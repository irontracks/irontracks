diff --git a/.gitignore b/.gitignore
index 714e2bc..064c95e 100644
--- a/.gitignore
+++ b/.gitignore
@@ -43,3 +43,7 @@ yarn-error.log*
 *.tsbuildinfo
 next-env.d.ts
 .env*.local
+
+# duplicate “save as” files
+* [2-9]
+* [2-9].*
diff --git a/_archive/duplicates/src/actions/workout-actions 2.js b/_archive/duplicates/src/actions/workout-actions 2.js
deleted file mode 100644
index a3a173a..0000000
--- a/_archive/duplicates/src/actions/workout-actions 2.js	
+++ /dev/null
@@ -1,510 +0,0 @@
-import { createClient } from '@/utils/supabase/client'
-import { normalizeWorkoutTitle } from '@/utils/workoutTitle'
-
-const safeString = (v) => {
-  const s = String(v ?? '').trim()
-  return s
-}
-
-const safeIso = (v) => {
-  try {
-    if (!v) return null
-    const d = v instanceof Date ? v : new Date(v)
-    const t = d.getTime()
-    return Number.isFinite(t) ? d.toISOString() : null
-  } catch {
-    return null
-  }
-}
-
-const safeJsonParse = (raw) => {
-  try {
-    if (!raw) return null
-    if (typeof raw === 'object') return raw
-    const s = String(raw).trim()
-    if (!s) return null
-    return JSON.parse(s)
-  } catch {
-    return null
-  }
-}
-
-const buildExercisesPayload = (workout) => {
-  const w = workout && typeof workout === 'object' ? workout : {}
-  const exercises = Array.isArray(w.exercises) ? w.exercises : []
-  return exercises
-    .filter((ex) => ex && typeof ex === 'object')
-    .map((ex, idx) => {
-      const setDetails =
-        Array.isArray(ex.setDetails) ? ex.setDetails : Array.isArray(ex.set_details) ? ex.set_details : Array.isArray(ex.sets) ? ex.sets : null
-      const headerSets = Number.parseInt(String(ex.sets ?? ''), 10) || 0
-      const numSets = headerSets || (Array.isArray(setDetails) ? setDetails.length : 0)
-      const sets = []
-      for (let i = 0; i < numSets; i += 1) {
-        const s = Array.isArray(setDetails) ? (setDetails[i] || null) : null
-        sets.push({
-          weight: s?.weight ?? null,
-          reps: s?.reps ?? ex?.reps ?? null,
-          rpe: s?.rpe ?? ex?.rpe ?? null,
-          set_number: s?.set_number ?? s?.setNumber ?? i + 1,
-          completed: false,
-          is_warmup: !!(s?.is_warmup ?? s?.isWarmup),
-          advanced_config: s?.advanced_config ?? s?.advancedConfig ?? null,
-        })
-      }
-      return {
-        name: safeString(ex?.name || ''),
-        notes: safeString(ex?.notes || ''),
-        video_url: ex?.videoUrl ?? ex?.video_url ?? null,
-        rest_time: ex?.restTime ?? ex?.rest_time ?? null,
-        cadence: ex?.cadence ?? null,
-        method: ex?.method ?? null,
-        order: idx,
-        sets,
-      }
-    })
-}
-
-export async function createWorkout(workout) {
-  try {
-    const supabase = createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-    if (!user?.id) return { ok: false, error: 'unauthorized' }
-
-    const title = safeString(workout?.title ?? workout?.name ?? 'Treino')
-    const exercisesPayload = buildExercisesPayload(workout)
-    const notes = workout?.notes != null ? safeString(workout.notes) : ''
-
-    const { data: workoutId, error } = await supabase.rpc('save_workout_atomic', {
-      p_workout_id: null,
-      p_user_id: user.id,
-      p_created_by: user.id,
-      p_is_template: true,
-      p_name: normalizeWorkoutTitle(title),
-      p_notes: notes,
-      p_exercises: exercisesPayload,
-    })
-    if (error) return { ok: false, error: error.message }
-    if (!workoutId) return { ok: false, error: 'Falha ao criar treino' }
-    return { ok: true, id: workoutId }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function updateWorkout(id, workout) {
-  try {
-    const supabase = createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-    if (!user?.id) return { ok: false, error: 'unauthorized' }
-
-    const workoutId = safeString(id)
-    if (!workoutId) return { ok: false, error: 'missing id' }
-
-    const title = safeString(workout?.title ?? workout?.name ?? 'Treino')
-    const exercisesPayload = buildExercisesPayload(workout)
-    const notes = workout?.notes != null ? safeString(workout.notes) : ''
-
-    const { data: savedId, error } = await supabase.rpc('save_workout_atomic', {
-      p_workout_id: workoutId,
-      p_user_id: user.id,
-      p_created_by: user.id,
-      p_is_template: true,
-      p_name: normalizeWorkoutTitle(title),
-      p_notes: notes,
-      p_exercises: exercisesPayload,
-    })
-    if (error) return { ok: false, error: error.message }
-    return { ok: true, id: savedId || workoutId }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function deleteWorkout(id) {
-  try {
-    const supabase = createClient()
-    const workoutId = safeString(id)
-    if (!workoutId) return { ok: false, error: 'missing id' }
-    const { error } = await supabase.from('workouts').delete().eq('id', workoutId)
-    if (error) return { ok: false, error: error.message }
-    return { ok: true }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function setWorkoutArchived(id, archived = true) {
-  try {
-    const supabase = createClient()
-    const workoutId = safeString(id)
-    if (!workoutId) return { ok: false, error: 'missing id' }
-    const archivedAt = archived ? new Date().toISOString() : null
-    const { error } = await supabase.from('workouts').update({ archived_at: archivedAt }).eq('id', workoutId)
-    if (error) return { ok: false, error: error.message }
-    return { ok: true, archivedAt }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function setWorkoutSortOrder(id, sortOrder) {
-  try {
-    const supabase = createClient()
-    const workoutId = safeString(id)
-    if (!workoutId) return { ok: false, error: 'missing id' }
-    const n = Number(sortOrder)
-    if (!Number.isFinite(n)) return { ok: false, error: 'invalid sort order' }
-    const { error } = await supabase.from('workouts').update({ sort_order: Math.floor(n) }).eq('id', workoutId)
-    if (error) return { ok: false, error: error.message }
-    return { ok: true }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function importData(payload) {
-  const src = payload && typeof payload === 'object' ? payload : null
-  const workouts = Array.isArray(src?.workouts) ? src.workouts : []
-  if (!workouts.length) return { ok: true, created: 0 }
-
-  let created = 0
-  for (const w of workouts) {
-    const res = await createWorkout({
-      title: w?.title ?? w?.name ?? 'Treino',
-      notes: w?.notes ?? '',
-      exercises: Array.isArray(w?.exercises) ? w.exercises : [],
-    })
-    if (res?.ok) created += 1
-  }
-  return { ok: true, created }
-}
-
-export async function generatePostWorkoutInsights(input) {
-  try {
-    const body = input && typeof input === 'object' ? input : {}
-    const res = await fetch('/api/ai/post-workout-insights', {
-      method: 'POST',
-      headers: { 'content-type': 'application/json' },
-      body: JSON.stringify(body),
-    })
-    const json = await res.json().catch(() => null)
-    if (!res.ok || !json?.ok) return { ok: false, error: json?.error || 'Falha ao gerar insights' }
-    return json
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function applyProgressionToNextTemplate(input) {
-  try {
-    const body = input && typeof input === 'object' ? input : {}
-    const res = await fetch('/api/ai/apply-progression-next', {
-      method: 'POST',
-      headers: { 'content-type': 'application/json' },
-      body: JSON.stringify(body),
-    })
-    const json = await res.json().catch(() => null)
-    if (!res.ok || !json?.ok) return { ok: false, error: json?.error || 'Falha ao aplicar progressão' }
-    return json
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function getIronRankLeaderboard(limit = 100) {
-  try {
-    const supabase = createClient()
-    const n = Math.min(300, Math.max(1, Number(limit) || 100))
-    const { data, error } = await supabase.rpc('iron_rank_leaderboard', { limit_count: n })
-    if (error) return { ok: false, error: error.message }
-    return { ok: true, data: Array.isArray(data) ? data : [] }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-const normalizeExerciseKey = (v) => {
-  return safeString(v)
-    .toLowerCase()
-    .normalize('NFD')
-    .replace(/[\u0300-\u036f]/g, '')
-    .replace(/\s+/g, ' ')
-}
-
-const extractLogsStatsByExercise = (session) => {
-  try {
-    const s = session && typeof session === 'object' ? session : {}
-    const logs = s?.logs && typeof s.logs === 'object' ? s.logs : {}
-    const exercises = Array.isArray(s?.exercises) ? s.exercises : []
-    const byKey = new Map()
-
-    Object.entries(logs).forEach(([k, v]) => {
-      const log = v && typeof v === 'object' ? v : null
-      if (!log) return
-      const parts = String(k || '').split('-')
-      const exIdx = Number(parts[0])
-      if (!Number.isFinite(exIdx)) return
-      const exName = safeString(exercises?.[exIdx]?.name || '')
-      if (!exName) return
-      const key = normalizeExerciseKey(exName)
-      if (!key) return
-      const w = Number(String(log?.weight ?? '').replace(',', '.'))
-      const r = Number(String(log?.reps ?? '').replace(',', '.'))
-      if (!Number.isFinite(w) || !Number.isFinite(r) || w <= 0 || r <= 0) return
-      const volume = w * r
-      const cur = byKey.get(key) || { exercise: exName, weight: 0, reps: 0, volume: 0 }
-      cur.exercise = exName
-      cur.weight = Math.max(cur.weight, w)
-      cur.reps = Math.max(cur.reps, r)
-      cur.volume = Math.max(cur.volume, volume)
-      byKey.set(key, cur)
-    })
-
-    return byKey
-  } catch {
-    return new Map()
-  }
-}
-
-export async function getLatestWorkoutPrs() {
-  try {
-    const supabase = createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-    if (!user?.id) return { ok: false, error: 'unauthorized', prs: [], workout: null }
-
-    const { data: latest, error: lErr } = await supabase
-      .from('workouts')
-      .select('id, name, date, created_at, notes')
-      .eq('user_id', user.id)
-      .eq('is_template', false)
-      .order('date', { ascending: false })
-      .order('created_at', { ascending: false })
-      .limit(1)
-      .maybeSingle()
-    if (lErr) return { ok: false, error: lErr.message, prs: [], workout: null }
-    if (!latest?.id) return { ok: true, prs: [], workout: { title: null, date: null } }
-
-    const session = safeJsonParse(latest.notes)
-    const currentMap = extractLogsStatsByExercise(session)
-
-    const { data: prevRows } = await supabase
-      .from('workouts')
-      .select('id, notes, date, created_at')
-      .eq('user_id', user.id)
-      .eq('is_template', false)
-      .neq('id', String(latest.id))
-      .order('date', { ascending: false })
-      .order('created_at', { ascending: false })
-      .limit(30)
-
-    const prevBest = new Map()
-    for (const row of Array.isArray(prevRows) ? prevRows : []) {
-      const prevSession = safeJsonParse(row?.notes)
-      const m = extractLogsStatsByExercise(prevSession)
-      for (const [k, st] of m.entries()) {
-        const cur = prevBest.get(k) || { weight: 0, reps: 0, volume: 0 }
-        prevBest.set(k, {
-          weight: Math.max(cur.weight, st.weight || 0),
-          reps: Math.max(cur.reps, st.reps || 0),
-          volume: Math.max(cur.volume, st.volume || 0),
-        })
-      }
-    }
-
-    const prs = []
-    for (const [k, st] of currentMap.entries()) {
-      const base = prevBest.get(k) || { weight: 0, reps: 0, volume: 0 }
-      const improved = {
-        weight: (st.weight || 0) > (base.weight || 0),
-        reps: (st.reps || 0) > (base.reps || 0),
-        volume: (st.volume || 0) > (base.volume || 0),
-      }
-      if (!improved.weight && !improved.reps && !improved.volume) continue
-      prs.push({ ...st, improved })
-    }
-
-    prs.sort((a, b) => (b.volume || 0) - (a.volume || 0))
-
-    return {
-      ok: true,
-      prs: prs.slice(0, 12),
-      workout: {
-        id: String(latest.id),
-        title: latest?.name ?? null,
-        date: safeIso(latest?.date) || safeIso(latest?.created_at),
-      },
-    }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e), prs: [], workout: null }
-  }
-}
-
-export async function computeWorkoutStreakAndStats() {
-  try {
-    const supabase = createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-    if (!user?.id) return { ok: false, error: 'unauthorized' }
-
-    const { data: recentRaw } = await supabase
-      .from('workouts')
-      .select('id, date, created_at')
-      .eq('user_id', user.id)
-      .eq('is_template', false)
-      .order('date', { ascending: false })
-      .order('created_at', { ascending: false })
-      .limit(180)
-
-    const daySet = new Set()
-    for (const r of Array.isArray(recentRaw) ? recentRaw : []) {
-      const iso = safeIso(r?.date) || safeIso(r?.created_at)
-      if (!iso) continue
-      daySet.add(iso.slice(0, 10))
-    }
-    const days = Array.from(daySet.values()).sort()
-
-    const toDayMs = (day) => {
-      const t = new Date(`${day}T00:00:00.000Z`).getTime()
-      return Number.isFinite(t) ? t : null
-    }
-
-    let currentStreak = 0
-    let bestStreak = 0
-
-    const todayKey = new Date().toISOString().slice(0, 10)
-    const hasToday = daySet.has(todayKey)
-    const startKey = hasToday ? todayKey : new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().slice(0, 10)
-    if (daySet.has(startKey)) {
-      let cursor = startKey
-      while (daySet.has(cursor)) {
-        currentStreak += 1
-        const ms = toDayMs(cursor)
-        if (!ms) break
-        cursor = new Date(ms - 24 * 60 * 60 * 1000).toISOString().slice(0, 10)
-      }
-    }
-
-    for (let i = 0; i < days.length; i += 1) {
-      let streak = 1
-      for (let j = i; j > 0; j -= 1) {
-        const a = toDayMs(days[j])
-        const b = toDayMs(days[j - 1])
-        if (a == null || b == null) break
-        if (a - b !== 24 * 60 * 60 * 1000) break
-        streak += 1
-      }
-      bestStreak = Math.max(bestStreak, streak)
-    }
-
-    const workoutsCountRes = await supabase
-      .from('workouts')
-      .select('id', { head: true, count: 'exact' })
-      .eq('user_id', user.id)
-      .eq('is_template', false)
-
-    const totalWorkouts = Number(workoutsCountRes.count) || 0
-
-    let totalVolumeKg = 0
-    try {
-      const { data: vol, error: vErr } = await supabase.rpc('iron_rank_my_total_volume')
-      if (!vErr) totalVolumeKg = Math.round(Number(String(vol ?? 0).replace(',', '.')) || 0)
-    } catch {}
-
-    const badges = []
-    if (totalWorkouts > 0) badges.push({ id: 'first_workout', label: 'Primeiro treino', kind: 'milestone' })
-    if (currentStreak >= 3) badges.push({ id: 'streak_3', label: '3 dias seguidos', kind: 'streak' })
-    if (currentStreak >= 7) badges.push({ id: 'streak_7', label: '7 dias seguidos', kind: 'streak' })
-    if (totalVolumeKg >= 5000) badges.push({ id: 'vol_5k', label: '5.000kg levantados', kind: 'volume' })
-    if (totalVolumeKg >= 20000) badges.push({ id: 'vol_20k', label: '20.000kg levantados', kind: 'volume' })
-
-    return {
-      ok: true,
-      data: {
-        currentStreak,
-        bestStreak,
-        totalWorkouts,
-        totalVolumeKg,
-        badges,
-      },
-    }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function generatePeriodReportInsights(input) {
-  try {
-    const body = input && typeof input === 'object' ? input : {}
-    const type = safeString(body?.type)
-    const stats = body?.stats && typeof body.stats === 'object' ? body.stats : null
-    if (!type || !stats) return { ok: false, error: 'missing input' }
-
-    const count = Number(stats.count) || 0
-    const totalMinutes = Number(stats.totalMinutes) || 0
-    const avgMinutes = Number(stats.avgMinutes) || 0
-    const totalVolumeKg = Number(stats.totalVolumeKg) || 0
-    const avgVolumeKg = Number(stats.avgVolumeKg) || 0
-    const days = Number(stats.days) || 0
-
-    const label = type === 'week' ? 'semanal' : type === 'month' ? 'mensal' : `de ${days} dias`
-
-    const ai = {
-      title: `Resumo ${label}`,
-      summary: [
-        `${count} treino(s) finalizado(s)`,
-        `${totalMinutes} min no total (${avgMinutes} min/treino)`,
-        `${totalVolumeKg.toLocaleString('pt-BR')}kg de volume (${avgVolumeKg.toLocaleString('pt-BR')}kg/treino)`,
-      ],
-      highlights: (Array.isArray(stats?.topExercisesByVolume) ? stats.topExercisesByVolume : [])
-        .slice(0, 3)
-        .map((x) => `${safeString(x?.name) || 'Exercício'}: ${Number(x?.volumeKg || 0).toLocaleString('pt-BR')}kg`),
-      warnings: [],
-    }
-
-    return { ok: true, ai }
-  } catch (e) {
-    return { ok: false, error: e?.message ? String(e.message) : String(e) }
-  }
-}
-
-export async function generateAssessmentPlanAi(input) {
-  const payload = input && typeof input === 'object' ? input : {}
-  const assessment = payload?.assessment && typeof payload.assessment === 'object' ? payload.assessment : null
-  if (!assessment) return { ok: false, error: 'missing assessment' }
-
-  const studentName = safeString(payload?.studentName || 'Aluno')
-  const goal = safeString(payload?.goal || '')
-  const weight = assessment?.weight != null ? safeString(assessment.weight) : ''
-  const bf = assessment?.body_fat_percentage != null ? safeString(assessment.body_fat_percentage) : assessment?.bf != null ? safeString(assessment.bf) : ''
-
-  const plan = [
-    `Plano tático (base) para ${studentName}:`,
-    goal ? `Objetivo: ${goal}` : null,
-    weight ? `Peso atual: ${weight} kg` : null,
-    bf ? `BF: ${bf}%` : null,
-    '',
-    'Treino (4-5x/semana):',
-    '- Priorize progressão em básicos (agachamento/terra/supino/remo).',
-    '- Registre cargas e reps; busque +1 rep ou +2,5kg quando possível.',
-    '',
-    'Recuperação:',
-    '- Sono: 7-9h.',
-    '- Passos: 7k-10k/dia (ajuste conforme objetivo).',
-    '',
-    'Nutrição (diretriz):',
-    '- Proteína alta e consistente; carbo em torno do treino; hidratação.',
-  ]
-    .filter((x) => x != null)
-    .join('\n')
-
-  return { ok: true, plan, usedAi: false, reason: 'fallback' }
-}
-
diff --git a/_archive/duplicates/src/app/(app)/community/CommunityClient 2.tsx b/_archive/duplicates/src/app/(app)/community/CommunityClient 2.tsx
deleted file mode 100644
index 9b01753..0000000
--- a/_archive/duplicates/src/app/(app)/community/CommunityClient 2.tsx	
+++ /dev/null
@@ -1,986 +0,0 @@
-'use client'
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
-import Image from 'next/image'
-import { useRouter } from 'next/navigation'
-import { createClient } from '@/utils/supabase/client'
-import { useUserSettings } from '@/hooks/useUserSettings'
-import { InAppNotificationsProvider, useInAppNotifications } from '@/contexts/InAppNotificationsContext'
-import { ArrowLeft, Search, Settings, UserPlus, UserMinus } from 'lucide-react'
-
-type ProfileRow = {
-  id: string
-  display_name: string | null
-  photo_url: string | null
-  role: string | null
-}
-
-type FollowRow = {
-  follower_id: string
-  following_id: string
-  status: 'pending' | 'accepted'
-}
-
-type FollowRequestItem = {
-  follower_id: string
-  following_id: string
-  status: 'pending'
-  follower_profile: ProfileRow | null
-}
-
-const safeString = (v: any) => (v === null || v === undefined ? '' : String(v))
-
-const formatRoleLabel = (raw: any) => {
-  const r = String(raw || '').trim().toLowerCase()
-  if (r === 'teacher') return 'PROFESSOR'
-  if (r === 'admin') return 'ADMIN'
-  if (r === 'user') return 'ALUNO'
-  return r ? r.toUpperCase() : 'ALUNO'
-}
-
-export default function CommunityClient({ embedded }: { embedded?: boolean }) {
-  if (embedded) return <CommunityClientInner embedded />
-  return (
-    <InAppNotificationsProvider>
-      <CommunityClientInner />
-    </InAppNotificationsProvider>
-  )
-}
-
-function CommunityClientInner({ embedded }: { embedded?: boolean }) {
-  const router = useRouter()
-  const supabase = useMemo(() => createClient(), [])
-  const { notify } = useInAppNotifications()
-  const [userId, setUserId] = useState<string>('')
-  const userSettingsApi = useUserSettings(userId)
-  const [communitySettingsOpen, setCommunitySettingsOpen] = useState(false)
-  const [loading, setLoading] = useState(true)
-  const [profiles, setProfiles] = useState<ProfileRow[]>([])
-  const [follows, setFollows] = useState<Map<string, FollowRow>>(new Map())
-  const [followRequests, setFollowRequests] = useState<FollowRequestItem[]>([])
-  const [loadError, setLoadError] = useState<string>('')
-  const [query, setQuery] = useState('')
-  const [busyId, setBusyId] = useState<string>('')
-  const [busyRequestId, setBusyRequestId] = useState<string>('')
-  const followerProfileCacheRef = useRef<Map<string, ProfileRow | null>>(new Map())
-  const showMessage = useCallback(
-    (text: string) => {
-      const msg = String(text || '').trim()
-      if (!msg) return
-      const allowToasts = Boolean(userSettingsApi?.settings?.inAppToasts ?? true)
-      if (allowToasts) {
-        notify({
-          text: msg,
-          senderName: 'Comunidade',
-          displayName: 'Comunidade',
-          photoURL: null,
-          type: 'info',
-        })
-        return
-      }
-      try {
-        if (typeof window !== 'undefined') window.alert(msg)
-      } catch {}
-    },
-    [notify, userSettingsApi?.settings?.inAppToasts]
-  )
-
-  const communityEnabled = Boolean(userSettingsApi?.settings?.moduleCommunity ?? true)
-
-  useEffect(() => {
-    let mounted = true
-    ;(async () => {
-      try {
-        const { data } = await supabase.auth.getUser()
-        const uid = data?.user?.id ? String(data.user.id) : ''
-        if (!mounted) return
-        setUserId(uid)
-      } catch {
-        if (!mounted) return
-        setUserId('')
-      }
-    })()
-
-    return () => {
-      mounted = false
-    }
-  }, [supabase])
-
-  const loadFollowerProfiles = useCallback(
-    async (ids: string[]) => {
-      const safeIds = Array.from(new Set((Array.isArray(ids) ? ids : []).map((v) => String(v || '').trim()).filter(Boolean)))
-      if (!safeIds.length) return new Map<string, ProfileRow | null>()
-
-      const out = new Map<string, ProfileRow | null>()
-      const missing: string[] = []
-      safeIds.forEach((id) => {
-        const cached = followerProfileCacheRef.current.get(id)
-        if (cached !== undefined) out.set(id, cached)
-        else missing.push(id)
-      })
-
-      if (!missing.length) return out
-
-      try {
-        const { data } = await supabase.from('profiles').select('id, display_name, photo_url, role').in('id', missing).limit(5000)
-        const rows = Array.isArray(data) ? data : []
-        const got = new Set<string>()
-        rows.forEach((row: any) => {
-          const id = String(row?.id || '').trim()
-          if (!id) return
-          got.add(id)
-          const prof: ProfileRow = {
-            id,
-            display_name: row?.display_name ? String(row.display_name) : null,
-            photo_url: row?.photo_url ? String(row.photo_url) : null,
-            role: row?.role ? String(row.role) : null,
-          }
-          followerProfileCacheRef.current.set(id, prof)
-          out.set(id, prof)
-        })
-
-        missing.forEach((id) => {
-          if (got.has(id)) return
-          followerProfileCacheRef.current.set(id, null)
-          out.set(id, null)
-        })
-      } catch {
-        missing.forEach((id) => {
-          followerProfileCacheRef.current.set(id, null)
-          out.set(id, null)
-        })
-      }
-
-      return out
-    },
-    [supabase]
-  )
-
-  const loadAll = useCallback(
-    async (uid: string) => {
-      const id = String(uid || '').trim()
-      if (!id) return
-
-      const [profilesRes, followsRes, incomingRes] = await Promise.all([
-        supabase.from('profiles').select('id, display_name, photo_url, role').order('display_name', { ascending: true }).limit(500),
-        supabase.from('social_follows').select('follower_id, following_id, status').eq('follower_id', id).limit(5000),
-        supabase
-          .from('social_follows')
-          .select('follower_id, following_id, status')
-          .eq('following_id', id)
-          .eq('status', 'pending')
-          .limit(5000),
-      ])
-
-      const profilesErr = profilesRes?.error ? String(profilesRes.error.message || profilesRes.error) : ''
-      const followsErr = followsRes?.error ? String(followsRes.error.message || followsRes.error) : ''
-      const incomingErr = incomingRes?.error ? String(incomingRes.error.message || incomingRes.error) : ''
-      if (profilesErr || followsErr || incomingErr) {
-        const raw = profilesErr || followsErr || incomingErr
-        const lower = raw.toLowerCase()
-        const msg = (() => {
-          if (lower.includes('schema cache') || lower.includes('could not find the table') || lower.includes('social_follows')) {
-            return 'O Social System não está aplicado no Supabase (tabela social_follows ausente). Rode as migrations do Supabase e recarregue a página.'
-          }
-          return raw || 'Falha ao carregar dados da comunidade.'
-        })()
-        setLoadError(msg)
-      } else {
-        setLoadError('')
-      }
-
-      const list = (Array.isArray(profilesRes?.data) ? profilesRes.data : [])
-        .filter((row) => row && typeof row === 'object')
-        .map((row: any) => ({
-          id: String(row.id),
-          display_name: row.display_name ? String(row.display_name) : null,
-          photo_url: row.photo_url ? String(row.photo_url) : null,
-          role: row.role ? String(row.role) : null,
-        }))
-        .filter((row) => row.id && row.id !== id)
-
-      setProfiles(list)
-
-      const map = new Map<string, FollowRow>()
-      ;(Array.isArray(followsRes?.data) ? followsRes.data : []).forEach((row: any) => {
-        const fid = String(row?.following_id || '').trim()
-        if (!fid) return
-        map.set(fid, {
-          follower_id: String(row?.follower_id || '').trim(),
-          following_id: fid,
-          status: row?.status === 'accepted' ? 'accepted' : 'pending',
-        })
-      })
-      setFollows(map)
-
-      let incomingRows = (Array.isArray(incomingRes?.data) ? incomingRes.data : [])
-        .filter((r) => r && typeof r === 'object')
-        .map((r: any) => ({
-          follower_id: String(r?.follower_id || '').trim(),
-          following_id: String(r?.following_id || '').trim(),
-          status: 'pending' as const,
-        }))
-        .filter((r) => r.follower_id && r.following_id)
-
-      if ((!incomingRows.length && incomingErr) || (incomingErr && incomingRows.length === 0)) {
-        try {
-          const { data: notifRows } = await supabase
-            .from('notifications')
-            .select('sender_id, metadata, read, created_at')
-            .eq('user_id', id)
-            .eq('type', 'follow_request')
-            .eq('read', false)
-            .order('created_at', { ascending: false })
-            .limit(100)
-
-          const followerIds = (Array.isArray(notifRows) ? notifRows : [])
-            .map((n: any) => {
-              const meta = n?.metadata && typeof n.metadata === 'object' ? n.metadata : null
-              return String(n?.sender_id ?? meta?.follower_id ?? '').trim()
-            })
-            .filter(Boolean)
-
-          incomingRows = Array.from(new Set(followerIds)).map((fid) => ({
-            follower_id: fid,
-            following_id: id,
-            status: 'pending' as const,
-          }))
-        } catch {}
-      }
-
-      const followerIds = incomingRows.map((r) => r.follower_id)
-      const profilesById = await loadFollowerProfiles(followerIds)
-
-      setFollowRequests(
-        incomingRows.map((r) => ({
-          ...r,
-          follower_profile: profilesById.get(r.follower_id) ?? null,
-        }))
-      )
-    },
-    [loadFollowerProfiles, supabase]
-  )
-
-  useEffect(() => {
-    if (!userId) {
-      setLoading(false)
-      setProfiles([])
-      setFollows(new Map())
-      setFollowRequests([])
-      return
-    }
-
-    let mounted = true
-    let incomingChannel: any
-    let outgoingChannel: any
-
-    const run = async () => {
-      setLoading(true)
-      try {
-        await loadAll(userId)
-      } catch {
-        if (!mounted) return
-        setProfiles([])
-        setFollows(new Map())
-        setFollowRequests([])
-      } finally {
-        if (mounted) setLoading(false)
-      }
-    }
-
-    run()
-
-    try {
-      incomingChannel = supabase
-        .channel(`community:follows:incoming:${userId}`)
-        .on(
-          'postgres_changes',
-          { event: '*', schema: 'public', table: 'social_follows', filter: `following_id=eq.${userId}` },
-          async (payload) => {
-            try {
-              if (!mounted) return
-              const ev = String(payload?.eventType || '').toUpperCase()
-              const row = (ev === 'DELETE' ? payload?.old : payload?.new) as any
-              const followerId = String(row?.follower_id || '').trim()
-              const status = String(row?.status || '').trim().toLowerCase()
-              if (!followerId) return
-
-              if (ev === 'DELETE' || status !== 'pending') {
-                setFollowRequests((prev) => prev.filter((r) => r.follower_id !== followerId))
-                return
-              }
-
-              const byId = await loadFollowerProfiles([followerId])
-              const prof = byId.get(followerId) ?? null
-
-              setFollowRequests((prev) => {
-                const current = Array.isArray(prev) ? prev : []
-                const exists = current.some((r) => r?.follower_id === followerId)
-                if (exists) {
-                  return current.map((r) => (r?.follower_id === followerId ? { ...r, follower_profile: prof } : r))
-                }
-                return [{ follower_id: followerId, following_id: userId, status: 'pending', follower_profile: prof }, ...current]
-              })
-            } catch {}
-          }
-        )
-        .subscribe()
-    } catch {}
-
-    try {
-      outgoingChannel = supabase
-        .channel(`community:follows:outgoing:${userId}`)
-        .on(
-          'postgres_changes',
-          { event: '*', schema: 'public', table: 'social_follows', filter: `follower_id=eq.${userId}` },
-          (payload) => {
-            try {
-              if (!mounted) return
-              const ev = String(payload?.eventType || '').toUpperCase()
-              const row = (ev === 'DELETE' ? payload?.old : payload?.new) as any
-              const followingId = String(row?.following_id || '').trim()
-              const status = String(row?.status || '').trim().toLowerCase()
-              if (!followingId) return
-
-              setFollows((prev) => {
-                const next = new Map(prev)
-                if (ev === 'DELETE') {
-                  next.delete(followingId)
-                  return next
-                }
-                next.set(followingId, {
-                  follower_id: userId,
-                  following_id: followingId,
-                  status: status === 'accepted' ? 'accepted' : 'pending',
-                })
-                return next
-              })
-            } catch {}
-          }
-        )
-        .subscribe()
-    } catch {}
-
-    const refresh = () => {
-      try {
-        if (!mounted) return
-        run()
-      } catch {}
-    }
-
-    try {
-      document.addEventListener('visibilitychange', () => {
-        try {
-          if (document.visibilityState === 'visible') refresh()
-        } catch {}
-      })
-      window.addEventListener('pageshow', refresh)
-    } catch {}
-
-    return () => {
-      mounted = false
-      try {
-        if (incomingChannel) supabase.removeChannel(incomingChannel)
-      } catch {}
-      try {
-        if (outgoingChannel) supabase.removeChannel(outgoingChannel)
-      } catch {}
-      try {
-        window.removeEventListener('pageshow', refresh)
-      } catch {}
-    }
-  }, [loadAll, loadFollowerProfiles, supabase, userId])
-
-  const filtered = useMemo(() => {
-    const q = query.trim().toLowerCase()
-    const base = Array.isArray(profiles) ? profiles : []
-    if (!q) return base
-    return base.filter((p) => {
-      const name = safeString(p.display_name).toLowerCase()
-      const role = safeString(p.role).toLowerCase()
-      return name.includes(q) || role.includes(q)
-    })
-  }, [profiles, query])
-
-  const respondFollowRequest = async (followerId: string, decision: 'accept' | 'deny') => {
-    const fid = String(followerId || '').trim()
-    if (!fid || !userId) return
-    if (busyRequestId) return
-    setBusyRequestId(fid)
-    try {
-      const res = await fetch('/api/social/follow/respond', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ follower_id: fid, decision }),
-      })
-      const data = await res.json().catch(() => null)
-      if (!data?.ok) {
-        const raw = String(data?.error || 'Falha ao responder')
-        const msg = (() => {
-          const lower = raw.toLowerCase()
-          if (lower.includes('schema cache') || lower.includes('could not find the table') || lower.includes('social_follows')) {
-            return 'O Social System não está aplicado no Supabase (tabela social_follows ausente). Rode as migrations do Supabase e recarregue a página.'
-          }
-          if (lower.includes('replica identity') || (lower.includes('publishes') && lower.includes('updates'))) {
-            return 'Falha ao atualizar a solicitação. O banco precisa de Primary Key/Replica Identity em social_follows. Rode as migrations do Supabase e recarregue a página.'
-          }
-          return raw
-        })()
-        if (typeof window !== 'undefined') window.alert(msg)
-        return
-      }
-
-      setFollowRequests((prev) => prev.filter((r) => r.follower_id !== fid))
-    } catch (e: any) {
-      if (typeof window !== 'undefined') window.alert(String(e?.message ?? e))
-    } finally {
-      setBusyRequestId('')
-    }
-  }
-
-  const cancelFollowRequest = async (profileId: string) => {
-    const pid = String(profileId || '').trim()
-    if (!pid || !userId) return
-    if (busyId) return
-    setBusyId(pid)
-    try {
-      const res = await fetch('/api/social/follow/cancel', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ following_id: pid }),
-      })
-      const data = await res.json().catch(() => null)
-      if (!data?.ok) {
-        const raw = String(data?.error || 'Falha ao cancelar')
-        const msg = (() => {
-          const lower = raw.toLowerCase()
-          if (lower.includes('schema cache') || lower.includes('could not find the table') || lower.includes('social_follows')) {
-            return 'O Social System não está aplicado no Supabase (tabela social_follows ausente). Rode as migrations do Supabase e recarregue a página.'
-          }
-          return raw
-        })()
-        if (typeof window !== 'undefined') window.alert(msg)
-        return
-      }
-
-      const status = String(data?.status || '').trim().toLowerCase()
-      const already = data?.already === true
-
-      if (!already || status !== 'accepted') {
-        setFollows((prev) => {
-          const next = new Map(prev)
-          next.delete(pid)
-          return next
-        })
-      }
-
-      try {
-        await loadAll(userId)
-      } catch {}
-    } catch (e: any) {
-      if (typeof window !== 'undefined') window.alert(String(e?.message ?? e))
-    } finally {
-      setBusyId('')
-    }
-  }
-
-  const follow = async (profileId: string) => {
-    const pid = String(profileId || '').trim()
-    if (!pid || !userId) return
-    if (busyId) return
-    setBusyId(pid)
-    try {
-      const res = await fetch('/api/social/follow', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ following_id: pid }),
-      })
-      const data = await res.json().catch(() => null)
-      if (!data?.ok) {
-        const raw = String(data?.error || 'Falha ao seguir')
-        const msg = (() => {
-          const lower = raw.toLowerCase()
-          if (lower.includes('user_not_accepting_follows')) {
-            return 'Este usuário não está aceitando convites para seguir.'
-          }
-          if (lower.includes('schema cache') || lower.includes('could not find the table') || lower.includes('social_follows')) {
-            return 'O Social System não está aplicado no Supabase (tabela social_follows ausente). Rode as migrations do Supabase e recarregue a página.'
-          }
-          return raw
-        })()
-        showMessage(msg)
-        return
-      }
-      try {
-        if (data?.notified === false && typeof window !== 'undefined') {
-          showMessage('Convite enviado. O usuário pode ter desativado notificações sociais e aprovará pela Comunidade.')
-        }
-      } catch {}
-      setFollows((prev) => {
-        const next = new Map(prev)
-        next.set(pid, { follower_id: userId, following_id: pid, status: 'pending' })
-        return next
-      })
-    } catch (e: any) {
-      showMessage(String(e?.message ?? e))
-    } finally {
-      setBusyId('')
-    }
-  }
-
-  const unfollow = async (profileId: string) => {
-    const pid = String(profileId || '').trim()
-    if (!pid || !userId) return
-    if (busyId) return
-    setBusyId(pid)
-    try {
-      const { error } = await supabase
-        .from('social_follows')
-        .delete()
-        .eq('follower_id', userId)
-        .eq('following_id', pid)
-      if (error) throw error
-
-      try {
-        await supabase.from('notifications').delete().eq('user_id', userId).eq('sender_id', pid)
-      } catch {}
-
-      setFollows((prev) => {
-        const next = new Map(prev)
-        next.delete(pid)
-        return next
-      })
-    } catch (e: any) {
-      if (typeof window !== 'undefined') window.alert(String(e?.message ?? e))
-    } finally {
-      setBusyId('')
-    }
-  }
-
-  if (userId && userSettingsApi?.loaded && !communityEnabled) {
-    return (
-      <div className={embedded ? '' : 'min-h-screen bg-neutral-950 text-white p-4'}>
-        <div className={embedded ? 'space-y-4' : 'max-w-3xl mx-auto space-y-4'}>
-          {!embedded ? (
-            <button
-              type="button"
-              onClick={() => router.push('/dashboard')}
-              className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black hover:bg-neutral-800 active:scale-95 transition-all"
-            >
-              Voltar ao Dashboard
-            </button>
-          ) : null}
-          <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4">
-            <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Comunidade</div>
-            <div className="text-lg font-black text-white mt-1">Módulo desativado</div>
-            <div className="text-sm text-neutral-400 mt-2">Ative em Configurações → Módulos opcionais.</div>
-          </div>
-        </div>
-      </div>
-    )
-  }
-
-  return (
-    <div className={embedded ? '' : "min-h-screen bg-neutral-900 text-white p-4"}>
-      <div className={embedded ? "space-y-4" : "max-w-4xl mx-auto space-y-4"}>
-        <div className="bg-neutral-800 border border-neutral-700 rounded-xl p-4">
-          <div className="flex items-center justify-between gap-3">
-            <div className="flex items-center gap-3 min-w-0">
-              {!embedded && (
-                <button
-                  type="button"
-                  onClick={() => {
-                    try {
-                      if (typeof window !== 'undefined' && window.history.length > 1) router.back()
-                      else router.push('/dashboard')
-                    } catch {
-                      router.push('/dashboard')
-                    }
-                  }}
-                  className="w-10 h-10 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 transition-colors inline-flex items-center justify-center text-neutral-200"
-                  aria-label="Voltar"
-                  title="Voltar"
-                >
-                  <ArrowLeft size={18} />
-                </button>
-              )}
-              <div className="min-w-0">
-              <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Comunidade</div>
-              <div className="text-white font-black text-xl truncate">Seguir Amigos</div>
-              <div className="text-xs text-neutral-400">Siga alunos e professores para receber notificações.</div>
-              </div>
-            </div>
-            <button
-              type="button"
-              onClick={() => setCommunitySettingsOpen(true)}
-              className="w-10 h-10 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 transition-colors inline-flex items-center justify-center text-neutral-200"
-              aria-label="Configurações da Comunidade"
-              title="Configurações da Comunidade"
-            >
-              <Settings size={18} />
-            </button>
-          </div>
-          <div className="mt-4 flex items-center gap-2 bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2">
-            <Search size={16} className="text-neutral-500" />
-            <input
-              value={query}
-              onChange={(e) => setQuery(e.target.value)}
-              className="bg-transparent outline-none text-sm text-white flex-1"
-              placeholder="Buscar por nome ou tipo (teacher/student)…"
-            />
-          </div>
-        </div>
-
-        {communitySettingsOpen && (
-          <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe">
-            <div className="w-full max-w-lg bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden">
-              <div className="p-4 border-b border-neutral-800 flex items-center justify-between">
-                <div className="min-w-0">
-                  <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Comunidade</div>
-                  <div className="text-white font-black text-lg truncate">Configurações</div>
-                </div>
-                <button
-                  type="button"
-                  onClick={() => setCommunitySettingsOpen(false)}
-                  className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                  aria-label="Fechar"
-                >
-                  <ArrowLeft size={18} />
-                </button>
-              </div>
-              <div className="p-4 space-y-3">
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">Permitir convites para seguir</div>
-                    <div className="text-xs text-neutral-400">Se desligar, ninguém consegue solicitar para te seguir.</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('allowSocialFollows', !(userSettingsApi?.settings?.allowSocialFollows ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.allowSocialFollows ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.allowSocialFollows ?? true) ? 'Ativo' : 'Bloqueado'}
-                  </button>
-                </div>
-
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">Notificações sociais</div>
-                    <div className="text-xs text-neutral-400">Solicitações de seguir e confirmações.</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('notifySocialFollows', !(userSettingsApi?.settings?.notifySocialFollows ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.notifySocialFollows ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.notifySocialFollows ?? true) ? 'Ativo' : 'Desligado'}
-                  </button>
-                </div>
-
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">Amigo entrou no app</div>
-                    <div className="text-xs text-neutral-400">Avisos de presença.</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('notifyFriendOnline', !(userSettingsApi?.settings?.notifyFriendOnline ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.notifyFriendOnline ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.notifyFriendOnline ?? true) ? 'Ativo' : 'Desligado'}
-                  </button>
-                </div>
-
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">Atividades de treino do amigo</div>
-                    <div className="text-xs text-neutral-400">Início/fim/criação/edição de treino.</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('notifyFriendWorkoutEvents', !(userSettingsApi?.settings?.notifyFriendWorkoutEvents ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.notifyFriendWorkoutEvents ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.notifyFriendWorkoutEvents ?? true) ? 'Ativo' : 'Desligado'}
-                  </button>
-                </div>
-
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">PRs do amigo</div>
-                    <div className="text-xs text-neutral-400">Avisos quando bater recorde pessoal.</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('notifyFriendPRs', !(userSettingsApi?.settings?.notifyFriendPRs ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.notifyFriendPRs ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.notifyFriendPRs ?? true) ? 'Ativo' : 'Desligado'}
-                  </button>
-                </div>
-
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">Streak do amigo</div>
-                    <div className="text-xs text-neutral-400">Avisos de sequência de dias treinando.</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('notifyFriendStreaks', !(userSettingsApi?.settings?.notifyFriendStreaks ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.notifyFriendStreaks ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.notifyFriendStreaks ?? true) ? 'Ativo' : 'Desligado'}
-                  </button>
-                </div>
-
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">Metas do amigo</div>
-                    <div className="text-xs text-neutral-400">Avisos de marcos (ex.: 10, 50 treinos).</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('notifyFriendGoals', !(userSettingsApi?.settings?.notifyFriendGoals ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.notifyFriendGoals ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.notifyFriendGoals ?? true) ? 'Ativo' : 'Desligado'}
-                  </button>
-                </div>
-
-                <div className="flex items-center justify-between gap-3">
-                  <div>
-                    <div className="text-sm font-bold text-white">Card flutuante (toasts)</div>
-                    <div className="text-xs text-neutral-400">Mensagens rápidas no topo da tela.</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => userSettingsApi.updateSetting('inAppToasts', !(userSettingsApi?.settings?.inAppToasts ?? true))}
-                    className={
-                      (userSettingsApi?.settings?.inAppToasts ?? true)
-                        ? 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                        : 'px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-black'
-                    }
-                  >
-                    {(userSettingsApi?.settings?.inAppToasts ?? true) ? 'Ativo' : 'Desligado'}
-                  </button>
-                </div>
-              </div>
-              <div className="p-4 border-t border-neutral-800 flex gap-2">
-                <button
-                  type="button"
-                  onClick={() => setCommunitySettingsOpen(false)}
-                  className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-200"
-                >
-                  Fechar
-                </button>
-                <button
-                  type="button"
-                  disabled={userSettingsApi?.saving}
-                  onClick={async () => {
-                    try {
-                      const res = await userSettingsApi.save()
-                      if (!res?.ok) {
-                        if (typeof window !== 'undefined') window.alert(String(res?.error || 'Falha ao salvar'))
-                        return
-                      }
-                      setCommunitySettingsOpen(false)
-                    } catch (e: any) {
-                      if (typeof window !== 'undefined') window.alert(String(e?.message ?? e))
-                    }
-                  }}
-                  className="flex-1 p-3 bg-yellow-500 rounded-xl font-black text-black disabled:opacity-50"
-                >
-                  {userSettingsApi?.saving ? 'Salvando...' : 'Salvar'}
-                </button>
-              </div>
-            </div>
-          </div>
-        )}
-
-        {loading ? (
-          <div className="bg-neutral-800 border border-neutral-700 rounded-xl p-6 text-sm text-neutral-400">Carregando…</div>
-        ) : !userId ? (
-          <div className="bg-neutral-800 border border-neutral-700 rounded-xl p-6 text-sm text-neutral-400">
-            Faça login para usar a comunidade.
-          </div>
-        ) : (
-          <>
-            <div className="bg-neutral-800 border border-neutral-700 rounded-xl overflow-hidden">
-              <div className="p-4 border-b border-neutral-700 flex items-center justify-between">
-                <div>
-                  <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Pedidos para seguir</div>
-                  <div className="text-sm text-neutral-300">
-                    {followRequests.length ? `${followRequests.length} pendente(s)` : 'Nenhuma solicitação pendente.'}
-                  </div>
-                  {loadError ? <div className="text-xs text-red-400 mt-1">{loadError}</div> : null}
-                </div>
-              </div>
-              {followRequests.length ? (
-                <div className="divide-y divide-neutral-700">
-                  {followRequests.map((r) => {
-                    const p = r.follower_profile
-                    const name = safeString(p?.display_name).trim() || 'Usuário'
-                    const role = formatRoleLabel(p?.role)
-                    const photo = safeString(p?.photo_url).trim()
-                    const busy = busyRequestId === r.follower_id
-                    return (
-                      <div key={r.follower_id} className="p-4 flex items-center gap-3">
-                        <div className="w-10 h-10 rounded-full bg-neutral-900 border border-neutral-700 overflow-hidden flex items-center justify-center">
-                          {photo ? (
-                            <Image src={photo} alt="" width={40} height={40} className="w-full h-full object-cover" unoptimized />
-                          ) : (
-                            <div className="text-xs font-black text-neutral-400">{name[0]}</div>
-                          )}
-                        </div>
-                        <div className="flex-1 min-w-0">
-                          <div className="text-sm font-black text-white truncate">{name}</div>
-                          <div className="text-[11px] text-neutral-400 uppercase tracking-wide truncate">{role}</div>
-                        </div>
-
-                        <div className="flex items-center gap-2">
-                          <button
-                            type="button"
-                            disabled={busy}
-                            onClick={() => respondFollowRequest(r.follower_id, 'accept')}
-                            className={
-                              busy
-                                ? 'px-3 py-2 rounded-xl bg-yellow-500/40 text-black/50 font-black cursor-not-allowed'
-                                : 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400 transition-colors'
-                            }
-                          >
-                            Aceitar
-                          </button>
-                          <button
-                            type="button"
-                            disabled={busy}
-                            onClick={() => respondFollowRequest(r.follower_id, 'deny')}
-                            className={
-                              busy
-                                ? 'px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-500 font-black cursor-not-allowed'
-                                : 'px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800 transition-colors'
-                            }
-                          >
-                            Negar
-                          </button>
-                        </div>
-                      </div>
-                    )
-                  })}
-                </div>
-              ) : null}
-            </div>
-            {filtered.length === 0 ? (
-              <div className="bg-neutral-800 border border-neutral-700 rounded-xl p-6 text-sm text-neutral-400">
-                Nenhum usuário encontrado.
-              </div>
-            ) : (
-              <div className="bg-neutral-800 border border-neutral-700 rounded-xl overflow-hidden">
-                <div className="px-4 py-3 border-b border-neutral-700 text-xs text-neutral-400">
-                  Notificações aparecem somente após o usuário aceitar seu pedido.
-                </div>
-                <div className="divide-y divide-neutral-700">
-                  {filtered.map((p) => {
-                    const followRow = follows.get(p.id) || null
-                    const status = followRow?.status || null
-                    const busy = busyId === p.id
-                    const name = safeString(p.display_name).trim() || 'Usuário'
-                    const role = formatRoleLabel(p.role)
-                    const photo = safeString(p.photo_url).trim()
-
-                    return (
-                      <div key={p.id} className="p-4 flex items-center gap-3">
-                        <div className="w-10 h-10 rounded-full bg-neutral-900 border border-neutral-700 overflow-hidden flex items-center justify-center">
-                          {photo ? (
-                            <Image src={photo} alt="" width={40} height={40} className="w-full h-full object-cover" unoptimized />
-                          ) : (
-                            <div className="text-xs font-black text-neutral-400">{name[0]}</div>
-                          )}
-                        </div>
-                        <div className="flex-1 min-w-0">
-                          <div className="text-sm font-black text-white truncate">{name}</div>
-                          <div className="text-[11px] text-neutral-400 uppercase tracking-wide truncate">{role}</div>
-                        </div>
-
-                        {status === 'accepted' ? (
-                          <button
-                            type="button"
-                            disabled={busy}
-                            onClick={() => unfollow(p.id)}
-                            className={
-                              busy
-                                ? 'px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-500 font-black cursor-not-allowed'
-                                : 'px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:border-red-500 hover:text-red-400 transition-colors inline-flex items-center gap-2'
-                            }
-                          >
-                            <UserMinus size={16} /> Parar de seguir
-                          </button>
-                        ) : status === 'pending' ? (
-                          <div className="flex flex-col items-end gap-1">
-                            <div className="text-[10px] text-neutral-500 uppercase tracking-widest font-black">Aguardando aprovação</div>
-                            <button
-                              type="button"
-                              disabled={busy}
-                              onClick={() => cancelFollowRequest(p.id)}
-                              className={
-                                busy
-                                  ? 'px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-500 font-black cursor-not-allowed'
-                                  : 'px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800 transition-colors'
-                              }
-                            >
-                              Cancelar convite
-                            </button>
-                          </div>
-                        ) : (
-                          <button
-                            type="button"
-                            disabled={busy}
-                            onClick={() => follow(p.id)}
-                            className={
-                              busy
-                                ? 'px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-500 font-black cursor-not-allowed'
-                                : 'px-3 py-2 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400 transition-colors inline-flex items-center gap-2'
-                            }
-                          >
-                            <UserPlus size={16} /> Seguir
-                          </button>
-                        )}
-                      </div>
-                    )
-                  })}
-                </div>
-              </div>
-            )}
-          </>
-        )}
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/app/(app)/community/page 2.tsx b/_archive/duplicates/src/app/(app)/community/page 2.tsx
deleted file mode 100644
index cb7f343..0000000
--- a/_archive/duplicates/src/app/(app)/community/page 2.tsx	
+++ /dev/null
@@ -1,8 +0,0 @@
-import CommunityClient from './CommunityClient'
-
-export const dynamic = 'force-dynamic'
-
-export default function CommunityPage() {
-  return <CommunityClient />
-}
-
diff --git a/_archive/duplicates/src/app/(app)/dashboard/DashboardClientEntry 2.tsx b/_archive/duplicates/src/app/(app)/dashboard/DashboardClientEntry 2.tsx
deleted file mode 100644
index f51d521..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/DashboardClientEntry 2.tsx	
+++ /dev/null
@@ -1,6 +0,0 @@
-'use client'
-
-import IronTracksAppClient from './IronTracksAppClient'
-
-export default IronTracksAppClient
-
diff --git a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 2.js b/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 2.js
deleted file mode 100644
index 0e964ed..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 2.js	
+++ /dev/null
@@ -1,5 +0,0 @@
-'use client'
-
-import IronTracksAppClient from './IronTracksAppClient 3.js'
-
-export default IronTracksAppClient
diff --git a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 4.js b/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 4.js
deleted file mode 100644
index 007d020..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 4.js	
+++ /dev/null
@@ -1,3619 +0,0 @@
-'use client';
-
-import React, { useState, useEffect, useCallback, Suspense, useRef } from 'react';
-import { useRouter } from 'next/navigation';
-import dynamic from 'next/dynamic';
-import Image from 'next/image';
-import {
-    RotateCcw,
-    History,
-    MoreVertical,
-    Share2,
-    Trash2,
-    Download,
-    Copy,
-    Plus,
-    Flame,
-    Play,
-    Dumbbell,
-    Check,
-    LogOut,
-    Clock,
-    Upload,
-    ArrowLeft,
-    X
-} from 'lucide-react';
-import { createClient } from '@/utils/supabase/client';
-import { createWorkout, updateWorkout, deleteWorkout, importData, computeWorkoutStreakAndStats, setWorkoutArchived, setWorkoutSortOrder } from '@/actions/workout-actions';
-
-import LoginScreen from '@/components/LoginScreen';
-import AdminPanelV2 from '@/components/AdminPanelV2';
-import ChatScreen from '@/components/ChatScreen';
-import ChatListScreen from '@/components/ChatListScreen';
-import ChatDirectScreen from '@/components/ChatDirectScreen';
-import HistoryList from '@/components/HistoryList';
-import CommunityClient from '@/app/(app)/community/CommunityClient';
-import StudentEvolution from '@/components/StudentEvolution';
-import WorkoutReport from '@/components/WorkoutReport';
-import ActiveWorkout from '@/components/ActiveWorkout';
-import RestTimerOverlay from '@/components/RestTimerOverlay';
-import LoadingScreen from '@/components/LoadingScreen';
-import ExerciseEditor from '@/components/ExerciseEditor';
-import IncomingInviteModal from '@/components/IncomingInviteModal';
-import InviteAcceptedModal from '@/components/InviteAcceptedModal';
-import NotificationCenter from '@/components/NotificationCenter';
-import HeaderActionsMenu from '@/components/HeaderActionsMenu.js';
-import { TeamWorkoutProvider } from '@/contexts/TeamWorkoutContext';
-import { InAppNotificationsProvider, useInAppNotifications } from '@/contexts/InAppNotificationsContext';
-import ErrorBoundary from '@/components/ErrorBoundary';
-import ErrorReporterProvider from '@/components/ErrorReporterProvider';
-import { DialogProvider, useDialog } from '@/contexts/DialogContext';
-import GlobalDialog from '@/components/GlobalDialog';
-import { playStartSound, unlockAudio } from '@/lib/sounds';
-import { workoutPlanHtml } from '@/utils/report/templates';
-import { estimateExerciseSeconds, toMinutesRounded, calculateExerciseDuration } from '@/utils/pacing';
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName'
-import { formatProgramWorkoutTitle } from '@/utils/workoutTitle'
-import { resolveCanonicalExerciseName } from '@/utils/exerciseCanonical'
-import { BackButton } from '@/components/ui/BackButton';
-import StudentDashboard from '@/components/dashboard/StudentDashboard.tsx'
-import WorkoutWizardModal from '@/components/dashboard/WorkoutWizardModal'
-import SettingsModal from '@/components/SettingsModal'
-import { useUserSettings } from '@/hooks/useUserSettings'
-import WhatsNewModal from '@/components/WhatsNewModal'
-import { generateWorkoutFromWizard } from '@/utils/workoutAutoGenerator'
-import { getLatestWhatsNew } from '@/content/whatsNew'
-import GuidedTour from '@/components/onboarding/GuidedTour'
-import { getTourSteps } from '@/utils/tourSteps'
-import { cacheGetWorkouts, cacheSetWorkouts, flushOfflineQueue, getOfflineQueueSummary, getPendingCount, isOnline } from '@/lib/offline/offlineSync'
-import OfflineSyncModal from '@/components/OfflineSyncModal'
-import { trackScreen, trackUserEvent } from '@/lib/telemetry/userActivity'
-
-const AssessmentHistory = dynamic(() => import('@/components/assessment/AssessmentHistory'), { ssr: false });
-const VipHub = dynamic(() => import('@/components/VipHub'), { ssr: false });
-
-const appId = 'irontracks-production';
-
-function InAppNotifyBinder({ bind }) {
-    const { notify } = useInAppNotifications();
-    const safeBind = typeof bind === 'function' ? bind : null;
-    useEffect(() => {
-        if (!safeBind) return;
-        safeBind(notify);
-        return () => {
-            try { safeBind(null); } catch {}
-        };
-    }, [notify, safeBind]);
-    return null;
-}
-
-const mapWorkoutRow = (w) => {
-	const rawExercises = Array.isArray(w?.exercises) ? w.exercises : [];
-	const exs = rawExercises
-		.filter((e) => e && typeof e === 'object')
-		.sort((a, b) => (a.order || 0) - (b.order || 0))
-		.map((e) => {
-			try {
-				const isCardio = String(e.method || '').toLowerCase() === 'cardio';
-				const dbSets = Array.isArray(e.sets)
-					? e.sets.filter((s) => s && typeof s === 'object')
-					: [];
-
-				const sortedSets = dbSets
-					.slice()
-					.sort((aSet, bSet) => (aSet?.set_number || 0) - (bSet?.set_number || 0));
-
-				const setsCount = sortedSets.length || (isCardio ? 1 : 4);
-
-				const setDetails = sortedSets.map((s, idx) => ({
-					set_number: s?.set_number ?? idx + 1,
-					reps: s?.reps ?? null,
-					rpe: s?.rpe ?? null,
-					weight: s?.weight ?? null,
-					is_warmup: !!(s?.is_warmup ?? s?.isWarmup),
-					advanced_config: s?.advanced_config ?? s?.advancedConfig ?? null,
-				}));
-
-				const nonEmptyReps = setDetails
-					.map((s) => s.reps)
-					.filter((r) => r !== null && r !== undefined && r !== '');
-				const defaultReps = isCardio ? '20' : '10';
-				let repsHeader = defaultReps;
-				if (nonEmptyReps.length > 0) {
-					const uniqueReps = Array.from(new Set(nonEmptyReps));
-					repsHeader = uniqueReps.length === 1 ? uniqueReps[0] : nonEmptyReps[0] ?? defaultReps;
-				}
-
-				const rpeValues = setDetails
-					.map((s) => s.rpe)
-					.filter((v) => v !== null && v !== undefined && !Number.isNaN(v));
-				const defaultRpe = isCardio ? 5 : 8;
-				const rpeHeader = rpeValues.length > 0 ? rpeValues[0] : defaultRpe;
-
-				return {
-					id: e.id,
-					name: e.name,
-					notes: e.notes,
-					videoUrl: e.video_url,
-					restTime: e.rest_time,
-					cadence: e.cadence,
-					method: e.method,
-					sets: setsCount,
-					reps: repsHeader,
-					rpe: rpeHeader,
-					setDetails,
-				};
-			} catch (mapErr) {
-				console.error('Erro ao mapear exercício', {
-					workoutId: w?.id,
-					exerciseId: e?.id,
-					error: mapErr,
-				});
-				return null;
-			}
-		})
-		.filter(Boolean);
-
-	return {
-		id: w.id,
-		title: w.name,
-		notes: w.notes,
-		exercises: exs,
-		is_template: !!w.is_template,
-		user_id: w.user_id,
-		created_by: w.created_by,
-        archived_at: w.archived_at ?? null,
-        sort_order: typeof w.sort_order === 'number' ? w.sort_order : (w.sort_order == null ? 0 : Number(w.sort_order) || 0),
-        created_at: w.created_at ?? null,
-	};
-};
-
-function IronTracksApp({ initialUser, initialProfile, initialWorkouts }) {
-    const { confirm, alert } = useDialog();
-    const [user, setUser] = useState(initialUser ?? null);
-    const [authLoading, setAuthLoading] = useState(false);
-    const [view, setView] = useState('dashboard');
-    const lastTrackedViewRef = useRef('');
-    const [directChat, setDirectChat] = useState(null);
-    const [workouts, setWorkouts] = useState(() => {
-        try {
-            const list = Array.isArray(initialWorkouts) ? initialWorkouts : [];
-            const mapped = list
-                .map((row) => mapWorkoutRow(row))
-                .filter(Boolean)
-                .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-            return mapped;
-        } catch {
-            return [];
-        }
-    });
-    const [stats, setStats] = useState({ workouts: 0, exercises: 0, activeStreak: 0 });
-    const [streakStats, setStreakStats] = useState(null);
-    const streakRefreshRef = useRef({ inFlight: false, lastAt: 0 });
-    const [newRecordsReloadKey, setNewRecordsReloadKey] = useState(0);
-    const [currentWorkout, setCurrentWorkout] = useState(null);
-    const [createWizardOpen, setCreateWizardOpen] = useState(false)
-    const [importCode, setImportCode] = useState('');
-    const [shareCode, setShareCode] = useState(null);
-    const [quickViewWorkout, setQuickViewWorkout] = useState(null);
-    const [showImportModal, setShowImportModal] = useState(false);
-    const [showJsonImportModal, setShowJsonImportModal] = useState(false);
-    const [reportData, setReportData] = useState({ current: null, previous: null });
-    const [reportBackView, setReportBackView] = useState('dashboard');
-    const [duplicatesOpen, setDuplicatesOpen] = useState(false);
-    const [duplicateGroups, setDuplicateGroups] = useState([]);
-    const [duplicatesBusy, setDuplicatesBusy] = useState(false);
-    const inAppNotifyRef = useRef(null);
-    const bindInAppNotify = useCallback((fn) => {
-        inAppNotifyRef.current = typeof fn === 'function' ? fn : null;
-    }, []);
-    const inAppNotify = useCallback((payload) => {
-        const fn = inAppNotifyRef.current;
-        if (typeof fn === 'function') fn(payload);
-    }, []);
-
-    const [preCheckinOpen, setPreCheckinOpen] = useState(false)
-    const [preCheckinWorkout, setPreCheckinWorkout] = useState(null)
-    const [preCheckinDraft, setPreCheckinDraft] = useState({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-    const preCheckinResolveRef = useRef(null)
-
-    const requestPreWorkoutCheckin = useCallback(async (workout) => {
-        if (!user?.id) return null
-        if (preCheckinOpen) return null
-        return await new Promise((resolve) => {
-            preCheckinResolveRef.current = (value) => {
-                resolve(value ?? null)
-            }
-            setPreCheckinWorkout(workout && typeof workout === 'object' ? workout : null)
-            setPreCheckinDraft({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-            setPreCheckinOpen(true)
-        })
-    }, [preCheckinOpen, user?.id])
-    const [settingsOpen, setSettingsOpen] = useState(false)
-    const [whatsNewOpen, setWhatsNewOpen] = useState(false)
-    const [isCoach, setIsCoach] = useState(false);
-    const initialRole = String(initialProfile?.role || '').toLowerCase()
-    const [vipAccess, setVipAccess] = useState(() => ({
-        loaded: initialRole === 'admin' || initialRole === 'teacher',
-        hasVip: initialRole === 'admin' || initialRole === 'teacher',
-    }))
-    const [hasUnreadChat, setHasUnreadChat] = useState(false);
-    const [hasUnreadNotification, setHasUnreadNotification] = useState(false);
-    const [exportWorkout, setExportWorkout] = useState(null);
-    const [showExportModal, setShowExportModal] = useState(false);
-    const [coachPending, setCoachPending] = useState(false);
-    const [studentFolders, setStudentFolders] = useState([]);
-    const [openStudent, setOpenStudent] = useState(null);
-    const [showNotifCenter, setShowNotifCenter] = useState(false);
-    const [exportingAll, setExportingAll] = useState(false);
-
-    const [profileIncomplete, setProfileIncomplete] = useState(false);
-    const [profileDraftName, setProfileDraftName] = useState('');
-    const [savingProfile, setSavingProfile] = useState(false);
-    const [showCompleteProfile, setShowCompleteProfile] = useState(false);
-
-    // Estado Global da Sessão Ativa
-	const [activeSession, setActiveSession] = useState(null);
-	const suppressForeignFinishToastUntilRef = useRef(0);
-    const [sessionTicker, setSessionTicker] = useState(0);
-    const [editActiveOpen, setEditActiveOpen] = useState(false);
-    const [editActiveDraft, setEditActiveDraft] = useState(null);
-    const editActiveBaseRef = useRef(null);
-    const editActiveAddExerciseRef = useRef(false);
-    const [showAdminPanel, setShowAdminPanel] = useState(false);
-    const userSettingsApi = useUserSettings(user?.id)
-    const whatsNewShownRef = useRef(false)
-    const TOUR_VERSION = 1
-    const [tourOpen, setTourOpen] = useState(false)
-    const [tourBoot, setTourBoot] = useState({ loaded: false, completed: false, skipped: false, version: TOUR_VERSION })
-    const [syncState, setSyncState] = useState({ online: true, syncing: false, pending: 0 })
-    const [offlineSyncOpen, setOfflineSyncOpen] = useState(false)
-
-    // Local fallback to guarantee the tour doesn't re-open when DB upsert fails/offline.
-    // Stored per-user AND per-tour-version.
-    const getTourLocalKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.dismissed.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourAutoOpenedKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.autoOpened.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourSeenKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.seen.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const readLocalTourDismissal = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return null
-        try {
-            if (typeof window === 'undefined') return null
-            const key = getTourLocalKey(safeUid)
-            if (!key) return null
-            const raw = window.localStorage.getItem(key) || ''
-            if (!raw) return null
-            const parsed = JSON.parse(raw)
-            if (!parsed || typeof parsed !== 'object') return null
-            const version = Number(parsed?.version || 0) || 0
-            if (version !== TOUR_VERSION) return null
-            const status = String(parsed?.status || '')
-            if (status !== 'completed' && status !== 'skipped') return null
-            return { version, status, at: Number(parsed?.at || 0) || 0 }
-        } catch {
-            return null
-        }
-    }, [TOUR_VERSION, getTourLocalKey])
-    const writeLocalTourDismissal = useCallback((uid, status) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        const safeStatus = status === 'completed' ? 'completed' : 'skipped'
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourLocalKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, JSON.stringify({ version: TOUR_VERSION, status: safeStatus, at: Date.now() }))
-        } catch {}
-    }, [TOUR_VERSION, getTourLocalKey])
-    const wasTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourSeenKey(safeUid)
-            if (!key) return false
-            return (window.localStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourSeenKey])
-    const markTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourSeenKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourSeenKey])
-    const wasTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return false
-            return (window.sessionStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourAutoOpenedKey])
-    const markTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return
-            window.sessionStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourAutoOpenedKey])
-
-    const supabase = useRef(createClient()).current;
-    const router = useRouter();
-    const isFetching = useRef(false);
-
-    const ADMIN_PANEL_OPEN_KEY = 'irontracks_admin_panel_open';
-
-    const refreshSyncState = useCallback(async () => {
-        try {
-            const online = isOnline()
-            const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-            if (offlineSyncV2Enabled) {
-                const sum = await getOfflineQueueSummary({ userId: user?.id })
-                if (sum?.ok) {
-                    setSyncState((prev) => ({
-                        ...(prev || {}),
-                        online: sum.online !== false,
-                        pending: Number(sum.pending || 0),
-                        failed: Number(sum.failed || 0),
-                        due: Number(sum.due || 0),
-                    }))
-                    return
-                }
-            }
-            const pending = await getPendingCount(user?.id)
-            setSyncState((prev) => ({ ...(prev || {}), online, pending, failed: 0, due: 0 }))
-        } catch {
-            setSyncState((prev) => ({ ...(prev || {}), online: isOnline() }))
-        }
-    }, [user?.id, userSettingsApi?.settings])
-
-    const runFlushQueue = useCallback(async () => {
-        try {
-            if (!isOnline()) {
-                setSyncState((prev) => ({ ...(prev || {}), online: false }))
-                return
-            }
-            setSyncState((prev) => ({ ...(prev || {}), syncing: true, online: true }))
-            await flushOfflineQueue({ max: 8 })
-        } finally {
-            setSyncState((prev) => ({ ...(prev || {}), syncing: false }))
-            await refreshSyncState()
-        }
-    }, [refreshSyncState])
-
-    useEffect(() => {
-        refreshSyncState()
-        const onChanged = () => refreshSyncState()
-        const onOnline = () => runFlushQueue()
-        const onOffline = () => refreshSyncState()
-        try {
-            window.addEventListener('irontracks.offlineQueueChanged', onChanged)
-            window.addEventListener('online', onOnline)
-            window.addEventListener('offline', onOffline)
-        } catch {}
-        return () => {
-            try {
-                window.removeEventListener('irontracks.offlineQueueChanged', onChanged)
-                window.removeEventListener('online', onOnline)
-                window.removeEventListener('offline', onOffline)
-            } catch {}
-        }
-    }, [refreshSyncState, runFlushQueue])
-
-    useEffect(() => {
-        if (!user?.id) return
-        if (!isOnline()) return
-        if ((syncState?.pending || 0) <= 0) return
-        const t = setInterval(() => {
-            runFlushQueue()
-        }, 15000)
-        return () => clearInterval(t)
-    }, [runFlushQueue, syncState?.pending, user?.id])
-
-    const logTourEvent = useCallback(async (event, payload) => {
-        try {
-            if (!user?.id) return
-            const ev = String(event || '').trim()
-            if (!ev) return
-            const basePayload = payload && typeof payload === 'object' ? payload : {}
-            const enriched = {
-                ...basePayload,
-                role: String(user?.role || ''),
-                path: (() => {
-                    try { return typeof window !== 'undefined' ? String(window.location.pathname || '') : '' } catch { return '' }
-                })(),
-            }
-            await supabase.from('onboarding_events').insert({
-                user_id: user.id,
-                event: ev,
-                payload: enriched,
-            })
-        } catch {}
-    }, [supabase, user?.id, user?.role])
-
-    const upsertTourFlags = useCallback(async (patch) => {
-        try {
-            if (!user?.id) return { ok: false, error: 'missing_user' }
-            const base = patch && typeof patch === 'object' ? patch : {}
-            const payload = {
-                user_id: user.id,
-                preferences: userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {},
-                tour_version: TOUR_VERSION,
-                updated_at: new Date().toISOString(),
-                ...base,
-            }
-            await supabase.from('user_settings').upsert(payload, { onConflict: 'user_id' })
-            return { ok: true }
-        } catch (e) {
-            return { ok: false, error: e?.message ?? String(e) }
-        }
-    }, [TOUR_VERSION, supabase, user?.id, userSettingsApi?.settings])
-
-    useEffect(() => {
-        if (!user?.id) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const uid = String(user.id)
-                const localDismissal = readLocalTourDismissal(uid)
-                if (localDismissal) {
-                    // Defensive: if the user already dismissed locally (offline, blocked RLS, etc.), never auto-open again.
-                    const completed = localDismissal.status === 'completed'
-                    const skipped = localDismissal.status === 'skipped'
-                    setTourBoot({ loaded: true, completed, skipped, version: TOUR_VERSION })
-                    return
-                }
-
-                const { data } = await supabase
-                    .from('user_settings')
-                    .select('tour_version, tour_completed_at, tour_skipped_at')
-                    .eq('user_id', user.id)
-                    .maybeSingle()
-
-                if (cancelled) return
-
-                const dbVersion = Number(data?.tour_version || 0) || 0
-                // Only force a new auto-open when the DB explicitly says an older version was seen.
-                // If dbVersion is missing/0 but completed_at exists, we respect completed/skipped to avoid annoying loops.
-                const needsNewVersion = dbVersion > 0 && dbVersion < TOUR_VERSION
-                const completed = needsNewVersion ? false : !!data?.tour_completed_at
-                const skipped = needsNewVersion ? false : !!data?.tour_skipped_at
-                setTourBoot({ loaded: true, completed, skipped, version: dbVersion || TOUR_VERSION })
-
-                const shouldOpen = !wasTourSeenEver(uid) && !wasTourAutoOpenedThisSession(uid) && (!completed && !skipped)
-                if (shouldOpen) {
-                    markTourAutoOpenedThisSession(uid)
-                    markTourSeenEver(uid)
-                    await logTourEvent('tour_started', { auto: true, version: TOUR_VERSION })
-                    setTourOpen(true)
-                }
-            } catch {
-                if (!cancelled) setTourBoot((prev) => ({ ...(prev || {}), loaded: true }))
-            }
-        })()
-        return () => {
-            cancelled = true
-        }
-    }, [TOUR_VERSION, logTourEvent, markTourAutoOpenedThisSession, markTourSeenEver, readLocalTourDismissal, supabase, user?.id, wasTourAutoOpenedThisSession, wasTourSeenEver])
-
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : '';
-        if (!uid) return;
-        const key = `irontracks.socialPresencePing.v1.${uid}`;
-        try {
-            if (typeof window !== 'undefined') {
-                const seen = window.sessionStorage.getItem(key) || '';
-                if (seen === '1') return;
-                window.sessionStorage.setItem(key, '1');
-            }
-        } catch {}
-        try {
-            fetch('/api/social/presence/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-        try {
-            fetch('/api/profiles/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-    }, [user?.id]);
-
-    useEffect(() => {
-        if (authLoading) return;
-        if (user) return;
-        const t = setTimeout(() => {
-            try {
-                router.replace('/?next=/dashboard');
-            } catch {}
-        }, 150);
-        return () => {
-            clearTimeout(t);
-        };
-    }, [authLoading, user, router]);
-
-    useEffect(() => {
-        if (whatsNewShownRef.current) return
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        if (!userSettingsApi?.loaded) return
-        const entry = getLatestWhatsNew()
-        if (!entry?.id) return
-        const prefs = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-        if (prefs?.whatsNewAutoOpen === false) return
-        const lastSeenId = String(prefs?.whatsNewLastSeenId || '')
-        const lastSeenAt = Number(prefs?.whatsNewLastSeenAt || 0) || 0
-        const remind24h = prefs?.whatsNewRemind24h !== false
-        const within24h = lastSeenAt > 0 && Date.now() - lastSeenAt < 24 * 60 * 60 * 1000
-        if (lastSeenId === String(entry.id)) {
-            if (!remind24h) return
-            if (within24h) return
-        }
-        whatsNewShownRef.current = true
-        setWhatsNewOpen(true)
-    }, [user?.id, userSettingsApi?.loaded, userSettingsApi?.settings])
-
-    const closeWhatsNew = useCallback(async () => {
-        try {
-            setWhatsNewOpen(false)
-            const entry = getLatestWhatsNew()
-            if (!entry?.id) return
-            const prev = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-            const prevSeenId = String(prev?.whatsNewLastSeenId || '')
-            const nextSeenAt = Date.now()
-            const next = { ...(prev || {}), whatsNewLastSeenId: String(entry.id), whatsNewLastSeenAt: nextSeenAt }
-            try { userSettingsApi?.setSettings?.(next) } catch {}
-            try { await userSettingsApi?.save?.(next) } catch {}
-        } catch {}
-    }, [userSettingsApi])
-    const ADMIN_PANEL_TAB_KEY = 'irontracks_admin_panel_tab';
-
-    const setUrlTabParam = useCallback((nextTab) => {
-        try {
-            if (typeof window === 'undefined') return;
-            const tabValue = String(nextTab || '').trim();
-            if (!tabValue) return;
-            const url = new URL(window.location.href);
-            url.searchParams.set('tab', tabValue);
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const removeUrlTabParam = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const url = new URL(window.location.href);
-            url.searchParams.delete('tab');
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const openAdminPanel = useCallback((tab) => {
-        try {
-            trackUserEvent('open_admin_panel', { type: 'admin', metadata: { tab: tab ? String(tab) : null } })
-        } catch {}
-        setShowAdminPanel(true);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                if (tab) sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, String(tab));
-                if (tab) setUrlTabParam(tab);
-            }
-        } catch {}
-    }, [setUrlTabParam]);
-
-    const closeAdminPanel = useCallback(() => {
-        setShowAdminPanel(false);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.removeItem(ADMIN_PANEL_OPEN_KEY);
-                sessionStorage.removeItem(ADMIN_PANEL_TAB_KEY);
-            }
-        } catch {}
-        removeUrlTabParam();
-    }, [removeUrlTabParam]);
-
-    const restoreAdminPanelIfNeeded = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const role = String(user?.role || '').toLowerCase();
-            const isPrivileged = role === 'admin' || role === 'teacher';
-            if (!isPrivileged) return;
-
-            const validTabs = new Set(['dashboard', 'students', 'teachers', 'templates', 'videos', 'broadcast', 'system']);
-            const url = new URL(window.location.href);
-            const urlTabRaw = String(url.searchParams.get('tab') || '').trim();
-            const urlTab = validTabs.has(urlTabRaw) ? urlTabRaw : '';
-
-            const open = sessionStorage.getItem(ADMIN_PANEL_OPEN_KEY);
-            const storedTabRaw = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-            const storedTab = validTabs.has(storedTabRaw) ? storedTabRaw : '';
-
-            const shouldOpen = open === '1' || !!urlTab;
-            if (!shouldOpen) return;
-
-            const tab = urlTab || storedTab || 'dashboard';
-            try {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, tab);
-            } catch {}
-            if (!urlTab && tab) setUrlTabParam(tab);
-            setShowAdminPanel(true);
-        } catch {}
-    }, [setUrlTabParam, user?.role]);
-
-    const resolveExerciseVideos = useCallback(async (exercises) => {
-        try {
-            const list = Array.isArray(exercises) ? exercises : [];
-            const missingNames = list
-                .map((ex) => {
-                    const name = String(ex?.name || '').trim();
-                    if (!name) return null;
-                    const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                    if (current) return null;
-                    return name;
-                })
-                .filter(Boolean);
-
-            const uniqueNames = Array.from(new Set(missingNames)).slice(0, 80);
-            if (!uniqueNames.length) return { exercises: list, updates: [] };
-
-            const res = await fetch('/api/exercise-library/resolve', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ names: uniqueNames }),
-            });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return { exercises: list, updates: [] };
-
-            const videos = json?.videos && typeof json.videos === 'object' ? json.videos : {};
-            const updates = [];
-
-            const next = list.map((ex) => {
-                const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                if (current) return ex;
-                const normalized = normalizeExerciseName(String(ex?.name || ''));
-                const url = normalized ? String(videos[normalized] || '').trim() : '';
-                if (!url) return ex;
-                if (ex?.id) updates.push({ id: ex.id, url });
-                return { ...ex, videoUrl: url, video_url: url };
-            });
-
-            return { exercises: next, updates };
-        } catch {
-            return { exercises: Array.isArray(exercises) ? exercises : [], updates: [] };
-        }
-    }, []);
-
-    const persistExerciseVideoUrls = useCallback(async (updates) => {
-        try {
-            const rows = Array.isArray(updates) ? updates : [];
-            const filtered = rows
-                .map((r) => ({ id: String(r?.id || '').trim(), url: String(r?.url || '').trim() }))
-                .filter((r) => !!r.id && !!r.url)
-                .slice(0, 100);
-            if (!filtered.length) return;
-            await Promise.allSettled(filtered.map((r) => supabase.from('exercises').update({ video_url: r.url }).eq('id', r.id)));
-        } catch {}
-    }, [supabase]);
-
-    const signOutInFlightRef = useRef(false);
-    const serverSessionSyncRef = useRef({ timer: null, lastKey: '' });
-    const serverSessionSyncWarnedRef = useRef(false);
-
-    const generateExerciseKey = useCallback(() => {
-        try {
-            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
-        } catch {}
-        return `ex_${Date.now()}_${Math.random().toString(16).slice(2)}`;
-    }, []);
-
-    const normalizeWorkoutForEditor = useCallback((raw) => {
-        try {
-            const base = raw && typeof raw === 'object' ? raw : {};
-            const title = String(base.title || base.name || 'Treino').trim() || 'Treino';
-            const exercisesRaw = Array.isArray(base.exercises) ? base.exercises : [];
-            const exercisesInitial = exercisesRaw.filter((ex) => ex && typeof ex === 'object').map((ex) => {
-                const existing = ex?._itx_exKey ? String(ex._itx_exKey) : '';
-                const fromId = ex?.id != null ? `id_${String(ex.id)}` : '';
-                const nextKey = existing || fromId || generateExerciseKey();
-                return { ...ex, _itx_exKey: nextKey };
-            });
-
-            const seen = new Set();
-            const exercises = exercisesInitial.map((ex) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k || seen.has(k)) {
-                    const nextKey = generateExerciseKey();
-                    seen.add(nextKey);
-                    return { ...ex, _itx_exKey: nextKey };
-                }
-                seen.add(k);
-                return ex;
-            });
-
-            return { ...base, title, exercises };
-        } catch {
-            return { title: 'Treino', exercises: [] };
-        }
-    }, [generateExerciseKey]);
-
-    const stripWorkoutInternalKeys = useCallback((workout) => {
-        try {
-            const w = workout && typeof workout === 'object' ? workout : {};
-            const exercises = Array.isArray(w.exercises)
-                ? w.exercises.map((ex) => {
-                      if (!ex || typeof ex !== 'object') return ex;
-                      const { _itx_exKey, ...rest } = ex;
-                      return rest;
-                  })
-                : w.exercises;
-            return { ...w, exercises };
-        } catch {
-            return workout;
-        }
-    }, []);
-
-    const reindexSessionLogsAfterWorkoutEdit = useCallback((oldWorkout, newWorkout, logs) => {
-        try {
-            const safeLogs = logs && typeof logs === 'object' ? logs : {};
-            const oldExercises = Array.isArray(oldWorkout?.exercises) ? oldWorkout.exercises : [];
-            const newExercises = Array.isArray(newWorkout?.exercises) ? newWorkout.exercises : [];
-            const oldKeyByIndex = oldExercises.map((ex) => String(ex?._itx_exKey || ''));
-            const newIndexByKey = new Map();
-            newExercises.forEach((ex, idx) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k) return;
-                if (newIndexByKey.has(k)) return;
-                newIndexByKey.set(k, idx);
-            });
-
-            const result = {};
-
-            Object.entries(safeLogs).forEach(([k, v]) => {
-                const parts = String(k || '').split('-');
-                if (parts.length !== 2) {
-                    result[k] = v;
-                    return;
-                }
-                const oldIdx = Number(parts[0]);
-                const setIdx = Number(parts[1]);
-                if (!Number.isFinite(oldIdx) || !Number.isFinite(setIdx)) {
-                    result[k] = v;
-                    return;
-                }
-                const exKey = oldKeyByIndex[oldIdx] || '';
-                const newIdx = exKey ? newIndexByKey.get(exKey) : undefined;
-                if (typeof newIdx !== 'number' || newIdx < 0) return;
-                const ex = newExercises[newIdx] || null;
-                const headerSets = Number.parseInt(ex?.sets, 10) || 0;
-                const details = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-                const maxSets = headerSets || (Array.isArray(details) ? details.length : 0);
-                if (maxSets && setIdx >= maxSets) return;
-                result[`${newIdx}-${setIdx}`] = v;
-            });
-
-            return result;
-        } catch {
-            return logs && typeof logs === 'object' ? logs : {};
-        }
-    }, []);
-
-    const clearSupabaseCookiesBestEffort = useCallback(() => {
-        try {
-            if (typeof document === 'undefined') return;
-            const raw = String(document.cookie || '');
-            const cookieNames = raw
-                .split(';')
-                .map((p) => p.trim())
-                .map((p) => p.split('=')[0])
-                .filter(Boolean);
-            const targets = cookieNames.filter((n) => n.startsWith('sb-') || n.includes('supabase'));
-            targets.forEach((name) => {
-                try {
-                    document.cookie = `${name}=; Max-Age=0; path=/`;
-                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
-                } catch {}
-            });
-        } catch {}
-    }, []);
-
-    const clearSupabaseStorageBestEffort = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const ls = window.localStorage;
-            if (!ls) return;
-            const keys = [];
-            for (let i = 0; i < ls.length; i++) {
-                const k = ls.key(i);
-                if (!k) continue;
-                if (k.startsWith('sb-') || k.includes('supabase') || k.includes('auth-token')) keys.push(k);
-            }
-            keys.forEach((k) => {
-                try { ls.removeItem(k); } catch {}
-            });
-        } catch {}
-    }, []);
-
-		const clearClientSessionState = useCallback(() => {
-		try {
-			localStorage.removeItem('activeSession');
-			localStorage.removeItem('appView');
-			if (user?.id) {
-				localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-				localStorage.removeItem(`irontracks.appView.v2.${user.id}`);
-			}
-		} catch {}
-		setActiveSession(null);
-		setView('dashboard');
-	}, [user?.id]);
-
-    const safeSignOut = useCallback(async (scope = 'local') => {
-        if (signOutInFlightRef.current) return;
-        signOutInFlightRef.current = true;
-        try {
-            clearSupabaseCookiesBestEffort();
-            clearSupabaseStorageBestEffort();
-        } catch (e) {
-            try {
-                clearSupabaseCookiesBestEffort();
-                clearSupabaseStorageBestEffort();
-            } catch {}
-        } finally {
-            signOutInFlightRef.current = false;
-        }
-    }, [clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        const scopedKey = `irontracks.activeSession.v2.${userId}`;
-        let localSavedAt = 0;
-
-        try {
-            const raw = localStorage.getItem(scopedKey) || localStorage.getItem('activeSession');
-            if (raw) {
-                const parsed = JSON.parse(raw);
-                if (parsed && typeof parsed === 'object' && parsed?.startedAt && parsed?.workout) {
-                    localSavedAt = Number(parsed?._savedAt ?? 0) || 0;
-                    setActiveSession(parsed);
-                    setView('active');
-
-                    if (!localStorage.getItem(scopedKey)) {
-                        try {
-                            localStorage.setItem(scopedKey, JSON.stringify(parsed));
-                            localStorage.removeItem('activeSession');
-                        } catch {}
-                    }
-                }
-            }
-        } catch {
-            try {
-                localStorage.removeItem(scopedKey);
-                localStorage.removeItem('activeSession');
-            } catch {}
-        }
-
-        const loadServer = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('active_workout_sessions')
-                    .select('state, updated_at')
-                    .eq('user_id', userId)
-                    .maybeSingle();
-                if (cancelled) return;
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                    return;
-                }
-
-                const state = data?.state;
-                if (!state || typeof state !== 'object') return;
-                if (!state?.startedAt || !state?.workout) return;
-
-                const updatedAtMs = (() => {
-                    const fromCol = typeof data?.updated_at === 'string' ? Date.parse(data.updated_at) : NaN;
-                    const fromState = Number(state?._savedAt ?? 0) || 0;
-                    return Math.max(Number.isFinite(fromCol) ? fromCol : 0, fromState);
-                })();
-
-                if (updatedAtMs <= localSavedAt) return;
-
-                setActiveSession(state);
-                setView('active');
-                try {
-                    localStorage.setItem(scopedKey, JSON.stringify(state));
-                } catch {}
-            } catch {}
-        };
-
-        loadServer();
-
-        return () => {
-            cancelled = true;
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        let mounted = true;
-        let channel;
-
-        try {
-            channel = supabase
-                .channel(`active-workout-session:${userId}`)
-                .on(
-                    'postgres_changes',
-                    {
-                        event: '*',
-                        schema: 'public',
-                        table: 'active_workout_sessions',
-                        filter: `user_id=eq.${userId}`,
-                    },
-                    (payload) => {
-                        try {
-                            if (!mounted) return;
-						const ev = String(payload?.eventType || '').toUpperCase();
-						if (ev === 'DELETE') {
-							if (Date.now() < (suppressForeignFinishToastUntilRef.current || 0)) {
-								suppressForeignFinishToastUntilRef.current = 0;
-								return;
-							}
-							setActiveSession(null);
-							setView('dashboard');
-							try {
-								localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-							} catch {}
-                                try {
-                                    inAppNotify({
-                                        text: 'Treino finalizado em outro dispositivo.',
-                                        senderName: 'Aviso do Sistema',
-                                        displayName: 'Sistema',
-                                        photoURL: null,
-                                    });
-                                } catch {}
-                                return;
-                            }
-
-                            if (ev === 'UPDATE') {
-                                const state = payload?.new?.state;
-                                if (!state || typeof state !== 'object' || !state?.startedAt || !state?.workout) {
-                                    setActiveSession(null);
-                                    setView('dashboard');
-                                    try {
-                                        localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-                                    } catch {}
-                                }
-                            }
-                        } catch {}
-                    }
-                )
-                .subscribe();
-        } catch {}
-
-        return () => {
-            mounted = false;
-            try {
-                if (channel) supabase.removeChannel(channel);
-            } catch {
-                try {
-                    if (channel) createClient().removeChannel(channel);
-                } catch {}
-            }
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const handler = () => { try { unlockAudio(); } catch {} };
-        document.addEventListener('touchstart', handler, { once: true });
-        document.addEventListener('click', handler, { once: true });
-        return () => {
-            document.removeEventListener('touchstart', handler);
-            document.removeEventListener('click', handler);
-        };
-    }, [supabase, alert, clearClientSessionState]);
-
-    // Persistência da View (Aba Atual)
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const scopedViewKey = `irontracks.appView.v2.${user.id}`;
-            const scopedSessionKey = `irontracks.activeSession.v2.${user.id}`;
-            const savedSession = localStorage.getItem(scopedSessionKey);
-            if (savedSession) {
-                setView('active');
-                return;
-            }
-
-            const raw = localStorage.getItem(scopedViewKey) || localStorage.getItem('appView');
-            const savedView = raw ? String(raw) : '';
-            if (!savedView) {
-                setView('dashboard');
-                return;
-            }
-
-            if (savedView === 'active') {
-                setView('dashboard');
-                return;
-            }
-
-            setView(savedView);
-        } catch {
-            setView('dashboard');
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            if (!view) return;
-            localStorage.setItem(`irontracks.appView.v2.${user.id}`, view);
-        } catch {
-            return;
-        }
-    }, [view, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const key = `irontracks.activeSession.v2.${user.id}`;
-            if (!activeSession) {
-                localStorage.removeItem(key);
-                localStorage.removeItem('activeSession');
-                return;
-            }
-
-            const payload = JSON.stringify({ ...(activeSession || {}), _savedAt: Date.now() });
-            const id = setTimeout(() => {
-                try {
-                    localStorage.setItem(key, payload);
-                } catch {}
-            }, 250);
-            return () => clearTimeout(id);
-        } catch {
-            return;
-        }
-    }, [activeSession, user?.id]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        try {
-            if (serverSessionSyncRef.current?.timer) {
-                try {
-                    clearTimeout(serverSessionSyncRef.current.timer);
-                } catch {}
-            }
-        } catch {}
-
-        const key = (() => {
-            try {
-                return JSON.stringify(activeSession || null);
-            } catch {
-                return '';
-            }
-        })();
-
-        serverSessionSyncRef.current.lastKey = key;
-
-        const run = async () => {
-            try {
-                if (serverSessionSyncRef.current.lastKey !== key) return;
-
-                if (!activeSession) {
-                    const { error } = await supabase.from('active_workout_sessions').delete().eq('user_id', userId);
-                    if (error) {
-                        const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                        const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                        const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                        if (isMissing && !serverSessionSyncWarnedRef.current) {
-                            serverSessionSyncWarnedRef.current = true;
-                            try {
-                                inAppNotify({
-                                    text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                    senderName: 'Aviso do Sistema',
-                                    displayName: 'Sistema',
-                                    photoURL: null,
-                                });
-                            } catch {}
-                        }
-                    }
-                    return;
-                }
-
-                const startedAtRaw = activeSession?.startedAt;
-                const startedAtMs = typeof startedAtRaw === 'number' ? startedAtRaw : new Date(startedAtRaw || 0).getTime();
-                if (!Number.isFinite(startedAtMs) || startedAtMs <= 0) return;
-                if (!activeSession?.workout) return;
-
-                const state = { ...(activeSession || {}), _savedAt: Date.now() };
-
-                const { error } = await supabase
-                    .from('active_workout_sessions')
-                    .upsert(
-                        {
-                            user_id: userId,
-                            started_at: new Date(startedAtMs).toISOString(),
-                            state,
-                            updated_at: new Date().toISOString(),
-                        },
-                        { onConflict: 'user_id' }
-                    );
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                }
-            } catch {}
-        };
-
-        let timerId = null;
-
-        try {
-            timerId = setTimeout(() => {
-                try {
-                    run();
-                } catch {}
-            }, 900);
-            serverSessionSyncRef.current.timer = timerId;
-        } catch {}
-
-        return () => {
-            try {
-                if (timerId) clearTimeout(timerId);
-            } catch {}
-        };
-    }, [activeSession, supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        if (!activeSession) return;
-        const id = setInterval(() => setSessionTicker(Date.now()), 1000);
-        return () => clearInterval(id);
-    }, [activeSession, view]);
-
-    useEffect(() => {
-        let cancelled = false;
-        if (!user?.id) {
-            setHasUnreadNotification(false);
-            return;
-        }
-
-        const loadInitial = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('notifications')
-                    .select('id')
-                    .eq('user_id', user.id)
-                    .limit(1);
-                if (cancelled) return;
-                if (error) {
-                    console.error('Erro ao carregar notificações:', error);
-                    setHasUnreadNotification(false);
-                    return;
-                }
-                setHasUnreadNotification(Array.isArray(data) && data.length > 0);
-            } catch (e) {
-                if (cancelled) return;
-                console.error('Erro ao carregar notificações:', e);
-                setHasUnreadNotification(false);
-            }
-        };
-
-        loadInitial();
-
-        const channel = supabase
-            .channel(`notifications:badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) setHasUnreadNotification(true);
-            })
-            .on('postgres_changes', {
-                event: 'DELETE',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) loadInitial();
-            })
-            .subscribe();
-
-        return () => {
-            cancelled = true;
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-        const allowNotifyDm = s ? s.notifyDirectMessages !== false : true
-
-        const channel = supabase
-            .channel(`direct-messages-badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'direct_messages'
-            }, async (payload) => {
-                try {
-                    if (!allowNotifyDm) return;
-                    const msg = payload.new;
-                    if (!msg || msg.sender_id === user.id) return;
-
-                    const currentView = view;
-                    if (currentView === 'chat' || currentView === 'chatList' || currentView === 'directChat' || currentView === 'globalChat') {
-                        return;
-                    }
-
-                    const { data: senderProfile } = await supabase
-                        .from('profiles')
-                        .select('display_name')
-                        .eq('id', msg.sender_id)
-                        .maybeSingle();
-
-                    const senderName = senderProfile?.display_name || 'Nova mensagem';
-                    const preview = String(msg.content || '').slice(0, 120);
-                    if (!preview) return;
-
-                    await fetch('/api/notifications/direct-message', {
-                        method: 'POST',
-                        headers: { 'Content-Type': 'application/json' },
-                        body: JSON.stringify({
-                            receiverId: user.id,
-                            senderName,
-                            preview,
-                        }),
-                    });
-                } catch (e) {
-                    console.error('Erro ao gerar notificação de mensagem direta:', e);
-                }
-            })
-            .subscribe();
-
-        return () => {
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id, userSettingsApi?.settings, view]);
-
-    useEffect(() => {
-        const baseUser = initialUser && typeof initialUser === 'object' ? initialUser : null
-        if (!baseUser?.id) {
-            try {
-                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-            } catch {}
-            return
-        }
-        const meta = baseUser?.user_metadata || {}
-        const emailRaw = String(baseUser?.email || '').trim()
-        const emailUser = emailRaw.includes('@') ? emailRaw.split('@')[0] : (emailRaw || 'Usuário')
-        const profileDisplayName = String(initialProfile?.display_name || initialProfile?.displayName || '').trim()
-        const profilePhotoURL = String(initialProfile?.photo_url || initialProfile?.photoURL || initialProfile?.photoUrl || '').trim()
-        const metaDisplayName = String(meta?.full_name || meta?.name || '').trim()
-        const displayName = profileDisplayName || metaDisplayName || emailUser
-        const photoURL = profilePhotoURL || meta?.avatar_url || meta?.picture || null
-        const nextUser = { ...baseUser, displayName, photoURL, role: initialProfile?.role || 'user' }
-        setUser(nextUser)
-        const role = String(initialProfile?.role || '').toLowerCase()
-        setIsCoach(role === 'teacher' || role === 'admin')
-    }, [initialUser, initialProfile])
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const res = await fetch('/api/vip/access', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                const json = await res.json().catch(() => null)
-                if (cancelled) return
-                if (json && json.ok) {
-                    setVipAccess({ loaded: true, hasVip: !!json.hasVip })
-                    return
-                }
-                setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            } catch {
-                if (!cancelled) setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            }
-        })()
-        return () => { cancelled = true }
-    }, [user?.id])
-
-    useEffect(() => {
-        try {
-            const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {
-                try {
-                    const ev = String(_event || '').toUpperCase()
-                    if (session && session.user?.id) return
-                    if (ev === 'SIGNED_OUT') {
-                        clearClientSessionState()
-                        if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                        return
-                    }
-                    if (ev === 'INITIAL_SESSION') {
-                        fetch('/api/auth/ping', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                            .then((r) => {
-                                if (r && r.status === 204) return
-                                clearClientSessionState()
-                                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                            })
-                            .catch(() => {})
-                        return
-                    }
-                } catch {}
-            })
-            return () => {
-                try { sub?.subscription?.unsubscribe?.() } catch {}
-            }
-        } catch {
-            return
-        }
-    }, [supabase, clearClientSessionState, clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort])
-
-    useEffect(() => {
-        restoreAdminPanelIfNeeded();
-        const onVisibility = () => {
-            if (typeof document === 'undefined') return;
-            if (document.visibilityState === 'visible') restoreAdminPanelIfNeeded();
-        };
-        const onPageShow = () => restoreAdminPanelIfNeeded();
-        try {
-            document.addEventListener('visibilitychange', onVisibility);
-            window.addEventListener('pageshow', onPageShow);
-        } catch {}
-        return () => {
-            try {
-                document.removeEventListener('visibilitychange', onVisibility);
-                window.removeEventListener('pageshow', onPageShow);
-            } catch {}
-        };
-    }, [restoreAdminPanelIfNeeded]);
-
-    // Sync Profile Separately (Optimized)
-    useEffect(() => {
-        if (user?.id) {
-             const syncProfile = async () => {
-                 try {
-                    return
-                 } catch (e) {
-                    console.error('Erro ao sincronizar perfil:', e);
-                 }
-             };
-             syncProfile();
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const run = async () => {
-            if (!user?.id) {
-                if (!cancelled) {
-                    setProfileIncomplete(false);
-                    setProfileDraftName('');
-                }
-                return;
-            }
-
-            try {
-                const seedName = String(initialProfile?.display_name || '').trim() || String(user?.displayName || '').trim();
-                if (!cancelled) {
-                    setProfileIncomplete(!seedName);
-                    setProfileDraftName(seedName);
-                }
-            } catch {
-                if (!cancelled) {
-                    setProfileIncomplete(true);
-                    setProfileDraftName(String(user?.displayName || '').trim());
-                }
-            }
-        };
-
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [initialProfile?.display_name, user?.id, user?.displayName]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        let cancelled = false;
-        const run = async () => {
-            try {
-                const res = await fetch('/api/dashboard/bootstrap', { cache: 'no-store', credentials: 'include' });
-                const json = await res.json().catch(() => null);
-                if (cancelled) return;
-                if (!json?.ok) return;
-
-                const prof = json?.profile && typeof json.profile === 'object' ? json.profile : null;
-                const displayName = String(prof?.display_name || '').trim();
-                const photoURL = String(prof?.photo_url || '').trim();
-                const role = String(prof?.role || '').toLowerCase();
-
-                setUser((prev) => {
-                    const current = prev && typeof prev === 'object' ? prev : null;
-                    if (!current) return prev;
-                    const patch = {};
-                    if (displayName && displayName !== current.displayName) patch.displayName = displayName;
-                    if (photoURL && photoURL !== current.photoURL) patch.photoURL = photoURL;
-                    if (role && role !== String(current.role || '').toLowerCase()) patch.role = role;
-                    return Object.keys(patch).length ? { ...current, ...patch } : prev;
-                });
-                if (role) setIsCoach(role === 'teacher' || role === 'admin');
-
-                if (Array.isArray(json.workouts) && json.workouts.length) {
-                    const mapped = json.workouts
-                        .map((row) => mapWorkoutRow(row))
-                        .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-                    setWorkouts(mapped);
-                    const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-                    setStats({ workouts: mapped.length, exercises: totalEx, activeStreak: 0 });
-                }
-            } catch {}
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [user?.id]);
-
-	// Fetch Workouts
-	const fetchWorkouts = useCallback(async (specificUser = user) => {
-        if (isFetching.current) return;
-        isFetching.current = true;
-        
-		try {
-			const currentUser = specificUser;
-
-            if (!currentUser?.id) {
-                console.warn("DASHBOARD: Usuário não identificado ao buscar treinos.");
-                return;
-            }
-
-            if (typeof navigator !== 'undefined' && navigator.onLine === false) {
-                try {
-                    const cached = await cacheGetWorkouts({ userId: currentUser.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-                return
-            }
-
-            const role = String(currentUser?.role || 'user') || 'user';
-
-            let data = []
-            let studentData = []
-            let studentsList = []
-
-            const hydrateWorkouts = async (rows) => {
-                const base = Array.isArray(rows) ? rows.filter((x) => x && typeof x === 'object') : [];
-                const workoutIds = base.map((w) => w.id).filter(Boolean);
-                if (workoutIds.length === 0) return base.map((w) => ({ ...w, exercises: [] }));
-
-                let exercises = [];
-                try {
-                    const { data: exRows } = await supabase
-                        .from('exercises')
-                        .select('*')
-                        .in('workout_id', workoutIds)
-                        .order('order', { ascending: true })
-                        .limit(5000);
-                    exercises = Array.isArray(exRows) ? exRows : [];
-                } catch {
-                    exercises = [];
-                }
-
-                const exIds = exercises.map((e) => e.id).filter(Boolean);
-                let sets = [];
-                if (exIds.length > 0) {
-                    try {
-                        const { data: setRows } = await supabase
-                            .from('sets')
-                            .select('*')
-                            .in('exercise_id', exIds)
-                            .order('set_number', { ascending: true })
-                            .limit(20000);
-                        sets = Array.isArray(setRows) ? setRows : [];
-                    } catch {
-                        sets = [];
-                    }
-                }
-
-                const setsByExercise = new Map();
-                for (const s of sets) {
-                    const eid = s?.exercise_id;
-                    if (!eid) continue;
-                    const list = setsByExercise.get(eid) || [];
-                    list.push(s);
-                    setsByExercise.set(eid, list);
-                }
-
-                const exByWorkout = new Map();
-                for (const ex of exercises) {
-                    const wid = ex?.workout_id;
-                    if (!wid) continue;
-                    const exWithSets = { ...ex, sets: setsByExercise.get(ex.id) || [] };
-                    const list = exByWorkout.get(wid) || [];
-                    list.push(exWithSets);
-                    exByWorkout.set(wid, list);
-                }
-
-                return base.map((w) => ({ ...w, exercises: exByWorkout.get(w.id) || [] }));
-            };
-
-            if (role === 'admin' || role === 'teacher') {
-                // 1. Fetch Students
-                try {
-                    const { data: st } = await supabase
-                        .from('students')
-                        .select('id, name, email, user_id')
-                        .or(`teacher_id.eq.${currentUser.id},user_id.eq.${currentUser.id}`)
-                        .order('name');
-                    studentsList = st || [];
-                } catch (e) { console.error('Erro fetching students', e); }
-
-                // 2. Fetch My Workouts
-                const { data: myBase, error: myErr } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (myErr) throw myErr
-                data = await hydrateWorkouts(myBase || [])
-
-                // 3. Fetch Student Workouts
-                const ids = studentsList.map(s => s.user_id || s.id).filter(Boolean)
-                if (ids.length > 0) {
-                    const seen = new Set()
-                    const combined = []
-                    try {
-                        const { data: swByUserBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('user_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByUser = await hydrateWorkouts(swByUserBase || [])
-                        for (const w of (swByUser || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    try {
-                        const { data: swByStudentBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('student_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByStudent = await hydrateWorkouts(swByStudentBase || [])
-                        for (const w of (swByStudent || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    studentData = combined
-                }
-            } else {
-                const { data: baseRows, error } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (error) throw error
-                data = await hydrateWorkouts(baseRows || [])
-
-                if (!data.length) {
-                    try {
-                        const { data: anyRows, error: anyErr } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('user_id', currentUser.id)
-                            .order('name', { ascending: true })
-                            .limit(500);
-                        if (!anyErr && Array.isArray(anyRows) && anyRows.length) {
-                            data = await hydrateWorkouts(anyRows);
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const { data: studentRow } = await supabase
-                            .from('students')
-                            .select('id')
-                            .eq('user_id', currentUser.id)
-                            .maybeSingle();
-                        const studentId = studentRow?.id ? String(studentRow.id) : '';
-                        if (studentId) {
-                            const { data: legacyBase } = await supabase
-                                .from('workouts')
-                                .select('*')
-                                .eq('is_template', true)
-                                .or(`user_id.eq.${studentId},student_id.eq.${studentId}`)
-                                .order('name', { ascending: true })
-                                .limit(500);
-                            const legacyHydrated = await hydrateWorkouts(legacyBase || []);
-                            const seen = new Set();
-                            const merged = [];
-                            for (const w of legacyHydrated) {
-                                if (!w?.id) continue;
-                                if (seen.has(w.id)) continue;
-                                seen.add(w.id);
-                                merged.push(w);
-                            }
-                            data = merged;
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const resLegacy = await fetch('/api/workouts/list', { cache: 'no-store' });
-                        const jsonLegacy = await resLegacy.json().catch(() => null);
-                        if (jsonLegacy?.ok && Array.isArray(jsonLegacy.rows) && jsonLegacy.rows.length) {
-                            data = (jsonLegacy.rows || []).map((w) => ({
-                                id: w?.id,
-                                name: w?.name,
-                                notes: null,
-                                is_template: true,
-                                user_id: currentUser.id,
-                                created_by: null,
-                                exercises: [],
-                            }));
-                        }
-                    } catch {}
-                }
-            }
-
-			if (Array.isArray(data)) {
-				const mappedRaw = data
-					.map((row) => mapWorkoutRow(row))
-					.filter(Boolean);
-                const mapped = mappedRaw.sort((a, b) => {
-                    const ao = Number.isFinite(Number(a?.sort_order)) ? Number(a.sort_order) : 0
-                    const bo = Number.isFinite(Number(b?.sort_order)) ? Number(b.sort_order) : 0
-                    if (ao !== bo) return ao - bo
-                    return (a.title || '').localeCompare(b.title || '')
-                });
-
-                try {
-                    await cacheSetWorkouts({ userId: currentUser?.id, workouts: mapped })
-                } catch {}
-
-                if (role === 'admin' || role === 'teacher') {
-                    setWorkouts(mapped)
-                    try {
-                        const studentMapped = (studentData || []).map(mapWorkoutRow)
-                        const byStudent = new Map()
-                        for (const w of studentMapped) {
-                            const sid = w.user_id
-                            if (!sid) continue
-                            const list = byStudent.get(sid) || []
-                            list.push(w)
-                            byStudent.set(sid, list)
-                        }
-                        const nameById = new Map()
-                        for (const s of (studentsList || [])) {
-                            const sid = s.user_id || s.id
-                            if (!sid) continue
-                            nameById.set(sid, { name: s.name || String(sid).slice(0,8), email: s.email || '' })
-                        }
-                        const folders = Array.from(byStudent.entries()).map(([sid, list]) => {
-                            const info = nameById.get(sid) || { name: String(sid).slice(0,8), email: '' }
-                            return { id: sid, name: info.name, email: info.email, workouts: list }
-                        }).filter(f => (f.workouts || []).length > 0)
-                        setStudentFolders(folders)
-                    } catch (err) {
-                        console.error("Erro ao processar alunos:", err);
-                        setStudentFolders([])
-                    }
-                } else {
-                    setWorkouts(mapped)
-                    try {
-                        const shared = mapped.filter(w => (w.created_by && w.created_by !== currentUser.id))
-                        const byCoach = new Map()
-                        for (const w of shared) {
-                            const cid = w.created_by
-                            const list = byCoach.get(cid) || []
-                            list.push(w)
-                            byCoach.set(cid, list)
-                        }
-                        const coachIds = Array.from(byCoach.keys())
-                        let profiles = []
-                        if (coachIds.length) {
-                            const { data: profs } = await supabase.from('profiles').select('id, display_name').in('id', coachIds)
-                            profiles = profs || []
-                        }
-                        const nameByCoach = new Map(profiles.map(p => [p.id, p.display_name || String(p.id).slice(0,8)]))
-                        const folders = Array.from(byCoach.entries()).map(([cid, list]) => ({
-                            id: cid,
-                            name: `Treinos compartilhados de ${nameByCoach.get(cid) || String(cid).slice(0,8)}`,
-                            email: '',
-                            workouts: list
-                        }))
-                        setStudentFolders(folders)
-                    } catch {
-                        setStudentFolders([])
-                    }
-                }
-                
-				// Atualiza estatísticas
-				const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-				setStats({ 
-					workouts: mapped.length, 
-					exercises: totalEx, 
-					activeStreak: 0 // Placeholder
-				});
-            } else {
-                console.warn('Fetch sem dados; mantendo estado atual');
-            }
-		} catch (e) {
-			const msg = e?.message ?? String(e);
-			if (msg.includes('Failed to fetch') || msg.includes('ERR_ABORTED')) {
-				// Dev HMR aborts or transient network; ignore quietly
-                try {
-                    const cached = await cacheGetWorkouts({ userId: specificUser?.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-				return;
-			}
-			console.error("Erro ao buscar:", { message: msg, error: e });
-		} finally { isFetching.current = false; }
-	}, [supabase, user]); // Depende apenas do usuário para evitar loops de busca
-
-    useEffect(() => {
-        if (user) {
-            fetchWorkouts(user);
-        }
-    }, [user, fetchWorkouts]);
-
-    useEffect(() => {
-        if (user && workouts.length === 0) {
-            try {
-                const k = 'workouts_cache_' + user.id;
-                const cached = localStorage.getItem(k);
-                if (cached) {
-                    const arr = JSON.parse(cached);
-                    if (Array.isArray(arr) && arr.length > 0) setWorkouts(arr);
-                }
-            } catch {}
-        }
-    }, [user, workouts.length]);
-
-    const refreshStreakStats = useCallback(async ({ force = false } = {}) => {
-        try {
-            if (!user?.id) return;
-            const now = Date.now();
-            const lastAt = Number(streakRefreshRef.current?.lastAt || 0);
-            if (!force && now - lastAt < 8000) return;
-            if (streakRefreshRef.current?.inFlight) return;
-            streakRefreshRef.current = { inFlight: true, lastAt: now };
-            const res = await computeWorkoutStreakAndStats();
-            if (res?.ok && res?.data) setStreakStats(res.data);
-        } catch (e) {
-            console.error('Erro ao calcular streak:', e);
-        } finally {
-            try {
-                streakRefreshRef.current = { ...(streakRefreshRef.current || {}), inFlight: false };
-            } catch {}
-        }
-    }, [user?.id]);
-
-    useEffect(() => {
-        refreshStreakStats({ force: true });
-    }, [refreshStreakStats]);
-
-    useEffect(() => {
-        try {
-            const v = String(view || '').trim() || 'unknown';
-            const prev = String(lastTrackedViewRef.current || '').trim();
-            if (v && v !== prev) {
-                trackScreen(v, { from: prev || null });
-                lastTrackedViewRef.current = v;
-            }
-        } catch {}
-    }, [view]);
-
-
-
-    // Handlers de Sessão
-    const handleLogout = async () => {
-        const ok = await confirm("Deseja realmente sair da sua conta?", "Sair");
-        if (!ok) return;
-        try { clearClientSessionState(); } catch {}
-        try { window.location.href = '/auth/logout'; } catch {}
-    };
-
-    const handleSaveProfile = async () => {
-        if (!user?.id) return;
-        const nextName = String(profileDraftName || '').trim();
-        if (!nextName) {
-            await alert('Informe seu nome para completar o perfil.', 'Perfil incompleto');
-            return;
-        }
-
-        setSavingProfile(true);
-        try {
-            const { data, error } = await supabase
-                .from('profiles')
-                .update({
-                    display_name: nextName,
-                    photo_url: user.photoURL ?? null,
-                    last_seen: new Date().toISOString(),
-                })
-                .eq('id', user.id)
-                .select('id')
-                .maybeSingle();
-            if (error) throw error;
-            if (!data?.id) {
-                await alert('Não foi possível salvar seu perfil (registro não encontrado).', 'Perfil');
-                return;
-            }
-            setProfileIncomplete(false);
-            setShowCompleteProfile(false);
-        } catch (e) {
-            await alert('Erro ao salvar perfil: ' + (e?.message || String(e || '')));
-        } finally {
-            setSavingProfile(false);
-        }
-    };
-
-    const handleStartSession = async (workout) => {
-        const exercisesList = Array.isArray(workout?.exercises)
-            ? workout.exercises.filter(ex => ex && typeof ex === 'object')
-            : [];
-
-        if (exercisesList.length === 0) {
-            await alert('Este treino está sem exercícios válidos. Edite o treino antes de iniciar.', 'Treino incompleto');
-            return;
-        }
-
-        const first = exercisesList[0] || {};
-        const exMin = toMinutesRounded(estimateExerciseSeconds(first));
-        const totalMin = toMinutesRounded(exercisesList.reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0));
-        const workoutTitle = String(workout?.title || workout?.name || 'Treino');
-        const ok = await confirm(`Iniciar "${workoutTitle}"? Primeiro exercício: ~${exMin} min. Estimado total: ~${totalMin} min.`, 'Iniciar Treino');
-        if (!ok) return;
-        let preCheckin = null
-        try {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const prompt = s ? s.promptPreWorkoutCheckin !== false : true
-            if (prompt) {
-                preCheckin = await requestPreWorkoutCheckin(workout)
-                if (preCheckin && user?.id) {
-                    const energyN = Number(preCheckin.energy)
-                    const sorenessN = Number(preCheckin.soreness)
-                    const timeN = Number(preCheckin.timeMinutes)
-                    const { error: checkinError } = await supabase.from('workout_checkins').insert({
-                        user_id: user.id,
-                        kind: 'pre',
-                        planned_workout_id: String(workout?.id || '').trim() ? workout.id : null,
-                        active_session_user_id: null,
-                        energy: Number.isFinite(energyN) && energyN >= 1 && energyN <= 5 ? Math.round(energyN) : null,
-                        soreness: Number.isFinite(sorenessN) && sorenessN >= 0 && sorenessN <= 10 ? Math.round(sorenessN) : null,
-                        notes: String(preCheckin.notes || '').trim() ? String(preCheckin.notes || '').trim() : null,
-                        answers: {
-                            time_minutes: Number.isFinite(timeN) && timeN > 0 ? Math.round(timeN) : null,
-                        },
-                    })
-                    if (checkinError) throw checkinError
-                }
-            }
-        } catch (e) {
-            console.warn('Falha ao salvar check-in pré-treino:', e?.message || String(e || ''))
-        }
-        let resolvedExercises = exercisesList;
-        try {
-            const resolved = await resolveExerciseVideos(exercisesList);
-            resolvedExercises = Array.isArray(resolved?.exercises) ? resolved.exercises : exercisesList;
-            persistExerciseVideoUrls(resolved?.updates || []);
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const enabled = s ? s.enableSounds !== false : true
-            const volumeRaw = Number(s?.soundVolume ?? 100)
-            const volume = Number.isFinite(volumeRaw) ? Math.max(0, Math.min(1, volumeRaw / 100)) : 1
-            playStartSound({ enabled, volume })
-        }
-        setActiveSession({
-            workout: { ...workout, exercises: resolvedExercises },
-            logs: {},
-            ui: {
-                baseExerciseCount: resolvedExercises.length,
-                pendingTemplateUpdate: false,
-                preCheckin: preCheckin && typeof preCheckin === 'object' ? preCheckin : null,
-            },
-            startedAt: Date.now(),
-            timerTargetTime: null,
-            timerContext: null
-        });
-        setView('active');
-        try {
-            const wid = String(workout?.id || '').trim() || null;
-            const title = String(workout?.title || workout?.name || 'Treino').trim();
-            fetch('/api/social/workout-start', {
-                method: 'POST',
-                headers: { 'content-type': 'application/json' },
-                body: JSON.stringify({ workout_id: wid, workout_title: title }),
-            }).catch(() => {});
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const allowPrompt = s ? s.notificationPermissionPrompt !== false : true
-            if (allowPrompt && typeof Notification !== 'undefined' && Notification.permission === 'default') {
-            Notification.requestPermission().catch(e => console.warn('Erro permissão notificação:', e));
-            }
-        }
-    };
-
-    const handleUpdateSessionLog = (key, data) => {
-        if (!activeSession) return;
-        setActiveSession(prev => {
-            if (!prev) return null;
-            return {
-                ...prev,
-                logs: { ...(prev.logs || {}), [key]: data }
-            };
-        });
-    };
-
-    const handleStartTimer = (duration, context) => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return {
-                ...prev,
-                timerTargetTime: Date.now() + (duration * 1000),
-                timerContext: context && typeof context === 'object' ? context : null
-            };
-        });
-    };
-
-    const handleCloseTimer = () => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return { ...prev, timerTargetTime: null, timerContext: null };
-        });
-    };
-
-	const handleFinishSession = async (sessionData, showReport) => {
-		suppressForeignFinishToastUntilRef.current = Date.now() + 8000;
-        try {
-            if (user?.id) {
-                localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-            }
-            localStorage.removeItem('activeSession');
-        } catch {}
-		setActiveSession(null);
-        try {
-            if (user) await fetchWorkouts(user);
-        } catch {}
-        try {
-            await refreshStreakStats({ force: true });
-        } catch {}
-        try {
-            setNewRecordsReloadKey((v) => v + 1);
-        } catch {}
-		if (showReport === false) {
-			setView('dashboard');
-			return;
-		}
-        setReportBackView('dashboard');
-        setReportData({ current: sessionData, previous: null });
-        setView('report');
-    };
-
-    // Handlers CRUD
-    const openManualWorkoutEditor = () => {
-        setCurrentWorkout({ title: '', exercises: [] })
-        setView('edit')
-    }
-	const handleCreateWorkout = () => { setCreateWizardOpen(true) };
-
-	const handleEditWorkout = async (workout) => {
-		if (!workout || !workout.id) return;
-		try {
-			const supabase = createClient();
-			const { data, error } = await supabase
-				.from('workouts')
-				.select('*, exercises(*, sets(*))')
-				.eq('id', workout.id)
-				.maybeSingle();
-			if (error) throw error;
-			if (!data) {
-				setCurrentWorkout(workout);
-				setView('edit');
-				return;
-			}
-			const mapped = mapWorkoutRow(data);
-            try {
-                const resolved = await resolveExerciseVideos(mapped?.exercises || []);
-                const exercises = Array.isArray(resolved?.exercises) ? resolved.exercises : (mapped?.exercises || []);
-                persistExerciseVideoUrls(resolved?.updates || []);
-                setCurrentWorkout({ ...mapped, exercises });
-            } catch {
-                setCurrentWorkout(mapped);
-            }
-			setView('edit');
-		} catch (e) {
-			const msg = e?.message || String(e || '');
-			await alert('Erro ao carregar treino para edição: ' + msg);
-		}
-	};
-
-    const handleSaveWorkout = useCallback(async (workoutToSave) => {
-        const w = workoutToSave || currentWorkout;
-        if (!user || !w || !w.title) return { ok: false, error: 'Treino inválido ou usuário ausente' };
-        try {
-            if (w.id) {
-                const res = await updateWorkout(w.id, w);
-                setCurrentWorkout(w);
-                return res;
-            } else {
-                const created = await createWorkout(w);
-                const id = created?.id ?? null;
-                setCurrentWorkout({ ...w, id });
-                return created;
-            }
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e || 'Falha ao salvar treino');
-            return { ok: false, error: msg };
-        }
-    }, [currentWorkout, user]);
-
-    const handlePersistWorkoutTemplateFromSession = useCallback(async (workoutFromSession) => {
-        try {
-            const normalized = normalizeWorkoutForEditor(workoutFromSession);
-            const cleaned = stripWorkoutInternalKeys(normalized);
-            if (!cleaned || !cleaned.title) return { ok: false, error: 'Treino inválido para salvar' };
-
-            if (cleaned.id) {
-                await updateWorkout(cleaned.id, cleaned);
-                try {
-                    await fetchWorkouts();
-                } catch {}
-                return { ok: true, mode: 'update' };
-            }
-
-            const created = await createWorkout(cleaned);
-            try {
-                await fetchWorkouts();
-            } catch {}
-            return { ok: true, mode: 'create', id: created?.id ?? null };
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e);
-            return { ok: false, error: msg || 'Falha ao salvar treino' };
-        }
-    }, [fetchWorkouts, normalizeWorkoutForEditor, stripWorkoutInternalKeys]);
-
-    const handleOpenActiveWorkoutEditor = useCallback((options = {}) => {
-        try {
-            if (!activeSession?.workout) return;
-            const base = normalizeWorkoutForEditor(activeSession.workout);
-            const shouldAddExercise = options && typeof options === 'object' ? !!options.addExercise : false;
-            editActiveAddExerciseRef.current = shouldAddExercise;
-            const nextBase = shouldAddExercise
-                ? {
-                    ...base,
-                    exercises: [
-                        ...(Array.isArray(base?.exercises) ? base.exercises : []),
-                        {
-                            name: '',
-                            sets: 4,
-                            reps: '10',
-                            rpe: '8',
-                            cadence: '2020',
-                            restTime: 60,
-                            method: 'Normal',
-                            videoUrl: '',
-                            notes: ''
-                        }
-                    ]
-                }
-                : base;
-            editActiveBaseRef.current = base;
-            setEditActiveDraft(nextBase);
-            setEditActiveOpen(true);
-        } catch {}
-    }, [activeSession?.workout, normalizeWorkoutForEditor]);
-
-    const handleCloseActiveWorkoutEditor = useCallback(() => {
-        try {
-            setEditActiveOpen(false);
-            setEditActiveDraft(null);
-            editActiveBaseRef.current = null;
-            editActiveAddExerciseRef.current = false;
-        } catch {}
-    }, []);
-
-    const handleSaveActiveWorkoutEditor = useCallback(async (workoutFromEditor) => {
-        const normalized = normalizeWorkoutForEditor(workoutFromEditor);
-        const cleaned = stripWorkoutInternalKeys(normalized);
-        const shouldDeferPersist = !!editActiveAddExerciseRef.current;
-        const res = shouldDeferPersist ? { deferred: true } : await handleSaveWorkout(cleaned);
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            const oldWorkout = editActiveBaseRef.current || normalizeWorkoutForEditor(prev.workout);
-            const nextLogs = reindexSessionLogsAfterWorkoutEdit(oldWorkout, normalized, prev.logs || {});
-            const baseUi = prev?.ui && typeof prev.ui === 'object' ? prev.ui : {};
-            const nextUi = shouldDeferPersist ? { ...baseUi, pendingTemplateUpdate: true } : baseUi;
-            return { ...prev, workout: normalized, logs: nextLogs, ui: nextUi };
-        });
-        editActiveBaseRef.current = normalized;
-        setEditActiveDraft(normalized);
-        return res;
-    }, [handleSaveWorkout, normalizeWorkoutForEditor, reindexSessionLogsAfterWorkoutEdit, stripWorkoutInternalKeys]);
-
-	const handleDeleteWorkout = async (id, title) => {
-		const name = title || (workouts.find(w => w.id === id)?.title) || 'este treino';
-		if (!(await confirm(`Apagar o treino "${name}"?`, "Excluir Treino"))) return;
-		try {
-			const res = await deleteWorkout(id);
-			if (!res?.success) {
-				await alert("Erro: " + (res?.error || 'Falha ao excluir treino'));
-				return;
-			}
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro: " + (e?.message ?? String(e))); }
-	};
-
-    const handleRestoreWorkout = async (workout) => {
-        const id = String(workout?.id || '').trim()
-        if (!id) return
-        const name = workout?.title || 'este treino'
-        if (!(await confirm(`Restaurar o treino "${name}"?`, 'Restaurar Treino'))) return
-        try {
-            const res = await setWorkoutArchived(id, false)
-            if (!res?.ok) {
-                await alert('Erro: ' + (res?.error || 'Falha ao restaurar treino'))
-                return
-            }
-            await fetchWorkouts()
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)))
-        }
-    }
-
-	const handleDuplicateWorkout = async (workout) => {
-		if (!(await confirm(`Duplicar "${workout.title}"?`, "Duplicar Treino"))) return;
-		const newWorkout = { ...workout, title: `${workout.title} (Cópia)` };
-		delete newWorkout.id;
-		try {
-			await createWorkout(newWorkout);
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro ao duplicar: " + (e?.message ?? String(e))); }
-	};
-
-    const handleBulkEditWorkouts = async (items) => {
-        try {
-            const arr = Array.isArray(items) ? items : []
-            if (!arr.length) return
-            let updatedTitles = 0
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const w = workouts.find((x) => String(x?.id || '') === id)
-                if (!w) continue
-
-                const desiredTitle = String(it?.title || '').trim() || String(w?.title || 'Treino')
-                if (desiredTitle !== String(w?.title || '')) {
-                    const r = await updateWorkout(id, { title: desiredTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                    if (!r?.ok) throw new Error(String(r?.error || 'Falha ao renomear treino'))
-                    updatedTitles += 1
-                }
-            }
-
-            let sortSaved = true
-            let sortError = ''
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const r2 = await setWorkoutSortOrder(id, i)
-                if (!r2?.ok) {
-                    sortSaved = false
-                    sortError = String(r2?.error || 'Falha ao ordenar treinos')
-                    break
-                }
-            }
-
-            await fetchWorkouts()
-
-            if (!sortSaved) {
-                const suffix = sortError ? `\n\n${sortError}` : ''
-                await alert(`Lista salva parcialmente: a ordenação não foi aplicada.${suffix}`)
-                return
-            }
-
-            if (updatedTitles) {
-                await alert(`Lista salva: ${updatedTitles} título(s) atualizado(s).`)
-            } else {
-                await alert('Lista salva.')
-            }
-        } catch (e) {
-            await alert('Erro ao salvar lista: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeAiWorkoutTitles = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const title = String(w?.title || '').trim()
-                    const m = title.match(/\(\s*dia\s*(\d+)\s*\)/i)
-                    if (!m?.[1]) return null
-                    const day = Number(m[1])
-                    if (!Number.isFinite(day) || day <= 0) return null
-                    return { workout: w, dayIndex: Math.floor(day - 1) }
-                })
-                .filter(Boolean)
-            if (!candidates.length) {
-                await alert('Nenhum treino no formato antigo “(Dia X)” foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar nomes de ${candidates.length} treinos gerados automaticamente?`, 'Padronizar nomes'))) return
-
-            let changed = 0
-            for (const item of candidates) {
-                const w = item.workout
-                const idx = item.dayIndex
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle, idx, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, { title: nextTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                changed += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${changed} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar nomes: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleApplyTitleRule = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            if (!list.length) {
-                await alert('Nenhum treino encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar títulos de ${list.length} treinos com A/B/C... e dia da semana?`, 'Padronizar títulos'))) return
-            let updated = 0
-            for (let i = 0; i < list.length; i += 1) {
-                const w = list[i]
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle || 'Treino', i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, {
-                    title: nextTitle,
-                    notes: w?.notes ?? '',
-                    exercises: Array.isArray(w?.exercises) ? w.exercises : [],
-                })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                updated += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${updated} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar títulos: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeExercises = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-                    let changesCount = 0
-                    const nextExercises = exercises.map((ex) => {
-                        const name = String(ex?.name || '').trim()
-                        if (!name) return ex
-                        const info = resolveCanonicalExerciseName(name)
-                        if (!info?.changed || !info?.canonical) return ex
-                        changesCount += 1
-                        return { ...ex, name: info.canonical }
-                    })
-                    if (!changesCount) return null
-                    return { workout: w, nextExercises, changesCount }
-                })
-                .filter(Boolean)
-
-            if (!candidates.length) {
-                await alert('Nenhum exercício para normalizar foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Normalizar exercícios em ${candidates.length} treinos?`, 'Normalizar exercícios'))) return
-
-            let updated = 0
-            const updatedWorkouts = []
-            for (const item of candidates) {
-                const w = item.workout
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const title = String(w?.title || '').trim() || `Treino ${id.slice(0, 8)}`
-                const notes = w?.notes ?? ''
-                const res = await updateWorkout(id, { title, notes, exercises: item.nextExercises })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao atualizar treino'))
-                updated += 1
-                updatedWorkouts.push({ title, changesCount: Number(item?.changesCount || 0) })
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            const lines = updatedWorkouts
-                .slice(0, 10)
-                .map((it) => `• ${it.title}${it.changesCount ? ` (${it.changesCount} exercício(s))` : ''}`)
-                .join('\n')
-            const more = updatedWorkouts.length > 10 ? `\n(+${updatedWorkouts.length - 10} outros)` : ''
-            const detail = lines ? `\n\nTreinos atualizados:\n${lines}${more}` : ''
-            await alert(`Normalização concluída: ${updated} treinos atualizados.${detail}`)
-        } catch (e) {
-            await alert('Erro ao normalizar exercícios: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleOpenDuplicates = async () => {
-        const list = (Array.isArray(workouts) ? workouts : []).filter((w) => !w?.archived_at)
-        const keys = list.map((w) => {
-            const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-            const set = new Set()
-            for (const ex of exercises) {
-                const name = String(ex?.name || '').trim()
-                if (!name) continue
-                const info = resolveCanonicalExerciseName(name)
-                const base = String(info?.canonical || name).trim()
-                const k = normalizeExerciseName(base)
-                if (k) set.add(k)
-            }
-            return set
-        })
-
-        const parent = Array.from({ length: list.length }).map((_, i) => i)
-        const find = (x) => {
-            let r = x
-            while (parent[r] !== r) r = parent[r]
-            let cur = x
-            while (parent[cur] !== cur) {
-                const p = parent[cur]
-                parent[cur] = r
-                cur = p
-            }
-            return r
-        }
-        const unite = (a, b) => {
-            const ra = find(a)
-            const rb = find(b)
-            if (ra !== rb) parent[rb] = ra
-        }
-
-        const similarity = (a, b) => {
-            const A = keys[a]
-            const B = keys[b]
-            if (!A?.size || !B?.size) return 0
-            let inter = 0
-            for (const v of A) if (B.has(v)) inter += 1
-            const union = A.size + B.size - inter
-            if (!union) return 0
-            return inter / union
-        }
-
-        const edges = []
-        for (let i = 0; i < list.length; i += 1) {
-            for (let j = i + 1; j < list.length; j += 1) {
-                const score = similarity(i, j)
-                if (score >= 0.9) {
-                    unite(i, j)
-                    edges.push({ i, j, score })
-                }
-            }
-        }
-
-        const groupsMap = new Map()
-        for (let i = 0; i < list.length; i += 1) {
-            const r = find(i)
-            const arr = groupsMap.get(r) || []
-            arr.push(i)
-            groupsMap.set(r, arr)
-        }
-
-        const groups = []
-        for (const idxs of groupsMap.values()) {
-            if (!idxs || idxs.length < 2) continue
-            let best = 0
-            for (const e of edges) {
-                if (idxs.includes(e.i) && idxs.includes(e.j)) best = Math.max(best, e.score)
-            }
-            groups.push({ items: idxs.map((i) => list[i]), score: best || 0.9 })
-        }
-
-        if (!groups.length) {
-            await alert('Não encontrei duplicados com alta similaridade.')
-            return
-        }
-        groups.sort((a, b) => b.score - a.score)
-        setDuplicateGroups(groups)
-        setDuplicatesOpen(true)
-    }
-
-    const handleArchiveDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Arquivar ${others.length} duplicados e manter "${base?.title || 'Treino'}"?`, 'Arquivar duplicados'))) return
-            setDuplicatesBusy(true)
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const res = await setWorkoutArchived(id, true)
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao arquivar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleMergeDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Mesclar ${others.length} duplicados em "${base?.title || 'Treino'}" e arquivar os demais?`, 'Mesclar duplicados'))) return
-            setDuplicatesBusy(true)
-
-            const baseExercises = Array.isArray(base?.exercises) ? base.exercises : []
-            const seen = new Set()
-            const merged = []
-            for (const ex of baseExercises) {
-                const name = String(ex?.name || '').trim()
-                const method = String(ex?.method || '').trim()
-                const reps = String(ex?.reps || '').trim()
-                const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                if (k && !seen.has(k)) {
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-            for (const w of others) {
-                const exs = Array.isArray(w?.exercises) ? w.exercises : []
-                for (const ex of exs) {
-                    const name = String(ex?.name || '').trim()
-                    const method = String(ex?.method || '').trim()
-                    const reps = String(ex?.reps || '').trim()
-                    const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                    if (!k || seen.has(k)) continue
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-
-            const baseId = String(base?.id || '').trim()
-            if (!baseId) throw new Error('Treino base sem ID')
-            const res = await updateWorkout(baseId, { title: String(base?.title || 'Treino'), notes: base?.notes ?? '', exercises: merged })
-            if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino mesclado'))
-
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const a = await setWorkoutArchived(id, true)
-                if (!a?.ok) throw new Error(String(a?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao mesclar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleShareWorkout = async (workout) => {
-        setExportWorkout(workout);
-        setShowExportModal(true);
-    };
-
-	const handleExportPdf = async () => {
-		if (!exportWorkout) return;
-		try {
-			const html = workoutPlanHtml(exportWorkout, user);
-			const win = window.open('', '_blank');
-			if (!win) return;
-			win.document.open();
-			win.document.write(html);
-			win.document.close();
-			win.focus();
-			setTimeout(() => { try { win.print(); } catch {} }, 300);
-			setShowExportModal(false);
-		} catch (e) { await alert('Erro ao gerar PDF: ' + (e?.message ?? String(e))); }
-	};
-
-    const handleExportJson = () => {
-        if (!exportWorkout) return;
-        const json = JSON.stringify({ workout: { title: exportWorkout.title, exercises: (exportWorkout.exercises || []).map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps, rpe: ex.rpe, cadence: ex.cadence, restTime: ex.restTime, method: ex.method, videoUrl: ex.videoUrl, notes: ex.notes })) } }, null, 2);
-        const blob = new Blob([json], { type: 'application/json' });
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement('a');
-        a.href = url;
-        a.download = `${(exportWorkout.title || 'treino').replace(/\s+/g,'_')}.json`;
-        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        setShowExportModal(false);
-    };
-
-    const handleExportAllWorkouts = async () => {
-        try {
-            setExportingAll(true);
-            const payload = {
-                user: { id: user?.id || '', email: user?.email || '' },
-                workouts: (workouts || []).map(w => ({
-                    id: w.id,
-                    title: w.title,
-                    notes: w.notes,
-                    is_template: true,
-                    exercises: (w.exercises || []).map(ex => ({
-                        name: ex.name,
-                        sets: ex.sets,
-                        reps: ex.reps,
-                        rpe: ex.rpe,
-                        cadence: ex.cadence,
-                        restTime: ex.restTime,
-                        method: ex.method,
-                        videoUrl: ex.videoUrl,
-                        notes: ex.notes
-                    }))
-                }))
-            };
-            const json = JSON.stringify(payload, null, 2);
-            const blob = new Blob([json], { type: 'application/json' });
-            const url = URL.createObjectURL(blob);
-            const a = document.createElement('a');
-            a.href = url;
-            a.download = `irontracks_workouts_${new Date().toISOString()}.json`;
-            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        } catch (e) {
-        } finally {
-            setExportingAll(false);
-        }
-    };
-
-    const handleImportWorkout = async () => {
-        await alert("Funcionalidade de importar código temporariamente indisponível na migração.", "Em Manutenção");
-    };
-
-    // JSON IMPORT HANDLER
-    const handleJsonUpload = (e) => {
-        const input = e?.target;
-        const file = input?.files?.[0];
-        if (!file) return;
-        try {
-            setShowJsonImportModal(false);
-        } catch {}
-
-        const reader = new FileReader();
-        reader.onload = async (event) => {
-            try {
-                const json = JSON.parse(event.target.result);
-                if (await confirm(`Importar dados de ${json.user?.email || 'Unknown'}? Isso criará novos treinos.`, "Importar Backup")) {
-                    await importData(json);
-                    await fetchWorkouts();
-                    await alert("Dados importados com sucesso!", "Sucesso");
-                }
-		} catch (err) {
-			await alert("Erro ao ler arquivo JSON: " + (err?.message ?? String(err)));
-		} finally {
-            try {
-                if (input) input.value = '';
-            } catch {}
-		}
-	};
-        reader.readAsText(file);
-    };
-
-    if (authLoading) return <LoadingScreen />;
-    if (!user?.id) return <LoadingScreen />;
-
-    const currentWorkoutId = activeSession?.workout?.id;
-    let nextWorkout = null;
-    if (currentWorkoutId && Array.isArray(workouts) && workouts.length > 0) {
-        const index = workouts.findIndex(w => w.id === currentWorkoutId);
-        if (index !== -1 && index + 1 < workouts.length) {
-            nextWorkout = workouts[index + 1];
-        }
-    }
-
-    const isHeaderVisible = view !== 'active' && view !== 'report';
-
-    return (
-        <InAppNotificationsProvider
-            userId={user?.id || null}
-            settings={userSettingsApi?.settings ?? null}
-            onOpenMessages={() => setView('chat')}
-            onOpenNotifications={() => {
-                setShowNotifCenter(true);
-                setHasUnreadNotification(false);
-            }}
-        >
-        <InAppNotifyBinder bind={bindInAppNotify} />
-        <TeamWorkoutProvider user={user} settings={userSettingsApi?.settings ?? null} onStartSession={handleStartSession}>
-            <div className="w-full bg-neutral-900 min-h-screen relative flex flex-col overflow-hidden" suppressHydrationWarning>
-                <IncomingInviteModal onStartSession={handleStartSession} />
-                <InviteAcceptedModal />
-                <GuidedTour
-                    open={Boolean(tourOpen)}
-                    steps={getTourSteps({
-                        role: user?.role,
-                        hasCommunity: (userSettingsApi?.settings?.moduleCommunity !== false),
-                    })}
-                    actions={{
-                        openAdminPanel: (tab) => {
-                            try {
-                                const safe = String(tab || 'dashboard').trim() || 'dashboard'
-                                openAdminPanel(safe)
-                            } catch {}
-                        },
-                    }}
-                    onEvent={(name, payload) => {
-                        logTourEvent(name, payload)
-                    }}
-                    onComplete={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: true, skipped: false, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'completed') } catch {}
-                        const res = await upsertTourFlags({ tour_completed_at: new Date().toISOString(), tour_skipped_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (completed). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_completed', { version: TOUR_VERSION })
-                    }}
-                    onSkip={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (skipped). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_skipped', { version: TOUR_VERSION })
-                    }}
-                    onCancel={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (cancelled). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_cancelled', { version: TOUR_VERSION })
-                    }}
-                />
-
-                {/* Header */}
-                {isHeaderVisible && (
-                    <div className="bg-neutral-950 flex justify-between items-center fixed top-0 left-0 right-0 z-40 border-b border-zinc-800 px-6 shadow-lg pt-[env(safe-area-inset-top)] min-h-[calc(4rem+env(safe-area-inset-top))]">
-                        <div 
-                            className="flex items-center cursor-pointer group"
-                            onClick={() => setView('dashboard')}
-                        >
-                            <div className="flex items-center gap-2">
-                                <Dumbbell size={18} className="text-yellow-500 opacity-25" />
-                                <h1 className="text-2xl font-black tracking-tighter italic leading-none text-white group-hover:opacity-80 transition-opacity">
-                                    IRON<span className="text-yellow-500">TRACKS</span>
-                                </h1>
-                            </div>
-                            <div className="h-6 w-px bg-yellow-500 mx-4 opacity-50"></div>
-                            <span className="text-zinc-400 text-xs font-medium tracking-wide uppercase">
-                                {isCoach ? 'Bem vindo Coach' : 'Bem vindo Atleta'}
-                            </span>
-                        </div>
-                        
-                        <div className="flex items-center gap-4">
-                                {(() => {
-                                    const pending = Number(syncState?.pending || 0)
-                                    const failed = Number(syncState?.failed || 0)
-                                    const online = syncState?.online !== false
-                                    const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-                                    const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-                                    if (!online) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-xs font-black uppercase tracking-widest">
-                                                Offline
-                                            </div>
-                                        )
-                                    }
-                                    if (offlineSyncV2Enabled && (pending > 0 || failed > 0)) {
-                                        return (
-                                            <button
-                                                type="button"
-                                                onClick={() => setOfflineSyncOpen(true)}
-                                                className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest hover:bg-yellow-500/15"
-                                                title="Abrir central de pendências"
-                                            >
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}{failed > 0 ? ` • Falhas: ${failed}` : ''}
-                                            </button>
-                                        )
-                                    }
-                                    if (pending > 0) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest">
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}
-                                            </div>
-                                        )
-                                    }
-                                    return null
-                                })()}
-                                <HeaderActionsMenu
-                                user={user}
-                                isCoach={isCoach}
-                                hasUnreadChat={hasUnreadChat}
-                                hasUnreadNotification={hasUnreadNotification}
-                                onOpenAdmin={() => {
-                                    if (typeof window !== 'undefined') {
-                                        const url = new URL(window.location);
-                                        url.searchParams.delete('view');
-                                        window.history.replaceState({}, '', url);
-                                    }
-                                    const tab = (() => {
-                                        try {
-                                            const url = new URL(window.location.href);
-                                            const current = String(url.searchParams.get('tab') || '').trim();
-                                            if (current) return current;
-                                        } catch {}
-                                        try {
-                                            const stored = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-                                            if (stored) return stored;
-                                        } catch {}
-                                        return 'dashboard';
-                                    })();
-                                    openAdminPanel(tab);
-                                }}
-                                onOpenChatList={() => setView('chatList')}
-                                onOpenGlobalChat={() => setView('globalChat')}
-                                onOpenHistory={() => setView('history')}
-                                onOpenNotifications={() => {
-                                    setShowNotifCenter(true);
-                                    setHasUnreadNotification(false);
-                                }}
-                                onOpenSchedule={() => router.push('/dashboard/schedule')}
-                                onOpenSettings={() => setSettingsOpen(true)}
-                                onOpenTour={async () => {
-                                    try {
-                                        await logTourEvent('tour_started', { auto: false, version: TOUR_VERSION })
-                                    } catch {}
-                                    setTourOpen(true)
-                                }}
-                                onLogout={handleLogout}
-                            />
-                        </div>
-                    </div>
-                )}
-
-                {isCoach && coachPending && (
-                    <div className="bg-yellow-500 text-black text-sm font-bold px-4 py-2 text-center">
-                        Sua conta de Professor está pendente. <button className="underline" onClick={async () => { try { const r = await fetch('/api/teachers/accept', { method: 'POST' }); const j = await r.json(); if (j.ok) { setCoachPending(false); await alert('Conta ativada!'); } else { await alert('Falha ao ativar: ' + (j.error || '')); } } catch (e) { await alert('Erro: ' + (e?.message ?? String(e))); } }}>Aceitar</button>
-                    </div>
-                )}
-
-                {/* Main Content */}
-                <div
-                    className="flex-1 overflow-y-auto custom-scrollbar relative"
-                    style={{
-                        '--dashboard-sticky-top': isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : '0px',
-                        paddingTop: isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : undefined,
-                    }}
-                >
-                    {(view === 'dashboard' || view === 'assessments' || view === 'community' || view === 'vip') && (
-                        <StudentDashboard
-                            workouts={Array.isArray(workouts) ? workouts : []}
-                            profileIncomplete={Boolean(profileIncomplete)}
-                            onOpenCompleteProfile={() => setShowCompleteProfile(true)}
-                            view={view === 'assessments' ? 'assessments' : view === 'community' ? 'community' : view === 'vip' ? 'vip' : 'dashboard'}
-                            onChangeView={(next) => setView(next)}
-                            assessmentsContent={(user?.id || initialUser?.id) ? <AssessmentHistory studentId={user?.id || initialUser?.id} /> : null}
-                            communityContent={(user?.id || initialUser?.id) ? <CommunityClient embedded /> : null}
-                            vipContent={<VipHub user={user} locked={!vipAccess?.hasVip} onOpenWorkoutEditor={(w) => handleEditWorkout(w)} onOpenVipTab={() => setView('vip')} />}
-                            vipLabel="VIP"
-                            vipLocked={!vipAccess?.hasVip}
-                            vipEnabled={true}
-                            settings={userSettingsApi?.settings ?? null}
-                            onCreateWorkout={handleCreateWorkout}
-                            onQuickView={(w) => setQuickViewWorkout(w)}
-                            onStartSession={(w) => handleStartSession(w)}
-                            onRestoreWorkout={(w) => handleRestoreWorkout(w)}
-                            onShareWorkout={(w) => handleShareWorkout(w)}
-                            onDuplicateWorkout={(w) => handleDuplicateWorkout(w)}
-                            onEditWorkout={(w) => handleEditWorkout(w)}
-                            onDeleteWorkout={(id, title) => handleDeleteWorkout(id, title)}
-                            onBulkEditWorkouts={handleBulkEditWorkouts}
-                            currentUserId={user?.id || initialUser?.id}
-                            newRecordsReloadKey={newRecordsReloadKey}
-                            exportingAll={Boolean(exportingAll)}
-                            onExportAll={handleExportAllWorkouts}
-                            streakStats={streakStats}
-                            onOpenJsonImport={() => setShowJsonImportModal(true)}
-                            onNormalizeAiWorkoutTitles={handleNormalizeAiWorkoutTitles}
-                            onNormalizeExercises={handleNormalizeExercises}
-                            onOpenDuplicates={handleOpenDuplicates}
-                            onApplyTitleRule={handleApplyTitleRule}
-                            onOpenIronScanner={async () => {
-                                try {
-                                    openManualWorkoutEditor()
-                                    await alert('No editor, clique em Scanner de Treino (Imagem).', 'Scanner')
-                                } catch {}
-                            }}
-                        />
-                    )}
-
-                    <WorkoutWizardModal
-                        isOpen={createWizardOpen}
-                        onClose={() => setCreateWizardOpen(false)}
-                        onManual={() => openManualWorkoutEditor()}
-                        onGenerate={async (answers, options) => {
-                            const mode = String(options?.mode || 'single').trim().toLowerCase();
-                            try {
-                                const res = await fetch('/api/ai/workout-wizard', {
-                                    method: 'POST',
-                                    headers: { 'Content-Type': 'application/json' },
-                                    body: JSON.stringify({ answers, mode }),
-                                })
-                                const data = await res.json().catch(() => null)
-                                if (!res.ok) {
-                                    const msg = data?.error ? String(data.error) : 'Falha ao gerar treino com IA.'
-                                    throw new Error(msg)
-                                }
-                                if (mode === 'program') {
-                                    const drafts = Array.isArray(data?.drafts) ? data.drafts : null
-                                    if (drafts && drafts.length) return { drafts }
-                                    if (data?.ok === false && Array.isArray(data?.drafts) && data.drafts.length) return { drafts: data.drafts }
-                                    throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                                }
-                                const draft = data?.draft && typeof data.draft === 'object' ? data.draft : null
-                                if (draft?.exercises && Array.isArray(draft.exercises) && draft.exercises.length > 0) return draft
-                                if (data?.ok === false && data?.draft) return data.draft
-                                throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                const lower = msg.toLowerCase()
-                                const isConfig = lower.includes('api de ia não configurada') || lower.includes('google_generative_ai_api_key')
-                                if (isConfig) throw e
-                                if (mode === 'program') {
-                                    const days = Math.max(2, Math.min(6, Number(answers?.daysPerWeek || 3) || 3))
-                                    const drafts = []
-                                    for (let i = 0; i < days; i++) {
-                                        drafts.push(generateWorkoutFromWizard(answers, i))
-                                    }
-                                    return { drafts }
-                                }
-                                return generateWorkoutFromWizard(answers, 0)
-                            }
-                        }}
-                        onSaveDrafts={async (drafts) => {
-                            const list = Array.isArray(drafts) ? drafts : []
-                            if (!list.length) return
-                            try {
-                                for (let i = 0; i < list.length; i += 1) {
-                                    const d = list[i]
-                                    const baseTitle = String(d?.title || 'Treino').trim() || 'Treino'
-                                    const finalTitle = formatProgramWorkoutTitle(baseTitle, i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                                    const exercises = Array.isArray(d?.exercises) ? d.exercises : []
-                                    const res = await createWorkout({ title: finalTitle, exercises })
-                                    if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino'))
-                                }
-                                try {
-                                    await fetchWorkouts()
-                                } catch {}
-                                setCreateWizardOpen(false)
-                                await alert(`Plano salvo: ${list.length} treinos criados.`)
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                await alert('Erro ao salvar plano: ' + msg)
-                            }
-                        }}
-                        onUseDraft={(draft) => {
-                            try {
-                                const title = String(draft?.title || '').trim() || 'Treino'
-                                const exercises = Array.isArray(draft?.exercises) ? draft.exercises : []
-                                setCurrentWorkout({ title, exercises })
-                                setView('edit')
-                            } finally {
-                                setCreateWizardOpen(false)
-                            }
-                        }}
-                    />
-
-					{view === 'edit' && (
-						<ExerciseEditor
-							workout={currentWorkout}
-							onCancel={() => setView('dashboard')}
-							onChange={setCurrentWorkout}
-							onSave={handleSaveWorkout}
-							onSaved={() => {
-								fetchWorkouts().catch(() => {});
-								setView('dashboard');
-							}}
-						/>
-					)}
-
-                    {view === 'active' && activeSession && (
-                        <ActiveWorkout
-                            session={activeSession}
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onUpdateLog={handleUpdateSessionLog}
-                            onFinish={handleFinishSession}
-                            onPersistWorkoutTemplate={handlePersistWorkoutTemplateFromSession}
-                            onBack={() => setView('dashboard')}
-                            onStartTimer={handleStartTimer}
-                            isCoach={isCoach}
-                            onUpdateSession={(updates) => setActiveSession(prev => ({ ...prev, ...updates }))}
-                            nextWorkout={nextWorkout}
-                            onEditWorkout={() => handleOpenActiveWorkoutEditor()}
-                            onAddExercise={() => handleOpenActiveWorkoutEditor({ addExercise: true })}
-                        />
-                    )}
-
-                    {editActiveOpen && view === 'active' && editActiveDraft && (
-                        <div
-                            className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3 md:p-6 pt-safe"
-                            onClick={() => handleCloseActiveWorkoutEditor()}
-                        >
-                            <div
-                                className="w-full max-w-5xl h-[92vh] bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-                                onClick={(e) => e.stopPropagation()}
-                            >
-                                <ExerciseEditor
-                                    workout={editActiveDraft}
-                                    onCancel={() => handleCloseActiveWorkoutEditor()}
-                                    onChange={(w) => setEditActiveDraft(normalizeWorkoutForEditor(w))}
-                                    onSave={handleSaveActiveWorkoutEditor}
-                                    onSaved={() => {
-                                        fetchWorkouts().catch(() => {});
-                                        handleCloseActiveWorkoutEditor();
-                                    }}
-                                />
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'history' && (
-                        <HistoryList
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onViewReport={(s) => { setReportBackView('history'); setReportData({ current: s, previous: null }); setView('report'); }}
-                            onBack={() => setView('dashboard')}
-                        />
-                    )}
-
-                    {/* Evolução removida conforme solicitação */}
-
-                    {view === 'report' && reportData.current && (
-                        <div className="fixed inset-0 z-[1200] bg-neutral-900 overflow-y-auto pt-safe">
-                            <WorkoutReport
-                                session={reportData.current}
-                                previousSession={reportData.previous}
-                                user={user}
-                                settings={userSettingsApi?.settings ?? null}
-                                onClose={() => setView(reportBackView || 'dashboard')}
-                            />
-                        </div>
-                    )}
-
-                    {duplicatesOpen && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe" onClick={() => !duplicatesBusy && setDuplicatesOpen(false)}>
-                            <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Ferramentas</div>
-                                        <div className="text-white font-black text-lg truncate">Duplicados</div>
-                                        <div className="text-xs text-neutral-400 truncate">{Array.isArray(duplicateGroups) ? `${duplicateGroups.length} grupos` : ''}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => setDuplicatesOpen(false)}
-                                        disabled={duplicatesBusy}
-                                        className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center disabled:opacity-50"
-                                        aria-label="Fechar"
-                                    >
-                                        <X size={18} />
-                                    </button>
-                                </div>
-                                <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-                                    {(Array.isArray(duplicateGroups) ? duplicateGroups : []).map((g, idx) => {
-                                        const items = Array.isArray(g?.items) ? g.items : []
-                                        const score = Number(g?.score || 0)
-                                        const base = items[0]
-                                        return (
-                                            <div key={`dup-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-4">
-                                                <div className="flex items-start justify-between gap-3">
-                                                    <div className="min-w-0">
-                                                        <div className="text-xs text-neutral-500 font-bold uppercase tracking-widest">Similaridade</div>
-                                                        <div className="text-white font-black truncate">{base?.title || 'Treino'}</div>
-                                                        <div className="text-xs text-neutral-400">{Math.round(score * 100)}%</div>
-                                                    </div>
-                                                    <div className="flex items-center gap-2">
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleMergeDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 disabled:opacity-50"
-                                                        >
-                                                            Mesclar
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleArchiveDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 disabled:opacity-50"
-                                                        >
-                                                            Arquivar
-                                                        </button>
-                                                    </div>
-                                                </div>
-                                                <div className="mt-3 space-y-2">
-                                                    {items.map((w, wi) => (
-                                                        <div key={`dup-item-${idx}-${wi}`} className="flex items-center justify-between gap-3 rounded-lg bg-neutral-900/40 border border-neutral-800 px-3 py-2">
-                                                            <div className="min-w-0">
-                                                                <div className="text-sm font-bold text-white truncate">{String(w?.title || 'Treino')}</div>
-                                                                <div className="text-[11px] text-neutral-500 font-mono">{Array.isArray(w?.exercises) ? w.exercises.length : 0} EXERCÍCIOS</div>
-                                                            </div>
-                                                            <div className="text-[11px] font-bold text-neutral-500">{wi === 0 ? 'BASE' : 'DUP'}</div>
-                                                        </div>
-                                                    ))}
-                                                </div>
-                                            </div>
-                                        )
-                                    })}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {showExportModal && exportWorkout && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowExportModal(false)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Como deseja exportar?</h3>
-                                    <BackButton onClick={() => setShowExportModal(false)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-3">
-                                    <button onClick={handleExportPdf} className="w-full px-4 py-3 bg-yellow-500 text-black font-bold rounded-xl">Baixar PDF</button>
-                                    <button onClick={handleExportJson} className="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl">Baixar JSON</button>
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {openStudent && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setOpenStudent(null)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Treinos de {openStudent.name}</h3>
-                                    <BackButton onClick={() => setOpenStudent(null)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-2 max-h-[70vh] overflow-y-auto">
-                                    {(openStudent.workouts || []).length === 0 && (
-                                        <p className="text-neutral-500 text-sm">Nenhum treino encontrado.</p>
-                                    )}
-                                    {(openStudent.workouts || []).map(w => (
-                                        <div key={w.id} className="p-3 rounded-xl border border-neutral-700 bg-neutral-800">
-                                            <div className="flex items-center justify-between">
-                                                <span className="text-white font-bold text-sm">{w.title}</span>
-                                                <span className="text-xs text-neutral-400">{w.exercises?.length || 0} exercícios</span>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'chat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'globalChat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'chatList' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatListScreen user={user} onClose={() => setView('dashboard')} onSelectChannel={(c) => { setDirectChat(c); setView('directChat'); }} />
-                        </div>
-                    )}
-
-                    {view === 'directChat' && directChat && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatDirectScreen user={user} otherUserId={directChat.other_user_id} otherUserName={directChat.other_user_name} otherUserPhoto={directChat.other_user_photo} onClose={() => setView('chatList')} />
-                        </div>
-                    )}
-
-                    {view === 'admin' && (
-                        <div className="fixed inset-0 z-[60]">
-                            <AdminPanelV2 user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-                </div>
-
-                {/* Modals & Overlays */}
-                {showCompleteProfile && (
-                    <div className="fixed inset-0 z-[85] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <div className="flex items-center justify-between gap-3 mb-4">
-                                <h3 className="font-black text-white">Completar Perfil</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-
-                            <label className="block text-xs font-bold uppercase tracking-widest text-neutral-500 mb-2">
-                                Nome de Exibição
-                            </label>
-                            <input
-                                value={profileDraftName}
-                                onChange={(e) => setProfileDraftName(e.target.value)}
-                                placeholder="Ex: João Silva"
-                                className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-yellow-500"
-                            />
-
-                            <div className="flex gap-2 mt-5">
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-300 disabled:opacity-50"
-                                >
-                                    Cancelar
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={handleSaveProfile}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-yellow-500 rounded-xl font-black text-black disabled:opacity-50"
-                                >
-                                    {savingProfile ? 'Salvando...' : 'Salvar'}
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                {showImportModal && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <h3 className="font-bold text-white mb-4">Importar Treino (Código)</h3>
-                            <input
-                                value={importCode}
-                                onChange={e => setImportCode(e.target.value)}
-                                placeholder="Cole o código do treino aqui"
-                                className="w-full bg-neutral-800 p-4 rounded-xl mb-4 text-white font-mono text-center uppercase"
-                            />
-                            <div className="flex gap-2">
-                                <button onClick={() => setShowImportModal(false)} className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-400">Cancelar</button>
-                                <button onClick={handleImportWorkout} className="flex-1 p-3 bg-blue-600 rounded-xl font-bold text-white">Importar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                
-                {showJsonImportModal && (
-                     <div className="fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <Upload size={48} className="mx-auto text-blue-500 mb-4" />
-                            <h3 className="font-bold text-white mb-2 text-xl">Restaurar Backup</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Selecione o arquivo .json que você salvou anteriormente.</p>
-                            
-                            <label className="block w-full cursor-pointer bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-colors">
-                                Selecionar Arquivo
-                                <input type="file" accept=".json" onChange={handleJsonUpload} className="hidden" />
-                            </label>
-                            
-                            <button onClick={() => setShowJsonImportModal(false)} className="mt-4 text-neutral-500 text-sm hover:text-white">Cancelar</button>
-                        </div>
-                    </div>
-                )}
-
-                {shareCode && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-black"><Check size={32} /></div>
-                            <h3 className="font-bold text-white mb-2">Link Gerado!</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Envie este código para seu aluno ou amigo.</p>
-                            <div className="bg-black p-4 rounded-xl font-mono text-yellow-500 text-xl mb-4 tracking-widest select-all">
-                                {shareCode}
-                            </div>
-                            <button onClick={() => setShareCode(null)} className="w-full p-3 bg-neutral-800 rounded-xl font-bold text-white">Fechar</button>
-                        </div>
-                    </div>
-                )}
-
-                {quickViewWorkout && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setQuickViewWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-lg rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">{String(quickViewWorkout?.title || '')}</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setQuickViewWorkout(null)}
-                                    className="flex items-center gap-2 text-yellow-500 hover:text-yellow-400 transition-colors py-2 px-3 rounded-xl hover:bg-neutral-800 active:opacity-70"
-                                    aria-label="Voltar"
-                                >
-                                    <ArrowLeft size={20} />
-                                    <span className="font-semibold text-sm">Voltar</span>
-                                </button>
-                            </div>
-                            <div className="p-4 max-h-[60vh] overflow-y-auto space-y-3 custom-scrollbar">
-                                {(Array.isArray(quickViewWorkout?.exercises) ? quickViewWorkout.exercises : []).map((ex, idx) => (
-                                    <div key={idx} className="p-3 rounded-xl bg-neutral-800/50 border border-neutral-700">
-                                        <div className="flex justify-between items-center">
-                                            <h4 className="font-bold text-white text-sm">{String(ex?.name || '—')}</h4>
-                                            <span className="text-xs text-neutral-400">{(parseInt(ex?.sets) || 0)} x {String(ex?.reps || '-')}</span>
-                                        </div>
-                                        <div className="text-xs text-neutral-400 mt-1 flex items-center gap-2">
-                                            <Clock size={14} className="text-yellow-500" /><span>Descanso: {ex?.restTime ? `${parseInt(ex.restTime)}s` : '-'}</span>
-                                        </div>
-                                        {ex?.notes && <p className="text-sm text-neutral-300 mt-2">{String(ex.notes || '')}</p>}
-                                    </div>
-                                ))}
-                                {(!Array.isArray(quickViewWorkout?.exercises) || quickViewWorkout.exercises.length === 0) && (
-                                    <p className="text-neutral-400 text-sm">Este treino não tem exercícios.</p>
-                                )}
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex gap-2">
-                                <button onClick={() => { const w = quickViewWorkout; setQuickViewWorkout(null); handleStartSession(w); }} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl">Iniciar Treino</button>
-                                <button onClick={() => setQuickViewWorkout(null)} className="flex-1 p-3 bg-neutral-800 text-white font-bold rounded-xl">Fechar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {showNotifCenter && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowNotifCenter(false)}>
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">Notificações</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowNotifCenter(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 relative">
-                                <NotificationCenter user={user} onStartSession={handleStartSession} embedded />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {activeSession?.timerTargetTime && (
-                    <RestTimerOverlay
-                        targetTime={activeSession.timerTargetTime}
-                        context={activeSession.timerContext}
-                        settings={userSettingsApi?.settings ?? null}
-                        onClose={handleCloseTimer}
-                        onFinish={handleCloseTimer}
-                    />
-                )}
-
-                {activeSession && view !== 'active' && (
-                    <div className="fixed bottom-0 left-0 right-0 z-[1100]">
-                        <div className="bg-neutral-900/95 backdrop-blur border-t border-neutral-800 px-4 py-3 pb-[max(env(safe-area-inset-bottom),12px)]">
-                            <div className="flex items-center gap-4">
-                                <div className="flex-1 min-w-0">
-                                    <h3 className="font-bold text-white truncate">{activeSession.workout?.title || 'Treino em andamento'}</h3>
-                                    <div className="flex items-center gap-3 text-xs text-neutral-300 mt-1">
-                                        <span className="font-mono text-yellow-500">{(() => { const end = sessionTicker || activeSession.startedAt; const s = Math.max(0, Math.floor((end - activeSession.startedAt) / 1000)); const m = Math.floor(s/60), sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; })()}</span>
-                                        <span className="text-neutral-500">tempo atual</span>
-                                        <span className="opacity-30">•</span>
-                                        <span className="font-mono text-neutral-200">{(() => { const total = (activeSession.workout?.exercises || []).reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0); return `${toMinutesRounded(total)} min`; })()}</span>
-                                        <span className="text-neutral-500">estimado total</span>
-                                    </div>
-                                    <div className="h-1 bg-neutral-700 rounded-full overflow-hidden mt-2">
-                                        {(() => {
-                                            const exCount = (activeSession.workout?.exercises || []).length;
-                                            let percent = 0;
-                                            if (exCount) {
-                                                const done = new Set();
-                                                if (activeSession.logs) {
-                                                    Object.keys(activeSession.logs).forEach(k => {
-                                                        const i = parseInt(k.split('-')[0]) || 0;
-                                                        done.add(i);
-                                                    });
-                                                }
-                                                const current = Math.min(done.size, exCount);
-                                                percent = Math.round((current / exCount) * 100);
-                                            }
-                                            return <div className="h-full bg-yellow-500" style={{ width: `${percent}%` }}></div>
-                                        })()}
-                                    </div>
-                                </div>
-                                <button className="shrink-0 px-4 py-2 bg-yellow-500 text-black font-black rounded-xl hover:bg-yellow-400" onClick={() => setView('active')}>Voltar pro treino</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {/* Admin Panel Modal controlled by State */}
-                {showAdminPanel && (
-                    <AdminPanelV2 user={user} onClose={closeAdminPanel} />
-                )}
-
-                {whatsNewOpen && (
-                    <WhatsNewModal
-                        isOpen={whatsNewOpen}
-                        entry={getLatestWhatsNew()}
-                        onClose={closeWhatsNew}
-                    />
-                )}
-
-                {preCheckinOpen && (
-                    <div
-                        className="fixed inset-0 z-[1300] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-                        onClick={() => {
-                            setPreCheckinOpen(false)
-                            const r = preCheckinResolveRef.current
-                            preCheckinResolveRef.current = null
-                            if (typeof r === 'function') r(null)
-                        }}
-                    >
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Check-in</div>
-                                    <div className="text-white font-black text-lg truncate">Pré-treino</div>
-                                    <div className="text-xs text-neutral-400 truncate">{String(preCheckinWorkout?.title || preCheckinWorkout?.name || 'Treino')}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-4">
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Energia (1–5)</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[1, 2, 3, 4, 5].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, energy: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.energy || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Dor / Soreness (0–10)</div>
-                                    <select
-                                        value={String(preCheckinDraft?.soreness ?? '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, soreness: String(e.target.value || '') }))}
-                                        className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                                    >
-                                        <option value="">Não informar</option>
-                                        {Array.from({ length: 11 }).map((_, i) => (
-                                            <option key={i} value={String(i)}>
-                                                {i}
-                                            </option>
-                                        ))}
-                                    </select>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Tempo disponível</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[30, 45, 60, 90, 120].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, timeMinutes: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.timeMinutes || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}m
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Observações (opcional)</div>
-                                    <textarea
-                                        value={String(preCheckinDraft?.notes || '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, notes: String(e.target.value || '') }))}
-                                        className="w-full min-h-[90px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none"
-                                        placeholder="Ex.: pouco sono, dor no joelho, viagem…"
-                                    />
-                                </div>
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex items-center gap-2">
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-                                >
-                                    Pular
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(preCheckinDraft)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-                                >
-                                    Continuar
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {settingsOpen && (
-                    <SettingsModal
-                        isOpen={settingsOpen}
-                        onClose={() => setSettingsOpen(false)}
-                        settings={userSettingsApi?.settings ?? null}
-                        userRole={user?.role || ''}
-                        saving={Boolean(userSettingsApi?.saving)}
-                        onOpenWhatsNew={() => {
-                            setSettingsOpen(false)
-                            setWhatsNewOpen(true)
-                        }}
-                        onSave={async (next) => {
-                            try {
-                                const safeNext = next && typeof next === 'object' ? next : (userSettingsApi?.settings ?? {})
-                                const res = await userSettingsApi?.save?.(safeNext)
-                                if (!res?.ok) {
-                                    await alert('Falha ao salvar: ' + (res?.error || ''))
-                                    return false
-                                }
-                                return true
-                            } catch (e) {
-                                await alert('Falha ao salvar: ' + (e?.message ?? String(e)))
-                                return false
-                            }
-                        }}
-                    />
-                )}
-
-                <OfflineSyncModal
-                    open={offlineSyncOpen}
-                    onClose={() => setOfflineSyncOpen(false)}
-                    userId={user?.id}
-                />
-            </div>
-        </TeamWorkoutProvider>
-        </InAppNotificationsProvider>
-    );
-}
-
-export default function IronTracksAppClient({ initialUser, initialProfile, initialWorkouts }) {
-    const [isMounted, setIsMounted] = useState(false);
-    useEffect(() => {
-        const t = setTimeout(() => {
-            setIsMounted(true);
-        }, 0);
-        return () => clearTimeout(t);
-    }, []);
-    if (!isMounted) return <LoadingScreen />;
-    return (
-        <DialogProvider>
-            <ErrorReporterProvider>
-                <ErrorBoundary>
-                    <IronTracksApp initialUser={initialUser} initialProfile={initialProfile} initialWorkouts={initialWorkouts} />
-                </ErrorBoundary>
-                <GlobalDialog />
-            </ErrorReporterProvider>
-        </DialogProvider>
-    );
-}
diff --git a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 5.js b/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 5.js
deleted file mode 100644
index fed17af..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 5.js	
+++ /dev/null
@@ -1,3577 +0,0 @@
-'use client';
-
-import React, { useState, useEffect, useCallback, Suspense, useRef } from 'react';
-import { useRouter } from 'next/navigation';
-import dynamic from 'next/dynamic';
-import Image from 'next/image';
-import {
-    RotateCcw,
-    History,
-    MoreVertical,
-    Share2,
-    Trash2,
-    Download,
-    Copy,
-    Plus,
-    Flame,
-    Play,
-    Dumbbell,
-    Check,
-    LogOut,
-    Clock,
-    Upload,
-    ArrowLeft,
-    X
-} from 'lucide-react';
-import { createClient } from '@/utils/supabase/client';
-import { createWorkout, updateWorkout, deleteWorkout, importData, computeWorkoutStreakAndStats, setWorkoutArchived, setWorkoutSortOrder } from '@/actions/workout-actions';
-
-import LoginScreen from '@/components/LoginScreen';
-import AdminPanelV2 from '@/components/AdminPanelV2';
-import ChatScreen from '@/components/ChatScreen';
-import ChatListScreen from '@/components/ChatListScreen';
-import ChatDirectScreen from '@/components/ChatDirectScreen';
-import HistoryList from '@/components/HistoryList';
-import CommunityClient from '@/app/(app)/community/CommunityClient';
-import StudentEvolution from '@/components/StudentEvolution';
-import WorkoutReport from '@/components/WorkoutReport';
-import ActiveWorkout from '@/components/ActiveWorkout';
-import RestTimerOverlay from '@/components/RestTimerOverlay';
-import LoadingScreen from '@/components/LoadingScreen';
-import ExerciseEditor from '@/components/ExerciseEditor';
-import IncomingInviteModal from '@/components/IncomingInviteModal';
-import InviteAcceptedModal from '@/components/InviteAcceptedModal';
-import NotificationCenter from '@/components/NotificationCenter';
-import HeaderActionsMenu from '@/components/HeaderActionsMenu.js';
-import { TeamWorkoutProvider } from '@/contexts/TeamWorkoutContext';
-import { InAppNotificationsProvider, useInAppNotifications } from '@/contexts/InAppNotificationsContext';
-import ErrorBoundary from '@/components/ErrorBoundary';
-import ErrorReporterProvider from '@/components/ErrorReporterProvider';
-import { DialogProvider, useDialog } from '@/contexts/DialogContext';
-import GlobalDialog from '@/components/GlobalDialog';
-import { playStartSound, unlockAudio } from '@/lib/sounds';
-import { workoutPlanHtml } from '@/utils/report/templates';
-import { estimateExerciseSeconds, toMinutesRounded, calculateExerciseDuration } from '@/utils/pacing';
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName'
-import { formatProgramWorkoutTitle } from '@/utils/workoutTitle'
-import { resolveCanonicalExerciseName } from '@/utils/exerciseCanonical'
-import { BackButton } from '@/components/ui/BackButton';
-import StudentDashboard from '@/components/dashboard/StudentDashboard.tsx'
-import WorkoutWizardModal from '@/components/dashboard/WorkoutWizardModal'
-import SettingsModal from '@/components/SettingsModal'
-import { useUserSettings } from '@/hooks/useUserSettings'
-import WhatsNewModal from '@/components/WhatsNewModal'
-import { generateWorkoutFromWizard } from '@/utils/workoutAutoGenerator'
-import { getLatestWhatsNew } from '@/content/whatsNew'
-import GuidedTour from '@/components/onboarding/GuidedTour'
-import { getTourSteps } from '@/utils/tourSteps'
-import { cacheGetWorkouts, cacheSetWorkouts, flushOfflineQueue, getOfflineQueueSummary, getPendingCount, isOnline } from '@/lib/offline/offlineSync'
-import OfflineSyncModal from '@/components/OfflineSyncModal'
-
-const AssessmentHistory = dynamic(() => import('@/components/assessment/AssessmentHistory'), { ssr: false });
-const VipHub = dynamic(() => import('@/components/VipHub'), { ssr: false });
-
-const appId = 'irontracks-production';
-
-function InAppNotifyBinder({ bind }) {
-    const { notify } = useInAppNotifications();
-    const safeBind = typeof bind === 'function' ? bind : null;
-    useEffect(() => {
-        if (!safeBind) return;
-        safeBind(notify);
-        return () => {
-            try { safeBind(null); } catch {}
-        };
-    }, [notify, safeBind]);
-    return null;
-}
-
-const mapWorkoutRow = (w) => {
-	const rawExercises = Array.isArray(w?.exercises) ? w.exercises : [];
-	const exs = rawExercises
-		.filter((e) => e && typeof e === 'object')
-		.sort((a, b) => (a.order || 0) - (b.order || 0))
-		.map((e) => {
-			try {
-				const isCardio = String(e.method || '').toLowerCase() === 'cardio';
-				const dbSets = Array.isArray(e.sets)
-					? e.sets.filter((s) => s && typeof s === 'object')
-					: [];
-
-				const sortedSets = dbSets
-					.slice()
-					.sort((aSet, bSet) => (aSet?.set_number || 0) - (bSet?.set_number || 0));
-
-				const setsCount = sortedSets.length || (isCardio ? 1 : 4);
-
-				const setDetails = sortedSets.map((s, idx) => ({
-					set_number: s?.set_number ?? idx + 1,
-					reps: s?.reps ?? null,
-					rpe: s?.rpe ?? null,
-					weight: s?.weight ?? null,
-					is_warmup: !!(s?.is_warmup ?? s?.isWarmup),
-					advanced_config: s?.advanced_config ?? s?.advancedConfig ?? null,
-				}));
-
-				const nonEmptyReps = setDetails
-					.map((s) => s.reps)
-					.filter((r) => r !== null && r !== undefined && r !== '');
-				const defaultReps = isCardio ? '20' : '10';
-				let repsHeader = defaultReps;
-				if (nonEmptyReps.length > 0) {
-					const uniqueReps = Array.from(new Set(nonEmptyReps));
-					repsHeader = uniqueReps.length === 1 ? uniqueReps[0] : nonEmptyReps[0] ?? defaultReps;
-				}
-
-				const rpeValues = setDetails
-					.map((s) => s.rpe)
-					.filter((v) => v !== null && v !== undefined && !Number.isNaN(v));
-				const defaultRpe = isCardio ? 5 : 8;
-				const rpeHeader = rpeValues.length > 0 ? rpeValues[0] : defaultRpe;
-
-				return {
-					id: e.id,
-					name: e.name,
-					notes: e.notes,
-					videoUrl: e.video_url,
-					restTime: e.rest_time,
-					cadence: e.cadence,
-					method: e.method,
-					sets: setsCount,
-					reps: repsHeader,
-					rpe: rpeHeader,
-					setDetails,
-				};
-			} catch (mapErr) {
-				console.error('Erro ao mapear exercício', {
-					workoutId: w?.id,
-					exerciseId: e?.id,
-					error: mapErr,
-				});
-				return null;
-			}
-		})
-		.filter(Boolean);
-
-	return {
-		id: w.id,
-		title: w.name,
-		notes: w.notes,
-		exercises: exs,
-		is_template: !!w.is_template,
-		user_id: w.user_id,
-		created_by: w.created_by,
-        archived_at: w.archived_at ?? null,
-        sort_order: typeof w.sort_order === 'number' ? w.sort_order : (w.sort_order == null ? 0 : Number(w.sort_order) || 0),
-        created_at: w.created_at ?? null,
-	};
-};
-
-function IronTracksApp({ initialUser, initialProfile, initialWorkouts }) {
-    const { confirm, alert } = useDialog();
-    const [user, setUser] = useState(initialUser ?? null);
-    const [authLoading, setAuthLoading] = useState(false);
-    const [view, setView] = useState('dashboard');
-    const [directChat, setDirectChat] = useState(null);
-    const [workouts, setWorkouts] = useState(() => {
-        try {
-            const list = Array.isArray(initialWorkouts) ? initialWorkouts : [];
-            const mapped = list
-                .map((row) => mapWorkoutRow(row))
-                .filter(Boolean)
-                .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-            return mapped;
-        } catch {
-            return [];
-        }
-    });
-    const [stats, setStats] = useState({ workouts: 0, exercises: 0, activeStreak: 0 });
-    const [streakStats, setStreakStats] = useState(null);
-    const [currentWorkout, setCurrentWorkout] = useState(null);
-    const [createWizardOpen, setCreateWizardOpen] = useState(false)
-    const [importCode, setImportCode] = useState('');
-    const [shareCode, setShareCode] = useState(null);
-    const [quickViewWorkout, setQuickViewWorkout] = useState(null);
-    const [showImportModal, setShowImportModal] = useState(false);
-    const [showJsonImportModal, setShowJsonImportModal] = useState(false);
-    const [reportData, setReportData] = useState({ current: null, previous: null });
-    const [reportBackView, setReportBackView] = useState('dashboard');
-    const [duplicatesOpen, setDuplicatesOpen] = useState(false);
-    const [duplicateGroups, setDuplicateGroups] = useState([]);
-    const [duplicatesBusy, setDuplicatesBusy] = useState(false);
-    const inAppNotifyRef = useRef(null);
-    const bindInAppNotify = useCallback((fn) => {
-        inAppNotifyRef.current = typeof fn === 'function' ? fn : null;
-    }, []);
-    const inAppNotify = useCallback((payload) => {
-        const fn = inAppNotifyRef.current;
-        if (typeof fn === 'function') fn(payload);
-    }, []);
-
-    const [preCheckinOpen, setPreCheckinOpen] = useState(false)
-    const [preCheckinWorkout, setPreCheckinWorkout] = useState(null)
-    const [preCheckinDraft, setPreCheckinDraft] = useState({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-    const preCheckinResolveRef = useRef(null)
-
-    const requestPreWorkoutCheckin = useCallback(async (workout) => {
-        if (!user?.id) return null
-        if (preCheckinOpen) return null
-        return await new Promise((resolve) => {
-            preCheckinResolveRef.current = (value) => {
-                resolve(value ?? null)
-            }
-            setPreCheckinWorkout(workout && typeof workout === 'object' ? workout : null)
-            setPreCheckinDraft({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-            setPreCheckinOpen(true)
-        })
-    }, [preCheckinOpen, user?.id])
-    const [settingsOpen, setSettingsOpen] = useState(false)
-    const [whatsNewOpen, setWhatsNewOpen] = useState(false)
-    const [isCoach, setIsCoach] = useState(false);
-    const initialRole = String(initialProfile?.role || '').toLowerCase()
-    const [vipAccess, setVipAccess] = useState(() => ({
-        loaded: initialRole === 'admin' || initialRole === 'teacher',
-        hasVip: initialRole === 'admin' || initialRole === 'teacher',
-    }))
-    const [hasUnreadChat, setHasUnreadChat] = useState(false);
-    const [hasUnreadNotification, setHasUnreadNotification] = useState(false);
-    const [exportWorkout, setExportWorkout] = useState(null);
-    const [showExportModal, setShowExportModal] = useState(false);
-    const [coachPending, setCoachPending] = useState(false);
-    const [studentFolders, setStudentFolders] = useState([]);
-    const [openStudent, setOpenStudent] = useState(null);
-    const [showNotifCenter, setShowNotifCenter] = useState(false);
-    const [exportingAll, setExportingAll] = useState(false);
-
-    const [profileIncomplete, setProfileIncomplete] = useState(false);
-    const [profileDraftName, setProfileDraftName] = useState('');
-    const [savingProfile, setSavingProfile] = useState(false);
-    const [showCompleteProfile, setShowCompleteProfile] = useState(false);
-
-    // Estado Global da Sessão Ativa
-	const [activeSession, setActiveSession] = useState(null);
-	const suppressForeignFinishToastUntilRef = useRef(0);
-    const [sessionTicker, setSessionTicker] = useState(0);
-    const [editActiveOpen, setEditActiveOpen] = useState(false);
-    const [editActiveDraft, setEditActiveDraft] = useState(null);
-    const editActiveBaseRef = useRef(null);
-    const editActiveAddExerciseRef = useRef(false);
-    const [showAdminPanel, setShowAdminPanel] = useState(false);
-    const userSettingsApi = useUserSettings(user?.id)
-    const whatsNewShownRef = useRef(false)
-    const TOUR_VERSION = 1
-    const [tourOpen, setTourOpen] = useState(false)
-    const [tourBoot, setTourBoot] = useState({ loaded: false, completed: false, skipped: false, version: TOUR_VERSION })
-    const [syncState, setSyncState] = useState({ online: true, syncing: false, pending: 0 })
-    const [offlineSyncOpen, setOfflineSyncOpen] = useState(false)
-
-    // Local fallback to guarantee the tour doesn't re-open when DB upsert fails/offline.
-    // Stored per-user AND per-tour-version.
-    const getTourLocalKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.dismissed.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourAutoOpenedKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.autoOpened.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourSeenKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.seen.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const readLocalTourDismissal = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return null
-        try {
-            if (typeof window === 'undefined') return null
-            const key = getTourLocalKey(safeUid)
-            if (!key) return null
-            const raw = window.localStorage.getItem(key) || ''
-            if (!raw) return null
-            const parsed = JSON.parse(raw)
-            if (!parsed || typeof parsed !== 'object') return null
-            const version = Number(parsed?.version || 0) || 0
-            if (version !== TOUR_VERSION) return null
-            const status = String(parsed?.status || '')
-            if (status !== 'completed' && status !== 'skipped') return null
-            return { version, status, at: Number(parsed?.at || 0) || 0 }
-        } catch {
-            return null
-        }
-    }, [TOUR_VERSION, getTourLocalKey])
-    const writeLocalTourDismissal = useCallback((uid, status) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        const safeStatus = status === 'completed' ? 'completed' : 'skipped'
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourLocalKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, JSON.stringify({ version: TOUR_VERSION, status: safeStatus, at: Date.now() }))
-        } catch {}
-    }, [TOUR_VERSION, getTourLocalKey])
-    const wasTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourSeenKey(safeUid)
-            if (!key) return false
-            return (window.localStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourSeenKey])
-    const markTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourSeenKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourSeenKey])
-    const wasTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return false
-            return (window.sessionStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourAutoOpenedKey])
-    const markTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return
-            window.sessionStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourAutoOpenedKey])
-
-    const supabase = useRef(createClient()).current;
-    const router = useRouter();
-    const isFetching = useRef(false);
-
-    const ADMIN_PANEL_OPEN_KEY = 'irontracks_admin_panel_open';
-
-    const refreshSyncState = useCallback(async () => {
-        try {
-            const online = isOnline()
-            const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-            if (offlineSyncV2Enabled) {
-                const sum = await getOfflineQueueSummary({ userId: user?.id })
-                if (sum?.ok) {
-                    setSyncState((prev) => ({
-                        ...(prev || {}),
-                        online: sum.online !== false,
-                        pending: Number(sum.pending || 0),
-                        failed: Number(sum.failed || 0),
-                        due: Number(sum.due || 0),
-                    }))
-                    return
-                }
-            }
-            const pending = await getPendingCount(user?.id)
-            setSyncState((prev) => ({ ...(prev || {}), online, pending, failed: 0, due: 0 }))
-        } catch {
-            setSyncState((prev) => ({ ...(prev || {}), online: isOnline() }))
-        }
-    }, [user?.id, userSettingsApi?.settings])
-
-    const runFlushQueue = useCallback(async () => {
-        try {
-            if (!isOnline()) {
-                setSyncState((prev) => ({ ...(prev || {}), online: false }))
-                return
-            }
-            setSyncState((prev) => ({ ...(prev || {}), syncing: true, online: true }))
-            await flushOfflineQueue({ max: 8 })
-        } finally {
-            setSyncState((prev) => ({ ...(prev || {}), syncing: false }))
-            await refreshSyncState()
-        }
-    }, [refreshSyncState])
-
-    useEffect(() => {
-        refreshSyncState()
-        const onChanged = () => refreshSyncState()
-        const onOnline = () => runFlushQueue()
-        const onOffline = () => refreshSyncState()
-        try {
-            window.addEventListener('irontracks.offlineQueueChanged', onChanged)
-            window.addEventListener('online', onOnline)
-            window.addEventListener('offline', onOffline)
-        } catch {}
-        return () => {
-            try {
-                window.removeEventListener('irontracks.offlineQueueChanged', onChanged)
-                window.removeEventListener('online', onOnline)
-                window.removeEventListener('offline', onOffline)
-            } catch {}
-        }
-    }, [refreshSyncState, runFlushQueue])
-
-    useEffect(() => {
-        if (!user?.id) return
-        if (!isOnline()) return
-        if ((syncState?.pending || 0) <= 0) return
-        const t = setInterval(() => {
-            runFlushQueue()
-        }, 15000)
-        return () => clearInterval(t)
-    }, [runFlushQueue, syncState?.pending, user?.id])
-
-    const logTourEvent = useCallback(async (event, payload) => {
-        try {
-            if (!user?.id) return
-            const ev = String(event || '').trim()
-            if (!ev) return
-            const basePayload = payload && typeof payload === 'object' ? payload : {}
-            const enriched = {
-                ...basePayload,
-                role: String(user?.role || ''),
-                path: (() => {
-                    try { return typeof window !== 'undefined' ? String(window.location.pathname || '') : '' } catch { return '' }
-                })(),
-            }
-            await supabase.from('onboarding_events').insert({
-                user_id: user.id,
-                event: ev,
-                payload: enriched,
-            })
-        } catch {}
-    }, [supabase, user?.id, user?.role])
-
-    const upsertTourFlags = useCallback(async (patch) => {
-        try {
-            if (!user?.id) return { ok: false, error: 'missing_user' }
-            const base = patch && typeof patch === 'object' ? patch : {}
-            const payload = {
-                user_id: user.id,
-                preferences: userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {},
-                tour_version: TOUR_VERSION,
-                updated_at: new Date().toISOString(),
-                ...base,
-            }
-            await supabase.from('user_settings').upsert(payload, { onConflict: 'user_id' })
-            return { ok: true }
-        } catch (e) {
-            return { ok: false, error: e?.message ?? String(e) }
-        }
-    }, [TOUR_VERSION, supabase, user?.id, userSettingsApi?.settings])
-
-    useEffect(() => {
-        if (!user?.id) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const uid = String(user.id)
-                const localDismissal = readLocalTourDismissal(uid)
-                if (localDismissal) {
-                    // Defensive: if the user already dismissed locally (offline, blocked RLS, etc.), never auto-open again.
-                    const completed = localDismissal.status === 'completed'
-                    const skipped = localDismissal.status === 'skipped'
-                    setTourBoot({ loaded: true, completed, skipped, version: TOUR_VERSION })
-                    return
-                }
-
-                const { data } = await supabase
-                    .from('user_settings')
-                    .select('tour_version, tour_completed_at, tour_skipped_at')
-                    .eq('user_id', user.id)
-                    .maybeSingle()
-
-                if (cancelled) return
-
-                const dbVersion = Number(data?.tour_version || 0) || 0
-                // Only force a new auto-open when the DB explicitly says an older version was seen.
-                // If dbVersion is missing/0 but completed_at exists, we respect completed/skipped to avoid annoying loops.
-                const needsNewVersion = dbVersion > 0 && dbVersion < TOUR_VERSION
-                const completed = needsNewVersion ? false : !!data?.tour_completed_at
-                const skipped = needsNewVersion ? false : !!data?.tour_skipped_at
-                setTourBoot({ loaded: true, completed, skipped, version: dbVersion || TOUR_VERSION })
-
-                const shouldOpen = !wasTourSeenEver(uid) && !wasTourAutoOpenedThisSession(uid) && (!completed && !skipped)
-                if (shouldOpen) {
-                    markTourAutoOpenedThisSession(uid)
-                    markTourSeenEver(uid)
-                    await logTourEvent('tour_started', { auto: true, version: TOUR_VERSION })
-                    setTourOpen(true)
-                }
-            } catch {
-                if (!cancelled) setTourBoot((prev) => ({ ...(prev || {}), loaded: true }))
-            }
-        })()
-        return () => {
-            cancelled = true
-        }
-    }, [TOUR_VERSION, logTourEvent, markTourAutoOpenedThisSession, markTourSeenEver, readLocalTourDismissal, supabase, user?.id, wasTourAutoOpenedThisSession, wasTourSeenEver])
-
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : '';
-        if (!uid) return;
-        const key = `irontracks.socialPresencePing.v1.${uid}`;
-        try {
-            if (typeof window !== 'undefined') {
-                const seen = window.sessionStorage.getItem(key) || '';
-                if (seen === '1') return;
-                window.sessionStorage.setItem(key, '1');
-            }
-        } catch {}
-        try {
-            fetch('/api/social/presence/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-        try {
-            fetch('/api/profiles/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-    }, [user?.id]);
-
-    useEffect(() => {
-        if (authLoading) return;
-        if (user) return;
-        const t = setTimeout(() => {
-            try {
-                router.replace('/?next=/dashboard');
-            } catch {}
-        }, 150);
-        return () => {
-            clearTimeout(t);
-        };
-    }, [authLoading, user, router]);
-
-    useEffect(() => {
-        if (whatsNewShownRef.current) return
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        if (!userSettingsApi?.loaded) return
-        const entry = getLatestWhatsNew()
-        if (!entry?.id) return
-        const prefs = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-        if (prefs?.whatsNewAutoOpen === false) return
-        const lastSeenId = String(prefs?.whatsNewLastSeenId || '')
-        const lastSeenAt = Number(prefs?.whatsNewLastSeenAt || 0) || 0
-        const remind24h = prefs?.whatsNewRemind24h !== false
-        const within24h = lastSeenAt > 0 && Date.now() - lastSeenAt < 24 * 60 * 60 * 1000
-        if (lastSeenId === String(entry.id)) {
-            if (!remind24h) return
-            if (within24h) return
-        }
-        whatsNewShownRef.current = true
-        setWhatsNewOpen(true)
-    }, [user?.id, userSettingsApi?.loaded, userSettingsApi?.settings])
-
-    const closeWhatsNew = useCallback(async () => {
-        try {
-            setWhatsNewOpen(false)
-            const entry = getLatestWhatsNew()
-            if (!entry?.id) return
-            const prev = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-            const prevSeenId = String(prev?.whatsNewLastSeenId || '')
-            const nextSeenAt = Date.now()
-            const next = { ...(prev || {}), whatsNewLastSeenId: String(entry.id), whatsNewLastSeenAt: nextSeenAt }
-            try { userSettingsApi?.setSettings?.(next) } catch {}
-            try { await userSettingsApi?.save?.(next) } catch {}
-        } catch {}
-    }, [userSettingsApi])
-    const ADMIN_PANEL_TAB_KEY = 'irontracks_admin_panel_tab';
-
-    const setUrlTabParam = useCallback((nextTab) => {
-        try {
-            if (typeof window === 'undefined') return;
-            const tabValue = String(nextTab || '').trim();
-            if (!tabValue) return;
-            const url = new URL(window.location.href);
-            url.searchParams.set('tab', tabValue);
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const removeUrlTabParam = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const url = new URL(window.location.href);
-            url.searchParams.delete('tab');
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const openAdminPanel = useCallback((tab) => {
-        setShowAdminPanel(true);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                if (tab) sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, String(tab));
-                if (tab) setUrlTabParam(tab);
-            }
-        } catch {}
-    }, [setUrlTabParam]);
-
-    const closeAdminPanel = useCallback(() => {
-        setShowAdminPanel(false);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.removeItem(ADMIN_PANEL_OPEN_KEY);
-                sessionStorage.removeItem(ADMIN_PANEL_TAB_KEY);
-            }
-        } catch {}
-        removeUrlTabParam();
-    }, [removeUrlTabParam]);
-
-    const restoreAdminPanelIfNeeded = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const role = String(user?.role || '').toLowerCase();
-            const isPrivileged = role === 'admin' || role === 'teacher';
-            if (!isPrivileged) return;
-
-            const validTabs = new Set(['dashboard', 'students', 'teachers', 'templates', 'videos', 'broadcast', 'system']);
-            const url = new URL(window.location.href);
-            const urlTabRaw = String(url.searchParams.get('tab') || '').trim();
-            const urlTab = validTabs.has(urlTabRaw) ? urlTabRaw : '';
-
-            const open = sessionStorage.getItem(ADMIN_PANEL_OPEN_KEY);
-            const storedTabRaw = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-            const storedTab = validTabs.has(storedTabRaw) ? storedTabRaw : '';
-
-            const shouldOpen = open === '1' || !!urlTab;
-            if (!shouldOpen) return;
-
-            const tab = urlTab || storedTab || 'dashboard';
-            try {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, tab);
-            } catch {}
-            if (!urlTab && tab) setUrlTabParam(tab);
-            setShowAdminPanel(true);
-        } catch {}
-    }, [setUrlTabParam, user?.role]);
-
-    const resolveExerciseVideos = useCallback(async (exercises) => {
-        try {
-            const list = Array.isArray(exercises) ? exercises : [];
-            const missingNames = list
-                .map((ex) => {
-                    const name = String(ex?.name || '').trim();
-                    if (!name) return null;
-                    const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                    if (current) return null;
-                    return name;
-                })
-                .filter(Boolean);
-
-            const uniqueNames = Array.from(new Set(missingNames)).slice(0, 80);
-            if (!uniqueNames.length) return { exercises: list, updates: [] };
-
-            const res = await fetch('/api/exercise-library/resolve', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ names: uniqueNames }),
-            });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return { exercises: list, updates: [] };
-
-            const videos = json?.videos && typeof json.videos === 'object' ? json.videos : {};
-            const updates = [];
-
-            const next = list.map((ex) => {
-                const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                if (current) return ex;
-                const normalized = normalizeExerciseName(String(ex?.name || ''));
-                const url = normalized ? String(videos[normalized] || '').trim() : '';
-                if (!url) return ex;
-                if (ex?.id) updates.push({ id: ex.id, url });
-                return { ...ex, videoUrl: url, video_url: url };
-            });
-
-            return { exercises: next, updates };
-        } catch {
-            return { exercises: Array.isArray(exercises) ? exercises : [], updates: [] };
-        }
-    }, []);
-
-    const persistExerciseVideoUrls = useCallback(async (updates) => {
-        try {
-            const rows = Array.isArray(updates) ? updates : [];
-            const filtered = rows
-                .map((r) => ({ id: String(r?.id || '').trim(), url: String(r?.url || '').trim() }))
-                .filter((r) => !!r.id && !!r.url)
-                .slice(0, 100);
-            if (!filtered.length) return;
-            await Promise.allSettled(filtered.map((r) => supabase.from('exercises').update({ video_url: r.url }).eq('id', r.id)));
-        } catch {}
-    }, [supabase]);
-
-    const signOutInFlightRef = useRef(false);
-    const serverSessionSyncRef = useRef({ timer: null, lastKey: '' });
-    const serverSessionSyncWarnedRef = useRef(false);
-
-    const generateExerciseKey = useCallback(() => {
-        try {
-            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
-        } catch {}
-        return `ex_${Date.now()}_${Math.random().toString(16).slice(2)}`;
-    }, []);
-
-    const normalizeWorkoutForEditor = useCallback((raw) => {
-        try {
-            const base = raw && typeof raw === 'object' ? raw : {};
-            const title = String(base.title || base.name || 'Treino').trim() || 'Treino';
-            const exercisesRaw = Array.isArray(base.exercises) ? base.exercises : [];
-            const exercisesInitial = exercisesRaw.filter((ex) => ex && typeof ex === 'object').map((ex) => {
-                const existing = ex?._itx_exKey ? String(ex._itx_exKey) : '';
-                const fromId = ex?.id != null ? `id_${String(ex.id)}` : '';
-                const nextKey = existing || fromId || generateExerciseKey();
-                return { ...ex, _itx_exKey: nextKey };
-            });
-
-            const seen = new Set();
-            const exercises = exercisesInitial.map((ex) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k || seen.has(k)) {
-                    const nextKey = generateExerciseKey();
-                    seen.add(nextKey);
-                    return { ...ex, _itx_exKey: nextKey };
-                }
-                seen.add(k);
-                return ex;
-            });
-
-            return { ...base, title, exercises };
-        } catch {
-            return { title: 'Treino', exercises: [] };
-        }
-    }, [generateExerciseKey]);
-
-    const stripWorkoutInternalKeys = useCallback((workout) => {
-        try {
-            const w = workout && typeof workout === 'object' ? workout : {};
-            const exercises = Array.isArray(w.exercises)
-                ? w.exercises.map((ex) => {
-                      if (!ex || typeof ex !== 'object') return ex;
-                      const { _itx_exKey, ...rest } = ex;
-                      return rest;
-                  })
-                : w.exercises;
-            return { ...w, exercises };
-        } catch {
-            return workout;
-        }
-    }, []);
-
-    const reindexSessionLogsAfterWorkoutEdit = useCallback((oldWorkout, newWorkout, logs) => {
-        try {
-            const safeLogs = logs && typeof logs === 'object' ? logs : {};
-            const oldExercises = Array.isArray(oldWorkout?.exercises) ? oldWorkout.exercises : [];
-            const newExercises = Array.isArray(newWorkout?.exercises) ? newWorkout.exercises : [];
-            const oldKeyByIndex = oldExercises.map((ex) => String(ex?._itx_exKey || ''));
-            const newIndexByKey = new Map();
-            newExercises.forEach((ex, idx) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k) return;
-                if (newIndexByKey.has(k)) return;
-                newIndexByKey.set(k, idx);
-            });
-
-            const result = {};
-
-            Object.entries(safeLogs).forEach(([k, v]) => {
-                const parts = String(k || '').split('-');
-                if (parts.length !== 2) {
-                    result[k] = v;
-                    return;
-                }
-                const oldIdx = Number(parts[0]);
-                const setIdx = Number(parts[1]);
-                if (!Number.isFinite(oldIdx) || !Number.isFinite(setIdx)) {
-                    result[k] = v;
-                    return;
-                }
-                const exKey = oldKeyByIndex[oldIdx] || '';
-                const newIdx = exKey ? newIndexByKey.get(exKey) : undefined;
-                if (typeof newIdx !== 'number' || newIdx < 0) return;
-                const ex = newExercises[newIdx] || null;
-                const headerSets = Number.parseInt(ex?.sets, 10) || 0;
-                const details = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-                const maxSets = headerSets || (Array.isArray(details) ? details.length : 0);
-                if (maxSets && setIdx >= maxSets) return;
-                result[`${newIdx}-${setIdx}`] = v;
-            });
-
-            return result;
-        } catch {
-            return logs && typeof logs === 'object' ? logs : {};
-        }
-    }, []);
-
-    const clearSupabaseCookiesBestEffort = useCallback(() => {
-        try {
-            if (typeof document === 'undefined') return;
-            const raw = String(document.cookie || '');
-            const cookieNames = raw
-                .split(';')
-                .map((p) => p.trim())
-                .map((p) => p.split('=')[0])
-                .filter(Boolean);
-            const targets = cookieNames.filter((n) => n.startsWith('sb-') || n.includes('supabase'));
-            targets.forEach((name) => {
-                try {
-                    document.cookie = `${name}=; Max-Age=0; path=/`;
-                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
-                } catch {}
-            });
-        } catch {}
-    }, []);
-
-    const clearSupabaseStorageBestEffort = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const ls = window.localStorage;
-            if (!ls) return;
-            const keys = [];
-            for (let i = 0; i < ls.length; i++) {
-                const k = ls.key(i);
-                if (!k) continue;
-                if (k.startsWith('sb-') || k.includes('supabase') || k.includes('auth-token')) keys.push(k);
-            }
-            keys.forEach((k) => {
-                try { ls.removeItem(k); } catch {}
-            });
-        } catch {}
-    }, []);
-
-		const clearClientSessionState = useCallback(() => {
-		try {
-			localStorage.removeItem('activeSession');
-			localStorage.removeItem('appView');
-			if (user?.id) {
-				localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-				localStorage.removeItem(`irontracks.appView.v2.${user.id}`);
-			}
-		} catch {}
-		setActiveSession(null);
-		setView('dashboard');
-	}, [user?.id]);
-
-    const safeSignOut = useCallback(async (scope = 'local') => {
-        if (signOutInFlightRef.current) return;
-        signOutInFlightRef.current = true;
-        try {
-            clearSupabaseCookiesBestEffort();
-            clearSupabaseStorageBestEffort();
-        } catch (e) {
-            try {
-                clearSupabaseCookiesBestEffort();
-                clearSupabaseStorageBestEffort();
-            } catch {}
-        } finally {
-            signOutInFlightRef.current = false;
-        }
-    }, [clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        const scopedKey = `irontracks.activeSession.v2.${userId}`;
-        let localSavedAt = 0;
-
-        try {
-            const raw = localStorage.getItem(scopedKey) || localStorage.getItem('activeSession');
-            if (raw) {
-                const parsed = JSON.parse(raw);
-                if (parsed && typeof parsed === 'object' && parsed?.startedAt && parsed?.workout) {
-                    localSavedAt = Number(parsed?._savedAt ?? 0) || 0;
-                    setActiveSession(parsed);
-                    setView('active');
-
-                    if (!localStorage.getItem(scopedKey)) {
-                        try {
-                            localStorage.setItem(scopedKey, JSON.stringify(parsed));
-                            localStorage.removeItem('activeSession');
-                        } catch {}
-                    }
-                }
-            }
-        } catch {
-            try {
-                localStorage.removeItem(scopedKey);
-                localStorage.removeItem('activeSession');
-            } catch {}
-        }
-
-        const loadServer = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('active_workout_sessions')
-                    .select('state, updated_at')
-                    .eq('user_id', userId)
-                    .maybeSingle();
-                if (cancelled) return;
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                    return;
-                }
-
-                const state = data?.state;
-                if (!state || typeof state !== 'object') return;
-                if (!state?.startedAt || !state?.workout) return;
-
-                const updatedAtMs = (() => {
-                    const fromCol = typeof data?.updated_at === 'string' ? Date.parse(data.updated_at) : NaN;
-                    const fromState = Number(state?._savedAt ?? 0) || 0;
-                    return Math.max(Number.isFinite(fromCol) ? fromCol : 0, fromState);
-                })();
-
-                if (updatedAtMs <= localSavedAt) return;
-
-                setActiveSession(state);
-                setView('active');
-                try {
-                    localStorage.setItem(scopedKey, JSON.stringify(state));
-                } catch {}
-            } catch {}
-        };
-
-        loadServer();
-
-        return () => {
-            cancelled = true;
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        let mounted = true;
-        let channel;
-
-        try {
-            channel = supabase
-                .channel(`active-workout-session:${userId}`)
-                .on(
-                    'postgres_changes',
-                    {
-                        event: '*',
-                        schema: 'public',
-                        table: 'active_workout_sessions',
-                        filter: `user_id=eq.${userId}`,
-                    },
-                    (payload) => {
-                        try {
-                            if (!mounted) return;
-						const ev = String(payload?.eventType || '').toUpperCase();
-						if (ev === 'DELETE') {
-							if (Date.now() < (suppressForeignFinishToastUntilRef.current || 0)) {
-								suppressForeignFinishToastUntilRef.current = 0;
-								return;
-							}
-							setActiveSession(null);
-							setView('dashboard');
-							try {
-								localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-							} catch {}
-                                try {
-                                    inAppNotify({
-                                        text: 'Treino finalizado em outro dispositivo.',
-                                        senderName: 'Aviso do Sistema',
-                                        displayName: 'Sistema',
-                                        photoURL: null,
-                                    });
-                                } catch {}
-                                return;
-                            }
-
-                            if (ev === 'UPDATE') {
-                                const state = payload?.new?.state;
-                                if (!state || typeof state !== 'object' || !state?.startedAt || !state?.workout) {
-                                    setActiveSession(null);
-                                    setView('dashboard');
-                                    try {
-                                        localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-                                    } catch {}
-                                }
-                            }
-                        } catch {}
-                    }
-                )
-                .subscribe();
-        } catch {}
-
-        return () => {
-            mounted = false;
-            try {
-                if (channel) supabase.removeChannel(channel);
-            } catch {
-                try {
-                    if (channel) createClient().removeChannel(channel);
-                } catch {}
-            }
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const handler = () => { try { unlockAudio(); } catch {} };
-        document.addEventListener('touchstart', handler, { once: true });
-        document.addEventListener('click', handler, { once: true });
-        return () => {
-            document.removeEventListener('touchstart', handler);
-            document.removeEventListener('click', handler);
-        };
-    }, [supabase, alert, clearClientSessionState]);
-
-    // Persistência da View (Aba Atual)
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const scopedViewKey = `irontracks.appView.v2.${user.id}`;
-            const scopedSessionKey = `irontracks.activeSession.v2.${user.id}`;
-            const savedSession = localStorage.getItem(scopedSessionKey);
-            if (savedSession) {
-                setView('active');
-                return;
-            }
-
-            const raw = localStorage.getItem(scopedViewKey) || localStorage.getItem('appView');
-            const savedView = raw ? String(raw) : '';
-            if (!savedView) {
-                setView('dashboard');
-                return;
-            }
-
-            if (savedView === 'active') {
-                setView('dashboard');
-                return;
-            }
-
-            setView(savedView);
-        } catch {
-            setView('dashboard');
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            if (!view) return;
-            localStorage.setItem(`irontracks.appView.v2.${user.id}`, view);
-        } catch {
-            return;
-        }
-    }, [view, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const key = `irontracks.activeSession.v2.${user.id}`;
-            if (!activeSession) {
-                localStorage.removeItem(key);
-                localStorage.removeItem('activeSession');
-                return;
-            }
-
-            const payload = JSON.stringify({ ...(activeSession || {}), _savedAt: Date.now() });
-            const id = setTimeout(() => {
-                try {
-                    localStorage.setItem(key, payload);
-                } catch {}
-            }, 250);
-            return () => clearTimeout(id);
-        } catch {
-            return;
-        }
-    }, [activeSession, user?.id]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        try {
-            if (serverSessionSyncRef.current?.timer) {
-                try {
-                    clearTimeout(serverSessionSyncRef.current.timer);
-                } catch {}
-            }
-        } catch {}
-
-        const key = (() => {
-            try {
-                return JSON.stringify(activeSession || null);
-            } catch {
-                return '';
-            }
-        })();
-
-        serverSessionSyncRef.current.lastKey = key;
-
-        const run = async () => {
-            try {
-                if (serverSessionSyncRef.current.lastKey !== key) return;
-
-                if (!activeSession) {
-                    const { error } = await supabase.from('active_workout_sessions').delete().eq('user_id', userId);
-                    if (error) {
-                        const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                        const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                        const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                        if (isMissing && !serverSessionSyncWarnedRef.current) {
-                            serverSessionSyncWarnedRef.current = true;
-                            try {
-                                inAppNotify({
-                                    text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                    senderName: 'Aviso do Sistema',
-                                    displayName: 'Sistema',
-                                    photoURL: null,
-                                });
-                            } catch {}
-                        }
-                    }
-                    return;
-                }
-
-                const startedAtRaw = activeSession?.startedAt;
-                const startedAtMs = typeof startedAtRaw === 'number' ? startedAtRaw : new Date(startedAtRaw || 0).getTime();
-                if (!Number.isFinite(startedAtMs) || startedAtMs <= 0) return;
-                if (!activeSession?.workout) return;
-
-                const state = { ...(activeSession || {}), _savedAt: Date.now() };
-
-                const { error } = await supabase
-                    .from('active_workout_sessions')
-                    .upsert(
-                        {
-                            user_id: userId,
-                            started_at: new Date(startedAtMs).toISOString(),
-                            state,
-                            updated_at: new Date().toISOString(),
-                        },
-                        { onConflict: 'user_id' }
-                    );
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                }
-            } catch {}
-        };
-
-        let timerId = null;
-
-        try {
-            timerId = setTimeout(() => {
-                try {
-                    run();
-                } catch {}
-            }, 900);
-            serverSessionSyncRef.current.timer = timerId;
-        } catch {}
-
-        return () => {
-            try {
-                if (timerId) clearTimeout(timerId);
-            } catch {}
-        };
-    }, [activeSession, supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        if (!activeSession) return;
-        const id = setInterval(() => setSessionTicker(Date.now()), 1000);
-        return () => clearInterval(id);
-    }, [activeSession, view]);
-
-    useEffect(() => {
-        let cancelled = false;
-        if (!user?.id) {
-            setHasUnreadNotification(false);
-            return;
-        }
-
-        const loadInitial = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('notifications')
-                    .select('id')
-                    .eq('user_id', user.id)
-                    .limit(1);
-                if (cancelled) return;
-                if (error) {
-                    console.error('Erro ao carregar notificações:', error);
-                    setHasUnreadNotification(false);
-                    return;
-                }
-                setHasUnreadNotification(Array.isArray(data) && data.length > 0);
-            } catch (e) {
-                if (cancelled) return;
-                console.error('Erro ao carregar notificações:', e);
-                setHasUnreadNotification(false);
-            }
-        };
-
-        loadInitial();
-
-        const channel = supabase
-            .channel(`notifications:badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) setHasUnreadNotification(true);
-            })
-            .on('postgres_changes', {
-                event: 'DELETE',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) loadInitial();
-            })
-            .subscribe();
-
-        return () => {
-            cancelled = true;
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-        const allowNotifyDm = s ? s.notifyDirectMessages !== false : true
-
-        const channel = supabase
-            .channel(`direct-messages-badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'direct_messages'
-            }, async (payload) => {
-                try {
-                    if (!allowNotifyDm) return;
-                    const msg = payload.new;
-                    if (!msg || msg.sender_id === user.id) return;
-
-                    const currentView = view;
-                    if (currentView === 'chat' || currentView === 'chatList' || currentView === 'directChat' || currentView === 'globalChat') {
-                        return;
-                    }
-
-                    const { data: senderProfile } = await supabase
-                        .from('profiles')
-                        .select('display_name')
-                        .eq('id', msg.sender_id)
-                        .maybeSingle();
-
-                    const senderName = senderProfile?.display_name || 'Nova mensagem';
-                    const preview = String(msg.content || '').slice(0, 120);
-                    if (!preview) return;
-
-                    await fetch('/api/notifications/direct-message', {
-                        method: 'POST',
-                        headers: { 'Content-Type': 'application/json' },
-                        body: JSON.stringify({
-                            receiverId: user.id,
-                            senderName,
-                            preview,
-                        }),
-                    });
-                } catch (e) {
-                    console.error('Erro ao gerar notificação de mensagem direta:', e);
-                }
-            })
-            .subscribe();
-
-        return () => {
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id, userSettingsApi?.settings, view]);
-
-    useEffect(() => {
-        const baseUser = initialUser && typeof initialUser === 'object' ? initialUser : null
-        if (!baseUser?.id) {
-            try {
-                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-            } catch {}
-            return
-        }
-        const meta = baseUser?.user_metadata || {}
-        const emailRaw = String(baseUser?.email || '').trim()
-        const emailUser = emailRaw.includes('@') ? emailRaw.split('@')[0] : (emailRaw || 'Usuário')
-        const profileDisplayName = String(initialProfile?.display_name || initialProfile?.displayName || '').trim()
-        const profilePhotoURL = String(initialProfile?.photo_url || initialProfile?.photoURL || initialProfile?.photoUrl || '').trim()
-        const metaDisplayName = String(meta?.full_name || meta?.name || '').trim()
-        const displayName = profileDisplayName || metaDisplayName || emailUser
-        const photoURL = profilePhotoURL || meta?.avatar_url || meta?.picture || null
-        const nextUser = { ...baseUser, displayName, photoURL, role: initialProfile?.role || 'user' }
-        setUser(nextUser)
-        const role = String(initialProfile?.role || '').toLowerCase()
-        setIsCoach(role === 'teacher' || role === 'admin')
-    }, [initialUser, initialProfile])
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const res = await fetch('/api/vip/access', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                const json = await res.json().catch(() => null)
-                if (cancelled) return
-                if (json && json.ok) {
-                    setVipAccess({ loaded: true, hasVip: !!json.hasVip })
-                    return
-                }
-                setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            } catch {
-                if (!cancelled) setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            }
-        })()
-        return () => { cancelled = true }
-    }, [user?.id])
-
-    useEffect(() => {
-        try {
-            const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {
-                try {
-                    const ev = String(_event || '').toUpperCase()
-                    if (session && session.user?.id) return
-                    if (ev === 'SIGNED_OUT') {
-                        clearClientSessionState()
-                        if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                        return
-                    }
-                    if (ev === 'INITIAL_SESSION') {
-                        fetch('/api/auth/ping', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                            .then((r) => {
-                                if (r && r.status === 204) return
-                                clearClientSessionState()
-                                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                            })
-                            .catch(() => {})
-                        return
-                    }
-                } catch {}
-            })
-            return () => {
-                try { sub?.subscription?.unsubscribe?.() } catch {}
-            }
-        } catch {
-            return
-        }
-    }, [supabase, clearClientSessionState, clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort])
-
-    useEffect(() => {
-        restoreAdminPanelIfNeeded();
-        const onVisibility = () => {
-            if (typeof document === 'undefined') return;
-            if (document.visibilityState === 'visible') restoreAdminPanelIfNeeded();
-        };
-        const onPageShow = () => restoreAdminPanelIfNeeded();
-        try {
-            document.addEventListener('visibilitychange', onVisibility);
-            window.addEventListener('pageshow', onPageShow);
-        } catch {}
-        return () => {
-            try {
-                document.removeEventListener('visibilitychange', onVisibility);
-                window.removeEventListener('pageshow', onPageShow);
-            } catch {}
-        };
-    }, [restoreAdminPanelIfNeeded]);
-
-    // Sync Profile Separately (Optimized)
-    useEffect(() => {
-        if (user?.id) {
-             const syncProfile = async () => {
-                 try {
-                    return
-                 } catch (e) {
-                    console.error('Erro ao sincronizar perfil:', e);
-                 }
-             };
-             syncProfile();
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const run = async () => {
-            if (!user?.id) {
-                if (!cancelled) {
-                    setProfileIncomplete(false);
-                    setProfileDraftName('');
-                }
-                return;
-            }
-
-            try {
-                const seedName = String(initialProfile?.display_name || '').trim() || String(user?.displayName || '').trim();
-                if (!cancelled) {
-                    setProfileIncomplete(!seedName);
-                    setProfileDraftName(seedName);
-                }
-            } catch {
-                if (!cancelled) {
-                    setProfileIncomplete(true);
-                    setProfileDraftName(String(user?.displayName || '').trim());
-                }
-            }
-        };
-
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [initialProfile?.display_name, user?.id, user?.displayName]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        let cancelled = false;
-        const run = async () => {
-            try {
-                const res = await fetch('/api/dashboard/bootstrap', { cache: 'no-store', credentials: 'include' });
-                const json = await res.json().catch(() => null);
-                if (cancelled) return;
-                if (!json?.ok) return;
-
-                const prof = json?.profile && typeof json.profile === 'object' ? json.profile : null;
-                const displayName = String(prof?.display_name || '').trim();
-                const photoURL = String(prof?.photo_url || '').trim();
-                const role = String(prof?.role || '').toLowerCase();
-
-                setUser((prev) => {
-                    const current = prev && typeof prev === 'object' ? prev : null;
-                    if (!current) return prev;
-                    const patch = {};
-                    if (displayName && displayName !== current.displayName) patch.displayName = displayName;
-                    if (photoURL && photoURL !== current.photoURL) patch.photoURL = photoURL;
-                    if (role && role !== String(current.role || '').toLowerCase()) patch.role = role;
-                    return Object.keys(patch).length ? { ...current, ...patch } : prev;
-                });
-                if (role) setIsCoach(role === 'teacher' || role === 'admin');
-
-                if (Array.isArray(json.workouts) && json.workouts.length) {
-                    const mapped = json.workouts
-                        .map((row) => mapWorkoutRow(row))
-                        .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-                    setWorkouts(mapped);
-                    const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-                    setStats({ workouts: mapped.length, exercises: totalEx, activeStreak: 0 });
-                }
-            } catch {}
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [user?.id]);
-
-	// Fetch Workouts
-	const fetchWorkouts = useCallback(async (specificUser = user) => {
-        if (isFetching.current) return;
-        isFetching.current = true;
-        
-		try {
-			const currentUser = specificUser;
-
-            if (!currentUser?.id) {
-                console.warn("DASHBOARD: Usuário não identificado ao buscar treinos.");
-                return;
-            }
-
-            if (typeof navigator !== 'undefined' && navigator.onLine === false) {
-                try {
-                    const cached = await cacheGetWorkouts({ userId: currentUser.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-                return
-            }
-
-            const role = String(currentUser?.role || 'user') || 'user';
-
-            let data = []
-            let studentData = []
-            let studentsList = []
-
-            const hydrateWorkouts = async (rows) => {
-                const base = Array.isArray(rows) ? rows.filter((x) => x && typeof x === 'object') : [];
-                const workoutIds = base.map((w) => w.id).filter(Boolean);
-                if (workoutIds.length === 0) return base.map((w) => ({ ...w, exercises: [] }));
-
-                let exercises = [];
-                try {
-                    const { data: exRows } = await supabase
-                        .from('exercises')
-                        .select('*')
-                        .in('workout_id', workoutIds)
-                        .order('order', { ascending: true })
-                        .limit(5000);
-                    exercises = Array.isArray(exRows) ? exRows : [];
-                } catch {
-                    exercises = [];
-                }
-
-                const exIds = exercises.map((e) => e.id).filter(Boolean);
-                let sets = [];
-                if (exIds.length > 0) {
-                    try {
-                        const { data: setRows } = await supabase
-                            .from('sets')
-                            .select('*')
-                            .in('exercise_id', exIds)
-                            .order('set_number', { ascending: true })
-                            .limit(20000);
-                        sets = Array.isArray(setRows) ? setRows : [];
-                    } catch {
-                        sets = [];
-                    }
-                }
-
-                const setsByExercise = new Map();
-                for (const s of sets) {
-                    const eid = s?.exercise_id;
-                    if (!eid) continue;
-                    const list = setsByExercise.get(eid) || [];
-                    list.push(s);
-                    setsByExercise.set(eid, list);
-                }
-
-                const exByWorkout = new Map();
-                for (const ex of exercises) {
-                    const wid = ex?.workout_id;
-                    if (!wid) continue;
-                    const exWithSets = { ...ex, sets: setsByExercise.get(ex.id) || [] };
-                    const list = exByWorkout.get(wid) || [];
-                    list.push(exWithSets);
-                    exByWorkout.set(wid, list);
-                }
-
-                return base.map((w) => ({ ...w, exercises: exByWorkout.get(w.id) || [] }));
-            };
-
-            if (role === 'admin' || role === 'teacher') {
-                // 1. Fetch Students
-                try {
-                    const { data: st } = await supabase
-                        .from('students')
-                        .select('id, name, email, user_id')
-                        .or(`teacher_id.eq.${currentUser.id},user_id.eq.${currentUser.id}`)
-                        .order('name');
-                    studentsList = st || [];
-                } catch (e) { console.error('Erro fetching students', e); }
-
-                // 2. Fetch My Workouts
-                const { data: myBase, error: myErr } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (myErr) throw myErr
-                data = await hydrateWorkouts(myBase || [])
-
-                // 3. Fetch Student Workouts
-                const ids = studentsList.map(s => s.user_id || s.id).filter(Boolean)
-                if (ids.length > 0) {
-                    const seen = new Set()
-                    const combined = []
-                    try {
-                        const { data: swByUserBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('user_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByUser = await hydrateWorkouts(swByUserBase || [])
-                        for (const w of (swByUser || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    try {
-                        const { data: swByStudentBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('student_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByStudent = await hydrateWorkouts(swByStudentBase || [])
-                        for (const w of (swByStudent || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    studentData = combined
-                }
-            } else {
-                const { data: baseRows, error } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (error) throw error
-                data = await hydrateWorkouts(baseRows || [])
-
-                if (!data.length) {
-                    try {
-                        const { data: anyRows, error: anyErr } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('user_id', currentUser.id)
-                            .order('name', { ascending: true })
-                            .limit(500);
-                        if (!anyErr && Array.isArray(anyRows) && anyRows.length) {
-                            data = await hydrateWorkouts(anyRows);
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const { data: studentRow } = await supabase
-                            .from('students')
-                            .select('id')
-                            .eq('user_id', currentUser.id)
-                            .maybeSingle();
-                        const studentId = studentRow?.id ? String(studentRow.id) : '';
-                        if (studentId) {
-                            const { data: legacyBase } = await supabase
-                                .from('workouts')
-                                .select('*')
-                                .eq('is_template', true)
-                                .or(`user_id.eq.${studentId},student_id.eq.${studentId}`)
-                                .order('name', { ascending: true })
-                                .limit(500);
-                            const legacyHydrated = await hydrateWorkouts(legacyBase || []);
-                            const seen = new Set();
-                            const merged = [];
-                            for (const w of legacyHydrated) {
-                                if (!w?.id) continue;
-                                if (seen.has(w.id)) continue;
-                                seen.add(w.id);
-                                merged.push(w);
-                            }
-                            data = merged;
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const resLegacy = await fetch('/api/workouts/list', { cache: 'no-store' });
-                        const jsonLegacy = await resLegacy.json().catch(() => null);
-                        if (jsonLegacy?.ok && Array.isArray(jsonLegacy.rows) && jsonLegacy.rows.length) {
-                            data = (jsonLegacy.rows || []).map((w) => ({
-                                id: w?.id,
-                                name: w?.name,
-                                notes: null,
-                                is_template: true,
-                                user_id: currentUser.id,
-                                created_by: null,
-                                exercises: [],
-                            }));
-                        }
-                    } catch {}
-                }
-            }
-
-			if (Array.isArray(data)) {
-				const mappedRaw = data
-					.map((row) => mapWorkoutRow(row))
-					.filter(Boolean);
-                const mapped = mappedRaw.sort((a, b) => {
-                    const ao = Number.isFinite(Number(a?.sort_order)) ? Number(a.sort_order) : 0
-                    const bo = Number.isFinite(Number(b?.sort_order)) ? Number(b.sort_order) : 0
-                    if (ao !== bo) return ao - bo
-                    return (a.title || '').localeCompare(b.title || '')
-                });
-
-                try {
-                    await cacheSetWorkouts({ userId: currentUser?.id, workouts: mapped })
-                } catch {}
-
-                if (role === 'admin' || role === 'teacher') {
-                    setWorkouts(mapped)
-                    try {
-                        const studentMapped = (studentData || []).map(mapWorkoutRow)
-                        const byStudent = new Map()
-                        for (const w of studentMapped) {
-                            const sid = w.user_id
-                            if (!sid) continue
-                            const list = byStudent.get(sid) || []
-                            list.push(w)
-                            byStudent.set(sid, list)
-                        }
-                        const nameById = new Map()
-                        for (const s of (studentsList || [])) {
-                            const sid = s.user_id || s.id
-                            if (!sid) continue
-                            nameById.set(sid, { name: s.name || String(sid).slice(0,8), email: s.email || '' })
-                        }
-                        const folders = Array.from(byStudent.entries()).map(([sid, list]) => {
-                            const info = nameById.get(sid) || { name: String(sid).slice(0,8), email: '' }
-                            return { id: sid, name: info.name, email: info.email, workouts: list }
-                        }).filter(f => (f.workouts || []).length > 0)
-                        setStudentFolders(folders)
-                    } catch (err) {
-                        console.error("Erro ao processar alunos:", err);
-                        setStudentFolders([])
-                    }
-                } else {
-                    setWorkouts(mapped)
-                    try {
-                        const shared = mapped.filter(w => (w.created_by && w.created_by !== currentUser.id))
-                        const byCoach = new Map()
-                        for (const w of shared) {
-                            const cid = w.created_by
-                            const list = byCoach.get(cid) || []
-                            list.push(w)
-                            byCoach.set(cid, list)
-                        }
-                        const coachIds = Array.from(byCoach.keys())
-                        let profiles = []
-                        if (coachIds.length) {
-                            const { data: profs } = await supabase.from('profiles').select('id, display_name').in('id', coachIds)
-                            profiles = profs || []
-                        }
-                        const nameByCoach = new Map(profiles.map(p => [p.id, p.display_name || String(p.id).slice(0,8)]))
-                        const folders = Array.from(byCoach.entries()).map(([cid, list]) => ({
-                            id: cid,
-                            name: `Treinos compartilhados de ${nameByCoach.get(cid) || String(cid).slice(0,8)}`,
-                            email: '',
-                            workouts: list
-                        }))
-                        setStudentFolders(folders)
-                    } catch {
-                        setStudentFolders([])
-                    }
-                }
-                
-				// Atualiza estatísticas
-				const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-				setStats({ 
-					workouts: mapped.length, 
-					exercises: totalEx, 
-					activeStreak: 0 // Placeholder
-				});
-            } else {
-                console.warn('Fetch sem dados; mantendo estado atual');
-            }
-		} catch (e) {
-			const msg = e?.message ?? String(e);
-			if (msg.includes('Failed to fetch') || msg.includes('ERR_ABORTED')) {
-				// Dev HMR aborts or transient network; ignore quietly
-                try {
-                    const cached = await cacheGetWorkouts({ userId: specificUser?.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-				return;
-			}
-			console.error("Erro ao buscar:", { message: msg, error: e });
-		} finally { isFetching.current = false; }
-	}, [supabase, user]); // Depende apenas do usuário para evitar loops de busca
-
-    useEffect(() => {
-        if (user) {
-            fetchWorkouts(user);
-        }
-    }, [user, fetchWorkouts]);
-
-    useEffect(() => {
-        if (user && workouts.length === 0) {
-            try {
-                const k = 'workouts_cache_' + user.id;
-                const cached = localStorage.getItem(k);
-                if (cached) {
-                    const arr = JSON.parse(cached);
-                    if (Array.isArray(arr) && arr.length > 0) setWorkouts(arr);
-                }
-            } catch {}
-        }
-    }, [user, workouts.length]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        computeWorkoutStreakAndStats()
-            .then(res => {
-                if (res?.ok && res?.data) setStreakStats(res.data)
-            })
-            .catch(err => console.error('Erro ao calcular streak:', err));
-    }, [user?.id]);
-
-
-
-    // Handlers de Sessão
-    const handleLogout = async () => {
-        const ok = await confirm("Deseja realmente sair da sua conta?", "Sair");
-        if (!ok) return;
-        try { clearClientSessionState(); } catch {}
-        try { window.location.href = '/auth/logout'; } catch {}
-    };
-
-    const handleSaveProfile = async () => {
-        if (!user?.id) return;
-        const nextName = String(profileDraftName || '').trim();
-        if (!nextName) {
-            await alert('Informe seu nome para completar o perfil.', 'Perfil incompleto');
-            return;
-        }
-
-        setSavingProfile(true);
-        try {
-            const { data, error } = await supabase
-                .from('profiles')
-                .update({
-                    display_name: nextName,
-                    photo_url: user.photoURL ?? null,
-                    last_seen: new Date().toISOString(),
-                })
-                .eq('id', user.id)
-                .select('id')
-                .maybeSingle();
-            if (error) throw error;
-            if (!data?.id) {
-                await alert('Não foi possível salvar seu perfil (registro não encontrado).', 'Perfil');
-                return;
-            }
-            setProfileIncomplete(false);
-            setShowCompleteProfile(false);
-        } catch (e) {
-            await alert('Erro ao salvar perfil: ' + (e?.message || String(e || '')));
-        } finally {
-            setSavingProfile(false);
-        }
-    };
-
-    const handleStartSession = async (workout) => {
-        const exercisesList = Array.isArray(workout?.exercises)
-            ? workout.exercises.filter(ex => ex && typeof ex === 'object')
-            : [];
-
-        if (exercisesList.length === 0) {
-            await alert('Este treino está sem exercícios válidos. Edite o treino antes de iniciar.', 'Treino incompleto');
-            return;
-        }
-
-        const first = exercisesList[0] || {};
-        const exMin = toMinutesRounded(estimateExerciseSeconds(first));
-        const totalMin = toMinutesRounded(exercisesList.reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0));
-        const workoutTitle = String(workout?.title || workout?.name || 'Treino');
-        const ok = await confirm(`Iniciar "${workoutTitle}"? Primeiro exercício: ~${exMin} min. Estimado total: ~${totalMin} min.`, 'Iniciar Treino');
-        if (!ok) return;
-        let preCheckin = null
-        try {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const prompt = s ? s.promptPreWorkoutCheckin !== false : true
-            if (prompt) {
-                preCheckin = await requestPreWorkoutCheckin(workout)
-                if (preCheckin && user?.id) {
-                    const energyN = Number(preCheckin.energy)
-                    const sorenessN = Number(preCheckin.soreness)
-                    const timeN = Number(preCheckin.timeMinutes)
-                    const { error: checkinError } = await supabase.from('workout_checkins').insert({
-                        user_id: user.id,
-                        kind: 'pre',
-                        planned_workout_id: String(workout?.id || '').trim() ? workout.id : null,
-                        active_session_user_id: null,
-                        energy: Number.isFinite(energyN) && energyN >= 1 && energyN <= 5 ? Math.round(energyN) : null,
-                        soreness: Number.isFinite(sorenessN) && sorenessN >= 0 && sorenessN <= 10 ? Math.round(sorenessN) : null,
-                        notes: String(preCheckin.notes || '').trim() ? String(preCheckin.notes || '').trim() : null,
-                        answers: {
-                            time_minutes: Number.isFinite(timeN) && timeN > 0 ? Math.round(timeN) : null,
-                        },
-                    })
-                    if (checkinError) throw checkinError
-                }
-            }
-        } catch (e) {
-            console.warn('Falha ao salvar check-in pré-treino:', e?.message || String(e || ''))
-        }
-        let resolvedExercises = exercisesList;
-        try {
-            const resolved = await resolveExerciseVideos(exercisesList);
-            resolvedExercises = Array.isArray(resolved?.exercises) ? resolved.exercises : exercisesList;
-            persistExerciseVideoUrls(resolved?.updates || []);
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const enabled = s ? s.enableSounds !== false : true
-            const volumeRaw = Number(s?.soundVolume ?? 100)
-            const volume = Number.isFinite(volumeRaw) ? Math.max(0, Math.min(1, volumeRaw / 100)) : 1
-            playStartSound({ enabled, volume })
-        }
-        setActiveSession({
-            workout: { ...workout, exercises: resolvedExercises },
-            logs: {},
-            ui: {
-                baseExerciseCount: resolvedExercises.length,
-                pendingTemplateUpdate: false,
-                preCheckin: preCheckin && typeof preCheckin === 'object' ? preCheckin : null,
-            },
-            startedAt: Date.now(),
-            timerTargetTime: null,
-            timerContext: null
-        });
-        setView('active');
-        try {
-            const wid = String(workout?.id || '').trim() || null;
-            const title = String(workout?.title || workout?.name || 'Treino').trim();
-            fetch('/api/social/workout-start', {
-                method: 'POST',
-                headers: { 'content-type': 'application/json' },
-                body: JSON.stringify({ workout_id: wid, workout_title: title }),
-            }).catch(() => {});
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const allowPrompt = s ? s.notificationPermissionPrompt !== false : true
-            if (allowPrompt && typeof Notification !== 'undefined' && Notification.permission === 'default') {
-            Notification.requestPermission().catch(e => console.warn('Erro permissão notificação:', e));
-            }
-        }
-    };
-
-    const handleUpdateSessionLog = (key, data) => {
-        if (!activeSession) return;
-        setActiveSession(prev => {
-            if (!prev) return null;
-            return {
-                ...prev,
-                logs: { ...(prev.logs || {}), [key]: data }
-            };
-        });
-    };
-
-    const handleStartTimer = (duration, context) => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return {
-                ...prev,
-                timerTargetTime: Date.now() + (duration * 1000),
-                timerContext: context && typeof context === 'object' ? context : null
-            };
-        });
-    };
-
-    const handleCloseTimer = () => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return { ...prev, timerTargetTime: null, timerContext: null };
-        });
-    };
-
-	const handleFinishSession = async (sessionData, showReport) => {
-		suppressForeignFinishToastUntilRef.current = Date.now() + 8000;
-        try {
-            if (user?.id) {
-                localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-            }
-            localStorage.removeItem('activeSession');
-        } catch {}
-		setActiveSession(null);
-		if (showReport === false) {
-			setView('dashboard');
-			return;
-		}
-        setReportBackView('dashboard');
-        setReportData({ current: sessionData, previous: null });
-        setView('report');
-    };
-
-    // Handlers CRUD
-    const openManualWorkoutEditor = () => {
-        setCurrentWorkout({ title: '', exercises: [] })
-        setView('edit')
-    }
-	const handleCreateWorkout = () => { setCreateWizardOpen(true) };
-
-	const handleEditWorkout = async (workout) => {
-		if (!workout || !workout.id) return;
-		try {
-			const supabase = createClient();
-			const { data, error } = await supabase
-				.from('workouts')
-				.select('*, exercises(*, sets(*))')
-				.eq('id', workout.id)
-				.maybeSingle();
-			if (error) throw error;
-			if (!data) {
-				setCurrentWorkout(workout);
-				setView('edit');
-				return;
-			}
-			const mapped = mapWorkoutRow(data);
-            try {
-                const resolved = await resolveExerciseVideos(mapped?.exercises || []);
-                const exercises = Array.isArray(resolved?.exercises) ? resolved.exercises : (mapped?.exercises || []);
-                persistExerciseVideoUrls(resolved?.updates || []);
-                setCurrentWorkout({ ...mapped, exercises });
-            } catch {
-                setCurrentWorkout(mapped);
-            }
-			setView('edit');
-		} catch (e) {
-			const msg = e?.message || String(e || '');
-			await alert('Erro ao carregar treino para edição: ' + msg);
-		}
-	};
-
-    const handleSaveWorkout = useCallback(async (workoutToSave) => {
-        const w = workoutToSave || currentWorkout;
-        if (!user || !w || !w.title) return { ok: false, error: 'Treino inválido ou usuário ausente' };
-        try {
-            if (w.id) {
-                const res = await updateWorkout(w.id, w);
-                setCurrentWorkout(w);
-                return res;
-            } else {
-                const created = await createWorkout(w);
-                const id = created?.id ?? null;
-                setCurrentWorkout({ ...w, id });
-                return created;
-            }
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e || 'Falha ao salvar treino');
-            return { ok: false, error: msg };
-        }
-    }, [currentWorkout, user]);
-
-    const handlePersistWorkoutTemplateFromSession = useCallback(async (workoutFromSession) => {
-        try {
-            const normalized = normalizeWorkoutForEditor(workoutFromSession);
-            const cleaned = stripWorkoutInternalKeys(normalized);
-            if (!cleaned || !cleaned.title) return { ok: false, error: 'Treino inválido para salvar' };
-
-            if (cleaned.id) {
-                await updateWorkout(cleaned.id, cleaned);
-                try {
-                    await fetchWorkouts();
-                } catch {}
-                return { ok: true, mode: 'update' };
-            }
-
-            const created = await createWorkout(cleaned);
-            try {
-                await fetchWorkouts();
-            } catch {}
-            return { ok: true, mode: 'create', id: created?.id ?? null };
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e);
-            return { ok: false, error: msg || 'Falha ao salvar treino' };
-        }
-    }, [fetchWorkouts, normalizeWorkoutForEditor, stripWorkoutInternalKeys]);
-
-    const handleOpenActiveWorkoutEditor = useCallback((options = {}) => {
-        try {
-            if (!activeSession?.workout) return;
-            const base = normalizeWorkoutForEditor(activeSession.workout);
-            const shouldAddExercise = options && typeof options === 'object' ? !!options.addExercise : false;
-            editActiveAddExerciseRef.current = shouldAddExercise;
-            const nextBase = shouldAddExercise
-                ? {
-                    ...base,
-                    exercises: [
-                        ...(Array.isArray(base?.exercises) ? base.exercises : []),
-                        {
-                            name: '',
-                            sets: 4,
-                            reps: '10',
-                            rpe: '8',
-                            cadence: '2020',
-                            restTime: 60,
-                            method: 'Normal',
-                            videoUrl: '',
-                            notes: ''
-                        }
-                    ]
-                }
-                : base;
-            editActiveBaseRef.current = base;
-            setEditActiveDraft(nextBase);
-            setEditActiveOpen(true);
-        } catch {}
-    }, [activeSession?.workout, normalizeWorkoutForEditor]);
-
-    const handleCloseActiveWorkoutEditor = useCallback(() => {
-        try {
-            setEditActiveOpen(false);
-            setEditActiveDraft(null);
-            editActiveBaseRef.current = null;
-            editActiveAddExerciseRef.current = false;
-        } catch {}
-    }, []);
-
-    const handleSaveActiveWorkoutEditor = useCallback(async (workoutFromEditor) => {
-        const normalized = normalizeWorkoutForEditor(workoutFromEditor);
-        const cleaned = stripWorkoutInternalKeys(normalized);
-        const shouldDeferPersist = !!editActiveAddExerciseRef.current;
-        const res = shouldDeferPersist ? { deferred: true } : await handleSaveWorkout(cleaned);
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            const oldWorkout = editActiveBaseRef.current || normalizeWorkoutForEditor(prev.workout);
-            const nextLogs = reindexSessionLogsAfterWorkoutEdit(oldWorkout, normalized, prev.logs || {});
-            const baseUi = prev?.ui && typeof prev.ui === 'object' ? prev.ui : {};
-            const nextUi = shouldDeferPersist ? { ...baseUi, pendingTemplateUpdate: true } : baseUi;
-            return { ...prev, workout: normalized, logs: nextLogs, ui: nextUi };
-        });
-        editActiveBaseRef.current = normalized;
-        setEditActiveDraft(normalized);
-        return res;
-    }, [handleSaveWorkout, normalizeWorkoutForEditor, reindexSessionLogsAfterWorkoutEdit, stripWorkoutInternalKeys]);
-
-	const handleDeleteWorkout = async (id, title) => {
-		const name = title || (workouts.find(w => w.id === id)?.title) || 'este treino';
-		if (!(await confirm(`Apagar o treino "${name}"?`, "Excluir Treino"))) return;
-		try {
-			const res = await deleteWorkout(id);
-			if (!res?.success) {
-				await alert("Erro: " + (res?.error || 'Falha ao excluir treino'));
-				return;
-			}
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro: " + (e?.message ?? String(e))); }
-	};
-
-    const handleRestoreWorkout = async (workout) => {
-        const id = String(workout?.id || '').trim()
-        if (!id) return
-        const name = workout?.title || 'este treino'
-        if (!(await confirm(`Restaurar o treino "${name}"?`, 'Restaurar Treino'))) return
-        try {
-            const res = await setWorkoutArchived(id, false)
-            if (!res?.ok) {
-                await alert('Erro: ' + (res?.error || 'Falha ao restaurar treino'))
-                return
-            }
-            await fetchWorkouts()
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)))
-        }
-    }
-
-	const handleDuplicateWorkout = async (workout) => {
-		if (!(await confirm(`Duplicar "${workout.title}"?`, "Duplicar Treino"))) return;
-		const newWorkout = { ...workout, title: `${workout.title} (Cópia)` };
-		delete newWorkout.id;
-		try {
-			await createWorkout(newWorkout);
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro ao duplicar: " + (e?.message ?? String(e))); }
-	};
-
-    const handleBulkEditWorkouts = async (items) => {
-        try {
-            const arr = Array.isArray(items) ? items : []
-            if (!arr.length) return
-            let updatedTitles = 0
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const w = workouts.find((x) => String(x?.id || '') === id)
-                if (!w) continue
-
-                const desiredTitle = String(it?.title || '').trim() || String(w?.title || 'Treino')
-                if (desiredTitle !== String(w?.title || '')) {
-                    const r = await updateWorkout(id, { title: desiredTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                    if (!r?.ok) throw new Error(String(r?.error || 'Falha ao renomear treino'))
-                    updatedTitles += 1
-                }
-            }
-
-            let sortSaved = true
-            let sortError = ''
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const r2 = await setWorkoutSortOrder(id, i)
-                if (!r2?.ok) {
-                    sortSaved = false
-                    sortError = String(r2?.error || 'Falha ao ordenar treinos')
-                    break
-                }
-            }
-
-            await fetchWorkouts()
-
-            if (!sortSaved) {
-                const suffix = sortError ? `\n\n${sortError}` : ''
-                await alert(`Lista salva parcialmente: a ordenação não foi aplicada.${suffix}`)
-                return
-            }
-
-            if (updatedTitles) {
-                await alert(`Lista salva: ${updatedTitles} título(s) atualizado(s).`)
-            } else {
-                await alert('Lista salva.')
-            }
-        } catch (e) {
-            await alert('Erro ao salvar lista: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeAiWorkoutTitles = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const title = String(w?.title || '').trim()
-                    const m = title.match(/\(\s*dia\s*(\d+)\s*\)/i)
-                    if (!m?.[1]) return null
-                    const day = Number(m[1])
-                    if (!Number.isFinite(day) || day <= 0) return null
-                    return { workout: w, dayIndex: Math.floor(day - 1) }
-                })
-                .filter(Boolean)
-            if (!candidates.length) {
-                await alert('Nenhum treino no formato antigo “(Dia X)” foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar nomes de ${candidates.length} treinos gerados automaticamente?`, 'Padronizar nomes'))) return
-
-            let changed = 0
-            for (const item of candidates) {
-                const w = item.workout
-                const idx = item.dayIndex
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle, idx, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, { title: nextTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                changed += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${changed} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar nomes: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleApplyTitleRule = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            if (!list.length) {
-                await alert('Nenhum treino encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar títulos de ${list.length} treinos com A/B/C... e dia da semana?`, 'Padronizar títulos'))) return
-            let updated = 0
-            for (let i = 0; i < list.length; i += 1) {
-                const w = list[i]
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle || 'Treino', i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, {
-                    title: nextTitle,
-                    notes: w?.notes ?? '',
-                    exercises: Array.isArray(w?.exercises) ? w.exercises : [],
-                })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                updated += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${updated} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar títulos: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeExercises = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-                    let changesCount = 0
-                    const nextExercises = exercises.map((ex) => {
-                        const name = String(ex?.name || '').trim()
-                        if (!name) return ex
-                        const info = resolveCanonicalExerciseName(name)
-                        if (!info?.changed || !info?.canonical) return ex
-                        changesCount += 1
-                        return { ...ex, name: info.canonical }
-                    })
-                    if (!changesCount) return null
-                    return { workout: w, nextExercises, changesCount }
-                })
-                .filter(Boolean)
-
-            if (!candidates.length) {
-                await alert('Nenhum exercício para normalizar foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Normalizar exercícios em ${candidates.length} treinos?`, 'Normalizar exercícios'))) return
-
-            let updated = 0
-            const updatedWorkouts = []
-            for (const item of candidates) {
-                const w = item.workout
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const title = String(w?.title || '').trim() || `Treino ${id.slice(0, 8)}`
-                const notes = w?.notes ?? ''
-                const res = await updateWorkout(id, { title, notes, exercises: item.nextExercises })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao atualizar treino'))
-                updated += 1
-                updatedWorkouts.push({ title, changesCount: Number(item?.changesCount || 0) })
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            const lines = updatedWorkouts
-                .slice(0, 10)
-                .map((it) => `• ${it.title}${it.changesCount ? ` (${it.changesCount} exercício(s))` : ''}`)
-                .join('\n')
-            const more = updatedWorkouts.length > 10 ? `\n(+${updatedWorkouts.length - 10} outros)` : ''
-            const detail = lines ? `\n\nTreinos atualizados:\n${lines}${more}` : ''
-            await alert(`Normalização concluída: ${updated} treinos atualizados.${detail}`)
-        } catch (e) {
-            await alert('Erro ao normalizar exercícios: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleOpenDuplicates = async () => {
-        const list = (Array.isArray(workouts) ? workouts : []).filter((w) => !w?.archived_at)
-        const keys = list.map((w) => {
-            const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-            const set = new Set()
-            for (const ex of exercises) {
-                const name = String(ex?.name || '').trim()
-                if (!name) continue
-                const info = resolveCanonicalExerciseName(name)
-                const base = String(info?.canonical || name).trim()
-                const k = normalizeExerciseName(base)
-                if (k) set.add(k)
-            }
-            return set
-        })
-
-        const parent = Array.from({ length: list.length }).map((_, i) => i)
-        const find = (x) => {
-            let r = x
-            while (parent[r] !== r) r = parent[r]
-            let cur = x
-            while (parent[cur] !== cur) {
-                const p = parent[cur]
-                parent[cur] = r
-                cur = p
-            }
-            return r
-        }
-        const unite = (a, b) => {
-            const ra = find(a)
-            const rb = find(b)
-            if (ra !== rb) parent[rb] = ra
-        }
-
-        const similarity = (a, b) => {
-            const A = keys[a]
-            const B = keys[b]
-            if (!A?.size || !B?.size) return 0
-            let inter = 0
-            for (const v of A) if (B.has(v)) inter += 1
-            const union = A.size + B.size - inter
-            if (!union) return 0
-            return inter / union
-        }
-
-        const edges = []
-        for (let i = 0; i < list.length; i += 1) {
-            for (let j = i + 1; j < list.length; j += 1) {
-                const score = similarity(i, j)
-                if (score >= 0.9) {
-                    unite(i, j)
-                    edges.push({ i, j, score })
-                }
-            }
-        }
-
-        const groupsMap = new Map()
-        for (let i = 0; i < list.length; i += 1) {
-            const r = find(i)
-            const arr = groupsMap.get(r) || []
-            arr.push(i)
-            groupsMap.set(r, arr)
-        }
-
-        const groups = []
-        for (const idxs of groupsMap.values()) {
-            if (!idxs || idxs.length < 2) continue
-            let best = 0
-            for (const e of edges) {
-                if (idxs.includes(e.i) && idxs.includes(e.j)) best = Math.max(best, e.score)
-            }
-            groups.push({ items: idxs.map((i) => list[i]), score: best || 0.9 })
-        }
-
-        if (!groups.length) {
-            await alert('Não encontrei duplicados com alta similaridade.')
-            return
-        }
-        groups.sort((a, b) => b.score - a.score)
-        setDuplicateGroups(groups)
-        setDuplicatesOpen(true)
-    }
-
-    const handleArchiveDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Arquivar ${others.length} duplicados e manter "${base?.title || 'Treino'}"?`, 'Arquivar duplicados'))) return
-            setDuplicatesBusy(true)
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const res = await setWorkoutArchived(id, true)
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao arquivar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleMergeDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Mesclar ${others.length} duplicados em "${base?.title || 'Treino'}" e arquivar os demais?`, 'Mesclar duplicados'))) return
-            setDuplicatesBusy(true)
-
-            const baseExercises = Array.isArray(base?.exercises) ? base.exercises : []
-            const seen = new Set()
-            const merged = []
-            for (const ex of baseExercises) {
-                const name = String(ex?.name || '').trim()
-                const method = String(ex?.method || '').trim()
-                const reps = String(ex?.reps || '').trim()
-                const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                if (k && !seen.has(k)) {
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-            for (const w of others) {
-                const exs = Array.isArray(w?.exercises) ? w.exercises : []
-                for (const ex of exs) {
-                    const name = String(ex?.name || '').trim()
-                    const method = String(ex?.method || '').trim()
-                    const reps = String(ex?.reps || '').trim()
-                    const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                    if (!k || seen.has(k)) continue
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-
-            const baseId = String(base?.id || '').trim()
-            if (!baseId) throw new Error('Treino base sem ID')
-            const res = await updateWorkout(baseId, { title: String(base?.title || 'Treino'), notes: base?.notes ?? '', exercises: merged })
-            if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino mesclado'))
-
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const a = await setWorkoutArchived(id, true)
-                if (!a?.ok) throw new Error(String(a?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao mesclar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleShareWorkout = async (workout) => {
-        setExportWorkout(workout);
-        setShowExportModal(true);
-    };
-
-	const handleExportPdf = async () => {
-		if (!exportWorkout) return;
-		try {
-			const html = workoutPlanHtml(exportWorkout, user);
-			const win = window.open('', '_blank');
-			if (!win) return;
-			win.document.open();
-			win.document.write(html);
-			win.document.close();
-			win.focus();
-			setTimeout(() => { try { win.print(); } catch {} }, 300);
-			setShowExportModal(false);
-		} catch (e) { await alert('Erro ao gerar PDF: ' + (e?.message ?? String(e))); }
-	};
-
-    const handleExportJson = () => {
-        if (!exportWorkout) return;
-        const json = JSON.stringify({ workout: { title: exportWorkout.title, exercises: (exportWorkout.exercises || []).map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps, rpe: ex.rpe, cadence: ex.cadence, restTime: ex.restTime, method: ex.method, videoUrl: ex.videoUrl, notes: ex.notes })) } }, null, 2);
-        const blob = new Blob([json], { type: 'application/json' });
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement('a');
-        a.href = url;
-        a.download = `${(exportWorkout.title || 'treino').replace(/\s+/g,'_')}.json`;
-        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        setShowExportModal(false);
-    };
-
-    const handleExportAllWorkouts = async () => {
-        try {
-            setExportingAll(true);
-            const payload = {
-                user: { id: user?.id || '', email: user?.email || '' },
-                workouts: (workouts || []).map(w => ({
-                    id: w.id,
-                    title: w.title,
-                    notes: w.notes,
-                    is_template: true,
-                    exercises: (w.exercises || []).map(ex => ({
-                        name: ex.name,
-                        sets: ex.sets,
-                        reps: ex.reps,
-                        rpe: ex.rpe,
-                        cadence: ex.cadence,
-                        restTime: ex.restTime,
-                        method: ex.method,
-                        videoUrl: ex.videoUrl,
-                        notes: ex.notes
-                    }))
-                }))
-            };
-            const json = JSON.stringify(payload, null, 2);
-            const blob = new Blob([json], { type: 'application/json' });
-            const url = URL.createObjectURL(blob);
-            const a = document.createElement('a');
-            a.href = url;
-            a.download = `irontracks_workouts_${new Date().toISOString()}.json`;
-            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        } catch (e) {
-        } finally {
-            setExportingAll(false);
-        }
-    };
-
-    const handleImportWorkout = async () => {
-        await alert("Funcionalidade de importar código temporariamente indisponível na migração.", "Em Manutenção");
-    };
-
-    // JSON IMPORT HANDLER
-    const handleJsonUpload = (e) => {
-        const input = e?.target;
-        const file = input?.files?.[0];
-        if (!file) return;
-        try {
-            setShowJsonImportModal(false);
-        } catch {}
-
-        const reader = new FileReader();
-        reader.onload = async (event) => {
-            try {
-                const json = JSON.parse(event.target.result);
-                if (await confirm(`Importar dados de ${json.user?.email || 'Unknown'}? Isso criará novos treinos.`, "Importar Backup")) {
-                    await importData(json);
-                    await fetchWorkouts();
-                    await alert("Dados importados com sucesso!", "Sucesso");
-                }
-		} catch (err) {
-			await alert("Erro ao ler arquivo JSON: " + (err?.message ?? String(err)));
-		} finally {
-            try {
-                if (input) input.value = '';
-            } catch {}
-		}
-	};
-        reader.readAsText(file);
-    };
-
-    if (authLoading) return <LoadingScreen />;
-    if (!user?.id) return <LoadingScreen />;
-
-    const currentWorkoutId = activeSession?.workout?.id;
-    let nextWorkout = null;
-    if (currentWorkoutId && Array.isArray(workouts) && workouts.length > 0) {
-        const index = workouts.findIndex(w => w.id === currentWorkoutId);
-        if (index !== -1 && index + 1 < workouts.length) {
-            nextWorkout = workouts[index + 1];
-        }
-    }
-
-    const isHeaderVisible = view !== 'active' && view !== 'report';
-
-    return (
-        <InAppNotificationsProvider
-            userId={user?.id || null}
-            settings={userSettingsApi?.settings ?? null}
-            onOpenMessages={() => setView('chat')}
-            onOpenNotifications={() => {
-                setShowNotifCenter(true);
-                setHasUnreadNotification(false);
-            }}
-        >
-        <InAppNotifyBinder bind={bindInAppNotify} />
-        <TeamWorkoutProvider user={user} settings={userSettingsApi?.settings ?? null} onStartSession={handleStartSession}>
-            <div className="w-full bg-neutral-900 min-h-screen relative flex flex-col overflow-hidden" suppressHydrationWarning>
-                <IncomingInviteModal onStartSession={handleStartSession} />
-                <InviteAcceptedModal />
-                <GuidedTour
-                    open={Boolean(tourOpen)}
-                    steps={getTourSteps({
-                        role: user?.role,
-                        hasCommunity: (userSettingsApi?.settings?.moduleCommunity !== false),
-                    })}
-                    actions={{
-                        openAdminPanel: (tab) => {
-                            try {
-                                const safe = String(tab || 'dashboard').trim() || 'dashboard'
-                                openAdminPanel(safe)
-                            } catch {}
-                        },
-                    }}
-                    onEvent={(name, payload) => {
-                        logTourEvent(name, payload)
-                    }}
-                    onComplete={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: true, skipped: false, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'completed') } catch {}
-                        const res = await upsertTourFlags({ tour_completed_at: new Date().toISOString(), tour_skipped_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (completed). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_completed', { version: TOUR_VERSION })
-                    }}
-                    onSkip={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (skipped). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_skipped', { version: TOUR_VERSION })
-                    }}
-                    onCancel={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (cancelled). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_cancelled', { version: TOUR_VERSION })
-                    }}
-                />
-
-                {/* Header */}
-                {isHeaderVisible && (
-                    <div className="bg-neutral-950 flex justify-between items-center fixed top-0 left-0 right-0 z-40 border-b border-zinc-800 px-6 shadow-lg pt-[env(safe-area-inset-top)] min-h-[calc(4rem+env(safe-area-inset-top))]">
-                        <div 
-                            className="flex items-center cursor-pointer group"
-                            onClick={() => setView('dashboard')}
-                        >
-                            <div className="flex items-center gap-2">
-                                <Dumbbell size={18} className="text-yellow-500 opacity-25" />
-                                <h1 className="text-2xl font-black tracking-tighter italic leading-none text-white group-hover:opacity-80 transition-opacity">
-                                    IRON<span className="text-yellow-500">TRACKS</span>
-                                </h1>
-                            </div>
-                            <div className="h-6 w-px bg-yellow-500 mx-4 opacity-50"></div>
-                            <span className="text-zinc-400 text-xs font-medium tracking-wide uppercase">
-                                {isCoach ? 'Bem vindo Coach' : 'Bem vindo Atleta'}
-                            </span>
-                        </div>
-                        
-                        <div className="flex items-center gap-4">
-                                {(() => {
-                                    const pending = Number(syncState?.pending || 0)
-                                    const failed = Number(syncState?.failed || 0)
-                                    const online = syncState?.online !== false
-                                    const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-                                    const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-                                    if (!online) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-xs font-black uppercase tracking-widest">
-                                                Offline
-                                            </div>
-                                        )
-                                    }
-                                    if (offlineSyncV2Enabled && (pending > 0 || failed > 0)) {
-                                        return (
-                                            <button
-                                                type="button"
-                                                onClick={() => setOfflineSyncOpen(true)}
-                                                className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest hover:bg-yellow-500/15"
-                                                title="Abrir central de pendências"
-                                            >
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}{failed > 0 ? ` • Falhas: ${failed}` : ''}
-                                            </button>
-                                        )
-                                    }
-                                    if (pending > 0) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest">
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}
-                                            </div>
-                                        )
-                                    }
-                                    return null
-                                })()}
-                                <HeaderActionsMenu
-                                user={user}
-                                isCoach={isCoach}
-                                hasUnreadChat={hasUnreadChat}
-                                hasUnreadNotification={hasUnreadNotification}
-                                onOpenAdmin={() => {
-                                    if (typeof window !== 'undefined') {
-                                        const url = new URL(window.location);
-                                        url.searchParams.delete('view');
-                                        window.history.replaceState({}, '', url);
-                                    }
-                                    const tab = (() => {
-                                        try {
-                                            const url = new URL(window.location.href);
-                                            const current = String(url.searchParams.get('tab') || '').trim();
-                                            if (current) return current;
-                                        } catch {}
-                                        try {
-                                            const stored = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-                                            if (stored) return stored;
-                                        } catch {}
-                                        return 'dashboard';
-                                    })();
-                                    openAdminPanel(tab);
-                                }}
-                                onOpenChatList={() => setView('chatList')}
-                                onOpenGlobalChat={() => setView('globalChat')}
-                                onOpenHistory={() => setView('history')}
-                                onOpenNotifications={() => {
-                                    setShowNotifCenter(true);
-                                    setHasUnreadNotification(false);
-                                }}
-                                onOpenSchedule={() => router.push('/dashboard/schedule')}
-                                onOpenSettings={() => setSettingsOpen(true)}
-                                onOpenTour={async () => {
-                                    try {
-                                        await logTourEvent('tour_started', { auto: false, version: TOUR_VERSION })
-                                    } catch {}
-                                    setTourOpen(true)
-                                }}
-                                onLogout={handleLogout}
-                            />
-                        </div>
-                    </div>
-                )}
-
-                {isCoach && coachPending && (
-                    <div className="bg-yellow-500 text-black text-sm font-bold px-4 py-2 text-center">
-                        Sua conta de Professor está pendente. <button className="underline" onClick={async () => { try { const r = await fetch('/api/teachers/accept', { method: 'POST' }); const j = await r.json(); if (j.ok) { setCoachPending(false); await alert('Conta ativada!'); } else { await alert('Falha ao ativar: ' + (j.error || '')); } } catch (e) { await alert('Erro: ' + (e?.message ?? String(e))); } }}>Aceitar</button>
-                    </div>
-                )}
-
-                {/* Main Content */}
-                <div
-                    className="flex-1 overflow-y-auto custom-scrollbar relative"
-                    style={{
-                        '--dashboard-sticky-top': isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : '0px',
-                        paddingTop: isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : undefined,
-                    }}
-                >
-                    {(view === 'dashboard' || view === 'assessments' || view === 'community' || view === 'vip') && (
-                        <StudentDashboard
-                            workouts={Array.isArray(workouts) ? workouts : []}
-                            profileIncomplete={Boolean(profileIncomplete)}
-                            onOpenCompleteProfile={() => setShowCompleteProfile(true)}
-                            view={view === 'assessments' ? 'assessments' : view === 'community' ? 'community' : view === 'vip' ? 'vip' : 'dashboard'}
-                            onChangeView={(next) => setView(next)}
-                            assessmentsContent={(user?.id || initialUser?.id) ? <AssessmentHistory studentId={user?.id || initialUser?.id} /> : null}
-                            communityContent={(user?.id || initialUser?.id) ? <CommunityClient embedded /> : null}
-                            vipContent={<VipHub user={user} locked={!vipAccess?.hasVip} onOpenWorkoutEditor={(w) => handleEditWorkout(w)} onOpenVipTab={() => setView('vip')} />}
-                            vipLabel="VIP"
-                            vipLocked={!vipAccess?.hasVip}
-                            vipEnabled={true}
-                            settings={userSettingsApi?.settings ?? null}
-                            onCreateWorkout={handleCreateWorkout}
-                            onQuickView={(w) => setQuickViewWorkout(w)}
-                            onStartSession={(w) => handleStartSession(w)}
-                            onRestoreWorkout={(w) => handleRestoreWorkout(w)}
-                            onShareWorkout={(w) => handleShareWorkout(w)}
-                            onDuplicateWorkout={(w) => handleDuplicateWorkout(w)}
-                            onEditWorkout={(w) => handleEditWorkout(w)}
-                            onDeleteWorkout={(id, title) => handleDeleteWorkout(id, title)}
-                            onBulkEditWorkouts={handleBulkEditWorkouts}
-                            currentUserId={user?.id || initialUser?.id}
-                            exportingAll={Boolean(exportingAll)}
-                            onExportAll={handleExportAllWorkouts}
-                            streakStats={streakStats}
-                            onOpenJsonImport={() => setShowJsonImportModal(true)}
-                            onNormalizeAiWorkoutTitles={handleNormalizeAiWorkoutTitles}
-                            onNormalizeExercises={handleNormalizeExercises}
-                            onOpenDuplicates={handleOpenDuplicates}
-                            onApplyTitleRule={handleApplyTitleRule}
-                            onOpenIronScanner={async () => {
-                                try {
-                                    openManualWorkoutEditor()
-                                    await alert('No editor, clique em Scanner de Treino (Imagem).', 'Scanner')
-                                } catch {}
-                            }}
-                        />
-                    )}
-
-                    <WorkoutWizardModal
-                        isOpen={createWizardOpen}
-                        onClose={() => setCreateWizardOpen(false)}
-                        onManual={() => openManualWorkoutEditor()}
-                        onGenerate={async (answers, options) => {
-                            const mode = String(options?.mode || 'single').trim().toLowerCase();
-                            try {
-                                const res = await fetch('/api/ai/workout-wizard', {
-                                    method: 'POST',
-                                    headers: { 'Content-Type': 'application/json' },
-                                    body: JSON.stringify({ answers, mode }),
-                                })
-                                const data = await res.json().catch(() => null)
-                                if (!res.ok) {
-                                    const msg = data?.error ? String(data.error) : 'Falha ao gerar treino com IA.'
-                                    throw new Error(msg)
-                                }
-                                if (mode === 'program') {
-                                    const drafts = Array.isArray(data?.drafts) ? data.drafts : null
-                                    if (drafts && drafts.length) return { drafts }
-                                    if (data?.ok === false && Array.isArray(data?.drafts) && data.drafts.length) return { drafts: data.drafts }
-                                    throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                                }
-                                const draft = data?.draft && typeof data.draft === 'object' ? data.draft : null
-                                if (draft?.exercises && Array.isArray(draft.exercises) && draft.exercises.length > 0) return draft
-                                if (data?.ok === false && data?.draft) return data.draft
-                                throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                const lower = msg.toLowerCase()
-                                const isConfig = lower.includes('api de ia não configurada') || lower.includes('google_generative_ai_api_key')
-                                if (isConfig) throw e
-                                if (mode === 'program') {
-                                    const days = Math.max(2, Math.min(6, Number(answers?.daysPerWeek || 3) || 3))
-                                    const drafts = []
-                                    for (let i = 0; i < days; i++) {
-                                        drafts.push(generateWorkoutFromWizard(answers, i))
-                                    }
-                                    return { drafts }
-                                }
-                                return generateWorkoutFromWizard(answers, 0)
-                            }
-                        }}
-                        onSaveDrafts={async (drafts) => {
-                            const list = Array.isArray(drafts) ? drafts : []
-                            if (!list.length) return
-                            try {
-                                for (let i = 0; i < list.length; i += 1) {
-                                    const d = list[i]
-                                    const baseTitle = String(d?.title || 'Treino').trim() || 'Treino'
-                                    const finalTitle = formatProgramWorkoutTitle(baseTitle, i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                                    const exercises = Array.isArray(d?.exercises) ? d.exercises : []
-                                    const res = await createWorkout({ title: finalTitle, exercises })
-                                    if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino'))
-                                }
-                                try {
-                                    await fetchWorkouts()
-                                } catch {}
-                                setCreateWizardOpen(false)
-                                await alert(`Plano salvo: ${list.length} treinos criados.`)
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                await alert('Erro ao salvar plano: ' + msg)
-                            }
-                        }}
-                        onUseDraft={(draft) => {
-                            try {
-                                const title = String(draft?.title || '').trim() || 'Treino'
-                                const exercises = Array.isArray(draft?.exercises) ? draft.exercises : []
-                                setCurrentWorkout({ title, exercises })
-                                setView('edit')
-                            } finally {
-                                setCreateWizardOpen(false)
-                            }
-                        }}
-                    />
-
-					{view === 'edit' && (
-						<ExerciseEditor
-							workout={currentWorkout}
-							onCancel={() => setView('dashboard')}
-							onChange={setCurrentWorkout}
-							onSave={handleSaveWorkout}
-							onSaved={() => {
-								fetchWorkouts().catch(() => {});
-								setView('dashboard');
-							}}
-						/>
-					)}
-
-                    {view === 'active' && activeSession && (
-                        <ActiveWorkout
-                            session={activeSession}
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onUpdateLog={handleUpdateSessionLog}
-                            onFinish={handleFinishSession}
-                            onPersistWorkoutTemplate={handlePersistWorkoutTemplateFromSession}
-                            onBack={() => setView('dashboard')}
-                            onStartTimer={handleStartTimer}
-                            isCoach={isCoach}
-                            onUpdateSession={(updates) => setActiveSession(prev => ({ ...prev, ...updates }))}
-                            nextWorkout={nextWorkout}
-                            onEditWorkout={() => handleOpenActiveWorkoutEditor()}
-                            onAddExercise={() => handleOpenActiveWorkoutEditor({ addExercise: true })}
-                        />
-                    )}
-
-                    {editActiveOpen && view === 'active' && editActiveDraft && (
-                        <div
-                            className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3 md:p-6 pt-safe"
-                            onClick={() => handleCloseActiveWorkoutEditor()}
-                        >
-                            <div
-                                className="w-full max-w-5xl h-[92vh] bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-                                onClick={(e) => e.stopPropagation()}
-                            >
-                                <ExerciseEditor
-                                    workout={editActiveDraft}
-                                    onCancel={() => handleCloseActiveWorkoutEditor()}
-                                    onChange={(w) => setEditActiveDraft(normalizeWorkoutForEditor(w))}
-                                    onSave={handleSaveActiveWorkoutEditor}
-                                    onSaved={() => {
-                                        fetchWorkouts().catch(() => {});
-                                        handleCloseActiveWorkoutEditor();
-                                    }}
-                                />
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'history' && (
-                        <HistoryList
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onViewReport={(s) => { setReportBackView('history'); setReportData({ current: s, previous: null }); setView('report'); }}
-                            onBack={() => setView('dashboard')}
-                        />
-                    )}
-
-                    {/* Evolução removida conforme solicitação */}
-
-                    {view === 'report' && reportData.current && (
-                        <div className="fixed inset-0 z-[1200] bg-neutral-900 overflow-y-auto pt-safe">
-                            <WorkoutReport
-                                session={reportData.current}
-                                previousSession={reportData.previous}
-                                user={user}
-                                settings={userSettingsApi?.settings ?? null}
-                                onClose={() => setView(reportBackView || 'dashboard')}
-                            />
-                        </div>
-                    )}
-
-                    {duplicatesOpen && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe" onClick={() => !duplicatesBusy && setDuplicatesOpen(false)}>
-                            <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Ferramentas</div>
-                                        <div className="text-white font-black text-lg truncate">Duplicados</div>
-                                        <div className="text-xs text-neutral-400 truncate">{Array.isArray(duplicateGroups) ? `${duplicateGroups.length} grupos` : ''}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => setDuplicatesOpen(false)}
-                                        disabled={duplicatesBusy}
-                                        className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center disabled:opacity-50"
-                                        aria-label="Fechar"
-                                    >
-                                        <X size={18} />
-                                    </button>
-                                </div>
-                                <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-                                    {(Array.isArray(duplicateGroups) ? duplicateGroups : []).map((g, idx) => {
-                                        const items = Array.isArray(g?.items) ? g.items : []
-                                        const score = Number(g?.score || 0)
-                                        const base = items[0]
-                                        return (
-                                            <div key={`dup-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-4">
-                                                <div className="flex items-start justify-between gap-3">
-                                                    <div className="min-w-0">
-                                                        <div className="text-xs text-neutral-500 font-bold uppercase tracking-widest">Similaridade</div>
-                                                        <div className="text-white font-black truncate">{base?.title || 'Treino'}</div>
-                                                        <div className="text-xs text-neutral-400">{Math.round(score * 100)}%</div>
-                                                    </div>
-                                                    <div className="flex items-center gap-2">
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleMergeDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 disabled:opacity-50"
-                                                        >
-                                                            Mesclar
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleArchiveDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 disabled:opacity-50"
-                                                        >
-                                                            Arquivar
-                                                        </button>
-                                                    </div>
-                                                </div>
-                                                <div className="mt-3 space-y-2">
-                                                    {items.map((w, wi) => (
-                                                        <div key={`dup-item-${idx}-${wi}`} className="flex items-center justify-between gap-3 rounded-lg bg-neutral-900/40 border border-neutral-800 px-3 py-2">
-                                                            <div className="min-w-0">
-                                                                <div className="text-sm font-bold text-white truncate">{String(w?.title || 'Treino')}</div>
-                                                                <div className="text-[11px] text-neutral-500 font-mono">{Array.isArray(w?.exercises) ? w.exercises.length : 0} EXERCÍCIOS</div>
-                                                            </div>
-                                                            <div className="text-[11px] font-bold text-neutral-500">{wi === 0 ? 'BASE' : 'DUP'}</div>
-                                                        </div>
-                                                    ))}
-                                                </div>
-                                            </div>
-                                        )
-                                    })}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {showExportModal && exportWorkout && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowExportModal(false)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Como deseja exportar?</h3>
-                                    <BackButton onClick={() => setShowExportModal(false)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-3">
-                                    <button onClick={handleExportPdf} className="w-full px-4 py-3 bg-yellow-500 text-black font-bold rounded-xl">Baixar PDF</button>
-                                    <button onClick={handleExportJson} className="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl">Baixar JSON</button>
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {openStudent && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setOpenStudent(null)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Treinos de {openStudent.name}</h3>
-                                    <BackButton onClick={() => setOpenStudent(null)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-2 max-h-[70vh] overflow-y-auto">
-                                    {(openStudent.workouts || []).length === 0 && (
-                                        <p className="text-neutral-500 text-sm">Nenhum treino encontrado.</p>
-                                    )}
-                                    {(openStudent.workouts || []).map(w => (
-                                        <div key={w.id} className="p-3 rounded-xl border border-neutral-700 bg-neutral-800">
-                                            <div className="flex items-center justify-between">
-                                                <span className="text-white font-bold text-sm">{w.title}</span>
-                                                <span className="text-xs text-neutral-400">{w.exercises?.length || 0} exercícios</span>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'chat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'globalChat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'chatList' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatListScreen user={user} onClose={() => setView('dashboard')} onSelectChannel={(c) => { setDirectChat(c); setView('directChat'); }} />
-                        </div>
-                    )}
-
-                    {view === 'directChat' && directChat && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatDirectScreen user={user} otherUserId={directChat.other_user_id} otherUserName={directChat.other_user_name} otherUserPhoto={directChat.other_user_photo} onClose={() => setView('chatList')} />
-                        </div>
-                    )}
-
-                    {view === 'admin' && (
-                        <div className="fixed inset-0 z-[60]">
-                            <AdminPanelV2 user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-                </div>
-
-                {/* Modals & Overlays */}
-                {showCompleteProfile && (
-                    <div className="fixed inset-0 z-[85] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <div className="flex items-center justify-between gap-3 mb-4">
-                                <h3 className="font-black text-white">Completar Perfil</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-
-                            <label className="block text-xs font-bold uppercase tracking-widest text-neutral-500 mb-2">
-                                Nome de Exibição
-                            </label>
-                            <input
-                                value={profileDraftName}
-                                onChange={(e) => setProfileDraftName(e.target.value)}
-                                placeholder="Ex: João Silva"
-                                className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-yellow-500"
-                            />
-
-                            <div className="flex gap-2 mt-5">
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-300 disabled:opacity-50"
-                                >
-                                    Cancelar
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={handleSaveProfile}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-yellow-500 rounded-xl font-black text-black disabled:opacity-50"
-                                >
-                                    {savingProfile ? 'Salvando...' : 'Salvar'}
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                {showImportModal && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <h3 className="font-bold text-white mb-4">Importar Treino (Código)</h3>
-                            <input
-                                value={importCode}
-                                onChange={e => setImportCode(e.target.value)}
-                                placeholder="Cole o código do treino aqui"
-                                className="w-full bg-neutral-800 p-4 rounded-xl mb-4 text-white font-mono text-center uppercase"
-                            />
-                            <div className="flex gap-2">
-                                <button onClick={() => setShowImportModal(false)} className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-400">Cancelar</button>
-                                <button onClick={handleImportWorkout} className="flex-1 p-3 bg-blue-600 rounded-xl font-bold text-white">Importar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                
-                {showJsonImportModal && (
-                     <div className="fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <Upload size={48} className="mx-auto text-blue-500 mb-4" />
-                            <h3 className="font-bold text-white mb-2 text-xl">Restaurar Backup</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Selecione o arquivo .json que você salvou anteriormente.</p>
-                            
-                            <label className="block w-full cursor-pointer bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-colors">
-                                Selecionar Arquivo
-                                <input type="file" accept=".json" onChange={handleJsonUpload} className="hidden" />
-                            </label>
-                            
-                            <button onClick={() => setShowJsonImportModal(false)} className="mt-4 text-neutral-500 text-sm hover:text-white">Cancelar</button>
-                        </div>
-                    </div>
-                )}
-
-                {shareCode && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-black"><Check size={32} /></div>
-                            <h3 className="font-bold text-white mb-2">Link Gerado!</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Envie este código para seu aluno ou amigo.</p>
-                            <div className="bg-black p-4 rounded-xl font-mono text-yellow-500 text-xl mb-4 tracking-widest select-all">
-                                {shareCode}
-                            </div>
-                            <button onClick={() => setShareCode(null)} className="w-full p-3 bg-neutral-800 rounded-xl font-bold text-white">Fechar</button>
-                        </div>
-                    </div>
-                )}
-
-                {quickViewWorkout && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setQuickViewWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-lg rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">{String(quickViewWorkout?.title || '')}</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setQuickViewWorkout(null)}
-                                    className="flex items-center gap-2 text-yellow-500 hover:text-yellow-400 transition-colors py-2 px-3 rounded-xl hover:bg-neutral-800 active:opacity-70"
-                                    aria-label="Voltar"
-                                >
-                                    <ArrowLeft size={20} />
-                                    <span className="font-semibold text-sm">Voltar</span>
-                                </button>
-                            </div>
-                            <div className="p-4 max-h-[60vh] overflow-y-auto space-y-3 custom-scrollbar">
-                                {(Array.isArray(quickViewWorkout?.exercises) ? quickViewWorkout.exercises : []).map((ex, idx) => (
-                                    <div key={idx} className="p-3 rounded-xl bg-neutral-800/50 border border-neutral-700">
-                                        <div className="flex justify-between items-center">
-                                            <h4 className="font-bold text-white text-sm">{String(ex?.name || '—')}</h4>
-                                            <span className="text-xs text-neutral-400">{(parseInt(ex?.sets) || 0)} x {String(ex?.reps || '-')}</span>
-                                        </div>
-                                        <div className="text-xs text-neutral-400 mt-1 flex items-center gap-2">
-                                            <Clock size={14} className="text-yellow-500" /><span>Descanso: {ex?.restTime ? `${parseInt(ex.restTime)}s` : '-'}</span>
-                                        </div>
-                                        {ex?.notes && <p className="text-sm text-neutral-300 mt-2">{String(ex.notes || '')}</p>}
-                                    </div>
-                                ))}
-                                {(!Array.isArray(quickViewWorkout?.exercises) || quickViewWorkout.exercises.length === 0) && (
-                                    <p className="text-neutral-400 text-sm">Este treino não tem exercícios.</p>
-                                )}
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex gap-2">
-                                <button onClick={() => { const w = quickViewWorkout; setQuickViewWorkout(null); handleStartSession(w); }} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl">Iniciar Treino</button>
-                                <button onClick={() => setQuickViewWorkout(null)} className="flex-1 p-3 bg-neutral-800 text-white font-bold rounded-xl">Fechar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {showNotifCenter && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowNotifCenter(false)}>
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">Notificações</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowNotifCenter(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 relative">
-                                <NotificationCenter user={user} onStartSession={handleStartSession} embedded />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {activeSession?.timerTargetTime && (
-                    <RestTimerOverlay
-                        targetTime={activeSession.timerTargetTime}
-                        context={activeSession.timerContext}
-                        settings={userSettingsApi?.settings ?? null}
-                        onClose={handleCloseTimer}
-                        onFinish={handleCloseTimer}
-                    />
-                )}
-
-                {activeSession && view !== 'active' && (
-                    <div className="fixed bottom-0 left-0 right-0 z-[1100]">
-                        <div className="bg-neutral-900/95 backdrop-blur border-t border-neutral-800 px-4 py-3 pb-[max(env(safe-area-inset-bottom),12px)]">
-                            <div className="flex items-center gap-4">
-                                <div className="flex-1 min-w-0">
-                                    <h3 className="font-bold text-white truncate">{activeSession.workout?.title || 'Treino em andamento'}</h3>
-                                    <div className="flex items-center gap-3 text-xs text-neutral-300 mt-1">
-                                        <span className="font-mono text-yellow-500">{(() => { const end = sessionTicker || activeSession.startedAt; const s = Math.max(0, Math.floor((end - activeSession.startedAt) / 1000)); const m = Math.floor(s/60), sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; })()}</span>
-                                        <span className="text-neutral-500">tempo atual</span>
-                                        <span className="opacity-30">•</span>
-                                        <span className="font-mono text-neutral-200">{(() => { const total = (activeSession.workout?.exercises || []).reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0); return `${toMinutesRounded(total)} min`; })()}</span>
-                                        <span className="text-neutral-500">estimado total</span>
-                                    </div>
-                                    <div className="h-1 bg-neutral-700 rounded-full overflow-hidden mt-2">
-                                        {(() => {
-                                            const exCount = (activeSession.workout?.exercises || []).length;
-                                            let percent = 0;
-                                            if (exCount) {
-                                                const done = new Set();
-                                                if (activeSession.logs) {
-                                                    Object.keys(activeSession.logs).forEach(k => {
-                                                        const i = parseInt(k.split('-')[0]) || 0;
-                                                        done.add(i);
-                                                    });
-                                                }
-                                                const current = Math.min(done.size, exCount);
-                                                percent = Math.round((current / exCount) * 100);
-                                            }
-                                            return <div className="h-full bg-yellow-500" style={{ width: `${percent}%` }}></div>
-                                        })()}
-                                    </div>
-                                </div>
-                                <button className="shrink-0 px-4 py-2 bg-yellow-500 text-black font-black rounded-xl hover:bg-yellow-400" onClick={() => setView('active')}>Voltar pro treino</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {/* Admin Panel Modal controlled by State */}
-                {showAdminPanel && (
-                    <AdminPanelV2 user={user} onClose={closeAdminPanel} />
-                )}
-
-                {whatsNewOpen && (
-                    <WhatsNewModal
-                        isOpen={whatsNewOpen}
-                        entry={getLatestWhatsNew()}
-                        onClose={closeWhatsNew}
-                    />
-                )}
-
-                {preCheckinOpen && (
-                    <div
-                        className="fixed inset-0 z-[1300] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-                        onClick={() => {
-                            setPreCheckinOpen(false)
-                            const r = preCheckinResolveRef.current
-                            preCheckinResolveRef.current = null
-                            if (typeof r === 'function') r(null)
-                        }}
-                    >
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Check-in</div>
-                                    <div className="text-white font-black text-lg truncate">Pré-treino</div>
-                                    <div className="text-xs text-neutral-400 truncate">{String(preCheckinWorkout?.title || preCheckinWorkout?.name || 'Treino')}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-4">
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Energia (1–5)</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[1, 2, 3, 4, 5].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, energy: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.energy || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Dor / Soreness (0–10)</div>
-                                    <select
-                                        value={String(preCheckinDraft?.soreness ?? '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, soreness: String(e.target.value || '') }))}
-                                        className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                                    >
-                                        <option value="">Não informar</option>
-                                        {Array.from({ length: 11 }).map((_, i) => (
-                                            <option key={i} value={String(i)}>
-                                                {i}
-                                            </option>
-                                        ))}
-                                    </select>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Tempo disponível</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[30, 45, 60, 90, 120].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, timeMinutes: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.timeMinutes || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}m
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Observações (opcional)</div>
-                                    <textarea
-                                        value={String(preCheckinDraft?.notes || '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, notes: String(e.target.value || '') }))}
-                                        className="w-full min-h-[90px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none"
-                                        placeholder="Ex.: pouco sono, dor no joelho, viagem…"
-                                    />
-                                </div>
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex items-center gap-2">
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-                                >
-                                    Pular
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(preCheckinDraft)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-                                >
-                                    Continuar
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {settingsOpen && (
-                    <SettingsModal
-                        isOpen={settingsOpen}
-                        onClose={() => setSettingsOpen(false)}
-                        settings={userSettingsApi?.settings ?? null}
-                        userRole={user?.role || ''}
-                        saving={Boolean(userSettingsApi?.saving)}
-                        onOpenWhatsNew={() => {
-                            setSettingsOpen(false)
-                            setWhatsNewOpen(true)
-                        }}
-                        onSave={async (next) => {
-                            try {
-                                const safeNext = next && typeof next === 'object' ? next : (userSettingsApi?.settings ?? {})
-                                const res = await userSettingsApi?.save?.(safeNext)
-                                if (!res?.ok) {
-                                    await alert('Falha ao salvar: ' + (res?.error || ''))
-                                    return false
-                                }
-                                return true
-                            } catch (e) {
-                                await alert('Falha ao salvar: ' + (e?.message ?? String(e)))
-                                return false
-                            }
-                        }}
-                    />
-                )}
-
-                <OfflineSyncModal
-                    open={offlineSyncOpen}
-                    onClose={() => setOfflineSyncOpen(false)}
-                    userId={user?.id}
-                />
-            </div>
-        </TeamWorkoutProvider>
-        </InAppNotificationsProvider>
-    );
-}
-
-export default function IronTracksAppClient({ initialUser, initialProfile, initialWorkouts }) {
-    const [isMounted, setIsMounted] = useState(false);
-    useEffect(() => {
-        const t = setTimeout(() => {
-            setIsMounted(true);
-        }, 0);
-        return () => clearTimeout(t);
-    }, []);
-    if (!isMounted) return <LoadingScreen />;
-    return (
-        <DialogProvider>
-            <ErrorReporterProvider>
-                <ErrorBoundary>
-                    <IronTracksApp initialUser={initialUser} initialProfile={initialProfile} initialWorkouts={initialWorkouts} />
-                </ErrorBoundary>
-                <GlobalDialog />
-            </ErrorReporterProvider>
-        </DialogProvider>
-    );
-}
diff --git a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 6.js b/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 6.js
deleted file mode 100644
index 922ccda..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 6.js	
+++ /dev/null
@@ -1,3603 +0,0 @@
-'use client';
-
-import React, { useState, useEffect, useCallback, Suspense, useRef } from 'react';
-import { useRouter } from 'next/navigation';
-import dynamic from 'next/dynamic';
-import Image from 'next/image';
-import {
-    RotateCcw,
-    History,
-    MoreVertical,
-    Share2,
-    Trash2,
-    Download,
-    Copy,
-    Plus,
-    Flame,
-    Play,
-    Dumbbell,
-    Check,
-    LogOut,
-    Clock,
-    Upload,
-    ArrowLeft,
-    X
-} from 'lucide-react';
-import { createClient } from '@/utils/supabase/client';
-import { createWorkout, updateWorkout, deleteWorkout, importData, computeWorkoutStreakAndStats, setWorkoutArchived, setWorkoutSortOrder } from '@/actions/workout-actions';
-
-import LoginScreen from '@/components/LoginScreen';
-import AdminPanelV2 from '@/components/AdminPanelV2';
-import ChatScreen from '@/components/ChatScreen';
-import ChatListScreen from '@/components/ChatListScreen';
-import ChatDirectScreen from '@/components/ChatDirectScreen';
-import HistoryList from '@/components/HistoryList';
-import CommunityClient from '@/app/(app)/community/CommunityClient';
-import StudentEvolution from '@/components/StudentEvolution';
-import WorkoutReport from '@/components/WorkoutReport';
-import ActiveWorkout from '@/components/ActiveWorkout';
-import RestTimerOverlay from '@/components/RestTimerOverlay';
-import LoadingScreen from '@/components/LoadingScreen';
-import ExerciseEditor from '@/components/ExerciseEditor';
-import IncomingInviteModal from '@/components/IncomingInviteModal';
-import InviteAcceptedModal from '@/components/InviteAcceptedModal';
-import NotificationCenter from '@/components/NotificationCenter';
-import HeaderActionsMenu from '@/components/HeaderActionsMenu.js';
-import { TeamWorkoutProvider } from '@/contexts/TeamWorkoutContext';
-import { InAppNotificationsProvider, useInAppNotifications } from '@/contexts/InAppNotificationsContext';
-import ErrorBoundary from '@/components/ErrorBoundary';
-import ErrorReporterProvider from '@/components/ErrorReporterProvider';
-import { DialogProvider, useDialog } from '@/contexts/DialogContext';
-import GlobalDialog from '@/components/GlobalDialog';
-import { playStartSound, unlockAudio } from '@/lib/sounds';
-import { workoutPlanHtml } from '@/utils/report/templates';
-import { estimateExerciseSeconds, toMinutesRounded, calculateExerciseDuration } from '@/utils/pacing';
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName'
-import { formatProgramWorkoutTitle } from '@/utils/workoutTitle'
-import { resolveCanonicalExerciseName } from '@/utils/exerciseCanonical'
-import { BackButton } from '@/components/ui/BackButton';
-import StudentDashboard from '@/components/dashboard/StudentDashboard.tsx'
-import WorkoutWizardModal from '@/components/dashboard/WorkoutWizardModal'
-import SettingsModal from '@/components/SettingsModal'
-import { useUserSettings } from '@/hooks/useUserSettings'
-import WhatsNewModal from '@/components/WhatsNewModal'
-import { generateWorkoutFromWizard } from '@/utils/workoutAutoGenerator'
-import { getLatestWhatsNew } from '@/content/whatsNew'
-import GuidedTour from '@/components/onboarding/GuidedTour'
-import { getTourSteps } from '@/utils/tourSteps'
-import { cacheGetWorkouts, cacheSetWorkouts, flushOfflineQueue, getOfflineQueueSummary, getPendingCount, isOnline } from '@/lib/offline/offlineSync'
-import OfflineSyncModal from '@/components/OfflineSyncModal'
-
-const AssessmentHistory = dynamic(() => import('@/components/assessment/AssessmentHistory'), { ssr: false });
-const VipHub = dynamic(() => import('@/components/VipHub'), { ssr: false });
-
-const appId = 'irontracks-production';
-
-function InAppNotifyBinder({ bind }) {
-    const { notify } = useInAppNotifications();
-    const safeBind = typeof bind === 'function' ? bind : null;
-    useEffect(() => {
-        if (!safeBind) return;
-        safeBind(notify);
-        return () => {
-            try { safeBind(null); } catch {}
-        };
-    }, [notify, safeBind]);
-    return null;
-}
-
-const mapWorkoutRow = (w) => {
-	const rawExercises = Array.isArray(w?.exercises) ? w.exercises : [];
-	const exs = rawExercises
-		.filter((e) => e && typeof e === 'object')
-		.sort((a, b) => (a.order || 0) - (b.order || 0))
-		.map((e) => {
-			try {
-				const isCardio = String(e.method || '').toLowerCase() === 'cardio';
-				const dbSets = Array.isArray(e.sets)
-					? e.sets.filter((s) => s && typeof s === 'object')
-					: [];
-
-				const sortedSets = dbSets
-					.slice()
-					.sort((aSet, bSet) => (aSet?.set_number || 0) - (bSet?.set_number || 0));
-
-				const setsCount = sortedSets.length || (isCardio ? 1 : 4);
-
-				const setDetails = sortedSets.map((s, idx) => ({
-					set_number: s?.set_number ?? idx + 1,
-					reps: s?.reps ?? null,
-					rpe: s?.rpe ?? null,
-					weight: s?.weight ?? null,
-					is_warmup: !!(s?.is_warmup ?? s?.isWarmup),
-					advanced_config: s?.advanced_config ?? s?.advancedConfig ?? null,
-				}));
-
-				const nonEmptyReps = setDetails
-					.map((s) => s.reps)
-					.filter((r) => r !== null && r !== undefined && r !== '');
-				const defaultReps = isCardio ? '20' : '10';
-				let repsHeader = defaultReps;
-				if (nonEmptyReps.length > 0) {
-					const uniqueReps = Array.from(new Set(nonEmptyReps));
-					repsHeader = uniqueReps.length === 1 ? uniqueReps[0] : nonEmptyReps[0] ?? defaultReps;
-				}
-
-				const rpeValues = setDetails
-					.map((s) => s.rpe)
-					.filter((v) => v !== null && v !== undefined && !Number.isNaN(v));
-				const defaultRpe = isCardio ? 5 : 8;
-				const rpeHeader = rpeValues.length > 0 ? rpeValues[0] : defaultRpe;
-
-				return {
-					id: e.id,
-					name: e.name,
-					notes: e.notes,
-					videoUrl: e.video_url,
-					restTime: e.rest_time,
-					cadence: e.cadence,
-					method: e.method,
-					sets: setsCount,
-					reps: repsHeader,
-					rpe: rpeHeader,
-					setDetails,
-				};
-			} catch (mapErr) {
-				console.error('Erro ao mapear exercício', {
-					workoutId: w?.id,
-					exerciseId: e?.id,
-					error: mapErr,
-				});
-				return null;
-			}
-		})
-		.filter(Boolean);
-
-	return {
-		id: w.id,
-		title: w.name,
-		notes: w.notes,
-		exercises: exs,
-		is_template: !!w.is_template,
-		user_id: w.user_id,
-		created_by: w.created_by,
-        archived_at: w.archived_at ?? null,
-        sort_order: typeof w.sort_order === 'number' ? w.sort_order : (w.sort_order == null ? 0 : Number(w.sort_order) || 0),
-        created_at: w.created_at ?? null,
-	};
-};
-
-function IronTracksApp({ initialUser, initialProfile, initialWorkouts }) {
-    const { confirm, alert } = useDialog();
-    const [user, setUser] = useState(initialUser ?? null);
-    const [authLoading, setAuthLoading] = useState(false);
-    const [view, setView] = useState('dashboard');
-    const [directChat, setDirectChat] = useState(null);
-    const [workouts, setWorkouts] = useState(() => {
-        try {
-            const list = Array.isArray(initialWorkouts) ? initialWorkouts : [];
-            const mapped = list
-                .map((row) => mapWorkoutRow(row))
-                .filter(Boolean)
-                .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-            return mapped;
-        } catch {
-            return [];
-        }
-    });
-    const [stats, setStats] = useState({ workouts: 0, exercises: 0, activeStreak: 0 });
-    const [streakStats, setStreakStats] = useState(null);
-    const streakRefreshRef = useRef({ inFlight: false, lastAt: 0 });
-    const [newRecordsReloadKey, setNewRecordsReloadKey] = useState(0);
-    const [currentWorkout, setCurrentWorkout] = useState(null);
-    const [createWizardOpen, setCreateWizardOpen] = useState(false)
-    const [importCode, setImportCode] = useState('');
-    const [shareCode, setShareCode] = useState(null);
-    const [quickViewWorkout, setQuickViewWorkout] = useState(null);
-    const [showImportModal, setShowImportModal] = useState(false);
-    const [showJsonImportModal, setShowJsonImportModal] = useState(false);
-    const [reportData, setReportData] = useState({ current: null, previous: null });
-    const [reportBackView, setReportBackView] = useState('dashboard');
-    const [duplicatesOpen, setDuplicatesOpen] = useState(false);
-    const [duplicateGroups, setDuplicateGroups] = useState([]);
-    const [duplicatesBusy, setDuplicatesBusy] = useState(false);
-    const inAppNotifyRef = useRef(null);
-    const bindInAppNotify = useCallback((fn) => {
-        inAppNotifyRef.current = typeof fn === 'function' ? fn : null;
-    }, []);
-    const inAppNotify = useCallback((payload) => {
-        const fn = inAppNotifyRef.current;
-        if (typeof fn === 'function') fn(payload);
-    }, []);
-
-    const [preCheckinOpen, setPreCheckinOpen] = useState(false)
-    const [preCheckinWorkout, setPreCheckinWorkout] = useState(null)
-    const [preCheckinDraft, setPreCheckinDraft] = useState({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-    const preCheckinResolveRef = useRef(null)
-
-    const requestPreWorkoutCheckin = useCallback(async (workout) => {
-        if (!user?.id) return null
-        if (preCheckinOpen) return null
-        return await new Promise((resolve) => {
-            preCheckinResolveRef.current = (value) => {
-                resolve(value ?? null)
-            }
-            setPreCheckinWorkout(workout && typeof workout === 'object' ? workout : null)
-            setPreCheckinDraft({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-            setPreCheckinOpen(true)
-        })
-    }, [preCheckinOpen, user?.id])
-    const [settingsOpen, setSettingsOpen] = useState(false)
-    const [whatsNewOpen, setWhatsNewOpen] = useState(false)
-    const [isCoach, setIsCoach] = useState(false);
-    const initialRole = String(initialProfile?.role || '').toLowerCase()
-    const [vipAccess, setVipAccess] = useState(() => ({
-        loaded: initialRole === 'admin' || initialRole === 'teacher',
-        hasVip: initialRole === 'admin' || initialRole === 'teacher',
-    }))
-    const [hasUnreadChat, setHasUnreadChat] = useState(false);
-    const [hasUnreadNotification, setHasUnreadNotification] = useState(false);
-    const [exportWorkout, setExportWorkout] = useState(null);
-    const [showExportModal, setShowExportModal] = useState(false);
-    const [coachPending, setCoachPending] = useState(false);
-    const [studentFolders, setStudentFolders] = useState([]);
-    const [openStudent, setOpenStudent] = useState(null);
-    const [showNotifCenter, setShowNotifCenter] = useState(false);
-    const [exportingAll, setExportingAll] = useState(false);
-
-    const [profileIncomplete, setProfileIncomplete] = useState(false);
-    const [profileDraftName, setProfileDraftName] = useState('');
-    const [savingProfile, setSavingProfile] = useState(false);
-    const [showCompleteProfile, setShowCompleteProfile] = useState(false);
-
-    // Estado Global da Sessão Ativa
-	const [activeSession, setActiveSession] = useState(null);
-	const suppressForeignFinishToastUntilRef = useRef(0);
-    const [sessionTicker, setSessionTicker] = useState(0);
-    const [editActiveOpen, setEditActiveOpen] = useState(false);
-    const [editActiveDraft, setEditActiveDraft] = useState(null);
-    const editActiveBaseRef = useRef(null);
-    const editActiveAddExerciseRef = useRef(false);
-    const [showAdminPanel, setShowAdminPanel] = useState(false);
-    const userSettingsApi = useUserSettings(user?.id)
-    const whatsNewShownRef = useRef(false)
-    const TOUR_VERSION = 1
-    const [tourOpen, setTourOpen] = useState(false)
-    const [tourBoot, setTourBoot] = useState({ loaded: false, completed: false, skipped: false, version: TOUR_VERSION })
-    const [syncState, setSyncState] = useState({ online: true, syncing: false, pending: 0 })
-    const [offlineSyncOpen, setOfflineSyncOpen] = useState(false)
-
-    // Local fallback to guarantee the tour doesn't re-open when DB upsert fails/offline.
-    // Stored per-user AND per-tour-version.
-    const getTourLocalKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.dismissed.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourAutoOpenedKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.autoOpened.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourSeenKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.seen.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const readLocalTourDismissal = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return null
-        try {
-            if (typeof window === 'undefined') return null
-            const key = getTourLocalKey(safeUid)
-            if (!key) return null
-            const raw = window.localStorage.getItem(key) || ''
-            if (!raw) return null
-            const parsed = JSON.parse(raw)
-            if (!parsed || typeof parsed !== 'object') return null
-            const version = Number(parsed?.version || 0) || 0
-            if (version !== TOUR_VERSION) return null
-            const status = String(parsed?.status || '')
-            if (status !== 'completed' && status !== 'skipped') return null
-            return { version, status, at: Number(parsed?.at || 0) || 0 }
-        } catch {
-            return null
-        }
-    }, [TOUR_VERSION, getTourLocalKey])
-    const writeLocalTourDismissal = useCallback((uid, status) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        const safeStatus = status === 'completed' ? 'completed' : 'skipped'
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourLocalKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, JSON.stringify({ version: TOUR_VERSION, status: safeStatus, at: Date.now() }))
-        } catch {}
-    }, [TOUR_VERSION, getTourLocalKey])
-    const wasTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourSeenKey(safeUid)
-            if (!key) return false
-            return (window.localStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourSeenKey])
-    const markTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourSeenKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourSeenKey])
-    const wasTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return false
-            return (window.sessionStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourAutoOpenedKey])
-    const markTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return
-            window.sessionStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourAutoOpenedKey])
-
-    const supabase = useRef(createClient()).current;
-    const router = useRouter();
-    const isFetching = useRef(false);
-
-    const ADMIN_PANEL_OPEN_KEY = 'irontracks_admin_panel_open';
-
-    const refreshSyncState = useCallback(async () => {
-        try {
-            const online = isOnline()
-            const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-            if (offlineSyncV2Enabled) {
-                const sum = await getOfflineQueueSummary({ userId: user?.id })
-                if (sum?.ok) {
-                    setSyncState((prev) => ({
-                        ...(prev || {}),
-                        online: sum.online !== false,
-                        pending: Number(sum.pending || 0),
-                        failed: Number(sum.failed || 0),
-                        due: Number(sum.due || 0),
-                    }))
-                    return
-                }
-            }
-            const pending = await getPendingCount(user?.id)
-            setSyncState((prev) => ({ ...(prev || {}), online, pending, failed: 0, due: 0 }))
-        } catch {
-            setSyncState((prev) => ({ ...(prev || {}), online: isOnline() }))
-        }
-    }, [user?.id, userSettingsApi?.settings])
-
-    const runFlushQueue = useCallback(async () => {
-        try {
-            if (!isOnline()) {
-                setSyncState((prev) => ({ ...(prev || {}), online: false }))
-                return
-            }
-            setSyncState((prev) => ({ ...(prev || {}), syncing: true, online: true }))
-            await flushOfflineQueue({ max: 8 })
-        } finally {
-            setSyncState((prev) => ({ ...(prev || {}), syncing: false }))
-            await refreshSyncState()
-        }
-    }, [refreshSyncState])
-
-    useEffect(() => {
-        refreshSyncState()
-        const onChanged = () => refreshSyncState()
-        const onOnline = () => runFlushQueue()
-        const onOffline = () => refreshSyncState()
-        try {
-            window.addEventListener('irontracks.offlineQueueChanged', onChanged)
-            window.addEventListener('online', onOnline)
-            window.addEventListener('offline', onOffline)
-        } catch {}
-        return () => {
-            try {
-                window.removeEventListener('irontracks.offlineQueueChanged', onChanged)
-                window.removeEventListener('online', onOnline)
-                window.removeEventListener('offline', onOffline)
-            } catch {}
-        }
-    }, [refreshSyncState, runFlushQueue])
-
-    useEffect(() => {
-        if (!user?.id) return
-        if (!isOnline()) return
-        if ((syncState?.pending || 0) <= 0) return
-        const t = setInterval(() => {
-            runFlushQueue()
-        }, 15000)
-        return () => clearInterval(t)
-    }, [runFlushQueue, syncState?.pending, user?.id])
-
-    const logTourEvent = useCallback(async (event, payload) => {
-        try {
-            if (!user?.id) return
-            const ev = String(event || '').trim()
-            if (!ev) return
-            const basePayload = payload && typeof payload === 'object' ? payload : {}
-            const enriched = {
-                ...basePayload,
-                role: String(user?.role || ''),
-                path: (() => {
-                    try { return typeof window !== 'undefined' ? String(window.location.pathname || '') : '' } catch { return '' }
-                })(),
-            }
-            await supabase.from('onboarding_events').insert({
-                user_id: user.id,
-                event: ev,
-                payload: enriched,
-            })
-        } catch {}
-    }, [supabase, user?.id, user?.role])
-
-    const upsertTourFlags = useCallback(async (patch) => {
-        try {
-            if (!user?.id) return { ok: false, error: 'missing_user' }
-            const base = patch && typeof patch === 'object' ? patch : {}
-            const payload = {
-                user_id: user.id,
-                preferences: userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {},
-                tour_version: TOUR_VERSION,
-                updated_at: new Date().toISOString(),
-                ...base,
-            }
-            await supabase.from('user_settings').upsert(payload, { onConflict: 'user_id' })
-            return { ok: true }
-        } catch (e) {
-            return { ok: false, error: e?.message ?? String(e) }
-        }
-    }, [TOUR_VERSION, supabase, user?.id, userSettingsApi?.settings])
-
-    useEffect(() => {
-        if (!user?.id) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const uid = String(user.id)
-                const localDismissal = readLocalTourDismissal(uid)
-                if (localDismissal) {
-                    // Defensive: if the user already dismissed locally (offline, blocked RLS, etc.), never auto-open again.
-                    const completed = localDismissal.status === 'completed'
-                    const skipped = localDismissal.status === 'skipped'
-                    setTourBoot({ loaded: true, completed, skipped, version: TOUR_VERSION })
-                    return
-                }
-
-                const { data } = await supabase
-                    .from('user_settings')
-                    .select('tour_version, tour_completed_at, tour_skipped_at')
-                    .eq('user_id', user.id)
-                    .maybeSingle()
-
-                if (cancelled) return
-
-                const dbVersion = Number(data?.tour_version || 0) || 0
-                // Only force a new auto-open when the DB explicitly says an older version was seen.
-                // If dbVersion is missing/0 but completed_at exists, we respect completed/skipped to avoid annoying loops.
-                const needsNewVersion = dbVersion > 0 && dbVersion < TOUR_VERSION
-                const completed = needsNewVersion ? false : !!data?.tour_completed_at
-                const skipped = needsNewVersion ? false : !!data?.tour_skipped_at
-                setTourBoot({ loaded: true, completed, skipped, version: dbVersion || TOUR_VERSION })
-
-                const shouldOpen = !wasTourSeenEver(uid) && !wasTourAutoOpenedThisSession(uid) && (!completed && !skipped)
-                if (shouldOpen) {
-                    markTourAutoOpenedThisSession(uid)
-                    markTourSeenEver(uid)
-                    await logTourEvent('tour_started', { auto: true, version: TOUR_VERSION })
-                    setTourOpen(true)
-                }
-            } catch {
-                if (!cancelled) setTourBoot((prev) => ({ ...(prev || {}), loaded: true }))
-            }
-        })()
-        return () => {
-            cancelled = true
-        }
-    }, [TOUR_VERSION, logTourEvent, markTourAutoOpenedThisSession, markTourSeenEver, readLocalTourDismissal, supabase, user?.id, wasTourAutoOpenedThisSession, wasTourSeenEver])
-
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : '';
-        if (!uid) return;
-        const key = `irontracks.socialPresencePing.v1.${uid}`;
-        try {
-            if (typeof window !== 'undefined') {
-                const seen = window.sessionStorage.getItem(key) || '';
-                if (seen === '1') return;
-                window.sessionStorage.setItem(key, '1');
-            }
-        } catch {}
-        try {
-            fetch('/api/social/presence/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-        try {
-            fetch('/api/profiles/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-    }, [user?.id]);
-
-    useEffect(() => {
-        if (authLoading) return;
-        if (user) return;
-        const t = setTimeout(() => {
-            try {
-                router.replace('/?next=/dashboard');
-            } catch {}
-        }, 150);
-        return () => {
-            clearTimeout(t);
-        };
-    }, [authLoading, user, router]);
-
-    useEffect(() => {
-        if (whatsNewShownRef.current) return
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        if (!userSettingsApi?.loaded) return
-        const entry = getLatestWhatsNew()
-        if (!entry?.id) return
-        const prefs = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-        if (prefs?.whatsNewAutoOpen === false) return
-        const lastSeenId = String(prefs?.whatsNewLastSeenId || '')
-        const lastSeenAt = Number(prefs?.whatsNewLastSeenAt || 0) || 0
-        const remind24h = prefs?.whatsNewRemind24h !== false
-        const within24h = lastSeenAt > 0 && Date.now() - lastSeenAt < 24 * 60 * 60 * 1000
-        if (lastSeenId === String(entry.id)) {
-            if (!remind24h) return
-            if (within24h) return
-        }
-        whatsNewShownRef.current = true
-        setWhatsNewOpen(true)
-    }, [user?.id, userSettingsApi?.loaded, userSettingsApi?.settings])
-
-    const closeWhatsNew = useCallback(async () => {
-        try {
-            setWhatsNewOpen(false)
-            const entry = getLatestWhatsNew()
-            if (!entry?.id) return
-            const prev = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-            const prevSeenId = String(prev?.whatsNewLastSeenId || '')
-            const nextSeenAt = Date.now()
-            const next = { ...(prev || {}), whatsNewLastSeenId: String(entry.id), whatsNewLastSeenAt: nextSeenAt }
-            try { userSettingsApi?.setSettings?.(next) } catch {}
-            try { await userSettingsApi?.save?.(next) } catch {}
-        } catch {}
-    }, [userSettingsApi])
-    const ADMIN_PANEL_TAB_KEY = 'irontracks_admin_panel_tab';
-
-    const setUrlTabParam = useCallback((nextTab) => {
-        try {
-            if (typeof window === 'undefined') return;
-            const tabValue = String(nextTab || '').trim();
-            if (!tabValue) return;
-            const url = new URL(window.location.href);
-            url.searchParams.set('tab', tabValue);
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const removeUrlTabParam = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const url = new URL(window.location.href);
-            url.searchParams.delete('tab');
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const openAdminPanel = useCallback((tab) => {
-        setShowAdminPanel(true);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                if (tab) sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, String(tab));
-                if (tab) setUrlTabParam(tab);
-            }
-        } catch {}
-    }, [setUrlTabParam]);
-
-    const closeAdminPanel = useCallback(() => {
-        setShowAdminPanel(false);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.removeItem(ADMIN_PANEL_OPEN_KEY);
-                sessionStorage.removeItem(ADMIN_PANEL_TAB_KEY);
-            }
-        } catch {}
-        removeUrlTabParam();
-    }, [removeUrlTabParam]);
-
-    const restoreAdminPanelIfNeeded = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const role = String(user?.role || '').toLowerCase();
-            const isPrivileged = role === 'admin' || role === 'teacher';
-            if (!isPrivileged) return;
-
-            const validTabs = new Set(['dashboard', 'students', 'teachers', 'templates', 'videos', 'broadcast', 'system']);
-            const url = new URL(window.location.href);
-            const urlTabRaw = String(url.searchParams.get('tab') || '').trim();
-            const urlTab = validTabs.has(urlTabRaw) ? urlTabRaw : '';
-
-            const open = sessionStorage.getItem(ADMIN_PANEL_OPEN_KEY);
-            const storedTabRaw = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-            const storedTab = validTabs.has(storedTabRaw) ? storedTabRaw : '';
-
-            const shouldOpen = open === '1' || !!urlTab;
-            if (!shouldOpen) return;
-
-            const tab = urlTab || storedTab || 'dashboard';
-            try {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, tab);
-            } catch {}
-            if (!urlTab && tab) setUrlTabParam(tab);
-            setShowAdminPanel(true);
-        } catch {}
-    }, [setUrlTabParam, user?.role]);
-
-    const resolveExerciseVideos = useCallback(async (exercises) => {
-        try {
-            const list = Array.isArray(exercises) ? exercises : [];
-            const missingNames = list
-                .map((ex) => {
-                    const name = String(ex?.name || '').trim();
-                    if (!name) return null;
-                    const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                    if (current) return null;
-                    return name;
-                })
-                .filter(Boolean);
-
-            const uniqueNames = Array.from(new Set(missingNames)).slice(0, 80);
-            if (!uniqueNames.length) return { exercises: list, updates: [] };
-
-            const res = await fetch('/api/exercise-library/resolve', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ names: uniqueNames }),
-            });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return { exercises: list, updates: [] };
-
-            const videos = json?.videos && typeof json.videos === 'object' ? json.videos : {};
-            const updates = [];
-
-            const next = list.map((ex) => {
-                const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                if (current) return ex;
-                const normalized = normalizeExerciseName(String(ex?.name || ''));
-                const url = normalized ? String(videos[normalized] || '').trim() : '';
-                if (!url) return ex;
-                if (ex?.id) updates.push({ id: ex.id, url });
-                return { ...ex, videoUrl: url, video_url: url };
-            });
-
-            return { exercises: next, updates };
-        } catch {
-            return { exercises: Array.isArray(exercises) ? exercises : [], updates: [] };
-        }
-    }, []);
-
-    const persistExerciseVideoUrls = useCallback(async (updates) => {
-        try {
-            const rows = Array.isArray(updates) ? updates : [];
-            const filtered = rows
-                .map((r) => ({ id: String(r?.id || '').trim(), url: String(r?.url || '').trim() }))
-                .filter((r) => !!r.id && !!r.url)
-                .slice(0, 100);
-            if (!filtered.length) return;
-            await Promise.allSettled(filtered.map((r) => supabase.from('exercises').update({ video_url: r.url }).eq('id', r.id)));
-        } catch {}
-    }, [supabase]);
-
-    const signOutInFlightRef = useRef(false);
-    const serverSessionSyncRef = useRef({ timer: null, lastKey: '' });
-    const serverSessionSyncWarnedRef = useRef(false);
-
-    const generateExerciseKey = useCallback(() => {
-        try {
-            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
-        } catch {}
-        return `ex_${Date.now()}_${Math.random().toString(16).slice(2)}`;
-    }, []);
-
-    const normalizeWorkoutForEditor = useCallback((raw) => {
-        try {
-            const base = raw && typeof raw === 'object' ? raw : {};
-            const title = String(base.title || base.name || 'Treino').trim() || 'Treino';
-            const exercisesRaw = Array.isArray(base.exercises) ? base.exercises : [];
-            const exercisesInitial = exercisesRaw.filter((ex) => ex && typeof ex === 'object').map((ex) => {
-                const existing = ex?._itx_exKey ? String(ex._itx_exKey) : '';
-                const fromId = ex?.id != null ? `id_${String(ex.id)}` : '';
-                const nextKey = existing || fromId || generateExerciseKey();
-                return { ...ex, _itx_exKey: nextKey };
-            });
-
-            const seen = new Set();
-            const exercises = exercisesInitial.map((ex) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k || seen.has(k)) {
-                    const nextKey = generateExerciseKey();
-                    seen.add(nextKey);
-                    return { ...ex, _itx_exKey: nextKey };
-                }
-                seen.add(k);
-                return ex;
-            });
-
-            return { ...base, title, exercises };
-        } catch {
-            return { title: 'Treino', exercises: [] };
-        }
-    }, [generateExerciseKey]);
-
-    const stripWorkoutInternalKeys = useCallback((workout) => {
-        try {
-            const w = workout && typeof workout === 'object' ? workout : {};
-            const exercises = Array.isArray(w.exercises)
-                ? w.exercises.map((ex) => {
-                      if (!ex || typeof ex !== 'object') return ex;
-                      const { _itx_exKey, ...rest } = ex;
-                      return rest;
-                  })
-                : w.exercises;
-            return { ...w, exercises };
-        } catch {
-            return workout;
-        }
-    }, []);
-
-    const reindexSessionLogsAfterWorkoutEdit = useCallback((oldWorkout, newWorkout, logs) => {
-        try {
-            const safeLogs = logs && typeof logs === 'object' ? logs : {};
-            const oldExercises = Array.isArray(oldWorkout?.exercises) ? oldWorkout.exercises : [];
-            const newExercises = Array.isArray(newWorkout?.exercises) ? newWorkout.exercises : [];
-            const oldKeyByIndex = oldExercises.map((ex) => String(ex?._itx_exKey || ''));
-            const newIndexByKey = new Map();
-            newExercises.forEach((ex, idx) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k) return;
-                if (newIndexByKey.has(k)) return;
-                newIndexByKey.set(k, idx);
-            });
-
-            const result = {};
-
-            Object.entries(safeLogs).forEach(([k, v]) => {
-                const parts = String(k || '').split('-');
-                if (parts.length !== 2) {
-                    result[k] = v;
-                    return;
-                }
-                const oldIdx = Number(parts[0]);
-                const setIdx = Number(parts[1]);
-                if (!Number.isFinite(oldIdx) || !Number.isFinite(setIdx)) {
-                    result[k] = v;
-                    return;
-                }
-                const exKey = oldKeyByIndex[oldIdx] || '';
-                const newIdx = exKey ? newIndexByKey.get(exKey) : undefined;
-                if (typeof newIdx !== 'number' || newIdx < 0) return;
-                const ex = newExercises[newIdx] || null;
-                const headerSets = Number.parseInt(ex?.sets, 10) || 0;
-                const details = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-                const maxSets = headerSets || (Array.isArray(details) ? details.length : 0);
-                if (maxSets && setIdx >= maxSets) return;
-                result[`${newIdx}-${setIdx}`] = v;
-            });
-
-            return result;
-        } catch {
-            return logs && typeof logs === 'object' ? logs : {};
-        }
-    }, []);
-
-    const clearSupabaseCookiesBestEffort = useCallback(() => {
-        try {
-            if (typeof document === 'undefined') return;
-            const raw = String(document.cookie || '');
-            const cookieNames = raw
-                .split(';')
-                .map((p) => p.trim())
-                .map((p) => p.split('=')[0])
-                .filter(Boolean);
-            const targets = cookieNames.filter((n) => n.startsWith('sb-') || n.includes('supabase'));
-            targets.forEach((name) => {
-                try {
-                    document.cookie = `${name}=; Max-Age=0; path=/`;
-                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
-                } catch {}
-            });
-        } catch {}
-    }, []);
-
-    const clearSupabaseStorageBestEffort = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const ls = window.localStorage;
-            if (!ls) return;
-            const keys = [];
-            for (let i = 0; i < ls.length; i++) {
-                const k = ls.key(i);
-                if (!k) continue;
-                if (k.startsWith('sb-') || k.includes('supabase') || k.includes('auth-token')) keys.push(k);
-            }
-            keys.forEach((k) => {
-                try { ls.removeItem(k); } catch {}
-            });
-        } catch {}
-    }, []);
-
-		const clearClientSessionState = useCallback(() => {
-		try {
-			localStorage.removeItem('activeSession');
-			localStorage.removeItem('appView');
-			if (user?.id) {
-				localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-				localStorage.removeItem(`irontracks.appView.v2.${user.id}`);
-			}
-		} catch {}
-		setActiveSession(null);
-		setView('dashboard');
-	}, [user?.id]);
-
-    const safeSignOut = useCallback(async (scope = 'local') => {
-        if (signOutInFlightRef.current) return;
-        signOutInFlightRef.current = true;
-        try {
-            clearSupabaseCookiesBestEffort();
-            clearSupabaseStorageBestEffort();
-        } catch (e) {
-            try {
-                clearSupabaseCookiesBestEffort();
-                clearSupabaseStorageBestEffort();
-            } catch {}
-        } finally {
-            signOutInFlightRef.current = false;
-        }
-    }, [clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        const scopedKey = `irontracks.activeSession.v2.${userId}`;
-        let localSavedAt = 0;
-
-        try {
-            const raw = localStorage.getItem(scopedKey) || localStorage.getItem('activeSession');
-            if (raw) {
-                const parsed = JSON.parse(raw);
-                if (parsed && typeof parsed === 'object' && parsed?.startedAt && parsed?.workout) {
-                    localSavedAt = Number(parsed?._savedAt ?? 0) || 0;
-                    setActiveSession(parsed);
-                    setView('active');
-
-                    if (!localStorage.getItem(scopedKey)) {
-                        try {
-                            localStorage.setItem(scopedKey, JSON.stringify(parsed));
-                            localStorage.removeItem('activeSession');
-                        } catch {}
-                    }
-                }
-            }
-        } catch {
-            try {
-                localStorage.removeItem(scopedKey);
-                localStorage.removeItem('activeSession');
-            } catch {}
-        }
-
-        const loadServer = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('active_workout_sessions')
-                    .select('state, updated_at')
-                    .eq('user_id', userId)
-                    .maybeSingle();
-                if (cancelled) return;
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                    return;
-                }
-
-                const state = data?.state;
-                if (!state || typeof state !== 'object') return;
-                if (!state?.startedAt || !state?.workout) return;
-
-                const updatedAtMs = (() => {
-                    const fromCol = typeof data?.updated_at === 'string' ? Date.parse(data.updated_at) : NaN;
-                    const fromState = Number(state?._savedAt ?? 0) || 0;
-                    return Math.max(Number.isFinite(fromCol) ? fromCol : 0, fromState);
-                })();
-
-                if (updatedAtMs <= localSavedAt) return;
-
-                setActiveSession(state);
-                setView('active');
-                try {
-                    localStorage.setItem(scopedKey, JSON.stringify(state));
-                } catch {}
-            } catch {}
-        };
-
-        loadServer();
-
-        return () => {
-            cancelled = true;
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        let mounted = true;
-        let channel;
-
-        try {
-            channel = supabase
-                .channel(`active-workout-session:${userId}`)
-                .on(
-                    'postgres_changes',
-                    {
-                        event: '*',
-                        schema: 'public',
-                        table: 'active_workout_sessions',
-                        filter: `user_id=eq.${userId}`,
-                    },
-                    (payload) => {
-                        try {
-                            if (!mounted) return;
-						const ev = String(payload?.eventType || '').toUpperCase();
-						if (ev === 'DELETE') {
-							if (Date.now() < (suppressForeignFinishToastUntilRef.current || 0)) {
-								suppressForeignFinishToastUntilRef.current = 0;
-								return;
-							}
-							setActiveSession(null);
-							setView('dashboard');
-							try {
-								localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-							} catch {}
-                                try {
-                                    inAppNotify({
-                                        text: 'Treino finalizado em outro dispositivo.',
-                                        senderName: 'Aviso do Sistema',
-                                        displayName: 'Sistema',
-                                        photoURL: null,
-                                    });
-                                } catch {}
-                                return;
-                            }
-
-                            if (ev === 'UPDATE') {
-                                const state = payload?.new?.state;
-                                if (!state || typeof state !== 'object' || !state?.startedAt || !state?.workout) {
-                                    setActiveSession(null);
-                                    setView('dashboard');
-                                    try {
-                                        localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-                                    } catch {}
-                                }
-                            }
-                        } catch {}
-                    }
-                )
-                .subscribe();
-        } catch {}
-
-        return () => {
-            mounted = false;
-            try {
-                if (channel) supabase.removeChannel(channel);
-            } catch {
-                try {
-                    if (channel) createClient().removeChannel(channel);
-                } catch {}
-            }
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const handler = () => { try { unlockAudio(); } catch {} };
-        document.addEventListener('touchstart', handler, { once: true });
-        document.addEventListener('click', handler, { once: true });
-        return () => {
-            document.removeEventListener('touchstart', handler);
-            document.removeEventListener('click', handler);
-        };
-    }, [supabase, alert, clearClientSessionState]);
-
-    // Persistência da View (Aba Atual)
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const scopedViewKey = `irontracks.appView.v2.${user.id}`;
-            const scopedSessionKey = `irontracks.activeSession.v2.${user.id}`;
-            const savedSession = localStorage.getItem(scopedSessionKey);
-            if (savedSession) {
-                setView('active');
-                return;
-            }
-
-            const raw = localStorage.getItem(scopedViewKey) || localStorage.getItem('appView');
-            const savedView = raw ? String(raw) : '';
-            if (!savedView) {
-                setView('dashboard');
-                return;
-            }
-
-            if (savedView === 'active') {
-                setView('dashboard');
-                return;
-            }
-
-            setView(savedView);
-        } catch {
-            setView('dashboard');
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            if (!view) return;
-            localStorage.setItem(`irontracks.appView.v2.${user.id}`, view);
-        } catch {
-            return;
-        }
-    }, [view, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const key = `irontracks.activeSession.v2.${user.id}`;
-            if (!activeSession) {
-                localStorage.removeItem(key);
-                localStorage.removeItem('activeSession');
-                return;
-            }
-
-            const payload = JSON.stringify({ ...(activeSession || {}), _savedAt: Date.now() });
-            const id = setTimeout(() => {
-                try {
-                    localStorage.setItem(key, payload);
-                } catch {}
-            }, 250);
-            return () => clearTimeout(id);
-        } catch {
-            return;
-        }
-    }, [activeSession, user?.id]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        try {
-            if (serverSessionSyncRef.current?.timer) {
-                try {
-                    clearTimeout(serverSessionSyncRef.current.timer);
-                } catch {}
-            }
-        } catch {}
-
-        const key = (() => {
-            try {
-                return JSON.stringify(activeSession || null);
-            } catch {
-                return '';
-            }
-        })();
-
-        serverSessionSyncRef.current.lastKey = key;
-
-        const run = async () => {
-            try {
-                if (serverSessionSyncRef.current.lastKey !== key) return;
-
-                if (!activeSession) {
-                    const { error } = await supabase.from('active_workout_sessions').delete().eq('user_id', userId);
-                    if (error) {
-                        const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                        const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                        const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                        if (isMissing && !serverSessionSyncWarnedRef.current) {
-                            serverSessionSyncWarnedRef.current = true;
-                            try {
-                                inAppNotify({
-                                    text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                    senderName: 'Aviso do Sistema',
-                                    displayName: 'Sistema',
-                                    photoURL: null,
-                                });
-                            } catch {}
-                        }
-                    }
-                    return;
-                }
-
-                const startedAtRaw = activeSession?.startedAt;
-                const startedAtMs = typeof startedAtRaw === 'number' ? startedAtRaw : new Date(startedAtRaw || 0).getTime();
-                if (!Number.isFinite(startedAtMs) || startedAtMs <= 0) return;
-                if (!activeSession?.workout) return;
-
-                const state = { ...(activeSession || {}), _savedAt: Date.now() };
-
-                const { error } = await supabase
-                    .from('active_workout_sessions')
-                    .upsert(
-                        {
-                            user_id: userId,
-                            started_at: new Date(startedAtMs).toISOString(),
-                            state,
-                            updated_at: new Date().toISOString(),
-                        },
-                        { onConflict: 'user_id' }
-                    );
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                }
-            } catch {}
-        };
-
-        let timerId = null;
-
-        try {
-            timerId = setTimeout(() => {
-                try {
-                    run();
-                } catch {}
-            }, 900);
-            serverSessionSyncRef.current.timer = timerId;
-        } catch {}
-
-        return () => {
-            try {
-                if (timerId) clearTimeout(timerId);
-            } catch {}
-        };
-    }, [activeSession, supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        if (!activeSession) return;
-        const id = setInterval(() => setSessionTicker(Date.now()), 1000);
-        return () => clearInterval(id);
-    }, [activeSession, view]);
-
-    useEffect(() => {
-        let cancelled = false;
-        if (!user?.id) {
-            setHasUnreadNotification(false);
-            return;
-        }
-
-        const loadInitial = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('notifications')
-                    .select('id')
-                    .eq('user_id', user.id)
-                    .limit(1);
-                if (cancelled) return;
-                if (error) {
-                    console.error('Erro ao carregar notificações:', error);
-                    setHasUnreadNotification(false);
-                    return;
-                }
-                setHasUnreadNotification(Array.isArray(data) && data.length > 0);
-            } catch (e) {
-                if (cancelled) return;
-                console.error('Erro ao carregar notificações:', e);
-                setHasUnreadNotification(false);
-            }
-        };
-
-        loadInitial();
-
-        const channel = supabase
-            .channel(`notifications:badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) setHasUnreadNotification(true);
-            })
-            .on('postgres_changes', {
-                event: 'DELETE',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) loadInitial();
-            })
-            .subscribe();
-
-        return () => {
-            cancelled = true;
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-        const allowNotifyDm = s ? s.notifyDirectMessages !== false : true
-
-        const channel = supabase
-            .channel(`direct-messages-badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'direct_messages'
-            }, async (payload) => {
-                try {
-                    if (!allowNotifyDm) return;
-                    const msg = payload.new;
-                    if (!msg || msg.sender_id === user.id) return;
-
-                    const currentView = view;
-                    if (currentView === 'chat' || currentView === 'chatList' || currentView === 'directChat' || currentView === 'globalChat') {
-                        return;
-                    }
-
-                    const { data: senderProfile } = await supabase
-                        .from('profiles')
-                        .select('display_name')
-                        .eq('id', msg.sender_id)
-                        .maybeSingle();
-
-                    const senderName = senderProfile?.display_name || 'Nova mensagem';
-                    const preview = String(msg.content || '').slice(0, 120);
-                    if (!preview) return;
-
-                    await fetch('/api/notifications/direct-message', {
-                        method: 'POST',
-                        headers: { 'Content-Type': 'application/json' },
-                        body: JSON.stringify({
-                            receiverId: user.id,
-                            senderName,
-                            preview,
-                        }),
-                    });
-                } catch (e) {
-                    console.error('Erro ao gerar notificação de mensagem direta:', e);
-                }
-            })
-            .subscribe();
-
-        return () => {
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id, userSettingsApi?.settings, view]);
-
-    useEffect(() => {
-        const baseUser = initialUser && typeof initialUser === 'object' ? initialUser : null
-        if (!baseUser?.id) {
-            try {
-                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-            } catch {}
-            return
-        }
-        const meta = baseUser?.user_metadata || {}
-        const emailRaw = String(baseUser?.email || '').trim()
-        const emailUser = emailRaw.includes('@') ? emailRaw.split('@')[0] : (emailRaw || 'Usuário')
-        const profileDisplayName = String(initialProfile?.display_name || initialProfile?.displayName || '').trim()
-        const profilePhotoURL = String(initialProfile?.photo_url || initialProfile?.photoURL || initialProfile?.photoUrl || '').trim()
-        const metaDisplayName = String(meta?.full_name || meta?.name || '').trim()
-        const displayName = profileDisplayName || metaDisplayName || emailUser
-        const photoURL = profilePhotoURL || meta?.avatar_url || meta?.picture || null
-        const nextUser = { ...baseUser, displayName, photoURL, role: initialProfile?.role || 'user' }
-        setUser(nextUser)
-        const role = String(initialProfile?.role || '').toLowerCase()
-        setIsCoach(role === 'teacher' || role === 'admin')
-    }, [initialUser, initialProfile])
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const res = await fetch('/api/vip/access', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                const json = await res.json().catch(() => null)
-                if (cancelled) return
-                if (json && json.ok) {
-                    setVipAccess({ loaded: true, hasVip: !!json.hasVip })
-                    return
-                }
-                setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            } catch {
-                if (!cancelled) setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            }
-        })()
-        return () => { cancelled = true }
-    }, [user?.id])
-
-    useEffect(() => {
-        try {
-            const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {
-                try {
-                    const ev = String(_event || '').toUpperCase()
-                    if (session && session.user?.id) return
-                    if (ev === 'SIGNED_OUT') {
-                        clearClientSessionState()
-                        if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                        return
-                    }
-                    if (ev === 'INITIAL_SESSION') {
-                        fetch('/api/auth/ping', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                            .then((r) => {
-                                if (r && r.status === 204) return
-                                clearClientSessionState()
-                                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                            })
-                            .catch(() => {})
-                        return
-                    }
-                } catch {}
-            })
-            return () => {
-                try { sub?.subscription?.unsubscribe?.() } catch {}
-            }
-        } catch {
-            return
-        }
-    }, [supabase, clearClientSessionState, clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort])
-
-    useEffect(() => {
-        restoreAdminPanelIfNeeded();
-        const onVisibility = () => {
-            if (typeof document === 'undefined') return;
-            if (document.visibilityState === 'visible') restoreAdminPanelIfNeeded();
-        };
-        const onPageShow = () => restoreAdminPanelIfNeeded();
-        try {
-            document.addEventListener('visibilitychange', onVisibility);
-            window.addEventListener('pageshow', onPageShow);
-        } catch {}
-        return () => {
-            try {
-                document.removeEventListener('visibilitychange', onVisibility);
-                window.removeEventListener('pageshow', onPageShow);
-            } catch {}
-        };
-    }, [restoreAdminPanelIfNeeded]);
-
-    // Sync Profile Separately (Optimized)
-    useEffect(() => {
-        if (user?.id) {
-             const syncProfile = async () => {
-                 try {
-                    return
-                 } catch (e) {
-                    console.error('Erro ao sincronizar perfil:', e);
-                 }
-             };
-             syncProfile();
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const run = async () => {
-            if (!user?.id) {
-                if (!cancelled) {
-                    setProfileIncomplete(false);
-                    setProfileDraftName('');
-                }
-                return;
-            }
-
-            try {
-                const seedName = String(initialProfile?.display_name || '').trim() || String(user?.displayName || '').trim();
-                if (!cancelled) {
-                    setProfileIncomplete(!seedName);
-                    setProfileDraftName(seedName);
-                }
-            } catch {
-                if (!cancelled) {
-                    setProfileIncomplete(true);
-                    setProfileDraftName(String(user?.displayName || '').trim());
-                }
-            }
-        };
-
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [initialProfile?.display_name, user?.id, user?.displayName]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        let cancelled = false;
-        const run = async () => {
-            try {
-                const res = await fetch('/api/dashboard/bootstrap', { cache: 'no-store', credentials: 'include' });
-                const json = await res.json().catch(() => null);
-                if (cancelled) return;
-                if (!json?.ok) return;
-
-                const prof = json?.profile && typeof json.profile === 'object' ? json.profile : null;
-                const displayName = String(prof?.display_name || '').trim();
-                const photoURL = String(prof?.photo_url || '').trim();
-                const role = String(prof?.role || '').toLowerCase();
-
-                setUser((prev) => {
-                    const current = prev && typeof prev === 'object' ? prev : null;
-                    if (!current) return prev;
-                    const patch = {};
-                    if (displayName && displayName !== current.displayName) patch.displayName = displayName;
-                    if (photoURL && photoURL !== current.photoURL) patch.photoURL = photoURL;
-                    if (role && role !== String(current.role || '').toLowerCase()) patch.role = role;
-                    return Object.keys(patch).length ? { ...current, ...patch } : prev;
-                });
-                if (role) setIsCoach(role === 'teacher' || role === 'admin');
-
-                if (Array.isArray(json.workouts) && json.workouts.length) {
-                    const mapped = json.workouts
-                        .map((row) => mapWorkoutRow(row))
-                        .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-                    setWorkouts(mapped);
-                    const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-                    setStats({ workouts: mapped.length, exercises: totalEx, activeStreak: 0 });
-                }
-            } catch {}
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [user?.id]);
-
-	// Fetch Workouts
-	const fetchWorkouts = useCallback(async (specificUser = user) => {
-        if (isFetching.current) return;
-        isFetching.current = true;
-        
-		try {
-			const currentUser = specificUser;
-
-            if (!currentUser?.id) {
-                console.warn("DASHBOARD: Usuário não identificado ao buscar treinos.");
-                return;
-            }
-
-            if (typeof navigator !== 'undefined' && navigator.onLine === false) {
-                try {
-                    const cached = await cacheGetWorkouts({ userId: currentUser.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-                return
-            }
-
-            const role = String(currentUser?.role || 'user') || 'user';
-
-            let data = []
-            let studentData = []
-            let studentsList = []
-
-            const hydrateWorkouts = async (rows) => {
-                const base = Array.isArray(rows) ? rows.filter((x) => x && typeof x === 'object') : [];
-                const workoutIds = base.map((w) => w.id).filter(Boolean);
-                if (workoutIds.length === 0) return base.map((w) => ({ ...w, exercises: [] }));
-
-                let exercises = [];
-                try {
-                    const { data: exRows } = await supabase
-                        .from('exercises')
-                        .select('*')
-                        .in('workout_id', workoutIds)
-                        .order('order', { ascending: true })
-                        .limit(5000);
-                    exercises = Array.isArray(exRows) ? exRows : [];
-                } catch {
-                    exercises = [];
-                }
-
-                const exIds = exercises.map((e) => e.id).filter(Boolean);
-                let sets = [];
-                if (exIds.length > 0) {
-                    try {
-                        const { data: setRows } = await supabase
-                            .from('sets')
-                            .select('*')
-                            .in('exercise_id', exIds)
-                            .order('set_number', { ascending: true })
-                            .limit(20000);
-                        sets = Array.isArray(setRows) ? setRows : [];
-                    } catch {
-                        sets = [];
-                    }
-                }
-
-                const setsByExercise = new Map();
-                for (const s of sets) {
-                    const eid = s?.exercise_id;
-                    if (!eid) continue;
-                    const list = setsByExercise.get(eid) || [];
-                    list.push(s);
-                    setsByExercise.set(eid, list);
-                }
-
-                const exByWorkout = new Map();
-                for (const ex of exercises) {
-                    const wid = ex?.workout_id;
-                    if (!wid) continue;
-                    const exWithSets = { ...ex, sets: setsByExercise.get(ex.id) || [] };
-                    const list = exByWorkout.get(wid) || [];
-                    list.push(exWithSets);
-                    exByWorkout.set(wid, list);
-                }
-
-                return base.map((w) => ({ ...w, exercises: exByWorkout.get(w.id) || [] }));
-            };
-
-            if (role === 'admin' || role === 'teacher') {
-                // 1. Fetch Students
-                try {
-                    const { data: st } = await supabase
-                        .from('students')
-                        .select('id, name, email, user_id')
-                        .or(`teacher_id.eq.${currentUser.id},user_id.eq.${currentUser.id}`)
-                        .order('name');
-                    studentsList = st || [];
-                } catch (e) { console.error('Erro fetching students', e); }
-
-                // 2. Fetch My Workouts
-                const { data: myBase, error: myErr } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (myErr) throw myErr
-                data = await hydrateWorkouts(myBase || [])
-
-                // 3. Fetch Student Workouts
-                const ids = studentsList.map(s => s.user_id || s.id).filter(Boolean)
-                if (ids.length > 0) {
-                    const seen = new Set()
-                    const combined = []
-                    try {
-                        const { data: swByUserBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('user_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByUser = await hydrateWorkouts(swByUserBase || [])
-                        for (const w of (swByUser || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    try {
-                        const { data: swByStudentBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('student_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByStudent = await hydrateWorkouts(swByStudentBase || [])
-                        for (const w of (swByStudent || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    studentData = combined
-                }
-            } else {
-                const { data: baseRows, error } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (error) throw error
-                data = await hydrateWorkouts(baseRows || [])
-
-                if (!data.length) {
-                    try {
-                        const { data: anyRows, error: anyErr } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('user_id', currentUser.id)
-                            .order('name', { ascending: true })
-                            .limit(500);
-                        if (!anyErr && Array.isArray(anyRows) && anyRows.length) {
-                            data = await hydrateWorkouts(anyRows);
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const { data: studentRow } = await supabase
-                            .from('students')
-                            .select('id')
-                            .eq('user_id', currentUser.id)
-                            .maybeSingle();
-                        const studentId = studentRow?.id ? String(studentRow.id) : '';
-                        if (studentId) {
-                            const { data: legacyBase } = await supabase
-                                .from('workouts')
-                                .select('*')
-                                .eq('is_template', true)
-                                .or(`user_id.eq.${studentId},student_id.eq.${studentId}`)
-                                .order('name', { ascending: true })
-                                .limit(500);
-                            const legacyHydrated = await hydrateWorkouts(legacyBase || []);
-                            const seen = new Set();
-                            const merged = [];
-                            for (const w of legacyHydrated) {
-                                if (!w?.id) continue;
-                                if (seen.has(w.id)) continue;
-                                seen.add(w.id);
-                                merged.push(w);
-                            }
-                            data = merged;
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const resLegacy = await fetch('/api/workouts/list', { cache: 'no-store' });
-                        const jsonLegacy = await resLegacy.json().catch(() => null);
-                        if (jsonLegacy?.ok && Array.isArray(jsonLegacy.rows) && jsonLegacy.rows.length) {
-                            data = (jsonLegacy.rows || []).map((w) => ({
-                                id: w?.id,
-                                name: w?.name,
-                                notes: null,
-                                is_template: true,
-                                user_id: currentUser.id,
-                                created_by: null,
-                                exercises: [],
-                            }));
-                        }
-                    } catch {}
-                }
-            }
-
-			if (Array.isArray(data)) {
-				const mappedRaw = data
-					.map((row) => mapWorkoutRow(row))
-					.filter(Boolean);
-                const mapped = mappedRaw.sort((a, b) => {
-                    const ao = Number.isFinite(Number(a?.sort_order)) ? Number(a.sort_order) : 0
-                    const bo = Number.isFinite(Number(b?.sort_order)) ? Number(b.sort_order) : 0
-                    if (ao !== bo) return ao - bo
-                    return (a.title || '').localeCompare(b.title || '')
-                });
-
-                try {
-                    await cacheSetWorkouts({ userId: currentUser?.id, workouts: mapped })
-                } catch {}
-
-                if (role === 'admin' || role === 'teacher') {
-                    setWorkouts(mapped)
-                    try {
-                        const studentMapped = (studentData || []).map(mapWorkoutRow)
-                        const byStudent = new Map()
-                        for (const w of studentMapped) {
-                            const sid = w.user_id
-                            if (!sid) continue
-                            const list = byStudent.get(sid) || []
-                            list.push(w)
-                            byStudent.set(sid, list)
-                        }
-                        const nameById = new Map()
-                        for (const s of (studentsList || [])) {
-                            const sid = s.user_id || s.id
-                            if (!sid) continue
-                            nameById.set(sid, { name: s.name || String(sid).slice(0,8), email: s.email || '' })
-                        }
-                        const folders = Array.from(byStudent.entries()).map(([sid, list]) => {
-                            const info = nameById.get(sid) || { name: String(sid).slice(0,8), email: '' }
-                            return { id: sid, name: info.name, email: info.email, workouts: list }
-                        }).filter(f => (f.workouts || []).length > 0)
-                        setStudentFolders(folders)
-                    } catch (err) {
-                        console.error("Erro ao processar alunos:", err);
-                        setStudentFolders([])
-                    }
-                } else {
-                    setWorkouts(mapped)
-                    try {
-                        const shared = mapped.filter(w => (w.created_by && w.created_by !== currentUser.id))
-                        const byCoach = new Map()
-                        for (const w of shared) {
-                            const cid = w.created_by
-                            const list = byCoach.get(cid) || []
-                            list.push(w)
-                            byCoach.set(cid, list)
-                        }
-                        const coachIds = Array.from(byCoach.keys())
-                        let profiles = []
-                        if (coachIds.length) {
-                            const { data: profs } = await supabase.from('profiles').select('id, display_name').in('id', coachIds)
-                            profiles = profs || []
-                        }
-                        const nameByCoach = new Map(profiles.map(p => [p.id, p.display_name || String(p.id).slice(0,8)]))
-                        const folders = Array.from(byCoach.entries()).map(([cid, list]) => ({
-                            id: cid,
-                            name: `Treinos compartilhados de ${nameByCoach.get(cid) || String(cid).slice(0,8)}`,
-                            email: '',
-                            workouts: list
-                        }))
-                        setStudentFolders(folders)
-                    } catch {
-                        setStudentFolders([])
-                    }
-                }
-                
-				// Atualiza estatísticas
-				const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-				setStats({ 
-					workouts: mapped.length, 
-					exercises: totalEx, 
-					activeStreak: 0 // Placeholder
-				});
-            } else {
-                console.warn('Fetch sem dados; mantendo estado atual');
-            }
-		} catch (e) {
-			const msg = e?.message ?? String(e);
-			if (msg.includes('Failed to fetch') || msg.includes('ERR_ABORTED')) {
-				// Dev HMR aborts or transient network; ignore quietly
-                try {
-                    const cached = await cacheGetWorkouts({ userId: specificUser?.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-				return;
-			}
-			console.error("Erro ao buscar:", { message: msg, error: e });
-		} finally { isFetching.current = false; }
-	}, [supabase, user]); // Depende apenas do usuário para evitar loops de busca
-
-    useEffect(() => {
-        if (user) {
-            fetchWorkouts(user);
-        }
-    }, [user, fetchWorkouts]);
-
-    useEffect(() => {
-        if (user && workouts.length === 0) {
-            try {
-                const k = 'workouts_cache_' + user.id;
-                const cached = localStorage.getItem(k);
-                if (cached) {
-                    const arr = JSON.parse(cached);
-                    if (Array.isArray(arr) && arr.length > 0) setWorkouts(arr);
-                }
-            } catch {}
-        }
-    }, [user, workouts.length]);
-
-    const refreshStreakStats = useCallback(async ({ force = false } = {}) => {
-        try {
-            if (!user?.id) return;
-            const now = Date.now();
-            const lastAt = Number(streakRefreshRef.current?.lastAt || 0);
-            if (!force && now - lastAt < 8000) return;
-            if (streakRefreshRef.current?.inFlight) return;
-            streakRefreshRef.current = { inFlight: true, lastAt: now };
-            const res = await computeWorkoutStreakAndStats();
-            if (res?.ok && res?.data) setStreakStats(res.data);
-        } catch (e) {
-            console.error('Erro ao calcular streak:', e);
-        } finally {
-            try {
-                streakRefreshRef.current = { ...(streakRefreshRef.current || {}), inFlight: false };
-            } catch {}
-        }
-    }, [user?.id]);
-
-    useEffect(() => {
-        refreshStreakStats({ force: true });
-    }, [refreshStreakStats]);
-
-
-
-    // Handlers de Sessão
-    const handleLogout = async () => {
-        const ok = await confirm("Deseja realmente sair da sua conta?", "Sair");
-        if (!ok) return;
-        try { clearClientSessionState(); } catch {}
-        try { window.location.href = '/auth/logout'; } catch {}
-    };
-
-    const handleSaveProfile = async () => {
-        if (!user?.id) return;
-        const nextName = String(profileDraftName || '').trim();
-        if (!nextName) {
-            await alert('Informe seu nome para completar o perfil.', 'Perfil incompleto');
-            return;
-        }
-
-        setSavingProfile(true);
-        try {
-            const { data, error } = await supabase
-                .from('profiles')
-                .update({
-                    display_name: nextName,
-                    photo_url: user.photoURL ?? null,
-                    last_seen: new Date().toISOString(),
-                })
-                .eq('id', user.id)
-                .select('id')
-                .maybeSingle();
-            if (error) throw error;
-            if (!data?.id) {
-                await alert('Não foi possível salvar seu perfil (registro não encontrado).', 'Perfil');
-                return;
-            }
-            setProfileIncomplete(false);
-            setShowCompleteProfile(false);
-        } catch (e) {
-            await alert('Erro ao salvar perfil: ' + (e?.message || String(e || '')));
-        } finally {
-            setSavingProfile(false);
-        }
-    };
-
-    const handleStartSession = async (workout) => {
-        const exercisesList = Array.isArray(workout?.exercises)
-            ? workout.exercises.filter(ex => ex && typeof ex === 'object')
-            : [];
-
-        if (exercisesList.length === 0) {
-            await alert('Este treino está sem exercícios válidos. Edite o treino antes de iniciar.', 'Treino incompleto');
-            return;
-        }
-
-        const first = exercisesList[0] || {};
-        const exMin = toMinutesRounded(estimateExerciseSeconds(first));
-        const totalMin = toMinutesRounded(exercisesList.reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0));
-        const workoutTitle = String(workout?.title || workout?.name || 'Treino');
-        const ok = await confirm(`Iniciar "${workoutTitle}"? Primeiro exercício: ~${exMin} min. Estimado total: ~${totalMin} min.`, 'Iniciar Treino');
-        if (!ok) return;
-        let preCheckin = null
-        try {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const prompt = s ? s.promptPreWorkoutCheckin !== false : true
-            if (prompt) {
-                preCheckin = await requestPreWorkoutCheckin(workout)
-                if (preCheckin && user?.id) {
-                    const energyN = Number(preCheckin.energy)
-                    const sorenessN = Number(preCheckin.soreness)
-                    const timeN = Number(preCheckin.timeMinutes)
-                    const { error: checkinError } = await supabase.from('workout_checkins').insert({
-                        user_id: user.id,
-                        kind: 'pre',
-                        planned_workout_id: String(workout?.id || '').trim() ? workout.id : null,
-                        active_session_user_id: null,
-                        energy: Number.isFinite(energyN) && energyN >= 1 && energyN <= 5 ? Math.round(energyN) : null,
-                        soreness: Number.isFinite(sorenessN) && sorenessN >= 0 && sorenessN <= 10 ? Math.round(sorenessN) : null,
-                        notes: String(preCheckin.notes || '').trim() ? String(preCheckin.notes || '').trim() : null,
-                        answers: {
-                            time_minutes: Number.isFinite(timeN) && timeN > 0 ? Math.round(timeN) : null,
-                        },
-                    })
-                    if (checkinError) throw checkinError
-                }
-            }
-        } catch (e) {
-            console.warn('Falha ao salvar check-in pré-treino:', e?.message || String(e || ''))
-        }
-        let resolvedExercises = exercisesList;
-        try {
-            const resolved = await resolveExerciseVideos(exercisesList);
-            resolvedExercises = Array.isArray(resolved?.exercises) ? resolved.exercises : exercisesList;
-            persistExerciseVideoUrls(resolved?.updates || []);
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const enabled = s ? s.enableSounds !== false : true
-            const volumeRaw = Number(s?.soundVolume ?? 100)
-            const volume = Number.isFinite(volumeRaw) ? Math.max(0, Math.min(1, volumeRaw / 100)) : 1
-            playStartSound({ enabled, volume })
-        }
-        setActiveSession({
-            workout: { ...workout, exercises: resolvedExercises },
-            logs: {},
-            ui: {
-                baseExerciseCount: resolvedExercises.length,
-                pendingTemplateUpdate: false,
-                preCheckin: preCheckin && typeof preCheckin === 'object' ? preCheckin : null,
-            },
-            startedAt: Date.now(),
-            timerTargetTime: null,
-            timerContext: null
-        });
-        setView('active');
-        try {
-            const wid = String(workout?.id || '').trim() || null;
-            const title = String(workout?.title || workout?.name || 'Treino').trim();
-            fetch('/api/social/workout-start', {
-                method: 'POST',
-                headers: { 'content-type': 'application/json' },
-                body: JSON.stringify({ workout_id: wid, workout_title: title }),
-            }).catch(() => {});
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const allowPrompt = s ? s.notificationPermissionPrompt !== false : true
-            if (allowPrompt && typeof Notification !== 'undefined' && Notification.permission === 'default') {
-            Notification.requestPermission().catch(e => console.warn('Erro permissão notificação:', e));
-            }
-        }
-    };
-
-    const handleUpdateSessionLog = (key, data) => {
-        if (!activeSession) return;
-        setActiveSession(prev => {
-            if (!prev) return null;
-            return {
-                ...prev,
-                logs: { ...(prev.logs || {}), [key]: data }
-            };
-        });
-    };
-
-    const handleStartTimer = (duration, context) => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return {
-                ...prev,
-                timerTargetTime: Date.now() + (duration * 1000),
-                timerContext: context && typeof context === 'object' ? context : null
-            };
-        });
-    };
-
-    const handleCloseTimer = () => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return { ...prev, timerTargetTime: null, timerContext: null };
-        });
-    };
-
-	const handleFinishSession = async (sessionData, showReport) => {
-		suppressForeignFinishToastUntilRef.current = Date.now() + 8000;
-        try {
-            if (user?.id) {
-                localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-            }
-            localStorage.removeItem('activeSession');
-        } catch {}
-		setActiveSession(null);
-        try {
-            if (user) await fetchWorkouts(user);
-        } catch {}
-        try {
-            await refreshStreakStats({ force: true });
-        } catch {}
-        try {
-            setNewRecordsReloadKey((v) => v + 1);
-        } catch {}
-		if (showReport === false) {
-			setView('dashboard');
-			return;
-		}
-        setReportBackView('dashboard');
-        setReportData({ current: sessionData, previous: null });
-        setView('report');
-    };
-
-    // Handlers CRUD
-    const openManualWorkoutEditor = () => {
-        setCurrentWorkout({ title: '', exercises: [] })
-        setView('edit')
-    }
-	const handleCreateWorkout = () => { setCreateWizardOpen(true) };
-
-	const handleEditWorkout = async (workout) => {
-		if (!workout || !workout.id) return;
-		try {
-			const supabase = createClient();
-			const { data, error } = await supabase
-				.from('workouts')
-				.select('*, exercises(*, sets(*))')
-				.eq('id', workout.id)
-				.maybeSingle();
-			if (error) throw error;
-			if (!data) {
-				setCurrentWorkout(workout);
-				setView('edit');
-				return;
-			}
-			const mapped = mapWorkoutRow(data);
-            try {
-                const resolved = await resolveExerciseVideos(mapped?.exercises || []);
-                const exercises = Array.isArray(resolved?.exercises) ? resolved.exercises : (mapped?.exercises || []);
-                persistExerciseVideoUrls(resolved?.updates || []);
-                setCurrentWorkout({ ...mapped, exercises });
-            } catch {
-                setCurrentWorkout(mapped);
-            }
-			setView('edit');
-		} catch (e) {
-			const msg = e?.message || String(e || '');
-			await alert('Erro ao carregar treino para edição: ' + msg);
-		}
-	};
-
-    const handleSaveWorkout = useCallback(async (workoutToSave) => {
-        const w = workoutToSave || currentWorkout;
-        if (!user || !w || !w.title) return { ok: false, error: 'Treino inválido ou usuário ausente' };
-        try {
-            if (w.id) {
-                const res = await updateWorkout(w.id, w);
-                setCurrentWorkout(w);
-                return res;
-            } else {
-                const created = await createWorkout(w);
-                const id = created?.id ?? null;
-                setCurrentWorkout({ ...w, id });
-                return created;
-            }
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e || 'Falha ao salvar treino');
-            return { ok: false, error: msg };
-        }
-    }, [currentWorkout, user]);
-
-    const handlePersistWorkoutTemplateFromSession = useCallback(async (workoutFromSession) => {
-        try {
-            const normalized = normalizeWorkoutForEditor(workoutFromSession);
-            const cleaned = stripWorkoutInternalKeys(normalized);
-            if (!cleaned || !cleaned.title) return { ok: false, error: 'Treino inválido para salvar' };
-
-            if (cleaned.id) {
-                await updateWorkout(cleaned.id, cleaned);
-                try {
-                    await fetchWorkouts();
-                } catch {}
-                return { ok: true, mode: 'update' };
-            }
-
-            const created = await createWorkout(cleaned);
-            try {
-                await fetchWorkouts();
-            } catch {}
-            return { ok: true, mode: 'create', id: created?.id ?? null };
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e);
-            return { ok: false, error: msg || 'Falha ao salvar treino' };
-        }
-    }, [fetchWorkouts, normalizeWorkoutForEditor, stripWorkoutInternalKeys]);
-
-    const handleOpenActiveWorkoutEditor = useCallback((options = {}) => {
-        try {
-            if (!activeSession?.workout) return;
-            const base = normalizeWorkoutForEditor(activeSession.workout);
-            const shouldAddExercise = options && typeof options === 'object' ? !!options.addExercise : false;
-            editActiveAddExerciseRef.current = shouldAddExercise;
-            const nextBase = shouldAddExercise
-                ? {
-                    ...base,
-                    exercises: [
-                        ...(Array.isArray(base?.exercises) ? base.exercises : []),
-                        {
-                            name: '',
-                            sets: 4,
-                            reps: '10',
-                            rpe: '8',
-                            cadence: '2020',
-                            restTime: 60,
-                            method: 'Normal',
-                            videoUrl: '',
-                            notes: ''
-                        }
-                    ]
-                }
-                : base;
-            editActiveBaseRef.current = base;
-            setEditActiveDraft(nextBase);
-            setEditActiveOpen(true);
-        } catch {}
-    }, [activeSession?.workout, normalizeWorkoutForEditor]);
-
-    const handleCloseActiveWorkoutEditor = useCallback(() => {
-        try {
-            setEditActiveOpen(false);
-            setEditActiveDraft(null);
-            editActiveBaseRef.current = null;
-            editActiveAddExerciseRef.current = false;
-        } catch {}
-    }, []);
-
-    const handleSaveActiveWorkoutEditor = useCallback(async (workoutFromEditor) => {
-        const normalized = normalizeWorkoutForEditor(workoutFromEditor);
-        const cleaned = stripWorkoutInternalKeys(normalized);
-        const shouldDeferPersist = !!editActiveAddExerciseRef.current;
-        const res = shouldDeferPersist ? { deferred: true } : await handleSaveWorkout(cleaned);
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            const oldWorkout = editActiveBaseRef.current || normalizeWorkoutForEditor(prev.workout);
-            const nextLogs = reindexSessionLogsAfterWorkoutEdit(oldWorkout, normalized, prev.logs || {});
-            const baseUi = prev?.ui && typeof prev.ui === 'object' ? prev.ui : {};
-            const nextUi = shouldDeferPersist ? { ...baseUi, pendingTemplateUpdate: true } : baseUi;
-            return { ...prev, workout: normalized, logs: nextLogs, ui: nextUi };
-        });
-        editActiveBaseRef.current = normalized;
-        setEditActiveDraft(normalized);
-        return res;
-    }, [handleSaveWorkout, normalizeWorkoutForEditor, reindexSessionLogsAfterWorkoutEdit, stripWorkoutInternalKeys]);
-
-	const handleDeleteWorkout = async (id, title) => {
-		const name = title || (workouts.find(w => w.id === id)?.title) || 'este treino';
-		if (!(await confirm(`Apagar o treino "${name}"?`, "Excluir Treino"))) return;
-		try {
-			const res = await deleteWorkout(id);
-			if (!res?.success) {
-				await alert("Erro: " + (res?.error || 'Falha ao excluir treino'));
-				return;
-			}
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro: " + (e?.message ?? String(e))); }
-	};
-
-    const handleRestoreWorkout = async (workout) => {
-        const id = String(workout?.id || '').trim()
-        if (!id) return
-        const name = workout?.title || 'este treino'
-        if (!(await confirm(`Restaurar o treino "${name}"?`, 'Restaurar Treino'))) return
-        try {
-            const res = await setWorkoutArchived(id, false)
-            if (!res?.ok) {
-                await alert('Erro: ' + (res?.error || 'Falha ao restaurar treino'))
-                return
-            }
-            await fetchWorkouts()
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)))
-        }
-    }
-
-	const handleDuplicateWorkout = async (workout) => {
-		if (!(await confirm(`Duplicar "${workout.title}"?`, "Duplicar Treino"))) return;
-		const newWorkout = { ...workout, title: `${workout.title} (Cópia)` };
-		delete newWorkout.id;
-		try {
-			await createWorkout(newWorkout);
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro ao duplicar: " + (e?.message ?? String(e))); }
-	};
-
-    const handleBulkEditWorkouts = async (items) => {
-        try {
-            const arr = Array.isArray(items) ? items : []
-            if (!arr.length) return
-            let updatedTitles = 0
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const w = workouts.find((x) => String(x?.id || '') === id)
-                if (!w) continue
-
-                const desiredTitle = String(it?.title || '').trim() || String(w?.title || 'Treino')
-                if (desiredTitle !== String(w?.title || '')) {
-                    const r = await updateWorkout(id, { title: desiredTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                    if (!r?.ok) throw new Error(String(r?.error || 'Falha ao renomear treino'))
-                    updatedTitles += 1
-                }
-            }
-
-            let sortSaved = true
-            let sortError = ''
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const r2 = await setWorkoutSortOrder(id, i)
-                if (!r2?.ok) {
-                    sortSaved = false
-                    sortError = String(r2?.error || 'Falha ao ordenar treinos')
-                    break
-                }
-            }
-
-            await fetchWorkouts()
-
-            if (!sortSaved) {
-                const suffix = sortError ? `\n\n${sortError}` : ''
-                await alert(`Lista salva parcialmente: a ordenação não foi aplicada.${suffix}`)
-                return
-            }
-
-            if (updatedTitles) {
-                await alert(`Lista salva: ${updatedTitles} título(s) atualizado(s).`)
-            } else {
-                await alert('Lista salva.')
-            }
-        } catch (e) {
-            await alert('Erro ao salvar lista: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeAiWorkoutTitles = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const title = String(w?.title || '').trim()
-                    const m = title.match(/\(\s*dia\s*(\d+)\s*\)/i)
-                    if (!m?.[1]) return null
-                    const day = Number(m[1])
-                    if (!Number.isFinite(day) || day <= 0) return null
-                    return { workout: w, dayIndex: Math.floor(day - 1) }
-                })
-                .filter(Boolean)
-            if (!candidates.length) {
-                await alert('Nenhum treino no formato antigo “(Dia X)” foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar nomes de ${candidates.length} treinos gerados automaticamente?`, 'Padronizar nomes'))) return
-
-            let changed = 0
-            for (const item of candidates) {
-                const w = item.workout
-                const idx = item.dayIndex
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle, idx, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, { title: nextTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                changed += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${changed} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar nomes: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleApplyTitleRule = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            if (!list.length) {
-                await alert('Nenhum treino encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar títulos de ${list.length} treinos com A/B/C... e dia da semana?`, 'Padronizar títulos'))) return
-            let updated = 0
-            for (let i = 0; i < list.length; i += 1) {
-                const w = list[i]
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle || 'Treino', i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, {
-                    title: nextTitle,
-                    notes: w?.notes ?? '',
-                    exercises: Array.isArray(w?.exercises) ? w.exercises : [],
-                })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                updated += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${updated} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar títulos: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeExercises = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-                    let changesCount = 0
-                    const nextExercises = exercises.map((ex) => {
-                        const name = String(ex?.name || '').trim()
-                        if (!name) return ex
-                        const info = resolveCanonicalExerciseName(name)
-                        if (!info?.changed || !info?.canonical) return ex
-                        changesCount += 1
-                        return { ...ex, name: info.canonical }
-                    })
-                    if (!changesCount) return null
-                    return { workout: w, nextExercises, changesCount }
-                })
-                .filter(Boolean)
-
-            if (!candidates.length) {
-                await alert('Nenhum exercício para normalizar foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Normalizar exercícios em ${candidates.length} treinos?`, 'Normalizar exercícios'))) return
-
-            let updated = 0
-            const updatedWorkouts = []
-            for (const item of candidates) {
-                const w = item.workout
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const title = String(w?.title || '').trim() || `Treino ${id.slice(0, 8)}`
-                const notes = w?.notes ?? ''
-                const res = await updateWorkout(id, { title, notes, exercises: item.nextExercises })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao atualizar treino'))
-                updated += 1
-                updatedWorkouts.push({ title, changesCount: Number(item?.changesCount || 0) })
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            const lines = updatedWorkouts
-                .slice(0, 10)
-                .map((it) => `• ${it.title}${it.changesCount ? ` (${it.changesCount} exercício(s))` : ''}`)
-                .join('\n')
-            const more = updatedWorkouts.length > 10 ? `\n(+${updatedWorkouts.length - 10} outros)` : ''
-            const detail = lines ? `\n\nTreinos atualizados:\n${lines}${more}` : ''
-            await alert(`Normalização concluída: ${updated} treinos atualizados.${detail}`)
-        } catch (e) {
-            await alert('Erro ao normalizar exercícios: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleOpenDuplicates = async () => {
-        const list = (Array.isArray(workouts) ? workouts : []).filter((w) => !w?.archived_at)
-        const keys = list.map((w) => {
-            const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-            const set = new Set()
-            for (const ex of exercises) {
-                const name = String(ex?.name || '').trim()
-                if (!name) continue
-                const info = resolveCanonicalExerciseName(name)
-                const base = String(info?.canonical || name).trim()
-                const k = normalizeExerciseName(base)
-                if (k) set.add(k)
-            }
-            return set
-        })
-
-        const parent = Array.from({ length: list.length }).map((_, i) => i)
-        const find = (x) => {
-            let r = x
-            while (parent[r] !== r) r = parent[r]
-            let cur = x
-            while (parent[cur] !== cur) {
-                const p = parent[cur]
-                parent[cur] = r
-                cur = p
-            }
-            return r
-        }
-        const unite = (a, b) => {
-            const ra = find(a)
-            const rb = find(b)
-            if (ra !== rb) parent[rb] = ra
-        }
-
-        const similarity = (a, b) => {
-            const A = keys[a]
-            const B = keys[b]
-            if (!A?.size || !B?.size) return 0
-            let inter = 0
-            for (const v of A) if (B.has(v)) inter += 1
-            const union = A.size + B.size - inter
-            if (!union) return 0
-            return inter / union
-        }
-
-        const edges = []
-        for (let i = 0; i < list.length; i += 1) {
-            for (let j = i + 1; j < list.length; j += 1) {
-                const score = similarity(i, j)
-                if (score >= 0.9) {
-                    unite(i, j)
-                    edges.push({ i, j, score })
-                }
-            }
-        }
-
-        const groupsMap = new Map()
-        for (let i = 0; i < list.length; i += 1) {
-            const r = find(i)
-            const arr = groupsMap.get(r) || []
-            arr.push(i)
-            groupsMap.set(r, arr)
-        }
-
-        const groups = []
-        for (const idxs of groupsMap.values()) {
-            if (!idxs || idxs.length < 2) continue
-            let best = 0
-            for (const e of edges) {
-                if (idxs.includes(e.i) && idxs.includes(e.j)) best = Math.max(best, e.score)
-            }
-            groups.push({ items: idxs.map((i) => list[i]), score: best || 0.9 })
-        }
-
-        if (!groups.length) {
-            await alert('Não encontrei duplicados com alta similaridade.')
-            return
-        }
-        groups.sort((a, b) => b.score - a.score)
-        setDuplicateGroups(groups)
-        setDuplicatesOpen(true)
-    }
-
-    const handleArchiveDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Arquivar ${others.length} duplicados e manter "${base?.title || 'Treino'}"?`, 'Arquivar duplicados'))) return
-            setDuplicatesBusy(true)
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const res = await setWorkoutArchived(id, true)
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao arquivar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleMergeDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Mesclar ${others.length} duplicados em "${base?.title || 'Treino'}" e arquivar os demais?`, 'Mesclar duplicados'))) return
-            setDuplicatesBusy(true)
-
-            const baseExercises = Array.isArray(base?.exercises) ? base.exercises : []
-            const seen = new Set()
-            const merged = []
-            for (const ex of baseExercises) {
-                const name = String(ex?.name || '').trim()
-                const method = String(ex?.method || '').trim()
-                const reps = String(ex?.reps || '').trim()
-                const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                if (k && !seen.has(k)) {
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-            for (const w of others) {
-                const exs = Array.isArray(w?.exercises) ? w.exercises : []
-                for (const ex of exs) {
-                    const name = String(ex?.name || '').trim()
-                    const method = String(ex?.method || '').trim()
-                    const reps = String(ex?.reps || '').trim()
-                    const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                    if (!k || seen.has(k)) continue
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-
-            const baseId = String(base?.id || '').trim()
-            if (!baseId) throw new Error('Treino base sem ID')
-            const res = await updateWorkout(baseId, { title: String(base?.title || 'Treino'), notes: base?.notes ?? '', exercises: merged })
-            if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino mesclado'))
-
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const a = await setWorkoutArchived(id, true)
-                if (!a?.ok) throw new Error(String(a?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao mesclar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleShareWorkout = async (workout) => {
-        setExportWorkout(workout);
-        setShowExportModal(true);
-    };
-
-	const handleExportPdf = async () => {
-		if (!exportWorkout) return;
-		try {
-			const html = workoutPlanHtml(exportWorkout, user);
-			const win = window.open('', '_blank');
-			if (!win) return;
-			win.document.open();
-			win.document.write(html);
-			win.document.close();
-			win.focus();
-			setTimeout(() => { try { win.print(); } catch {} }, 300);
-			setShowExportModal(false);
-		} catch (e) { await alert('Erro ao gerar PDF: ' + (e?.message ?? String(e))); }
-	};
-
-    const handleExportJson = () => {
-        if (!exportWorkout) return;
-        const json = JSON.stringify({ workout: { title: exportWorkout.title, exercises: (exportWorkout.exercises || []).map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps, rpe: ex.rpe, cadence: ex.cadence, restTime: ex.restTime, method: ex.method, videoUrl: ex.videoUrl, notes: ex.notes })) } }, null, 2);
-        const blob = new Blob([json], { type: 'application/json' });
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement('a');
-        a.href = url;
-        a.download = `${(exportWorkout.title || 'treino').replace(/\s+/g,'_')}.json`;
-        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        setShowExportModal(false);
-    };
-
-    const handleExportAllWorkouts = async () => {
-        try {
-            setExportingAll(true);
-            const payload = {
-                user: { id: user?.id || '', email: user?.email || '' },
-                workouts: (workouts || []).map(w => ({
-                    id: w.id,
-                    title: w.title,
-                    notes: w.notes,
-                    is_template: true,
-                    exercises: (w.exercises || []).map(ex => ({
-                        name: ex.name,
-                        sets: ex.sets,
-                        reps: ex.reps,
-                        rpe: ex.rpe,
-                        cadence: ex.cadence,
-                        restTime: ex.restTime,
-                        method: ex.method,
-                        videoUrl: ex.videoUrl,
-                        notes: ex.notes
-                    }))
-                }))
-            };
-            const json = JSON.stringify(payload, null, 2);
-            const blob = new Blob([json], { type: 'application/json' });
-            const url = URL.createObjectURL(blob);
-            const a = document.createElement('a');
-            a.href = url;
-            a.download = `irontracks_workouts_${new Date().toISOString()}.json`;
-            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        } catch (e) {
-        } finally {
-            setExportingAll(false);
-        }
-    };
-
-    const handleImportWorkout = async () => {
-        await alert("Funcionalidade de importar código temporariamente indisponível na migração.", "Em Manutenção");
-    };
-
-    // JSON IMPORT HANDLER
-    const handleJsonUpload = (e) => {
-        const input = e?.target;
-        const file = input?.files?.[0];
-        if (!file) return;
-        try {
-            setShowJsonImportModal(false);
-        } catch {}
-
-        const reader = new FileReader();
-        reader.onload = async (event) => {
-            try {
-                const json = JSON.parse(event.target.result);
-                if (await confirm(`Importar dados de ${json.user?.email || 'Unknown'}? Isso criará novos treinos.`, "Importar Backup")) {
-                    await importData(json);
-                    await fetchWorkouts();
-                    await alert("Dados importados com sucesso!", "Sucesso");
-                }
-		} catch (err) {
-			await alert("Erro ao ler arquivo JSON: " + (err?.message ?? String(err)));
-		} finally {
-            try {
-                if (input) input.value = '';
-            } catch {}
-		}
-	};
-        reader.readAsText(file);
-    };
-
-    if (authLoading) return <LoadingScreen />;
-    if (!user?.id) return <LoadingScreen />;
-
-    const currentWorkoutId = activeSession?.workout?.id;
-    let nextWorkout = null;
-    if (currentWorkoutId && Array.isArray(workouts) && workouts.length > 0) {
-        const index = workouts.findIndex(w => w.id === currentWorkoutId);
-        if (index !== -1 && index + 1 < workouts.length) {
-            nextWorkout = workouts[index + 1];
-        }
-    }
-
-    const isHeaderVisible = view !== 'active' && view !== 'report';
-
-    return (
-        <InAppNotificationsProvider
-            userId={user?.id || null}
-            settings={userSettingsApi?.settings ?? null}
-            onOpenMessages={() => setView('chat')}
-            onOpenNotifications={() => {
-                setShowNotifCenter(true);
-                setHasUnreadNotification(false);
-            }}
-        >
-        <InAppNotifyBinder bind={bindInAppNotify} />
-        <TeamWorkoutProvider user={user} settings={userSettingsApi?.settings ?? null} onStartSession={handleStartSession}>
-            <div className="w-full bg-neutral-900 min-h-screen relative flex flex-col overflow-hidden" suppressHydrationWarning>
-                <IncomingInviteModal onStartSession={handleStartSession} />
-                <InviteAcceptedModal />
-                <GuidedTour
-                    open={Boolean(tourOpen)}
-                    steps={getTourSteps({
-                        role: user?.role,
-                        hasCommunity: (userSettingsApi?.settings?.moduleCommunity !== false),
-                    })}
-                    actions={{
-                        openAdminPanel: (tab) => {
-                            try {
-                                const safe = String(tab || 'dashboard').trim() || 'dashboard'
-                                openAdminPanel(safe)
-                            } catch {}
-                        },
-                    }}
-                    onEvent={(name, payload) => {
-                        logTourEvent(name, payload)
-                    }}
-                    onComplete={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: true, skipped: false, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'completed') } catch {}
-                        const res = await upsertTourFlags({ tour_completed_at: new Date().toISOString(), tour_skipped_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (completed). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_completed', { version: TOUR_VERSION })
-                    }}
-                    onSkip={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (skipped). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_skipped', { version: TOUR_VERSION })
-                    }}
-                    onCancel={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (cancelled). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_cancelled', { version: TOUR_VERSION })
-                    }}
-                />
-
-                {/* Header */}
-                {isHeaderVisible && (
-                    <div className="bg-neutral-950 flex justify-between items-center fixed top-0 left-0 right-0 z-40 border-b border-zinc-800 px-6 shadow-lg pt-[env(safe-area-inset-top)] min-h-[calc(4rem+env(safe-area-inset-top))]">
-                        <div 
-                            className="flex items-center cursor-pointer group"
-                            onClick={() => setView('dashboard')}
-                        >
-                            <div className="flex items-center gap-2">
-                                <Dumbbell size={18} className="text-yellow-500 opacity-25" />
-                                <h1 className="text-2xl font-black tracking-tighter italic leading-none text-white group-hover:opacity-80 transition-opacity">
-                                    IRON<span className="text-yellow-500">TRACKS</span>
-                                </h1>
-                            </div>
-                            <div className="h-6 w-px bg-yellow-500 mx-4 opacity-50"></div>
-                            <span className="text-zinc-400 text-xs font-medium tracking-wide uppercase">
-                                {isCoach ? 'Bem vindo Coach' : 'Bem vindo Atleta'}
-                            </span>
-                        </div>
-                        
-                        <div className="flex items-center gap-4">
-                                {(() => {
-                                    const pending = Number(syncState?.pending || 0)
-                                    const failed = Number(syncState?.failed || 0)
-                                    const online = syncState?.online !== false
-                                    const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-                                    const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-                                    if (!online) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-xs font-black uppercase tracking-widest">
-                                                Offline
-                                            </div>
-                                        )
-                                    }
-                                    if (offlineSyncV2Enabled && (pending > 0 || failed > 0)) {
-                                        return (
-                                            <button
-                                                type="button"
-                                                onClick={() => setOfflineSyncOpen(true)}
-                                                className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest hover:bg-yellow-500/15"
-                                                title="Abrir central de pendências"
-                                            >
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}{failed > 0 ? ` • Falhas: ${failed}` : ''}
-                                            </button>
-                                        )
-                                    }
-                                    if (pending > 0) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest">
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}
-                                            </div>
-                                        )
-                                    }
-                                    return null
-                                })()}
-                                <HeaderActionsMenu
-                                user={user}
-                                isCoach={isCoach}
-                                hasUnreadChat={hasUnreadChat}
-                                hasUnreadNotification={hasUnreadNotification}
-                                onOpenAdmin={() => {
-                                    if (typeof window !== 'undefined') {
-                                        const url = new URL(window.location);
-                                        url.searchParams.delete('view');
-                                        window.history.replaceState({}, '', url);
-                                    }
-                                    const tab = (() => {
-                                        try {
-                                            const url = new URL(window.location.href);
-                                            const current = String(url.searchParams.get('tab') || '').trim();
-                                            if (current) return current;
-                                        } catch {}
-                                        try {
-                                            const stored = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-                                            if (stored) return stored;
-                                        } catch {}
-                                        return 'dashboard';
-                                    })();
-                                    openAdminPanel(tab);
-                                }}
-                                onOpenChatList={() => setView('chatList')}
-                                onOpenGlobalChat={() => setView('globalChat')}
-                                onOpenHistory={() => setView('history')}
-                                onOpenNotifications={() => {
-                                    setShowNotifCenter(true);
-                                    setHasUnreadNotification(false);
-                                }}
-                                onOpenSchedule={() => router.push('/dashboard/schedule')}
-                                onOpenSettings={() => setSettingsOpen(true)}
-                                onOpenTour={async () => {
-                                    try {
-                                        await logTourEvent('tour_started', { auto: false, version: TOUR_VERSION })
-                                    } catch {}
-                                    setTourOpen(true)
-                                }}
-                                onLogout={handleLogout}
-                            />
-                        </div>
-                    </div>
-                )}
-
-                {isCoach && coachPending && (
-                    <div className="bg-yellow-500 text-black text-sm font-bold px-4 py-2 text-center">
-                        Sua conta de Professor está pendente. <button className="underline" onClick={async () => { try { const r = await fetch('/api/teachers/accept', { method: 'POST' }); const j = await r.json(); if (j.ok) { setCoachPending(false); await alert('Conta ativada!'); } else { await alert('Falha ao ativar: ' + (j.error || '')); } } catch (e) { await alert('Erro: ' + (e?.message ?? String(e))); } }}>Aceitar</button>
-                    </div>
-                )}
-
-                {/* Main Content */}
-                <div
-                    className="flex-1 overflow-y-auto custom-scrollbar relative"
-                    style={{
-                        '--dashboard-sticky-top': isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : '0px',
-                        paddingTop: isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : undefined,
-                    }}
-                >
-                    {(view === 'dashboard' || view === 'assessments' || view === 'community' || view === 'vip') && (
-                        <StudentDashboard
-                            workouts={Array.isArray(workouts) ? workouts : []}
-                            profileIncomplete={Boolean(profileIncomplete)}
-                            onOpenCompleteProfile={() => setShowCompleteProfile(true)}
-                            view={view === 'assessments' ? 'assessments' : view === 'community' ? 'community' : view === 'vip' ? 'vip' : 'dashboard'}
-                            onChangeView={(next) => setView(next)}
-                            assessmentsContent={(user?.id || initialUser?.id) ? <AssessmentHistory studentId={user?.id || initialUser?.id} /> : null}
-                            communityContent={(user?.id || initialUser?.id) ? <CommunityClient embedded /> : null}
-                            vipContent={<VipHub user={user} locked={!vipAccess?.hasVip} onOpenWorkoutEditor={(w) => handleEditWorkout(w)} onOpenVipTab={() => setView('vip')} />}
-                            vipLabel="VIP"
-                            vipLocked={!vipAccess?.hasVip}
-                            vipEnabled={true}
-                            settings={userSettingsApi?.settings ?? null}
-                            onCreateWorkout={handleCreateWorkout}
-                            onQuickView={(w) => setQuickViewWorkout(w)}
-                            onStartSession={(w) => handleStartSession(w)}
-                            onRestoreWorkout={(w) => handleRestoreWorkout(w)}
-                            onShareWorkout={(w) => handleShareWorkout(w)}
-                            onDuplicateWorkout={(w) => handleDuplicateWorkout(w)}
-                            onEditWorkout={(w) => handleEditWorkout(w)}
-                            onDeleteWorkout={(id, title) => handleDeleteWorkout(id, title)}
-                            onBulkEditWorkouts={handleBulkEditWorkouts}
-                            currentUserId={user?.id || initialUser?.id}
-                            newRecordsReloadKey={newRecordsReloadKey}
-                            exportingAll={Boolean(exportingAll)}
-                            onExportAll={handleExportAllWorkouts}
-                            streakStats={streakStats}
-                            onOpenJsonImport={() => setShowJsonImportModal(true)}
-                            onNormalizeAiWorkoutTitles={handleNormalizeAiWorkoutTitles}
-                            onNormalizeExercises={handleNormalizeExercises}
-                            onOpenDuplicates={handleOpenDuplicates}
-                            onApplyTitleRule={handleApplyTitleRule}
-                            onOpenIronScanner={async () => {
-                                try {
-                                    openManualWorkoutEditor()
-                                    await alert('No editor, clique em Scanner de Treino (Imagem).', 'Scanner')
-                                } catch {}
-                            }}
-                        />
-                    )}
-
-                    <WorkoutWizardModal
-                        isOpen={createWizardOpen}
-                        onClose={() => setCreateWizardOpen(false)}
-                        onManual={() => openManualWorkoutEditor()}
-                        onGenerate={async (answers, options) => {
-                            const mode = String(options?.mode || 'single').trim().toLowerCase();
-                            try {
-                                const res = await fetch('/api/ai/workout-wizard', {
-                                    method: 'POST',
-                                    headers: { 'Content-Type': 'application/json' },
-                                    body: JSON.stringify({ answers, mode }),
-                                })
-                                const data = await res.json().catch(() => null)
-                                if (!res.ok) {
-                                    const msg = data?.error ? String(data.error) : 'Falha ao gerar treino com IA.'
-                                    throw new Error(msg)
-                                }
-                                if (mode === 'program') {
-                                    const drafts = Array.isArray(data?.drafts) ? data.drafts : null
-                                    if (drafts && drafts.length) return { drafts }
-                                    if (data?.ok === false && Array.isArray(data?.drafts) && data.drafts.length) return { drafts: data.drafts }
-                                    throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                                }
-                                const draft = data?.draft && typeof data.draft === 'object' ? data.draft : null
-                                if (draft?.exercises && Array.isArray(draft.exercises) && draft.exercises.length > 0) return draft
-                                if (data?.ok === false && data?.draft) return data.draft
-                                throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                const lower = msg.toLowerCase()
-                                const isConfig = lower.includes('api de ia não configurada') || lower.includes('google_generative_ai_api_key')
-                                if (isConfig) throw e
-                                if (mode === 'program') {
-                                    const days = Math.max(2, Math.min(6, Number(answers?.daysPerWeek || 3) || 3))
-                                    const drafts = []
-                                    for (let i = 0; i < days; i++) {
-                                        drafts.push(generateWorkoutFromWizard(answers, i))
-                                    }
-                                    return { drafts }
-                                }
-                                return generateWorkoutFromWizard(answers, 0)
-                            }
-                        }}
-                        onSaveDrafts={async (drafts) => {
-                            const list = Array.isArray(drafts) ? drafts : []
-                            if (!list.length) return
-                            try {
-                                for (let i = 0; i < list.length; i += 1) {
-                                    const d = list[i]
-                                    const baseTitle = String(d?.title || 'Treino').trim() || 'Treino'
-                                    const finalTitle = formatProgramWorkoutTitle(baseTitle, i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                                    const exercises = Array.isArray(d?.exercises) ? d.exercises : []
-                                    const res = await createWorkout({ title: finalTitle, exercises })
-                                    if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino'))
-                                }
-                                try {
-                                    await fetchWorkouts()
-                                } catch {}
-                                setCreateWizardOpen(false)
-                                await alert(`Plano salvo: ${list.length} treinos criados.`)
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                await alert('Erro ao salvar plano: ' + msg)
-                            }
-                        }}
-                        onUseDraft={(draft) => {
-                            try {
-                                const title = String(draft?.title || '').trim() || 'Treino'
-                                const exercises = Array.isArray(draft?.exercises) ? draft.exercises : []
-                                setCurrentWorkout({ title, exercises })
-                                setView('edit')
-                            } finally {
-                                setCreateWizardOpen(false)
-                            }
-                        }}
-                    />
-
-					{view === 'edit' && (
-						<ExerciseEditor
-							workout={currentWorkout}
-							onCancel={() => setView('dashboard')}
-							onChange={setCurrentWorkout}
-							onSave={handleSaveWorkout}
-							onSaved={() => {
-								fetchWorkouts().catch(() => {});
-								setView('dashboard');
-							}}
-						/>
-					)}
-
-                    {view === 'active' && activeSession && (
-                        <ActiveWorkout
-                            session={activeSession}
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onUpdateLog={handleUpdateSessionLog}
-                            onFinish={handleFinishSession}
-                            onPersistWorkoutTemplate={handlePersistWorkoutTemplateFromSession}
-                            onBack={() => setView('dashboard')}
-                            onStartTimer={handleStartTimer}
-                            isCoach={isCoach}
-                            onUpdateSession={(updates) => setActiveSession(prev => ({ ...prev, ...updates }))}
-                            nextWorkout={nextWorkout}
-                            onEditWorkout={() => handleOpenActiveWorkoutEditor()}
-                            onAddExercise={() => handleOpenActiveWorkoutEditor({ addExercise: true })}
-                        />
-                    )}
-
-                    {editActiveOpen && view === 'active' && editActiveDraft && (
-                        <div
-                            className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3 md:p-6 pt-safe"
-                            onClick={() => handleCloseActiveWorkoutEditor()}
-                        >
-                            <div
-                                className="w-full max-w-5xl h-[92vh] bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-                                onClick={(e) => e.stopPropagation()}
-                            >
-                                <ExerciseEditor
-                                    workout={editActiveDraft}
-                                    onCancel={() => handleCloseActiveWorkoutEditor()}
-                                    onChange={(w) => setEditActiveDraft(normalizeWorkoutForEditor(w))}
-                                    onSave={handleSaveActiveWorkoutEditor}
-                                    onSaved={() => {
-                                        fetchWorkouts().catch(() => {});
-                                        handleCloseActiveWorkoutEditor();
-                                    }}
-                                />
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'history' && (
-                        <HistoryList
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onViewReport={(s) => { setReportBackView('history'); setReportData({ current: s, previous: null }); setView('report'); }}
-                            onBack={() => setView('dashboard')}
-                        />
-                    )}
-
-                    {/* Evolução removida conforme solicitação */}
-
-                    {view === 'report' && reportData.current && (
-                        <div className="fixed inset-0 z-[1200] bg-neutral-900 overflow-y-auto pt-safe">
-                            <WorkoutReport
-                                session={reportData.current}
-                                previousSession={reportData.previous}
-                                user={user}
-                                settings={userSettingsApi?.settings ?? null}
-                                onClose={() => setView(reportBackView || 'dashboard')}
-                            />
-                        </div>
-                    )}
-
-                    {duplicatesOpen && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe" onClick={() => !duplicatesBusy && setDuplicatesOpen(false)}>
-                            <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Ferramentas</div>
-                                        <div className="text-white font-black text-lg truncate">Duplicados</div>
-                                        <div className="text-xs text-neutral-400 truncate">{Array.isArray(duplicateGroups) ? `${duplicateGroups.length} grupos` : ''}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => setDuplicatesOpen(false)}
-                                        disabled={duplicatesBusy}
-                                        className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center disabled:opacity-50"
-                                        aria-label="Fechar"
-                                    >
-                                        <X size={18} />
-                                    </button>
-                                </div>
-                                <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-                                    {(Array.isArray(duplicateGroups) ? duplicateGroups : []).map((g, idx) => {
-                                        const items = Array.isArray(g?.items) ? g.items : []
-                                        const score = Number(g?.score || 0)
-                                        const base = items[0]
-                                        return (
-                                            <div key={`dup-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-4">
-                                                <div className="flex items-start justify-between gap-3">
-                                                    <div className="min-w-0">
-                                                        <div className="text-xs text-neutral-500 font-bold uppercase tracking-widest">Similaridade</div>
-                                                        <div className="text-white font-black truncate">{base?.title || 'Treino'}</div>
-                                                        <div className="text-xs text-neutral-400">{Math.round(score * 100)}%</div>
-                                                    </div>
-                                                    <div className="flex items-center gap-2">
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleMergeDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 disabled:opacity-50"
-                                                        >
-                                                            Mesclar
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleArchiveDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 disabled:opacity-50"
-                                                        >
-                                                            Arquivar
-                                                        </button>
-                                                    </div>
-                                                </div>
-                                                <div className="mt-3 space-y-2">
-                                                    {items.map((w, wi) => (
-                                                        <div key={`dup-item-${idx}-${wi}`} className="flex items-center justify-between gap-3 rounded-lg bg-neutral-900/40 border border-neutral-800 px-3 py-2">
-                                                            <div className="min-w-0">
-                                                                <div className="text-sm font-bold text-white truncate">{String(w?.title || 'Treino')}</div>
-                                                                <div className="text-[11px] text-neutral-500 font-mono">{Array.isArray(w?.exercises) ? w.exercises.length : 0} EXERCÍCIOS</div>
-                                                            </div>
-                                                            <div className="text-[11px] font-bold text-neutral-500">{wi === 0 ? 'BASE' : 'DUP'}</div>
-                                                        </div>
-                                                    ))}
-                                                </div>
-                                            </div>
-                                        )
-                                    })}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {showExportModal && exportWorkout && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowExportModal(false)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Como deseja exportar?</h3>
-                                    <BackButton onClick={() => setShowExportModal(false)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-3">
-                                    <button onClick={handleExportPdf} className="w-full px-4 py-3 bg-yellow-500 text-black font-bold rounded-xl">Baixar PDF</button>
-                                    <button onClick={handleExportJson} className="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl">Baixar JSON</button>
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {openStudent && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setOpenStudent(null)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Treinos de {openStudent.name}</h3>
-                                    <BackButton onClick={() => setOpenStudent(null)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-2 max-h-[70vh] overflow-y-auto">
-                                    {(openStudent.workouts || []).length === 0 && (
-                                        <p className="text-neutral-500 text-sm">Nenhum treino encontrado.</p>
-                                    )}
-                                    {(openStudent.workouts || []).map(w => (
-                                        <div key={w.id} className="p-3 rounded-xl border border-neutral-700 bg-neutral-800">
-                                            <div className="flex items-center justify-between">
-                                                <span className="text-white font-bold text-sm">{w.title}</span>
-                                                <span className="text-xs text-neutral-400">{w.exercises?.length || 0} exercícios</span>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'chat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'globalChat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'chatList' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatListScreen user={user} onClose={() => setView('dashboard')} onSelectChannel={(c) => { setDirectChat(c); setView('directChat'); }} />
-                        </div>
-                    )}
-
-                    {view === 'directChat' && directChat && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatDirectScreen user={user} otherUserId={directChat.other_user_id} otherUserName={directChat.other_user_name} otherUserPhoto={directChat.other_user_photo} onClose={() => setView('chatList')} />
-                        </div>
-                    )}
-
-                    {view === 'admin' && (
-                        <div className="fixed inset-0 z-[60]">
-                            <AdminPanelV2 user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-                </div>
-
-                {/* Modals & Overlays */}
-                {showCompleteProfile && (
-                    <div className="fixed inset-0 z-[85] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <div className="flex items-center justify-between gap-3 mb-4">
-                                <h3 className="font-black text-white">Completar Perfil</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-
-                            <label className="block text-xs font-bold uppercase tracking-widest text-neutral-500 mb-2">
-                                Nome de Exibição
-                            </label>
-                            <input
-                                value={profileDraftName}
-                                onChange={(e) => setProfileDraftName(e.target.value)}
-                                placeholder="Ex: João Silva"
-                                className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-yellow-500"
-                            />
-
-                            <div className="flex gap-2 mt-5">
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-300 disabled:opacity-50"
-                                >
-                                    Cancelar
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={handleSaveProfile}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-yellow-500 rounded-xl font-black text-black disabled:opacity-50"
-                                >
-                                    {savingProfile ? 'Salvando...' : 'Salvar'}
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                {showImportModal && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <h3 className="font-bold text-white mb-4">Importar Treino (Código)</h3>
-                            <input
-                                value={importCode}
-                                onChange={e => setImportCode(e.target.value)}
-                                placeholder="Cole o código do treino aqui"
-                                className="w-full bg-neutral-800 p-4 rounded-xl mb-4 text-white font-mono text-center uppercase"
-                            />
-                            <div className="flex gap-2">
-                                <button onClick={() => setShowImportModal(false)} className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-400">Cancelar</button>
-                                <button onClick={handleImportWorkout} className="flex-1 p-3 bg-blue-600 rounded-xl font-bold text-white">Importar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                
-                {showJsonImportModal && (
-                     <div className="fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <Upload size={48} className="mx-auto text-blue-500 mb-4" />
-                            <h3 className="font-bold text-white mb-2 text-xl">Restaurar Backup</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Selecione o arquivo .json que você salvou anteriormente.</p>
-                            
-                            <label className="block w-full cursor-pointer bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-colors">
-                                Selecionar Arquivo
-                                <input type="file" accept=".json" onChange={handleJsonUpload} className="hidden" />
-                            </label>
-                            
-                            <button onClick={() => setShowJsonImportModal(false)} className="mt-4 text-neutral-500 text-sm hover:text-white">Cancelar</button>
-                        </div>
-                    </div>
-                )}
-
-                {shareCode && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-black"><Check size={32} /></div>
-                            <h3 className="font-bold text-white mb-2">Link Gerado!</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Envie este código para seu aluno ou amigo.</p>
-                            <div className="bg-black p-4 rounded-xl font-mono text-yellow-500 text-xl mb-4 tracking-widest select-all">
-                                {shareCode}
-                            </div>
-                            <button onClick={() => setShareCode(null)} className="w-full p-3 bg-neutral-800 rounded-xl font-bold text-white">Fechar</button>
-                        </div>
-                    </div>
-                )}
-
-                {quickViewWorkout && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setQuickViewWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-lg rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">{String(quickViewWorkout?.title || '')}</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setQuickViewWorkout(null)}
-                                    className="flex items-center gap-2 text-yellow-500 hover:text-yellow-400 transition-colors py-2 px-3 rounded-xl hover:bg-neutral-800 active:opacity-70"
-                                    aria-label="Voltar"
-                                >
-                                    <ArrowLeft size={20} />
-                                    <span className="font-semibold text-sm">Voltar</span>
-                                </button>
-                            </div>
-                            <div className="p-4 max-h-[60vh] overflow-y-auto space-y-3 custom-scrollbar">
-                                {(Array.isArray(quickViewWorkout?.exercises) ? quickViewWorkout.exercises : []).map((ex, idx) => (
-                                    <div key={idx} className="p-3 rounded-xl bg-neutral-800/50 border border-neutral-700">
-                                        <div className="flex justify-between items-center">
-                                            <h4 className="font-bold text-white text-sm">{String(ex?.name || '—')}</h4>
-                                            <span className="text-xs text-neutral-400">{(parseInt(ex?.sets) || 0)} x {String(ex?.reps || '-')}</span>
-                                        </div>
-                                        <div className="text-xs text-neutral-400 mt-1 flex items-center gap-2">
-                                            <Clock size={14} className="text-yellow-500" /><span>Descanso: {ex?.restTime ? `${parseInt(ex.restTime)}s` : '-'}</span>
-                                        </div>
-                                        {ex?.notes && <p className="text-sm text-neutral-300 mt-2">{String(ex.notes || '')}</p>}
-                                    </div>
-                                ))}
-                                {(!Array.isArray(quickViewWorkout?.exercises) || quickViewWorkout.exercises.length === 0) && (
-                                    <p className="text-neutral-400 text-sm">Este treino não tem exercícios.</p>
-                                )}
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex gap-2">
-                                <button onClick={() => { const w = quickViewWorkout; setQuickViewWorkout(null); handleStartSession(w); }} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl">Iniciar Treino</button>
-                                <button onClick={() => setQuickViewWorkout(null)} className="flex-1 p-3 bg-neutral-800 text-white font-bold rounded-xl">Fechar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {showNotifCenter && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowNotifCenter(false)}>
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">Notificações</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowNotifCenter(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 relative">
-                                <NotificationCenter user={user} onStartSession={handleStartSession} embedded />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {activeSession?.timerTargetTime && (
-                    <RestTimerOverlay
-                        targetTime={activeSession.timerTargetTime}
-                        context={activeSession.timerContext}
-                        settings={userSettingsApi?.settings ?? null}
-                        onClose={handleCloseTimer}
-                        onFinish={handleCloseTimer}
-                    />
-                )}
-
-                {activeSession && view !== 'active' && (
-                    <div className="fixed bottom-0 left-0 right-0 z-[1100]">
-                        <div className="bg-neutral-900/95 backdrop-blur border-t border-neutral-800 px-4 py-3 pb-[max(env(safe-area-inset-bottom),12px)]">
-                            <div className="flex items-center gap-4">
-                                <div className="flex-1 min-w-0">
-                                    <h3 className="font-bold text-white truncate">{activeSession.workout?.title || 'Treino em andamento'}</h3>
-                                    <div className="flex items-center gap-3 text-xs text-neutral-300 mt-1">
-                                        <span className="font-mono text-yellow-500">{(() => { const end = sessionTicker || activeSession.startedAt; const s = Math.max(0, Math.floor((end - activeSession.startedAt) / 1000)); const m = Math.floor(s/60), sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; })()}</span>
-                                        <span className="text-neutral-500">tempo atual</span>
-                                        <span className="opacity-30">•</span>
-                                        <span className="font-mono text-neutral-200">{(() => { const total = (activeSession.workout?.exercises || []).reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0); return `${toMinutesRounded(total)} min`; })()}</span>
-                                        <span className="text-neutral-500">estimado total</span>
-                                    </div>
-                                    <div className="h-1 bg-neutral-700 rounded-full overflow-hidden mt-2">
-                                        {(() => {
-                                            const exCount = (activeSession.workout?.exercises || []).length;
-                                            let percent = 0;
-                                            if (exCount) {
-                                                const done = new Set();
-                                                if (activeSession.logs) {
-                                                    Object.keys(activeSession.logs).forEach(k => {
-                                                        const i = parseInt(k.split('-')[0]) || 0;
-                                                        done.add(i);
-                                                    });
-                                                }
-                                                const current = Math.min(done.size, exCount);
-                                                percent = Math.round((current / exCount) * 100);
-                                            }
-                                            return <div className="h-full bg-yellow-500" style={{ width: `${percent}%` }}></div>
-                                        })()}
-                                    </div>
-                                </div>
-                                <button className="shrink-0 px-4 py-2 bg-yellow-500 text-black font-black rounded-xl hover:bg-yellow-400" onClick={() => setView('active')}>Voltar pro treino</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {/* Admin Panel Modal controlled by State */}
-                {showAdminPanel && (
-                    <AdminPanelV2 user={user} onClose={closeAdminPanel} />
-                )}
-
-                {whatsNewOpen && (
-                    <WhatsNewModal
-                        isOpen={whatsNewOpen}
-                        entry={getLatestWhatsNew()}
-                        onClose={closeWhatsNew}
-                    />
-                )}
-
-                {preCheckinOpen && (
-                    <div
-                        className="fixed inset-0 z-[1300] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-                        onClick={() => {
-                            setPreCheckinOpen(false)
-                            const r = preCheckinResolveRef.current
-                            preCheckinResolveRef.current = null
-                            if (typeof r === 'function') r(null)
-                        }}
-                    >
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Check-in</div>
-                                    <div className="text-white font-black text-lg truncate">Pré-treino</div>
-                                    <div className="text-xs text-neutral-400 truncate">{String(preCheckinWorkout?.title || preCheckinWorkout?.name || 'Treino')}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-4">
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Energia (1–5)</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[1, 2, 3, 4, 5].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, energy: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.energy || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Dor / Soreness (0–10)</div>
-                                    <select
-                                        value={String(preCheckinDraft?.soreness ?? '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, soreness: String(e.target.value || '') }))}
-                                        className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                                    >
-                                        <option value="">Não informar</option>
-                                        {Array.from({ length: 11 }).map((_, i) => (
-                                            <option key={i} value={String(i)}>
-                                                {i}
-                                            </option>
-                                        ))}
-                                    </select>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Tempo disponível</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[30, 45, 60, 90, 120].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, timeMinutes: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.timeMinutes || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}m
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Observações (opcional)</div>
-                                    <textarea
-                                        value={String(preCheckinDraft?.notes || '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, notes: String(e.target.value || '') }))}
-                                        className="w-full min-h-[90px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none"
-                                        placeholder="Ex.: pouco sono, dor no joelho, viagem…"
-                                    />
-                                </div>
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex items-center gap-2">
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-                                >
-                                    Pular
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(preCheckinDraft)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-                                >
-                                    Continuar
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {settingsOpen && (
-                    <SettingsModal
-                        isOpen={settingsOpen}
-                        onClose={() => setSettingsOpen(false)}
-                        settings={userSettingsApi?.settings ?? null}
-                        userRole={user?.role || ''}
-                        saving={Boolean(userSettingsApi?.saving)}
-                        onOpenWhatsNew={() => {
-                            setSettingsOpen(false)
-                            setWhatsNewOpen(true)
-                        }}
-                        onSave={async (next) => {
-                            try {
-                                const safeNext = next && typeof next === 'object' ? next : (userSettingsApi?.settings ?? {})
-                                const res = await userSettingsApi?.save?.(safeNext)
-                                if (!res?.ok) {
-                                    await alert('Falha ao salvar: ' + (res?.error || ''))
-                                    return false
-                                }
-                                return true
-                            } catch (e) {
-                                await alert('Falha ao salvar: ' + (e?.message ?? String(e)))
-                                return false
-                            }
-                        }}
-                    />
-                )}
-
-                <OfflineSyncModal
-                    open={offlineSyncOpen}
-                    onClose={() => setOfflineSyncOpen(false)}
-                    userId={user?.id}
-                />
-            </div>
-        </TeamWorkoutProvider>
-        </InAppNotificationsProvider>
-    );
-}
-
-export default function IronTracksAppClient({ initialUser, initialProfile, initialWorkouts }) {
-    const [isMounted, setIsMounted] = useState(false);
-    useEffect(() => {
-        const t = setTimeout(() => {
-            setIsMounted(true);
-        }, 0);
-        return () => clearTimeout(t);
-    }, []);
-    if (!isMounted) return <LoadingScreen />;
-    return (
-        <DialogProvider>
-            <ErrorReporterProvider>
-                <ErrorBoundary>
-                    <IronTracksApp initialUser={initialUser} initialProfile={initialProfile} initialWorkouts={initialWorkouts} />
-                </ErrorBoundary>
-                <GlobalDialog />
-            </ErrorReporterProvider>
-        </DialogProvider>
-    );
-}
diff --git a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 7.js b/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 7.js
deleted file mode 100644
index fed17af..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 7.js	
+++ /dev/null
@@ -1,3577 +0,0 @@
-'use client';
-
-import React, { useState, useEffect, useCallback, Suspense, useRef } from 'react';
-import { useRouter } from 'next/navigation';
-import dynamic from 'next/dynamic';
-import Image from 'next/image';
-import {
-    RotateCcw,
-    History,
-    MoreVertical,
-    Share2,
-    Trash2,
-    Download,
-    Copy,
-    Plus,
-    Flame,
-    Play,
-    Dumbbell,
-    Check,
-    LogOut,
-    Clock,
-    Upload,
-    ArrowLeft,
-    X
-} from 'lucide-react';
-import { createClient } from '@/utils/supabase/client';
-import { createWorkout, updateWorkout, deleteWorkout, importData, computeWorkoutStreakAndStats, setWorkoutArchived, setWorkoutSortOrder } from '@/actions/workout-actions';
-
-import LoginScreen from '@/components/LoginScreen';
-import AdminPanelV2 from '@/components/AdminPanelV2';
-import ChatScreen from '@/components/ChatScreen';
-import ChatListScreen from '@/components/ChatListScreen';
-import ChatDirectScreen from '@/components/ChatDirectScreen';
-import HistoryList from '@/components/HistoryList';
-import CommunityClient from '@/app/(app)/community/CommunityClient';
-import StudentEvolution from '@/components/StudentEvolution';
-import WorkoutReport from '@/components/WorkoutReport';
-import ActiveWorkout from '@/components/ActiveWorkout';
-import RestTimerOverlay from '@/components/RestTimerOverlay';
-import LoadingScreen from '@/components/LoadingScreen';
-import ExerciseEditor from '@/components/ExerciseEditor';
-import IncomingInviteModal from '@/components/IncomingInviteModal';
-import InviteAcceptedModal from '@/components/InviteAcceptedModal';
-import NotificationCenter from '@/components/NotificationCenter';
-import HeaderActionsMenu from '@/components/HeaderActionsMenu.js';
-import { TeamWorkoutProvider } from '@/contexts/TeamWorkoutContext';
-import { InAppNotificationsProvider, useInAppNotifications } from '@/contexts/InAppNotificationsContext';
-import ErrorBoundary from '@/components/ErrorBoundary';
-import ErrorReporterProvider from '@/components/ErrorReporterProvider';
-import { DialogProvider, useDialog } from '@/contexts/DialogContext';
-import GlobalDialog from '@/components/GlobalDialog';
-import { playStartSound, unlockAudio } from '@/lib/sounds';
-import { workoutPlanHtml } from '@/utils/report/templates';
-import { estimateExerciseSeconds, toMinutesRounded, calculateExerciseDuration } from '@/utils/pacing';
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName'
-import { formatProgramWorkoutTitle } from '@/utils/workoutTitle'
-import { resolveCanonicalExerciseName } from '@/utils/exerciseCanonical'
-import { BackButton } from '@/components/ui/BackButton';
-import StudentDashboard from '@/components/dashboard/StudentDashboard.tsx'
-import WorkoutWizardModal from '@/components/dashboard/WorkoutWizardModal'
-import SettingsModal from '@/components/SettingsModal'
-import { useUserSettings } from '@/hooks/useUserSettings'
-import WhatsNewModal from '@/components/WhatsNewModal'
-import { generateWorkoutFromWizard } from '@/utils/workoutAutoGenerator'
-import { getLatestWhatsNew } from '@/content/whatsNew'
-import GuidedTour from '@/components/onboarding/GuidedTour'
-import { getTourSteps } from '@/utils/tourSteps'
-import { cacheGetWorkouts, cacheSetWorkouts, flushOfflineQueue, getOfflineQueueSummary, getPendingCount, isOnline } from '@/lib/offline/offlineSync'
-import OfflineSyncModal from '@/components/OfflineSyncModal'
-
-const AssessmentHistory = dynamic(() => import('@/components/assessment/AssessmentHistory'), { ssr: false });
-const VipHub = dynamic(() => import('@/components/VipHub'), { ssr: false });
-
-const appId = 'irontracks-production';
-
-function InAppNotifyBinder({ bind }) {
-    const { notify } = useInAppNotifications();
-    const safeBind = typeof bind === 'function' ? bind : null;
-    useEffect(() => {
-        if (!safeBind) return;
-        safeBind(notify);
-        return () => {
-            try { safeBind(null); } catch {}
-        };
-    }, [notify, safeBind]);
-    return null;
-}
-
-const mapWorkoutRow = (w) => {
-	const rawExercises = Array.isArray(w?.exercises) ? w.exercises : [];
-	const exs = rawExercises
-		.filter((e) => e && typeof e === 'object')
-		.sort((a, b) => (a.order || 0) - (b.order || 0))
-		.map((e) => {
-			try {
-				const isCardio = String(e.method || '').toLowerCase() === 'cardio';
-				const dbSets = Array.isArray(e.sets)
-					? e.sets.filter((s) => s && typeof s === 'object')
-					: [];
-
-				const sortedSets = dbSets
-					.slice()
-					.sort((aSet, bSet) => (aSet?.set_number || 0) - (bSet?.set_number || 0));
-
-				const setsCount = sortedSets.length || (isCardio ? 1 : 4);
-
-				const setDetails = sortedSets.map((s, idx) => ({
-					set_number: s?.set_number ?? idx + 1,
-					reps: s?.reps ?? null,
-					rpe: s?.rpe ?? null,
-					weight: s?.weight ?? null,
-					is_warmup: !!(s?.is_warmup ?? s?.isWarmup),
-					advanced_config: s?.advanced_config ?? s?.advancedConfig ?? null,
-				}));
-
-				const nonEmptyReps = setDetails
-					.map((s) => s.reps)
-					.filter((r) => r !== null && r !== undefined && r !== '');
-				const defaultReps = isCardio ? '20' : '10';
-				let repsHeader = defaultReps;
-				if (nonEmptyReps.length > 0) {
-					const uniqueReps = Array.from(new Set(nonEmptyReps));
-					repsHeader = uniqueReps.length === 1 ? uniqueReps[0] : nonEmptyReps[0] ?? defaultReps;
-				}
-
-				const rpeValues = setDetails
-					.map((s) => s.rpe)
-					.filter((v) => v !== null && v !== undefined && !Number.isNaN(v));
-				const defaultRpe = isCardio ? 5 : 8;
-				const rpeHeader = rpeValues.length > 0 ? rpeValues[0] : defaultRpe;
-
-				return {
-					id: e.id,
-					name: e.name,
-					notes: e.notes,
-					videoUrl: e.video_url,
-					restTime: e.rest_time,
-					cadence: e.cadence,
-					method: e.method,
-					sets: setsCount,
-					reps: repsHeader,
-					rpe: rpeHeader,
-					setDetails,
-				};
-			} catch (mapErr) {
-				console.error('Erro ao mapear exercício', {
-					workoutId: w?.id,
-					exerciseId: e?.id,
-					error: mapErr,
-				});
-				return null;
-			}
-		})
-		.filter(Boolean);
-
-	return {
-		id: w.id,
-		title: w.name,
-		notes: w.notes,
-		exercises: exs,
-		is_template: !!w.is_template,
-		user_id: w.user_id,
-		created_by: w.created_by,
-        archived_at: w.archived_at ?? null,
-        sort_order: typeof w.sort_order === 'number' ? w.sort_order : (w.sort_order == null ? 0 : Number(w.sort_order) || 0),
-        created_at: w.created_at ?? null,
-	};
-};
-
-function IronTracksApp({ initialUser, initialProfile, initialWorkouts }) {
-    const { confirm, alert } = useDialog();
-    const [user, setUser] = useState(initialUser ?? null);
-    const [authLoading, setAuthLoading] = useState(false);
-    const [view, setView] = useState('dashboard');
-    const [directChat, setDirectChat] = useState(null);
-    const [workouts, setWorkouts] = useState(() => {
-        try {
-            const list = Array.isArray(initialWorkouts) ? initialWorkouts : [];
-            const mapped = list
-                .map((row) => mapWorkoutRow(row))
-                .filter(Boolean)
-                .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-            return mapped;
-        } catch {
-            return [];
-        }
-    });
-    const [stats, setStats] = useState({ workouts: 0, exercises: 0, activeStreak: 0 });
-    const [streakStats, setStreakStats] = useState(null);
-    const [currentWorkout, setCurrentWorkout] = useState(null);
-    const [createWizardOpen, setCreateWizardOpen] = useState(false)
-    const [importCode, setImportCode] = useState('');
-    const [shareCode, setShareCode] = useState(null);
-    const [quickViewWorkout, setQuickViewWorkout] = useState(null);
-    const [showImportModal, setShowImportModal] = useState(false);
-    const [showJsonImportModal, setShowJsonImportModal] = useState(false);
-    const [reportData, setReportData] = useState({ current: null, previous: null });
-    const [reportBackView, setReportBackView] = useState('dashboard');
-    const [duplicatesOpen, setDuplicatesOpen] = useState(false);
-    const [duplicateGroups, setDuplicateGroups] = useState([]);
-    const [duplicatesBusy, setDuplicatesBusy] = useState(false);
-    const inAppNotifyRef = useRef(null);
-    const bindInAppNotify = useCallback((fn) => {
-        inAppNotifyRef.current = typeof fn === 'function' ? fn : null;
-    }, []);
-    const inAppNotify = useCallback((payload) => {
-        const fn = inAppNotifyRef.current;
-        if (typeof fn === 'function') fn(payload);
-    }, []);
-
-    const [preCheckinOpen, setPreCheckinOpen] = useState(false)
-    const [preCheckinWorkout, setPreCheckinWorkout] = useState(null)
-    const [preCheckinDraft, setPreCheckinDraft] = useState({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-    const preCheckinResolveRef = useRef(null)
-
-    const requestPreWorkoutCheckin = useCallback(async (workout) => {
-        if (!user?.id) return null
-        if (preCheckinOpen) return null
-        return await new Promise((resolve) => {
-            preCheckinResolveRef.current = (value) => {
-                resolve(value ?? null)
-            }
-            setPreCheckinWorkout(workout && typeof workout === 'object' ? workout : null)
-            setPreCheckinDraft({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-            setPreCheckinOpen(true)
-        })
-    }, [preCheckinOpen, user?.id])
-    const [settingsOpen, setSettingsOpen] = useState(false)
-    const [whatsNewOpen, setWhatsNewOpen] = useState(false)
-    const [isCoach, setIsCoach] = useState(false);
-    const initialRole = String(initialProfile?.role || '').toLowerCase()
-    const [vipAccess, setVipAccess] = useState(() => ({
-        loaded: initialRole === 'admin' || initialRole === 'teacher',
-        hasVip: initialRole === 'admin' || initialRole === 'teacher',
-    }))
-    const [hasUnreadChat, setHasUnreadChat] = useState(false);
-    const [hasUnreadNotification, setHasUnreadNotification] = useState(false);
-    const [exportWorkout, setExportWorkout] = useState(null);
-    const [showExportModal, setShowExportModal] = useState(false);
-    const [coachPending, setCoachPending] = useState(false);
-    const [studentFolders, setStudentFolders] = useState([]);
-    const [openStudent, setOpenStudent] = useState(null);
-    const [showNotifCenter, setShowNotifCenter] = useState(false);
-    const [exportingAll, setExportingAll] = useState(false);
-
-    const [profileIncomplete, setProfileIncomplete] = useState(false);
-    const [profileDraftName, setProfileDraftName] = useState('');
-    const [savingProfile, setSavingProfile] = useState(false);
-    const [showCompleteProfile, setShowCompleteProfile] = useState(false);
-
-    // Estado Global da Sessão Ativa
-	const [activeSession, setActiveSession] = useState(null);
-	const suppressForeignFinishToastUntilRef = useRef(0);
-    const [sessionTicker, setSessionTicker] = useState(0);
-    const [editActiveOpen, setEditActiveOpen] = useState(false);
-    const [editActiveDraft, setEditActiveDraft] = useState(null);
-    const editActiveBaseRef = useRef(null);
-    const editActiveAddExerciseRef = useRef(false);
-    const [showAdminPanel, setShowAdminPanel] = useState(false);
-    const userSettingsApi = useUserSettings(user?.id)
-    const whatsNewShownRef = useRef(false)
-    const TOUR_VERSION = 1
-    const [tourOpen, setTourOpen] = useState(false)
-    const [tourBoot, setTourBoot] = useState({ loaded: false, completed: false, skipped: false, version: TOUR_VERSION })
-    const [syncState, setSyncState] = useState({ online: true, syncing: false, pending: 0 })
-    const [offlineSyncOpen, setOfflineSyncOpen] = useState(false)
-
-    // Local fallback to guarantee the tour doesn't re-open when DB upsert fails/offline.
-    // Stored per-user AND per-tour-version.
-    const getTourLocalKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.dismissed.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourAutoOpenedKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.autoOpened.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourSeenKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.seen.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const readLocalTourDismissal = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return null
-        try {
-            if (typeof window === 'undefined') return null
-            const key = getTourLocalKey(safeUid)
-            if (!key) return null
-            const raw = window.localStorage.getItem(key) || ''
-            if (!raw) return null
-            const parsed = JSON.parse(raw)
-            if (!parsed || typeof parsed !== 'object') return null
-            const version = Number(parsed?.version || 0) || 0
-            if (version !== TOUR_VERSION) return null
-            const status = String(parsed?.status || '')
-            if (status !== 'completed' && status !== 'skipped') return null
-            return { version, status, at: Number(parsed?.at || 0) || 0 }
-        } catch {
-            return null
-        }
-    }, [TOUR_VERSION, getTourLocalKey])
-    const writeLocalTourDismissal = useCallback((uid, status) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        const safeStatus = status === 'completed' ? 'completed' : 'skipped'
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourLocalKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, JSON.stringify({ version: TOUR_VERSION, status: safeStatus, at: Date.now() }))
-        } catch {}
-    }, [TOUR_VERSION, getTourLocalKey])
-    const wasTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourSeenKey(safeUid)
-            if (!key) return false
-            return (window.localStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourSeenKey])
-    const markTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourSeenKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourSeenKey])
-    const wasTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return false
-            return (window.sessionStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourAutoOpenedKey])
-    const markTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return
-            window.sessionStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourAutoOpenedKey])
-
-    const supabase = useRef(createClient()).current;
-    const router = useRouter();
-    const isFetching = useRef(false);
-
-    const ADMIN_PANEL_OPEN_KEY = 'irontracks_admin_panel_open';
-
-    const refreshSyncState = useCallback(async () => {
-        try {
-            const online = isOnline()
-            const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-            if (offlineSyncV2Enabled) {
-                const sum = await getOfflineQueueSummary({ userId: user?.id })
-                if (sum?.ok) {
-                    setSyncState((prev) => ({
-                        ...(prev || {}),
-                        online: sum.online !== false,
-                        pending: Number(sum.pending || 0),
-                        failed: Number(sum.failed || 0),
-                        due: Number(sum.due || 0),
-                    }))
-                    return
-                }
-            }
-            const pending = await getPendingCount(user?.id)
-            setSyncState((prev) => ({ ...(prev || {}), online, pending, failed: 0, due: 0 }))
-        } catch {
-            setSyncState((prev) => ({ ...(prev || {}), online: isOnline() }))
-        }
-    }, [user?.id, userSettingsApi?.settings])
-
-    const runFlushQueue = useCallback(async () => {
-        try {
-            if (!isOnline()) {
-                setSyncState((prev) => ({ ...(prev || {}), online: false }))
-                return
-            }
-            setSyncState((prev) => ({ ...(prev || {}), syncing: true, online: true }))
-            await flushOfflineQueue({ max: 8 })
-        } finally {
-            setSyncState((prev) => ({ ...(prev || {}), syncing: false }))
-            await refreshSyncState()
-        }
-    }, [refreshSyncState])
-
-    useEffect(() => {
-        refreshSyncState()
-        const onChanged = () => refreshSyncState()
-        const onOnline = () => runFlushQueue()
-        const onOffline = () => refreshSyncState()
-        try {
-            window.addEventListener('irontracks.offlineQueueChanged', onChanged)
-            window.addEventListener('online', onOnline)
-            window.addEventListener('offline', onOffline)
-        } catch {}
-        return () => {
-            try {
-                window.removeEventListener('irontracks.offlineQueueChanged', onChanged)
-                window.removeEventListener('online', onOnline)
-                window.removeEventListener('offline', onOffline)
-            } catch {}
-        }
-    }, [refreshSyncState, runFlushQueue])
-
-    useEffect(() => {
-        if (!user?.id) return
-        if (!isOnline()) return
-        if ((syncState?.pending || 0) <= 0) return
-        const t = setInterval(() => {
-            runFlushQueue()
-        }, 15000)
-        return () => clearInterval(t)
-    }, [runFlushQueue, syncState?.pending, user?.id])
-
-    const logTourEvent = useCallback(async (event, payload) => {
-        try {
-            if (!user?.id) return
-            const ev = String(event || '').trim()
-            if (!ev) return
-            const basePayload = payload && typeof payload === 'object' ? payload : {}
-            const enriched = {
-                ...basePayload,
-                role: String(user?.role || ''),
-                path: (() => {
-                    try { return typeof window !== 'undefined' ? String(window.location.pathname || '') : '' } catch { return '' }
-                })(),
-            }
-            await supabase.from('onboarding_events').insert({
-                user_id: user.id,
-                event: ev,
-                payload: enriched,
-            })
-        } catch {}
-    }, [supabase, user?.id, user?.role])
-
-    const upsertTourFlags = useCallback(async (patch) => {
-        try {
-            if (!user?.id) return { ok: false, error: 'missing_user' }
-            const base = patch && typeof patch === 'object' ? patch : {}
-            const payload = {
-                user_id: user.id,
-                preferences: userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {},
-                tour_version: TOUR_VERSION,
-                updated_at: new Date().toISOString(),
-                ...base,
-            }
-            await supabase.from('user_settings').upsert(payload, { onConflict: 'user_id' })
-            return { ok: true }
-        } catch (e) {
-            return { ok: false, error: e?.message ?? String(e) }
-        }
-    }, [TOUR_VERSION, supabase, user?.id, userSettingsApi?.settings])
-
-    useEffect(() => {
-        if (!user?.id) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const uid = String(user.id)
-                const localDismissal = readLocalTourDismissal(uid)
-                if (localDismissal) {
-                    // Defensive: if the user already dismissed locally (offline, blocked RLS, etc.), never auto-open again.
-                    const completed = localDismissal.status === 'completed'
-                    const skipped = localDismissal.status === 'skipped'
-                    setTourBoot({ loaded: true, completed, skipped, version: TOUR_VERSION })
-                    return
-                }
-
-                const { data } = await supabase
-                    .from('user_settings')
-                    .select('tour_version, tour_completed_at, tour_skipped_at')
-                    .eq('user_id', user.id)
-                    .maybeSingle()
-
-                if (cancelled) return
-
-                const dbVersion = Number(data?.tour_version || 0) || 0
-                // Only force a new auto-open when the DB explicitly says an older version was seen.
-                // If dbVersion is missing/0 but completed_at exists, we respect completed/skipped to avoid annoying loops.
-                const needsNewVersion = dbVersion > 0 && dbVersion < TOUR_VERSION
-                const completed = needsNewVersion ? false : !!data?.tour_completed_at
-                const skipped = needsNewVersion ? false : !!data?.tour_skipped_at
-                setTourBoot({ loaded: true, completed, skipped, version: dbVersion || TOUR_VERSION })
-
-                const shouldOpen = !wasTourSeenEver(uid) && !wasTourAutoOpenedThisSession(uid) && (!completed && !skipped)
-                if (shouldOpen) {
-                    markTourAutoOpenedThisSession(uid)
-                    markTourSeenEver(uid)
-                    await logTourEvent('tour_started', { auto: true, version: TOUR_VERSION })
-                    setTourOpen(true)
-                }
-            } catch {
-                if (!cancelled) setTourBoot((prev) => ({ ...(prev || {}), loaded: true }))
-            }
-        })()
-        return () => {
-            cancelled = true
-        }
-    }, [TOUR_VERSION, logTourEvent, markTourAutoOpenedThisSession, markTourSeenEver, readLocalTourDismissal, supabase, user?.id, wasTourAutoOpenedThisSession, wasTourSeenEver])
-
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : '';
-        if (!uid) return;
-        const key = `irontracks.socialPresencePing.v1.${uid}`;
-        try {
-            if (typeof window !== 'undefined') {
-                const seen = window.sessionStorage.getItem(key) || '';
-                if (seen === '1') return;
-                window.sessionStorage.setItem(key, '1');
-            }
-        } catch {}
-        try {
-            fetch('/api/social/presence/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-        try {
-            fetch('/api/profiles/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-    }, [user?.id]);
-
-    useEffect(() => {
-        if (authLoading) return;
-        if (user) return;
-        const t = setTimeout(() => {
-            try {
-                router.replace('/?next=/dashboard');
-            } catch {}
-        }, 150);
-        return () => {
-            clearTimeout(t);
-        };
-    }, [authLoading, user, router]);
-
-    useEffect(() => {
-        if (whatsNewShownRef.current) return
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        if (!userSettingsApi?.loaded) return
-        const entry = getLatestWhatsNew()
-        if (!entry?.id) return
-        const prefs = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-        if (prefs?.whatsNewAutoOpen === false) return
-        const lastSeenId = String(prefs?.whatsNewLastSeenId || '')
-        const lastSeenAt = Number(prefs?.whatsNewLastSeenAt || 0) || 0
-        const remind24h = prefs?.whatsNewRemind24h !== false
-        const within24h = lastSeenAt > 0 && Date.now() - lastSeenAt < 24 * 60 * 60 * 1000
-        if (lastSeenId === String(entry.id)) {
-            if (!remind24h) return
-            if (within24h) return
-        }
-        whatsNewShownRef.current = true
-        setWhatsNewOpen(true)
-    }, [user?.id, userSettingsApi?.loaded, userSettingsApi?.settings])
-
-    const closeWhatsNew = useCallback(async () => {
-        try {
-            setWhatsNewOpen(false)
-            const entry = getLatestWhatsNew()
-            if (!entry?.id) return
-            const prev = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-            const prevSeenId = String(prev?.whatsNewLastSeenId || '')
-            const nextSeenAt = Date.now()
-            const next = { ...(prev || {}), whatsNewLastSeenId: String(entry.id), whatsNewLastSeenAt: nextSeenAt }
-            try { userSettingsApi?.setSettings?.(next) } catch {}
-            try { await userSettingsApi?.save?.(next) } catch {}
-        } catch {}
-    }, [userSettingsApi])
-    const ADMIN_PANEL_TAB_KEY = 'irontracks_admin_panel_tab';
-
-    const setUrlTabParam = useCallback((nextTab) => {
-        try {
-            if (typeof window === 'undefined') return;
-            const tabValue = String(nextTab || '').trim();
-            if (!tabValue) return;
-            const url = new URL(window.location.href);
-            url.searchParams.set('tab', tabValue);
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const removeUrlTabParam = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const url = new URL(window.location.href);
-            url.searchParams.delete('tab');
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const openAdminPanel = useCallback((tab) => {
-        setShowAdminPanel(true);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                if (tab) sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, String(tab));
-                if (tab) setUrlTabParam(tab);
-            }
-        } catch {}
-    }, [setUrlTabParam]);
-
-    const closeAdminPanel = useCallback(() => {
-        setShowAdminPanel(false);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.removeItem(ADMIN_PANEL_OPEN_KEY);
-                sessionStorage.removeItem(ADMIN_PANEL_TAB_KEY);
-            }
-        } catch {}
-        removeUrlTabParam();
-    }, [removeUrlTabParam]);
-
-    const restoreAdminPanelIfNeeded = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const role = String(user?.role || '').toLowerCase();
-            const isPrivileged = role === 'admin' || role === 'teacher';
-            if (!isPrivileged) return;
-
-            const validTabs = new Set(['dashboard', 'students', 'teachers', 'templates', 'videos', 'broadcast', 'system']);
-            const url = new URL(window.location.href);
-            const urlTabRaw = String(url.searchParams.get('tab') || '').trim();
-            const urlTab = validTabs.has(urlTabRaw) ? urlTabRaw : '';
-
-            const open = sessionStorage.getItem(ADMIN_PANEL_OPEN_KEY);
-            const storedTabRaw = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-            const storedTab = validTabs.has(storedTabRaw) ? storedTabRaw : '';
-
-            const shouldOpen = open === '1' || !!urlTab;
-            if (!shouldOpen) return;
-
-            const tab = urlTab || storedTab || 'dashboard';
-            try {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, tab);
-            } catch {}
-            if (!urlTab && tab) setUrlTabParam(tab);
-            setShowAdminPanel(true);
-        } catch {}
-    }, [setUrlTabParam, user?.role]);
-
-    const resolveExerciseVideos = useCallback(async (exercises) => {
-        try {
-            const list = Array.isArray(exercises) ? exercises : [];
-            const missingNames = list
-                .map((ex) => {
-                    const name = String(ex?.name || '').trim();
-                    if (!name) return null;
-                    const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                    if (current) return null;
-                    return name;
-                })
-                .filter(Boolean);
-
-            const uniqueNames = Array.from(new Set(missingNames)).slice(0, 80);
-            if (!uniqueNames.length) return { exercises: list, updates: [] };
-
-            const res = await fetch('/api/exercise-library/resolve', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ names: uniqueNames }),
-            });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return { exercises: list, updates: [] };
-
-            const videos = json?.videos && typeof json.videos === 'object' ? json.videos : {};
-            const updates = [];
-
-            const next = list.map((ex) => {
-                const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                if (current) return ex;
-                const normalized = normalizeExerciseName(String(ex?.name || ''));
-                const url = normalized ? String(videos[normalized] || '').trim() : '';
-                if (!url) return ex;
-                if (ex?.id) updates.push({ id: ex.id, url });
-                return { ...ex, videoUrl: url, video_url: url };
-            });
-
-            return { exercises: next, updates };
-        } catch {
-            return { exercises: Array.isArray(exercises) ? exercises : [], updates: [] };
-        }
-    }, []);
-
-    const persistExerciseVideoUrls = useCallback(async (updates) => {
-        try {
-            const rows = Array.isArray(updates) ? updates : [];
-            const filtered = rows
-                .map((r) => ({ id: String(r?.id || '').trim(), url: String(r?.url || '').trim() }))
-                .filter((r) => !!r.id && !!r.url)
-                .slice(0, 100);
-            if (!filtered.length) return;
-            await Promise.allSettled(filtered.map((r) => supabase.from('exercises').update({ video_url: r.url }).eq('id', r.id)));
-        } catch {}
-    }, [supabase]);
-
-    const signOutInFlightRef = useRef(false);
-    const serverSessionSyncRef = useRef({ timer: null, lastKey: '' });
-    const serverSessionSyncWarnedRef = useRef(false);
-
-    const generateExerciseKey = useCallback(() => {
-        try {
-            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
-        } catch {}
-        return `ex_${Date.now()}_${Math.random().toString(16).slice(2)}`;
-    }, []);
-
-    const normalizeWorkoutForEditor = useCallback((raw) => {
-        try {
-            const base = raw && typeof raw === 'object' ? raw : {};
-            const title = String(base.title || base.name || 'Treino').trim() || 'Treino';
-            const exercisesRaw = Array.isArray(base.exercises) ? base.exercises : [];
-            const exercisesInitial = exercisesRaw.filter((ex) => ex && typeof ex === 'object').map((ex) => {
-                const existing = ex?._itx_exKey ? String(ex._itx_exKey) : '';
-                const fromId = ex?.id != null ? `id_${String(ex.id)}` : '';
-                const nextKey = existing || fromId || generateExerciseKey();
-                return { ...ex, _itx_exKey: nextKey };
-            });
-
-            const seen = new Set();
-            const exercises = exercisesInitial.map((ex) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k || seen.has(k)) {
-                    const nextKey = generateExerciseKey();
-                    seen.add(nextKey);
-                    return { ...ex, _itx_exKey: nextKey };
-                }
-                seen.add(k);
-                return ex;
-            });
-
-            return { ...base, title, exercises };
-        } catch {
-            return { title: 'Treino', exercises: [] };
-        }
-    }, [generateExerciseKey]);
-
-    const stripWorkoutInternalKeys = useCallback((workout) => {
-        try {
-            const w = workout && typeof workout === 'object' ? workout : {};
-            const exercises = Array.isArray(w.exercises)
-                ? w.exercises.map((ex) => {
-                      if (!ex || typeof ex !== 'object') return ex;
-                      const { _itx_exKey, ...rest } = ex;
-                      return rest;
-                  })
-                : w.exercises;
-            return { ...w, exercises };
-        } catch {
-            return workout;
-        }
-    }, []);
-
-    const reindexSessionLogsAfterWorkoutEdit = useCallback((oldWorkout, newWorkout, logs) => {
-        try {
-            const safeLogs = logs && typeof logs === 'object' ? logs : {};
-            const oldExercises = Array.isArray(oldWorkout?.exercises) ? oldWorkout.exercises : [];
-            const newExercises = Array.isArray(newWorkout?.exercises) ? newWorkout.exercises : [];
-            const oldKeyByIndex = oldExercises.map((ex) => String(ex?._itx_exKey || ''));
-            const newIndexByKey = new Map();
-            newExercises.forEach((ex, idx) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k) return;
-                if (newIndexByKey.has(k)) return;
-                newIndexByKey.set(k, idx);
-            });
-
-            const result = {};
-
-            Object.entries(safeLogs).forEach(([k, v]) => {
-                const parts = String(k || '').split('-');
-                if (parts.length !== 2) {
-                    result[k] = v;
-                    return;
-                }
-                const oldIdx = Number(parts[0]);
-                const setIdx = Number(parts[1]);
-                if (!Number.isFinite(oldIdx) || !Number.isFinite(setIdx)) {
-                    result[k] = v;
-                    return;
-                }
-                const exKey = oldKeyByIndex[oldIdx] || '';
-                const newIdx = exKey ? newIndexByKey.get(exKey) : undefined;
-                if (typeof newIdx !== 'number' || newIdx < 0) return;
-                const ex = newExercises[newIdx] || null;
-                const headerSets = Number.parseInt(ex?.sets, 10) || 0;
-                const details = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-                const maxSets = headerSets || (Array.isArray(details) ? details.length : 0);
-                if (maxSets && setIdx >= maxSets) return;
-                result[`${newIdx}-${setIdx}`] = v;
-            });
-
-            return result;
-        } catch {
-            return logs && typeof logs === 'object' ? logs : {};
-        }
-    }, []);
-
-    const clearSupabaseCookiesBestEffort = useCallback(() => {
-        try {
-            if (typeof document === 'undefined') return;
-            const raw = String(document.cookie || '');
-            const cookieNames = raw
-                .split(';')
-                .map((p) => p.trim())
-                .map((p) => p.split('=')[0])
-                .filter(Boolean);
-            const targets = cookieNames.filter((n) => n.startsWith('sb-') || n.includes('supabase'));
-            targets.forEach((name) => {
-                try {
-                    document.cookie = `${name}=; Max-Age=0; path=/`;
-                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
-                } catch {}
-            });
-        } catch {}
-    }, []);
-
-    const clearSupabaseStorageBestEffort = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const ls = window.localStorage;
-            if (!ls) return;
-            const keys = [];
-            for (let i = 0; i < ls.length; i++) {
-                const k = ls.key(i);
-                if (!k) continue;
-                if (k.startsWith('sb-') || k.includes('supabase') || k.includes('auth-token')) keys.push(k);
-            }
-            keys.forEach((k) => {
-                try { ls.removeItem(k); } catch {}
-            });
-        } catch {}
-    }, []);
-
-		const clearClientSessionState = useCallback(() => {
-		try {
-			localStorage.removeItem('activeSession');
-			localStorage.removeItem('appView');
-			if (user?.id) {
-				localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-				localStorage.removeItem(`irontracks.appView.v2.${user.id}`);
-			}
-		} catch {}
-		setActiveSession(null);
-		setView('dashboard');
-	}, [user?.id]);
-
-    const safeSignOut = useCallback(async (scope = 'local') => {
-        if (signOutInFlightRef.current) return;
-        signOutInFlightRef.current = true;
-        try {
-            clearSupabaseCookiesBestEffort();
-            clearSupabaseStorageBestEffort();
-        } catch (e) {
-            try {
-                clearSupabaseCookiesBestEffort();
-                clearSupabaseStorageBestEffort();
-            } catch {}
-        } finally {
-            signOutInFlightRef.current = false;
-        }
-    }, [clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        const scopedKey = `irontracks.activeSession.v2.${userId}`;
-        let localSavedAt = 0;
-
-        try {
-            const raw = localStorage.getItem(scopedKey) || localStorage.getItem('activeSession');
-            if (raw) {
-                const parsed = JSON.parse(raw);
-                if (parsed && typeof parsed === 'object' && parsed?.startedAt && parsed?.workout) {
-                    localSavedAt = Number(parsed?._savedAt ?? 0) || 0;
-                    setActiveSession(parsed);
-                    setView('active');
-
-                    if (!localStorage.getItem(scopedKey)) {
-                        try {
-                            localStorage.setItem(scopedKey, JSON.stringify(parsed));
-                            localStorage.removeItem('activeSession');
-                        } catch {}
-                    }
-                }
-            }
-        } catch {
-            try {
-                localStorage.removeItem(scopedKey);
-                localStorage.removeItem('activeSession');
-            } catch {}
-        }
-
-        const loadServer = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('active_workout_sessions')
-                    .select('state, updated_at')
-                    .eq('user_id', userId)
-                    .maybeSingle();
-                if (cancelled) return;
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                    return;
-                }
-
-                const state = data?.state;
-                if (!state || typeof state !== 'object') return;
-                if (!state?.startedAt || !state?.workout) return;
-
-                const updatedAtMs = (() => {
-                    const fromCol = typeof data?.updated_at === 'string' ? Date.parse(data.updated_at) : NaN;
-                    const fromState = Number(state?._savedAt ?? 0) || 0;
-                    return Math.max(Number.isFinite(fromCol) ? fromCol : 0, fromState);
-                })();
-
-                if (updatedAtMs <= localSavedAt) return;
-
-                setActiveSession(state);
-                setView('active');
-                try {
-                    localStorage.setItem(scopedKey, JSON.stringify(state));
-                } catch {}
-            } catch {}
-        };
-
-        loadServer();
-
-        return () => {
-            cancelled = true;
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        let mounted = true;
-        let channel;
-
-        try {
-            channel = supabase
-                .channel(`active-workout-session:${userId}`)
-                .on(
-                    'postgres_changes',
-                    {
-                        event: '*',
-                        schema: 'public',
-                        table: 'active_workout_sessions',
-                        filter: `user_id=eq.${userId}`,
-                    },
-                    (payload) => {
-                        try {
-                            if (!mounted) return;
-						const ev = String(payload?.eventType || '').toUpperCase();
-						if (ev === 'DELETE') {
-							if (Date.now() < (suppressForeignFinishToastUntilRef.current || 0)) {
-								suppressForeignFinishToastUntilRef.current = 0;
-								return;
-							}
-							setActiveSession(null);
-							setView('dashboard');
-							try {
-								localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-							} catch {}
-                                try {
-                                    inAppNotify({
-                                        text: 'Treino finalizado em outro dispositivo.',
-                                        senderName: 'Aviso do Sistema',
-                                        displayName: 'Sistema',
-                                        photoURL: null,
-                                    });
-                                } catch {}
-                                return;
-                            }
-
-                            if (ev === 'UPDATE') {
-                                const state = payload?.new?.state;
-                                if (!state || typeof state !== 'object' || !state?.startedAt || !state?.workout) {
-                                    setActiveSession(null);
-                                    setView('dashboard');
-                                    try {
-                                        localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-                                    } catch {}
-                                }
-                            }
-                        } catch {}
-                    }
-                )
-                .subscribe();
-        } catch {}
-
-        return () => {
-            mounted = false;
-            try {
-                if (channel) supabase.removeChannel(channel);
-            } catch {
-                try {
-                    if (channel) createClient().removeChannel(channel);
-                } catch {}
-            }
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const handler = () => { try { unlockAudio(); } catch {} };
-        document.addEventListener('touchstart', handler, { once: true });
-        document.addEventListener('click', handler, { once: true });
-        return () => {
-            document.removeEventListener('touchstart', handler);
-            document.removeEventListener('click', handler);
-        };
-    }, [supabase, alert, clearClientSessionState]);
-
-    // Persistência da View (Aba Atual)
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const scopedViewKey = `irontracks.appView.v2.${user.id}`;
-            const scopedSessionKey = `irontracks.activeSession.v2.${user.id}`;
-            const savedSession = localStorage.getItem(scopedSessionKey);
-            if (savedSession) {
-                setView('active');
-                return;
-            }
-
-            const raw = localStorage.getItem(scopedViewKey) || localStorage.getItem('appView');
-            const savedView = raw ? String(raw) : '';
-            if (!savedView) {
-                setView('dashboard');
-                return;
-            }
-
-            if (savedView === 'active') {
-                setView('dashboard');
-                return;
-            }
-
-            setView(savedView);
-        } catch {
-            setView('dashboard');
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            if (!view) return;
-            localStorage.setItem(`irontracks.appView.v2.${user.id}`, view);
-        } catch {
-            return;
-        }
-    }, [view, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const key = `irontracks.activeSession.v2.${user.id}`;
-            if (!activeSession) {
-                localStorage.removeItem(key);
-                localStorage.removeItem('activeSession');
-                return;
-            }
-
-            const payload = JSON.stringify({ ...(activeSession || {}), _savedAt: Date.now() });
-            const id = setTimeout(() => {
-                try {
-                    localStorage.setItem(key, payload);
-                } catch {}
-            }, 250);
-            return () => clearTimeout(id);
-        } catch {
-            return;
-        }
-    }, [activeSession, user?.id]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        try {
-            if (serverSessionSyncRef.current?.timer) {
-                try {
-                    clearTimeout(serverSessionSyncRef.current.timer);
-                } catch {}
-            }
-        } catch {}
-
-        const key = (() => {
-            try {
-                return JSON.stringify(activeSession || null);
-            } catch {
-                return '';
-            }
-        })();
-
-        serverSessionSyncRef.current.lastKey = key;
-
-        const run = async () => {
-            try {
-                if (serverSessionSyncRef.current.lastKey !== key) return;
-
-                if (!activeSession) {
-                    const { error } = await supabase.from('active_workout_sessions').delete().eq('user_id', userId);
-                    if (error) {
-                        const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                        const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                        const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                        if (isMissing && !serverSessionSyncWarnedRef.current) {
-                            serverSessionSyncWarnedRef.current = true;
-                            try {
-                                inAppNotify({
-                                    text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                    senderName: 'Aviso do Sistema',
-                                    displayName: 'Sistema',
-                                    photoURL: null,
-                                });
-                            } catch {}
-                        }
-                    }
-                    return;
-                }
-
-                const startedAtRaw = activeSession?.startedAt;
-                const startedAtMs = typeof startedAtRaw === 'number' ? startedAtRaw : new Date(startedAtRaw || 0).getTime();
-                if (!Number.isFinite(startedAtMs) || startedAtMs <= 0) return;
-                if (!activeSession?.workout) return;
-
-                const state = { ...(activeSession || {}), _savedAt: Date.now() };
-
-                const { error } = await supabase
-                    .from('active_workout_sessions')
-                    .upsert(
-                        {
-                            user_id: userId,
-                            started_at: new Date(startedAtMs).toISOString(),
-                            state,
-                            updated_at: new Date().toISOString(),
-                        },
-                        { onConflict: 'user_id' }
-                    );
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                }
-            } catch {}
-        };
-
-        let timerId = null;
-
-        try {
-            timerId = setTimeout(() => {
-                try {
-                    run();
-                } catch {}
-            }, 900);
-            serverSessionSyncRef.current.timer = timerId;
-        } catch {}
-
-        return () => {
-            try {
-                if (timerId) clearTimeout(timerId);
-            } catch {}
-        };
-    }, [activeSession, supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        if (!activeSession) return;
-        const id = setInterval(() => setSessionTicker(Date.now()), 1000);
-        return () => clearInterval(id);
-    }, [activeSession, view]);
-
-    useEffect(() => {
-        let cancelled = false;
-        if (!user?.id) {
-            setHasUnreadNotification(false);
-            return;
-        }
-
-        const loadInitial = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('notifications')
-                    .select('id')
-                    .eq('user_id', user.id)
-                    .limit(1);
-                if (cancelled) return;
-                if (error) {
-                    console.error('Erro ao carregar notificações:', error);
-                    setHasUnreadNotification(false);
-                    return;
-                }
-                setHasUnreadNotification(Array.isArray(data) && data.length > 0);
-            } catch (e) {
-                if (cancelled) return;
-                console.error('Erro ao carregar notificações:', e);
-                setHasUnreadNotification(false);
-            }
-        };
-
-        loadInitial();
-
-        const channel = supabase
-            .channel(`notifications:badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) setHasUnreadNotification(true);
-            })
-            .on('postgres_changes', {
-                event: 'DELETE',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) loadInitial();
-            })
-            .subscribe();
-
-        return () => {
-            cancelled = true;
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-        const allowNotifyDm = s ? s.notifyDirectMessages !== false : true
-
-        const channel = supabase
-            .channel(`direct-messages-badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'direct_messages'
-            }, async (payload) => {
-                try {
-                    if (!allowNotifyDm) return;
-                    const msg = payload.new;
-                    if (!msg || msg.sender_id === user.id) return;
-
-                    const currentView = view;
-                    if (currentView === 'chat' || currentView === 'chatList' || currentView === 'directChat' || currentView === 'globalChat') {
-                        return;
-                    }
-
-                    const { data: senderProfile } = await supabase
-                        .from('profiles')
-                        .select('display_name')
-                        .eq('id', msg.sender_id)
-                        .maybeSingle();
-
-                    const senderName = senderProfile?.display_name || 'Nova mensagem';
-                    const preview = String(msg.content || '').slice(0, 120);
-                    if (!preview) return;
-
-                    await fetch('/api/notifications/direct-message', {
-                        method: 'POST',
-                        headers: { 'Content-Type': 'application/json' },
-                        body: JSON.stringify({
-                            receiverId: user.id,
-                            senderName,
-                            preview,
-                        }),
-                    });
-                } catch (e) {
-                    console.error('Erro ao gerar notificação de mensagem direta:', e);
-                }
-            })
-            .subscribe();
-
-        return () => {
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id, userSettingsApi?.settings, view]);
-
-    useEffect(() => {
-        const baseUser = initialUser && typeof initialUser === 'object' ? initialUser : null
-        if (!baseUser?.id) {
-            try {
-                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-            } catch {}
-            return
-        }
-        const meta = baseUser?.user_metadata || {}
-        const emailRaw = String(baseUser?.email || '').trim()
-        const emailUser = emailRaw.includes('@') ? emailRaw.split('@')[0] : (emailRaw || 'Usuário')
-        const profileDisplayName = String(initialProfile?.display_name || initialProfile?.displayName || '').trim()
-        const profilePhotoURL = String(initialProfile?.photo_url || initialProfile?.photoURL || initialProfile?.photoUrl || '').trim()
-        const metaDisplayName = String(meta?.full_name || meta?.name || '').trim()
-        const displayName = profileDisplayName || metaDisplayName || emailUser
-        const photoURL = profilePhotoURL || meta?.avatar_url || meta?.picture || null
-        const nextUser = { ...baseUser, displayName, photoURL, role: initialProfile?.role || 'user' }
-        setUser(nextUser)
-        const role = String(initialProfile?.role || '').toLowerCase()
-        setIsCoach(role === 'teacher' || role === 'admin')
-    }, [initialUser, initialProfile])
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const res = await fetch('/api/vip/access', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                const json = await res.json().catch(() => null)
-                if (cancelled) return
-                if (json && json.ok) {
-                    setVipAccess({ loaded: true, hasVip: !!json.hasVip })
-                    return
-                }
-                setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            } catch {
-                if (!cancelled) setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            }
-        })()
-        return () => { cancelled = true }
-    }, [user?.id])
-
-    useEffect(() => {
-        try {
-            const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {
-                try {
-                    const ev = String(_event || '').toUpperCase()
-                    if (session && session.user?.id) return
-                    if (ev === 'SIGNED_OUT') {
-                        clearClientSessionState()
-                        if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                        return
-                    }
-                    if (ev === 'INITIAL_SESSION') {
-                        fetch('/api/auth/ping', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                            .then((r) => {
-                                if (r && r.status === 204) return
-                                clearClientSessionState()
-                                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                            })
-                            .catch(() => {})
-                        return
-                    }
-                } catch {}
-            })
-            return () => {
-                try { sub?.subscription?.unsubscribe?.() } catch {}
-            }
-        } catch {
-            return
-        }
-    }, [supabase, clearClientSessionState, clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort])
-
-    useEffect(() => {
-        restoreAdminPanelIfNeeded();
-        const onVisibility = () => {
-            if (typeof document === 'undefined') return;
-            if (document.visibilityState === 'visible') restoreAdminPanelIfNeeded();
-        };
-        const onPageShow = () => restoreAdminPanelIfNeeded();
-        try {
-            document.addEventListener('visibilitychange', onVisibility);
-            window.addEventListener('pageshow', onPageShow);
-        } catch {}
-        return () => {
-            try {
-                document.removeEventListener('visibilitychange', onVisibility);
-                window.removeEventListener('pageshow', onPageShow);
-            } catch {}
-        };
-    }, [restoreAdminPanelIfNeeded]);
-
-    // Sync Profile Separately (Optimized)
-    useEffect(() => {
-        if (user?.id) {
-             const syncProfile = async () => {
-                 try {
-                    return
-                 } catch (e) {
-                    console.error('Erro ao sincronizar perfil:', e);
-                 }
-             };
-             syncProfile();
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const run = async () => {
-            if (!user?.id) {
-                if (!cancelled) {
-                    setProfileIncomplete(false);
-                    setProfileDraftName('');
-                }
-                return;
-            }
-
-            try {
-                const seedName = String(initialProfile?.display_name || '').trim() || String(user?.displayName || '').trim();
-                if (!cancelled) {
-                    setProfileIncomplete(!seedName);
-                    setProfileDraftName(seedName);
-                }
-            } catch {
-                if (!cancelled) {
-                    setProfileIncomplete(true);
-                    setProfileDraftName(String(user?.displayName || '').trim());
-                }
-            }
-        };
-
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [initialProfile?.display_name, user?.id, user?.displayName]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        let cancelled = false;
-        const run = async () => {
-            try {
-                const res = await fetch('/api/dashboard/bootstrap', { cache: 'no-store', credentials: 'include' });
-                const json = await res.json().catch(() => null);
-                if (cancelled) return;
-                if (!json?.ok) return;
-
-                const prof = json?.profile && typeof json.profile === 'object' ? json.profile : null;
-                const displayName = String(prof?.display_name || '').trim();
-                const photoURL = String(prof?.photo_url || '').trim();
-                const role = String(prof?.role || '').toLowerCase();
-
-                setUser((prev) => {
-                    const current = prev && typeof prev === 'object' ? prev : null;
-                    if (!current) return prev;
-                    const patch = {};
-                    if (displayName && displayName !== current.displayName) patch.displayName = displayName;
-                    if (photoURL && photoURL !== current.photoURL) patch.photoURL = photoURL;
-                    if (role && role !== String(current.role || '').toLowerCase()) patch.role = role;
-                    return Object.keys(patch).length ? { ...current, ...patch } : prev;
-                });
-                if (role) setIsCoach(role === 'teacher' || role === 'admin');
-
-                if (Array.isArray(json.workouts) && json.workouts.length) {
-                    const mapped = json.workouts
-                        .map((row) => mapWorkoutRow(row))
-                        .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-                    setWorkouts(mapped);
-                    const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-                    setStats({ workouts: mapped.length, exercises: totalEx, activeStreak: 0 });
-                }
-            } catch {}
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [user?.id]);
-
-	// Fetch Workouts
-	const fetchWorkouts = useCallback(async (specificUser = user) => {
-        if (isFetching.current) return;
-        isFetching.current = true;
-        
-		try {
-			const currentUser = specificUser;
-
-            if (!currentUser?.id) {
-                console.warn("DASHBOARD: Usuário não identificado ao buscar treinos.");
-                return;
-            }
-
-            if (typeof navigator !== 'undefined' && navigator.onLine === false) {
-                try {
-                    const cached = await cacheGetWorkouts({ userId: currentUser.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-                return
-            }
-
-            const role = String(currentUser?.role || 'user') || 'user';
-
-            let data = []
-            let studentData = []
-            let studentsList = []
-
-            const hydrateWorkouts = async (rows) => {
-                const base = Array.isArray(rows) ? rows.filter((x) => x && typeof x === 'object') : [];
-                const workoutIds = base.map((w) => w.id).filter(Boolean);
-                if (workoutIds.length === 0) return base.map((w) => ({ ...w, exercises: [] }));
-
-                let exercises = [];
-                try {
-                    const { data: exRows } = await supabase
-                        .from('exercises')
-                        .select('*')
-                        .in('workout_id', workoutIds)
-                        .order('order', { ascending: true })
-                        .limit(5000);
-                    exercises = Array.isArray(exRows) ? exRows : [];
-                } catch {
-                    exercises = [];
-                }
-
-                const exIds = exercises.map((e) => e.id).filter(Boolean);
-                let sets = [];
-                if (exIds.length > 0) {
-                    try {
-                        const { data: setRows } = await supabase
-                            .from('sets')
-                            .select('*')
-                            .in('exercise_id', exIds)
-                            .order('set_number', { ascending: true })
-                            .limit(20000);
-                        sets = Array.isArray(setRows) ? setRows : [];
-                    } catch {
-                        sets = [];
-                    }
-                }
-
-                const setsByExercise = new Map();
-                for (const s of sets) {
-                    const eid = s?.exercise_id;
-                    if (!eid) continue;
-                    const list = setsByExercise.get(eid) || [];
-                    list.push(s);
-                    setsByExercise.set(eid, list);
-                }
-
-                const exByWorkout = new Map();
-                for (const ex of exercises) {
-                    const wid = ex?.workout_id;
-                    if (!wid) continue;
-                    const exWithSets = { ...ex, sets: setsByExercise.get(ex.id) || [] };
-                    const list = exByWorkout.get(wid) || [];
-                    list.push(exWithSets);
-                    exByWorkout.set(wid, list);
-                }
-
-                return base.map((w) => ({ ...w, exercises: exByWorkout.get(w.id) || [] }));
-            };
-
-            if (role === 'admin' || role === 'teacher') {
-                // 1. Fetch Students
-                try {
-                    const { data: st } = await supabase
-                        .from('students')
-                        .select('id, name, email, user_id')
-                        .or(`teacher_id.eq.${currentUser.id},user_id.eq.${currentUser.id}`)
-                        .order('name');
-                    studentsList = st || [];
-                } catch (e) { console.error('Erro fetching students', e); }
-
-                // 2. Fetch My Workouts
-                const { data: myBase, error: myErr } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (myErr) throw myErr
-                data = await hydrateWorkouts(myBase || [])
-
-                // 3. Fetch Student Workouts
-                const ids = studentsList.map(s => s.user_id || s.id).filter(Boolean)
-                if (ids.length > 0) {
-                    const seen = new Set()
-                    const combined = []
-                    try {
-                        const { data: swByUserBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('user_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByUser = await hydrateWorkouts(swByUserBase || [])
-                        for (const w of (swByUser || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    try {
-                        const { data: swByStudentBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('student_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByStudent = await hydrateWorkouts(swByStudentBase || [])
-                        for (const w of (swByStudent || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    studentData = combined
-                }
-            } else {
-                const { data: baseRows, error } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (error) throw error
-                data = await hydrateWorkouts(baseRows || [])
-
-                if (!data.length) {
-                    try {
-                        const { data: anyRows, error: anyErr } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('user_id', currentUser.id)
-                            .order('name', { ascending: true })
-                            .limit(500);
-                        if (!anyErr && Array.isArray(anyRows) && anyRows.length) {
-                            data = await hydrateWorkouts(anyRows);
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const { data: studentRow } = await supabase
-                            .from('students')
-                            .select('id')
-                            .eq('user_id', currentUser.id)
-                            .maybeSingle();
-                        const studentId = studentRow?.id ? String(studentRow.id) : '';
-                        if (studentId) {
-                            const { data: legacyBase } = await supabase
-                                .from('workouts')
-                                .select('*')
-                                .eq('is_template', true)
-                                .or(`user_id.eq.${studentId},student_id.eq.${studentId}`)
-                                .order('name', { ascending: true })
-                                .limit(500);
-                            const legacyHydrated = await hydrateWorkouts(legacyBase || []);
-                            const seen = new Set();
-                            const merged = [];
-                            for (const w of legacyHydrated) {
-                                if (!w?.id) continue;
-                                if (seen.has(w.id)) continue;
-                                seen.add(w.id);
-                                merged.push(w);
-                            }
-                            data = merged;
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const resLegacy = await fetch('/api/workouts/list', { cache: 'no-store' });
-                        const jsonLegacy = await resLegacy.json().catch(() => null);
-                        if (jsonLegacy?.ok && Array.isArray(jsonLegacy.rows) && jsonLegacy.rows.length) {
-                            data = (jsonLegacy.rows || []).map((w) => ({
-                                id: w?.id,
-                                name: w?.name,
-                                notes: null,
-                                is_template: true,
-                                user_id: currentUser.id,
-                                created_by: null,
-                                exercises: [],
-                            }));
-                        }
-                    } catch {}
-                }
-            }
-
-			if (Array.isArray(data)) {
-				const mappedRaw = data
-					.map((row) => mapWorkoutRow(row))
-					.filter(Boolean);
-                const mapped = mappedRaw.sort((a, b) => {
-                    const ao = Number.isFinite(Number(a?.sort_order)) ? Number(a.sort_order) : 0
-                    const bo = Number.isFinite(Number(b?.sort_order)) ? Number(b.sort_order) : 0
-                    if (ao !== bo) return ao - bo
-                    return (a.title || '').localeCompare(b.title || '')
-                });
-
-                try {
-                    await cacheSetWorkouts({ userId: currentUser?.id, workouts: mapped })
-                } catch {}
-
-                if (role === 'admin' || role === 'teacher') {
-                    setWorkouts(mapped)
-                    try {
-                        const studentMapped = (studentData || []).map(mapWorkoutRow)
-                        const byStudent = new Map()
-                        for (const w of studentMapped) {
-                            const sid = w.user_id
-                            if (!sid) continue
-                            const list = byStudent.get(sid) || []
-                            list.push(w)
-                            byStudent.set(sid, list)
-                        }
-                        const nameById = new Map()
-                        for (const s of (studentsList || [])) {
-                            const sid = s.user_id || s.id
-                            if (!sid) continue
-                            nameById.set(sid, { name: s.name || String(sid).slice(0,8), email: s.email || '' })
-                        }
-                        const folders = Array.from(byStudent.entries()).map(([sid, list]) => {
-                            const info = nameById.get(sid) || { name: String(sid).slice(0,8), email: '' }
-                            return { id: sid, name: info.name, email: info.email, workouts: list }
-                        }).filter(f => (f.workouts || []).length > 0)
-                        setStudentFolders(folders)
-                    } catch (err) {
-                        console.error("Erro ao processar alunos:", err);
-                        setStudentFolders([])
-                    }
-                } else {
-                    setWorkouts(mapped)
-                    try {
-                        const shared = mapped.filter(w => (w.created_by && w.created_by !== currentUser.id))
-                        const byCoach = new Map()
-                        for (const w of shared) {
-                            const cid = w.created_by
-                            const list = byCoach.get(cid) || []
-                            list.push(w)
-                            byCoach.set(cid, list)
-                        }
-                        const coachIds = Array.from(byCoach.keys())
-                        let profiles = []
-                        if (coachIds.length) {
-                            const { data: profs } = await supabase.from('profiles').select('id, display_name').in('id', coachIds)
-                            profiles = profs || []
-                        }
-                        const nameByCoach = new Map(profiles.map(p => [p.id, p.display_name || String(p.id).slice(0,8)]))
-                        const folders = Array.from(byCoach.entries()).map(([cid, list]) => ({
-                            id: cid,
-                            name: `Treinos compartilhados de ${nameByCoach.get(cid) || String(cid).slice(0,8)}`,
-                            email: '',
-                            workouts: list
-                        }))
-                        setStudentFolders(folders)
-                    } catch {
-                        setStudentFolders([])
-                    }
-                }
-                
-				// Atualiza estatísticas
-				const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-				setStats({ 
-					workouts: mapped.length, 
-					exercises: totalEx, 
-					activeStreak: 0 // Placeholder
-				});
-            } else {
-                console.warn('Fetch sem dados; mantendo estado atual');
-            }
-		} catch (e) {
-			const msg = e?.message ?? String(e);
-			if (msg.includes('Failed to fetch') || msg.includes('ERR_ABORTED')) {
-				// Dev HMR aborts or transient network; ignore quietly
-                try {
-                    const cached = await cacheGetWorkouts({ userId: specificUser?.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-				return;
-			}
-			console.error("Erro ao buscar:", { message: msg, error: e });
-		} finally { isFetching.current = false; }
-	}, [supabase, user]); // Depende apenas do usuário para evitar loops de busca
-
-    useEffect(() => {
-        if (user) {
-            fetchWorkouts(user);
-        }
-    }, [user, fetchWorkouts]);
-
-    useEffect(() => {
-        if (user && workouts.length === 0) {
-            try {
-                const k = 'workouts_cache_' + user.id;
-                const cached = localStorage.getItem(k);
-                if (cached) {
-                    const arr = JSON.parse(cached);
-                    if (Array.isArray(arr) && arr.length > 0) setWorkouts(arr);
-                }
-            } catch {}
-        }
-    }, [user, workouts.length]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        computeWorkoutStreakAndStats()
-            .then(res => {
-                if (res?.ok && res?.data) setStreakStats(res.data)
-            })
-            .catch(err => console.error('Erro ao calcular streak:', err));
-    }, [user?.id]);
-
-
-
-    // Handlers de Sessão
-    const handleLogout = async () => {
-        const ok = await confirm("Deseja realmente sair da sua conta?", "Sair");
-        if (!ok) return;
-        try { clearClientSessionState(); } catch {}
-        try { window.location.href = '/auth/logout'; } catch {}
-    };
-
-    const handleSaveProfile = async () => {
-        if (!user?.id) return;
-        const nextName = String(profileDraftName || '').trim();
-        if (!nextName) {
-            await alert('Informe seu nome para completar o perfil.', 'Perfil incompleto');
-            return;
-        }
-
-        setSavingProfile(true);
-        try {
-            const { data, error } = await supabase
-                .from('profiles')
-                .update({
-                    display_name: nextName,
-                    photo_url: user.photoURL ?? null,
-                    last_seen: new Date().toISOString(),
-                })
-                .eq('id', user.id)
-                .select('id')
-                .maybeSingle();
-            if (error) throw error;
-            if (!data?.id) {
-                await alert('Não foi possível salvar seu perfil (registro não encontrado).', 'Perfil');
-                return;
-            }
-            setProfileIncomplete(false);
-            setShowCompleteProfile(false);
-        } catch (e) {
-            await alert('Erro ao salvar perfil: ' + (e?.message || String(e || '')));
-        } finally {
-            setSavingProfile(false);
-        }
-    };
-
-    const handleStartSession = async (workout) => {
-        const exercisesList = Array.isArray(workout?.exercises)
-            ? workout.exercises.filter(ex => ex && typeof ex === 'object')
-            : [];
-
-        if (exercisesList.length === 0) {
-            await alert('Este treino está sem exercícios válidos. Edite o treino antes de iniciar.', 'Treino incompleto');
-            return;
-        }
-
-        const first = exercisesList[0] || {};
-        const exMin = toMinutesRounded(estimateExerciseSeconds(first));
-        const totalMin = toMinutesRounded(exercisesList.reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0));
-        const workoutTitle = String(workout?.title || workout?.name || 'Treino');
-        const ok = await confirm(`Iniciar "${workoutTitle}"? Primeiro exercício: ~${exMin} min. Estimado total: ~${totalMin} min.`, 'Iniciar Treino');
-        if (!ok) return;
-        let preCheckin = null
-        try {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const prompt = s ? s.promptPreWorkoutCheckin !== false : true
-            if (prompt) {
-                preCheckin = await requestPreWorkoutCheckin(workout)
-                if (preCheckin && user?.id) {
-                    const energyN = Number(preCheckin.energy)
-                    const sorenessN = Number(preCheckin.soreness)
-                    const timeN = Number(preCheckin.timeMinutes)
-                    const { error: checkinError } = await supabase.from('workout_checkins').insert({
-                        user_id: user.id,
-                        kind: 'pre',
-                        planned_workout_id: String(workout?.id || '').trim() ? workout.id : null,
-                        active_session_user_id: null,
-                        energy: Number.isFinite(energyN) && energyN >= 1 && energyN <= 5 ? Math.round(energyN) : null,
-                        soreness: Number.isFinite(sorenessN) && sorenessN >= 0 && sorenessN <= 10 ? Math.round(sorenessN) : null,
-                        notes: String(preCheckin.notes || '').trim() ? String(preCheckin.notes || '').trim() : null,
-                        answers: {
-                            time_minutes: Number.isFinite(timeN) && timeN > 0 ? Math.round(timeN) : null,
-                        },
-                    })
-                    if (checkinError) throw checkinError
-                }
-            }
-        } catch (e) {
-            console.warn('Falha ao salvar check-in pré-treino:', e?.message || String(e || ''))
-        }
-        let resolvedExercises = exercisesList;
-        try {
-            const resolved = await resolveExerciseVideos(exercisesList);
-            resolvedExercises = Array.isArray(resolved?.exercises) ? resolved.exercises : exercisesList;
-            persistExerciseVideoUrls(resolved?.updates || []);
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const enabled = s ? s.enableSounds !== false : true
-            const volumeRaw = Number(s?.soundVolume ?? 100)
-            const volume = Number.isFinite(volumeRaw) ? Math.max(0, Math.min(1, volumeRaw / 100)) : 1
-            playStartSound({ enabled, volume })
-        }
-        setActiveSession({
-            workout: { ...workout, exercises: resolvedExercises },
-            logs: {},
-            ui: {
-                baseExerciseCount: resolvedExercises.length,
-                pendingTemplateUpdate: false,
-                preCheckin: preCheckin && typeof preCheckin === 'object' ? preCheckin : null,
-            },
-            startedAt: Date.now(),
-            timerTargetTime: null,
-            timerContext: null
-        });
-        setView('active');
-        try {
-            const wid = String(workout?.id || '').trim() || null;
-            const title = String(workout?.title || workout?.name || 'Treino').trim();
-            fetch('/api/social/workout-start', {
-                method: 'POST',
-                headers: { 'content-type': 'application/json' },
-                body: JSON.stringify({ workout_id: wid, workout_title: title }),
-            }).catch(() => {});
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const allowPrompt = s ? s.notificationPermissionPrompt !== false : true
-            if (allowPrompt && typeof Notification !== 'undefined' && Notification.permission === 'default') {
-            Notification.requestPermission().catch(e => console.warn('Erro permissão notificação:', e));
-            }
-        }
-    };
-
-    const handleUpdateSessionLog = (key, data) => {
-        if (!activeSession) return;
-        setActiveSession(prev => {
-            if (!prev) return null;
-            return {
-                ...prev,
-                logs: { ...(prev.logs || {}), [key]: data }
-            };
-        });
-    };
-
-    const handleStartTimer = (duration, context) => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return {
-                ...prev,
-                timerTargetTime: Date.now() + (duration * 1000),
-                timerContext: context && typeof context === 'object' ? context : null
-            };
-        });
-    };
-
-    const handleCloseTimer = () => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return { ...prev, timerTargetTime: null, timerContext: null };
-        });
-    };
-
-	const handleFinishSession = async (sessionData, showReport) => {
-		suppressForeignFinishToastUntilRef.current = Date.now() + 8000;
-        try {
-            if (user?.id) {
-                localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-            }
-            localStorage.removeItem('activeSession');
-        } catch {}
-		setActiveSession(null);
-		if (showReport === false) {
-			setView('dashboard');
-			return;
-		}
-        setReportBackView('dashboard');
-        setReportData({ current: sessionData, previous: null });
-        setView('report');
-    };
-
-    // Handlers CRUD
-    const openManualWorkoutEditor = () => {
-        setCurrentWorkout({ title: '', exercises: [] })
-        setView('edit')
-    }
-	const handleCreateWorkout = () => { setCreateWizardOpen(true) };
-
-	const handleEditWorkout = async (workout) => {
-		if (!workout || !workout.id) return;
-		try {
-			const supabase = createClient();
-			const { data, error } = await supabase
-				.from('workouts')
-				.select('*, exercises(*, sets(*))')
-				.eq('id', workout.id)
-				.maybeSingle();
-			if (error) throw error;
-			if (!data) {
-				setCurrentWorkout(workout);
-				setView('edit');
-				return;
-			}
-			const mapped = mapWorkoutRow(data);
-            try {
-                const resolved = await resolveExerciseVideos(mapped?.exercises || []);
-                const exercises = Array.isArray(resolved?.exercises) ? resolved.exercises : (mapped?.exercises || []);
-                persistExerciseVideoUrls(resolved?.updates || []);
-                setCurrentWorkout({ ...mapped, exercises });
-            } catch {
-                setCurrentWorkout(mapped);
-            }
-			setView('edit');
-		} catch (e) {
-			const msg = e?.message || String(e || '');
-			await alert('Erro ao carregar treino para edição: ' + msg);
-		}
-	};
-
-    const handleSaveWorkout = useCallback(async (workoutToSave) => {
-        const w = workoutToSave || currentWorkout;
-        if (!user || !w || !w.title) return { ok: false, error: 'Treino inválido ou usuário ausente' };
-        try {
-            if (w.id) {
-                const res = await updateWorkout(w.id, w);
-                setCurrentWorkout(w);
-                return res;
-            } else {
-                const created = await createWorkout(w);
-                const id = created?.id ?? null;
-                setCurrentWorkout({ ...w, id });
-                return created;
-            }
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e || 'Falha ao salvar treino');
-            return { ok: false, error: msg };
-        }
-    }, [currentWorkout, user]);
-
-    const handlePersistWorkoutTemplateFromSession = useCallback(async (workoutFromSession) => {
-        try {
-            const normalized = normalizeWorkoutForEditor(workoutFromSession);
-            const cleaned = stripWorkoutInternalKeys(normalized);
-            if (!cleaned || !cleaned.title) return { ok: false, error: 'Treino inválido para salvar' };
-
-            if (cleaned.id) {
-                await updateWorkout(cleaned.id, cleaned);
-                try {
-                    await fetchWorkouts();
-                } catch {}
-                return { ok: true, mode: 'update' };
-            }
-
-            const created = await createWorkout(cleaned);
-            try {
-                await fetchWorkouts();
-            } catch {}
-            return { ok: true, mode: 'create', id: created?.id ?? null };
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e);
-            return { ok: false, error: msg || 'Falha ao salvar treino' };
-        }
-    }, [fetchWorkouts, normalizeWorkoutForEditor, stripWorkoutInternalKeys]);
-
-    const handleOpenActiveWorkoutEditor = useCallback((options = {}) => {
-        try {
-            if (!activeSession?.workout) return;
-            const base = normalizeWorkoutForEditor(activeSession.workout);
-            const shouldAddExercise = options && typeof options === 'object' ? !!options.addExercise : false;
-            editActiveAddExerciseRef.current = shouldAddExercise;
-            const nextBase = shouldAddExercise
-                ? {
-                    ...base,
-                    exercises: [
-                        ...(Array.isArray(base?.exercises) ? base.exercises : []),
-                        {
-                            name: '',
-                            sets: 4,
-                            reps: '10',
-                            rpe: '8',
-                            cadence: '2020',
-                            restTime: 60,
-                            method: 'Normal',
-                            videoUrl: '',
-                            notes: ''
-                        }
-                    ]
-                }
-                : base;
-            editActiveBaseRef.current = base;
-            setEditActiveDraft(nextBase);
-            setEditActiveOpen(true);
-        } catch {}
-    }, [activeSession?.workout, normalizeWorkoutForEditor]);
-
-    const handleCloseActiveWorkoutEditor = useCallback(() => {
-        try {
-            setEditActiveOpen(false);
-            setEditActiveDraft(null);
-            editActiveBaseRef.current = null;
-            editActiveAddExerciseRef.current = false;
-        } catch {}
-    }, []);
-
-    const handleSaveActiveWorkoutEditor = useCallback(async (workoutFromEditor) => {
-        const normalized = normalizeWorkoutForEditor(workoutFromEditor);
-        const cleaned = stripWorkoutInternalKeys(normalized);
-        const shouldDeferPersist = !!editActiveAddExerciseRef.current;
-        const res = shouldDeferPersist ? { deferred: true } : await handleSaveWorkout(cleaned);
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            const oldWorkout = editActiveBaseRef.current || normalizeWorkoutForEditor(prev.workout);
-            const nextLogs = reindexSessionLogsAfterWorkoutEdit(oldWorkout, normalized, prev.logs || {});
-            const baseUi = prev?.ui && typeof prev.ui === 'object' ? prev.ui : {};
-            const nextUi = shouldDeferPersist ? { ...baseUi, pendingTemplateUpdate: true } : baseUi;
-            return { ...prev, workout: normalized, logs: nextLogs, ui: nextUi };
-        });
-        editActiveBaseRef.current = normalized;
-        setEditActiveDraft(normalized);
-        return res;
-    }, [handleSaveWorkout, normalizeWorkoutForEditor, reindexSessionLogsAfterWorkoutEdit, stripWorkoutInternalKeys]);
-
-	const handleDeleteWorkout = async (id, title) => {
-		const name = title || (workouts.find(w => w.id === id)?.title) || 'este treino';
-		if (!(await confirm(`Apagar o treino "${name}"?`, "Excluir Treino"))) return;
-		try {
-			const res = await deleteWorkout(id);
-			if (!res?.success) {
-				await alert("Erro: " + (res?.error || 'Falha ao excluir treino'));
-				return;
-			}
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro: " + (e?.message ?? String(e))); }
-	};
-
-    const handleRestoreWorkout = async (workout) => {
-        const id = String(workout?.id || '').trim()
-        if (!id) return
-        const name = workout?.title || 'este treino'
-        if (!(await confirm(`Restaurar o treino "${name}"?`, 'Restaurar Treino'))) return
-        try {
-            const res = await setWorkoutArchived(id, false)
-            if (!res?.ok) {
-                await alert('Erro: ' + (res?.error || 'Falha ao restaurar treino'))
-                return
-            }
-            await fetchWorkouts()
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)))
-        }
-    }
-
-	const handleDuplicateWorkout = async (workout) => {
-		if (!(await confirm(`Duplicar "${workout.title}"?`, "Duplicar Treino"))) return;
-		const newWorkout = { ...workout, title: `${workout.title} (Cópia)` };
-		delete newWorkout.id;
-		try {
-			await createWorkout(newWorkout);
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro ao duplicar: " + (e?.message ?? String(e))); }
-	};
-
-    const handleBulkEditWorkouts = async (items) => {
-        try {
-            const arr = Array.isArray(items) ? items : []
-            if (!arr.length) return
-            let updatedTitles = 0
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const w = workouts.find((x) => String(x?.id || '') === id)
-                if (!w) continue
-
-                const desiredTitle = String(it?.title || '').trim() || String(w?.title || 'Treino')
-                if (desiredTitle !== String(w?.title || '')) {
-                    const r = await updateWorkout(id, { title: desiredTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                    if (!r?.ok) throw new Error(String(r?.error || 'Falha ao renomear treino'))
-                    updatedTitles += 1
-                }
-            }
-
-            let sortSaved = true
-            let sortError = ''
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const r2 = await setWorkoutSortOrder(id, i)
-                if (!r2?.ok) {
-                    sortSaved = false
-                    sortError = String(r2?.error || 'Falha ao ordenar treinos')
-                    break
-                }
-            }
-
-            await fetchWorkouts()
-
-            if (!sortSaved) {
-                const suffix = sortError ? `\n\n${sortError}` : ''
-                await alert(`Lista salva parcialmente: a ordenação não foi aplicada.${suffix}`)
-                return
-            }
-
-            if (updatedTitles) {
-                await alert(`Lista salva: ${updatedTitles} título(s) atualizado(s).`)
-            } else {
-                await alert('Lista salva.')
-            }
-        } catch (e) {
-            await alert('Erro ao salvar lista: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeAiWorkoutTitles = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const title = String(w?.title || '').trim()
-                    const m = title.match(/\(\s*dia\s*(\d+)\s*\)/i)
-                    if (!m?.[1]) return null
-                    const day = Number(m[1])
-                    if (!Number.isFinite(day) || day <= 0) return null
-                    return { workout: w, dayIndex: Math.floor(day - 1) }
-                })
-                .filter(Boolean)
-            if (!candidates.length) {
-                await alert('Nenhum treino no formato antigo “(Dia X)” foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar nomes de ${candidates.length} treinos gerados automaticamente?`, 'Padronizar nomes'))) return
-
-            let changed = 0
-            for (const item of candidates) {
-                const w = item.workout
-                const idx = item.dayIndex
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle, idx, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, { title: nextTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                changed += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${changed} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar nomes: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleApplyTitleRule = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            if (!list.length) {
-                await alert('Nenhum treino encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar títulos de ${list.length} treinos com A/B/C... e dia da semana?`, 'Padronizar títulos'))) return
-            let updated = 0
-            for (let i = 0; i < list.length; i += 1) {
-                const w = list[i]
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle || 'Treino', i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, {
-                    title: nextTitle,
-                    notes: w?.notes ?? '',
-                    exercises: Array.isArray(w?.exercises) ? w.exercises : [],
-                })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                updated += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${updated} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar títulos: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeExercises = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-                    let changesCount = 0
-                    const nextExercises = exercises.map((ex) => {
-                        const name = String(ex?.name || '').trim()
-                        if (!name) return ex
-                        const info = resolveCanonicalExerciseName(name)
-                        if (!info?.changed || !info?.canonical) return ex
-                        changesCount += 1
-                        return { ...ex, name: info.canonical }
-                    })
-                    if (!changesCount) return null
-                    return { workout: w, nextExercises, changesCount }
-                })
-                .filter(Boolean)
-
-            if (!candidates.length) {
-                await alert('Nenhum exercício para normalizar foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Normalizar exercícios em ${candidates.length} treinos?`, 'Normalizar exercícios'))) return
-
-            let updated = 0
-            const updatedWorkouts = []
-            for (const item of candidates) {
-                const w = item.workout
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const title = String(w?.title || '').trim() || `Treino ${id.slice(0, 8)}`
-                const notes = w?.notes ?? ''
-                const res = await updateWorkout(id, { title, notes, exercises: item.nextExercises })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao atualizar treino'))
-                updated += 1
-                updatedWorkouts.push({ title, changesCount: Number(item?.changesCount || 0) })
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            const lines = updatedWorkouts
-                .slice(0, 10)
-                .map((it) => `• ${it.title}${it.changesCount ? ` (${it.changesCount} exercício(s))` : ''}`)
-                .join('\n')
-            const more = updatedWorkouts.length > 10 ? `\n(+${updatedWorkouts.length - 10} outros)` : ''
-            const detail = lines ? `\n\nTreinos atualizados:\n${lines}${more}` : ''
-            await alert(`Normalização concluída: ${updated} treinos atualizados.${detail}`)
-        } catch (e) {
-            await alert('Erro ao normalizar exercícios: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleOpenDuplicates = async () => {
-        const list = (Array.isArray(workouts) ? workouts : []).filter((w) => !w?.archived_at)
-        const keys = list.map((w) => {
-            const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-            const set = new Set()
-            for (const ex of exercises) {
-                const name = String(ex?.name || '').trim()
-                if (!name) continue
-                const info = resolveCanonicalExerciseName(name)
-                const base = String(info?.canonical || name).trim()
-                const k = normalizeExerciseName(base)
-                if (k) set.add(k)
-            }
-            return set
-        })
-
-        const parent = Array.from({ length: list.length }).map((_, i) => i)
-        const find = (x) => {
-            let r = x
-            while (parent[r] !== r) r = parent[r]
-            let cur = x
-            while (parent[cur] !== cur) {
-                const p = parent[cur]
-                parent[cur] = r
-                cur = p
-            }
-            return r
-        }
-        const unite = (a, b) => {
-            const ra = find(a)
-            const rb = find(b)
-            if (ra !== rb) parent[rb] = ra
-        }
-
-        const similarity = (a, b) => {
-            const A = keys[a]
-            const B = keys[b]
-            if (!A?.size || !B?.size) return 0
-            let inter = 0
-            for (const v of A) if (B.has(v)) inter += 1
-            const union = A.size + B.size - inter
-            if (!union) return 0
-            return inter / union
-        }
-
-        const edges = []
-        for (let i = 0; i < list.length; i += 1) {
-            for (let j = i + 1; j < list.length; j += 1) {
-                const score = similarity(i, j)
-                if (score >= 0.9) {
-                    unite(i, j)
-                    edges.push({ i, j, score })
-                }
-            }
-        }
-
-        const groupsMap = new Map()
-        for (let i = 0; i < list.length; i += 1) {
-            const r = find(i)
-            const arr = groupsMap.get(r) || []
-            arr.push(i)
-            groupsMap.set(r, arr)
-        }
-
-        const groups = []
-        for (const idxs of groupsMap.values()) {
-            if (!idxs || idxs.length < 2) continue
-            let best = 0
-            for (const e of edges) {
-                if (idxs.includes(e.i) && idxs.includes(e.j)) best = Math.max(best, e.score)
-            }
-            groups.push({ items: idxs.map((i) => list[i]), score: best || 0.9 })
-        }
-
-        if (!groups.length) {
-            await alert('Não encontrei duplicados com alta similaridade.')
-            return
-        }
-        groups.sort((a, b) => b.score - a.score)
-        setDuplicateGroups(groups)
-        setDuplicatesOpen(true)
-    }
-
-    const handleArchiveDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Arquivar ${others.length} duplicados e manter "${base?.title || 'Treino'}"?`, 'Arquivar duplicados'))) return
-            setDuplicatesBusy(true)
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const res = await setWorkoutArchived(id, true)
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao arquivar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleMergeDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Mesclar ${others.length} duplicados em "${base?.title || 'Treino'}" e arquivar os demais?`, 'Mesclar duplicados'))) return
-            setDuplicatesBusy(true)
-
-            const baseExercises = Array.isArray(base?.exercises) ? base.exercises : []
-            const seen = new Set()
-            const merged = []
-            for (const ex of baseExercises) {
-                const name = String(ex?.name || '').trim()
-                const method = String(ex?.method || '').trim()
-                const reps = String(ex?.reps || '').trim()
-                const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                if (k && !seen.has(k)) {
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-            for (const w of others) {
-                const exs = Array.isArray(w?.exercises) ? w.exercises : []
-                for (const ex of exs) {
-                    const name = String(ex?.name || '').trim()
-                    const method = String(ex?.method || '').trim()
-                    const reps = String(ex?.reps || '').trim()
-                    const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                    if (!k || seen.has(k)) continue
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-
-            const baseId = String(base?.id || '').trim()
-            if (!baseId) throw new Error('Treino base sem ID')
-            const res = await updateWorkout(baseId, { title: String(base?.title || 'Treino'), notes: base?.notes ?? '', exercises: merged })
-            if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino mesclado'))
-
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const a = await setWorkoutArchived(id, true)
-                if (!a?.ok) throw new Error(String(a?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao mesclar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleShareWorkout = async (workout) => {
-        setExportWorkout(workout);
-        setShowExportModal(true);
-    };
-
-	const handleExportPdf = async () => {
-		if (!exportWorkout) return;
-		try {
-			const html = workoutPlanHtml(exportWorkout, user);
-			const win = window.open('', '_blank');
-			if (!win) return;
-			win.document.open();
-			win.document.write(html);
-			win.document.close();
-			win.focus();
-			setTimeout(() => { try { win.print(); } catch {} }, 300);
-			setShowExportModal(false);
-		} catch (e) { await alert('Erro ao gerar PDF: ' + (e?.message ?? String(e))); }
-	};
-
-    const handleExportJson = () => {
-        if (!exportWorkout) return;
-        const json = JSON.stringify({ workout: { title: exportWorkout.title, exercises: (exportWorkout.exercises || []).map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps, rpe: ex.rpe, cadence: ex.cadence, restTime: ex.restTime, method: ex.method, videoUrl: ex.videoUrl, notes: ex.notes })) } }, null, 2);
-        const blob = new Blob([json], { type: 'application/json' });
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement('a');
-        a.href = url;
-        a.download = `${(exportWorkout.title || 'treino').replace(/\s+/g,'_')}.json`;
-        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        setShowExportModal(false);
-    };
-
-    const handleExportAllWorkouts = async () => {
-        try {
-            setExportingAll(true);
-            const payload = {
-                user: { id: user?.id || '', email: user?.email || '' },
-                workouts: (workouts || []).map(w => ({
-                    id: w.id,
-                    title: w.title,
-                    notes: w.notes,
-                    is_template: true,
-                    exercises: (w.exercises || []).map(ex => ({
-                        name: ex.name,
-                        sets: ex.sets,
-                        reps: ex.reps,
-                        rpe: ex.rpe,
-                        cadence: ex.cadence,
-                        restTime: ex.restTime,
-                        method: ex.method,
-                        videoUrl: ex.videoUrl,
-                        notes: ex.notes
-                    }))
-                }))
-            };
-            const json = JSON.stringify(payload, null, 2);
-            const blob = new Blob([json], { type: 'application/json' });
-            const url = URL.createObjectURL(blob);
-            const a = document.createElement('a');
-            a.href = url;
-            a.download = `irontracks_workouts_${new Date().toISOString()}.json`;
-            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        } catch (e) {
-        } finally {
-            setExportingAll(false);
-        }
-    };
-
-    const handleImportWorkout = async () => {
-        await alert("Funcionalidade de importar código temporariamente indisponível na migração.", "Em Manutenção");
-    };
-
-    // JSON IMPORT HANDLER
-    const handleJsonUpload = (e) => {
-        const input = e?.target;
-        const file = input?.files?.[0];
-        if (!file) return;
-        try {
-            setShowJsonImportModal(false);
-        } catch {}
-
-        const reader = new FileReader();
-        reader.onload = async (event) => {
-            try {
-                const json = JSON.parse(event.target.result);
-                if (await confirm(`Importar dados de ${json.user?.email || 'Unknown'}? Isso criará novos treinos.`, "Importar Backup")) {
-                    await importData(json);
-                    await fetchWorkouts();
-                    await alert("Dados importados com sucesso!", "Sucesso");
-                }
-		} catch (err) {
-			await alert("Erro ao ler arquivo JSON: " + (err?.message ?? String(err)));
-		} finally {
-            try {
-                if (input) input.value = '';
-            } catch {}
-		}
-	};
-        reader.readAsText(file);
-    };
-
-    if (authLoading) return <LoadingScreen />;
-    if (!user?.id) return <LoadingScreen />;
-
-    const currentWorkoutId = activeSession?.workout?.id;
-    let nextWorkout = null;
-    if (currentWorkoutId && Array.isArray(workouts) && workouts.length > 0) {
-        const index = workouts.findIndex(w => w.id === currentWorkoutId);
-        if (index !== -1 && index + 1 < workouts.length) {
-            nextWorkout = workouts[index + 1];
-        }
-    }
-
-    const isHeaderVisible = view !== 'active' && view !== 'report';
-
-    return (
-        <InAppNotificationsProvider
-            userId={user?.id || null}
-            settings={userSettingsApi?.settings ?? null}
-            onOpenMessages={() => setView('chat')}
-            onOpenNotifications={() => {
-                setShowNotifCenter(true);
-                setHasUnreadNotification(false);
-            }}
-        >
-        <InAppNotifyBinder bind={bindInAppNotify} />
-        <TeamWorkoutProvider user={user} settings={userSettingsApi?.settings ?? null} onStartSession={handleStartSession}>
-            <div className="w-full bg-neutral-900 min-h-screen relative flex flex-col overflow-hidden" suppressHydrationWarning>
-                <IncomingInviteModal onStartSession={handleStartSession} />
-                <InviteAcceptedModal />
-                <GuidedTour
-                    open={Boolean(tourOpen)}
-                    steps={getTourSteps({
-                        role: user?.role,
-                        hasCommunity: (userSettingsApi?.settings?.moduleCommunity !== false),
-                    })}
-                    actions={{
-                        openAdminPanel: (tab) => {
-                            try {
-                                const safe = String(tab || 'dashboard').trim() || 'dashboard'
-                                openAdminPanel(safe)
-                            } catch {}
-                        },
-                    }}
-                    onEvent={(name, payload) => {
-                        logTourEvent(name, payload)
-                    }}
-                    onComplete={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: true, skipped: false, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'completed') } catch {}
-                        const res = await upsertTourFlags({ tour_completed_at: new Date().toISOString(), tour_skipped_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (completed). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_completed', { version: TOUR_VERSION })
-                    }}
-                    onSkip={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (skipped). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_skipped', { version: TOUR_VERSION })
-                    }}
-                    onCancel={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (cancelled). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_cancelled', { version: TOUR_VERSION })
-                    }}
-                />
-
-                {/* Header */}
-                {isHeaderVisible && (
-                    <div className="bg-neutral-950 flex justify-between items-center fixed top-0 left-0 right-0 z-40 border-b border-zinc-800 px-6 shadow-lg pt-[env(safe-area-inset-top)] min-h-[calc(4rem+env(safe-area-inset-top))]">
-                        <div 
-                            className="flex items-center cursor-pointer group"
-                            onClick={() => setView('dashboard')}
-                        >
-                            <div className="flex items-center gap-2">
-                                <Dumbbell size={18} className="text-yellow-500 opacity-25" />
-                                <h1 className="text-2xl font-black tracking-tighter italic leading-none text-white group-hover:opacity-80 transition-opacity">
-                                    IRON<span className="text-yellow-500">TRACKS</span>
-                                </h1>
-                            </div>
-                            <div className="h-6 w-px bg-yellow-500 mx-4 opacity-50"></div>
-                            <span className="text-zinc-400 text-xs font-medium tracking-wide uppercase">
-                                {isCoach ? 'Bem vindo Coach' : 'Bem vindo Atleta'}
-                            </span>
-                        </div>
-                        
-                        <div className="flex items-center gap-4">
-                                {(() => {
-                                    const pending = Number(syncState?.pending || 0)
-                                    const failed = Number(syncState?.failed || 0)
-                                    const online = syncState?.online !== false
-                                    const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-                                    const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-                                    if (!online) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-xs font-black uppercase tracking-widest">
-                                                Offline
-                                            </div>
-                                        )
-                                    }
-                                    if (offlineSyncV2Enabled && (pending > 0 || failed > 0)) {
-                                        return (
-                                            <button
-                                                type="button"
-                                                onClick={() => setOfflineSyncOpen(true)}
-                                                className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest hover:bg-yellow-500/15"
-                                                title="Abrir central de pendências"
-                                            >
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}{failed > 0 ? ` • Falhas: ${failed}` : ''}
-                                            </button>
-                                        )
-                                    }
-                                    if (pending > 0) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest">
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}
-                                            </div>
-                                        )
-                                    }
-                                    return null
-                                })()}
-                                <HeaderActionsMenu
-                                user={user}
-                                isCoach={isCoach}
-                                hasUnreadChat={hasUnreadChat}
-                                hasUnreadNotification={hasUnreadNotification}
-                                onOpenAdmin={() => {
-                                    if (typeof window !== 'undefined') {
-                                        const url = new URL(window.location);
-                                        url.searchParams.delete('view');
-                                        window.history.replaceState({}, '', url);
-                                    }
-                                    const tab = (() => {
-                                        try {
-                                            const url = new URL(window.location.href);
-                                            const current = String(url.searchParams.get('tab') || '').trim();
-                                            if (current) return current;
-                                        } catch {}
-                                        try {
-                                            const stored = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-                                            if (stored) return stored;
-                                        } catch {}
-                                        return 'dashboard';
-                                    })();
-                                    openAdminPanel(tab);
-                                }}
-                                onOpenChatList={() => setView('chatList')}
-                                onOpenGlobalChat={() => setView('globalChat')}
-                                onOpenHistory={() => setView('history')}
-                                onOpenNotifications={() => {
-                                    setShowNotifCenter(true);
-                                    setHasUnreadNotification(false);
-                                }}
-                                onOpenSchedule={() => router.push('/dashboard/schedule')}
-                                onOpenSettings={() => setSettingsOpen(true)}
-                                onOpenTour={async () => {
-                                    try {
-                                        await logTourEvent('tour_started', { auto: false, version: TOUR_VERSION })
-                                    } catch {}
-                                    setTourOpen(true)
-                                }}
-                                onLogout={handleLogout}
-                            />
-                        </div>
-                    </div>
-                )}
-
-                {isCoach && coachPending && (
-                    <div className="bg-yellow-500 text-black text-sm font-bold px-4 py-2 text-center">
-                        Sua conta de Professor está pendente. <button className="underline" onClick={async () => { try { const r = await fetch('/api/teachers/accept', { method: 'POST' }); const j = await r.json(); if (j.ok) { setCoachPending(false); await alert('Conta ativada!'); } else { await alert('Falha ao ativar: ' + (j.error || '')); } } catch (e) { await alert('Erro: ' + (e?.message ?? String(e))); } }}>Aceitar</button>
-                    </div>
-                )}
-
-                {/* Main Content */}
-                <div
-                    className="flex-1 overflow-y-auto custom-scrollbar relative"
-                    style={{
-                        '--dashboard-sticky-top': isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : '0px',
-                        paddingTop: isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : undefined,
-                    }}
-                >
-                    {(view === 'dashboard' || view === 'assessments' || view === 'community' || view === 'vip') && (
-                        <StudentDashboard
-                            workouts={Array.isArray(workouts) ? workouts : []}
-                            profileIncomplete={Boolean(profileIncomplete)}
-                            onOpenCompleteProfile={() => setShowCompleteProfile(true)}
-                            view={view === 'assessments' ? 'assessments' : view === 'community' ? 'community' : view === 'vip' ? 'vip' : 'dashboard'}
-                            onChangeView={(next) => setView(next)}
-                            assessmentsContent={(user?.id || initialUser?.id) ? <AssessmentHistory studentId={user?.id || initialUser?.id} /> : null}
-                            communityContent={(user?.id || initialUser?.id) ? <CommunityClient embedded /> : null}
-                            vipContent={<VipHub user={user} locked={!vipAccess?.hasVip} onOpenWorkoutEditor={(w) => handleEditWorkout(w)} onOpenVipTab={() => setView('vip')} />}
-                            vipLabel="VIP"
-                            vipLocked={!vipAccess?.hasVip}
-                            vipEnabled={true}
-                            settings={userSettingsApi?.settings ?? null}
-                            onCreateWorkout={handleCreateWorkout}
-                            onQuickView={(w) => setQuickViewWorkout(w)}
-                            onStartSession={(w) => handleStartSession(w)}
-                            onRestoreWorkout={(w) => handleRestoreWorkout(w)}
-                            onShareWorkout={(w) => handleShareWorkout(w)}
-                            onDuplicateWorkout={(w) => handleDuplicateWorkout(w)}
-                            onEditWorkout={(w) => handleEditWorkout(w)}
-                            onDeleteWorkout={(id, title) => handleDeleteWorkout(id, title)}
-                            onBulkEditWorkouts={handleBulkEditWorkouts}
-                            currentUserId={user?.id || initialUser?.id}
-                            exportingAll={Boolean(exportingAll)}
-                            onExportAll={handleExportAllWorkouts}
-                            streakStats={streakStats}
-                            onOpenJsonImport={() => setShowJsonImportModal(true)}
-                            onNormalizeAiWorkoutTitles={handleNormalizeAiWorkoutTitles}
-                            onNormalizeExercises={handleNormalizeExercises}
-                            onOpenDuplicates={handleOpenDuplicates}
-                            onApplyTitleRule={handleApplyTitleRule}
-                            onOpenIronScanner={async () => {
-                                try {
-                                    openManualWorkoutEditor()
-                                    await alert('No editor, clique em Scanner de Treino (Imagem).', 'Scanner')
-                                } catch {}
-                            }}
-                        />
-                    )}
-
-                    <WorkoutWizardModal
-                        isOpen={createWizardOpen}
-                        onClose={() => setCreateWizardOpen(false)}
-                        onManual={() => openManualWorkoutEditor()}
-                        onGenerate={async (answers, options) => {
-                            const mode = String(options?.mode || 'single').trim().toLowerCase();
-                            try {
-                                const res = await fetch('/api/ai/workout-wizard', {
-                                    method: 'POST',
-                                    headers: { 'Content-Type': 'application/json' },
-                                    body: JSON.stringify({ answers, mode }),
-                                })
-                                const data = await res.json().catch(() => null)
-                                if (!res.ok) {
-                                    const msg = data?.error ? String(data.error) : 'Falha ao gerar treino com IA.'
-                                    throw new Error(msg)
-                                }
-                                if (mode === 'program') {
-                                    const drafts = Array.isArray(data?.drafts) ? data.drafts : null
-                                    if (drafts && drafts.length) return { drafts }
-                                    if (data?.ok === false && Array.isArray(data?.drafts) && data.drafts.length) return { drafts: data.drafts }
-                                    throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                                }
-                                const draft = data?.draft && typeof data.draft === 'object' ? data.draft : null
-                                if (draft?.exercises && Array.isArray(draft.exercises) && draft.exercises.length > 0) return draft
-                                if (data?.ok === false && data?.draft) return data.draft
-                                throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                const lower = msg.toLowerCase()
-                                const isConfig = lower.includes('api de ia não configurada') || lower.includes('google_generative_ai_api_key')
-                                if (isConfig) throw e
-                                if (mode === 'program') {
-                                    const days = Math.max(2, Math.min(6, Number(answers?.daysPerWeek || 3) || 3))
-                                    const drafts = []
-                                    for (let i = 0; i < days; i++) {
-                                        drafts.push(generateWorkoutFromWizard(answers, i))
-                                    }
-                                    return { drafts }
-                                }
-                                return generateWorkoutFromWizard(answers, 0)
-                            }
-                        }}
-                        onSaveDrafts={async (drafts) => {
-                            const list = Array.isArray(drafts) ? drafts : []
-                            if (!list.length) return
-                            try {
-                                for (let i = 0; i < list.length; i += 1) {
-                                    const d = list[i]
-                                    const baseTitle = String(d?.title || 'Treino').trim() || 'Treino'
-                                    const finalTitle = formatProgramWorkoutTitle(baseTitle, i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                                    const exercises = Array.isArray(d?.exercises) ? d.exercises : []
-                                    const res = await createWorkout({ title: finalTitle, exercises })
-                                    if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino'))
-                                }
-                                try {
-                                    await fetchWorkouts()
-                                } catch {}
-                                setCreateWizardOpen(false)
-                                await alert(`Plano salvo: ${list.length} treinos criados.`)
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                await alert('Erro ao salvar plano: ' + msg)
-                            }
-                        }}
-                        onUseDraft={(draft) => {
-                            try {
-                                const title = String(draft?.title || '').trim() || 'Treino'
-                                const exercises = Array.isArray(draft?.exercises) ? draft.exercises : []
-                                setCurrentWorkout({ title, exercises })
-                                setView('edit')
-                            } finally {
-                                setCreateWizardOpen(false)
-                            }
-                        }}
-                    />
-
-					{view === 'edit' && (
-						<ExerciseEditor
-							workout={currentWorkout}
-							onCancel={() => setView('dashboard')}
-							onChange={setCurrentWorkout}
-							onSave={handleSaveWorkout}
-							onSaved={() => {
-								fetchWorkouts().catch(() => {});
-								setView('dashboard');
-							}}
-						/>
-					)}
-
-                    {view === 'active' && activeSession && (
-                        <ActiveWorkout
-                            session={activeSession}
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onUpdateLog={handleUpdateSessionLog}
-                            onFinish={handleFinishSession}
-                            onPersistWorkoutTemplate={handlePersistWorkoutTemplateFromSession}
-                            onBack={() => setView('dashboard')}
-                            onStartTimer={handleStartTimer}
-                            isCoach={isCoach}
-                            onUpdateSession={(updates) => setActiveSession(prev => ({ ...prev, ...updates }))}
-                            nextWorkout={nextWorkout}
-                            onEditWorkout={() => handleOpenActiveWorkoutEditor()}
-                            onAddExercise={() => handleOpenActiveWorkoutEditor({ addExercise: true })}
-                        />
-                    )}
-
-                    {editActiveOpen && view === 'active' && editActiveDraft && (
-                        <div
-                            className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3 md:p-6 pt-safe"
-                            onClick={() => handleCloseActiveWorkoutEditor()}
-                        >
-                            <div
-                                className="w-full max-w-5xl h-[92vh] bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-                                onClick={(e) => e.stopPropagation()}
-                            >
-                                <ExerciseEditor
-                                    workout={editActiveDraft}
-                                    onCancel={() => handleCloseActiveWorkoutEditor()}
-                                    onChange={(w) => setEditActiveDraft(normalizeWorkoutForEditor(w))}
-                                    onSave={handleSaveActiveWorkoutEditor}
-                                    onSaved={() => {
-                                        fetchWorkouts().catch(() => {});
-                                        handleCloseActiveWorkoutEditor();
-                                    }}
-                                />
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'history' && (
-                        <HistoryList
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onViewReport={(s) => { setReportBackView('history'); setReportData({ current: s, previous: null }); setView('report'); }}
-                            onBack={() => setView('dashboard')}
-                        />
-                    )}
-
-                    {/* Evolução removida conforme solicitação */}
-
-                    {view === 'report' && reportData.current && (
-                        <div className="fixed inset-0 z-[1200] bg-neutral-900 overflow-y-auto pt-safe">
-                            <WorkoutReport
-                                session={reportData.current}
-                                previousSession={reportData.previous}
-                                user={user}
-                                settings={userSettingsApi?.settings ?? null}
-                                onClose={() => setView(reportBackView || 'dashboard')}
-                            />
-                        </div>
-                    )}
-
-                    {duplicatesOpen && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe" onClick={() => !duplicatesBusy && setDuplicatesOpen(false)}>
-                            <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Ferramentas</div>
-                                        <div className="text-white font-black text-lg truncate">Duplicados</div>
-                                        <div className="text-xs text-neutral-400 truncate">{Array.isArray(duplicateGroups) ? `${duplicateGroups.length} grupos` : ''}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => setDuplicatesOpen(false)}
-                                        disabled={duplicatesBusy}
-                                        className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center disabled:opacity-50"
-                                        aria-label="Fechar"
-                                    >
-                                        <X size={18} />
-                                    </button>
-                                </div>
-                                <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-                                    {(Array.isArray(duplicateGroups) ? duplicateGroups : []).map((g, idx) => {
-                                        const items = Array.isArray(g?.items) ? g.items : []
-                                        const score = Number(g?.score || 0)
-                                        const base = items[0]
-                                        return (
-                                            <div key={`dup-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-4">
-                                                <div className="flex items-start justify-between gap-3">
-                                                    <div className="min-w-0">
-                                                        <div className="text-xs text-neutral-500 font-bold uppercase tracking-widest">Similaridade</div>
-                                                        <div className="text-white font-black truncate">{base?.title || 'Treino'}</div>
-                                                        <div className="text-xs text-neutral-400">{Math.round(score * 100)}%</div>
-                                                    </div>
-                                                    <div className="flex items-center gap-2">
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleMergeDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 disabled:opacity-50"
-                                                        >
-                                                            Mesclar
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleArchiveDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 disabled:opacity-50"
-                                                        >
-                                                            Arquivar
-                                                        </button>
-                                                    </div>
-                                                </div>
-                                                <div className="mt-3 space-y-2">
-                                                    {items.map((w, wi) => (
-                                                        <div key={`dup-item-${idx}-${wi}`} className="flex items-center justify-between gap-3 rounded-lg bg-neutral-900/40 border border-neutral-800 px-3 py-2">
-                                                            <div className="min-w-0">
-                                                                <div className="text-sm font-bold text-white truncate">{String(w?.title || 'Treino')}</div>
-                                                                <div className="text-[11px] text-neutral-500 font-mono">{Array.isArray(w?.exercises) ? w.exercises.length : 0} EXERCÍCIOS</div>
-                                                            </div>
-                                                            <div className="text-[11px] font-bold text-neutral-500">{wi === 0 ? 'BASE' : 'DUP'}</div>
-                                                        </div>
-                                                    ))}
-                                                </div>
-                                            </div>
-                                        )
-                                    })}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {showExportModal && exportWorkout && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowExportModal(false)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Como deseja exportar?</h3>
-                                    <BackButton onClick={() => setShowExportModal(false)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-3">
-                                    <button onClick={handleExportPdf} className="w-full px-4 py-3 bg-yellow-500 text-black font-bold rounded-xl">Baixar PDF</button>
-                                    <button onClick={handleExportJson} className="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl">Baixar JSON</button>
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {openStudent && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setOpenStudent(null)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Treinos de {openStudent.name}</h3>
-                                    <BackButton onClick={() => setOpenStudent(null)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-2 max-h-[70vh] overflow-y-auto">
-                                    {(openStudent.workouts || []).length === 0 && (
-                                        <p className="text-neutral-500 text-sm">Nenhum treino encontrado.</p>
-                                    )}
-                                    {(openStudent.workouts || []).map(w => (
-                                        <div key={w.id} className="p-3 rounded-xl border border-neutral-700 bg-neutral-800">
-                                            <div className="flex items-center justify-between">
-                                                <span className="text-white font-bold text-sm">{w.title}</span>
-                                                <span className="text-xs text-neutral-400">{w.exercises?.length || 0} exercícios</span>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'chat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'globalChat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'chatList' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatListScreen user={user} onClose={() => setView('dashboard')} onSelectChannel={(c) => { setDirectChat(c); setView('directChat'); }} />
-                        </div>
-                    )}
-
-                    {view === 'directChat' && directChat && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatDirectScreen user={user} otherUserId={directChat.other_user_id} otherUserName={directChat.other_user_name} otherUserPhoto={directChat.other_user_photo} onClose={() => setView('chatList')} />
-                        </div>
-                    )}
-
-                    {view === 'admin' && (
-                        <div className="fixed inset-0 z-[60]">
-                            <AdminPanelV2 user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-                </div>
-
-                {/* Modals & Overlays */}
-                {showCompleteProfile && (
-                    <div className="fixed inset-0 z-[85] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <div className="flex items-center justify-between gap-3 mb-4">
-                                <h3 className="font-black text-white">Completar Perfil</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-
-                            <label className="block text-xs font-bold uppercase tracking-widest text-neutral-500 mb-2">
-                                Nome de Exibição
-                            </label>
-                            <input
-                                value={profileDraftName}
-                                onChange={(e) => setProfileDraftName(e.target.value)}
-                                placeholder="Ex: João Silva"
-                                className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-yellow-500"
-                            />
-
-                            <div className="flex gap-2 mt-5">
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-300 disabled:opacity-50"
-                                >
-                                    Cancelar
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={handleSaveProfile}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-yellow-500 rounded-xl font-black text-black disabled:opacity-50"
-                                >
-                                    {savingProfile ? 'Salvando...' : 'Salvar'}
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                {showImportModal && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <h3 className="font-bold text-white mb-4">Importar Treino (Código)</h3>
-                            <input
-                                value={importCode}
-                                onChange={e => setImportCode(e.target.value)}
-                                placeholder="Cole o código do treino aqui"
-                                className="w-full bg-neutral-800 p-4 rounded-xl mb-4 text-white font-mono text-center uppercase"
-                            />
-                            <div className="flex gap-2">
-                                <button onClick={() => setShowImportModal(false)} className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-400">Cancelar</button>
-                                <button onClick={handleImportWorkout} className="flex-1 p-3 bg-blue-600 rounded-xl font-bold text-white">Importar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                
-                {showJsonImportModal && (
-                     <div className="fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <Upload size={48} className="mx-auto text-blue-500 mb-4" />
-                            <h3 className="font-bold text-white mb-2 text-xl">Restaurar Backup</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Selecione o arquivo .json que você salvou anteriormente.</p>
-                            
-                            <label className="block w-full cursor-pointer bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-colors">
-                                Selecionar Arquivo
-                                <input type="file" accept=".json" onChange={handleJsonUpload} className="hidden" />
-                            </label>
-                            
-                            <button onClick={() => setShowJsonImportModal(false)} className="mt-4 text-neutral-500 text-sm hover:text-white">Cancelar</button>
-                        </div>
-                    </div>
-                )}
-
-                {shareCode && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-black"><Check size={32} /></div>
-                            <h3 className="font-bold text-white mb-2">Link Gerado!</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Envie este código para seu aluno ou amigo.</p>
-                            <div className="bg-black p-4 rounded-xl font-mono text-yellow-500 text-xl mb-4 tracking-widest select-all">
-                                {shareCode}
-                            </div>
-                            <button onClick={() => setShareCode(null)} className="w-full p-3 bg-neutral-800 rounded-xl font-bold text-white">Fechar</button>
-                        </div>
-                    </div>
-                )}
-
-                {quickViewWorkout && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setQuickViewWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-lg rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">{String(quickViewWorkout?.title || '')}</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setQuickViewWorkout(null)}
-                                    className="flex items-center gap-2 text-yellow-500 hover:text-yellow-400 transition-colors py-2 px-3 rounded-xl hover:bg-neutral-800 active:opacity-70"
-                                    aria-label="Voltar"
-                                >
-                                    <ArrowLeft size={20} />
-                                    <span className="font-semibold text-sm">Voltar</span>
-                                </button>
-                            </div>
-                            <div className="p-4 max-h-[60vh] overflow-y-auto space-y-3 custom-scrollbar">
-                                {(Array.isArray(quickViewWorkout?.exercises) ? quickViewWorkout.exercises : []).map((ex, idx) => (
-                                    <div key={idx} className="p-3 rounded-xl bg-neutral-800/50 border border-neutral-700">
-                                        <div className="flex justify-between items-center">
-                                            <h4 className="font-bold text-white text-sm">{String(ex?.name || '—')}</h4>
-                                            <span className="text-xs text-neutral-400">{(parseInt(ex?.sets) || 0)} x {String(ex?.reps || '-')}</span>
-                                        </div>
-                                        <div className="text-xs text-neutral-400 mt-1 flex items-center gap-2">
-                                            <Clock size={14} className="text-yellow-500" /><span>Descanso: {ex?.restTime ? `${parseInt(ex.restTime)}s` : '-'}</span>
-                                        </div>
-                                        {ex?.notes && <p className="text-sm text-neutral-300 mt-2">{String(ex.notes || '')}</p>}
-                                    </div>
-                                ))}
-                                {(!Array.isArray(quickViewWorkout?.exercises) || quickViewWorkout.exercises.length === 0) && (
-                                    <p className="text-neutral-400 text-sm">Este treino não tem exercícios.</p>
-                                )}
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex gap-2">
-                                <button onClick={() => { const w = quickViewWorkout; setQuickViewWorkout(null); handleStartSession(w); }} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl">Iniciar Treino</button>
-                                <button onClick={() => setQuickViewWorkout(null)} className="flex-1 p-3 bg-neutral-800 text-white font-bold rounded-xl">Fechar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {showNotifCenter && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowNotifCenter(false)}>
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">Notificações</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowNotifCenter(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 relative">
-                                <NotificationCenter user={user} onStartSession={handleStartSession} embedded />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {activeSession?.timerTargetTime && (
-                    <RestTimerOverlay
-                        targetTime={activeSession.timerTargetTime}
-                        context={activeSession.timerContext}
-                        settings={userSettingsApi?.settings ?? null}
-                        onClose={handleCloseTimer}
-                        onFinish={handleCloseTimer}
-                    />
-                )}
-
-                {activeSession && view !== 'active' && (
-                    <div className="fixed bottom-0 left-0 right-0 z-[1100]">
-                        <div className="bg-neutral-900/95 backdrop-blur border-t border-neutral-800 px-4 py-3 pb-[max(env(safe-area-inset-bottom),12px)]">
-                            <div className="flex items-center gap-4">
-                                <div className="flex-1 min-w-0">
-                                    <h3 className="font-bold text-white truncate">{activeSession.workout?.title || 'Treino em andamento'}</h3>
-                                    <div className="flex items-center gap-3 text-xs text-neutral-300 mt-1">
-                                        <span className="font-mono text-yellow-500">{(() => { const end = sessionTicker || activeSession.startedAt; const s = Math.max(0, Math.floor((end - activeSession.startedAt) / 1000)); const m = Math.floor(s/60), sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; })()}</span>
-                                        <span className="text-neutral-500">tempo atual</span>
-                                        <span className="opacity-30">•</span>
-                                        <span className="font-mono text-neutral-200">{(() => { const total = (activeSession.workout?.exercises || []).reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0); return `${toMinutesRounded(total)} min`; })()}</span>
-                                        <span className="text-neutral-500">estimado total</span>
-                                    </div>
-                                    <div className="h-1 bg-neutral-700 rounded-full overflow-hidden mt-2">
-                                        {(() => {
-                                            const exCount = (activeSession.workout?.exercises || []).length;
-                                            let percent = 0;
-                                            if (exCount) {
-                                                const done = new Set();
-                                                if (activeSession.logs) {
-                                                    Object.keys(activeSession.logs).forEach(k => {
-                                                        const i = parseInt(k.split('-')[0]) || 0;
-                                                        done.add(i);
-                                                    });
-                                                }
-                                                const current = Math.min(done.size, exCount);
-                                                percent = Math.round((current / exCount) * 100);
-                                            }
-                                            return <div className="h-full bg-yellow-500" style={{ width: `${percent}%` }}></div>
-                                        })()}
-                                    </div>
-                                </div>
-                                <button className="shrink-0 px-4 py-2 bg-yellow-500 text-black font-black rounded-xl hover:bg-yellow-400" onClick={() => setView('active')}>Voltar pro treino</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {/* Admin Panel Modal controlled by State */}
-                {showAdminPanel && (
-                    <AdminPanelV2 user={user} onClose={closeAdminPanel} />
-                )}
-
-                {whatsNewOpen && (
-                    <WhatsNewModal
-                        isOpen={whatsNewOpen}
-                        entry={getLatestWhatsNew()}
-                        onClose={closeWhatsNew}
-                    />
-                )}
-
-                {preCheckinOpen && (
-                    <div
-                        className="fixed inset-0 z-[1300] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-                        onClick={() => {
-                            setPreCheckinOpen(false)
-                            const r = preCheckinResolveRef.current
-                            preCheckinResolveRef.current = null
-                            if (typeof r === 'function') r(null)
-                        }}
-                    >
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Check-in</div>
-                                    <div className="text-white font-black text-lg truncate">Pré-treino</div>
-                                    <div className="text-xs text-neutral-400 truncate">{String(preCheckinWorkout?.title || preCheckinWorkout?.name || 'Treino')}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-4">
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Energia (1–5)</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[1, 2, 3, 4, 5].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, energy: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.energy || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Dor / Soreness (0–10)</div>
-                                    <select
-                                        value={String(preCheckinDraft?.soreness ?? '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, soreness: String(e.target.value || '') }))}
-                                        className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                                    >
-                                        <option value="">Não informar</option>
-                                        {Array.from({ length: 11 }).map((_, i) => (
-                                            <option key={i} value={String(i)}>
-                                                {i}
-                                            </option>
-                                        ))}
-                                    </select>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Tempo disponível</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[30, 45, 60, 90, 120].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, timeMinutes: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.timeMinutes || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}m
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Observações (opcional)</div>
-                                    <textarea
-                                        value={String(preCheckinDraft?.notes || '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, notes: String(e.target.value || '') }))}
-                                        className="w-full min-h-[90px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none"
-                                        placeholder="Ex.: pouco sono, dor no joelho, viagem…"
-                                    />
-                                </div>
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex items-center gap-2">
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-                                >
-                                    Pular
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(preCheckinDraft)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-                                >
-                                    Continuar
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {settingsOpen && (
-                    <SettingsModal
-                        isOpen={settingsOpen}
-                        onClose={() => setSettingsOpen(false)}
-                        settings={userSettingsApi?.settings ?? null}
-                        userRole={user?.role || ''}
-                        saving={Boolean(userSettingsApi?.saving)}
-                        onOpenWhatsNew={() => {
-                            setSettingsOpen(false)
-                            setWhatsNewOpen(true)
-                        }}
-                        onSave={async (next) => {
-                            try {
-                                const safeNext = next && typeof next === 'object' ? next : (userSettingsApi?.settings ?? {})
-                                const res = await userSettingsApi?.save?.(safeNext)
-                                if (!res?.ok) {
-                                    await alert('Falha ao salvar: ' + (res?.error || ''))
-                                    return false
-                                }
-                                return true
-                            } catch (e) {
-                                await alert('Falha ao salvar: ' + (e?.message ?? String(e)))
-                                return false
-                            }
-                        }}
-                    />
-                )}
-
-                <OfflineSyncModal
-                    open={offlineSyncOpen}
-                    onClose={() => setOfflineSyncOpen(false)}
-                    userId={user?.id}
-                />
-            </div>
-        </TeamWorkoutProvider>
-        </InAppNotificationsProvider>
-    );
-}
-
-export default function IronTracksAppClient({ initialUser, initialProfile, initialWorkouts }) {
-    const [isMounted, setIsMounted] = useState(false);
-    useEffect(() => {
-        const t = setTimeout(() => {
-            setIsMounted(true);
-        }, 0);
-        return () => clearTimeout(t);
-    }, []);
-    if (!isMounted) return <LoadingScreen />;
-    return (
-        <DialogProvider>
-            <ErrorReporterProvider>
-                <ErrorBoundary>
-                    <IronTracksApp initialUser={initialUser} initialProfile={initialProfile} initialWorkouts={initialWorkouts} />
-                </ErrorBoundary>
-                <GlobalDialog />
-            </ErrorReporterProvider>
-        </DialogProvider>
-    );
-}
diff --git a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 8.js b/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 8.js
deleted file mode 100644
index 15eeb0a..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/IronTracksAppClient 8.js	
+++ /dev/null
@@ -1,3590 +0,0 @@
-'use client';
-
-import React, { useState, useEffect, useCallback, Suspense, useRef } from 'react';
-import { useRouter } from 'next/navigation';
-import dynamic from 'next/dynamic';
-import Image from 'next/image';
-import {
-    RotateCcw,
-    History,
-    MoreVertical,
-    Share2,
-    Trash2,
-    Download,
-    Copy,
-    Plus,
-    Flame,
-    Play,
-    Dumbbell,
-    Check,
-    LogOut,
-    Clock,
-    Upload,
-    ArrowLeft,
-    X,
-    Crown
-} from 'lucide-react';
-import { createClient } from '@/utils/supabase/client';
-import { createWorkout, updateWorkout, deleteWorkout, importData, computeWorkoutStreakAndStats, setWorkoutArchived, setWorkoutSortOrder } from '@/actions/workout-actions';
-
-import LoginScreen from '@/components/LoginScreen';
-import AdminPanelV2 from '@/components/AdminPanelV2';
-import ChatScreen from '@/components/ChatScreen';
-import ChatListScreen from '@/components/ChatListScreen';
-import ChatDirectScreen from '@/components/ChatDirectScreen';
-import HistoryList from '@/components/HistoryList';
-import CommunityClient from '@/app/(app)/community/CommunityClient';
-import StudentEvolution from '@/components/StudentEvolution';
-import WorkoutReport from '@/components/WorkoutReport';
-import ActiveWorkout from '@/components/ActiveWorkout';
-import RestTimerOverlay from '@/components/RestTimerOverlay';
-import LoadingScreen from '@/components/LoadingScreen';
-import ExerciseEditor from '@/components/ExerciseEditor';
-import IncomingInviteModal from '@/components/IncomingInviteModal';
-import InviteAcceptedModal from '@/components/InviteAcceptedModal';
-import NotificationCenter from '@/components/NotificationCenter';
-import HeaderActionsMenu from '@/components/HeaderActionsMenu.js';
-import { TeamWorkoutProvider } from '@/contexts/TeamWorkoutContext';
-import { InAppNotificationsProvider, useInAppNotifications } from '@/contexts/InAppNotificationsContext';
-import ErrorBoundary from '@/components/ErrorBoundary';
-import ErrorReporterProvider from '@/components/ErrorReporterProvider';
-import { DialogProvider, useDialog } from '@/contexts/DialogContext';
-import GlobalDialog from '@/components/GlobalDialog';
-import { playStartSound, unlockAudio } from '@/lib/sounds';
-import { workoutPlanHtml } from '@/utils/report/templates';
-import { estimateExerciseSeconds, toMinutesRounded, calculateExerciseDuration } from '@/utils/pacing';
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName'
-import { formatProgramWorkoutTitle } from '@/utils/workoutTitle'
-import { resolveCanonicalExerciseName } from '@/utils/exerciseCanonical'
-import { BackButton } from '@/components/ui/BackButton';
-import StudentDashboard from '@/components/dashboard/StudentDashboard.tsx'
-import WorkoutWizardModal from '@/components/dashboard/WorkoutWizardModal'
-import SettingsModal from '@/components/SettingsModal'
-import { useUserSettings } from '@/hooks/useUserSettings'
-import WhatsNewModal from '@/components/WhatsNewModal'
-import WelcomeFloatingWindow from '@/components/WelcomeFloatingWindow'
-import { generateWorkoutFromWizard } from '@/utils/workoutAutoGenerator'
-import { getLatestWhatsNew } from '@/content/whatsNew'
-import GuidedTour from '@/components/onboarding/GuidedTour'
-import { getTourSteps } from '@/utils/tourSteps'
-import { cacheGetWorkouts, cacheSetWorkouts, flushOfflineQueue, getOfflineQueueSummary, getPendingCount, isOnline } from '@/lib/offline/offlineSync'
-import OfflineSyncModal from '@/components/OfflineSyncModal'
-
-const AssessmentHistory = dynamic(() => import('@/components/assessment/AssessmentHistory'), { ssr: false });
-const VipHub = dynamic(() => import('@/components/VipHub'), { ssr: false });
-
-const appId = 'irontracks-production';
-
-function InAppNotifyBinder({ bind }) {
-    const { notify } = useInAppNotifications();
-    const safeBind = typeof bind === 'function' ? bind : null;
-    useEffect(() => {
-        if (!safeBind) return;
-        safeBind(notify);
-        return () => {
-            try { safeBind(null); } catch {}
-        };
-    }, [notify, safeBind]);
-    return null;
-}
-
-const mapWorkoutRow = (w) => {
-	const rawExercises = Array.isArray(w?.exercises) ? w.exercises : [];
-	const exs = rawExercises
-		.filter((e) => e && typeof e === 'object')
-		.sort((a, b) => (a.order || 0) - (b.order || 0))
-		.map((e) => {
-			try {
-				const isCardio = String(e.method || '').toLowerCase() === 'cardio';
-				const dbSets = Array.isArray(e.sets)
-					? e.sets.filter((s) => s && typeof s === 'object')
-					: [];
-
-				const sortedSets = dbSets
-					.slice()
-					.sort((aSet, bSet) => (aSet?.set_number || 0) - (bSet?.set_number || 0));
-
-				const setsCount = sortedSets.length || (isCardio ? 1 : 4);
-
-				const setDetails = sortedSets.map((s, idx) => ({
-					set_number: s?.set_number ?? idx + 1,
-					reps: s?.reps ?? null,
-					rpe: s?.rpe ?? null,
-					weight: s?.weight ?? null,
-					is_warmup: !!(s?.is_warmup ?? s?.isWarmup),
-					advanced_config: s?.advanced_config ?? s?.advancedConfig ?? null,
-				}));
-
-				const nonEmptyReps = setDetails
-					.map((s) => s.reps)
-					.filter((r) => r !== null && r !== undefined && r !== '');
-				const defaultReps = isCardio ? '20' : '10';
-				let repsHeader = defaultReps;
-				if (nonEmptyReps.length > 0) {
-					const uniqueReps = Array.from(new Set(nonEmptyReps));
-					repsHeader = uniqueReps.length === 1 ? uniqueReps[0] : nonEmptyReps[0] ?? defaultReps;
-				}
-
-				const rpeValues = setDetails
-					.map((s) => s.rpe)
-					.filter((v) => v !== null && v !== undefined && !Number.isNaN(v));
-				const defaultRpe = isCardio ? 5 : 8;
-				const rpeHeader = rpeValues.length > 0 ? rpeValues[0] : defaultRpe;
-
-				return {
-					id: e.id,
-					name: e.name,
-					notes: e.notes,
-					videoUrl: e.video_url,
-					restTime: e.rest_time,
-					cadence: e.cadence,
-					method: e.method,
-					sets: setsCount,
-					reps: repsHeader,
-					rpe: rpeHeader,
-					setDetails,
-				};
-			} catch (mapErr) {
-				console.error('Erro ao mapear exercício', {
-					workoutId: w?.id,
-					exerciseId: e?.id,
-					error: mapErr,
-				});
-				return null;
-			}
-		})
-		.filter(Boolean);
-
-	return {
-		id: w.id,
-		title: w.name,
-		notes: w.notes,
-		exercises: exs,
-		is_template: !!w.is_template,
-		user_id: w.user_id,
-		created_by: w.created_by,
-        archived_at: w.archived_at ?? null,
-        sort_order: typeof w.sort_order === 'number' ? w.sort_order : (w.sort_order == null ? 0 : Number(w.sort_order) || 0),
-        created_at: w.created_at ?? null,
-	};
-};
-
-function IronTracksApp({ initialUser, initialProfile, initialWorkouts }) {
-    const { confirm, alert } = useDialog();
-    const [user, setUser] = useState(initialUser ?? null);
-    const [authLoading, setAuthLoading] = useState(false);
-    const [view, setView] = useState('dashboard');
-    const [directChat, setDirectChat] = useState(null);
-    const [workouts, setWorkouts] = useState(() => {
-        try {
-            const list = Array.isArray(initialWorkouts) ? initialWorkouts : [];
-            const mapped = list
-                .map((row) => mapWorkoutRow(row))
-                .filter(Boolean)
-                .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-            return mapped;
-        } catch {
-            return [];
-        }
-    });
-    const [stats, setStats] = useState({ workouts: 0, exercises: 0, activeStreak: 0 });
-    const [streakStats, setStreakStats] = useState(null);
-    const [currentWorkout, setCurrentWorkout] = useState(null);
-    const [createWizardOpen, setCreateWizardOpen] = useState(false)
-    const [importCode, setImportCode] = useState('');
-    const [shareCode, setShareCode] = useState(null);
-    const [quickViewWorkout, setQuickViewWorkout] = useState(null);
-    const [showImportModal, setShowImportModal] = useState(false);
-    const [showJsonImportModal, setShowJsonImportModal] = useState(false);
-    const [reportData, setReportData] = useState({ current: null, previous: null });
-    const [reportBackView, setReportBackView] = useState('dashboard');
-    const [duplicatesOpen, setDuplicatesOpen] = useState(false);
-    const [duplicateGroups, setDuplicateGroups] = useState([]);
-    const [duplicatesBusy, setDuplicatesBusy] = useState(false);
-    const inAppNotifyRef = useRef(null);
-    const bindInAppNotify = useCallback((fn) => {
-        inAppNotifyRef.current = typeof fn === 'function' ? fn : null;
-    }, []);
-    const inAppNotify = useCallback((payload) => {
-        const fn = inAppNotifyRef.current;
-        if (typeof fn === 'function') fn(payload);
-    }, []);
-
-    const [preCheckinOpen, setPreCheckinOpen] = useState(false)
-    const [preCheckinWorkout, setPreCheckinWorkout] = useState(null)
-    const [preCheckinDraft, setPreCheckinDraft] = useState({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-    const preCheckinResolveRef = useRef(null)
-
-    const requestPreWorkoutCheckin = useCallback(async (workout) => {
-        if (!user?.id) return null
-        if (preCheckinOpen) return null
-        return await new Promise((resolve) => {
-            preCheckinResolveRef.current = (value) => {
-                resolve(value ?? null)
-            }
-            setPreCheckinWorkout(workout && typeof workout === 'object' ? workout : null)
-            setPreCheckinDraft({ energy: '', soreness: '', timeMinutes: '60', notes: '' })
-            setPreCheckinOpen(true)
-        })
-    }, [preCheckinOpen, user?.id])
-    const [settingsOpen, setSettingsOpen] = useState(false)
-    const [whatsNewOpen, setWhatsNewOpen] = useState(false)
-    const [isCoach, setIsCoach] = useState(false);
-    const initialRole = String(initialProfile?.role || '').toLowerCase()
-    const [vipAccess, setVipAccess] = useState(() => ({
-        loaded: initialRole === 'admin' || initialRole === 'teacher',
-        hasVip: initialRole === 'admin' || initialRole === 'teacher',
-    }))
-    const [hasUnreadChat, setHasUnreadChat] = useState(false);
-    const [hasUnreadNotification, setHasUnreadNotification] = useState(false);
-    const [exportWorkout, setExportWorkout] = useState(null);
-    const [showExportModal, setShowExportModal] = useState(false);
-    const [coachPending, setCoachPending] = useState(false);
-    const [studentFolders, setStudentFolders] = useState([]);
-    const [openStudent, setOpenStudent] = useState(null);
-    const [showNotifCenter, setShowNotifCenter] = useState(false);
-    const [exportingAll, setExportingAll] = useState(false);
-
-    const [profileIncomplete, setProfileIncomplete] = useState(false);
-    const [profileDraftName, setProfileDraftName] = useState('');
-    const [savingProfile, setSavingProfile] = useState(false);
-    const [showCompleteProfile, setShowCompleteProfile] = useState(false);
-
-    // Estado Global da Sessão Ativa
-	const [activeSession, setActiveSession] = useState(null);
-	const suppressForeignFinishToastUntilRef = useRef(0);
-    const [sessionTicker, setSessionTicker] = useState(0);
-    const [editActiveOpen, setEditActiveOpen] = useState(false);
-    const [editActiveDraft, setEditActiveDraft] = useState(null);
-    const editActiveBaseRef = useRef(null);
-    const editActiveAddExerciseRef = useRef(false);
-    const [showAdminPanel, setShowAdminPanel] = useState(false);
-    const userSettingsApi = useUserSettings(user?.id)
-    const whatsNewShownRef = useRef(false)
-    const TOUR_VERSION = 1
-    const [tourOpen, setTourOpen] = useState(false)
-    const [tourBoot, setTourBoot] = useState({ loaded: false, completed: false, skipped: false, version: TOUR_VERSION })
-    const [syncState, setSyncState] = useState({ online: true, syncing: false, pending: 0 })
-    const [offlineSyncOpen, setOfflineSyncOpen] = useState(false)
-
-    // Local fallback to guarantee the tour doesn't re-open when DB upsert fails/offline.
-    // Stored per-user AND per-tour-version.
-    const getTourLocalKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.dismissed.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourAutoOpenedKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.autoOpened.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const getTourSeenKey = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        return safeUid ? `irontracks.onboarding.tour.v${TOUR_VERSION}.seen.${safeUid}` : ''
-    }, [TOUR_VERSION])
-    const readLocalTourDismissal = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return null
-        try {
-            if (typeof window === 'undefined') return null
-            const key = getTourLocalKey(safeUid)
-            if (!key) return null
-            const raw = window.localStorage.getItem(key) || ''
-            if (!raw) return null
-            const parsed = JSON.parse(raw)
-            if (!parsed || typeof parsed !== 'object') return null
-            const version = Number(parsed?.version || 0) || 0
-            if (version !== TOUR_VERSION) return null
-            const status = String(parsed?.status || '')
-            if (status !== 'completed' && status !== 'skipped') return null
-            return { version, status, at: Number(parsed?.at || 0) || 0 }
-        } catch {
-            return null
-        }
-    }, [TOUR_VERSION, getTourLocalKey])
-    const writeLocalTourDismissal = useCallback((uid, status) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        const safeStatus = status === 'completed' ? 'completed' : 'skipped'
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourLocalKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, JSON.stringify({ version: TOUR_VERSION, status: safeStatus, at: Date.now() }))
-        } catch {}
-    }, [TOUR_VERSION, getTourLocalKey])
-    const wasTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourSeenKey(safeUid)
-            if (!key) return false
-            return (window.localStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourSeenKey])
-    const markTourSeenEver = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourSeenKey(safeUid)
-            if (!key) return
-            window.localStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourSeenKey])
-    const wasTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return false
-        try {
-            if (typeof window === 'undefined') return false
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return false
-            return (window.sessionStorage.getItem(key) || '') === '1'
-        } catch {
-            return false
-        }
-    }, [getTourAutoOpenedKey])
-    const markTourAutoOpenedThisSession = useCallback((uid) => {
-        const safeUid = uid ? String(uid) : ''
-        if (!safeUid) return
-        try {
-            if (typeof window === 'undefined') return
-            const key = getTourAutoOpenedKey(safeUid)
-            if (!key) return
-            window.sessionStorage.setItem(key, '1')
-        } catch {}
-    }, [getTourAutoOpenedKey])
-
-    const supabase = useRef(createClient()).current;
-    const router = useRouter();
-    const isFetching = useRef(false);
-
-    const ADMIN_PANEL_OPEN_KEY = 'irontracks_admin_panel_open';
-
-    const refreshSyncState = useCallback(async () => {
-        try {
-            const online = isOnline()
-            const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-            if (offlineSyncV2Enabled) {
-                const sum = await getOfflineQueueSummary({ userId: user?.id })
-                if (sum?.ok) {
-                    setSyncState((prev) => ({
-                        ...(prev || {}),
-                        online: sum.online !== false,
-                        pending: Number(sum.pending || 0),
-                        failed: Number(sum.failed || 0),
-                        due: Number(sum.due || 0),
-                    }))
-                    return
-                }
-            }
-            const pending = await getPendingCount(user?.id)
-            setSyncState((prev) => ({ ...(prev || {}), online, pending, failed: 0, due: 0 }))
-        } catch {
-            setSyncState((prev) => ({ ...(prev || {}), online: isOnline() }))
-        }
-    }, [user?.id, userSettingsApi?.settings])
-
-    const runFlushQueue = useCallback(async () => {
-        try {
-            if (!isOnline()) {
-                setSyncState((prev) => ({ ...(prev || {}), online: false }))
-                return
-            }
-            setSyncState((prev) => ({ ...(prev || {}), syncing: true, online: true }))
-            await flushOfflineQueue({ max: 8 })
-        } finally {
-            setSyncState((prev) => ({ ...(prev || {}), syncing: false }))
-            await refreshSyncState()
-        }
-    }, [refreshSyncState])
-
-    useEffect(() => {
-        refreshSyncState()
-        const onChanged = () => refreshSyncState()
-        const onOnline = () => runFlushQueue()
-        const onOffline = () => refreshSyncState()
-        try {
-            window.addEventListener('irontracks.offlineQueueChanged', onChanged)
-            window.addEventListener('online', onOnline)
-            window.addEventListener('offline', onOffline)
-        } catch {}
-        return () => {
-            try {
-                window.removeEventListener('irontracks.offlineQueueChanged', onChanged)
-                window.removeEventListener('online', onOnline)
-                window.removeEventListener('offline', onOffline)
-            } catch {}
-        }
-    }, [refreshSyncState, runFlushQueue])
-
-    useEffect(() => {
-        if (!user?.id) return
-        if (!isOnline()) return
-        if ((syncState?.pending || 0) <= 0) return
-        const t = setInterval(() => {
-            runFlushQueue()
-        }, 15000)
-        return () => clearInterval(t)
-    }, [runFlushQueue, syncState?.pending, user?.id])
-
-    const logTourEvent = useCallback(async (event, payload) => {
-        try {
-            if (!user?.id) return
-            const ev = String(event || '').trim()
-            if (!ev) return
-            const basePayload = payload && typeof payload === 'object' ? payload : {}
-            const enriched = {
-                ...basePayload,
-                role: String(user?.role || ''),
-                path: (() => {
-                    try { return typeof window !== 'undefined' ? String(window.location.pathname || '') : '' } catch { return '' }
-                })(),
-            }
-            await supabase.from('onboarding_events').insert({
-                user_id: user.id,
-                event: ev,
-                payload: enriched,
-            })
-        } catch {}
-    }, [supabase, user?.id, user?.role])
-
-    const upsertTourFlags = useCallback(async (patch) => {
-        try {
-            if (!user?.id) return { ok: false, error: 'missing_user' }
-            const base = patch && typeof patch === 'object' ? patch : {}
-            const payload = {
-                user_id: user.id,
-                preferences: userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {},
-                tour_version: TOUR_VERSION,
-                updated_at: new Date().toISOString(),
-                ...base,
-            }
-            await supabase.from('user_settings').upsert(payload, { onConflict: 'user_id' })
-            return { ok: true }
-        } catch (e) {
-            return { ok: false, error: e?.message ?? String(e) }
-        }
-    }, [TOUR_VERSION, supabase, user?.id, userSettingsApi?.settings])
-
-    useEffect(() => {
-        if (!user?.id) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const uid = String(user.id)
-                const localDismissal = readLocalTourDismissal(uid)
-                if (localDismissal) {
-                    // Defensive: if the user already dismissed locally (offline, blocked RLS, etc.), never auto-open again.
-                    const completed = localDismissal.status === 'completed'
-                    const skipped = localDismissal.status === 'skipped'
-                    setTourBoot({ loaded: true, completed, skipped, version: TOUR_VERSION })
-                    return
-                }
-
-                const { data } = await supabase
-                    .from('user_settings')
-                    .select('tour_version, tour_completed_at, tour_skipped_at')
-                    .eq('user_id', user.id)
-                    .maybeSingle()
-
-                if (cancelled) return
-
-                const dbVersion = Number(data?.tour_version || 0) || 0
-                // Only force a new auto-open when the DB explicitly says an older version was seen.
-                // If dbVersion is missing/0 but completed_at exists, we respect completed/skipped to avoid annoying loops.
-                const needsNewVersion = dbVersion > 0 && dbVersion < TOUR_VERSION
-                const completed = needsNewVersion ? false : !!data?.tour_completed_at
-                const skipped = needsNewVersion ? false : !!data?.tour_skipped_at
-                setTourBoot({ loaded: true, completed, skipped, version: dbVersion || TOUR_VERSION })
-
-                const shouldOpen = !wasTourSeenEver(uid) && !wasTourAutoOpenedThisSession(uid) && (!completed && !skipped)
-                if (shouldOpen) {
-                    markTourAutoOpenedThisSession(uid)
-                    markTourSeenEver(uid)
-                    await logTourEvent('tour_started', { auto: true, version: TOUR_VERSION })
-                    setTourOpen(true)
-                }
-            } catch {
-                if (!cancelled) setTourBoot((prev) => ({ ...(prev || {}), loaded: true }))
-            }
-        })()
-        return () => {
-            cancelled = true
-        }
-    }, [TOUR_VERSION, logTourEvent, markTourAutoOpenedThisSession, markTourSeenEver, readLocalTourDismissal, supabase, user?.id, wasTourAutoOpenedThisSession, wasTourSeenEver])
-
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : '';
-        if (!uid) return;
-        const key = `irontracks.socialPresencePing.v1.${uid}`;
-        try {
-            if (typeof window !== 'undefined') {
-                const seen = window.sessionStorage.getItem(key) || '';
-                if (seen === '1') return;
-                window.sessionStorage.setItem(key, '1');
-            }
-        } catch {}
-        try {
-            fetch('/api/social/presence/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-        try {
-            fetch('/api/profiles/ping', { method: 'POST' }).catch(() => {});
-        } catch {}
-    }, [user?.id]);
-
-    useEffect(() => {
-        if (authLoading) return;
-        if (user) return;
-        const t = setTimeout(() => {
-            try {
-                router.replace('/?next=/dashboard');
-            } catch {}
-        }, 150);
-        return () => {
-            clearTimeout(t);
-        };
-    }, [authLoading, user, router]);
-
-    useEffect(() => {
-        if (whatsNewShownRef.current) return
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        if (!userSettingsApi?.loaded) return
-        const entry = getLatestWhatsNew()
-        if (!entry?.id) return
-        const prefs = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-        if (prefs?.whatsNewAutoOpen === false) return
-        const lastSeenId = String(prefs?.whatsNewLastSeenId || '')
-        const lastSeenAt = Number(prefs?.whatsNewLastSeenAt || 0) || 0
-        const remind24h = prefs?.whatsNewRemind24h !== false
-        const within24h = lastSeenAt > 0 && Date.now() - lastSeenAt < 24 * 60 * 60 * 1000
-        if (lastSeenId === String(entry.id)) {
-            if (!remind24h) return
-            if (within24h) return
-        }
-        whatsNewShownRef.current = true
-        setWhatsNewOpen(true)
-    }, [user?.id, userSettingsApi?.loaded, userSettingsApi?.settings])
-
-    const closeWhatsNew = useCallback(async () => {
-        try {
-            setWhatsNewOpen(false)
-            const entry = getLatestWhatsNew()
-            if (!entry?.id) return
-            const prev = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : {}
-            const prevSeenId = String(prev?.whatsNewLastSeenId || '')
-            const nextSeenAt = Date.now()
-            const next = { ...(prev || {}), whatsNewLastSeenId: String(entry.id), whatsNewLastSeenAt: nextSeenAt }
-            try { userSettingsApi?.setSettings?.(next) } catch {}
-            try { await userSettingsApi?.save?.(next) } catch {}
-        } catch {}
-    }, [userSettingsApi])
-    const ADMIN_PANEL_TAB_KEY = 'irontracks_admin_panel_tab';
-
-    const setUrlTabParam = useCallback((nextTab) => {
-        try {
-            if (typeof window === 'undefined') return;
-            const tabValue = String(nextTab || '').trim();
-            if (!tabValue) return;
-            const url = new URL(window.location.href);
-            url.searchParams.set('tab', tabValue);
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const removeUrlTabParam = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const url = new URL(window.location.href);
-            url.searchParams.delete('tab');
-            window.history.replaceState({}, '', url);
-        } catch {}
-    }, []);
-
-    const openAdminPanel = useCallback((tab) => {
-        setShowAdminPanel(true);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                if (tab) sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, String(tab));
-                if (tab) setUrlTabParam(tab);
-            }
-        } catch {}
-    }, [setUrlTabParam]);
-
-    const closeAdminPanel = useCallback(() => {
-        setShowAdminPanel(false);
-        try {
-            if (typeof window !== 'undefined') {
-                sessionStorage.removeItem(ADMIN_PANEL_OPEN_KEY);
-                sessionStorage.removeItem(ADMIN_PANEL_TAB_KEY);
-            }
-        } catch {}
-        removeUrlTabParam();
-    }, [removeUrlTabParam]);
-
-    const restoreAdminPanelIfNeeded = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const role = String(user?.role || '').toLowerCase();
-            const isPrivileged = role === 'admin' || role === 'teacher';
-            if (!isPrivileged) return;
-
-            const validTabs = new Set(['dashboard', 'students', 'teachers', 'templates', 'videos', 'broadcast', 'system']);
-            const url = new URL(window.location.href);
-            const urlTabRaw = String(url.searchParams.get('tab') || '').trim();
-            const urlTab = validTabs.has(urlTabRaw) ? urlTabRaw : '';
-
-            const open = sessionStorage.getItem(ADMIN_PANEL_OPEN_KEY);
-            const storedTabRaw = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-            const storedTab = validTabs.has(storedTabRaw) ? storedTabRaw : '';
-
-            const shouldOpen = open === '1' || !!urlTab;
-            if (!shouldOpen) return;
-
-            const tab = urlTab || storedTab || 'dashboard';
-            try {
-                sessionStorage.setItem(ADMIN_PANEL_OPEN_KEY, '1');
-                sessionStorage.setItem(ADMIN_PANEL_TAB_KEY, tab);
-            } catch {}
-            if (!urlTab && tab) setUrlTabParam(tab);
-            setShowAdminPanel(true);
-        } catch {}
-    }, [setUrlTabParam, user?.role]);
-
-    const resolveExerciseVideos = useCallback(async (exercises) => {
-        try {
-            const list = Array.isArray(exercises) ? exercises : [];
-            const missingNames = list
-                .map((ex) => {
-                    const name = String(ex?.name || '').trim();
-                    if (!name) return null;
-                    const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                    if (current) return null;
-                    return name;
-                })
-                .filter(Boolean);
-
-            const uniqueNames = Array.from(new Set(missingNames)).slice(0, 80);
-            if (!uniqueNames.length) return { exercises: list, updates: [] };
-
-            const res = await fetch('/api/exercise-library/resolve', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ names: uniqueNames }),
-            });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return { exercises: list, updates: [] };
-
-            const videos = json?.videos && typeof json.videos === 'object' ? json.videos : {};
-            const updates = [];
-
-            const next = list.map((ex) => {
-                const current = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-                if (current) return ex;
-                const normalized = normalizeExerciseName(String(ex?.name || ''));
-                const url = normalized ? String(videos[normalized] || '').trim() : '';
-                if (!url) return ex;
-                if (ex?.id) updates.push({ id: ex.id, url });
-                return { ...ex, videoUrl: url, video_url: url };
-            });
-
-            return { exercises: next, updates };
-        } catch {
-            return { exercises: Array.isArray(exercises) ? exercises : [], updates: [] };
-        }
-    }, []);
-
-    const persistExerciseVideoUrls = useCallback(async (updates) => {
-        try {
-            const rows = Array.isArray(updates) ? updates : [];
-            const filtered = rows
-                .map((r) => ({ id: String(r?.id || '').trim(), url: String(r?.url || '').trim() }))
-                .filter((r) => !!r.id && !!r.url)
-                .slice(0, 100);
-            if (!filtered.length) return;
-            await Promise.allSettled(filtered.map((r) => supabase.from('exercises').update({ video_url: r.url }).eq('id', r.id)));
-        } catch {}
-    }, [supabase]);
-
-    const signOutInFlightRef = useRef(false);
-    const serverSessionSyncRef = useRef({ timer: null, lastKey: '' });
-    const serverSessionSyncWarnedRef = useRef(false);
-
-    const generateExerciseKey = useCallback(() => {
-        try {
-            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
-        } catch {}
-        return `ex_${Date.now()}_${Math.random().toString(16).slice(2)}`;
-    }, []);
-
-    const normalizeWorkoutForEditor = useCallback((raw) => {
-        try {
-            const base = raw && typeof raw === 'object' ? raw : {};
-            const title = String(base.title || base.name || 'Treino').trim() || 'Treino';
-            const exercisesRaw = Array.isArray(base.exercises) ? base.exercises : [];
-            const exercisesInitial = exercisesRaw.filter((ex) => ex && typeof ex === 'object').map((ex) => {
-                const existing = ex?._itx_exKey ? String(ex._itx_exKey) : '';
-                const fromId = ex?.id != null ? `id_${String(ex.id)}` : '';
-                const nextKey = existing || fromId || generateExerciseKey();
-                return { ...ex, _itx_exKey: nextKey };
-            });
-
-            const seen = new Set();
-            const exercises = exercisesInitial.map((ex) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k || seen.has(k)) {
-                    const nextKey = generateExerciseKey();
-                    seen.add(nextKey);
-                    return { ...ex, _itx_exKey: nextKey };
-                }
-                seen.add(k);
-                return ex;
-            });
-
-            return { ...base, title, exercises };
-        } catch {
-            return { title: 'Treino', exercises: [] };
-        }
-    }, [generateExerciseKey]);
-
-    const stripWorkoutInternalKeys = useCallback((workout) => {
-        try {
-            const w = workout && typeof workout === 'object' ? workout : {};
-            const exercises = Array.isArray(w.exercises)
-                ? w.exercises.map((ex) => {
-                      if (!ex || typeof ex !== 'object') return ex;
-                      const { _itx_exKey, ...rest } = ex;
-                      return rest;
-                  })
-                : w.exercises;
-            return { ...w, exercises };
-        } catch {
-            return workout;
-        }
-    }, []);
-
-    const reindexSessionLogsAfterWorkoutEdit = useCallback((oldWorkout, newWorkout, logs) => {
-        try {
-            const safeLogs = logs && typeof logs === 'object' ? logs : {};
-            const oldExercises = Array.isArray(oldWorkout?.exercises) ? oldWorkout.exercises : [];
-            const newExercises = Array.isArray(newWorkout?.exercises) ? newWorkout.exercises : [];
-            const oldKeyByIndex = oldExercises.map((ex) => String(ex?._itx_exKey || ''));
-            const newIndexByKey = new Map();
-            newExercises.forEach((ex, idx) => {
-                const k = String(ex?._itx_exKey || '');
-                if (!k) return;
-                if (newIndexByKey.has(k)) return;
-                newIndexByKey.set(k, idx);
-            });
-
-            const result = {};
-
-            Object.entries(safeLogs).forEach(([k, v]) => {
-                const parts = String(k || '').split('-');
-                if (parts.length !== 2) {
-                    result[k] = v;
-                    return;
-                }
-                const oldIdx = Number(parts[0]);
-                const setIdx = Number(parts[1]);
-                if (!Number.isFinite(oldIdx) || !Number.isFinite(setIdx)) {
-                    result[k] = v;
-                    return;
-                }
-                const exKey = oldKeyByIndex[oldIdx] || '';
-                const newIdx = exKey ? newIndexByKey.get(exKey) : undefined;
-                if (typeof newIdx !== 'number' || newIdx < 0) return;
-                const ex = newExercises[newIdx] || null;
-                const headerSets = Number.parseInt(ex?.sets, 10) || 0;
-                const details = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-                const maxSets = headerSets || (Array.isArray(details) ? details.length : 0);
-                if (maxSets && setIdx >= maxSets) return;
-                result[`${newIdx}-${setIdx}`] = v;
-            });
-
-            return result;
-        } catch {
-            return logs && typeof logs === 'object' ? logs : {};
-        }
-    }, []);
-
-    const clearSupabaseCookiesBestEffort = useCallback(() => {
-        try {
-            if (typeof document === 'undefined') return;
-            const raw = String(document.cookie || '');
-            const cookieNames = raw
-                .split(';')
-                .map((p) => p.trim())
-                .map((p) => p.split('=')[0])
-                .filter(Boolean);
-            const targets = cookieNames.filter((n) => n.startsWith('sb-') || n.includes('supabase'));
-            targets.forEach((name) => {
-                try {
-                    document.cookie = `${name}=; Max-Age=0; path=/`;
-                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`;
-                } catch {}
-            });
-        } catch {}
-    }, []);
-
-    const clearSupabaseStorageBestEffort = useCallback(() => {
-        try {
-            if (typeof window === 'undefined') return;
-            const ls = window.localStorage;
-            if (!ls) return;
-            const keys = [];
-            for (let i = 0; i < ls.length; i++) {
-                const k = ls.key(i);
-                if (!k) continue;
-                if (k.startsWith('sb-') || k.includes('supabase') || k.includes('auth-token')) keys.push(k);
-            }
-            keys.forEach((k) => {
-                try { ls.removeItem(k); } catch {}
-            });
-        } catch {}
-    }, []);
-
-		const clearClientSessionState = useCallback(() => {
-		try {
-			localStorage.removeItem('activeSession');
-			localStorage.removeItem('appView');
-			if (user?.id) {
-				localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-				localStorage.removeItem(`irontracks.appView.v2.${user.id}`);
-			}
-		} catch {}
-		setActiveSession(null);
-		setView('dashboard');
-	}, [user?.id]);
-
-    const safeSignOut = useCallback(async (scope = 'local') => {
-        if (signOutInFlightRef.current) return;
-        signOutInFlightRef.current = true;
-        try {
-            clearSupabaseCookiesBestEffort();
-            clearSupabaseStorageBestEffort();
-        } catch (e) {
-            try {
-                clearSupabaseCookiesBestEffort();
-                clearSupabaseStorageBestEffort();
-            } catch {}
-        } finally {
-            signOutInFlightRef.current = false;
-        }
-    }, [clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        const scopedKey = `irontracks.activeSession.v2.${userId}`;
-        let localSavedAt = 0;
-
-        try {
-            const raw = localStorage.getItem(scopedKey) || localStorage.getItem('activeSession');
-            if (raw) {
-                const parsed = JSON.parse(raw);
-                if (parsed && typeof parsed === 'object' && parsed?.startedAt && parsed?.workout) {
-                    localSavedAt = Number(parsed?._savedAt ?? 0) || 0;
-                    setActiveSession(parsed);
-                    setView('active');
-
-                    if (!localStorage.getItem(scopedKey)) {
-                        try {
-                            localStorage.setItem(scopedKey, JSON.stringify(parsed));
-                            localStorage.removeItem('activeSession');
-                        } catch {}
-                    }
-                }
-            }
-        } catch {
-            try {
-                localStorage.removeItem(scopedKey);
-                localStorage.removeItem('activeSession');
-            } catch {}
-        }
-
-        const loadServer = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('active_workout_sessions')
-                    .select('state, updated_at')
-                    .eq('user_id', userId)
-                    .maybeSingle();
-                if (cancelled) return;
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                    return;
-                }
-
-                const state = data?.state;
-                if (!state || typeof state !== 'object') return;
-                if (!state?.startedAt || !state?.workout) return;
-
-                const updatedAtMs = (() => {
-                    const fromCol = typeof data?.updated_at === 'string' ? Date.parse(data.updated_at) : NaN;
-                    const fromState = Number(state?._savedAt ?? 0) || 0;
-                    return Math.max(Number.isFinite(fromCol) ? fromCol : 0, fromState);
-                })();
-
-                if (updatedAtMs <= localSavedAt) return;
-
-                setActiveSession(state);
-                setView('active');
-                try {
-                    localStorage.setItem(scopedKey, JSON.stringify(state));
-                } catch {}
-            } catch {}
-        };
-
-        loadServer();
-
-        return () => {
-            cancelled = true;
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        let mounted = true;
-        let channel;
-
-        try {
-            channel = supabase
-                .channel(`active-workout-session:${userId}`)
-                .on(
-                    'postgres_changes',
-                    {
-                        event: '*',
-                        schema: 'public',
-                        table: 'active_workout_sessions',
-                        filter: `user_id=eq.${userId}`,
-                    },
-                    (payload) => {
-                        try {
-                            if (!mounted) return;
-						const ev = String(payload?.eventType || '').toUpperCase();
-						if (ev === 'DELETE') {
-							if (Date.now() < (suppressForeignFinishToastUntilRef.current || 0)) {
-								suppressForeignFinishToastUntilRef.current = 0;
-								return;
-							}
-							setActiveSession(null);
-							setView('dashboard');
-							try {
-								localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-							} catch {}
-                                try {
-                                    inAppNotify({
-                                        text: 'Treino finalizado em outro dispositivo.',
-                                        senderName: 'Aviso do Sistema',
-                                        displayName: 'Sistema',
-                                        photoURL: null,
-                                    });
-                                } catch {}
-                                return;
-                            }
-
-                            if (ev === 'UPDATE') {
-                                const state = payload?.new?.state;
-                                if (!state || typeof state !== 'object' || !state?.startedAt || !state?.workout) {
-                                    setActiveSession(null);
-                                    setView('dashboard');
-                                    try {
-                                        localStorage.removeItem(`irontracks.activeSession.v2.${userId}`);
-                                    } catch {}
-                                }
-                            }
-                        } catch {}
-                    }
-                )
-                .subscribe();
-        } catch {}
-
-        return () => {
-            mounted = false;
-            try {
-                if (channel) supabase.removeChannel(channel);
-            } catch {
-                try {
-                    if (channel) createClient().removeChannel(channel);
-                } catch {}
-            }
-        };
-    }, [supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        const handler = () => { try { unlockAudio(); } catch {} };
-        document.addEventListener('touchstart', handler, { once: true });
-        document.addEventListener('click', handler, { once: true });
-        return () => {
-            document.removeEventListener('touchstart', handler);
-            document.removeEventListener('click', handler);
-        };
-    }, [supabase, alert, clearClientSessionState]);
-
-    // Persistência da View (Aba Atual)
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const scopedViewKey = `irontracks.appView.v2.${user.id}`;
-            const scopedSessionKey = `irontracks.activeSession.v2.${user.id}`;
-            const savedSession = localStorage.getItem(scopedSessionKey);
-            if (savedSession) {
-                setView('active');
-                return;
-            }
-
-            const raw = localStorage.getItem(scopedViewKey) || localStorage.getItem('appView');
-            const savedView = raw ? String(raw) : '';
-            if (!savedView) {
-                setView('dashboard');
-                return;
-            }
-
-            if (savedView === 'active') {
-                setView('dashboard');
-                return;
-            }
-
-            setView(savedView);
-        } catch {
-            setView('dashboard');
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            if (!view) return;
-            localStorage.setItem(`irontracks.appView.v2.${user.id}`, view);
-        } catch {
-            return;
-        }
-    }, [view, user?.id]);
-
-    useEffect(() => {
-        try {
-            if (!user?.id) return;
-            const key = `irontracks.activeSession.v2.${user.id}`;
-            if (!activeSession) {
-                localStorage.removeItem(key);
-                localStorage.removeItem('activeSession');
-                return;
-            }
-
-            const payload = JSON.stringify({ ...(activeSession || {}), _savedAt: Date.now() });
-            const id = setTimeout(() => {
-                try {
-                    localStorage.setItem(key, payload);
-                } catch {}
-            }, 250);
-            return () => clearTimeout(id);
-        } catch {
-            return;
-        }
-    }, [activeSession, user?.id]);
-
-    useEffect(() => {
-        const userId = user?.id ? String(user.id) : '';
-        if (!userId) return;
-
-        try {
-            if (serverSessionSyncRef.current?.timer) {
-                try {
-                    clearTimeout(serverSessionSyncRef.current.timer);
-                } catch {}
-            }
-        } catch {}
-
-        const key = (() => {
-            try {
-                return JSON.stringify(activeSession || null);
-            } catch {
-                return '';
-            }
-        })();
-
-        serverSessionSyncRef.current.lastKey = key;
-
-        const run = async () => {
-            try {
-                if (serverSessionSyncRef.current.lastKey !== key) return;
-
-                if (!activeSession) {
-                    const { error } = await supabase.from('active_workout_sessions').delete().eq('user_id', userId);
-                    if (error) {
-                        const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                        const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                        const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                        if (isMissing && !serverSessionSyncWarnedRef.current) {
-                            serverSessionSyncWarnedRef.current = true;
-                            try {
-                                inAppNotify({
-                                    text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                    senderName: 'Aviso do Sistema',
-                                    displayName: 'Sistema',
-                                    photoURL: null,
-                                });
-                            } catch {}
-                        }
-                    }
-                    return;
-                }
-
-                const startedAtRaw = activeSession?.startedAt;
-                const startedAtMs = typeof startedAtRaw === 'number' ? startedAtRaw : new Date(startedAtRaw || 0).getTime();
-                if (!Number.isFinite(startedAtMs) || startedAtMs <= 0) return;
-                if (!activeSession?.workout) return;
-
-                const state = { ...(activeSession || {}), _savedAt: Date.now() };
-
-                const { error } = await supabase
-                    .from('active_workout_sessions')
-                    .upsert(
-                        {
-                            user_id: userId,
-                            started_at: new Date(startedAtMs).toISOString(),
-                            state,
-                            updated_at: new Date().toISOString(),
-                        },
-                        { onConflict: 'user_id' }
-                    );
-                if (error) {
-                    const msg = String((error && typeof error === 'object' && 'message' in error ? error.message : '') || '').toLowerCase();
-                    const code = String((error && typeof error === 'object' && 'code' in error ? error.code : '') || '').toLowerCase();
-                    const isMissing = code === '42p01' || msg.includes('does not exist') || msg.includes('relation') || msg.includes('schema cache');
-                    if (isMissing && !serverSessionSyncWarnedRef.current) {
-                        serverSessionSyncWarnedRef.current = true;
-                        try {
-                            inAppNotify({
-                                text: 'Sincronização do treino entre navegadores indisponível (migrations pendentes).',
-                                senderName: 'Aviso do Sistema',
-                                displayName: 'Sistema',
-                                photoURL: null,
-                            });
-                        } catch {}
-                    }
-                }
-            } catch {}
-        };
-
-        let timerId = null;
-
-        try {
-            timerId = setTimeout(() => {
-                try {
-                    run();
-                } catch {}
-            }, 900);
-            serverSessionSyncRef.current.timer = timerId;
-        } catch {}
-
-        return () => {
-            try {
-                if (timerId) clearTimeout(timerId);
-            } catch {}
-        };
-    }, [activeSession, supabase, user?.id, inAppNotify]);
-
-    useEffect(() => {
-        if (!activeSession) return;
-        const id = setInterval(() => setSessionTicker(Date.now()), 1000);
-        return () => clearInterval(id);
-    }, [activeSession, view]);
-
-    useEffect(() => {
-        let cancelled = false;
-        if (!user?.id) {
-            setHasUnreadNotification(false);
-            return;
-        }
-
-        const loadInitial = async () => {
-            try {
-                const { data, error } = await supabase
-                    .from('notifications')
-                    .select('id')
-                    .eq('user_id', user.id)
-                    .limit(1);
-                if (cancelled) return;
-                if (error) {
-                    console.error('Erro ao carregar notificações:', error);
-                    setHasUnreadNotification(false);
-                    return;
-                }
-                setHasUnreadNotification(Array.isArray(data) && data.length > 0);
-            } catch (e) {
-                if (cancelled) return;
-                console.error('Erro ao carregar notificações:', e);
-                setHasUnreadNotification(false);
-            }
-        };
-
-        loadInitial();
-
-        const channel = supabase
-            .channel(`notifications:badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) setHasUnreadNotification(true);
-            })
-            .on('postgres_changes', {
-                event: 'DELETE',
-                schema: 'public',
-                table: 'notifications',
-                filter: `user_id=eq.${user.id}`
-            }, () => {
-                if (!cancelled) loadInitial();
-            })
-            .subscribe();
-
-        return () => {
-            cancelled = true;
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-        const allowNotifyDm = s ? s.notifyDirectMessages !== false : true
-
-        const channel = supabase
-            .channel(`direct-messages-badge:${user.id}`)
-            .on('postgres_changes', {
-                event: 'INSERT',
-                schema: 'public',
-                table: 'direct_messages'
-            }, async (payload) => {
-                try {
-                    if (!allowNotifyDm) return;
-                    const msg = payload.new;
-                    if (!msg || msg.sender_id === user.id) return;
-
-                    const currentView = view;
-                    if (currentView === 'chat' || currentView === 'chatList' || currentView === 'directChat' || currentView === 'globalChat') {
-                        return;
-                    }
-
-                    const { data: senderProfile } = await supabase
-                        .from('profiles')
-                        .select('display_name')
-                        .eq('id', msg.sender_id)
-                        .maybeSingle();
-
-                    const senderName = senderProfile?.display_name || 'Nova mensagem';
-                    const preview = String(msg.content || '').slice(0, 120);
-                    if (!preview) return;
-
-                    await fetch('/api/notifications/direct-message', {
-                        method: 'POST',
-                        headers: { 'Content-Type': 'application/json' },
-                        body: JSON.stringify({
-                            receiverId: user.id,
-                            senderName,
-                            preview,
-                        }),
-                    });
-                } catch (e) {
-                    console.error('Erro ao gerar notificação de mensagem direta:', e);
-                }
-            })
-            .subscribe();
-
-        return () => {
-            supabase.removeChannel(channel);
-        };
-    }, [supabase, user?.id, userSettingsApi?.settings, view]);
-
-    useEffect(() => {
-        const baseUser = initialUser && typeof initialUser === 'object' ? initialUser : null
-        if (!baseUser?.id) {
-            try {
-                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-            } catch {}
-            return
-        }
-        const meta = baseUser?.user_metadata || {}
-        const emailRaw = String(baseUser?.email || '').trim()
-        const emailUser = emailRaw.includes('@') ? emailRaw.split('@')[0] : (emailRaw || 'Usuário')
-        const profileDisplayName = String(initialProfile?.display_name || initialProfile?.displayName || '').trim()
-        const profilePhotoURL = String(initialProfile?.photo_url || initialProfile?.photoURL || initialProfile?.photoUrl || '').trim()
-        const metaDisplayName = String(meta?.full_name || meta?.name || '').trim()
-        const displayName = profileDisplayName || metaDisplayName || emailUser
-        const photoURL = profilePhotoURL || meta?.avatar_url || meta?.picture || null
-        const nextUser = { ...baseUser, displayName, photoURL, role: initialProfile?.role || 'user' }
-        setUser(nextUser)
-        const role = String(initialProfile?.role || '').toLowerCase()
-        setIsCoach(role === 'teacher' || role === 'admin')
-    }, [initialUser, initialProfile])
-
-    useEffect(() => {
-        const uid = user?.id ? String(user.id) : ''
-        if (!uid) return
-        let cancelled = false
-        ;(async () => {
-            try {
-                const res = await fetch('/api/vip/access', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                const json = await res.json().catch(() => null)
-                if (cancelled) return
-                if (json && json.ok) {
-                    setVipAccess({ loaded: true, hasVip: !!json.hasVip })
-                    return
-                }
-                setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            } catch {
-                if (!cancelled) setVipAccess((prev) => ({ loaded: true, hasVip: !!prev?.hasVip }))
-            }
-        })()
-        return () => { cancelled = true }
-    }, [user?.id])
-
-    useEffect(() => {
-        try {
-            const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {
-                try {
-                    const ev = String(_event || '').toUpperCase()
-                    if (session && session.user?.id) return
-                    if (ev === 'SIGNED_OUT') {
-                        clearClientSessionState()
-                        if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                        return
-                    }
-                    if (ev === 'INITIAL_SESSION') {
-                        fetch('/api/auth/ping', { method: 'GET', credentials: 'include', cache: 'no-store' })
-                            .then((r) => {
-                                if (r && r.status === 204) return
-                                clearClientSessionState()
-                                if (typeof window !== 'undefined') window.location.href = '/?next=/dashboard'
-                            })
-                            .catch(() => {})
-                        return
-                    }
-                } catch {}
-            })
-            return () => {
-                try { sub?.subscription?.unsubscribe?.() } catch {}
-            }
-        } catch {
-            return
-        }
-    }, [supabase, clearClientSessionState, clearSupabaseCookiesBestEffort, clearSupabaseStorageBestEffort])
-
-    useEffect(() => {
-        restoreAdminPanelIfNeeded();
-        const onVisibility = () => {
-            if (typeof document === 'undefined') return;
-            if (document.visibilityState === 'visible') restoreAdminPanelIfNeeded();
-        };
-        const onPageShow = () => restoreAdminPanelIfNeeded();
-        try {
-            document.addEventListener('visibilitychange', onVisibility);
-            window.addEventListener('pageshow', onPageShow);
-        } catch {}
-        return () => {
-            try {
-                document.removeEventListener('visibilitychange', onVisibility);
-                window.removeEventListener('pageshow', onPageShow);
-            } catch {}
-        };
-    }, [restoreAdminPanelIfNeeded]);
-
-    // Sync Profile Separately (Optimized)
-    useEffect(() => {
-        if (user?.id) {
-             const syncProfile = async () => {
-                 try {
-                    return
-                 } catch (e) {
-                    console.error('Erro ao sincronizar perfil:', e);
-                 }
-             };
-             syncProfile();
-        }
-    }, [supabase, user?.id]);
-
-    useEffect(() => {
-        let cancelled = false;
-        const run = async () => {
-            if (!user?.id) {
-                if (!cancelled) {
-                    setProfileIncomplete(false);
-                    setProfileDraftName('');
-                }
-                return;
-            }
-
-            try {
-                const seedName = String(initialProfile?.display_name || '').trim() || String(user?.displayName || '').trim();
-                if (!cancelled) {
-                    setProfileIncomplete(!seedName);
-                    setProfileDraftName(seedName);
-                }
-            } catch {
-                if (!cancelled) {
-                    setProfileIncomplete(true);
-                    setProfileDraftName(String(user?.displayName || '').trim());
-                }
-            }
-        };
-
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [initialProfile?.display_name, user?.id, user?.displayName]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        let cancelled = false;
-        const run = async () => {
-            try {
-                const res = await fetch('/api/dashboard/bootstrap', { cache: 'no-store', credentials: 'include' });
-                const json = await res.json().catch(() => null);
-                if (cancelled) return;
-                if (!json?.ok) return;
-
-                const prof = json?.profile && typeof json.profile === 'object' ? json.profile : null;
-                const displayName = String(prof?.display_name || '').trim();
-                const photoURL = String(prof?.photo_url || '').trim();
-                const role = String(prof?.role || '').toLowerCase();
-
-                setUser((prev) => {
-                    const current = prev && typeof prev === 'object' ? prev : null;
-                    if (!current) return prev;
-                    const patch = {};
-                    if (displayName && displayName !== current.displayName) patch.displayName = displayName;
-                    if (photoURL && photoURL !== current.photoURL) patch.photoURL = photoURL;
-                    if (role && role !== String(current.role || '').toLowerCase()) patch.role = role;
-                    return Object.keys(patch).length ? { ...current, ...patch } : prev;
-                });
-                if (role) setIsCoach(role === 'teacher' || role === 'admin');
-
-                if (Array.isArray(json.workouts) && json.workouts.length) {
-                    const mapped = json.workouts
-                        .map((row) => mapWorkoutRow(row))
-                        .sort((a, b) => (a.title || '').localeCompare(b.title || ''));
-                    setWorkouts(mapped);
-                    const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-                    setStats({ workouts: mapped.length, exercises: totalEx, activeStreak: 0 });
-                }
-            } catch {}
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [user?.id]);
-
-	// Fetch Workouts
-	const fetchWorkouts = useCallback(async (specificUser = user) => {
-        if (isFetching.current) return;
-        isFetching.current = true;
-        
-		try {
-			const currentUser = specificUser;
-
-            if (!currentUser?.id) {
-                console.warn("DASHBOARD: Usuário não identificado ao buscar treinos.");
-                return;
-            }
-
-            if (typeof navigator !== 'undefined' && navigator.onLine === false) {
-                try {
-                    const cached = await cacheGetWorkouts({ userId: currentUser.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-                return
-            }
-
-            const role = String(currentUser?.role || 'user') || 'user';
-
-            let data = []
-            let studentData = []
-            let studentsList = []
-
-            const hydrateWorkouts = async (rows) => {
-                const base = Array.isArray(rows) ? rows.filter((x) => x && typeof x === 'object') : [];
-                const workoutIds = base.map((w) => w.id).filter(Boolean);
-                if (workoutIds.length === 0) return base.map((w) => ({ ...w, exercises: [] }));
-
-                let exercises = [];
-                try {
-                    const { data: exRows } = await supabase
-                        .from('exercises')
-                        .select('*')
-                        .in('workout_id', workoutIds)
-                        .order('order', { ascending: true })
-                        .limit(5000);
-                    exercises = Array.isArray(exRows) ? exRows : [];
-                } catch {
-                    exercises = [];
-                }
-
-                const exIds = exercises.map((e) => e.id).filter(Boolean);
-                let sets = [];
-                if (exIds.length > 0) {
-                    try {
-                        const { data: setRows } = await supabase
-                            .from('sets')
-                            .select('*')
-                            .in('exercise_id', exIds)
-                            .order('set_number', { ascending: true })
-                            .limit(20000);
-                        sets = Array.isArray(setRows) ? setRows : [];
-                    } catch {
-                        sets = [];
-                    }
-                }
-
-                const setsByExercise = new Map();
-                for (const s of sets) {
-                    const eid = s?.exercise_id;
-                    if (!eid) continue;
-                    const list = setsByExercise.get(eid) || [];
-                    list.push(s);
-                    setsByExercise.set(eid, list);
-                }
-
-                const exByWorkout = new Map();
-                for (const ex of exercises) {
-                    const wid = ex?.workout_id;
-                    if (!wid) continue;
-                    const exWithSets = { ...ex, sets: setsByExercise.get(ex.id) || [] };
-                    const list = exByWorkout.get(wid) || [];
-                    list.push(exWithSets);
-                    exByWorkout.set(wid, list);
-                }
-
-                return base.map((w) => ({ ...w, exercises: exByWorkout.get(w.id) || [] }));
-            };
-
-            if (role === 'admin' || role === 'teacher') {
-                // 1. Fetch Students
-                try {
-                    const { data: st } = await supabase
-                        .from('students')
-                        .select('id, name, email, user_id')
-                        .or(`teacher_id.eq.${currentUser.id},user_id.eq.${currentUser.id}`)
-                        .order('name');
-                    studentsList = st || [];
-                } catch (e) { console.error('Erro fetching students', e); }
-
-                // 2. Fetch My Workouts
-                const { data: myBase, error: myErr } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (myErr) throw myErr
-                data = await hydrateWorkouts(myBase || [])
-
-                // 3. Fetch Student Workouts
-                const ids = studentsList.map(s => s.user_id || s.id).filter(Boolean)
-                if (ids.length > 0) {
-                    const seen = new Set()
-                    const combined = []
-                    try {
-                        const { data: swByUserBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('user_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByUser = await hydrateWorkouts(swByUserBase || [])
-                        for (const w of (swByUser || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    try {
-                        const { data: swByStudentBase } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('is_template', true)
-                            .in('student_id', ids)
-                            .order('name')
-                            .limit(500)
-                        const swByStudent = await hydrateWorkouts(swByStudentBase || [])
-                        for (const w of (swByStudent || [])) { if (!seen.has(w.id)) { seen.add(w.id); combined.push(w) } }
-                    } catch {}
-                    studentData = combined
-                }
-            } else {
-                const { data: baseRows, error } = await supabase
-                    .from('workouts')
-                    .select('*')
-                    .eq('is_template', true)
-                    .eq('user_id', currentUser.id)
-                    .order('name', { ascending: true })
-                if (error) throw error
-                data = await hydrateWorkouts(baseRows || [])
-
-                if (!data.length) {
-                    try {
-                        const { data: anyRows, error: anyErr } = await supabase
-                            .from('workouts')
-                            .select('*')
-                            .eq('user_id', currentUser.id)
-                            .order('name', { ascending: true })
-                            .limit(500);
-                        if (!anyErr && Array.isArray(anyRows) && anyRows.length) {
-                            data = await hydrateWorkouts(anyRows);
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const { data: studentRow } = await supabase
-                            .from('students')
-                            .select('id')
-                            .eq('user_id', currentUser.id)
-                            .maybeSingle();
-                        const studentId = studentRow?.id ? String(studentRow.id) : '';
-                        if (studentId) {
-                            const { data: legacyBase } = await supabase
-                                .from('workouts')
-                                .select('*')
-                                .eq('is_template', true)
-                                .or(`user_id.eq.${studentId},student_id.eq.${studentId}`)
-                                .order('name', { ascending: true })
-                                .limit(500);
-                            const legacyHydrated = await hydrateWorkouts(legacyBase || []);
-                            const seen = new Set();
-                            const merged = [];
-                            for (const w of legacyHydrated) {
-                                if (!w?.id) continue;
-                                if (seen.has(w.id)) continue;
-                                seen.add(w.id);
-                                merged.push(w);
-                            }
-                            data = merged;
-                        }
-                    } catch {}
-                }
-
-                if (!data.length) {
-                    try {
-                        const resLegacy = await fetch('/api/workouts/list', { cache: 'no-store' });
-                        const jsonLegacy = await resLegacy.json().catch(() => null);
-                        if (jsonLegacy?.ok && Array.isArray(jsonLegacy.rows) && jsonLegacy.rows.length) {
-                            data = (jsonLegacy.rows || []).map((w) => ({
-                                id: w?.id,
-                                name: w?.name,
-                                notes: null,
-                                is_template: true,
-                                user_id: currentUser.id,
-                                created_by: null,
-                                exercises: [],
-                            }));
-                        }
-                    } catch {}
-                }
-            }
-
-			if (Array.isArray(data)) {
-				const mappedRaw = data
-					.map((row) => mapWorkoutRow(row))
-					.filter(Boolean);
-                const mapped = mappedRaw.sort((a, b) => {
-                    const ao = Number.isFinite(Number(a?.sort_order)) ? Number(a.sort_order) : 0
-                    const bo = Number.isFinite(Number(b?.sort_order)) ? Number(b.sort_order) : 0
-                    if (ao !== bo) return ao - bo
-                    return (a.title || '').localeCompare(b.title || '')
-                });
-
-                try {
-                    await cacheSetWorkouts({ userId: currentUser?.id, workouts: mapped })
-                } catch {}
-
-                if (role === 'admin' || role === 'teacher') {
-                    setWorkouts(mapped)
-                    try {
-                        const studentMapped = (studentData || []).map(mapWorkoutRow)
-                        const byStudent = new Map()
-                        for (const w of studentMapped) {
-                            const sid = w.user_id
-                            if (!sid) continue
-                            const list = byStudent.get(sid) || []
-                            list.push(w)
-                            byStudent.set(sid, list)
-                        }
-                        const nameById = new Map()
-                        for (const s of (studentsList || [])) {
-                            const sid = s.user_id || s.id
-                            if (!sid) continue
-                            nameById.set(sid, { name: s.name || String(sid).slice(0,8), email: s.email || '' })
-                        }
-                        const folders = Array.from(byStudent.entries()).map(([sid, list]) => {
-                            const info = nameById.get(sid) || { name: String(sid).slice(0,8), email: '' }
-                            return { id: sid, name: info.name, email: info.email, workouts: list }
-                        }).filter(f => (f.workouts || []).length > 0)
-                        setStudentFolders(folders)
-                    } catch (err) {
-                        console.error("Erro ao processar alunos:", err);
-                        setStudentFolders([])
-                    }
-                } else {
-                    setWorkouts(mapped)
-                    try {
-                        const shared = mapped.filter(w => (w.created_by && w.created_by !== currentUser.id))
-                        const byCoach = new Map()
-                        for (const w of shared) {
-                            const cid = w.created_by
-                            const list = byCoach.get(cid) || []
-                            list.push(w)
-                            byCoach.set(cid, list)
-                        }
-                        const coachIds = Array.from(byCoach.keys())
-                        let profiles = []
-                        if (coachIds.length) {
-                            const { data: profs } = await supabase.from('profiles').select('id, display_name').in('id', coachIds)
-                            profiles = profs || []
-                        }
-                        const nameByCoach = new Map(profiles.map(p => [p.id, p.display_name || String(p.id).slice(0,8)]))
-                        const folders = Array.from(byCoach.entries()).map(([cid, list]) => ({
-                            id: cid,
-                            name: `Treinos compartilhados de ${nameByCoach.get(cid) || String(cid).slice(0,8)}`,
-                            email: '',
-                            workouts: list
-                        }))
-                        setStudentFolders(folders)
-                    } catch {
-                        setStudentFolders([])
-                    }
-                }
-                
-				// Atualiza estatísticas
-				const totalEx = mapped.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0);
-				setStats({ 
-					workouts: mapped.length, 
-					exercises: totalEx, 
-					activeStreak: 0 // Placeholder
-				});
-            } else {
-                console.warn('Fetch sem dados; mantendo estado atual');
-            }
-		} catch (e) {
-			const msg = e?.message ?? String(e);
-			if (msg.includes('Failed to fetch') || msg.includes('ERR_ABORTED')) {
-				// Dev HMR aborts or transient network; ignore quietly
-                try {
-                    const cached = await cacheGetWorkouts({ userId: specificUser?.id })
-                    if (cached?.workouts && Array.isArray(cached.workouts) && cached.workouts.length) {
-                        setWorkouts(cached.workouts)
-                        const totalEx = cached.workouts.reduce((acc, w) => acc + (Array.isArray(w?.exercises) ? w.exercises.length : 0), 0)
-                        setStats({ workouts: cached.workouts.length, exercises: totalEx, activeStreak: 0 })
-                    }
-                } catch {}
-				return;
-			}
-			console.error("Erro ao buscar:", { message: msg, error: e });
-		} finally { isFetching.current = false; }
-	}, [supabase, user]); // Depende apenas do usuário para evitar loops de busca
-
-    useEffect(() => {
-        if (user) {
-            fetchWorkouts(user);
-        }
-    }, [user, fetchWorkouts]);
-
-    useEffect(() => {
-        if (user && workouts.length === 0) {
-            try {
-                const k = 'workouts_cache_' + user.id;
-                const cached = localStorage.getItem(k);
-                if (cached) {
-                    const arr = JSON.parse(cached);
-                    if (Array.isArray(arr) && arr.length > 0) setWorkouts(arr);
-                }
-            } catch {}
-        }
-    }, [user, workouts.length]);
-
-    useEffect(() => {
-        if (!user?.id) return;
-        computeWorkoutStreakAndStats()
-            .then(res => {
-                if (res?.ok && res?.data) setStreakStats(res.data)
-            })
-            .catch(err => console.error('Erro ao calcular streak:', err));
-    }, [user?.id]);
-
-
-
-    // Handlers de Sessão
-    const handleLogout = async () => {
-        const ok = await confirm("Deseja realmente sair da sua conta?", "Sair");
-        if (!ok) return;
-        try { clearClientSessionState(); } catch {}
-        try { window.location.href = '/auth/logout'; } catch {}
-    };
-
-    const handleSaveProfile = async () => {
-        if (!user?.id) return;
-        const nextName = String(profileDraftName || '').trim();
-        if (!nextName) {
-            await alert('Informe seu nome para completar o perfil.', 'Perfil incompleto');
-            return;
-        }
-
-        setSavingProfile(true);
-        try {
-            const { data, error } = await supabase
-                .from('profiles')
-                .update({
-                    display_name: nextName,
-                    photo_url: user.photoURL ?? null,
-                    last_seen: new Date().toISOString(),
-                })
-                .eq('id', user.id)
-                .select('id')
-                .maybeSingle();
-            if (error) throw error;
-            if (!data?.id) {
-                await alert('Não foi possível salvar seu perfil (registro não encontrado).', 'Perfil');
-                return;
-            }
-            setProfileIncomplete(false);
-            setShowCompleteProfile(false);
-        } catch (e) {
-            await alert('Erro ao salvar perfil: ' + (e?.message || String(e || '')));
-        } finally {
-            setSavingProfile(false);
-        }
-    };
-
-    const handleStartSession = async (workout) => {
-        const exercisesList = Array.isArray(workout?.exercises)
-            ? workout.exercises.filter(ex => ex && typeof ex === 'object')
-            : [];
-
-        if (exercisesList.length === 0) {
-            await alert('Este treino está sem exercícios válidos. Edite o treino antes de iniciar.', 'Treino incompleto');
-            return;
-        }
-
-        const first = exercisesList[0] || {};
-        const exMin = toMinutesRounded(estimateExerciseSeconds(first));
-        const totalMin = toMinutesRounded(exercisesList.reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0));
-        const workoutTitle = String(workout?.title || workout?.name || 'Treino');
-        const ok = await confirm(`Iniciar "${workoutTitle}"? Primeiro exercício: ~${exMin} min. Estimado total: ~${totalMin} min.`, 'Iniciar Treino');
-        if (!ok) return;
-        let preCheckin = null
-        try {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const prompt = s ? s.promptPreWorkoutCheckin !== false : true
-            if (prompt) {
-                preCheckin = await requestPreWorkoutCheckin(workout)
-                if (preCheckin && user?.id) {
-                    const energyN = Number(preCheckin.energy)
-                    const sorenessN = Number(preCheckin.soreness)
-                    const timeN = Number(preCheckin.timeMinutes)
-                    const { error: checkinError } = await supabase.from('workout_checkins').insert({
-                        user_id: user.id,
-                        kind: 'pre',
-                        planned_workout_id: String(workout?.id || '').trim() ? workout.id : null,
-                        active_session_user_id: null,
-                        energy: Number.isFinite(energyN) && energyN >= 1 && energyN <= 5 ? Math.round(energyN) : null,
-                        soreness: Number.isFinite(sorenessN) && sorenessN >= 0 && sorenessN <= 10 ? Math.round(sorenessN) : null,
-                        notes: String(preCheckin.notes || '').trim() ? String(preCheckin.notes || '').trim() : null,
-                        answers: {
-                            time_minutes: Number.isFinite(timeN) && timeN > 0 ? Math.round(timeN) : null,
-                        },
-                    })
-                    if (checkinError) throw checkinError
-                }
-            }
-        } catch (e) {
-            console.warn('Falha ao salvar check-in pré-treino:', e?.message || String(e || ''))
-        }
-        let resolvedExercises = exercisesList;
-        try {
-            const resolved = await resolveExerciseVideos(exercisesList);
-            resolvedExercises = Array.isArray(resolved?.exercises) ? resolved.exercises : exercisesList;
-            persistExerciseVideoUrls(resolved?.updates || []);
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const enabled = s ? s.enableSounds !== false : true
-            const volumeRaw = Number(s?.soundVolume ?? 100)
-            const volume = Number.isFinite(volumeRaw) ? Math.max(0, Math.min(1, volumeRaw / 100)) : 1
-            playStartSound({ enabled, volume })
-        }
-        setActiveSession({
-            workout: { ...workout, exercises: resolvedExercises },
-            logs: {},
-            ui: {
-                baseExerciseCount: resolvedExercises.length,
-                pendingTemplateUpdate: false,
-                preCheckin: preCheckin && typeof preCheckin === 'object' ? preCheckin : null,
-            },
-            startedAt: Date.now(),
-            timerTargetTime: null,
-            timerContext: null
-        });
-        setView('active');
-        try {
-            const wid = String(workout?.id || '').trim() || null;
-            const title = String(workout?.title || workout?.name || 'Treino').trim();
-            fetch('/api/social/workout-start', {
-                method: 'POST',
-                headers: { 'content-type': 'application/json' },
-                body: JSON.stringify({ workout_id: wid, workout_title: title }),
-            }).catch(() => {});
-        } catch {}
-        {
-            const s = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-            const allowPrompt = s ? s.notificationPermissionPrompt !== false : true
-            if (allowPrompt && typeof Notification !== 'undefined' && Notification.permission === 'default') {
-            Notification.requestPermission().catch(e => console.warn('Erro permissão notificação:', e));
-            }
-        }
-    };
-
-    const handleUpdateSessionLog = (key, data) => {
-        if (!activeSession) return;
-        setActiveSession(prev => {
-            if (!prev) return null;
-            return {
-                ...prev,
-                logs: { ...(prev.logs || {}), [key]: data }
-            };
-        });
-    };
-
-    const handleStartTimer = (duration, context) => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return {
-                ...prev,
-                timerTargetTime: Date.now() + (duration * 1000),
-                timerContext: context && typeof context === 'object' ? context : null
-            };
-        });
-    };
-
-    const handleCloseTimer = () => {
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            return { ...prev, timerTargetTime: null, timerContext: null };
-        });
-    };
-
-	const handleFinishSession = async (sessionData, showReport) => {
-		suppressForeignFinishToastUntilRef.current = Date.now() + 8000;
-        try {
-            if (user?.id) {
-                localStorage.removeItem(`irontracks.activeSession.v2.${user.id}`);
-            }
-            localStorage.removeItem('activeSession');
-        } catch {}
-		setActiveSession(null);
-		if (showReport === false) {
-			setView('dashboard');
-			return;
-		}
-        setReportBackView('dashboard');
-        setReportData({ current: sessionData, previous: null });
-        setView('report');
-    };
-
-    // Handlers CRUD
-    const openManualWorkoutEditor = () => {
-        setCurrentWorkout({ title: '', exercises: [] })
-        setView('edit')
-    }
-	const handleCreateWorkout = () => { setCreateWizardOpen(true) };
-
-	const handleEditWorkout = async (workout) => {
-		if (!workout || !workout.id) return;
-		try {
-			const supabase = createClient();
-			const { data, error } = await supabase
-				.from('workouts')
-				.select('*, exercises(*, sets(*))')
-				.eq('id', workout.id)
-				.maybeSingle();
-			if (error) throw error;
-			if (!data) {
-				setCurrentWorkout(workout);
-				setView('edit');
-				return;
-			}
-			const mapped = mapWorkoutRow(data);
-            try {
-                const resolved = await resolveExerciseVideos(mapped?.exercises || []);
-                const exercises = Array.isArray(resolved?.exercises) ? resolved.exercises : (mapped?.exercises || []);
-                persistExerciseVideoUrls(resolved?.updates || []);
-                setCurrentWorkout({ ...mapped, exercises });
-            } catch {
-                setCurrentWorkout(mapped);
-            }
-			setView('edit');
-		} catch (e) {
-			const msg = e?.message || String(e || '');
-			await alert('Erro ao carregar treino para edição: ' + msg);
-		}
-	};
-
-    const handleSaveWorkout = useCallback(async (workoutToSave) => {
-        const w = workoutToSave || currentWorkout;
-        if (!user || !w || !w.title) return { ok: false, error: 'Treino inválido ou usuário ausente' };
-        try {
-            if (w.id) {
-                const res = await updateWorkout(w.id, w);
-                setCurrentWorkout(w);
-                return res;
-            } else {
-                const created = await createWorkout(w);
-                const id = created?.id ?? null;
-                setCurrentWorkout({ ...w, id });
-                return created;
-            }
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e || 'Falha ao salvar treino');
-            return { ok: false, error: msg };
-        }
-    }, [currentWorkout, user]);
-
-    const handlePersistWorkoutTemplateFromSession = useCallback(async (workoutFromSession) => {
-        try {
-            const normalized = normalizeWorkoutForEditor(workoutFromSession);
-            const cleaned = stripWorkoutInternalKeys(normalized);
-            if (!cleaned || !cleaned.title) return { ok: false, error: 'Treino inválido para salvar' };
-
-            if (cleaned.id) {
-                await updateWorkout(cleaned.id, cleaned);
-                try {
-                    await fetchWorkouts();
-                } catch {}
-                return { ok: true, mode: 'update' };
-            }
-
-            const created = await createWorkout(cleaned);
-            try {
-                await fetchWorkouts();
-            } catch {}
-            return { ok: true, mode: 'create', id: created?.id ?? null };
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e);
-            return { ok: false, error: msg || 'Falha ao salvar treino' };
-        }
-    }, [fetchWorkouts, normalizeWorkoutForEditor, stripWorkoutInternalKeys]);
-
-    const handleOpenActiveWorkoutEditor = useCallback((options = {}) => {
-        try {
-            if (!activeSession?.workout) return;
-            const base = normalizeWorkoutForEditor(activeSession.workout);
-            const shouldAddExercise = options && typeof options === 'object' ? !!options.addExercise : false;
-            editActiveAddExerciseRef.current = shouldAddExercise;
-            const nextBase = shouldAddExercise
-                ? {
-                    ...base,
-                    exercises: [
-                        ...(Array.isArray(base?.exercises) ? base.exercises : []),
-                        {
-                            name: '',
-                            sets: 4,
-                            reps: '10',
-                            rpe: '8',
-                            cadence: '2020',
-                            restTime: 60,
-                            method: 'Normal',
-                            videoUrl: '',
-                            notes: ''
-                        }
-                    ]
-                }
-                : base;
-            editActiveBaseRef.current = base;
-            setEditActiveDraft(nextBase);
-            setEditActiveOpen(true);
-        } catch {}
-    }, [activeSession?.workout, normalizeWorkoutForEditor]);
-
-    const handleCloseActiveWorkoutEditor = useCallback(() => {
-        try {
-            setEditActiveOpen(false);
-            setEditActiveDraft(null);
-            editActiveBaseRef.current = null;
-            editActiveAddExerciseRef.current = false;
-        } catch {}
-    }, []);
-
-    const handleSaveActiveWorkoutEditor = useCallback(async (workoutFromEditor) => {
-        const normalized = normalizeWorkoutForEditor(workoutFromEditor);
-        const cleaned = stripWorkoutInternalKeys(normalized);
-        const shouldDeferPersist = !!editActiveAddExerciseRef.current;
-        const res = shouldDeferPersist ? { deferred: true } : await handleSaveWorkout(cleaned);
-        setActiveSession((prev) => {
-            if (!prev) return prev;
-            const oldWorkout = editActiveBaseRef.current || normalizeWorkoutForEditor(prev.workout);
-            const nextLogs = reindexSessionLogsAfterWorkoutEdit(oldWorkout, normalized, prev.logs || {});
-            const baseUi = prev?.ui && typeof prev.ui === 'object' ? prev.ui : {};
-            const nextUi = shouldDeferPersist ? { ...baseUi, pendingTemplateUpdate: true } : baseUi;
-            return { ...prev, workout: normalized, logs: nextLogs, ui: nextUi };
-        });
-        editActiveBaseRef.current = normalized;
-        setEditActiveDraft(normalized);
-        return res;
-    }, [handleSaveWorkout, normalizeWorkoutForEditor, reindexSessionLogsAfterWorkoutEdit, stripWorkoutInternalKeys]);
-
-	const handleDeleteWorkout = async (id, title) => {
-		const name = title || (workouts.find(w => w.id === id)?.title) || 'este treino';
-		if (!(await confirm(`Apagar o treino "${name}"?`, "Excluir Treino"))) return;
-		try {
-			const res = await deleteWorkout(id);
-			if (!res?.success) {
-				await alert("Erro: " + (res?.error || 'Falha ao excluir treino'));
-				return;
-			}
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro: " + (e?.message ?? String(e))); }
-	};
-
-    const handleRestoreWorkout = async (workout) => {
-        const id = String(workout?.id || '').trim()
-        if (!id) return
-        const name = workout?.title || 'este treino'
-        if (!(await confirm(`Restaurar o treino "${name}"?`, 'Restaurar Treino'))) return
-        try {
-            const res = await setWorkoutArchived(id, false)
-            if (!res?.ok) {
-                await alert('Erro: ' + (res?.error || 'Falha ao restaurar treino'))
-                return
-            }
-            await fetchWorkouts()
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)))
-        }
-    }
-
-	const handleDuplicateWorkout = async (workout) => {
-		if (!(await confirm(`Duplicar "${workout.title}"?`, "Duplicar Treino"))) return;
-		const newWorkout = { ...workout, title: `${workout.title} (Cópia)` };
-		delete newWorkout.id;
-		try {
-			await createWorkout(newWorkout);
-			await fetchWorkouts();
-		} catch (e) { await alert("Erro ao duplicar: " + (e?.message ?? String(e))); }
-	};
-
-    const handleBulkEditWorkouts = async (items) => {
-        try {
-            const arr = Array.isArray(items) ? items : []
-            if (!arr.length) return
-            let updatedTitles = 0
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const w = workouts.find((x) => String(x?.id || '') === id)
-                if (!w) continue
-
-                const desiredTitle = String(it?.title || '').trim() || String(w?.title || 'Treino')
-                if (desiredTitle !== String(w?.title || '')) {
-                    const r = await updateWorkout(id, { title: desiredTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                    if (!r?.ok) throw new Error(String(r?.error || 'Falha ao renomear treino'))
-                    updatedTitles += 1
-                }
-            }
-
-            let sortSaved = true
-            let sortError = ''
-            for (let i = 0; i < arr.length; i += 1) {
-                const it = arr[i]
-                const id = String(it?.id || '').trim()
-                if (!id) continue
-                const r2 = await setWorkoutSortOrder(id, i)
-                if (!r2?.ok) {
-                    sortSaved = false
-                    sortError = String(r2?.error || 'Falha ao ordenar treinos')
-                    break
-                }
-            }
-
-            await fetchWorkouts()
-
-            if (!sortSaved) {
-                const suffix = sortError ? `\n\n${sortError}` : ''
-                await alert(`Lista salva parcialmente: a ordenação não foi aplicada.${suffix}`)
-                return
-            }
-
-            if (updatedTitles) {
-                await alert(`Lista salva: ${updatedTitles} título(s) atualizado(s).`)
-            } else {
-                await alert('Lista salva.')
-            }
-        } catch (e) {
-            await alert('Erro ao salvar lista: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeAiWorkoutTitles = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const title = String(w?.title || '').trim()
-                    const m = title.match(/\(\s*dia\s*(\d+)\s*\)/i)
-                    if (!m?.[1]) return null
-                    const day = Number(m[1])
-                    if (!Number.isFinite(day) || day <= 0) return null
-                    return { workout: w, dayIndex: Math.floor(day - 1) }
-                })
-                .filter(Boolean)
-            if (!candidates.length) {
-                await alert('Nenhum treino no formato antigo “(Dia X)” foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar nomes de ${candidates.length} treinos gerados automaticamente?`, 'Padronizar nomes'))) return
-
-            let changed = 0
-            for (const item of candidates) {
-                const w = item.workout
-                const idx = item.dayIndex
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle, idx, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, { title: nextTitle, notes: w?.notes ?? '', exercises: Array.isArray(w?.exercises) ? w.exercises : [] })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                changed += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${changed} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar nomes: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleApplyTitleRule = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            if (!list.length) {
-                await alert('Nenhum treino encontrado.')
-                return
-            }
-            if (!(await confirm(`Padronizar títulos de ${list.length} treinos com A/B/C... e dia da semana?`, 'Padronizar títulos'))) return
-            let updated = 0
-            for (let i = 0; i < list.length; i += 1) {
-                const w = list[i]
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const oldTitle = String(w?.title || '').trim()
-                const nextTitle = formatProgramWorkoutTitle(oldTitle || 'Treino', i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                if (!nextTitle || nextTitle === oldTitle) continue
-                const res = await updateWorkout(id, {
-                    title: nextTitle,
-                    notes: w?.notes ?? '',
-                    exercises: Array.isArray(w?.exercises) ? w.exercises : [],
-                })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao renomear treino'))
-                updated += 1
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            await alert(`Padronização concluída: ${updated} treinos atualizados.`)
-        } catch (e) {
-            await alert('Erro ao padronizar títulos: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleNormalizeExercises = async () => {
-        try {
-            const list = Array.isArray(workouts) ? workouts : []
-            const candidates = list
-                .map((w) => {
-                    const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-                    let changesCount = 0
-                    const nextExercises = exercises.map((ex) => {
-                        const name = String(ex?.name || '').trim()
-                        if (!name) return ex
-                        const info = resolveCanonicalExerciseName(name)
-                        if (!info?.changed || !info?.canonical) return ex
-                        changesCount += 1
-                        return { ...ex, name: info.canonical }
-                    })
-                    if (!changesCount) return null
-                    return { workout: w, nextExercises, changesCount }
-                })
-                .filter(Boolean)
-
-            if (!candidates.length) {
-                await alert('Nenhum exercício para normalizar foi encontrado.')
-                return
-            }
-            if (!(await confirm(`Normalizar exercícios em ${candidates.length} treinos?`, 'Normalizar exercícios'))) return
-
-            let updated = 0
-            const updatedWorkouts = []
-            for (const item of candidates) {
-                const w = item.workout
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const title = String(w?.title || '').trim() || `Treino ${id.slice(0, 8)}`
-                const notes = w?.notes ?? ''
-                const res = await updateWorkout(id, { title, notes, exercises: item.nextExercises })
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao atualizar treino'))
-                updated += 1
-                updatedWorkouts.push({ title, changesCount: Number(item?.changesCount || 0) })
-            }
-            try {
-                await fetchWorkouts()
-            } catch {}
-            const lines = updatedWorkouts
-                .slice(0, 10)
-                .map((it) => `• ${it.title}${it.changesCount ? ` (${it.changesCount} exercício(s))` : ''}`)
-                .join('\n')
-            const more = updatedWorkouts.length > 10 ? `\n(+${updatedWorkouts.length - 10} outros)` : ''
-            const detail = lines ? `\n\nTreinos atualizados:\n${lines}${more}` : ''
-            await alert(`Normalização concluída: ${updated} treinos atualizados.${detail}`)
-        } catch (e) {
-            await alert('Erro ao normalizar exercícios: ' + (e?.message ?? String(e)))
-        }
-    }
-
-    const handleOpenDuplicates = async () => {
-        const list = (Array.isArray(workouts) ? workouts : []).filter((w) => !w?.archived_at)
-        const keys = list.map((w) => {
-            const exercises = Array.isArray(w?.exercises) ? w.exercises : []
-            const set = new Set()
-            for (const ex of exercises) {
-                const name = String(ex?.name || '').trim()
-                if (!name) continue
-                const info = resolveCanonicalExerciseName(name)
-                const base = String(info?.canonical || name).trim()
-                const k = normalizeExerciseName(base)
-                if (k) set.add(k)
-            }
-            return set
-        })
-
-        const parent = Array.from({ length: list.length }).map((_, i) => i)
-        const find = (x) => {
-            let r = x
-            while (parent[r] !== r) r = parent[r]
-            let cur = x
-            while (parent[cur] !== cur) {
-                const p = parent[cur]
-                parent[cur] = r
-                cur = p
-            }
-            return r
-        }
-        const unite = (a, b) => {
-            const ra = find(a)
-            const rb = find(b)
-            if (ra !== rb) parent[rb] = ra
-        }
-
-        const similarity = (a, b) => {
-            const A = keys[a]
-            const B = keys[b]
-            if (!A?.size || !B?.size) return 0
-            let inter = 0
-            for (const v of A) if (B.has(v)) inter += 1
-            const union = A.size + B.size - inter
-            if (!union) return 0
-            return inter / union
-        }
-
-        const edges = []
-        for (let i = 0; i < list.length; i += 1) {
-            for (let j = i + 1; j < list.length; j += 1) {
-                const score = similarity(i, j)
-                if (score >= 0.9) {
-                    unite(i, j)
-                    edges.push({ i, j, score })
-                }
-            }
-        }
-
-        const groupsMap = new Map()
-        for (let i = 0; i < list.length; i += 1) {
-            const r = find(i)
-            const arr = groupsMap.get(r) || []
-            arr.push(i)
-            groupsMap.set(r, arr)
-        }
-
-        const groups = []
-        for (const idxs of groupsMap.values()) {
-            if (!idxs || idxs.length < 2) continue
-            let best = 0
-            for (const e of edges) {
-                if (idxs.includes(e.i) && idxs.includes(e.j)) best = Math.max(best, e.score)
-            }
-            groups.push({ items: idxs.map((i) => list[i]), score: best || 0.9 })
-        }
-
-        if (!groups.length) {
-            await alert('Não encontrei duplicados com alta similaridade.')
-            return
-        }
-        groups.sort((a, b) => b.score - a.score)
-        setDuplicateGroups(groups)
-        setDuplicatesOpen(true)
-    }
-
-    const handleArchiveDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Arquivar ${others.length} duplicados e manter "${base?.title || 'Treino'}"?`, 'Arquivar duplicados'))) return
-            setDuplicatesBusy(true)
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const res = await setWorkoutArchived(id, true)
-                if (!res?.ok) throw new Error(String(res?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao arquivar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleMergeDuplicateGroup = async (group) => {
-        if (duplicatesBusy) return
-        try {
-            if (!group?.items || group.items.length < 2) return
-            const base = group.items[0]
-            const others = group.items.slice(1)
-            if (!(await confirm(`Mesclar ${others.length} duplicados em "${base?.title || 'Treino'}" e arquivar os demais?`, 'Mesclar duplicados'))) return
-            setDuplicatesBusy(true)
-
-            const baseExercises = Array.isArray(base?.exercises) ? base.exercises : []
-            const seen = new Set()
-            const merged = []
-            for (const ex of baseExercises) {
-                const name = String(ex?.name || '').trim()
-                const method = String(ex?.method || '').trim()
-                const reps = String(ex?.reps || '').trim()
-                const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                if (k && !seen.has(k)) {
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-            for (const w of others) {
-                const exs = Array.isArray(w?.exercises) ? w.exercises : []
-                for (const ex of exs) {
-                    const name = String(ex?.name || '').trim()
-                    const method = String(ex?.method || '').trim()
-                    const reps = String(ex?.reps || '').trim()
-                    const k = `${normalizeExerciseName(resolveCanonicalExerciseName(name).canonical || name)}|${method}|${reps}`
-                    if (!k || seen.has(k)) continue
-                    seen.add(k)
-                    merged.push(ex)
-                }
-            }
-
-            const baseId = String(base?.id || '').trim()
-            if (!baseId) throw new Error('Treino base sem ID')
-            const res = await updateWorkout(baseId, { title: String(base?.title || 'Treino'), notes: base?.notes ?? '', exercises: merged })
-            if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino mesclado'))
-
-            for (const w of others) {
-                const id = String(w?.id || '').trim()
-                if (!id) continue
-                const a = await setWorkoutArchived(id, true)
-                if (!a?.ok) throw new Error(String(a?.error || 'Falha ao arquivar'))
-            }
-            await fetchWorkouts()
-            setDuplicatesOpen(false)
-            setDuplicateGroups([])
-        } catch (e) {
-            await alert('Erro ao mesclar duplicados: ' + (e?.message ?? String(e)))
-        } finally {
-            setDuplicatesBusy(false)
-        }
-    }
-
-    const handleShareWorkout = async (workout) => {
-        setExportWorkout(workout);
-        setShowExportModal(true);
-    };
-
-	const handleExportPdf = async () => {
-		if (!exportWorkout) return;
-		try {
-			const html = workoutPlanHtml(exportWorkout, user);
-			const win = window.open('', '_blank');
-			if (!win) return;
-			win.document.open();
-			win.document.write(html);
-			win.document.close();
-			win.focus();
-			setTimeout(() => { try { win.print(); } catch {} }, 300);
-			setShowExportModal(false);
-		} catch (e) { await alert('Erro ao gerar PDF: ' + (e?.message ?? String(e))); }
-	};
-
-    const handleExportJson = () => {
-        if (!exportWorkout) return;
-        const json = JSON.stringify({ workout: { title: exportWorkout.title, exercises: (exportWorkout.exercises || []).map(ex => ({ name: ex.name, sets: ex.sets, reps: ex.reps, rpe: ex.rpe, cadence: ex.cadence, restTime: ex.restTime, method: ex.method, videoUrl: ex.videoUrl, notes: ex.notes })) } }, null, 2);
-        const blob = new Blob([json], { type: 'application/json' });
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement('a');
-        a.href = url;
-        a.download = `${(exportWorkout.title || 'treino').replace(/\s+/g,'_')}.json`;
-        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        setShowExportModal(false);
-    };
-
-    const handleExportAllWorkouts = async () => {
-        try {
-            setExportingAll(true);
-            const payload = {
-                user: { id: user?.id || '', email: user?.email || '' },
-                workouts: (workouts || []).map(w => ({
-                    id: w.id,
-                    title: w.title,
-                    notes: w.notes,
-                    is_template: true,
-                    exercises: (w.exercises || []).map(ex => ({
-                        name: ex.name,
-                        sets: ex.sets,
-                        reps: ex.reps,
-                        rpe: ex.rpe,
-                        cadence: ex.cadence,
-                        restTime: ex.restTime,
-                        method: ex.method,
-                        videoUrl: ex.videoUrl,
-                        notes: ex.notes
-                    }))
-                }))
-            };
-            const json = JSON.stringify(payload, null, 2);
-            const blob = new Blob([json], { type: 'application/json' });
-            const url = URL.createObjectURL(blob);
-            const a = document.createElement('a');
-            a.href = url;
-            a.download = `irontracks_workouts_${new Date().toISOString()}.json`;
-            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        } catch (e) {
-        } finally {
-            setExportingAll(false);
-        }
-    };
-
-    const handleImportWorkout = async () => {
-        await alert("Funcionalidade de importar código temporariamente indisponível na migração.", "Em Manutenção");
-    };
-
-    // JSON IMPORT HANDLER
-    const handleJsonUpload = (e) => {
-        const input = e?.target;
-        const file = input?.files?.[0];
-        if (!file) return;
-        try {
-            setShowJsonImportModal(false);
-        } catch {}
-
-        const reader = new FileReader();
-        reader.onload = async (event) => {
-            try {
-                const json = JSON.parse(event.target.result);
-                if (await confirm(`Importar dados de ${json.user?.email || 'Unknown'}? Isso criará novos treinos.`, "Importar Backup")) {
-                    await importData(json);
-                    await fetchWorkouts();
-                    await alert("Dados importados com sucesso!", "Sucesso");
-                }
-		} catch (err) {
-			await alert("Erro ao ler arquivo JSON: " + (err?.message ?? String(err)));
-		} finally {
-            try {
-                if (input) input.value = '';
-            } catch {}
-		}
-	};
-        reader.readAsText(file);
-    };
-
-    if (authLoading) return <LoadingScreen />;
-    if (!user?.id) return <LoadingScreen />;
-
-    const currentWorkoutId = activeSession?.workout?.id;
-    let nextWorkout = null;
-    if (currentWorkoutId && Array.isArray(workouts) && workouts.length > 0) {
-        const index = workouts.findIndex(w => w.id === currentWorkoutId);
-        if (index !== -1 && index + 1 < workouts.length) {
-            nextWorkout = workouts[index + 1];
-        }
-    }
-
-    const isHeaderVisible = view !== 'active' && view !== 'report';
-
-    return (
-        <InAppNotificationsProvider
-            userId={user?.id || null}
-            settings={userSettingsApi?.settings ?? null}
-            onOpenMessages={() => setView('chat')}
-            onOpenNotifications={() => {
-                setShowNotifCenter(true);
-                setHasUnreadNotification(false);
-            }}
-        >
-        <InAppNotifyBinder bind={bindInAppNotify} />
-        <TeamWorkoutProvider user={user} settings={userSettingsApi?.settings ?? null} onStartSession={handleStartSession}>
-            <div className="w-full bg-neutral-900 min-h-screen relative flex flex-col overflow-hidden" suppressHydrationWarning>
-                <IncomingInviteModal onStartSession={handleStartSession} />
-                <InviteAcceptedModal />
-                <GuidedTour
-                    open={Boolean(tourOpen)}
-                    steps={getTourSteps({
-                        role: user?.role,
-                        hasCommunity: (userSettingsApi?.settings?.moduleCommunity !== false),
-                    })}
-                    actions={{
-                        openAdminPanel: (tab) => {
-                            try {
-                                const safe = String(tab || 'dashboard').trim() || 'dashboard'
-                                openAdminPanel(safe)
-                            } catch {}
-                        },
-                    }}
-                    onEvent={(name, payload) => {
-                        logTourEvent(name, payload)
-                    }}
-                    onComplete={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: true, skipped: false, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'completed') } catch {}
-                        const res = await upsertTourFlags({ tour_completed_at: new Date().toISOString(), tour_skipped_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (completed). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_completed', { version: TOUR_VERSION })
-                    }}
-                    onSkip={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (skipped). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_skipped', { version: TOUR_VERSION })
-                    }}
-                    onCancel={async () => {
-                        setTourOpen(false)
-                        setTourBoot((prev) => ({ ...(prev || {}), completed: false, skipped: true, version: TOUR_VERSION }))
-                        try { writeLocalTourDismissal(user?.id, 'skipped') } catch {}
-                        const res = await upsertTourFlags({ tour_skipped_at: new Date().toISOString(), tour_completed_at: null })
-                        if (!res?.ok) {
-                            console.warn('Falha ao persistir flags do tour (cancelled). Mantendo fallback local.', res)
-                        }
-                        await logTourEvent('tour_cancelled', { version: TOUR_VERSION })
-                    }}
-                />
-
-                {/* Header */}
-                {isHeaderVisible && (
-                    <div className="bg-neutral-950 flex justify-between items-center fixed top-0 left-0 right-0 z-40 border-b border-zinc-800 px-6 shadow-lg pt-[env(safe-area-inset-top)] min-h-[calc(4rem+env(safe-area-inset-top))]">
-                        <div 
-                            className="flex items-center cursor-pointer group"
-                            onClick={() => setView('dashboard')}
-                        >
-                            <div className="flex items-center gap-2">
-                                <Dumbbell size={18} className="text-yellow-500 opacity-25" />
-                                <h1 className="text-2xl font-black tracking-tighter italic leading-none text-white group-hover:opacity-80 transition-opacity">
-                                    IRON<span className="text-yellow-500">TRACKS</span>
-                                </h1>
-                            </div>
-                            <div className="h-6 w-px bg-yellow-500 mx-4 opacity-50"></div>
-                            <div className="flex items-center gap-2">
-                                <span className="text-zinc-400 text-xs font-medium tracking-wide uppercase">
-                                    {isCoach ? 'Bem vindo Coach' : 'Bem vindo Atleta'}
-                                </span>
-                                {vipAccess?.hasVip && (
-                                    <div className="flex items-center gap-1.5 px-2 py-0.5 rounded-md bg-yellow-500/10 border border-yellow-500/20 shadow-[0_0_10px_-3px_rgba(234,179,8,0.3)] mr-3">
-                                        <Crown size={11} className="text-yellow-500 fill-yellow-500" />
-                                        <span className="text-[10px] font-black text-yellow-500 tracking-widest leading-none">VIP</span>
-                                    </div>
-                                )}
-                            </div>
-                        </div>
-                        
-                        <div className="flex items-center gap-4">
-                                {(() => {
-                                    const pending = Number(syncState?.pending || 0)
-                                    const failed = Number(syncState?.failed || 0)
-                                    const online = syncState?.online !== false
-                                    const settings = userSettingsApi?.settings && typeof userSettingsApi.settings === 'object' ? userSettingsApi.settings : null
-                                    const offlineSyncV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureOfflineSyncV2 === true
-                                    if (!online) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/10 border border-red-500/30 text-red-300 text-xs font-black uppercase tracking-widest">
-                                                Offline
-                                            </div>
-                                        )
-                                    }
-                                    if (offlineSyncV2Enabled && (pending > 0 || failed > 0)) {
-                                        return (
-                                            <button
-                                                type="button"
-                                                onClick={() => setOfflineSyncOpen(true)}
-                                                className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest hover:bg-yellow-500/15"
-                                                title="Abrir central de pendências"
-                                            >
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}{failed > 0 ? ` • Falhas: ${failed}` : ''}
-                                            </button>
-                                        )
-                                    }
-                                    if (pending > 0) {
-                                        return (
-                                            <div className="hidden sm:inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-black uppercase tracking-widest">
-                                                {syncState?.syncing ? 'Sincronizando' : 'Pendentes'}: {pending}
-                                            </div>
-                                        )
-                                    }
-                                    return null
-                                })()}
-                                <HeaderActionsMenu
-                                user={user}
-                                isCoach={isCoach}
-                                hasUnreadChat={hasUnreadChat}
-                                hasUnreadNotification={hasUnreadNotification}
-                                onOpenAdmin={() => {
-                                    if (typeof window !== 'undefined') {
-                                        const url = new URL(window.location);
-                                        url.searchParams.delete('view');
-                                        window.history.replaceState({}, '', url);
-                                    }
-                                    const tab = (() => {
-                                        try {
-                                            const url = new URL(window.location.href);
-                                            const current = String(url.searchParams.get('tab') || '').trim();
-                                            if (current) return current;
-                                        } catch {}
-                                        try {
-                                            const stored = String(sessionStorage.getItem(ADMIN_PANEL_TAB_KEY) || '').trim();
-                                            if (stored) return stored;
-                                        } catch {}
-                                        return 'dashboard';
-                                    })();
-                                    openAdminPanel(tab);
-                                }}
-                                onOpenChatList={() => setView('chatList')}
-                                onOpenGlobalChat={() => setView('globalChat')}
-                                onOpenHistory={() => setView('history')}
-                                onOpenNotifications={() => {
-                                    setShowNotifCenter(true);
-                                    setHasUnreadNotification(false);
-                                }}
-                                onOpenSchedule={() => router.push('/dashboard/schedule')}
-                                onOpenSettings={() => setSettingsOpen(true)}
-                                onOpenTour={async () => {
-                                    try {
-                                        await logTourEvent('tour_started', { auto: false, version: TOUR_VERSION })
-                                    } catch {}
-                                    setTourOpen(true)
-                                }}
-                                onLogout={handleLogout}
-                            />
-                        </div>
-                    </div>
-                )}
-
-                {isCoach && coachPending && (
-                    <div className="bg-yellow-500 text-black text-sm font-bold px-4 py-2 text-center">
-                        Sua conta de Professor está pendente. <button className="underline" onClick={async () => { try { const r = await fetch('/api/teachers/accept', { method: 'POST' }); const j = await r.json(); if (j.ok) { setCoachPending(false); await alert('Conta ativada!'); } else { await alert('Falha ao ativar: ' + (j.error || '')); } } catch (e) { await alert('Erro: ' + (e?.message ?? String(e))); } }}>Aceitar</button>
-                    </div>
-                )}
-
-                {/* Main Content */}
-                <div
-                    className="flex-1 overflow-y-auto custom-scrollbar relative"
-                    style={{
-                        '--dashboard-sticky-top': isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : '0px',
-                        paddingTop: isHeaderVisible ? 'calc(4rem + env(safe-area-inset-top))' : undefined,
-                    }}
-                >
-                    {(view === 'dashboard' || view === 'assessments' || view === 'community' || view === 'vip') && (
-                        <StudentDashboard
-                            workouts={Array.isArray(workouts) ? workouts : []}
-                            profileIncomplete={Boolean(profileIncomplete)}
-                            onOpenCompleteProfile={() => setShowCompleteProfile(true)}
-                            view={view === 'assessments' ? 'assessments' : view === 'community' ? 'community' : view === 'vip' ? 'vip' : 'dashboard'}
-                            onChangeView={(next) => setView(next)}
-                            assessmentsContent={(user?.id || initialUser?.id) ? <AssessmentHistory studentId={user?.id || initialUser?.id} /> : null}
-                            communityContent={(user?.id || initialUser?.id) ? <CommunityClient embedded /> : null}
-                            vipContent={<VipHub user={user} locked={!vipAccess?.hasVip} onOpenWorkoutEditor={(w) => handleEditWorkout(w)} onOpenVipTab={() => setView('vip')} />}
-                            vipLabel="VIP"
-                            vipLocked={!vipAccess?.hasVip}
-                            vipEnabled={true}
-                            settings={userSettingsApi?.settings ?? null}
-                            onCreateWorkout={handleCreateWorkout}
-                            onQuickView={(w) => setQuickViewWorkout(w)}
-                            onStartSession={(w) => handleStartSession(w)}
-                            onRestoreWorkout={(w) => handleRestoreWorkout(w)}
-                            onShareWorkout={(w) => handleShareWorkout(w)}
-                            onDuplicateWorkout={(w) => handleDuplicateWorkout(w)}
-                            onEditWorkout={(w) => handleEditWorkout(w)}
-                            onDeleteWorkout={(id, title) => handleDeleteWorkout(id, title)}
-                            onBulkEditWorkouts={handleBulkEditWorkouts}
-                            currentUserId={user?.id || initialUser?.id}
-                            exportingAll={Boolean(exportingAll)}
-                            onExportAll={handleExportAllWorkouts}
-                            streakStats={streakStats}
-                            onOpenJsonImport={() => setShowJsonImportModal(true)}
-                            onNormalizeAiWorkoutTitles={handleNormalizeAiWorkoutTitles}
-                            onNormalizeExercises={handleNormalizeExercises}
-                            onOpenDuplicates={handleOpenDuplicates}
-                            onApplyTitleRule={handleApplyTitleRule}
-                            onOpenIronScanner={async () => {
-                                try {
-                                    openManualWorkoutEditor()
-                                    await alert('No editor, clique em Scanner de Treino (Imagem).', 'Scanner')
-                                } catch {}
-                            }}
-                        />
-                    )}
-
-                    <WorkoutWizardModal
-                        isOpen={createWizardOpen}
-                        onClose={() => setCreateWizardOpen(false)}
-                        onManual={() => openManualWorkoutEditor()}
-                        onGenerate={async (answers, options) => {
-                            const mode = String(options?.mode || 'single').trim().toLowerCase();
-                            try {
-                                const res = await fetch('/api/ai/workout-wizard', {
-                                    method: 'POST',
-                                    headers: { 'Content-Type': 'application/json' },
-                                    body: JSON.stringify({ answers, mode }),
-                                })
-                                const data = await res.json().catch(() => null)
-                                if (!res.ok) {
-                                    const msg = data?.error ? String(data.error) : 'Falha ao gerar treino com IA.'
-                                    throw new Error(msg)
-                                }
-                                if (mode === 'program') {
-                                    const drafts = Array.isArray(data?.drafts) ? data.drafts : null
-                                    if (drafts && drafts.length) return { drafts }
-                                    if (data?.ok === false && Array.isArray(data?.drafts) && data.drafts.length) return { drafts: data.drafts }
-                                    throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                                }
-                                const draft = data?.draft && typeof data.draft === 'object' ? data.draft : null
-                                if (draft?.exercises && Array.isArray(draft.exercises) && draft.exercises.length > 0) return draft
-                                if (data?.ok === false && data?.draft) return data.draft
-                                throw new Error(data?.error ? String(data.error) : 'Resposta inválida da IA.')
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                const lower = msg.toLowerCase()
-                                const isConfig = lower.includes('api de ia não configurada') || lower.includes('google_generative_ai_api_key')
-                                if (isConfig) throw e
-                                if (mode === 'program') {
-                                    const days = Math.max(2, Math.min(6, Number(answers?.daysPerWeek || 3) || 3))
-                                    const drafts = []
-                                    for (let i = 0; i < days; i++) {
-                                        drafts.push(generateWorkoutFromWizard(answers, i))
-                                    }
-                                    return { drafts }
-                                }
-                                return generateWorkoutFromWizard(answers, 0)
-                            }
-                        }}
-                        onSaveDrafts={async (drafts) => {
-                            const list = Array.isArray(drafts) ? drafts : []
-                            if (!list.length) return
-                            try {
-                                for (let i = 0; i < list.length; i += 1) {
-                                    const d = list[i]
-                                    const baseTitle = String(d?.title || 'Treino').trim() || 'Treino'
-                                    const finalTitle = formatProgramWorkoutTitle(baseTitle, i, { startDay: userSettingsApi?.settings?.programTitleStartDay })
-                                    const exercises = Array.isArray(d?.exercises) ? d.exercises : []
-                                    const res = await createWorkout({ title: finalTitle, exercises })
-                                    if (!res?.ok) throw new Error(String(res?.error || 'Falha ao salvar treino'))
-                                }
-                                try {
-                                    await fetchWorkouts()
-                                } catch {}
-                                setCreateWizardOpen(false)
-                                await alert(`Plano salvo: ${list.length} treinos criados.`)
-                            } catch (e) {
-                                const msg = e?.message ? String(e.message) : String(e)
-                                await alert('Erro ao salvar plano: ' + msg)
-                            }
-                        }}
-                        onUseDraft={(draft) => {
-                            try {
-                                const title = String(draft?.title || '').trim() || 'Treino'
-                                const exercises = Array.isArray(draft?.exercises) ? draft.exercises : []
-                                setCurrentWorkout({ title, exercises })
-                                setView('edit')
-                            } finally {
-                                setCreateWizardOpen(false)
-                            }
-                        }}
-                    />
-
-					{view === 'edit' && (
-						<ExerciseEditor
-							workout={currentWorkout}
-							onCancel={() => setView('dashboard')}
-							onChange={setCurrentWorkout}
-							onSave={handleSaveWorkout}
-							onSaved={() => {
-								fetchWorkouts().catch(() => {});
-								setView('dashboard');
-							}}
-						/>
-					)}
-
-                    {view === 'active' && activeSession && (
-                        <ActiveWorkout
-                            session={activeSession}
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onUpdateLog={handleUpdateSessionLog}
-                            onFinish={handleFinishSession}
-                            onPersistWorkoutTemplate={handlePersistWorkoutTemplateFromSession}
-                            onBack={() => setView('dashboard')}
-                            onStartTimer={handleStartTimer}
-                            isCoach={isCoach}
-                            onUpdateSession={(updates) => setActiveSession(prev => ({ ...prev, ...updates }))}
-                            nextWorkout={nextWorkout}
-                            onEditWorkout={() => handleOpenActiveWorkoutEditor()}
-                            onAddExercise={() => handleOpenActiveWorkoutEditor({ addExercise: true })}
-                        />
-                    )}
-
-                    {editActiveOpen && view === 'active' && editActiveDraft && (
-                        <div
-                            className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-3 md:p-6 pt-safe"
-                            onClick={() => handleCloseActiveWorkoutEditor()}
-                        >
-                            <div
-                                className="w-full max-w-5xl h-[92vh] bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-                                onClick={(e) => e.stopPropagation()}
-                            >
-                                <ExerciseEditor
-                                    workout={editActiveDraft}
-                                    onCancel={() => handleCloseActiveWorkoutEditor()}
-                                    onChange={(w) => setEditActiveDraft(normalizeWorkoutForEditor(w))}
-                                    onSave={handleSaveActiveWorkoutEditor}
-                                    onSaved={() => {
-                                        fetchWorkouts().catch(() => {});
-                                        handleCloseActiveWorkoutEditor();
-                                    }}
-                                />
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'history' && (
-                        <HistoryList
-                            user={user}
-                            settings={userSettingsApi?.settings ?? null}
-                            onViewReport={(s) => { setReportBackView('history'); setReportData({ current: s, previous: null }); setView('report'); }}
-                            onBack={() => setView('dashboard')}
-                        />
-                    )}
-
-                    {/* Evolução removida conforme solicitação */}
-
-                    {view === 'report' && reportData.current && (
-                        <div className="fixed inset-0 z-[1200] bg-neutral-900 overflow-y-auto pt-safe">
-                            <WorkoutReport
-                                session={reportData.current}
-                                previousSession={reportData.previous}
-                                user={user}
-                                isVip={vipAccess?.hasVip}
-                                settings={userSettingsApi?.settings ?? null}
-                                onClose={() => setView(reportBackView || 'dashboard')}
-                            />
-                        </div>
-                    )}
-
-                    {duplicatesOpen && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe" onClick={() => !duplicatesBusy && setDuplicatesOpen(false)}>
-                            <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Ferramentas</div>
-                                        <div className="text-white font-black text-lg truncate">Duplicados</div>
-                                        <div className="text-xs text-neutral-400 truncate">{Array.isArray(duplicateGroups) ? `${duplicateGroups.length} grupos` : ''}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => setDuplicatesOpen(false)}
-                                        disabled={duplicatesBusy}
-                                        className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center disabled:opacity-50"
-                                        aria-label="Fechar"
-                                    >
-                                        <X size={18} />
-                                    </button>
-                                </div>
-                                <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-                                    {(Array.isArray(duplicateGroups) ? duplicateGroups : []).map((g, idx) => {
-                                        const items = Array.isArray(g?.items) ? g.items : []
-                                        const score = Number(g?.score || 0)
-                                        const base = items[0]
-                                        return (
-                                            <div key={`dup-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-4">
-                                                <div className="flex items-start justify-between gap-3">
-                                                    <div className="min-w-0">
-                                                        <div className="text-xs text-neutral-500 font-bold uppercase tracking-widest">Similaridade</div>
-                                                        <div className="text-white font-black truncate">{base?.title || 'Treino'}</div>
-                                                        <div className="text-xs text-neutral-400">{Math.round(score * 100)}%</div>
-                                                    </div>
-                                                    <div className="flex items-center gap-2">
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleMergeDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 disabled:opacity-50"
-                                                        >
-                                                            Mesclar
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            disabled={duplicatesBusy}
-                                                            onClick={() => handleArchiveDuplicateGroup(g)}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 disabled:opacity-50"
-                                                        >
-                                                            Arquivar
-                                                        </button>
-                                                    </div>
-                                                </div>
-                                                <div className="mt-3 space-y-2">
-                                                    {items.map((w, wi) => (
-                                                        <div key={`dup-item-${idx}-${wi}`} className="flex items-center justify-between gap-3 rounded-lg bg-neutral-900/40 border border-neutral-800 px-3 py-2">
-                                                            <div className="min-w-0">
-                                                                <div className="text-sm font-bold text-white truncate">{String(w?.title || 'Treino')}</div>
-                                                                <div className="text-[11px] text-neutral-500 font-mono">{Array.isArray(w?.exercises) ? w.exercises.length : 0} EXERCÍCIOS</div>
-                                                            </div>
-                                                            <div className="text-[11px] font-bold text-neutral-500">{wi === 0 ? 'BASE' : 'DUP'}</div>
-                                                        </div>
-                                                    ))}
-                                                </div>
-                                            </div>
-                                        )
-                                    })}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {showExportModal && exportWorkout && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowExportModal(false)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Como deseja exportar?</h3>
-                                    <BackButton onClick={() => setShowExportModal(false)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-3">
-                                    <button onClick={handleExportPdf} className="w-full px-4 py-3 bg-yellow-500 text-black font-bold rounded-xl">Baixar PDF</button>
-                                    <button onClick={handleExportJson} className="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl">Baixar JSON</button>
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {openStudent && (
-                        <div className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setOpenStudent(null)}>
-                            <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                                <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                    <h3 className="font-bold text-white">Treinos de {openStudent.name}</h3>
-                                    <BackButton onClick={() => setOpenStudent(null)} className="bg-transparent hover:bg-neutral-800 text-neutral-300" />
-                                </div>
-                                <div className="p-4 space-y-2 max-h-[70vh] overflow-y-auto">
-                                    {(openStudent.workouts || []).length === 0 && (
-                                        <p className="text-neutral-500 text-sm">Nenhum treino encontrado.</p>
-                                    )}
-                                    {(openStudent.workouts || []).map(w => (
-                                        <div key={w.id} className="p-3 rounded-xl border border-neutral-700 bg-neutral-800">
-                                            <div className="flex items-center justify-between">
-                                                <span className="text-white font-bold text-sm">{w.title}</span>
-                                                <span className="text-xs text-neutral-400">{w.exercises?.length || 0} exercícios</span>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-                    )}
-
-                    {view === 'chat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'globalChat' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatScreen user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-
-                    {view === 'chatList' && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatListScreen user={user} onClose={() => setView('dashboard')} onSelectChannel={(c) => { setDirectChat(c); setView('directChat'); }} />
-                        </div>
-                    )}
-
-                    {view === 'directChat' && directChat && (
-                        <div className="absolute inset-0 z-50 bg-neutral-900">
-                            <ChatDirectScreen user={user} otherUserId={directChat.other_user_id} otherUserName={directChat.other_user_name} otherUserPhoto={directChat.other_user_photo} onClose={() => setView('chatList')} />
-                        </div>
-                    )}
-
-                    {view === 'admin' && (
-                        <div className="fixed inset-0 z-[60]">
-                            <AdminPanelV2 user={user} onClose={() => setView('dashboard')} />
-                        </div>
-                    )}
-                </div>
-
-                {/* Modals & Overlays */}
-                {showCompleteProfile && (
-                    <div className="fixed inset-0 z-[85] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <div className="flex items-center justify-between gap-3 mb-4">
-                                <h3 className="font-black text-white">Completar Perfil</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-
-                            <label className="block text-xs font-bold uppercase tracking-widest text-neutral-500 mb-2">
-                                Nome de Exibição
-                            </label>
-                            <input
-                                value={profileDraftName}
-                                onChange={(e) => setProfileDraftName(e.target.value)}
-                                placeholder="Ex: João Silva"
-                                className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-yellow-500"
-                            />
-
-                            <div className="flex gap-2 mt-5">
-                                <button
-                                    type="button"
-                                    onClick={() => setShowCompleteProfile(false)}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-300 disabled:opacity-50"
-                                >
-                                    Cancelar
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={handleSaveProfile}
-                                    disabled={savingProfile}
-                                    className="flex-1 p-3 bg-yellow-500 rounded-xl font-black text-black disabled:opacity-50"
-                                >
-                                    {savingProfile ? 'Salvando...' : 'Salvar'}
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                {showImportModal && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800">
-                            <h3 className="font-bold text-white mb-4">Importar Treino (Código)</h3>
-                            <input
-                                value={importCode}
-                                onChange={e => setImportCode(e.target.value)}
-                                placeholder="Cole o código do treino aqui"
-                                className="w-full bg-neutral-800 p-4 rounded-xl mb-4 text-white font-mono text-center uppercase"
-                            />
-                            <div className="flex gap-2">
-                                <button onClick={() => setShowImportModal(false)} className="flex-1 p-3 bg-neutral-800 rounded-xl font-bold text-neutral-400">Cancelar</button>
-                                <button onClick={handleImportWorkout} className="flex-1 p-3 bg-blue-600 rounded-xl font-bold text-white">Importar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-                
-                {showJsonImportModal && (
-                     <div className="fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <Upload size={48} className="mx-auto text-blue-500 mb-4" />
-                            <h3 className="font-bold text-white mb-2 text-xl">Restaurar Backup</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Selecione o arquivo .json que você salvou anteriormente.</p>
-                            
-                            <label className="block w-full cursor-pointer bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-colors">
-                                Selecionar Arquivo
-                                <input type="file" accept=".json" onChange={handleJsonUpload} className="hidden" />
-                            </label>
-                            
-                            <button onClick={() => setShowJsonImportModal(false)} className="mt-4 text-neutral-500 text-sm hover:text-white">Cancelar</button>
-                        </div>
-                    </div>
-                )}
-
-                {shareCode && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-4">
-                        <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 text-center">
-                            <div className="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-black"><Check size={32} /></div>
-                            <h3 className="font-bold text-white mb-2">Link Gerado!</h3>
-                            <p className="text-neutral-400 text-sm mb-6">Envie este código para seu aluno ou amigo.</p>
-                            <div className="bg-black p-4 rounded-xl font-mono text-yellow-500 text-xl mb-4 tracking-widest select-all">
-                                {shareCode}
-                            </div>
-                            <button onClick={() => setShareCode(null)} className="w-full p-3 bg-neutral-800 rounded-xl font-bold text-white">Fechar</button>
-                        </div>
-                    </div>
-                )}
-
-                {quickViewWorkout && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setQuickViewWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-lg rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">{String(quickViewWorkout?.title || '')}</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setQuickViewWorkout(null)}
-                                    className="flex items-center gap-2 text-yellow-500 hover:text-yellow-400 transition-colors py-2 px-3 rounded-xl hover:bg-neutral-800 active:opacity-70"
-                                    aria-label="Voltar"
-                                >
-                                    <ArrowLeft size={20} />
-                                    <span className="font-semibold text-sm">Voltar</span>
-                                </button>
-                            </div>
-                            <div className="p-4 max-h-[60vh] overflow-y-auto space-y-3 custom-scrollbar">
-                                {(Array.isArray(quickViewWorkout?.exercises) ? quickViewWorkout.exercises : []).map((ex, idx) => (
-                                    <div key={idx} className="p-3 rounded-xl bg-neutral-800/50 border border-neutral-700">
-                                        <div className="flex justify-between items-center">
-                                            <h4 className="font-bold text-white text-sm">{String(ex?.name || '—')}</h4>
-                                            <span className="text-xs text-neutral-400">{(parseInt(ex?.sets) || 0)} x {String(ex?.reps || '-')}</span>
-                                        </div>
-                                        <div className="text-xs text-neutral-400 mt-1 flex items-center gap-2">
-                                            <Clock size={14} className="text-yellow-500" /><span>Descanso: {ex?.restTime ? `${parseInt(ex.restTime)}s` : '-'}</span>
-                                        </div>
-                                        {ex?.notes && <p className="text-sm text-neutral-300 mt-2">{String(ex.notes || '')}</p>}
-                                    </div>
-                                ))}
-                                {(!Array.isArray(quickViewWorkout?.exercises) || quickViewWorkout.exercises.length === 0) && (
-                                    <p className="text-neutral-400 text-sm">Este treino não tem exercícios.</p>
-                                )}
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex gap-2">
-                                <button onClick={() => { const w = quickViewWorkout; setQuickViewWorkout(null); handleStartSession(w); }} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl">Iniciar Treino</button>
-                                <button onClick={() => setQuickViewWorkout(null)} className="flex-1 p-3 bg-neutral-800 text-white font-bold rounded-xl">Fechar</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {showNotifCenter && (
-                    <div className="fixed inset-0 z-[75] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowNotifCenter(false)}>
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 flex justify-between items-center border-b border-neutral-800">
-                                <h3 className="font-bold text-white">Notificações</h3>
-                                <button
-                                    type="button"
-                                    onClick={() => setShowNotifCenter(false)}
-                                    className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 flex items-center justify-center text-neutral-400 hover:text-white transition-colors"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 relative">
-                                <NotificationCenter user={user} onStartSession={handleStartSession} embedded />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {activeSession?.timerTargetTime && (
-                    <RestTimerOverlay
-                        targetTime={activeSession.timerTargetTime}
-                        context={activeSession.timerContext}
-                        settings={userSettingsApi?.settings ?? null}
-                        onClose={handleCloseTimer}
-                        onFinish={handleCloseTimer}
-                    />
-                )}
-
-                {activeSession && view !== 'active' && (
-                    <div className="fixed bottom-0 left-0 right-0 z-[1100]">
-                        <div className="bg-neutral-900/95 backdrop-blur border-t border-neutral-800 px-4 py-3 pb-[max(env(safe-area-inset-bottom),12px)]">
-                            <div className="flex items-center gap-4">
-                                <div className="flex-1 min-w-0">
-                                    <h3 className="font-bold text-white truncate">{activeSession.workout?.title || 'Treino em andamento'}</h3>
-                                    <div className="flex items-center gap-3 text-xs text-neutral-300 mt-1">
-                                        <span className="font-mono text-yellow-500">{(() => { const end = sessionTicker || activeSession.startedAt; const s = Math.max(0, Math.floor((end - activeSession.startedAt) / 1000)); const m = Math.floor(s/60), sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; })()}</span>
-                                        <span className="text-neutral-500">tempo atual</span>
-                                        <span className="opacity-30">•</span>
-                                        <span className="font-mono text-neutral-200">{(() => { const total = (activeSession.workout?.exercises || []).reduce((acc, ex) => acc + calculateExerciseDuration(ex), 0); return `${toMinutesRounded(total)} min`; })()}</span>
-                                        <span className="text-neutral-500">estimado total</span>
-                                    </div>
-                                    <div className="h-1 bg-neutral-700 rounded-full overflow-hidden mt-2">
-                                        {(() => {
-                                            const exCount = (activeSession.workout?.exercises || []).length;
-                                            let percent = 0;
-                                            if (exCount) {
-                                                const done = new Set();
-                                                if (activeSession.logs) {
-                                                    Object.keys(activeSession.logs).forEach(k => {
-                                                        const i = parseInt(k.split('-')[0]) || 0;
-                                                        done.add(i);
-                                                    });
-                                                }
-                                                const current = Math.min(done.size, exCount);
-                                                percent = Math.round((current / exCount) * 100);
-                                            }
-                                            return <div className="h-full bg-yellow-500" style={{ width: `${percent}%` }}></div>
-                                        })()}
-                                    </div>
-                                </div>
-                                <button className="shrink-0 px-4 py-2 bg-yellow-500 text-black font-black rounded-xl hover:bg-yellow-400" onClick={() => setView('active')}>Voltar pro treino</button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {/* Admin Panel Modal controlled by State */}
-                {showAdminPanel && (
-                    <AdminPanelV2 user={user} onClose={closeAdminPanel} />
-                )}
-
-                {whatsNewOpen && (
-                    <WhatsNewModal
-                        isOpen={whatsNewOpen}
-                        entry={getLatestWhatsNew()}
-                        onClose={closeWhatsNew}
-                    />
-                )}
-
-                {preCheckinOpen && (
-                    <div
-                        className="fixed inset-0 z-[1300] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-                        onClick={() => {
-                            setPreCheckinOpen(false)
-                            const r = preCheckinResolveRef.current
-                            preCheckinResolveRef.current = null
-                            if (typeof r === 'function') r(null)
-                        }}
-                    >
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Check-in</div>
-                                    <div className="text-white font-black text-lg truncate">Pré-treino</div>
-                                    <div className="text-xs text-neutral-400 truncate">{String(preCheckinWorkout?.title || preCheckinWorkout?.name || 'Treino')}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-4">
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Energia (1–5)</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[1, 2, 3, 4, 5].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, energy: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.energy || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Dor / Soreness (0–10)</div>
-                                    <select
-                                        value={String(preCheckinDraft?.soreness ?? '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, soreness: String(e.target.value || '') }))}
-                                        className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                                    >
-                                        <option value="">Não informar</option>
-                                        {Array.from({ length: 11 }).map((_, i) => (
-                                            <option key={i} value={String(i)}>
-                                                {i}
-                                            </option>
-                                        ))}
-                                    </select>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Tempo disponível</div>
-                                    <div className="grid grid-cols-5 gap-2">
-                                        {[30, 45, 60, 90, 120].map((n) => (
-                                            <button
-                                                key={n}
-                                                type="button"
-                                                onClick={() => setPreCheckinDraft((prev) => ({ ...prev, timeMinutes: String(n) }))}
-                                                className={
-                                                    String(preCheckinDraft?.timeMinutes || '') === String(n)
-                                                        ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                                                        : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                                                }
-                                            >
-                                                {n}m
-                                            </button>
-                                        ))}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Observações (opcional)</div>
-                                    <textarea
-                                        value={String(preCheckinDraft?.notes || '')}
-                                        onChange={(e) => setPreCheckinDraft((prev) => ({ ...prev, notes: String(e.target.value || '') }))}
-                                        className="w-full min-h-[90px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none"
-                                        placeholder="Ex.: pouco sono, dor no joelho, viagem…"
-                                    />
-                                </div>
-                            </div>
-                            <div className="p-4 border-t border-neutral-800 flex items-center gap-2">
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(null)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-                                >
-                                    Pular
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        setPreCheckinOpen(false)
-                                        const r = preCheckinResolveRef.current
-                                        preCheckinResolveRef.current = null
-                                        if (typeof r === 'function') r(preCheckinDraft)
-                                    }}
-                                    className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-                                >
-                                    Continuar
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {settingsOpen && (
-                    <SettingsModal
-                        isOpen={settingsOpen}
-                        onClose={() => setSettingsOpen(false)}
-                        settings={userSettingsApi?.settings ?? null}
-                        userRole={user?.role || ''}
-                        saving={Boolean(userSettingsApi?.saving)}
-                        onOpenWhatsNew={() => {
-                            setSettingsOpen(false)
-                            setWhatsNewOpen(true)
-                        }}
-                        onSave={async (next) => {
-                            try {
-                                const safeNext = next && typeof next === 'object' ? next : (userSettingsApi?.settings ?? {})
-                                const res = await userSettingsApi?.save?.(safeNext)
-                                if (!res?.ok) {
-                                    await alert('Falha ao salvar: ' + (res?.error || ''))
-                                    return false
-                                }
-                                return true
-                            } catch (e) {
-                                await alert('Falha ao salvar: ' + (e?.message ?? String(e)))
-                                return false
-                            }
-                        }}
-                    />
-                )}
-
-                <OfflineSyncModal
-                    open={offlineSyncOpen}
-                    onClose={() => setOfflineSyncOpen(false)}
-                    userId={user?.id}
-                />
-
-                <WelcomeFloatingWindow user={user} />
-            </div>
-        </TeamWorkoutProvider>
-        </InAppNotificationsProvider>
-    );
-}
-
-export default function IronTracksAppClient({ initialUser, initialProfile, initialWorkouts }) {
-    const [isMounted, setIsMounted] = useState(false);
-    useEffect(() => {
-        const t = setTimeout(() => {
-            setIsMounted(true);
-        }, 0);
-        return () => clearTimeout(t);
-    }, []);
-    if (!isMounted) return <LoadingScreen />;
-    return (
-        <DialogProvider>
-            <ErrorReporterProvider>
-                <ErrorBoundary>
-                    <IronTracksApp initialUser={initialUser} initialProfile={initialProfile} initialWorkouts={initialWorkouts} />
-                </ErrorBoundary>
-                <GlobalDialog />
-            </ErrorReporterProvider>
-        </DialogProvider>
-    );
-}
diff --git a/_archive/duplicates/src/app/(app)/dashboard/error 2.tsx b/_archive/duplicates/src/app/(app)/dashboard/error 2.tsx
deleted file mode 100644
index 9ce6455..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/error 2.tsx	
+++ /dev/null
@@ -1,63 +0,0 @@
-'use client'
-
-import { useEffect } from 'react'
-import { AlertCircle, RefreshCw, LogIn } from 'lucide-react'
-
-export default function DashboardError({ error, reset }: { error: Error & { digest?: string }; reset: () => void }) {
-  useEffect(() => {
-    try {
-      const key = 'irontracks.dashboard.error.autoreload.v1'
-      const seen = window.sessionStorage.getItem(key) || ''
-      if (seen === '1') return
-      window.sessionStorage.setItem(key, '1')
-      window.location.reload()
-    } catch {}
-  }, [])
-
-  return (
-    <div className="min-h-screen bg-neutral-900 flex flex-col items-center justify-center p-6 text-center">
-      <div className="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mb-6 animate-pulse">
-        <AlertCircle size={40} className="text-red-500" />
-      </div>
-
-      <h1 className="text-2xl font-black text-white mb-2 uppercase tracking-tight">Ops! Algo deu errado.</h1>
-      <p className="text-neutral-400 mb-8 max-w-sm">Se isso persistir, recarregue o app ou volte para o login.</p>
-
-      <div className="bg-black/50 p-4 rounded-xl mb-6 w-full max-w-md overflow-x-auto text-left border border-red-900/30">
-        <p className="text-red-400 font-mono text-xs break-all">{String(error?.message || error?.toString?.() || 'Erro desconhecido')}</p>
-      </div>
-
-      <div className="w-full max-w-md grid grid-cols-1 gap-3">
-        <button
-          type="button"
-          onClick={() => {
-            try {
-              reset()
-            } catch {}
-            try {
-              window.location.reload()
-            } catch {}
-          }}
-          className="flex items-center justify-center gap-2 bg-yellow-500 text-black px-6 py-3 rounded-xl font-black hover:bg-yellow-400 transition-all active:scale-95"
-        >
-          <RefreshCw size={20} />
-          Recarregar Aplicativo
-        </button>
-
-        <button
-          type="button"
-          onClick={() => {
-            try {
-              window.location.href = '/?next=/dashboard'
-            } catch {}
-          }}
-          className="flex items-center justify-center gap-2 bg-neutral-900 border border-neutral-800 text-white px-6 py-3 rounded-xl font-black hover:bg-neutral-800 transition-all active:scale-95"
-        >
-          <LogIn size={20} />
-          Ir para o Login
-        </button>
-      </div>
-    </div>
-  )
-}
-
diff --git a/_archive/duplicates/src/app/(app)/dashboard/page 2.tsx b/_archive/duplicates/src/app/(app)/dashboard/page 2.tsx
deleted file mode 100644
index 63a117f..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/page 2.tsx	
+++ /dev/null
@@ -1,145 +0,0 @@
-import { createClient } from '@/utils/supabase/server'
-import { redirect } from 'next/navigation'
-import IronTracksAppClient from './IronTracksAppClient'
-import { resolveRoleByUser } from '@/utils/auth/route'
-
-type SP = Record<string, string | string[] | undefined>
-
-const hydrateWorkouts = async (supabase: any, rows: any[]) => {
-  const base = Array.isArray(rows) ? rows.filter((x) => x && typeof x === 'object') : []
-  const workoutIds = base.map((w) => w?.id).filter(Boolean)
-  if (!workoutIds.length) return base.map((w) => ({ ...w, exercises: [] }))
-
-  let exercises: any[] = []
-  try {
-    const { data } = await supabase
-      .from('exercises')
-      .select('*')
-      .in('workout_id', workoutIds)
-      .order('order', { ascending: true })
-      .limit(5000)
-    exercises = Array.isArray(data) ? data : []
-  } catch {
-    exercises = []
-  }
-
-  const exerciseIds = exercises.map((e) => e?.id).filter(Boolean)
-  let sets: any[] = []
-  if (exerciseIds.length) {
-    try {
-      const { data } = await supabase
-        .from('sets')
-        .select('*')
-        .in('exercise_id', exerciseIds)
-        .order('set_number', { ascending: true })
-        .limit(20000)
-      sets = Array.isArray(data) ? data : []
-    } catch {
-      sets = []
-    }
-  }
-
-  const setsByExercise = new Map<string, any[]>()
-  for (const s of sets) {
-    const eid = s?.exercise_id
-    if (!eid) continue
-    const list = setsByExercise.get(eid) || []
-    list.push(s)
-    setsByExercise.set(eid, list)
-  }
-
-  const exByWorkout = new Map<string, any[]>()
-  for (const ex of exercises) {
-    const wid = ex?.workout_id
-    if (!wid) continue
-    const exWithSets = { ...ex, sets: setsByExercise.get(ex.id) || [] }
-    const list = exByWorkout.get(wid) || []
-    list.push(exWithSets)
-    exByWorkout.set(wid, list)
-  }
-
-  return base.map((w) => ({ ...w, exercises: exByWorkout.get(w.id) || [] }))
-}
-
-export default async function DashboardPage({ searchParams }: { searchParams?: Promise<SP> }) {
-  const sp = await searchParams
-  const code = typeof sp?.code === 'string' ? sp?.code : ''
-  const next = typeof sp?.next === 'string' ? sp?.next : ''
-  if (code) {
-    const safeNext = next && next.startsWith('/') ? next : '/dashboard'
-    redirect(`/auth/callback?code=${encodeURIComponent(code)}&next=${encodeURIComponent(safeNext)}`)
-  }
-
-  const supabase = await createClient()
-  const {
-    data: { user },
-    error,
-  } = await supabase.auth.getUser()
-  if (error || !user?.id) redirect('/?next=/dashboard')
-
-  const { data: profile } = await supabase
-    .from('profiles')
-    .select('role, display_name, photo_url')
-    .eq('id', user.id)
-    .maybeSingle()
-
-  const resolved = await resolveRoleByUser({ id: user.id, email: user.email ?? null })
-
-  const initialUser = {
-    id: user.id,
-    email: user.email ?? null,
-    user_metadata: user.user_metadata ?? {},
-  }
-
-  const initialProfile = {
-    role: resolved?.role ?? profile?.role ?? null,
-    display_name: profile?.display_name ?? null,
-    photo_url: profile?.photo_url ?? null,
-  }
-
-  let baseWorkouts: any[] = []
-  try {
-    const { data } = await supabase
-      .from('workouts')
-      .select('*')
-      .eq('is_template', true)
-      .eq('user_id', user.id)
-      .order('name', { ascending: true })
-      .limit(500)
-    baseWorkouts = Array.isArray(data) ? data : []
-  } catch {
-    baseWorkouts = []
-  }
-
-  if (!baseWorkouts.length) {
-    try {
-      const { data } = await supabase.from('workouts').select('*').eq('user_id', user.id).order('name', { ascending: true }).limit(500)
-      baseWorkouts = Array.isArray(data) ? data : []
-    } catch {
-      baseWorkouts = []
-    }
-  }
-
-  if (!baseWorkouts.length) {
-    try {
-      const { data: student } = await supabase.from('students').select('id').eq('user_id', user.id).maybeSingle()
-      const studentId = student?.id ? String(student.id) : ''
-      if (studentId) {
-        const { data } = await supabase
-          .from('workouts')
-          .select('*')
-          .eq('is_template', true)
-          .or(`user_id.eq.${studentId},student_id.eq.${studentId}`)
-          .order('name', { ascending: true })
-          .limit(500)
-        baseWorkouts = Array.isArray(data) ? data : []
-      }
-    } catch {
-      baseWorkouts = []
-    }
-  }
-
-  const initialWorkouts = await hydrateWorkouts(supabase, baseWorkouts)
-
-  return <IronTracksAppClient initialUser={initialUser} initialProfile={initialProfile} initialWorkouts={initialWorkouts} />
-}
diff --git a/_archive/duplicates/src/app/(app)/dashboard/page 3.tsx b/_archive/duplicates/src/app/(app)/dashboard/page 3.tsx
deleted file mode 100644
index 63a117f..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/page 3.tsx	
+++ /dev/null
@@ -1,145 +0,0 @@
-import { createClient } from '@/utils/supabase/server'
-import { redirect } from 'next/navigation'
-import IronTracksAppClient from './IronTracksAppClient'
-import { resolveRoleByUser } from '@/utils/auth/route'
-
-type SP = Record<string, string | string[] | undefined>
-
-const hydrateWorkouts = async (supabase: any, rows: any[]) => {
-  const base = Array.isArray(rows) ? rows.filter((x) => x && typeof x === 'object') : []
-  const workoutIds = base.map((w) => w?.id).filter(Boolean)
-  if (!workoutIds.length) return base.map((w) => ({ ...w, exercises: [] }))
-
-  let exercises: any[] = []
-  try {
-    const { data } = await supabase
-      .from('exercises')
-      .select('*')
-      .in('workout_id', workoutIds)
-      .order('order', { ascending: true })
-      .limit(5000)
-    exercises = Array.isArray(data) ? data : []
-  } catch {
-    exercises = []
-  }
-
-  const exerciseIds = exercises.map((e) => e?.id).filter(Boolean)
-  let sets: any[] = []
-  if (exerciseIds.length) {
-    try {
-      const { data } = await supabase
-        .from('sets')
-        .select('*')
-        .in('exercise_id', exerciseIds)
-        .order('set_number', { ascending: true })
-        .limit(20000)
-      sets = Array.isArray(data) ? data : []
-    } catch {
-      sets = []
-    }
-  }
-
-  const setsByExercise = new Map<string, any[]>()
-  for (const s of sets) {
-    const eid = s?.exercise_id
-    if (!eid) continue
-    const list = setsByExercise.get(eid) || []
-    list.push(s)
-    setsByExercise.set(eid, list)
-  }
-
-  const exByWorkout = new Map<string, any[]>()
-  for (const ex of exercises) {
-    const wid = ex?.workout_id
-    if (!wid) continue
-    const exWithSets = { ...ex, sets: setsByExercise.get(ex.id) || [] }
-    const list = exByWorkout.get(wid) || []
-    list.push(exWithSets)
-    exByWorkout.set(wid, list)
-  }
-
-  return base.map((w) => ({ ...w, exercises: exByWorkout.get(w.id) || [] }))
-}
-
-export default async function DashboardPage({ searchParams }: { searchParams?: Promise<SP> }) {
-  const sp = await searchParams
-  const code = typeof sp?.code === 'string' ? sp?.code : ''
-  const next = typeof sp?.next === 'string' ? sp?.next : ''
-  if (code) {
-    const safeNext = next && next.startsWith('/') ? next : '/dashboard'
-    redirect(`/auth/callback?code=${encodeURIComponent(code)}&next=${encodeURIComponent(safeNext)}`)
-  }
-
-  const supabase = await createClient()
-  const {
-    data: { user },
-    error,
-  } = await supabase.auth.getUser()
-  if (error || !user?.id) redirect('/?next=/dashboard')
-
-  const { data: profile } = await supabase
-    .from('profiles')
-    .select('role, display_name, photo_url')
-    .eq('id', user.id)
-    .maybeSingle()
-
-  const resolved = await resolveRoleByUser({ id: user.id, email: user.email ?? null })
-
-  const initialUser = {
-    id: user.id,
-    email: user.email ?? null,
-    user_metadata: user.user_metadata ?? {},
-  }
-
-  const initialProfile = {
-    role: resolved?.role ?? profile?.role ?? null,
-    display_name: profile?.display_name ?? null,
-    photo_url: profile?.photo_url ?? null,
-  }
-
-  let baseWorkouts: any[] = []
-  try {
-    const { data } = await supabase
-      .from('workouts')
-      .select('*')
-      .eq('is_template', true)
-      .eq('user_id', user.id)
-      .order('name', { ascending: true })
-      .limit(500)
-    baseWorkouts = Array.isArray(data) ? data : []
-  } catch {
-    baseWorkouts = []
-  }
-
-  if (!baseWorkouts.length) {
-    try {
-      const { data } = await supabase.from('workouts').select('*').eq('user_id', user.id).order('name', { ascending: true }).limit(500)
-      baseWorkouts = Array.isArray(data) ? data : []
-    } catch {
-      baseWorkouts = []
-    }
-  }
-
-  if (!baseWorkouts.length) {
-    try {
-      const { data: student } = await supabase.from('students').select('id').eq('user_id', user.id).maybeSingle()
-      const studentId = student?.id ? String(student.id) : ''
-      if (studentId) {
-        const { data } = await supabase
-          .from('workouts')
-          .select('*')
-          .eq('is_template', true)
-          .or(`user_id.eq.${studentId},student_id.eq.${studentId}`)
-          .order('name', { ascending: true })
-          .limit(500)
-        baseWorkouts = Array.isArray(data) ? data : []
-      }
-    } catch {
-      baseWorkouts = []
-    }
-  }
-
-  const initialWorkouts = await hydrateWorkouts(supabase, baseWorkouts)
-
-  return <IronTracksAppClient initialUser={initialUser} initialProfile={initialProfile} initialWorkouts={initialWorkouts} />
-}
diff --git a/_archive/duplicates/src/app/(app)/dashboard/schedule/ScheduleClient 2.tsx b/_archive/duplicates/src/app/(app)/dashboard/schedule/ScheduleClient 2.tsx
deleted file mode 100644
index fe66311..0000000
--- a/_archive/duplicates/src/app/(app)/dashboard/schedule/ScheduleClient 2.tsx	
+++ /dev/null
@@ -1,573 +0,0 @@
-'use client'
-
-import React, { useCallback, useEffect, useMemo, useState } from 'react'
-import { useRouter } from 'next/navigation'
-import { Calendar, ArrowLeft, Clock, User, Plus, Pencil, Trash2 } from 'lucide-react'
-import { createClient } from '@/utils/supabase/client'
-
-type AppointmentRow = {
-  id: string
-  title: string
-  start_time: string
-  end_time: string
-  type: 'personal' | 'assessment' | 'other'
-  notes: string | null
-  student_id: string | null
-}
-
-type StudentRow = {
-  id: string
-  name: string | null
-  email: string | null
-}
-
-type FormState = {
-  date: string
-  startTime: string
-  endTime: string
-  studentId: string
-  type: 'personal' | 'assessment' | 'other'
-}
-
-const DEFAULT_APPOINTMENT_DURATION_MINUTES = 60
-
-function toDateInputValue(date: Date) {
-  const year = date.getFullYear()
-  const month = String(date.getMonth() + 1).padStart(2, '0')
-  const day = String(date.getDate()).padStart(2, '0')
-  return `${year}-${month}-${day}`
-}
-
-function toTimeInputValue(date: Date) {
-  const hours = String(date.getHours()).padStart(2, '0')
-  const minutes = String(date.getMinutes()).padStart(2, '0')
-  return `${hours}:${minutes}`
-}
-
-function addMinutes(date: Date, minutes: number) {
-  return new Date(date.getTime() + minutes * 60000)
-}
-
-function formatTimeRange(startIso: string, endIso: string) {
-  if (!startIso || !endIso) return ''
-  const start = new Date(startIso)
-  const end = new Date(endIso)
-  const startHours = String(start.getHours()).padStart(2, '0')
-  const startMinutes = String(start.getMinutes()).padStart(2, '0')
-  const endHours = String(end.getHours()).padStart(2, '0')
-  const endMinutes = String(end.getMinutes()).padStart(2, '0')
-  return `${startHours}:${startMinutes} - ${endHours}:${endMinutes}`
-}
-
-function getTypeLabel(type: 'personal' | 'assessment' | 'other') {
-  if (type === 'personal') return 'Personal'
-  if (type === 'assessment') return 'Avaliação'
-  return 'Outro'
-}
-
-export default function SchedulePage() {
-  const router = useRouter()
-  const supabase = useMemo(() => createClient(), [])
-
-  const today = new Date()
-  const initialDate = toDateInputValue(today)
-  const initialStartTime = toTimeInputValue(today)
-  const initialEndTime = toTimeInputValue(addMinutes(today, DEFAULT_APPOINTMENT_DURATION_MINUTES))
-
-  const [userId, setUserId] = useState<string | null>(null)
-  const [loading, setLoading] = useState(true)
-  const [saving, setSaving] = useState(false)
-  const [error, setError] = useState('')
-  const [appointments, setAppointments] = useState<AppointmentRow[]>([])
-  const [students, setStudents] = useState<StudentRow[]>([])
-  const [isModalOpen, setIsModalOpen] = useState(false)
-  const [selectedDate, setSelectedDate] = useState(initialDate)
-  const [editingAppointment, setEditingAppointment] = useState<AppointmentRow | null>(null)
-
-  const [form, setForm] = useState<FormState>({
-    date: initialDate,
-    startTime: initialStartTime,
-    endTime: initialEndTime,
-    studentId: '',
-    type: 'personal',
-  })
-
-  const loadAppointmentsForDate = useCallback(
-    async (dateString: string) => {
-      const safeDate = dateString || toDateInputValue(new Date())
-      const startOfDay = new Date(`${safeDate}T00:00:00`)
-      const endOfDay = new Date(`${safeDate}T23:59:59.999`)
-
-      const { data, error: queryError } = await supabase
-        .from('appointments')
-        .select('id, title, start_time, end_time, type, notes, student_id')
-        .gte('start_time', startOfDay.toISOString())
-        .lte('start_time', endOfDay.toISOString())
-        .order('start_time', { ascending: true })
-
-      if (queryError) throw queryError
-      setAppointments(Array.isArray(data) ? data : [])
-    },
-    [supabase]
-  )
-
-  const loadStudentsForCoach = useCallback(async () => {
-    const { data, error } = await supabase
-      .from('students')
-      .select('id, name, email')
-      .order('name', { ascending: true })
-
-    if (error) throw error
-    setStudents(Array.isArray(data) ? data : [])
-  }, [supabase])
-
-  useEffect(() => {
-    let isMounted = true
-
-    const load = async () => {
-      try {
-        setLoading(true)
-        setError('')
-        const { data } = await supabase.auth.getUser()
-        const currentUser = data?.user
-        if (!currentUser) {
-          if (!isMounted) return
-          setError('Você precisa estar autenticado para ver a agenda.')
-          setLoading(false)
-          return
-        }
-        if (!isMounted) return
-        setUserId(currentUser.id)
-        const baseDate = toDateInputValue(new Date())
-        setSelectedDate(baseDate)
-        setForm(prev => ({
-          ...prev,
-          date: baseDate,
-        }))
-        await loadStudentsForCoach()
-      } catch (e: any) {
-        if (!isMounted) return
-        setError(e?.message || 'Erro ao carregar agenda.')
-      } finally {
-        if (!isMounted) return
-        setLoading(false)
-      }
-    }
-
-    load()
-
-    return () => {
-      isMounted = false
-    }
-  }, [supabase, loadStudentsForCoach])
-
-  useEffect(() => {
-    if (!userId || !selectedDate) return
-    let isCancelled = false
-
-    const loadDay = async () => {
-      try {
-        setLoading(true)
-        await loadAppointmentsForDate(selectedDate)
-      } catch (e: any) {
-        if (isCancelled) return
-        setError(e?.message || 'Erro ao carregar agenda.')
-      } finally {
-        if (isCancelled) return
-        setLoading(false)
-      }
-    }
-
-    loadDay()
-
-    return () => {
-      isCancelled = true
-    }
-  }, [userId, selectedDate, loadAppointmentsForDate])
-
-  const handleOpenModal = () => {
-    const base = new Date()
-    const baseDate = selectedDate || toDateInputValue(base)
-    const start = toTimeInputValue(base)
-    const end = toTimeInputValue(addMinutes(base, DEFAULT_APPOINTMENT_DURATION_MINUTES))
-    setForm(prev => ({
-      ...prev,
-      date: baseDate,
-      startTime: start,
-      endTime: end,
-    }))
-    setEditingAppointment(null)
-    setIsModalOpen(true)
-  }
-
-  const handleCloseModal = () => {
-    if (saving) return
-    setIsModalOpen(false)
-  }
-
-  const notifyStudentAppointment = async (studentId: string | null, baseTitle: string, start: Date) => {
-    if (!studentId) return
-    try {
-      const dateLabel = start.toLocaleDateString('pt-BR')
-      const timeLabel = start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
-      const title = baseTitle
-      const message = `Você tem um agendamento ${baseTitle.toLowerCase()} em ${dateLabel} às ${timeLabel}.`
-      await fetch('/api/notifications/appointment-created', {
-        method: 'POST',
-        headers: { 'Content-Type': 'application/json' },
-        body: JSON.stringify({
-          studentId,
-          title,
-          message,
-          type: 'appointment',
-        }),
-      })
-    } catch (e) {
-      console.error('Erro ao enviar notificação de agendamento:', e)
-    }
-  }
-
-  const handleSubmitAppointment = async (event: any) => {
-    event?.preventDefault?.()
-    if (!userId) {
-      setError('Usuário não identificado.')
-      return
-    }
-
-    const trimmedDate = (form.date || '').trim()
-    const trimmedStart = (form.startTime || '').trim()
-    const trimmedEnd = (form.endTime || '').trim()
-    const type = form.type
-
-    if (!trimmedDate || !trimmedStart || !type) {
-      setError('Preencha data, horário e tipo do agendamento.')
-      return
-    }
-
-    setSaving(true)
-    setError('')
-
-    try {
-      const start = new Date(`${trimmedDate}T${trimmedStart}:00`)
-      let end = trimmedEnd ? new Date(`${trimmedDate}T${trimmedEnd}:00`) : addMinutes(start, DEFAULT_APPOINTMENT_DURATION_MINUTES)
-      if (end <= start) {
-        end = addMinutes(start, DEFAULT_APPOINTMENT_DURATION_MINUTES)
-      }
-
-      const chosenStudentId = form.studentId || null
-
-      const mappedStudent = students.find(s => s.id === chosenStudentId) || null
-      const baseTitle = getTypeLabel(type)
-      const studentName = mappedStudent?.name || mappedStudent?.email || ''
-      const computedTitle = studentName ? `${baseTitle} · ${studentName}` : baseTitle
-
-      if (editingAppointment) {
-        const { error: updateError } = await supabase
-          .from('appointments')
-          .update({
-            student_id: chosenStudentId,
-            title: computedTitle,
-            start_time: start.toISOString(),
-            end_time: end.toISOString(),
-            type,
-          })
-          .eq('id', editingAppointment.id)
-          .eq('coach_id', userId)
-        if (updateError) throw updateError
-      } else {
-        const { error: insertError } = await supabase
-          .from('appointments')
-          .insert({
-            coach_id: userId,
-            student_id: chosenStudentId,
-            title: computedTitle,
-            start_time: start.toISOString(),
-            end_time: end.toISOString(),
-            type,
-            notes: null,
-          })
-        if (insertError) throw insertError
-        await notifyStudentAppointment(chosenStudentId, baseTitle, start)
-      }
-
-      const targetDate = selectedDate || trimmedDate
-      await loadAppointmentsForDate(targetDate)
-
-      setIsModalOpen(false)
-      setEditingAppointment(null)
-    } catch (e: any) {
-      setError(e?.message || 'Erro ao salvar agendamento.')
-    } finally {
-      setSaving(false)
-    }
-  }
-
-  const handleEditAppointment = (item: AppointmentRow) => {
-    const start = new Date(item.start_time)
-    const end = new Date(item.end_time)
-    const dateStr = toDateInputValue(start)
-    const startStr = toTimeInputValue(start)
-    const endStr = toTimeInputValue(end)
-    const studentId = item.student_id || ''
-    const type = item.type
-    setForm({
-      date: dateStr,
-      startTime: startStr,
-      endTime: endStr,
-      studentId,
-      type,
-    })
-    setEditingAppointment(item)
-    setIsModalOpen(true)
-  }
-
-  const handleDeleteAppointment = async (item: AppointmentRow) => {
-    if (!userId) {
-      setError('Usuário não identificado.')
-      return
-    }
-    const confirmed = typeof window === 'undefined' ? false : window.confirm('Deseja realmente excluir este agendamento?')
-    if (!confirmed) return
-    try {
-      setSaving(true)
-      setError('')
-      const { error: deleteError } = await supabase
-        .from('appointments')
-        .delete()
-        .eq('id', item.id)
-        .eq('coach_id', userId)
-      if (deleteError) throw deleteError
-      const targetDate = selectedDate || toDateInputValue(new Date())
-      await loadAppointmentsForDate(targetDate)
-    } catch (e: any) {
-      setError(e?.message || 'Erro ao excluir agendamento.')
-    } finally {
-      setSaving(false)
-    }
-  }
-
-  const studentsById = new Map<string, StudentRow>()
-  const safeStudents = Array.isArray(students) ? students : []
-  for (const s of safeStudents) {
-    if (!s || !s.id) continue
-    studentsById.set(s.id, s)
-  }
-
-  const safeAppointments = Array.isArray(appointments) ? appointments : []
-
-  return (
-    <div className="min-h-screen bg-neutral-900 text-white flex flex-col">
-      <header className="bg-neutral-950 border-b border-neutral-800 px-4 pt-[env(safe-area-inset-top)] pb-3 flex items-center justify-between gap-3">
-        <button
-          type="button"
-          onClick={() => router.push('/dashboard')}
-          className="flex items-center gap-2 text-neutral-400 hover:text-white px-3 py-2 rounded-full bg-neutral-900 border border-neutral-700 active:scale-95 transition-transform"
-        >
-          <ArrowLeft size={18} />
-          <span className="text-xs font-bold uppercase tracking-wide">Voltar</span>
-        </button>
-        <div className="flex items-center gap-2">
-          <Calendar size={20} className="text-yellow-500" />
-          <div className="text-right">
-            <div className="text-[10px] uppercase text-neutral-500 font-bold">Coach</div>
-            <div className="text-sm font-black tracking-tight">Agenda do Dia</div>
-          </div>
-        </div>
-      </header>
-
-      <main className="flex-1 px-4 py-4 pb-[max(env(safe-area-inset-bottom),96px)] space-y-4">
-        <section className="flex items-center justify-between gap-3">
-          <div>
-            <div className="text-xs font-bold uppercase text-neutral-500 mb-1">Data</div>
-            <input
-              type="date"
-              value={selectedDate}
-              onChange={e => setSelectedDate(e.target.value)}
-              className="bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-3 text-sm text-white focus:outline-none focus:border-yellow-500 min-h-[48px] w-full"
-            />
-          </div>
-          <button
-            type="button"
-            onClick={handleOpenModal}
-            className="flex items-center gap-2 bg-yellow-500 text-black font-black px-4 py-3 rounded-xl shadow-lg shadow-yellow-900/30 text-sm uppercase tracking-wide active:scale-95 transition-transform min-h-[44px]"
-          >
-            <Plus size={18} />
-            Novo Agendamento
-          </button>
-        </section>
-
-        {error && (
-          <div className="bg-red-900/40 border border-red-500 text-red-100 text-sm px-3 py-2 rounded-xl">
-            {error}
-          </div>
-        )}
-
-        {loading ? (
-          <div className="flex items-center justify-center py-16 text-neutral-400 text-sm">
-            Carregando agenda...
-          </div>
-        ) : safeAppointments.length === 0 ? (
-          <div className="mt-4 bg-neutral-800 border border-neutral-700 rounded-2xl px-4 py-6 flex flex-col items-center text-center">
-            <Calendar size={32} className="text-neutral-500 mb-3" />
-            <h2 className="text-base font-bold mb-1">Nenhum agendamento para este dia</h2>
-            <p className="text-xs text-neutral-400 mb-4">Aproveite o descanso! ☕</p>
-          </div>
-        ) : (
-          <section className="space-y-3">
-            {safeAppointments.map(item => {
-              const student = item.student_id ? studentsById.get(item.student_id) || null : null
-              const label = getTypeLabel(item.type)
-              const range = formatTimeRange(item.start_time, item.end_time)
-              const studentName = student?.name || student?.email || ''
-              return (
-                <div
-                  key={item.id}
-                  className="bg-neutral-800 border border-neutral-700 rounded-2xl px-4 py-3 flex items-center justify-between gap-3"
-                >
-                  <div className="flex items-center gap-3">
-                    <div className="w-10 h-10 rounded-full bg-neutral-900 flex items-center justify-center">
-                      <Clock size={18} className="text-yellow-500" />
-                    </div>
-                    <div>
-                      <div className="flex items-center gap-2 mb-1">
-                        <span className="text-xs font-bold uppercase px-2 py-0.5 rounded-full bg-yellow-500/10 text-yellow-400 border border-yellow-500/40">
-                          {label}
-                        </span>
-                        {studentName ? (
-                          <span className="flex items-center gap-1 text-[11px] text-neutral-300">
-                            <User size={12} className="text-neutral-400" />
-                            {studentName}
-                          </span>
-                        ) : null}
-                      </div>
-                      <div className="text-sm font-semibold text-white mb-0.5">
-                        {item.title}
-                      </div>
-                      <div className="text-xs text-neutral-400 flex items-center gap-1">
-                        <Clock size={12} />
-                        {range}
-                      </div>
-                    </div>
-                  </div>
-                  <div className="flex items-center gap-2">
-                    <button
-                      type="button"
-                      onClick={() => handleEditAppointment(item)}
-                      className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 flex items-center justify-center text-neutral-300 active:scale-95 transition-transform"
-                    >
-                      <Pencil size={16} />
-                    </button>
-                    <button
-                      type="button"
-                      onClick={() => handleDeleteAppointment(item)}
-                      className="w-9 h-9 rounded-full bg-red-900/40 border border-red-700/60 flex items-center justify-center text-red-400 active:scale-95 transition-transform"
-                    >
-                      <Trash2 size={16} />
-                    </button>
-                  </div>
-                </div>
-              )
-            })}
-          </section>
-        )}
-      </main>
-
-      {isModalOpen && (
-        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center px-4">
-          <div className="bg-neutral-900 border border-neutral-800 rounded-2xl w-full max-w-md p-5">
-            <div className="flex items-center justify-between mb-4">
-              <h2 className="text-lg font-black flex items-center gap-2">
-                <Calendar size={20} className="text-yellow-500" />
-                Novo Agendamento
-              </h2>
-              <button
-                type="button"
-                onClick={handleCloseModal}
-                className="text-neutral-400 hover:text-white px-2 py-1 rounded-full active:scale-95 transition-transform"
-              >
-                <ArrowLeft size={18} />
-              </button>
-            </div>
-
-            <form onSubmit={handleSubmitAppointment} className="space-y-4">
-              <div className="grid grid-cols-2 gap-3">
-                <div className="space-y-1">
-                  <label className="text-[11px] font-bold uppercase text-neutral-500">Data</label>
-                  <input
-                    type="date"
-                    value={form.date}
-                    onChange={e => setForm(prev => ({ ...prev, date: e.target.value }))}
-                    className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-yellow-500 min-h-[44px]"
-                  />
-                </div>
-                <div className="space-y-1">
-                  <label className="text-[11px] font-bold uppercase text-neutral-500">Hora início</label>
-                  <input
-                    type="time"
-                    value={form.startTime}
-                    onChange={e => setForm(prev => ({ ...prev, startTime: e.target.value }))}
-                    className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-yellow-500 min-h-[44px]"
-                  />
-                </div>
-              </div>
-              <div className="space-y-1">
-                <label className="text-[11px] font-bold uppercase text-neutral-500">Hora fim (opcional)</label>
-                <input
-                  type="time"
-                  value={form.endTime}
-                  onChange={e => setForm(prev => ({ ...prev, endTime: e.target.value }))}
-                  className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-yellow-500 min-h-[44px]"
-                />
-              </div>
-              <div className="space-y-1">
-                <label className="text-[11px] font-bold uppercase text-neutral-500">Aluno</label>
-                <select
-                  value={form.studentId}
-                  onChange={e => setForm(prev => ({ ...prev, studentId: e.target.value }))}
-                  className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-yellow-500 min-h-[44px]"
-                >
-                  <option value="">Sem aluno vinculado</option>
-                  {safeStudents.map(s => (
-                    <option key={s.id} value={s.id}>
-                      {s.name || s.email || 'Aluno sem nome'}
-                    </option>
-                  ))}
-                </select>
-              </div>
-              <div className="space-y-1">
-                <label className="text-[11px] font-bold uppercase text-neutral-500">Tipo</label>
-                <select
-                  value={form.type}
-                  onChange={e => setForm(prev => ({ ...prev, type: e.target.value as FormState['type'] }))}
-                  className="w-full bg-neutral-800 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-yellow-500 min-h-[44px]"
-                >
-                  <option value="personal">Personal</option>
-                  <option value="assessment">Avaliação</option>
-                  <option value="other">Outro</option>
-                </select>
-              </div>
-
-              <div className="flex gap-2 mt-2">
-                <button
-                  type="button"
-                  onClick={handleCloseModal}
-                  disabled={saving}
-                  className="flex-1 min-h-[44px] px-4 py-3 rounded-xl border border-neutral-700 text-neutral-300 text-sm font-bold uppercase bg-neutral-900 hover:bg-neutral-800 disabled:opacity-50 active:scale-95 transition-transform"
-                >
-                  Cancelar
-                </button>
-                <button
-                  type="submit"
-                  disabled={saving}
-                  className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black text-sm font-black uppercase tracking-wide hover:bg-yellow-400 disabled:opacity-50 active:scale-95 transition-transform"
-                >
-                  {saving ? 'Salvando...' : 'Salvar'}
-                </button>
-              </div>
-            </form>
-          </div>
-        </div>
-      )}
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/app/(public)/page 2.tsx b/_archive/duplicates/src/app/(public)/page 2.tsx
deleted file mode 100644
index cd5ad78..0000000
--- a/_archive/duplicates/src/app/(public)/page 2.tsx	
+++ /dev/null
@@ -1,32 +0,0 @@
-import LoginScreen from '@/components/LoginScreen'
-import { createClient } from '@/utils/supabase/server'
-import { redirect } from 'next/navigation'
-
-type SP = Record<string, string | string[] | undefined>
-
-export default async function PublicHomePage({ searchParams }: { searchParams?: SP }) {
-  const code = typeof searchParams?.code === 'string' ? searchParams?.code : ''
-  const next = typeof searchParams?.next === 'string' ? searchParams?.next : ''
-  const error = typeof searchParams?.error === 'string' ? searchParams?.error : ''
-  const errorDescription = typeof searchParams?.error_description === 'string' ? searchParams?.error_description : ''
-
-  if (code) {
-    const safeNext = next && next.startsWith('/') ? next : '/dashboard'
-    redirect(`/auth/callback?code=${encodeURIComponent(code)}&next=${encodeURIComponent(safeNext)}`)
-  }
-
-  if (error || errorDescription) {
-    const msg = errorDescription || error
-    redirect(`/auth/error?error=${encodeURIComponent(msg)}`)
-  }
-
-  try {
-    const supabase = await createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-    if (user?.id) redirect('/dashboard')
-  } catch {}
-
-  return <LoginScreen />
-}
diff --git a/_archive/duplicates/src/app/api/access-request/create/route 2.ts b/_archive/duplicates/src/app/api/access-request/create/route 2.ts
deleted file mode 100644
index 772bad3..0000000
--- a/_archive/duplicates/src/app/api/access-request/create/route 2.ts	
+++ /dev/null
@@ -1,75 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-export async function POST(req: Request) {
-  try {
-    const body = await req.json()
-    const { email, phone, full_name, birth_date } = body
-
-    // 1. Validation
-    if (!email || !phone || !full_name || !birth_date) {
-      return NextResponse.json({ ok: false, error: 'Todos os campos são obrigatórios.' }, { status: 400 })
-    }
-
-    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
-    if (!emailRegex.test(email)) {
-      return NextResponse.json({ ok: false, error: 'E-mail inválido.' }, { status: 400 })
-    }
-
-    // 2. Check duplicate in access_requests
-    const supabaseAdmin = createAdminClient()
-    
-    const { data: existingRequest } = await supabaseAdmin
-      .from('access_requests')
-      .select('id, status')
-      .eq('email', email)
-      .maybeSingle()
-
-    if (existingRequest) {
-      if (existingRequest.status === 'pending') {
-        return NextResponse.json({ ok: false, error: 'Já existe uma solicitação pendente para este e-mail.' }, { status: 400 })
-      }
-      if (existingRequest.status === 'accepted') {
-        return NextResponse.json({ ok: false, error: 'Este e-mail já possui acesso liberado. Faça login.' }, { status: 400 })
-      }
-      // If rejected, we allow a new request (maybe they fixed the info)
-    }
-
-    // 3. Check if user already exists in Auth (Optional, but good UX)
-    // Note: This requires admin privileges which we have via createAdminClient
-    // But checking auth.users is distinct. Usually we check 'profiles' table.
-    const { data: existingProfile } = await supabaseAdmin
-        .from('profiles')
-        .select('id')
-        .eq('email', email)
-        .maybeSingle()
-    
-    if (existingProfile) {
-        return NextResponse.json({ ok: false, error: 'Usuário já cadastrado. Faça login.' }, { status: 400 })
-    }
-
-    // 4. Create Request
-    const { error: insertError } = await supabaseAdmin
-      .from('access_requests')
-      .insert({
-        email,
-        phone,
-        full_name,
-        birth_date,
-        status: 'pending'
-      })
-
-    if (insertError) {
-        console.error('Error inserting access request:', insertError)
-        return NextResponse.json({ ok: false, error: 'Erro ao salvar solicitação.' }, { status: 500 })
-    }
-
-    return NextResponse.json({ ok: true, message: 'Solicitação enviada com sucesso!' })
-
-  } catch (error: any) {
-    console.error('Access Request Error:', error)
-    return NextResponse.json({ ok: false, error: 'Erro interno do servidor.' }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/admin/access-requests/action/route 2.ts b/_archive/duplicates/src/app/api/admin/access-requests/action/route 2.ts
deleted file mode 100644
index 42be89f..0000000
--- a/_archive/duplicates/src/app/api/admin/access-requests/action/route 2.ts	
+++ /dev/null
@@ -1,133 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createAdminClient } from '@/utils/supabase/admin'
-import { requireRole } from '@/utils/auth/route'
-
-export const dynamic = 'force-dynamic'
-
-export async function POST(req: Request) {
-  try {
-    const auth = await requireRole(['admin'])
-    if (!auth.ok) return auth.response
-
-    const body = await req.json()
-    const { requestId, action } = body
-
-    if (!requestId || !['accept', 'reject'].includes(action)) {
-      return NextResponse.json({ ok: false, error: 'Dados inválidos.' }, { status: 400 })
-    }
-
-    const admin = createAdminClient()
-
-    // Fetch request details
-    const { data: request, error: fetchError } = await admin
-      .from('access_requests')
-      .select('*')
-      .eq('id', requestId)
-      .single()
-
-    if (fetchError || !request) {
-      return NextResponse.json({ ok: false, error: 'Solicitação não encontrada.' }, { status: 404 })
-    }
-
-    if (request.status !== 'pending') {
-      return NextResponse.json({ ok: false, error: `Solicitação já processada (${request.status}).` }, { status: 400 })
-    }
-
-    if (action === 'reject') {
-      // Reject logic
-      const { error: updateError } = await admin
-        .from('access_requests')
-        .update({ status: 'rejected', updated_at: new Date().toISOString() })
-        .eq('id', requestId)
-
-      if (updateError) throw updateError
-
-      // Mock Email
-      console.log(`[EMAIL] To: ${request.email} | Subject: Solicitação Recusada | Body: Infelizmente seu pedido foi negado.`)
-
-      return NextResponse.json({ ok: true, message: 'Solicitação recusada.' })
-    }
-
-    if (action === 'accept') {
-      // Accept logic
-      // 1. Create Auth User
-      // We use a temp password or generate one. Usually we send a magic link or password reset.
-      // Since I can't send real emails easily, I'll generate a password and "log it" (simulation).
-      // Or better, create user with email_confirm: true and let them reset password?
-      // "enviar um e-mail de boas-vindas com instruções de acesso"
-      
-      const tempPassword = Math.random().toString(36).slice(-8) + 'Aa1!'
-      
-      const { data: authUser, error: authError } = await admin.auth.admin.createUser({
-        email: request.email,
-        password: tempPassword,
-        email_confirm: true,
-        user_metadata: {
-            full_name: request.full_name,
-            phone: request.phone,
-            birth_date: request.birth_date
-        }
-      })
-
-      if (authError) {
-        // If user already exists, we might want to just link profile or fail
-        if (authError.message.includes('already registered')) {
-            // Check if profile exists
-             const { data: existingProfile } = await admin.from('profiles').select('id').eq('email', request.email).maybeSingle()
-             if (existingProfile) {
-                 return NextResponse.json({ ok: false, error: 'Usuário já existe no sistema.' }, { status: 400 })
-             }
-             // If auth exists but no profile, we can proceed to create profile (edge case)
-             // But for now return error to be safe
-             return NextResponse.json({ ok: false, error: 'E-mail já cadastrado na autenticação.' }, { status: 400 })
-        }
-        throw authError
-      }
-
-      const userId = authUser.user.id
-
-      // 2. Create Profile
-      const { error: profileError } = await admin
-        .from('profiles')
-        .insert({
-            id: userId,
-            email: request.email,
-            display_name: request.full_name,
-            role: 'student',
-        })
-
-      if (profileError) {
-          const code = profileError && (profileError as any).code ? String((profileError as any).code) : ''
-          if (code === '23505') {
-              console.warn('Profile already exists for user, treating as success:', {
-                userId,
-                email: request.email,
-              })
-          } else {
-              console.error('Profile creation failed:', profileError)
-              try {
-                  await admin.auth.admin.deleteUser(userId)
-              } catch {}
-              throw profileError
-          }
-      }
-
-      // 3. Update Request
-      const { error: updateError } = await admin
-        .from('access_requests')
-        .update({ status: 'accepted', updated_at: new Date().toISOString() })
-        .eq('id', requestId)
-
-      if (updateError) throw updateError
-
-      // Mock Email
-      console.log(`[EMAIL] To: ${request.email} | Subject: Bem-vindo ao IronTracks! | Body: Sua conta foi criada. Senha temporária: ${tempPassword}`)
-
-      return NextResponse.json({ ok: true, message: 'Conta criada e acesso liberado.' })
-    }
-
-  } catch (e: any) {
-    console.error('Access Action Error:', e)
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/ai/coach-chat/route 2.ts b/_archive/duplicates/src/app/api/ai/coach-chat/route 2.ts
deleted file mode 100644
index 876bf13..0000000
--- a/_archive/duplicates/src/app/api/ai/coach-chat/route 2.ts	
+++ /dev/null
@@ -1,151 +0,0 @@
-import { NextResponse } from 'next/server';
-import { GoogleGenerativeAI } from '@google/generative-ai';
-import { requireUser } from '@/utils/auth/route';
-
-export const dynamic = 'force-dynamic';
-
-const MODEL_ID = process.env.GOOGLE_GENERATIVE_AI_MODEL_ID || 'gemini-2.0-flash-exp';
-
-const formatSession = (session: any): string => {
-    if (!session) return 'Nenhum dado disponível.';
-    
-    let summary = `Título: ${session.workoutTitle || 'Treino sem nome'}\n`;
-    summary += `Data: ${new Date(session.date || Date.now()).toLocaleDateString('pt-BR')}\n`;
-    summary += `Duração: ${Math.round((session.totalTime || 0) / 60)} min\n`;
-    
-    const exercises = Array.isArray(session.exercises) ? session.exercises : [];
-    const logs = session.logs || {};
-    
-    summary += 'Exercícios:\n';
-    exercises.forEach((ex: any, idx: number) => {
-        summary += `${idx + 1}. ${ex.name} (${ex.sets} séries, Método: ${ex.method || 'Normal'}, RPE: ${ex.rpe || '-'}, Descanso: ${ex.restTime || '-'}s)\n`;
-        // Add logs detail
-        for (let s = 0; s < (ex.sets || 0); s++) {
-            const key = `${idx}-${s}`;
-            const log = logs[key];
-            if (log) {
-                summary += `   - Série ${s + 1}: ${log.weight}kg x ${log.reps} reps\n`;
-            }
-        }
-    });
-    
-    return summary;
-};
-
-export async function POST(req: Request) {
-    try {
-        const user = await requireUser();
-        if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
-
-        const body = await req.json();
-        const { messages, context } = body;
-
-        if (!process.env.GOOGLE_GENERATIVE_AI_API_KEY) {
-            return NextResponse.json({ error: 'API Key missing' }, { status: 500 });
-        }
-
-        const genAI = new GoogleGenerativeAI(process.env.GOOGLE_GENERATIVE_AI_API_KEY);
-        const model = genAI.getGenerativeModel({ model: MODEL_ID });
-
-        const currentWorkout = formatSession(context?.session);
-        const previousWorkout = formatSession(context?.previousSession);
-
-        const isGeneralMode = !context?.session && !context?.previousSession;
-
-        const systemPrompt = `
-Você é o Iron Coach, um treinador de força e condicionamento físico de elite e especialista em biomecânica.
-Sua missão é analisar os dados do treino do usuário e responder perguntas, fornecer feedbacks técnicos e motivar.
-
-${isGeneralMode ? `
-MODO GERAL (SEM TREINO ESPECÍFICO):
-O usuário está na área VIP e quer tirar dúvidas gerais sobre treino, nutrição ou estratégia.
-Use seu conhecimento para guiar o usuário. Se ele perguntar sobre um treino específico, peça para ele abrir o relatório daquele treino.
-` : `
-DADOS DO TREINO ATUAL (ACABOU DE FINALIZAR):
-${currentWorkout}
-
-DADOS DO TREINO ANTERIOR (REFERÊNCIA):
-${previousWorkout}
-`}
-
-DIRETRIZES DE PERSONALIDADE:
-1. Fale como um treinador experiente: direto, técnico mas acessível, e focado em resultados.
-2. Use Português do Brasil.
-3. Seja conciso. Evite textos longos e genéricos. Vá direto ao ponto.
-4. Use emojis ocasionalmente para manter o tom leve (💪, 🔥, 🚀).
-
-REGRAS DE ANÁLISE:
-1. Se o usuário perguntar sobre um grupo muscular ou exercício, analise os números (carga, reps). Compare com o treino anterior se disponível.
-2. Se houve queda de rendimento, pergunte a causa (dor, sono, estresse) e valide a decisão de reduzir carga para priorizar técnica.
-3. Se houve progresso, parabenize especificamente (ex: "Aumentou 2kg no Supino, excelente!").
-4. Se o usuário falar sobre dor ou desconforto, sugira ajustes de execução ou descanso, mas lembre que não é médico.
-
-RESUMO DA CONVERSA ATÉ AGORA:
-(O usuário e você já trocaram as mensagens abaixo. Continue a conversa naturalmente.)
-`;
-
-        // Convert messages to Gemini format
-        // Gemini expects: { role: 'user' | 'model', parts: [{ text: ... }] }
-        // Our messages: { role: 'user' | 'assistant', content: ... }
-        const history = (messages || []).map((m: any) => ({
-            role: m.role === 'assistant' ? 'model' : 'user',
-            parts: [{ text: m.content }]
-        }));
-
-        // We use generateContent with system instruction if supported, or prepend it.
-        // gemini-1.5-pro supports systemInstruction. 
-        // For broad compatibility, we'll prepend the context to the first message or use a chat session.
-        
-        const chat = model.startChat({
-            history: [
-                {
-                    role: 'user',
-                    parts: [{ text: systemPrompt + "\n\nEntendi o contexto. Estou pronto para analisar o treino." }]
-                },
-                {
-                    role: 'model',
-                    parts: [{ text: "Ótimo. Estou com os dados do seu treino em mãos. O que gostaria de saber ou discutir sobre sua performance de hoje?" }]
-                },
-                ...history
-            ]
-        });
-
-        // The last message is usually the trigger, but in 'chat' mode we just send the last user input?
-        // Actually, the `messages` array includes the latest user message.
-        // So we should pop it to send it as `sendMessage`.
-        
-        const lastMsg = history.length > 0 && history[history.length - 1].role === 'user' 
-            ? history.pop() 
-            : { parts: [{ text: "Pode fazer uma análise geral?" }] };
-
-        // Re-initialize chat with history excluding the last message
-        const finalChat = model.startChat({
-            history: [
-                {
-                    role: 'user',
-                    parts: [{ text: systemPrompt + "\n\nEntendi o contexto. Estou pronto." }]
-                },
-                {
-                    role: 'model',
-                    parts: [{ text: "Certo. Vamos lá." }]
-                },
-                ...history
-            ]
-        });
-
-        const result = await finalChat.sendMessage(lastMsg.parts[0].text);
-        const responseText = result.response.text();
-
-        return NextResponse.json({ 
-            role: 'assistant', 
-            content: responseText 
-        });
-
-    } catch (error: any) {
-        console.error('Coach Chat Error:', error);
-        return NextResponse.json({ 
-            error: 'Failed to process chat', 
-            details: error?.message ?? String(error) 
-        }, { status: 500 });
-    }
-}
diff --git a/_archive/duplicates/src/app/api/ai/workout-wizard/route 2.ts b/_archive/duplicates/src/app/api/ai/workout-wizard/route 2.ts
deleted file mode 100644
index 1b085b9..0000000
--- a/_archive/duplicates/src/app/api/ai/workout-wizard/route 2.ts	
+++ /dev/null
@@ -1,320 +0,0 @@
-import { NextResponse } from 'next/server'
-import { GoogleGenerativeAI } from '@google/generative-ai'
-import { requireUser } from '@/utils/auth/route'
-import { generateWorkoutFromWizard } from '@/utils/workoutWizardGenerator'
-
-import * as validation from '@/utils/workoutWizardAiValidation'
-
-export const dynamic = 'force-dynamic'
-
-const WORKOUT_WIZARD_MODEL = process.env.GOOGLE_GENERATIVE_AI_MODEL_ID || 'gemini-2.5-flash'
-
-const safeJsonParse = (raw: string) => {
-  try {
-    const trimmed = String(raw || '').trim()
-    if (!trimmed) return null
-    return JSON.parse(trimmed)
-  } catch {
-    return null
-  }
-}
-
-const extractJsonFromModelText = (text: string) => {
-  const cleaned = String(text || '').trim()
-  if (!cleaned) return null
-  const direct = safeJsonParse(cleaned)
-  if (direct) return direct
-  const start = cleaned.indexOf('{')
-  const end = cleaned.lastIndexOf('}')
-  if (start === -1 || end === -1 || end <= start) return null
-  return safeJsonParse(cleaned.slice(start, end + 1))
-}
-
-const toBool = (v: any) => Boolean(v)
-
-const normalizeAnswers = (answersRaw: any) => {
-  const a = answersRaw && typeof answersRaw === 'object' ? answersRaw : {}
-  const goal = String(a.goal || 'hypertrophy')
-  const split = String(a.split || 'full_body')
-  const focus = String(a.focus || 'balanced')
-  const equipment = String(a.equipment || 'gym')
-  const level = String(a.level || 'beginner')
-  const daysPerWeek = Number(a.daysPerWeek || 3) || 3
-  const timeMinutes = Number(a.timeMinutes || 45) || 45
-  const constraints = String(a.constraints || '')
-  return { goal, split, focus, equipment, level, daysPerWeek, timeMinutes, constraints }
-}
-
-const buildPromptSingle = (answers: any) => {
-  const constraints = String(answers?.constraints || '')
-  const constraintsNormalized = String((validation as any)?.normalizeText?.(constraints) ?? '').trim()
-  const machinePriorityFromText = toBool((validation as any)?.detectFlagsFromConstraints?.(constraints)?.machinePriority)
-  const shoulderFromText = toBool((validation as any)?.detectFlagsFromConstraints?.(constraints)?.shoulderSensitive)
-  const avoidOverheadFromText = toBool((validation as any)?.detectFlagsFromConstraints?.(constraints)?.avoidOverhead)
-  const noBarbellFromText = toBool((validation as any)?.detectFlagsFromConstraints?.(constraints)?.noBarbell)
-
-  const absoluteRules: string[] = [
-    'Retorne APENAS um JSON válido (sem markdown, sem texto extra).',
-    'Escreva em pt-BR.',
-    'A prioridade máxima é obedecer fielmente as restrições/observações do usuário (answers.constraints). Não ignore.',
-    'Se houver conflito entre objetivo/split e restrições, adapte o treino para cumprir as restrições.',
-    'Use nomes comuns de exercícios de academia (Brasil).',
-    'Não invente equipamentos fora do contexto do usuário.',
-    'Evite repetir exatamente o mesmo treino para níveis diferentes.',
-  ]
-
-  const safetyRules: string[] = []
-  if (shoulderFromText || avoidOverheadFromText) {
-    safetyRules.push('Usuário relatou dor/restrição no ombro/overhead: evitar desenvolvimento/militar/overhead press, dips/paralelas e remada alta/upright row.')
-    safetyRules.push('Prefira: máquinas/cabos, pegada neutra, movimentos estáveis e controlados.')
-  }
-  if (noBarbellFromText) {
-    safetyRules.push('Usuário pediu sem barra: evitar exercícios com barra livre (barbell) como padrão; preferir máquinas, halteres ou cabos.')
-  }
-  if (machinePriorityFromText) {
-    safetyRules.push('Usuário pediu priorizar máquinas (ex.: Smart Fit): a maior parte dos exercícios deve ser em máquinas/cabos.')
-  }
-
-  const schema = [
-    '{',
-    '  "title": string,',
-    '  "notes": string (curto, opcional),',
-    '  "constraintsApplied": string[] (2-6 bullets explicando como você cumpriu as restrições),',
-    '  "rejectedItems": string[] (0-6, opcional, itens que você evitou por restrição),',
-    '  "exercises": [',
-    '    { "name": string, "sets": number, "reps": string, "restTime": number, "rpe": string|null, "notes": string|null }',
-    '  ]',
-    '}',
-  ].join('\n')
-
-  const levelGuidance =
-    answers.level === 'beginner'
-      ? 'Nível iniciante: exercícios simples, estáveis, técnica fácil, volume moderado.'
-      : answers.level === 'advanced'
-        ? 'Nível avançado: mais volume/variação e progressão, sem sacrificar segurança.'
-        : 'Nível intermediário: equilíbrio entre volume e complexidade.'
-
-  const prompt = [
-    'Você é um coach de musculação do app IronTracks.',
-    '',
-    'REGRAS ABSOLUTAS:',
-    ...absoluteRules.map((r) => `- ${r}`),
-    '',
-    safetyRules.length ? 'REGRAS DE SEGURANÇA:' : '',
-    ...safetyRules.map((r) => `- ${r}`),
-    '',
-    'OBJETIVO:',
-    '- Gerar um treino que combine com o nível, objetivo, tempo e equipamento.',
-    '',
-    'GUIA DE NÍVEL:',
-    `- ${levelGuidance}`,
-    '',
-    'DADOS DO USUÁRIO (JSON):',
-    JSON.stringify(answers),
-    '',
-    'CAMPO DE RESTRIÇÕES (texto original):',
-    constraints,
-    '',
-    'CAMPO DE RESTRIÇÕES (normalizado):',
-    constraintsNormalized,
-    '',
-    'FORMATO DE SAÍDA (JSON):',
-    schema,
-  ]
-    .filter(Boolean)
-    .join('\n')
-
-  return prompt
-}
-
-const buildPromptVariants = (answers: any, variants: string[]) => {
-  const schema = [
-    '{',
-    '  "drafts": [',
-    '    {',
-    '      "level": "beginner"|"intermediate"|"advanced",',
-    '      "title": string,',
-    '      "notes": string (curto, opcional),',
-    '      "constraintsApplied": string[],',
-    '      "rejectedItems": string[],',
-    '      "exercises": [ { "name": string, "sets": number, "reps": string, "restTime": number, "rpe": string|null, "notes": string|null } ]',
-    '    }',
-    '  ]',
-    '}',
-  ].join('\n')
-
-  const prompt = [
-    'Você é um coach de musculação do app IronTracks.',
-    'Retorne APENAS um JSON válido (sem markdown, sem texto extra).',
-    'Escreva em pt-BR.',
-    'A prioridade máxima é obedecer fielmente as restrições/observações do usuário (answers.constraints). Não ignore.',
-    'Gere múltiplas variações do treino, uma para cada nível solicitado, e garanta que não sejam iguais.',
-    '',
-    'Níveis solicitados:',
-    JSON.stringify(variants),
-    '',
-    'Dados do usuário (JSON):',
-    JSON.stringify(answers),
-    '',
-    'Formato de saída (JSON):',
-    schema,
-  ].join('\n')
-
-  return prompt
-}
-
-const genText = async (prompt: string) => {
-  const apiKey = process.env.GOOGLE_GENERATIVE_AI_API_KEY
-  if (!apiKey) {
-    return { ok: false as const, error: 'API de IA não configurada. Configure GOOGLE_GENERATIVE_AI_API_KEY.' }
-  }
-  const genAI = new GoogleGenerativeAI(apiKey)
-  const model = genAI.getGenerativeModel({ model: WORKOUT_WIZARD_MODEL })
-  const result = await model.generateContent([{ text: prompt }] as any)
-  const text = (await result?.response?.text()) || ''
-  return { ok: true as const, text }
-}
-
-const applyFallbackFilter = (draft: any, constraintsText: string) => {
-  const flags = (validation as any)?.detectFlagsFromConstraints?.(constraintsText) || {}
-  const normalized = (validation as any)?.normalizeDraft?.(draft) || { title: 'Treino', exercises: [] }
-  const forbidShoulder = Boolean(flags.shoulderSensitive || flags.avoidOverhead)
-  const forbidBarbell = Boolean(flags.noBarbell)
-  const machinePriority = Boolean(flags.machinePriority)
-
-  const replaceMap: Array<{ test: (n: string) => boolean; replace: string }> = []
-  if (forbidShoulder) {
-    replaceMap.push(
-      { test: (n) => (validation as any).normalizeText(n).includes('desenvolvimento'), replace: 'Face pull' },
-      { test: (n) => (validation as any).normalizeText(n).includes('militar'), replace: 'Face pull' },
-      { test: (n) => (validation as any).normalizeText(n).includes('overhead'), replace: 'Face pull' },
-      { test: (n) => (validation as any).normalizeText(n).includes('paralelas'), replace: 'Tríceps na polia (corda)' },
-      { test: (n) => (validation as any).normalizeText(n).includes('dips'), replace: 'Tríceps na polia (corda)' },
-      { test: (n) => (validation as any).normalizeText(n).includes('remada alta'), replace: 'Face pull' },
-    )
-  }
-  if (forbidBarbell || machinePriority) {
-    replaceMap.push(
-      { test: (n) => (validation as any).normalizeText(n).includes('supino reto'), replace: 'Chest press (máquina)' },
-      { test: (n) => (validation as any).normalizeText(n).includes('supino inclinado'), replace: 'Chest press inclinado (máquina)' },
-      { test: (n) => (validation as any).normalizeText(n).includes('agachamento livre'), replace: 'Leg press' },
-      { test: (n) => (validation as any).normalizeText(n).includes('remada curvada'), replace: 'Remada baixa (máquina/cabo)' },
-      { test: (n) => (validation as any).normalizeText(n).includes('levantamento terra'), replace: 'Hip thrust (máquina)' },
-      { test: (n) => (validation as any).normalizeText(n).includes('terra romeno'), replace: 'Mesa flexora' },
-    )
-  }
-
-  const next = {
-    title: normalized.title,
-    exercises: normalized.exercises.map((e: any) => {
-      const name = String(e?.name || '').trim()
-      const mapped = replaceMap.find((m) => m.test(name))
-      return { ...e, name: mapped ? mapped.replace : name }
-    }),
-  }
-  return next
-}
-
-const normalizeVariantLevel = (v: string) => {
-  const t = String(v || '').trim().toLowerCase()
-  if (t === 'beginner' || t === 'intermediate' || t === 'advanced') return t
-  return null
-}
-
-export async function POST(req: Request) {
-  try {
-    const auth = await requireUser()
-    if (!auth.ok) return auth.response
-
-    const body = await req.json().catch(() => ({}))
-    const answers = normalizeAnswers(body?.answers)
-    const variantsRaw = Array.isArray(body?.variants) ? body.variants : null
-    const variants = variantsRaw ? (variantsRaw.map((v: any) => normalizeVariantLevel(String(v))).filter(Boolean) as string[]) : null
-
-    const runSingle = async (answersForRun: any) => {
-      const prompt = buildPromptSingle(answersForRun)
-      let lastError = ''
-      for (let attempt = 0; attempt < 3; attempt++) {
-        const res = await genText(attempt === 0 ? prompt : `${prompt}\n\nCORREÇÃO OBRIGATÓRIA:\n${lastError}\nRefaça o JSON obedecendo todas as regras.`)
-        if (!res.ok) return { ok: false as const, error: res.error }
-        const parsed = extractJsonFromModelText(res.text)
-        if (!parsed) {
-          lastError = 'Resposta inválida (JSON não parseável).'
-          continue
-        }
-        const check = (validation as any).validateDraftAgainstConstraints(parsed, answersForRun.constraints)
-        if (!check?.ok) {
-          lastError = `Problemas encontrados: ${Array.isArray(check?.errors) ? check.errors.join(' ') : 'violação de regras'}`
-          continue
-        }
-        return { ok: true as const, draft: (validation as any).normalizeDraft(parsed) }
-      }
-      return { ok: false as const, error: lastError || 'Resposta inválida da IA.' }
-    }
-
-    const runVariants = async (answersForRun: any, levels: string[]) => {
-      const prompt = buildPromptVariants(answersForRun, levels)
-      let lastError = ''
-      for (let attempt = 0; attempt < 3; attempt++) {
-        const res = await genText(attempt === 0 ? prompt : `${prompt}\n\nCORREÇÃO OBRIGATÓRIA:\n${lastError}\nRefaça o JSON obedecendo todas as regras.`)
-        if (!res.ok) return { ok: false as const, error: res.error }
-        const parsed = extractJsonFromModelText(res.text)
-        const draftsRaw = parsed && typeof parsed === 'object' ? (Array.isArray((parsed as any).drafts) ? (parsed as any).drafts : null) : null
-        if (!draftsRaw || !draftsRaw.length) {
-          lastError = 'Resposta inválida (drafts ausente).'
-          continue
-        }
-        const normalizedDrafts = draftsRaw
-          .map((d: any) => {
-            const level = normalizeVariantLevel(String(d?.level || ''))
-            if (!level) return null
-            const check = (validation as any).validateDraftAgainstConstraints(d, answersForRun.constraints)
-            if (!check?.ok) return { level, ok: false, errors: check?.errors || [] }
-            return { level, ok: true, draft: (validation as any).normalizeDraft(d) }
-          })
-          .filter(Boolean)
-        const hasInvalid = normalizedDrafts.some((d: any) => !d.ok)
-        if (hasInvalid) {
-          lastError = normalizedDrafts
-            .filter((d: any) => !d.ok)
-            .slice(0, 2)
-            .map((d: any) => `[${d.level}] ${Array.isArray(d.errors) ? d.errors.join(' ') : 'inválido'}`)
-            .join(' ')
-          continue
-        }
-        const sorted = levels
-          .map((lv) => normalizedDrafts.find((d: any) => d.level === lv))
-          .filter(Boolean)
-          .map((d: any) => d.draft)
-        if (sorted.length >= 2) {
-          const sim = (validation as any).similarityByNames(sorted[0], sorted[1])
-          if (sim >= 0.7) {
-            lastError = `Os treinos ficaram parecidos demais (similaridade ${(sim * 100).toFixed(0)}%). Garanta diferença real de exercícios e estrutura entre níveis.`
-            continue
-          }
-        }
-        return { ok: true as const, drafts: sorted }
-      }
-      return { ok: false as const, error: lastError || 'Resposta inválida da IA.' }
-    }
-
-    if (variants && variants.length) {
-      const ai = await runVariants({ ...answers }, variants)
-      if (ai.ok) return NextResponse.json({ ok: true, drafts: ai.drafts })
-      const fallbackDrafts = variants.map((lv: string) => {
-        const base = generateWorkoutFromWizard({ ...(answers as any), level: lv } as any)
-        return applyFallbackFilter(base, answers.constraints)
-      })
-      return NextResponse.json({ ok: false, error: ai.error, drafts: fallbackDrafts }, { status: 200 })
-    }
-
-    const ai = await runSingle({ ...answers })
-    if (ai.ok) return NextResponse.json({ ok: true, draft: ai.draft })
-
-    const base = generateWorkoutFromWizard(answers as any)
-    const fallback = applyFallbackFilter(base, answers.constraints)
-    return NextResponse.json({ ok: false, error: ai.error, draft: fallback }, { status: 200 })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/assessment-scanner/route 2.ts b/_archive/duplicates/src/app/api/assessment-scanner/route 2.ts
deleted file mode 100644
index 829cf14..0000000
--- a/_archive/duplicates/src/app/api/assessment-scanner/route 2.ts	
+++ /dev/null
@@ -1,30 +0,0 @@
-import { NextRequest, NextResponse } from "next/server";
-import { processAssessmentDocument } from "@/actions/assessment-scanner-actions";
-
-export const runtime = "nodejs";
-
-export async function POST(req: NextRequest) {
-  try {
-    const contentType = req.headers.get("content-type") || "";
-    const isMultipart = contentType.toLowerCase().includes("multipart/form-data");
-    if (!isMultipart) {
-      return NextResponse.json({ ok: false, error: "Content-Type inválido" }, { status: 400 });
-    }
-
-    const formData = await req.formData();
-    const result = await processAssessmentDocument(formData);
-
-    if (!result.ok) {
-      return NextResponse.json(
-        { ok: false, error: result.error || "Falha ao processar avaliação" },
-        { status: 400 }
-      );
-    }
-
-    return NextResponse.json({ ok: true, formData: result.formData ?? {} });
-  } catch (e: any) {
-    const msg = e?.message ? String(e.message) : String(e);
-    return NextResponse.json({ ok: false, error: msg || "Erro inesperado" }, { status: 500 });
-  }
-}
-
diff --git a/_archive/duplicates/src/app/api/assessment-scanner/route 3.ts b/_archive/duplicates/src/app/api/assessment-scanner/route 3.ts
deleted file mode 100644
index 829cf14..0000000
--- a/_archive/duplicates/src/app/api/assessment-scanner/route 3.ts	
+++ /dev/null
@@ -1,30 +0,0 @@
-import { NextRequest, NextResponse } from "next/server";
-import { processAssessmentDocument } from "@/actions/assessment-scanner-actions";
-
-export const runtime = "nodejs";
-
-export async function POST(req: NextRequest) {
-  try {
-    const contentType = req.headers.get("content-type") || "";
-    const isMultipart = contentType.toLowerCase().includes("multipart/form-data");
-    if (!isMultipart) {
-      return NextResponse.json({ ok: false, error: "Content-Type inválido" }, { status: 400 });
-    }
-
-    const formData = await req.formData();
-    const result = await processAssessmentDocument(formData);
-
-    if (!result.ok) {
-      return NextResponse.json(
-        { ok: false, error: result.error || "Falha ao processar avaliação" },
-        { status: 400 }
-      );
-    }
-
-    return NextResponse.json({ ok: true, formData: result.formData ?? {} });
-  } catch (e: any) {
-    const msg = e?.message ? String(e.message) : String(e);
-    return NextResponse.json({ ok: false, error: msg || "Erro inesperado" }, { status: 500 });
-  }
-}
-
diff --git a/_archive/duplicates/src/app/api/diagnostics/iron-rank/route 2.ts b/_archive/duplicates/src/app/api/diagnostics/iron-rank/route 2.ts
deleted file mode 100644
index a85f12b..0000000
--- a/_archive/duplicates/src/app/api/diagnostics/iron-rank/route 2.ts	
+++ /dev/null
@@ -1,118 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createClient } from '@/utils/supabase/server'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-const safeJson = (v: any) => {
-  try {
-    return JSON.stringify(v)
-  } catch {
-    return null
-  }
-}
-
-const parseJson = (raw: any) => {
-  try {
-    if (!raw) return null
-    if (typeof raw === 'object') return raw
-    const s = String(raw).trim()
-    if (!s) return null
-    return JSON.parse(s)
-  } catch {
-    return null
-  }
-}
-
-const extractLogs = (notes: any) => {
-  const base = notes && typeof notes === 'object' ? notes : null
-  if (!base) return null
-  return (base as any)?.logs ?? (base as any)?.session?.logs ?? (base as any)?.rawSession?.logs ?? null
-}
-
-export async function GET() {
-  try {
-    const supabase = await createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-    if (!user) return NextResponse.json({ ok: false, error: 'unauthorized' }, { status: 401 })
-
-    const admin = createAdminClient()
-
-    const rpcRes = await supabase.rpc('iron_rank_leaderboard', { limit_count: 10 })
-
-    const workoutsCountRes = await admin
-      .from('workouts')
-      .select('id', { head: true, count: 'exact' })
-      .eq('is_template', false)
-
-    const setsCountRes = await admin
-      .from('sets')
-      .select('id', { head: true, count: 'exact' })
-      .or('completed.is.null,completed.eq.true')
-      .gt('weight', 0)
-      .not('reps', 'is', null)
-
-    const recentWorkoutsRes = await admin
-      .from('workouts')
-      .select('id, user_id, notes, created_at, date, is_template')
-      .eq('is_template', false)
-      .order('date', { ascending: false })
-      .limit(20)
-
-    const recent = Array.isArray(recentWorkoutsRes.data) ? recentWorkoutsRes.data : []
-    const parsedRecent = recent
-      .map((w: any) => {
-        const notes = parseJson(w?.notes)
-        const logs = extractLogs(notes)
-        const logsObj = logs && typeof logs === 'object' ? logs : null
-        const entries = logsObj ? Object.entries(logsObj) : []
-        const doneEntries = entries.filter(([, v]) => {
-          const vv = v && typeof v === 'object' ? v : null
-          const done = (vv as any)?.done ?? (vv as any)?.isDone ?? (vv as any)?.completed ?? null
-          return done === true || String(done || '').toLowerCase() === 'true'
-        })
-        return {
-          id: w?.id ?? null,
-          user_id: w?.user_id ?? null,
-          has_notes: !!w?.notes,
-          notes_type: typeof w?.notes,
-          parsed_notes: !!notes,
-          logs_path: logs ? 'found' : 'missing',
-          logs_entries: entries.length,
-          done_entries: doneEntries.length,
-          note_keys: notes && typeof notes === 'object' ? Object.keys(notes).slice(0, 30) : [],
-          sample_log_keys:
-            doneEntries.length && doneEntries[0]?.[1] && typeof doneEntries[0][1] === 'object'
-              ? Object.keys(doneEntries[0][1]).slice(0, 30)
-              : [],
-        }
-      })
-      .slice(0, 10)
-
-    return NextResponse.json({
-      ok: true,
-      rpc: {
-        error: rpcRes.error ? { message: rpcRes.error.message, code: (rpcRes.error as any).code ?? null } : null,
-        rows: Array.isArray(rpcRes.data) ? rpcRes.data.length : 0,
-        sample: Array.isArray(rpcRes.data) ? rpcRes.data.slice(0, 5) : null,
-      },
-      counts: {
-        workouts_non_template: workoutsCountRes.count ?? null,
-        sets_weight_gt0_reps_notnull_completed_true_or_null: setsCountRes.count ?? null,
-      },
-      recent_workouts_sample: parsedRecent,
-      raw: {
-        workouts_count_error: workoutsCountRes.error ? workoutsCountRes.error.message : null,
-        sets_count_error: setsCountRes.error ? setsCountRes.error.message : null,
-        recent_error: recentWorkoutsRes.error ? recentWorkoutsRes.error.message : null,
-        rpc_error_raw: rpcRes.error ? safeJson(rpcRes.error) : null,
-      },
-    })
-  } catch (e: any) {
-    return NextResponse.json(
-      { ok: false, error: e?.message ? String(e.message) : String(e), where: 'api/diagnostics/iron-rank' },
-      { status: 500 }
-    )
-  }
-}
-
diff --git a/_archive/duplicates/src/app/api/exercises/canonicalize/route 2.ts b/_archive/duplicates/src/app/api/exercises/canonicalize/route 2.ts
deleted file mode 100644
index 1df7c29..0000000
--- a/_archive/duplicates/src/app/api/exercises/canonicalize/route 2.ts	
+++ /dev/null
@@ -1,317 +0,0 @@
-import { NextResponse } from 'next/server'
-import { GoogleGenerativeAI } from '@google/generative-ai'
-
-import { requireUser } from '@/utils/auth/route'
-import { createAdminClient } from '@/utils/supabase/admin'
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName'
-
-export const runtime = 'nodejs'
-export const dynamic = 'force-dynamic'
-
-const MODEL_ID = process.env.GOOGLE_GENERATIVE_AI_MODEL_ID || 'gemini-2.5-flash'
-
-const extractJson = (raw: string) => {
-  const text = String(raw || '').trim()
-  if (!text) return null
-  let candidate = text
-  if (candidate.startsWith('```')) {
-    const firstBreak = candidate.indexOf('\n')
-    const lastFence = candidate.lastIndexOf('```')
-    if (firstBreak !== -1 && lastFence !== -1) {
-      candidate = candidate.substring(firstBreak + 1, lastFence).trim()
-    }
-  }
-  try {
-    return JSON.parse(candidate)
-  } catch {
-    const start = candidate.indexOf('{')
-    const end = candidate.lastIndexOf('}')
-    if (start === -1 || end === -1 || end <= start) return null
-    const slice = candidate.substring(start, end + 1)
-    try {
-      return JSON.parse(slice)
-    } catch {
-      return null
-    }
-  }
-}
-
-const isMissingTable = (error: any) => {
-  try {
-    if (!error) return false
-    const status = Number((error as any)?.status)
-    const code = (error as any)?.code ? String((error as any).code) : ''
-    const msg = (error as any)?.message ? String((error as any).message) : ''
-    return status === 404 || code === '42P01' || /does not exist/i.test(msg) || /not found/i.test(msg)
-  } catch {
-    return false
-  }
-}
-
-const tokenize = (normalized: string) => {
-  return new Set(String(normalized || '').split(' ').map((t) => t.trim()).filter(Boolean))
-}
-
-const jaccard = (a: Set<string>, b: Set<string>) => {
-  if (!a.size && !b.size) return 0
-  let inter = 0
-  a.forEach((x) => {
-    if (b.has(x)) inter += 1
-  })
-  const union = a.size + b.size - inter
-  return union ? inter / union : 0
-}
-
-const bestDeterministic = (
-  aliasNormalized: string,
-  canonicals: Array<{ id: string; display_name: string; normalized_name: string }>,
-) => {
-  const a = String(aliasNormalized || '').trim()
-  if (!a) return null
-  const aTokens = tokenize(a)
-  let best: { id: string; display_name: string; score: number } | null = null
-  for (const c of canonicals) {
-    const cn = String(c?.normalized_name || '').trim()
-    if (!cn) continue
-    let score = 0
-    if (cn === a) score = 1
-    else if (cn.includes(a) || a.includes(cn)) score = 0.9
-    else score = jaccard(aTokens, tokenize(cn))
-    if (!best || score > best.score) best = { id: String(c.id), display_name: String(c.display_name), score }
-  }
-  if (!best) return null
-  if (best.score >= 0.78) return best
-  return null
-}
-
-async function resolveWithGemini(payload: Array<{ alias: string; normalized: string; candidates: string[] }>) {
-  const apiKey = String(process.env.GOOGLE_GENERATIVE_AI_API_KEY || '').trim()
-  if (!apiKey) throw new Error('missing_gemini_key')
-
-  const genAI = new GoogleGenerativeAI(apiKey)
-  const model = genAI.getGenerativeModel({ model: MODEL_ID })
-
-  const prompt =
-    'Você é um assistente para PADRONIZAR nomes de exercícios de musculação para relatórios de evolução.' +
-    ' Retorne APENAS JSON válido no formato {"items":[{"normalized":string,"canonical":string,"confidence":number}]}.' +
-    ' Regras: 1) canonical deve ser curto e consistente, preferindo PT-BR (ex: "Supino Reto", "Agachamento Livre").' +
-    ' 2) Se houver candidatos, escolha o mais adequado dentre eles (não invente outro se um candidato serve).' +
-    ' 3) confidence de 0 a 1 (0.9+ quando for óbvio).' +
-    ' 4) Não inclua markdown nem texto extra.' +
-    ` Itens: ${JSON.stringify(payload)}`
-
-  const result = await model.generateContent(prompt)
-  const text = (await result?.response?.text()) || ''
-  const parsed = extractJson(text)
-  const items = parsed && typeof parsed === 'object' ? (parsed as any).items : null
-  return Array.isArray(items) ? items : []
-}
-
-export async function POST(req: Request) {
-  const auth = await requireUser()
-  if (!auth.ok) return auth.response
-
-  try {
-    const body: any = await req.json().catch(() => ({}))
-    const mode = String(body?.mode || '').trim().toLowerCase()
-    const asyncPrefetch = mode === 'prefetch' || mode === 'async'
-    const raw = body?.names ?? body?.name ?? []
-    const names = Array.isArray(raw) ? raw : [raw]
-    const cleaned = names
-      .map((n) => String(n ?? '').trim())
-      .filter(Boolean)
-      .slice(0, 120)
-
-    const normalizedList = Array.from(new Set(cleaned.map((n) => normalizeExerciseName(n)).filter(Boolean)))
-    if (!normalizedList.length) return NextResponse.json({ ok: true, map: {} })
-
-    const admin = createAdminClient()
-    const userId = String(auth.user.id)
-
-    const { data: aliasRows, error: aliasErr } = await admin
-      .from('exercise_aliases')
-      .select('normalized_alias, canonical_id')
-      .eq('user_id', userId)
-      .in('normalized_alias', normalizedList)
-      .limit(normalizedList.length)
-    if (isMissingTable(aliasErr)) {
-      const map: Record<string, string> = {}
-      for (const n of normalizedList) map[n] = cleaned.find((orig) => normalizeExerciseName(orig) === n) || n
-      return NextResponse.json({ ok: true, map }, { headers: { 'cache-control': 'no-store, max-age=0' } })
-    }
-
-    const aliasArr = Array.isArray(aliasRows) ? aliasRows : []
-    const byAlias = new Map<string, string>()
-    for (const r of aliasArr) {
-      const a = String((r as any)?.normalized_alias || '').trim()
-      const cid = String((r as any)?.canonical_id || '').trim()
-      if (a && cid) byAlias.set(a, cid)
-    }
-
-    const canonicalIds = Array.from(new Set(Array.from(byAlias.values())))
-    let canonicalsById = new Map<string, { id: string; display_name: string; normalized_name: string }>()
-    if (canonicalIds.length) {
-      const { data } = await admin
-        .from('exercise_canonical')
-        .select('id, display_name, normalized_name')
-        .eq('user_id', userId)
-        .in('id', canonicalIds)
-        .limit(canonicalIds.length)
-      ;(Array.isArray(data) ? data : []).forEach((row: any) => {
-        const id = String(row?.id || '').trim()
-        if (!id) return
-        canonicalsById.set(id, {
-          id,
-          display_name: String(row?.display_name || '').trim(),
-          normalized_name: String(row?.normalized_name || '').trim(),
-        })
-      })
-    }
-
-    const missing = normalizedList.filter((n) => !byAlias.has(n))
-
-    const { data: canonicalTop, error: canonicalTopErr } = await admin
-      .from('exercise_canonical')
-      .select('id, display_name, normalized_name')
-      .eq('user_id', userId)
-      .order('usage_count', { ascending: false })
-      .order('created_at', { ascending: false })
-      .limit(250)
-    if (isMissingTable(canonicalTopErr)) {
-      const map: Record<string, string> = {}
-      for (const n of normalizedList) map[n] = cleaned.find((orig) => normalizeExerciseName(orig) === n) || n
-      return NextResponse.json({ ok: true, map }, { headers: { 'cache-control': 'no-store, max-age=0' } })
-    }
-
-    const canonicals = (Array.isArray(canonicalTop) ? canonicalTop : []).map((row: any) => ({
-      id: String(row?.id || '').trim(),
-      display_name: String(row?.display_name || '').trim(),
-      normalized_name: String(row?.normalized_name || '').trim(),
-    })).filter((r: any) => r.id && r.normalized_name)
-
-    const map: Record<string, string> = {}
-    normalizedList.forEach((n) => {
-      const cid = byAlias.get(n)
-      if (!cid) return
-      const c = canonicalsById.get(cid)
-      if (c?.display_name) map[n] = c.display_name
-    })
-
-    const deterministicResolved: Array<{ normalized: string; canonical_id: string; canonical_name: string; confidence: number }> = []
-    for (const n of missing) {
-      const best = bestDeterministic(n, canonicals)
-      if (!best) continue
-      deterministicResolved.push({ normalized: n, canonical_id: best.id, canonical_name: best.display_name, confidence: best.score })
-      map[n] = best.display_name
-    }
-
-    const stillMissing = missing.filter((n) => !map[n])
-    let geminiResolved: Array<{ normalized: string; canonical: string; confidence: number }> = []
-    if (!asyncPrefetch && stillMissing.length) {
-      try {
-        const payload = stillMissing.slice(0, 40).map((n) => {
-          const rawAlias = cleaned.find((orig) => normalizeExerciseName(orig) === n) || n
-          const topCandidates = canonicals
-            .map((c) => ({ n: c.display_name, s: (() => {
-              const det = bestDeterministic(n, [c])
-              return det?.score || 0
-            })() }))
-            .filter((x) => x.s > 0.35)
-            .sort((a, b) => b.s - a.s)
-            .slice(0, 8)
-            .map((x) => x.n)
-          return { alias: rawAlias, normalized: n, candidates: topCandidates }
-        })
-        const items = await resolveWithGemini(payload)
-        geminiResolved = (Array.isArray(items) ? items : []).map((it: any) => ({
-          normalized: String(it?.normalized || '').trim(),
-          canonical: String(it?.canonical || '').trim(),
-          confidence: Number(it?.confidence),
-        })).filter((it) => it.normalized && it.canonical)
-      } catch {
-        geminiResolved = []
-      }
-    }
-
-    if (asyncPrefetch && stillMissing.length) {
-      try {
-        const jobs = stillMissing.slice(0, 80).map((n) => ({
-          user_id: userId,
-          alias: cleaned.find((orig) => normalizeExerciseName(orig) === n) || n,
-          normalized_alias: n,
-          status: 'pending',
-        }))
-        await admin.from('exercise_alias_jobs').upsert(jobs, { onConflict: 'user_id,normalized_alias' })
-      } catch {}
-    }
-
-    for (const it of geminiResolved) {
-      if (map[it.normalized]) continue
-      const canonicalName = it.canonical
-      const canonicalNormalized = normalizeExerciseName(canonicalName)
-      if (!canonicalNormalized) continue
-
-      const { data: upCanon } = await admin
-        .from('exercise_canonical')
-        .upsert(
-          { user_id: userId, display_name: canonicalName, normalized_name: canonicalNormalized },
-          { onConflict: 'user_id,normalized_name' },
-        )
-        .select('id, display_name, normalized_name, usage_count')
-        .maybeSingle()
-
-      const canonicalId = String((upCanon as any)?.id || '').trim()
-      if (!canonicalId) continue
-
-      await admin
-        .from('exercise_aliases')
-        .upsert(
-          {
-            user_id: userId,
-            canonical_id: canonicalId,
-            alias: cleaned.find((orig) => normalizeExerciseName(orig) === it.normalized) || it.normalized,
-            normalized_alias: it.normalized,
-            confidence: Number.isFinite(it.confidence) ? Math.max(0, Math.min(1, it.confidence)) : 0.65,
-            source: 'gemini',
-            needs_review: !(Number.isFinite(it.confidence) && it.confidence >= 0.78),
-          },
-          { onConflict: 'user_id,normalized_alias' },
-        )
-
-      await admin
-        .from('exercise_canonical')
-        .update({ usage_count: (upCanon as any)?.usage_count != null ? (Number((upCanon as any).usage_count) || 0) + 1 : 1 })
-        .eq('user_id', userId)
-        .eq('id', canonicalId)
-
-      map[it.normalized] = canonicalName
-    }
-
-    for (const it of deterministicResolved) {
-      try {
-        await admin
-          .from('exercise_aliases')
-          .upsert(
-            {
-              user_id: userId,
-              canonical_id: it.canonical_id,
-              alias: cleaned.find((orig) => normalizeExerciseName(orig) === it.normalized) || it.normalized,
-              normalized_alias: it.normalized,
-              confidence: Math.max(0, Math.min(1, it.confidence)),
-              source: 'deterministic',
-              needs_review: it.confidence < 0.85,
-            },
-            { onConflict: 'user_id,normalized_alias' },
-          )
-      } catch {}
-    }
-
-    for (const n of normalizedList) {
-      if (!map[n]) map[n] = cleaned.find((orig) => normalizeExerciseName(orig) === n) || n
-    }
-
-    return NextResponse.json({ ok: true, map }, { headers: { 'cache-control': 'no-store, max-age=0' } })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/marketplace/webhooks/asaas/route 2.ts b/_archive/duplicates/src/app/api/marketplace/webhooks/asaas/route 2.ts
deleted file mode 100644
index 976c201..0000000
--- a/_archive/duplicates/src/app/api/marketplace/webhooks/asaas/route 2.ts	
+++ /dev/null
@@ -1,111 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-const mapSubscriptionStatusFromPayment = (status: string) => {
-  const s = (status || '').toUpperCase()
-  if (['RECEIVED', 'CONFIRMED'].includes(s)) return 'active'
-  if (['OVERDUE'].includes(s)) return 'past_due'
-  if (['CANCELED', 'CANCELLED', 'REFUNDED', 'CHARGEBACK', 'DELETED'].includes(s)) return 'cancelled'
-  return 'pending'
-}
-
-export async function POST(req: Request) {
-  const secret = (process.env.ASAAS_WEBHOOK_SECRET || '').trim()
-  const provided = (req.headers.get('x-webhook-secret') || '').trim()
-  if (!secret) {
-    return NextResponse.json({ ok: false, error: 'webhook_not_configured' }, { status: 500 })
-  }
-  if (provided !== secret) {
-    return NextResponse.json({ ok: false, error: 'unauthorized' }, { status: 401 })
-  }
-
-  const body = await req.json().catch(() => ({}))
-
-  const eventType = (body?.event || body?.type || body?.eventType || '') as string
-  const eventId = (body?.id || body?.eventId || null) as string | null
-  const payment = (body?.payment || body?.data?.payment || null) as any
-  const paymentId = (payment?.id || null) as string | null
-  const paymentStatus = (payment?.status || '') as string
-  const subscriptionId = (payment?.subscription || null) as string | null
-
-  const admin = createAdminClient()
-
-  try {
-    const { data: inserted, error: insertErr } = await admin
-      .from('asaas_webhook_events')
-      .insert({
-        asaas_event_id: eventId,
-        event_type: eventType || null,
-        payment_id: paymentId,
-        payload: body,
-      })
-      .select('id')
-      .single()
-
-    if (insertErr) {
-      const code = (insertErr as any)?.code as string | undefined
-      const msg = insertErr.message || ''
-      if (code === '23505' || msg.toLowerCase().includes('duplicate')) {
-        return NextResponse.json({ ok: true, deduped: true })
-      }
-      return NextResponse.json({ ok: false, error: msg }, { status: 400 })
-    }
-
-    if (!paymentId) {
-      await admin.from('asaas_webhook_events').update({ processed_at: new Date().toISOString() }).eq('id', inserted.id)
-      return NextResponse.json({ ok: true, processed: false })
-    }
-
-    const updates: Record<string, any> = {
-      status: paymentStatus || 'pending',
-    }
-    if (payment?.dueDate) updates.due_date = payment.dueDate
-    if (payment?.invoiceUrl) updates.invoice_url = payment.invoiceUrl
-    if (payment?.billingType) updates.billing_type = payment.billingType
-    if (payment?.pixQrCode?.encodedImage) updates.pix_qr_code = payment.pixQrCode.encodedImage
-    if (payment?.pixQrCode?.payload) updates.pix_payload = payment.pixQrCode.payload
-    if (payment?.paymentDate) updates.paid_at = payment.paymentDate
-    if (payment?.confirmedDate && !updates.paid_at) updates.paid_at = payment.confirmedDate
-
-    const { data: payRow } = await admin
-      .from('marketplace_payments')
-      .update(updates)
-      .eq('asaas_payment_id', paymentId)
-      .select('id, subscription_id')
-      .maybeSingle()
-
-    const subStatus = mapSubscriptionStatusFromPayment(paymentStatus)
-    const subTargetId = subscriptionId
-    if (subTargetId) {
-      await admin
-        .from('marketplace_subscriptions')
-        .update({ status: subStatus, updated_at: new Date().toISOString() })
-        .eq('asaas_subscription_id', subTargetId)
-    } else if (payRow?.subscription_id) {
-      await admin
-        .from('marketplace_subscriptions')
-        .update({ status: subStatus, updated_at: new Date().toISOString() })
-        .eq('id', payRow.subscription_id)
-    }
-
-    await admin.from('asaas_webhook_events').update({ processed_at: new Date().toISOString() }).eq('id', inserted.id)
-    return NextResponse.json({ ok: true })
-  } catch (e: any) {
-    try {
-      await admin
-        .from('asaas_webhook_events')
-        .insert({
-          asaas_event_id: eventId,
-          event_type: eventType || null,
-          payment_id: paymentId,
-          payload: body,
-          processing_error: e?.message ?? String(e),
-          processed_at: new Date().toISOString(),
-        })
-    } catch {}
-
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/social/stories/create/route 2.ts b/_archive/duplicates/src/app/api/social/stories/create/route 2.ts
deleted file mode 100644
index d2a7a32..0000000
--- a/_archive/duplicates/src/app/api/social/stories/create/route 2.ts	
+++ /dev/null
@@ -1,50 +0,0 @@
-import { NextResponse } from 'next/server'
-import { requireUser } from '@/utils/auth/route'
-
-export const dynamic = 'force-dynamic'
-
-const isAllowedStoryPath = (userId: string, path: string) => {
-  const uid = String(userId || '').trim()
-  const p = String(path || '').trim()
-  if (!uid || !p) return false
-  if (p.includes('..') || p.includes('\\') || p.includes('\0') || p.startsWith('/')) return false
-  const parts = p.split('/').filter(Boolean)
-  if (parts.length < 3) return false
-  if (parts[0] !== uid) return false
-  if (parts[1] !== 'stories') return false
-  const name = parts.slice(2).join('/')
-  if (!name.endsWith('.jpg') && !name.endsWith('.jpeg') && !name.endsWith('.png')) return false
-  return true
-}
-
-export async function POST(req: Request) {
-  try {
-    const auth = await requireUser()
-    if (!auth.ok) return auth.response
-
-    const body = await req.json().catch(() => ({}))
-    const mediaPath = String(body?.mediaPath || body?.media_path || '').trim()
-    const caption = body?.caption != null ? String(body.caption).trim() : null
-    const meta = body?.meta && typeof body.meta === 'object' ? body.meta : {}
-
-    if (!mediaPath) return NextResponse.json({ ok: false, error: 'media_path required' }, { status: 400 })
-    if (!isAllowedStoryPath(auth.user.id, mediaPath)) return NextResponse.json({ ok: false, error: 'forbidden' }, { status: 403 })
-
-    const { data, error } = await auth.supabase
-      .from('social_stories')
-      .insert({
-        author_id: auth.user.id,
-        media_path: mediaPath,
-        caption,
-        meta,
-      })
-      .select('id, created_at, expires_at')
-      .maybeSingle()
-
-    if (error || !data?.id) return NextResponse.json({ ok: false, error: error?.message || 'failed' }, { status: 400 })
-    return NextResponse.json({ ok: true, data })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
-
diff --git a/_archive/duplicates/src/app/api/social/stories/delete/route 2.ts b/_archive/duplicates/src/app/api/social/stories/delete/route 2.ts
deleted file mode 100644
index 65329f2..0000000
--- a/_archive/duplicates/src/app/api/social/stories/delete/route 2.ts	
+++ /dev/null
@@ -1,46 +0,0 @@
-import { NextResponse } from 'next/server'
-import { requireUser } from '@/utils/auth/route'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-export async function POST(req: Request) {
-  try {
-    const auth = await requireUser()
-    if (!auth.ok) return auth.response
-
-    const body = await req.json().catch(() => ({}))
-    const storyId = String(body?.storyId || body?.story_id || '').trim()
-    if (!storyId) return NextResponse.json({ ok: false, error: 'story_id required' }, { status: 400 })
-
-    const admin = createAdminClient()
-
-    const { data: story, error: sErr } = await admin
-      .from('social_stories')
-      .select('id, author_id, media_path')
-      .eq('id', storyId)
-      .maybeSingle()
-
-    if (sErr) return NextResponse.json({ ok: false, error: sErr.message }, { status: 400 })
-    if (!story?.id) return NextResponse.json({ ok: false, error: 'not_found' }, { status: 404 })
-
-    const authorId = String(story.author_id || '').trim()
-    if (!authorId || authorId !== String(auth.user.id || '').trim()) {
-      return NextResponse.json({ ok: false, error: 'forbidden' }, { status: 403 })
-    }
-
-    const mediaPath = String(story.media_path || '').trim()
-    const { error: uErr } = await admin.from('social_stories').update({ is_deleted: true }).eq('id', storyId)
-    if (uErr) return NextResponse.json({ ok: false, error: uErr.message }, { status: 400 })
-
-    if (mediaPath) {
-      try {
-        await admin.storage.from('social-stories').remove([mediaPath])
-      } catch {}
-    }
-
-    return NextResponse.json({ ok: true })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/social/stories/delete/route 3.ts b/_archive/duplicates/src/app/api/social/stories/delete/route 3.ts
deleted file mode 100644
index 65329f2..0000000
--- a/_archive/duplicates/src/app/api/social/stories/delete/route 3.ts	
+++ /dev/null
@@ -1,46 +0,0 @@
-import { NextResponse } from 'next/server'
-import { requireUser } from '@/utils/auth/route'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-export async function POST(req: Request) {
-  try {
-    const auth = await requireUser()
-    if (!auth.ok) return auth.response
-
-    const body = await req.json().catch(() => ({}))
-    const storyId = String(body?.storyId || body?.story_id || '').trim()
-    if (!storyId) return NextResponse.json({ ok: false, error: 'story_id required' }, { status: 400 })
-
-    const admin = createAdminClient()
-
-    const { data: story, error: sErr } = await admin
-      .from('social_stories')
-      .select('id, author_id, media_path')
-      .eq('id', storyId)
-      .maybeSingle()
-
-    if (sErr) return NextResponse.json({ ok: false, error: sErr.message }, { status: 400 })
-    if (!story?.id) return NextResponse.json({ ok: false, error: 'not_found' }, { status: 404 })
-
-    const authorId = String(story.author_id || '').trim()
-    if (!authorId || authorId !== String(auth.user.id || '').trim()) {
-      return NextResponse.json({ ok: false, error: 'forbidden' }, { status: 403 })
-    }
-
-    const mediaPath = String(story.media_path || '').trim()
-    const { error: uErr } = await admin.from('social_stories').update({ is_deleted: true }).eq('id', storyId)
-    if (uErr) return NextResponse.json({ ok: false, error: uErr.message }, { status: 400 })
-
-    if (mediaPath) {
-      try {
-        await admin.storage.from('social-stories').remove([mediaPath])
-      } catch {}
-    }
-
-    return NextResponse.json({ ok: true })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/social/stories/list/route 2.ts b/_archive/duplicates/src/app/api/social/stories/list/route 2.ts
deleted file mode 100644
index 855ad00..0000000
--- a/_archive/duplicates/src/app/api/social/stories/list/route 2.ts	
+++ /dev/null
@@ -1,166 +0,0 @@
-import { NextResponse } from 'next/server'
-import { requireUser } from '@/utils/auth/route'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-type StoryRow = {
-  id: string
-  author_id: string
-  media_path: string
-  created_at: string
-  expires_at: string
-  caption: string | null
-}
-
-export async function GET(req: Request) {
-  try {
-    const auth = await requireUser()
-    if (!auth.ok) return auth.response
-
-    const url = new URL(req.url)
-    const limit = Math.min(300, Math.max(1, Number(url.searchParams.get('limit') || 200) || 200))
-    const signedSeconds = Math.min(3600, Math.max(60, Number(url.searchParams.get('signedSeconds') || 600) || 600))
-
-    const userId = String(auth.user.id || '').trim()
-    if (!userId) return NextResponse.json({ ok: false, error: 'unauthorized' }, { status: 401 })
-
-    const admin = createAdminClient()
-
-    const { data: follows, error: fErr } = await auth.supabase
-      .from('social_follows')
-      .select('following_id, status')
-      .eq('follower_id', userId)
-      .eq('status', 'accepted')
-
-    if (fErr) return NextResponse.json({ ok: false, error: fErr.message }, { status: 400 })
-
-    const followingIds = (Array.isArray(follows) ? follows : []).map((r: any) => String(r?.following_id || '').trim()).filter(Boolean)
-    const authorIds = Array.from(new Set([userId, ...followingIds]))
-    if (!authorIds.length) return NextResponse.json({ ok: true, data: [] })
-
-    const { data: storiesRaw, error: sErr } = await admin
-      .from('social_stories')
-      .select('id, author_id, media_path, created_at, expires_at, caption')
-      .in('author_id', authorIds)
-      .eq('is_deleted', false)
-      .gt('expires_at', new Date().toISOString())
-      .order('created_at', { ascending: false })
-      .limit(limit)
-
-    if (sErr) return NextResponse.json({ ok: false, error: sErr.message }, { status: 400 })
-    const stories = (Array.isArray(storiesRaw) ? (storiesRaw as any[]) : []) as StoryRow[]
-    const storyIds = stories.map((s) => s.id).filter(Boolean)
-
-    const viewedSet = new Set<string>()
-    if (storyIds.length) {
-      const { data: viewsRaw } = await admin.from('social_story_views').select('story_id').eq('viewer_id', userId).in('story_id', storyIds)
-      for (const r of Array.isArray(viewsRaw) ? (viewsRaw as any[]) : []) {
-        const sid = String((r as any)?.story_id || '').trim()
-        if (sid) viewedSet.add(sid)
-      }
-    }
-
-    const likeCountByStory = new Map<string, number>()
-    const likedSet = new Set<string>()
-    if (storyIds.length) {
-      const { data: likesRaw } = await admin.from('social_story_likes').select('story_id, user_id').in('story_id', storyIds)
-      const likes = Array.isArray(likesRaw) ? likesRaw : []
-      for (const r of likes as any[]) {
-        const sid = String(r?.story_id || '').trim()
-        const uid = String(r?.user_id || '').trim()
-        if (!sid) continue
-        likeCountByStory.set(sid, (likeCountByStory.get(sid) || 0) + 1)
-        if (uid && uid === userId) likedSet.add(sid)
-      }
-    }
-
-    const commentCountByStory = new Map<string, number>()
-    if (storyIds.length) {
-      const { data: commentsRaw } = await admin.from('social_story_comments').select('story_id').in('story_id', storyIds)
-      const comments = Array.isArray(commentsRaw) ? commentsRaw : []
-      for (const r of comments as any[]) {
-        const sid = String(r?.story_id || '').trim()
-        if (!sid) continue
-        commentCountByStory.set(sid, (commentCountByStory.get(sid) || 0) + 1)
-      }
-    }
-
-    const { data: profilesRaw } = await admin
-      .from('profiles')
-      .select('id, display_name, photo_url, role')
-      .in('id', authorIds)
-    const profilesArr = Array.isArray(profilesRaw) ? profilesRaw : []
-    const profileById = new Map<string, any>()
-    for (const p of profilesArr as any[]) {
-      const id = String(p?.id || '').trim()
-      if (!id) continue
-      profileById.set(id, p)
-    }
-
-    const bucket = 'social-stories'
-    const signedUrlByPath = new Map<string, string>()
-    const sign = async (path: string) => {
-      const p = String(path || '').trim()
-      if (!p) return null
-      const cached = signedUrlByPath.get(p)
-      if (cached) return cached
-      const { data, error } = await admin.storage.from(bucket).createSignedUrl(p, signedSeconds)
-      if (error || !data?.signedUrl) return null
-      signedUrlByPath.set(p, data.signedUrl)
-      return data.signedUrl
-    }
-
-    const byAuthor = new Map<string, any>()
-    for (const authorId of authorIds) {
-      const p = profileById.get(authorId) || null
-      byAuthor.set(authorId, {
-        authorId,
-        displayName: p?.display_name ?? null,
-        photoUrl: p?.photo_url ?? null,
-        role: p?.role ?? null,
-        stories: [],
-      })
-    }
-
-    for (const s of stories) {
-      const authorId = String(s.author_id || '').trim()
-      if (!authorId || !byAuthor.has(authorId)) continue
-      const urlSigned = await sign(s.media_path)
-      byAuthor.get(authorId).stories.push({
-        id: s.id,
-        createdAt: s.created_at,
-        expiresAt: s.expires_at,
-        caption: s.caption ?? null,
-        mediaUrl: urlSigned,
-        viewed: viewedSet.has(s.id),
-        likeCount: likeCountByStory.get(s.id) || 0,
-        hasLiked: likedSet.has(s.id),
-        commentCount: commentCountByStory.get(s.id) || 0,
-      })
-    }
-
-    const groups = Array.from(byAuthor.values())
-      .map((g) => {
-        const storiesArr = Array.isArray(g.stories) ? g.stories : []
-        return {
-          ...g,
-          hasStories: storiesArr.length > 0,
-          hasUnseen: storiesArr.some((st: any) => !st.viewed),
-          latestAt: storiesArr.length ? String(storiesArr[0]?.createdAt || '') : '',
-        }
-      })
-      .filter((g) => g.authorId === userId || g.hasStories)
-      .sort((a, b) => {
-        if (a.authorId === userId) return -1
-        if (b.authorId === userId) return 1
-        if (a.hasUnseen !== b.hasUnseen) return a.hasUnseen ? -1 : 1
-        if (a.hasStories !== b.hasStories) return a.hasStories ? -1 : 1
-        return String(b.latestAt).localeCompare(String(a.latestAt))
-      })
-
-    return NextResponse.json({ ok: true, data: groups })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/social/stories/media/route 2.ts b/_archive/duplicates/src/app/api/social/stories/media/route 2.ts
deleted file mode 100644
index cb5d278..0000000
--- a/_archive/duplicates/src/app/api/social/stories/media/route 2.ts	
+++ /dev/null
@@ -1,35 +0,0 @@
-import { NextResponse } from 'next/server'
-import { requireUser } from '@/utils/auth/route'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-export async function POST(req: Request) {
-  try {
-    const auth = await requireUser()
-    if (!auth.ok) return auth.response
-
-    const body = await req.json().catch(() => ({}))
-    const storyId = String(body?.storyId || body?.story_id || '').trim()
-    const signedSeconds = Math.min(3600, Math.max(60, Number(body?.signedSeconds || 600) || 600))
-    if (!storyId) return NextResponse.json({ ok: false, error: 'story_id required' }, { status: 400 })
-
-    const { data: story, error } = await auth.supabase
-      .from('social_stories')
-      .select('id, media_path')
-      .eq('id', storyId)
-      .maybeSingle()
-
-    if (error || !story?.media_path) return NextResponse.json({ ok: false, error: error?.message || 'not_found' }, { status: 404 })
-
-    const admin = createAdminClient()
-    const bucket = 'social-stories'
-    const { data, error: sErr } = await admin.storage.from(bucket).createSignedUrl(String(story.media_path), signedSeconds)
-    if (sErr || !data?.signedUrl) return NextResponse.json({ ok: false, error: sErr?.message || 'failed' }, { status: 400 })
-
-    return NextResponse.json({ ok: true, url: data.signedUrl })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
-
diff --git a/_archive/duplicates/src/app/api/supabase/status/route 2.ts b/_archive/duplicates/src/app/api/supabase/status/route 2.ts
deleted file mode 100644
index 810d682..0000000
--- a/_archive/duplicates/src/app/api/supabase/status/route 2.ts	
+++ /dev/null
@@ -1,44 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createClient } from '@/utils/supabase/server'
-import { cookies } from 'next/headers'
-import { hasValidInternalSecret, requireRole } from '@/utils/auth/route'
-
-export async function GET(req: Request) {
-  const hasUrl = !!process.env.NEXT_PUBLIC_SUPABASE_URL
-  const hasAnon = !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  const isDev = process.env.NODE_ENV === 'development'
-  const isInternal = hasValidInternalSecret(req)
-  if (!isInternal && !isDev) {
-    const auth = await requireRole(['admin'])
-    if (!auth.ok) return auth.response
-  }
-
-  try {
-    const supabase = await createClient()
-    const { data, error } = await supabase.auth.getUser()
-    if (error) {
-      return NextResponse.json(
-        { ok: false, hasUrl, hasAnon, error: error.message || 'unauthorized' },
-        { status: 401 }
-      )
-    }
-    if (isInternal || isDev) {
-      const cookieStore = await cookies()
-      const cookieNames = (cookieStore.getAll() || []).map((c) => c?.name).filter(Boolean).sort()
-      return NextResponse.json({
-        ok: true,
-        hasUrl,
-        hasAnon,
-        cookieNames,
-        userId: data?.user?.id ?? null,
-        userEmail: data?.user?.email ?? null,
-      })
-    }
-    return NextResponse.json({ ok: true, hasUrl, hasAnon })
-  } catch (e: any) {
-    return NextResponse.json(
-      { ok: false, hasUrl, hasAnon, error: e?.message ?? String(e) },
-      { status: 500 }
-    )
-  }
-}
diff --git a/_archive/duplicates/src/app/api/workouts/finish/route 2.ts b/_archive/duplicates/src/app/api/workouts/finish/route 2.ts
deleted file mode 100644
index 5d29487..0000000
--- a/_archive/duplicates/src/app/api/workouts/finish/route 2.ts	
+++ /dev/null
@@ -1,310 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createClient } from '@/utils/supabase/server'
-import { normalizeWorkoutTitle } from '@/utils/workoutTitle'
-import { createAdminClient } from '@/utils/supabase/admin'
-import { filterRecipientsByPreference, insertNotifications, listFollowerIdsOf, shouldThrottleBySenderType } from '@/lib/social/notifyFollowers'
-
-const parseTrainingNumberOrZero = (v: any) => {
-  const n = typeof v === 'number' ? v : Number(String(v || '').replace(',', '.'))
-  return Number.isFinite(n) ? n : 0
-}
-
-const getExercisePlannedSetsCount = (ex: any) => {
-  try {
-    const bySets = Math.max(0, Number(ex?.sets) || 0)
-    const byDetails = Array.isArray(ex?.setDetails) ? ex.setDetails.length : Array.isArray(ex?.set_details) ? ex.set_details.length : 0
-    return Math.max(bySets, byDetails)
-  } catch {
-    return 0
-  }
-}
-
-const buildBestByExerciseFromSession = (session: any, onlyNames?: Set<string>) => {
-  const base = session && typeof session === 'object' ? session : null
-  const logs = base?.logs && typeof base.logs === 'object' ? base.logs : {}
-  const exercises = Array.isArray(base?.exercises) ? base.exercises : []
-  const out = new Map<string, { weight: number; reps: number; volume: number }>()
-
-  exercises.forEach((ex: any, exIdx: number) => {
-    const name = String(ex?.name || '').trim()
-    if (!name) return
-    if (onlyNames && !onlyNames.has(name)) return
-
-    const setsCount = getExercisePlannedSetsCount(ex)
-    let bestWeight = 0
-    let bestReps = 0
-    let bestVolume = 0
-
-    for (let setIdx = 0; setIdx < setsCount; setIdx += 1) {
-      const key = `${exIdx}-${setIdx}`
-      const log = (logs as any)?.[key]
-      if (!log || typeof log !== 'object') continue
-      if (!log?.done) continue
-      const weight = parseTrainingNumberOrZero(log?.weight)
-      const reps = parseTrainingNumberOrZero(log?.reps)
-      if (Number.isFinite(weight) && weight > bestWeight) bestWeight = weight
-      if (Number.isFinite(reps) && reps > bestReps) bestReps = reps
-      const vol = weight * reps
-      if (Number.isFinite(vol) && vol > bestVolume) bestVolume = vol
-    }
-
-    const prev = out.get(name) || { weight: 0, reps: 0, volume: 0 }
-    out.set(name, {
-      weight: Math.max(prev.weight, bestWeight),
-      reps: Math.max(prev.reps, bestReps),
-      volume: Math.max(prev.volume, bestVolume),
-    })
-  })
-
-  return out
-}
-
-const computeWorkoutStreak = (dateRows: any[]) => {
-  const rows = Array.isArray(dateRows) ? dateRows : []
-  const daySet = new Set<string>()
-  rows.forEach((r) => {
-    try {
-      const d = r?.date ? new Date(r.date) : null
-      if (!d || Number.isNaN(d.getTime())) return
-      const day = d.toISOString().slice(0, 10)
-      daySet.add(day)
-    } catch {}
-  })
-  if (!daySet.size) return 0
-
-  const sorted = Array.from(daySet).sort().reverse()
-  const start = sorted[0]
-  let cursor = new Date(`${start}T00:00:00.000Z`)
-  let streak = 0
-
-  while (true) {
-    const key = cursor.toISOString().slice(0, 10)
-    if (!daySet.has(key)) break
-    streak += 1
-    cursor = new Date(cursor.getTime() - 24 * 60 * 60 * 1000)
-  }
-  return streak
-}
-
-export async function POST(request: Request) {
-  try {
-    const supabase = await createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-
-    if (!user) return NextResponse.json({ ok: false, error: 'unauthorized' }, { status: 401 })
-
-    const body = await request.json().catch(() => ({}))
-    const session = body && typeof body === 'object' ? body.session ?? body : null
-    if (!session) return NextResponse.json({ ok: false, error: 'missing session' }, { status: 400 })
-
-    const { data, error } = await supabase
-      .from('workouts')
-      .insert({
-        user_id: user.id,
-        created_by: user.id,
-        name: normalizeWorkoutTitle(session.workoutTitle || 'Treino Realizado'),
-        date: new Date(session?.date ?? new Date()),
-        completed_at: new Date().toISOString(),
-        is_template: false,
-        notes: JSON.stringify(session),
-      })
-      .select('id, created_at')
-      .single()
-
-    if (error) return NextResponse.json({ ok: false, error: error.message }, { status: 400 })
-
-    try {
-      await supabase.from('active_workout_sessions').delete().eq('user_id', user.id)
-    } catch {}
-
-    try {
-      const admin = createAdminClient()
-      const { data: me } = await admin.from('profiles').select('display_name').eq('id', user.id).maybeSingle()
-      const name = String(me?.display_name || '').trim() || 'Seu amigo'
-
-      const followerIds = await listFollowerIdsOf(user.id)
-      const workoutTitle = normalizeWorkoutTitle(session.workoutTitle || 'Treino')
-
-      const workoutRecipients = await filterRecipientsByPreference(followerIds, 'notifyFriendWorkoutEvents')
-      if (workoutRecipients.length) {
-        await insertNotifications(
-          workoutRecipients.map((rid) => ({
-            user_id: rid,
-            recipient_id: rid,
-            sender_id: user.id,
-            type: 'workout_finish',
-            title: 'Treino finalizado',
-            message: `${name} terminou um treino: ${workoutTitle}.`,
-            read: false,
-            is_read: false,
-            metadata: { workout_id: data?.id ?? null, workout_title: workoutTitle, sender_id: user.id },
-          })),
-        )
-      }
-
-      const streakMilestones = new Set([3, 7, 14, 30, 60, 100])
-      const goalMilestones = new Set([10, 25, 50, 100, 200, 500])
-
-      try {
-        const throttleStreak = await shouldThrottleBySenderType(user.id, 'friend_streak', 12 * 60)
-        if (!throttleStreak) {
-          const { data: dates } = await admin
-            .from('workouts')
-            .select('date')
-            .eq('user_id', user.id)
-            .eq('is_template', false)
-            .order('date', { ascending: false })
-            .limit(370)
-          const streak = computeWorkoutStreak(Array.isArray(dates) ? dates : [])
-          if (streak > 0 && streakMilestones.has(streak)) {
-            const recipients = await filterRecipientsByPreference(followerIds, 'notifyFriendStreaks')
-            if (recipients.length) {
-              await insertNotifications(
-                recipients.map((rid) => ({
-                  user_id: rid,
-                  recipient_id: rid,
-                  sender_id: user.id,
-                  type: 'friend_streak',
-                  title: 'Streak de treino',
-                  message: `${name} completou ${streak} dia(s) seguidos treinando.`,
-                  read: false,
-                  is_read: false,
-                  metadata: { streak, sender_id: user.id },
-                })),
-              )
-            }
-          }
-        }
-      } catch {}
-
-      try {
-        const throttleGoals = await shouldThrottleBySenderType(user.id, 'friend_goal', 12 * 60)
-        if (!throttleGoals) {
-          const { count } = await admin
-            .from('workouts')
-            .select('id', { count: 'exact', head: true })
-            .eq('user_id', user.id)
-            .eq('is_template', false)
-          const total = Number(count || 0)
-          if (total > 0 && goalMilestones.has(total)) {
-            const recipients = await filterRecipientsByPreference(followerIds, 'notifyFriendGoals')
-            if (recipients.length) {
-              await insertNotifications(
-                recipients.map((rid) => ({
-                  user_id: rid,
-                  recipient_id: rid,
-                  sender_id: user.id,
-                  type: 'friend_goal',
-                  title: 'Marco atingido',
-                  message: `${name} completou ${total} treinos no histórico.`,
-                  read: false,
-                  is_read: false,
-                  metadata: { total_workouts: total, sender_id: user.id },
-                })),
-              )
-            }
-          }
-        }
-      } catch {}
-
-      try {
-        const throttlePr = await shouldThrottleBySenderType(user.id, 'friend_pr', 60)
-        if (!throttlePr) {
-          const currentBest = buildBestByExerciseFromSession(session)
-          if (currentBest.size) {
-            const onlyNames = new Set(Array.from(currentBest.keys()))
-            const { data: history } = await admin
-              .from('workouts')
-              .select('id, notes')
-              .eq('user_id', user.id)
-              .eq('is_template', false)
-              .order('created_at', { ascending: false })
-              .limit(160)
-            const rows = Array.isArray(history) ? history : []
-            const historyBest = new Map<string, { weight: number; reps: number; volume: number }>()
-            for (const row of rows) {
-              try {
-                if (row?.id && data?.id && String(row.id) === String(data.id)) continue
-                let sess: any = null
-                if (typeof row?.notes === 'string') sess = JSON.parse(row.notes)
-                else if (row?.notes && typeof row.notes === 'object') sess = row.notes
-                if (!sess || typeof sess !== 'object') continue
-                const best = buildBestByExerciseFromSession(sess, onlyNames)
-                best.forEach((v, exName) => {
-                  const prev = historyBest.get(exName) || { weight: 0, reps: 0, volume: 0 }
-                  historyBest.set(exName, {
-                    weight: Math.max(prev.weight, v.weight),
-                    reps: Math.max(prev.reps, v.reps),
-                    volume: Math.max(prev.volume, v.volume),
-                  })
-                })
-              } catch {}
-            }
-
-            const prs: { exercise: string; label: string; value: string; score: number }[] = []
-            currentBest.forEach((cur, exName) => {
-              const hist = historyBest.get(exName) || { weight: 0, reps: 0, volume: 0 }
-              const volumePr = cur.volume > 0 && cur.volume > hist.volume
-              const weightPr = cur.weight > 0 && cur.weight > hist.weight
-              const repsPr = cur.reps > 0 && cur.reps > hist.reps
-              if (!volumePr && !weightPr && !repsPr) return
-              if (volumePr) {
-                prs.push({
-                  exercise: exName,
-                  label: 'Volume',
-                  value: `${cur.volume.toLocaleString('pt-BR')}kg`,
-                  score: cur.volume,
-                })
-                return
-              }
-              if (weightPr) {
-                prs.push({
-                  exercise: exName,
-                  label: 'Carga',
-                  value: `${cur.weight.toLocaleString('pt-BR')}kg`,
-                  score: cur.weight,
-                })
-                return
-              }
-              prs.push({
-                exercise: exName,
-                label: 'Reps',
-                value: `${Math.round(cur.reps)} reps`,
-                score: cur.reps,
-              })
-            })
-
-            prs.sort((a, b) => b.score - a.score)
-            const top = prs.slice(0, 3)
-            if (top.length) {
-              const recipients = await filterRecipientsByPreference(followerIds, 'notifyFriendPRs')
-              if (recipients.length) {
-                const summary = top.map((p) => `${p.exercise}: ${p.label} ${p.value}`).join(' • ')
-                await insertNotifications(
-                  recipients.map((rid) => ({
-                    user_id: rid,
-                    recipient_id: rid,
-                    sender_id: user.id,
-                    type: 'friend_pr',
-                    title: 'PR batido',
-                    message: `${name} bateu PR: ${summary}.`,
-                    read: false,
-                    is_read: false,
-                    metadata: { prs: top, workout_id: data?.id ?? null, sender_id: user.id },
-                  })),
-                )
-              }
-            }
-          }
-        }
-      } catch {}
-    } catch {}
-
-    return NextResponse.json({ ok: true, saved: data })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
-
diff --git a/_archive/duplicates/src/app/api/workouts/finish/route 3.ts b/_archive/duplicates/src/app/api/workouts/finish/route 3.ts
deleted file mode 100644
index b6d4de6..0000000
--- a/_archive/duplicates/src/app/api/workouts/finish/route 3.ts	
+++ /dev/null
@@ -1,427 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createClient } from '@/utils/supabase/server'
-import { normalizeWorkoutTitle } from '@/utils/workoutTitle'
-import { createAdminClient } from '@/utils/supabase/admin'
-import { filterRecipientsByPreference, insertNotifications, listFollowerIdsOf, shouldThrottleBySenderType } from '@/lib/social/notifyFollowers'
-
-const parseTrainingNumberOrZero = (v: any) => {
-  const n = typeof v === 'number' ? v : Number(String(v || '').replace(',', '.'))
-  return Number.isFinite(n) ? n : 0
-}
-
-const normalizeExerciseKey = (v: any) => {
-  try {
-    return String(v ?? '')
-      .trim()
-      .toLowerCase()
-      .normalize('NFD')
-      .replace(/[\u0300-\u036f]/g, '')
-      .replace(/\s+/g, ' ')
-  } catch {
-    return String(v ?? '').trim().toLowerCase().replace(/\s+/g, ' ')
-  }
-}
-
-const getExercisePlannedSetsCount = (ex: any) => {
-  try {
-    const bySets = Math.max(0, Number(ex?.sets) || 0)
-    const byDetails = Array.isArray(ex?.setDetails) ? ex.setDetails.length : Array.isArray(ex?.set_details) ? ex.set_details.length : 0
-    return Math.max(bySets, byDetails)
-  } catch {
-    return 0
-  }
-}
-
-const buildBestByExerciseFromSession = (session: any, onlyNames?: Set<string>) => {
-  const base = session && typeof session === 'object' ? session : null
-  const logs = base?.logs && typeof base.logs === 'object' ? base.logs : {}
-  const exercises = Array.isArray(base?.exercises) ? base.exercises : []
-  const out = new Map<string, { exercise: string; weight: number; reps: number; volume: number }>()
-
-  exercises.forEach((ex: any, exIdx: number) => {
-    const name = String(ex?.name || '').trim()
-    if (!name) return
-    const norm = normalizeExerciseKey(name)
-    if (!norm) return
-    if (onlyNames && !onlyNames.has(norm)) return
-
-    const setsCount = getExercisePlannedSetsCount(ex)
-    let bestWeight = 0
-    let bestReps = 0
-    let bestVolume = 0
-
-    for (let setIdx = 0; setIdx < setsCount; setIdx += 1) {
-      const key = `${exIdx}-${setIdx}`
-      const log = (logs as any)?.[key]
-      if (!log || typeof log !== 'object') continue
-      if (!log?.done) continue
-      const weight = parseTrainingNumberOrZero(log?.weight)
-      const reps = parseTrainingNumberOrZero(log?.reps)
-      if (Number.isFinite(weight) && weight > bestWeight) bestWeight = weight
-      if (Number.isFinite(reps) && reps > bestReps) bestReps = reps
-      const vol = weight * reps
-      if (Number.isFinite(vol) && vol > bestVolume) bestVolume = vol
-    }
-
-    const prev = out.get(norm) || { exercise: name, weight: 0, reps: 0, volume: 0 }
-    out.set(norm, {
-      exercise: prev.exercise || name,
-      weight: Math.max(prev.weight, bestWeight),
-      reps: Math.max(prev.reps, bestReps),
-      volume: Math.max(prev.volume, bestVolume),
-    })
-  })
-
-  return out
-}
-
-const computeWorkoutStreak = (dateRows: any[]) => {
-  const rows = Array.isArray(dateRows) ? dateRows : []
-  const daySet = new Set<string>()
-  rows.forEach((r) => {
-    try {
-      const d = r?.date ? new Date(r.date) : null
-      if (!d || Number.isNaN(d.getTime())) return
-      const day = d.toISOString().slice(0, 10)
-      daySet.add(day)
-    } catch {}
-  })
-  if (!daySet.size) return 0
-
-  const sorted = Array.from(daySet).sort().reverse()
-  const start = sorted[0]
-  let cursor = new Date(`${start}T00:00:00.000Z`)
-  let streak = 0
-
-  while (true) {
-    const key = cursor.toISOString().slice(0, 10)
-    if (!daySet.has(key)) break
-    streak += 1
-    cursor = new Date(cursor.getTime() - 24 * 60 * 60 * 1000)
-  }
-  return streak
-}
-
-export async function POST(request: Request) {
-  try {
-    const supabase = await createClient()
-    const {
-      data: { user },
-    } = await supabase.auth.getUser()
-
-    if (!user) return NextResponse.json({ ok: false, error: 'unauthorized' }, { status: 401 })
-
-    const body = await request.json()
-    const session = body?.session
-    if (!session) return NextResponse.json({ ok: false, error: 'missing session' }, { status: 400 })
-
-    const idempotencyKeyRaw = body?.idempotencyKey ?? body?.idempotency_key ?? session?.idempotencyKey ?? session?.idempotency_key
-    const idempotencyKey = typeof idempotencyKeyRaw === 'string' ? idempotencyKeyRaw.trim() : String(idempotencyKeyRaw ?? '').trim()
-
-    if (idempotencyKey) {
-      try {
-        const { data: existing } = await supabase
-          .from('workouts')
-          .select('id, created_at')
-          .eq('user_id', user.id)
-          .eq('idempotency_key', idempotencyKey)
-          .maybeSingle()
-
-        if (existing?.id) {
-          return NextResponse.json({ ok: true, saved: existing, idempotent: true })
-        }
-      } catch {
-        // If idempotency check fails (e.g. migration not applied yet), continue without blocking.
-      }
-    }
-
-    const { data, error } = await supabase
-      .from('workouts')
-      .insert({
-        user_id: user.id,
-        created_by: user.id,
-        idempotency_key: idempotencyKey || null,
-        name: normalizeWorkoutTitle(session.workoutTitle || 'Treino Realizado'),
-        date: new Date(session?.date ?? new Date()),
-        completed_at: new Date().toISOString(),
-        is_template: false,
-        notes: JSON.stringify(session),
-      })
-      .select('id, created_at')
-      .single()
-
-    if (error) {
-      const isDuplicate = (error as any)?.code === '23505' || /duplicate key value/i.test(String(error?.message || ''))
-
-      if (isDuplicate && idempotencyKey) {
-        try {
-          const { data: existing } = await supabase
-            .from('workouts')
-            .select('id, created_at')
-            .eq('user_id', user.id)
-            .eq('idempotency_key', idempotencyKey)
-            .maybeSingle()
-
-          if (existing?.id) {
-            return NextResponse.json({ ok: true, saved: existing, idempotent: true })
-          }
-        } catch {}
-      }
-
-      return NextResponse.json({ ok: false, error: error.message }, { status: 400 })
-    }
-
-    try {
-      const originWorkoutId = session?.originWorkoutId ? String(session.originWorkoutId) : ''
-      if (originWorkoutId) {
-        const baseMs = (() => {
-          try {
-            const d = session?.date ? new Date(session.date) : null
-            const ms = d && !Number.isNaN(d.getTime()) ? d.getTime() : Date.now()
-            return ms
-          } catch {
-            return Date.now()
-          }
-        })()
-        const windowStartIso = new Date(baseMs - 12 * 60 * 60 * 1000).toISOString()
-        const windowEndIso = new Date(baseMs + 2 * 60 * 60 * 1000).toISOString()
-
-        const { data: latestPre, error: preError } = await supabase
-          .from('workout_checkins')
-          .select('id')
-          .eq('user_id', user.id)
-          .eq('kind', 'pre')
-          .eq('planned_workout_id', originWorkoutId)
-          .gte('created_at', windowStartIso)
-          .lte('created_at', windowEndIso)
-          .order('created_at', { ascending: false })
-          .limit(1)
-          .maybeSingle()
-        if (preError) throw preError
-        if (latestPre?.id) {
-          const { error: updError } = await supabase
-            .from('workout_checkins')
-            .update({ workout_id: data?.id ?? null, active_session_user_id: null })
-            .eq('id', latestPre.id)
-          if (updError) throw updError
-        }
-      }
-    } catch (e: any) {
-      console.warn('Falha ao vincular check-in pré ao treino salvo:', e?.message || String(e || ''))
-    }
-
-    try {
-      const raw = session?.postCheckin
-      const pc = raw && typeof raw === 'object' ? raw : null
-      if (pc) {
-        const sorenessN = parseTrainingNumberOrZero((pc as any)?.soreness)
-        const satisfactionN = parseTrainingNumberOrZero((pc as any)?.satisfaction)
-        const rpeN = parseTrainingNumberOrZero((pc as any)?.rpe)
-        const notesRaw = String((pc as any)?.notes || '').trim()
-
-        const { error: checkinError } = await supabase.from('workout_checkins').insert({
-          user_id: user.id,
-          kind: 'post',
-          workout_id: data?.id ?? null,
-          planned_workout_id: session?.originWorkoutId ?? null,
-          soreness: Number.isFinite(sorenessN) && sorenessN >= 0 && sorenessN <= 10 ? Math.round(sorenessN) : null,
-          mood: Number.isFinite(satisfactionN) && satisfactionN >= 1 && satisfactionN <= 5 ? Math.round(satisfactionN) : null,
-          notes: notesRaw ? notesRaw : null,
-          answers: {
-            rpe: Number.isFinite(rpeN) && rpeN >= 1 && rpeN <= 10 ? Math.round(rpeN) : null,
-          },
-        })
-        if (checkinError) throw checkinError
-      }
-    } catch (e: any) {
-      console.warn('Falha ao salvar check-in pós-treino:', e?.message || String(e || ''))
-    }
-
-    try {
-      await supabase.from('active_workout_sessions').delete().eq('user_id', user.id)
-    } catch {}
-
-    try {
-      const admin = createAdminClient()
-      const { data: me } = await admin.from('profiles').select('display_name').eq('id', user.id).maybeSingle()
-      const name = String(me?.display_name || '').trim() || 'Seu amigo'
-
-      const followerIds = await listFollowerIdsOf(user.id)
-      const workoutTitle = normalizeWorkoutTitle(session.workoutTitle || 'Treino')
-
-      const workoutRecipients = await filterRecipientsByPreference(followerIds, 'notifyFriendWorkoutEvents')
-      if (workoutRecipients.length) {
-        await insertNotifications(
-          workoutRecipients.map((rid) => ({
-            user_id: rid,
-            recipient_id: rid,
-            sender_id: user.id,
-            type: 'workout_finish',
-            title: 'Treino finalizado',
-            message: `${name} terminou um treino: ${workoutTitle}.`,
-            read: false,
-            is_read: false,
-            metadata: { workout_id: data?.id ?? null, workout_title: workoutTitle, sender_id: user.id },
-          }))
-        )
-      }
-
-      const streakMilestones = new Set([3, 7, 14, 30, 60, 100])
-      const goalMilestones = new Set([10, 25, 50, 100, 200, 500])
-
-      try {
-        const throttleStreak = await shouldThrottleBySenderType(user.id, 'friend_streak', 12 * 60)
-        if (!throttleStreak) {
-          const { data: dates } = await admin
-            .from('workouts')
-            .select('date')
-            .eq('user_id', user.id)
-            .eq('is_template', false)
-            .order('date', { ascending: false })
-            .limit(370)
-          const streak = computeWorkoutStreak(Array.isArray(dates) ? dates : [])
-          if (streak > 0 && streakMilestones.has(streak)) {
-            const recipients = await filterRecipientsByPreference(followerIds, 'notifyFriendStreaks')
-            if (recipients.length) {
-              await insertNotifications(
-                recipients.map((rid) => ({
-                  user_id: rid,
-                  recipient_id: rid,
-                  sender_id: user.id,
-                  type: 'friend_streak',
-                  title: 'Streak de treino',
-                  message: `${name} completou ${streak} dia(s) seguidos treinando.`,
-                  read: false,
-                  is_read: false,
-                  metadata: { streak, sender_id: user.id },
-                }))
-              )
-            }
-          }
-        }
-      } catch {}
-
-      try {
-        const throttleGoals = await shouldThrottleBySenderType(user.id, 'friend_goal', 12 * 60)
-        if (!throttleGoals) {
-          const { count } = await admin
-            .from('workouts')
-            .select('id', { count: 'exact', head: true })
-            .eq('user_id', user.id)
-            .eq('is_template', false)
-          const total = Number(count || 0)
-          if (total > 0 && goalMilestones.has(total)) {
-            const recipients = await filterRecipientsByPreference(followerIds, 'notifyFriendGoals')
-            if (recipients.length) {
-              await insertNotifications(
-                recipients.map((rid) => ({
-                  user_id: rid,
-                  recipient_id: rid,
-                  sender_id: user.id,
-                  type: 'friend_goal',
-                  title: 'Marco atingido',
-                  message: `${name} completou ${total} treinos no histórico.`,
-                  read: false,
-                  is_read: false,
-                  metadata: { total_workouts: total, sender_id: user.id },
-                }))
-              )
-            }
-          }
-        }
-      } catch {}
-
-      try {
-        const throttlePr = await shouldThrottleBySenderType(user.id, 'friend_pr', 60)
-        if (!throttlePr) {
-          const currentBest = buildBestByExerciseFromSession(session)
-          if (currentBest.size) {
-            const onlyNames = new Set(Array.from(currentBest.keys()))
-            const { data: history } = await admin
-              .from('workouts')
-              .select('id, notes')
-              .eq('user_id', user.id)
-              .eq('is_template', false)
-              .order('created_at', { ascending: false })
-              .limit(160)
-            const rows = Array.isArray(history) ? history : []
-            const historyBest = new Map<string, { weight: number; reps: number; volume: number }>()
-            for (const row of rows) {
-              try {
-                if (row?.id && data?.id && String(row.id) === String(data.id)) continue
-                let sess: any = null
-                if (typeof row?.notes === 'string') sess = JSON.parse(row.notes)
-                else if (row?.notes && typeof row.notes === 'object') sess = row.notes
-                if (!sess || typeof sess !== 'object') continue
-                const best = buildBestByExerciseFromSession(sess, onlyNames)
-                best.forEach((v, key) => {
-                  const prev = historyBest.get(key) || { weight: 0, reps: 0, volume: 0 }
-                  historyBest.set(key, { weight: Math.max(prev.weight, v.weight), reps: Math.max(prev.reps, v.reps), volume: Math.max(prev.volume, v.volume) })
-                })
-              } catch {}
-            }
-
-            const prs: { exercise: string; label: string; value: string; score: number }[] = []
-            currentBest.forEach((cur, key) => {
-              const hist = historyBest.get(key) || { weight: 0, reps: 0, volume: 0 }
-              const volumePr = cur.volume > 0 && cur.volume > hist.volume
-              const weightPr = cur.weight > 0 && cur.weight > hist.weight
-              const repsPr = cur.reps > 0 && cur.reps > hist.reps
-              if (!volumePr && !weightPr && !repsPr) return
-              if (volumePr) {
-                prs.push({
-                  exercise: cur.exercise,
-                  label: 'Volume',
-                  value: `${cur.volume.toLocaleString('pt-BR')}kg`,
-                  score: cur.volume,
-                })
-                return
-              }
-              if (weightPr) {
-                prs.push({
-                  exercise: cur.exercise,
-                  label: 'Carga',
-                  value: `${cur.weight.toLocaleString('pt-BR')}kg`,
-                  score: cur.weight,
-                })
-                return
-              }
-              prs.push({
-                exercise: cur.exercise,
-                label: 'Reps',
-                value: `${Math.round(cur.reps)} reps`,
-                score: cur.reps,
-              })
-            })
-
-            prs.sort((a, b) => b.score - a.score)
-            const top = prs.slice(0, 3)
-            if (top.length) {
-              const recipients = await filterRecipientsByPreference(followerIds, 'notifyFriendPRs')
-              if (recipients.length) {
-                const summary = top.map((p) => `${p.exercise}: ${p.label} ${p.value}`).join(' • ')
-                await insertNotifications(
-                  recipients.map((rid) => ({
-                    user_id: rid,
-                    recipient_id: rid,
-                    sender_id: user.id,
-                    type: 'friend_pr',
-                    title: 'PR batido',
-                    message: `${name} bateu PR: ${summary}.`,
-                    read: false,
-                    is_read: false,
-                    metadata: { prs: top, workout_id: data?.id ?? null, sender_id: user.id },
-                  }))
-                )
-              }
-            }
-          }
-        }
-      } catch {}
-    } catch {}
-
-    return NextResponse.json({ ok: true, saved: data })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/workouts/list/route 2.ts b/_archive/duplicates/src/app/api/workouts/list/route 2.ts
deleted file mode 100644
index 3bf4a04..0000000
--- a/_archive/duplicates/src/app/api/workouts/list/route 2.ts	
+++ /dev/null
@@ -1,36 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createClient } from '@/utils/supabase/server'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-const ADMIN_EMAIL = 'djmkapple@gmail.com'
-
-export async function GET() {
-  try {
-    const supabase = await createClient()
-    const { data: { user } } = await supabase.auth.getUser()
-    if (!user) return NextResponse.json({ ok: false, error: 'unauthorized' }, { status: 401 })
-
-    // const isAdmin = user.email === ADMIN_EMAIL // Not used for filtering anymore
-    const admin = createAdminClient()
-
-    // Always filter by athlete_uuid = user.id to get "My Workouts" (legacy)
-    // regardless of admin status, as this endpoint is for the personal dashboard.
-    let query = admin
-      .from('workouts')
-      .select('id, name, user_id')
-      .eq('user_id', user.id)
-      .eq('is_template', true)
-      .is('student_id', null)
-      .order('name')
-
-    const { data, error } = await query
-    if (error) return NextResponse.json({ ok: false, error: error.message }, { status: 400 })
-
-    const rows = data || []
-    return NextResponse.json({ ok: true, rows })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/api/workouts/list/route 3.ts b/_archive/duplicates/src/app/api/workouts/list/route 3.ts
deleted file mode 100644
index 3bf4a04..0000000
--- a/_archive/duplicates/src/app/api/workouts/list/route 3.ts	
+++ /dev/null
@@ -1,36 +0,0 @@
-import { NextResponse } from 'next/server'
-import { createClient } from '@/utils/supabase/server'
-import { createAdminClient } from '@/utils/supabase/admin'
-
-export const dynamic = 'force-dynamic'
-
-const ADMIN_EMAIL = 'djmkapple@gmail.com'
-
-export async function GET() {
-  try {
-    const supabase = await createClient()
-    const { data: { user } } = await supabase.auth.getUser()
-    if (!user) return NextResponse.json({ ok: false, error: 'unauthorized' }, { status: 401 })
-
-    // const isAdmin = user.email === ADMIN_EMAIL // Not used for filtering anymore
-    const admin = createAdminClient()
-
-    // Always filter by athlete_uuid = user.id to get "My Workouts" (legacy)
-    // regardless of admin status, as this endpoint is for the personal dashboard.
-    let query = admin
-      .from('workouts')
-      .select('id, name, user_id')
-      .eq('user_id', user.id)
-      .eq('is_template', true)
-      .is('student_id', null)
-      .order('name')
-
-    const { data, error } = await query
-    if (error) return NextResponse.json({ ok: false, error: error.message }, { status: 400 })
-
-    const rows = data || []
-    return NextResponse.json({ ok: true, rows })
-  } catch (e: any) {
-    return NextResponse.json({ ok: false, error: e?.message ?? String(e) }, { status: 500 })
-  }
-}
diff --git a/_archive/duplicates/src/app/auth/callback/route 2.js b/_archive/duplicates/src/app/auth/callback/route 2.js
deleted file mode 100644
index 33106cb..0000000
--- a/_archive/duplicates/src/app/auth/callback/route 2.js	
+++ /dev/null
@@ -1,97 +0,0 @@
-import { createServerClient } from '@supabase/ssr'
-import { NextResponse } from 'next/server'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export const dynamic = 'force-dynamic'
-export const runtime = 'nodejs'
-
-export async function GET(request) {
-  const { searchParams } = new URL(request.url)
-  const code = searchParams.get('code')
-  const next = searchParams.get('next') ?? ''
-  const errorParam = searchParams.get('error')
-  const errorDescription = searchParams.get('error_description')
-  const nextCookieName = 'it.auth.next'
-  const setCookieNames = []
-
-  const originFromUrl = new URL(request.url).origin
-  const forwardedHost = request.headers.get('x-forwarded-host')
-  const forwardedProto = request.headers.get('x-forwarded-proto') || 'https'
-  const isLocalEnv = process.env.NODE_ENV === 'development'
-  const baseOrigin = forwardedHost && !isLocalEnv ? `${forwardedProto}://${forwardedHost}` : originFromUrl
-  let safeOrigin = isLocalEnv && baseOrigin.includes('0.0.0.0') ? baseOrigin.replace('0.0.0.0', 'localhost') : baseOrigin
-  if (!isLocalEnv) {
-    try {
-      const u = new URL(safeOrigin)
-      u.protocol = 'https:'
-      safeOrigin = u.origin
-    } catch {}
-  }
-
-  const rawError = String(errorDescription || errorParam || '').trim()
-  if (rawError && !code) {
-    return NextResponse.redirect(new URL(`/auth/error?error=${encodeURIComponent(rawError)}`, safeOrigin))
-  }
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    return NextResponse.redirect(new URL('/auth/error?error=missing_env', safeOrigin))
-  }
-
-  let nextFromCookie = ''
-  try {
-    nextFromCookie = String(request.cookies.get(nextCookieName)?.value || '')
-  } catch {}
-  const rawNext = String(next || '')
-  const fallbackNext = nextFromCookie || '/dashboard'
-  const safeNext = rawNext.startsWith('/') ? rawNext : fallbackNext.startsWith('/') ? fallbackNext : '/dashboard'
-  const redirectUrl = new URL(safeNext, safeOrigin)
-
-  let response = NextResponse.redirect(redirectUrl)
-  try {
-    response.cookies.set(nextCookieName, '', { path: '/', maxAge: 0 })
-  } catch {}
-
-  if (!code) {
-    return NextResponse.redirect(new URL('/auth/error?error=missing_code', safeOrigin))
-  }
-
-  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    cookies: {
-      getAll() {
-        return request.cookies.getAll()
-      },
-      setAll(cookiesToSet) {
-        cookiesToSet.forEach(({ name, value, options }) => {
-          try {
-            setCookieNames.push(String(name || ''))
-          } catch {}
-          response.cookies.set(name, value, { ...(options || {}) })
-        })
-      },
-    },
-  })
-
-  try {
-    const { error } = await supabase.auth.exchangeCodeForSession(code)
-    if (error) {
-      return NextResponse.redirect(new URL(`/auth/error?error=${encodeURIComponent(error.message || 'exchange_failed')}`, safeOrigin))
-    }
-    try {
-      await supabase.auth.getUser()
-    } catch {}
-  } catch (e) {
-    return NextResponse.redirect(new URL('/auth/error?error=exchange_failed', safeOrigin))
-  }
-
-  try {
-    if (process.env.NODE_ENV === 'development') {
-      const uniq = Array.from(new Set(setCookieNames.filter(Boolean))).sort()
-      response.headers.set('x-it-set-cookie-names', uniq.join(',').slice(0, 900))
-    }
-  } catch {}
-
-  return response
-}
diff --git a/_archive/duplicates/src/app/auth/error/page 2.tsx b/_archive/duplicates/src/app/auth/error/page 2.tsx
deleted file mode 100644
index ccf1899..0000000
--- a/_archive/duplicates/src/app/auth/error/page 2.tsx	
+++ /dev/null
@@ -1,72 +0,0 @@
-'use client'
-
-import Link from 'next/link'
-import { useSearchParams } from 'next/navigation'
-import { Suspense, useMemo } from 'react'
-import { AlertTriangle, ArrowLeft } from 'lucide-react'
-
-function AuthErrorInner() {
-  const sp = useSearchParams()
-  const err = useMemo(() => String(sp?.get('error') || '').trim(), [sp])
-  const errLower = String(err || '').toLowerCase()
-  const hint =
-    errLower.includes('missing_env')
-      ? 'Faltam variáveis do Supabase neste ambiente (Preview). Configure NEXT_PUBLIC_SUPABASE_URL e NEXT_PUBLIC_SUPABASE_ANON_KEY na Vercel (Environment Variables → Preview) e faça Redeploy.'
-      : errLower.includes('signups not allowed') || errLower.includes('signup') || errLower.includes('sign up')
-      ? 'Parece que o Supabase está bloqueando novos usuários (signups).'
-      : errLower.includes('test user') ||
-        errLower.includes('access denied') ||
-        errLower.includes('consent') ||
-        errLower.includes('access_denied')
-      ? 'Parece bloqueio do Google OAuth (app em modo Testing / test users).'
-      : errLower.includes('flow_state_not_found')
-      ? 'Falha no estado do OAuth. Normalmente isso acontece quando cookies são bloqueados ou o fluxo começa em um domínio e volta em outro.'
-      : errLower.includes('pkce')
-      ? 'Normalmente isso acontece quando o fluxo começou em um domínio e voltou em outro (www vs sem www), ou quando cookies foram bloqueados.'
-      : ''
-
-  return (
-    <div className="min-h-screen bg-neutral-900 flex flex-col items-center justify-center p-6 text-center">
-      <div className="bg-neutral-800 p-8 rounded-2xl border border-neutral-700 max-w-md w-full shadow-2xl">
-        <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500">
-          <AlertTriangle size={32} />
-        </div>
-
-        <h1 className="text-2xl font-black text-white mb-2 uppercase">Erro de Autenticação</h1>
-
-        <p className="text-neutral-400 mb-8 leading-relaxed">
-          Não foi possível validar seu login.
-          {err ? ` (${err})` : ''}
-        </p>
-
-        {hint ? (
-          <div className="mb-6 rounded-xl border border-neutral-700 bg-neutral-900 p-4 text-left text-sm text-neutral-300">
-            {hint}
-          </div>
-        ) : null}
-
-        <Link
-          href="/"
-          className="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-colors"
-        >
-          <ArrowLeft size={20} />
-          Voltar para o Início
-        </Link>
-      </div>
-    </div>
-  )
-}
-
-export default function AuthErrorPage() {
-  return (
-    <Suspense
-      fallback={
-        <div className="min-h-screen bg-neutral-900 flex flex-col items-center justify-center p-6 text-center">
-          <div className="bg-neutral-800 p-8 rounded-2xl border border-neutral-700 max-w-md w-full shadow-2xl" />
-        </div>
-      }
-    >
-      <AuthErrorInner />
-    </Suspense>
-  )
-}
diff --git a/_archive/duplicates/src/app/auth/login/route 2.ts b/_archive/duplicates/src/app/auth/login/route 2.ts
deleted file mode 100644
index 0d30073..0000000
--- a/_archive/duplicates/src/app/auth/login/route 2.ts	
+++ /dev/null
@@ -1,105 +0,0 @@
-import { createServerClient } from '@supabase/ssr'
-import { NextResponse } from 'next/server'
-import { cookies } from 'next/headers'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export const dynamic = 'force-dynamic'
-
-export async function GET(request: Request) {
-  const url = new URL(request.url)
-  const sp = url.searchParams
-  const next = sp.get('next') ?? '/dashboard'
-  const nextCookieName = 'it.auth.next'
-  const nextCookieMaxAgeSeconds = 60 * 5
-
-  const originFromUrl = url.origin
-  const forwardedHost = (request.headers.get('x-forwarded-host') || '').trim()
-  const forwardedProto = (request.headers.get('x-forwarded-proto') || 'https').trim()
-  const isLocalEnv = process.env.NODE_ENV === 'development'
-  const baseOrigin = forwardedHost && !isLocalEnv ? `${forwardedProto}://${forwardedHost}` : originFromUrl
-  let safeOrigin = isLocalEnv && baseOrigin.includes('0.0.0.0') ? baseOrigin.replace('0.0.0.0', 'localhost') : baseOrigin
-  if (!isLocalEnv) {
-    try {
-      const u = new URL(safeOrigin)
-      u.protocol = 'https:'
-      safeOrigin = u.origin
-    } catch {}
-  }
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    return NextResponse.redirect(new URL('/auth/error?error=missing_env', safeOrigin))
-  }
-
-  const rawNext = String(next || '/dashboard')
-  const safeNext = rawNext.startsWith('/') ? rawNext : '/dashboard'
-  const redirectTo = `${safeOrigin}/auth/callback?next=${encodeURIComponent(safeNext)}`
-  const baseCookieOptions = getSupabaseCookieOptions()
-  const nextCookieExpires = new Date(Date.now() + nextCookieMaxAgeSeconds * 1000)
-
-  let cookiesToApply: Array<{ name: string; value: string; options?: any }> = []
-  const cookieStore = await cookies()
-
-  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    cookies: {
-      getAll() {
-        return cookieStore.getAll()
-      },
-      setAll(cookiesToSet) {
-        cookiesToApply = cookiesToSet.map((c) => ({
-          name: c.name,
-          value: c.value,
-          options: c.options ? { ...c.options } : undefined,
-        }))
-      },
-    },
-  })
-
-  let oauthUrl: string | null = null
-  try {
-    const { data, error } = await supabase.auth.signInWithOAuth({
-      provider: 'google',
-      options: { redirectTo },
-    })
-    if (error) {
-      return NextResponse.redirect(
-        new URL(`/auth/error?error=${encodeURIComponent(error.message || 'oauth_failed')}`, safeOrigin),
-      )
-    }
-    oauthUrl = data?.url || null
-  } catch (e: any) {
-    return NextResponse.redirect(
-      new URL(`/auth/error?error=${encodeURIComponent(e?.message || 'oauth_failed')}`, safeOrigin),
-    )
-  }
-
-  if (!oauthUrl) {
-    return NextResponse.redirect(new URL('/auth/error?error=oauth_url_missing', safeOrigin))
-  }
-
-  const redirectResp = NextResponse.redirect(oauthUrl)
-  cookiesToApply.forEach(({ name, value, options }) => {
-    try {
-      redirectResp.cookies.set(name, value, { ...(options || {}) })
-    } catch {
-      try {
-        redirectResp.cookies.set(name, value)
-      } catch {}
-    }
-  })
-  try {
-    redirectResp.cookies.set(nextCookieName, safeNext, {
-      ...(baseCookieOptions || {}),
-      expires: nextCookieExpires,
-      maxAge: nextCookieMaxAgeSeconds,
-    })
-  } catch {
-    try {
-      redirectResp.cookies.set(nextCookieName, safeNext)
-    } catch {}
-  }
-
-  return redirectResp
-}
diff --git a/_archive/duplicates/src/app/auth/logout/route 2.ts b/_archive/duplicates/src/app/auth/logout/route 2.ts
deleted file mode 100644
index 86e2a45..0000000
--- a/_archive/duplicates/src/app/auth/logout/route 2.ts	
+++ /dev/null
@@ -1,53 +0,0 @@
-import { createServerClient } from '@supabase/ssr'
-import { NextResponse } from 'next/server'
-import { cookies } from 'next/headers'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export const dynamic = 'force-dynamic'
-
-export async function GET(request: Request) {
-  const url = new URL(request.url)
-  const originFromUrl = url.origin
-  const forwardedHost = (request.headers.get('x-forwarded-host') || '').trim()
-  const forwardedProto = (request.headers.get('x-forwarded-proto') || 'https').trim()
-  const isLocalEnv = process.env.NODE_ENV === 'development'
-  const baseOrigin = forwardedHost && !isLocalEnv ? `${forwardedProto}://${forwardedHost}` : originFromUrl
-  let safeOrigin = isLocalEnv && baseOrigin.includes('0.0.0.0') ? baseOrigin.replace('0.0.0.0', 'localhost') : baseOrigin
-  if (!isLocalEnv) {
-    try {
-      const u = new URL(safeOrigin)
-      u.protocol = 'https:'
-      safeOrigin = u.origin
-    } catch {}
-  }
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    return NextResponse.redirect(new URL('/', safeOrigin))
-  }
-
-  let response = NextResponse.redirect(new URL('/', safeOrigin))
-  const cookieStore = await cookies()
-
-  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    cookies: {
-      getAll() {
-        return cookieStore.getAll()
-      },
-      setAll(cookiesToSet) {
-        response = NextResponse.redirect(new URL('/', safeOrigin))
-        cookiesToSet.forEach(({ name, value, options }) => {
-          response.cookies.set(name, value, { ...(options || {}) })
-        })
-      },
-    },
-  })
-
-  try {
-    await supabase.auth.signOut({ scope: 'local' })
-  } catch {}
-
-  return response
-}
diff --git a/_archive/duplicates/src/app/favicon.ico/route 2.ts b/_archive/duplicates/src/app/favicon.ico/route 2.ts
deleted file mode 100644
index 331ad29..0000000
--- a/_archive/duplicates/src/app/favicon.ico/route 2.ts	
+++ /dev/null
@@ -1,6 +0,0 @@
-import { NextResponse } from 'next/server'
-
-export function GET(req: Request) {
-  return NextResponse.redirect(new URL('/icone.png', req.url), 307)
-}
-
diff --git a/_archive/duplicates/src/app/favicon.ico/route 3.ts b/_archive/duplicates/src/app/favicon.ico/route 3.ts
deleted file mode 100644
index 331ad29..0000000
--- a/_archive/duplicates/src/app/favicon.ico/route 3.ts	
+++ /dev/null
@@ -1,6 +0,0 @@
-import { NextResponse } from 'next/server'
-
-export function GET(req: Request) {
-  return NextResponse.redirect(new URL('/icone.png', req.url), 307)
-}
-
diff --git a/_archive/duplicates/src/app/marketplace/MarketplaceClient 2.tsx b/_archive/duplicates/src/app/marketplace/MarketplaceClient 2.tsx
deleted file mode 100644
index 9262d4e..0000000
--- a/_archive/duplicates/src/app/marketplace/MarketplaceClient 2.tsx	
+++ /dev/null
@@ -1,489 +0,0 @@
-'use client'
-
-import { useCallback, useEffect, useMemo, useState } from 'react'
-import Image from 'next/image'
-import { useRouter } from 'next/navigation'
-import { createClient } from '@/utils/supabase/client'
-import { ArrowLeft, Copy, CreditCard, ExternalLink, QrCode, RefreshCw, X, MessageSquare } from 'lucide-react'
-
-type AppPlan = {
-  id: string
-  name: string
-  description: string | null
-  interval: 'month' | 'year'
-  price_cents: number
-  currency: string
-  status: 'active' | 'inactive'
-  sort_order?: number | null
-  features?: any
-}
-
-type CheckoutResponse = {
-  ok: boolean
-  error?: string
-  resumed?: boolean
-  subscription?: { id: string; status: string; asaas_subscription_id: string }
-  payment?: {
-    id: string
-    status: string
-    due_date: string | null
-    asaas_payment_id: string
-    invoice_url: string | null
-    pix_qr_code: string | null
-    pix_payload: string | null
-  } | null
-}
-
-const formatMoney = (cents: number) => {
-  const v = Number.isFinite(cents) ? cents : 0
-  const value = (v / 100).toFixed(2)
-  const [intPart, decPart] = value.split('.')
-  const withThousands = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.')
-  return `R$ ${withThousands},${decPart || '00'}`
-}
-
-const minButtonClass = 'min-h-[44px]'
-const PIX_QR_SIZE = 224
-
-const normalizePixImageSrc = (encodedImage: string) => {
-  const s = (encodedImage || '').trim()
-  if (!s) return ''
-  if (s.startsWith('data:image/')) return s
-  return `data:image/png;base64,${s}`
-}
-
-const toCheckoutUserMessage = (raw: string) => {
-  const s = String(raw || '').trim()
-  if (!s) return 'Erro ao criar cobrança.'
-  if (s === 'db_migration_required') return 'O banco de dados ainda não foi atualizado (migrations pendentes).'
-  if (s === 'already_has_active_subscription') return 'Você já tem uma assinatura ativa ou pendente nesta conta.'
-  if (s === 'already_subscribed') return 'Você já iniciou uma assinatura deste plano nesta conta.'
-  if (s === 'pending_subscription_exists') return 'Você tem uma tentativa de assinatura pendente. Finalize ou cancele para tentar novamente.'
-  if (s === 'asaas_api_key_missing') return 'Pagamento PIX indisponível (Asaas não configurado no servidor).'
-  if (s === 'mercadopago_access_token_missing') return 'Pagamento no cartão indisponível (Mercado Pago não configurado no servidor).'
-  if (s === 'unauthorized') return 'Você precisa estar logado para assinar.'
-  return s
-}
-
-export default function MarketplaceClient() {
-  const supabase = useMemo(() => createClient(), [])
-  const router = useRouter()
-
-  const [userId, setUserId] = useState<string>('')
-  const [marketplaceEnabled, setMarketplaceEnabled] = useState(true)
-  const [marketplaceGateChecked, setMarketplaceGateChecked] = useState(false)
-
-  const [plans, setPlans] = useState<AppPlan[]>([])
-  const [loadingPlans, setLoadingPlans] = useState(false)
-
-  const [checkoutOpen, setCheckoutOpen] = useState(false)
-  const [selectedPlan, setSelectedPlan] = useState<AppPlan | null>(null)
-  const [cpfCnpj, setCpfCnpj] = useState('')
-  const [mobilePhone, setMobilePhone] = useState('')
-  const [payerName, setPayerName] = useState('')
-  const [checkingOut, setCheckingOut] = useState(false)
-  const [cardRedirecting, setCardRedirecting] = useState(false)
-  const [checkoutResult, setCheckoutResult] = useState<CheckoutResponse | null>(null)
-
-  const goBack = useCallback(() => {
-    try {
-      router.back()
-      window.setTimeout(() => {
-        try {
-          if (typeof window !== 'undefined' && window.location && window.location.pathname === '/marketplace') {
-            router.push('/dashboard')
-          }
-        } catch {}
-      }, 200)
-    } catch {
-      try {
-        router.push('/dashboard')
-      } catch {}
-    }
-  }, [router])
-
-  const closeCheckout = useCallback(() => {
-    setCheckoutOpen(false)
-    setSelectedPlan(null)
-    setCheckoutResult(null)
-    setCheckingOut(false)
-  }, [])
-
-  const loadMe = useCallback(async () => {
-    const { data: { user } } = await supabase.auth.getUser()
-    if (!user?.id) {
-      setMarketplaceEnabled(true)
-      setMarketplaceGateChecked(true)
-      return
-    }
-    setUserId(user.id)
-    try {
-      const { data: prefRow } = await supabase
-        .from('user_settings')
-        .select('preferences')
-        .eq('user_id', user.id)
-        .maybeSingle()
-      const prefs = prefRow?.preferences && typeof prefRow.preferences === 'object' ? prefRow.preferences : null
-      const enabled = prefs ? (prefs as any).moduleMarketplace !== false : true
-      setMarketplaceEnabled(Boolean(enabled))
-    } catch {
-      setMarketplaceEnabled(true)
-    } finally {
-      setMarketplaceGateChecked(true)
-    }
-  }, [supabase])
-
-  const loadPlans = useCallback(async () => {
-    setLoadingPlans(true)
-    try {
-      const res = await fetch('/api/app/plans', { cache: 'no-store' })
-      const json = await res.json().catch(() => ({}))
-      const rows = Array.isArray(json?.plans) ? (json.plans as AppPlan[]) : []
-      setPlans(rows)
-    } catch {
-      setPlans([])
-    } finally {
-      setLoadingPlans(false)
-    }
-  }, [])
-
-  const openCheckout = useCallback((plan: AppPlan) => {
-    setSelectedPlan(plan)
-    setCheckoutOpen(true)
-    setCheckoutResult(null)
-    setCpfCnpj('')
-    setMobilePhone('')
-    setPayerName('')
-  }, [])
-
-  const startCheckout = useCallback(async () => {
-    if (!selectedPlan) return
-    if (checkingOut) return
-    setCheckingOut(true)
-    setCheckoutResult(null)
-    try {
-      const res = await fetch('/api/app/checkout', {
-        method: 'POST',
-        headers: { 'Content-Type': 'application/json' },
-        body: JSON.stringify({
-          planId: selectedPlan.id,
-          billingType: 'PIX',
-          cpfCnpj,
-          mobilePhone,
-          name: payerName,
-        }),
-      })
-      const json = (await res.json().catch(() => ({}))) as CheckoutResponse
-      setCheckoutResult(json)
-    } catch (e: any) {
-      setCheckoutResult({ ok: false, error: e?.message || String(e) })
-    } finally {
-      setCheckingOut(false)
-    }
-  }, [checkingOut, cpfCnpj, mobilePhone, payerName, selectedPlan])
-
-  const startCardCheckout = useCallback(async () => {
-    if (!selectedPlan) return
-    if (cardRedirecting) return
-    setCardRedirecting(true)
-    setCheckoutResult(null)
-    try {
-      const res = await fetch('/api/billing/mercadopago/subscribe', {
-        method: 'POST',
-        headers: { 'Content-Type': 'application/json' },
-        body: JSON.stringify({ planId: selectedPlan.id }),
-      })
-      const json = await res.json().catch(() => ({}))
-      const redirectUrl = String(json?.redirect_url || '').trim()
-      if (!json?.ok) {
-        setCheckoutResult({ ok: false, error: String(json?.error || 'Falha ao iniciar checkout com cartão.') })
-        return
-      }
-      if (!redirectUrl) {
-        setCheckoutResult({ ok: false, error: 'Checkout do cartão sem URL de redirecionamento.' })
-        return
-      }
-      window.location.href = redirectUrl
-    } catch (e: any) {
-      setCheckoutResult({ ok: false, error: e?.message || String(e) })
-    } finally {
-      setCardRedirecting(false)
-    }
-  }, [cardRedirecting, selectedPlan])
-
-  const cancelPendingAttempt = useCallback(async () => {
-    if (!selectedPlan) return
-    try {
-      const res = await fetch('/api/app/subscriptions/cancel-pending', {
-        method: 'POST',
-        headers: { 'Content-Type': 'application/json' },
-        body: JSON.stringify({ planId: selectedPlan.id }),
-      })
-      const json = await res.json().catch(() => ({}))
-      if (!json?.ok) {
-        setCheckoutResult({ ok: false, error: String(json?.error || 'Falha ao cancelar tentativa.') })
-        return
-      }
-      setCheckoutResult(null)
-      window.alert('Tentativa cancelada. Você pode tentar novamente.')
-    } catch (e: any) {
-      setCheckoutResult({ ok: false, error: e?.message || String(e) })
-    }
-  }, [selectedPlan])
-
-  const canCancelPending = Boolean(
-    (checkoutResult && checkoutResult.ok && checkoutResult.resumed) ||
-      (checkoutResult && !checkoutResult.ok && ['already_subscribed', 'pending_subscription_exists'].includes(String(checkoutResult.error || ''))),
-  )
-
-  const copyToClipboard = useCallback(async (text: string) => {
-    const v = (text || '').trim()
-    if (!v) return
-    try {
-      await navigator.clipboard.writeText(v)
-      window.alert('Copiado!')
-    } catch {
-      window.prompt('Copie o código PIX:', v)
-    }
-  }, [])
-
-  useEffect(() => {
-    loadMe().catch(() => {})
-  }, [loadMe])
-
-  useEffect(() => {
-    if (!marketplaceGateChecked) return
-    if (!marketplaceEnabled) return
-    loadPlans().catch(() => {})
-  }, [loadPlans, marketplaceEnabled, marketplaceGateChecked])
-
-  return (
-    <div className="min-h-screen bg-neutral-900 text-white p-4">
-      <div className="max-w-2xl mx-auto space-y-4">
-        <div className="bg-neutral-800 rounded-2xl border border-neutral-700 p-4">
-          <div className="flex items-center justify-between gap-3">
-            <div>
-              <h1 className="text-lg font-bold">Marketplace</h1>
-              <p className="text-sm text-neutral-300">Planos VIP (Pix ou Cartão)</p>
-            </div>
-            <div className="flex items-center gap-2">
-              <button
-                onClick={goBack}
-                className={`${minButtonClass} px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-bold flex items-center gap-2`}
-              >
-                <ArrowLeft size={18} />
-                Voltar
-              </button>
-              <button
-                onClick={loadPlans}
-                className={`${minButtonClass} px-4 py-3 rounded-xl bg-yellow-500 text-black font-bold flex items-center gap-2`}
-                disabled={!marketplaceGateChecked || !marketplaceEnabled || loadingPlans}
-              >
-                <RefreshCw size={18} />
-                {loadingPlans ? '...' : 'Atualizar'}
-              </button>
-            </div>
-          </div>
-        </div>
-
-        <div className="space-y-2">
-          {!marketplaceGateChecked ? <div className="text-center py-8 text-neutral-400">Carregando...</div> : null}
-          {marketplaceGateChecked && !marketplaceEnabled ? (
-            <div className="text-center py-10 text-neutral-300 bg-neutral-800/40 border border-neutral-800 rounded-2xl">
-              <div className="text-sm font-black uppercase tracking-widest text-yellow-500">Marketplace</div>
-              <div className="text-lg font-black text-white mt-2">Módulo desativado</div>
-              <div className="text-sm text-neutral-400 mt-2">Ative nas preferências para ver os planos.</div>
-              <div className="mt-5 flex flex-col sm:flex-row gap-2 justify-center">
-                <button
-                  type="button"
-                  onClick={goBack}
-                  className={`${minButtonClass} px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black inline-flex items-center justify-center gap-2`}
-                >
-                  <ArrowLeft size={18} />
-                  Voltar
-                </button>
-              </div>
-            </div>
-          ) : null}
-          {marketplaceGateChecked && marketplaceEnabled && loadingPlans ? (
-            <div className="text-center py-8 text-neutral-400">Carregando...</div>
-          ) : null}
-
-          {marketplaceGateChecked && marketplaceEnabled && !loadingPlans && (plans ?? []).length === 0 && (
-            <div className="text-center py-10 text-neutral-300 bg-neutral-800/40 border border-neutral-800 rounded-2xl">
-              <div className="text-sm font-black uppercase tracking-widest text-yellow-500">Marketplace</div>
-              <div className="text-lg font-black text-white mt-2">Nenhum plano encontrado</div>
-              <div className="text-sm text-neutral-400 mt-2">Tente recarregar ou volte para o app.</div>
-              <div className="mt-5 flex flex-col sm:flex-row gap-2 justify-center">
-                <button
-                  type="button"
-                  onClick={goBack}
-                  className={`${minButtonClass} px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black inline-flex items-center justify-center gap-2`}
-                >
-                  <ArrowLeft size={18} />
-                  Voltar
-                </button>
-                <button
-                  type="button"
-                  onClick={loadPlans}
-                  className={`${minButtonClass} px-4 py-3 rounded-xl bg-yellow-500 text-black font-black inline-flex items-center justify-center gap-2`}
-                >
-                  <RefreshCw size={18} />
-                  Recarregar
-                </button>
-              </div>
-            </div>
-          )}
-
-          {marketplaceGateChecked && marketplaceEnabled ? (plans ?? []).map((plan) => (
-            <div key={plan.id} className="bg-neutral-800 rounded-2xl border border-neutral-700 p-4">
-              <div className="flex items-start justify-between gap-3">
-                <div className="min-w-0">
-                  <div className="text-white font-black text-lg">{plan.name}</div>
-                  {plan.description ? <div className="text-sm text-neutral-300 mt-1">{plan.description}</div> : null}
-                  
-                  {plan.features?.limits?.messagesPerDay ? (
-                    <div className="mt-3 flex items-center gap-2 text-xs text-neutral-300 bg-neutral-900/50 p-2 rounded-lg border border-neutral-800">
-                      <MessageSquare size={14} className="text-yellow-500" />
-                      <span>Coach IA: <strong className="text-white">{plan.features.limits.messagesPerDay} msgs/dia</strong></span>
-                    </div>
-                  ) : null}
-
-                  <div className="text-sm text-neutral-400 mt-3">
-                    <span className="font-black text-white">{formatMoney(plan.price_cents)}</span> / {plan.interval === 'year' ? 'ano' : 'mês'}
-                  </div>
-                </div>
-                <button
-                  onClick={() => openCheckout(plan)}
-                  className={`${minButtonClass} px-4 py-3 rounded-xl bg-yellow-500 text-black font-black flex items-center gap-2`}
-                  disabled={!userId}
-                  title={!userId ? 'Faça login para assinar' : undefined}
-                >
-                  <CreditCard size={18} />
-                  Assinar
-                </button>
-              </div>
-            </div>
-          )) : null}
-        </div>
-      </div>
-
-      {checkoutOpen && selectedPlan && (
-        <div className="fixed inset-0 bg-black/70 flex items-end sm:items-center justify-center p-4 z-50">
-          <div className="w-full max-w-lg bg-neutral-900 rounded-2xl border border-neutral-700 overflow-hidden">
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between">
-              <div className="font-black">Assinar {selectedPlan.name}</div>
-              <button onClick={closeCheckout} className={`${minButtonClass} p-2 hover:bg-neutral-800 rounded-xl`}>
-                <X size={18} />
-              </button>
-            </div>
-
-            <div className="p-4 space-y-3">
-              <div className="text-sm text-neutral-300">
-                {formatMoney(selectedPlan.price_cents)} / {selectedPlan.interval === 'year' ? 'ano' : 'mês'} • Pix ou Cartão
-              </div>
-
-              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
-                <input
-                  className="w-full rounded-xl bg-neutral-950 border border-neutral-800 px-3 py-3 text-white font-bold focus:outline-none focus:border-yellow-500"
-                  placeholder="Nome"
-                  value={payerName}
-                  onChange={(e) => setPayerName(e.target.value)}
-                />
-                <input
-                  className="w-full rounded-xl bg-neutral-950 border border-neutral-800 px-3 py-3 text-white font-bold focus:outline-none focus:border-yellow-500"
-                  placeholder="Celular (DDD + número)"
-                  value={mobilePhone}
-                  onChange={(e) => setMobilePhone(e.target.value)}
-                />
-                <input
-                  className="w-full rounded-xl bg-neutral-950 border border-neutral-800 px-3 py-3 text-white font-bold focus:outline-none focus:border-yellow-500 sm:col-span-2"
-                  placeholder="CPF/CNPJ"
-                  value={cpfCnpj}
-                  onChange={(e) => setCpfCnpj(e.target.value)}
-                />
-              </div>
-
-              <button
-                onClick={startCheckout}
-                disabled={checkingOut}
-                className={`${minButtonClass} w-full px-4 py-3 rounded-xl bg-yellow-500 text-black font-black disabled:opacity-60 flex items-center justify-center gap-2`}
-              >
-                <QrCode size={18} />
-                {checkingOut ? 'Gerando PIX...' : 'Gerar PIX'}
-              </button>
-
-              <button
-                onClick={startCardCheckout}
-                disabled={cardRedirecting}
-                className={`${minButtonClass} w-full px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-white font-black disabled:opacity-60 flex items-center justify-center gap-2`}
-              >
-                <CreditCard size={18} />
-                {cardRedirecting ? 'Redirecionando...' : 'Assinar com Cartão'}
-              </button>
-
-              {checkoutResult && !checkoutResult.ok ? (
-                <div className="rounded-2xl border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-200">
-                  {toCheckoutUserMessage(String(checkoutResult.error || ''))}
-                </div>
-              ) : null}
-
-              {canCancelPending ? (
-                <button
-                  type="button"
-                  onClick={cancelPendingAttempt}
-                  className={`${minButtonClass} w-full px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-white font-black flex items-center justify-center gap-2`}
-                >
-                  Cancelar tentativa
-                </button>
-              ) : null}
-
-              {checkoutResult && checkoutResult.ok && checkoutResult.payment ? (
-                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                  <div className="font-black text-white">PIX pronto</div>
-                  <div className="text-sm text-neutral-400 mt-1">Escaneie o QR Code ou copie o código.</div>
-
-                  {checkoutResult.payment.pix_qr_code ? (
-                    <div className="mt-4 flex justify-center">
-                      <Image
-                        src={normalizePixImageSrc(checkoutResult.payment.pix_qr_code)}
-                        width={PIX_QR_SIZE}
-                        height={PIX_QR_SIZE}
-                        alt="QR Code PIX"
-                        className="rounded-xl border border-neutral-800 bg-neutral-950"
-                      />
-                    </div>
-                  ) : null}
-
-                  {checkoutResult.payment.pix_payload ? (
-                    <div className="mt-4 space-y-2">
-                      <button
-                        type="button"
-                        onClick={() => copyToClipboard(checkoutResult.payment?.pix_payload || '')}
-                        className={`${minButtonClass} w-full px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-white font-black flex items-center justify-center gap-2`}
-                      >
-                        <Copy size={18} />
-                        Copiar código PIX
-                      </button>
-                      {checkoutResult.payment.invoice_url ? (
-                        <a
-                          href={checkoutResult.payment.invoice_url}
-                          target="_blank"
-                          rel="noreferrer"
-                          className={`${minButtonClass} w-full px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-white font-black flex items-center justify-center gap-2`}
-                        >
-                          <ExternalLink size={18} />
-                          Abrir fatura
-                        </a>
-                      ) : null}
-                    </div>
-                  ) : null}
-                </div>
-              ) : null}
-            </div>
-          </div>
-        </div>
-      )}
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/app/wait-approval/page 2.tsx b/_archive/duplicates/src/app/wait-approval/page 2.tsx
deleted file mode 100644
index 0def616..0000000
--- a/_archive/duplicates/src/app/wait-approval/page 2.tsx	
+++ /dev/null
@@ -1,67 +0,0 @@
-import { createClient } from "@/utils/supabase/server";
-import { redirect } from "next/navigation";
-import Link from "next/link";
-import { Clock, LogOut } from "lucide-react";
-
-export default async function WaitApprovalPage() {
-  const supabase = await createClient();
-  const { data: { user } } = await supabase.auth.getUser();
-
-  // Se não estiver logado, manda pro login
-  if (!user) {
-    redirect("/auth/login");
-  }
-
-  const email = String(user.email || "").trim().toLowerCase();
-  if (email === "apple-test@irontracks.com.br") {
-    redirect("/dashboard");
-  }
-
-  // Verifica se já foi aprovado (para evitar ficar preso aqui)
-  const { data: profile } = await supabase
-    .from("profiles")
-    .select("is_approved")
-    .eq("id", user.id)
-    .single();
-
-  if (profile?.is_approved) {
-    redirect("/dashboard");
-  }
-
-  return (
-    <div className="min-h-screen bg-neutral-950 flex flex-col items-center justify-center p-6 text-center">
-      <div className="max-w-md w-full bg-neutral-900 border border-neutral-800 rounded-2xl p-8 shadow-2xl animate-in fade-in zoom-in duration-500">
-        <div className="w-20 h-20 bg-yellow-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-yellow-500/20 animate-pulse">
-          <Clock className="w-10 h-10 text-yellow-500" />
-        </div>
-
-        <h1 className="text-2xl font-black text-white mb-2 italic tracking-tight">
-          AGUARDANDO APROVAÇÃO
-        </h1>
-        
-        <div className="h-1 w-16 bg-gradient-to-r from-yellow-500 to-amber-600 rounded-full mx-auto mb-6" />
-
-        <p className="text-neutral-400 mb-8 leading-relaxed">
-          Seu cadastro foi realizado com sucesso! Para garantir a segurança da
-          plataforma, um administrador precisa liberar seu acesso.
-          <br/><br/>
-          <span className="text-yellow-500/80 font-bold text-sm">Você receberá a liberação em breve.</span>
-        </p>
-
-        <div className="space-y-3">
-          <Link
-            href="/auth/logout"
-            className="w-full py-4 px-6 bg-neutral-800 hover:bg-neutral-700 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2 group"
-          >
-            <LogOut size={18} className="group-hover:text-red-400 transition-colors" />
-            Sair da conta
-          </Link>
-          
-          <p className="text-[10px] text-neutral-700 mt-6 font-mono uppercase tracking-widest">
-            ID: {user.id.slice(0, 8)}...
-          </p>
-        </div>
-      </div>
-    </div>
-  );
-}
diff --git a/_archive/duplicates/src/components/ActiveWorkout 2.js b/_archive/duplicates/src/components/ActiveWorkout 2.js
deleted file mode 100644
index 16b8258..0000000
--- a/_archive/duplicates/src/components/ActiveWorkout 2.js	
+++ /dev/null
@@ -1,2588 +0,0 @@
-"use client";
-
-import React, { useEffect, useMemo, useRef, useState } from 'react';
-import { Check, ChevronDown, ChevronUp, Clock, Dumbbell, Link2, MessageSquare, Pencil, Play, Plus, Save, Sparkles, UserPlus, X } from 'lucide-react';
-import { useDialog } from '@/contexts/DialogContext';
-import { BackButton } from '@/components/ui/BackButton';
-import { clearLastWorkoutFinishDraft, enqueueWorkoutFinishJob, saveLastWorkoutFinishDraft } from '@/lib/offline/offlineSync'
-import { parseTrainingNumber } from '@/utils/trainingNumber';
-import InviteManager from '@/components/InviteManager';
-import TeamRoomCard from '@/components/TeamRoomCard';
-import { useTeamWorkout } from '@/contexts/TeamWorkoutContext';
-import ExecutionVideoCapture from '@/components/ExecutionVideoCapture';
-import { trackUserEvent } from '@/lib/telemetry/userActivity'
-
-const isObject = (v) => v && typeof v === 'object' && !Array.isArray(v);
-
-const isClusterConfig = (cfg) => {
-  if (!isObject(cfg)) return false;
-  const hasClusterSize = cfg.cluster_size != null;
-  const hasIntra = cfg.intra_rest_sec != null;
-  const hasTotal = cfg.total_reps != null;
-  return (hasClusterSize && hasIntra) || (hasClusterSize && hasTotal) || (hasIntra && hasTotal);
-};
-
-const isRestPauseConfig = (cfg) => {
-  if (!isObject(cfg)) return false;
-  const hasMiniSets = cfg.mini_sets != null;
-  const hasRest = cfg.rest_time_sec != null;
-  const hasInitial = cfg.initial_reps != null;
-  return (hasMiniSets && hasRest) || (hasMiniSets && hasInitial) || (hasRest && hasInitial);
-};
-
-const buildPlannedBlocks = (totalReps, clusterSize) => {
-  const t = Number(totalReps);
-  const c = Number(clusterSize);
-  if (!Number.isFinite(t) || t <= 0) return [];
-  if (!Number.isFinite(c) || c <= 0) return [];
-  const blocks = [];
-  let remaining = t;
-  while (remaining > 0) {
-    const next = Math.min(c, remaining);
-    blocks.push(next);
-    remaining -= next;
-    if (blocks.length > 50) break;
-  }
-  return blocks;
-};
-
-const buildBlocksByCount = (totalReps, blocksCount) => {
-  const t = Number(totalReps);
-  const c = Number(blocksCount);
-  if (!Number.isFinite(t) || t <= 0) return [];
-  if (!Number.isFinite(c) || c <= 0) return [];
-  const count = Math.min(50, Math.round(c));
-  const base = Math.floor(t / count);
-  const remainder = t - base * count;
-  if (base <= 0) return [];
-  const blocks = Array.from({ length: count }).map((_, idx) => base + (idx < remainder ? 1 : 0));
-  return blocks.filter((n) => Number.isFinite(n) && n > 0);
-};
-
-const parseClusterPrescription = (raw) => {
-  const text = String(raw || '')
-    .toLowerCase()
-    .replace(/[()]/g, ' ')
-    .replace(/[–—]/g, '-')
-    .replace(/[›»→]/g, '>')
-    .replace(/\s+/g, ' ')
-    .trim();
-  if (!text) return { blocks: [], rests: [] };
-  const parts = text
-    .split('>')
-    .map((p) => String(p || '').trim())
-    .filter(Boolean);
-  if (!parts.length) return { blocks: [], rests: [] };
-  const blocks = [];
-  const rests = [];
-  parts.forEach((p) => {
-    const n = parseTrainingNumber(p);
-    if (!n || n <= 0) return;
-    if (p.includes('rep')) blocks.push(n);
-    else if (p.includes('seg') || p.includes('sec') || p.includes('s')) rests.push(n);
-  });
-  if (blocks.length >= 2 && rests.length === blocks.length - 1) return { blocks, rests };
-  if (blocks.length >= 2 && rests.length >= 1) {
-    const base = rests[0];
-    return { blocks, rests: Array.from({ length: blocks.length - 1 }).map(() => base) };
-  }
-  return { blocks: [], rests: [] };
-};
-
-export default function ActiveWorkout(props) {
-  const { alert, confirm } = useDialog();
-  const { sendInvite, createJoinCode, setPresenceStatus, teamSession, presence } = useTeamWorkout();
-  const session = props?.session && typeof props.session === 'object' ? props.session : null;
-  const workout = session?.workout && typeof session.workout === 'object' ? session.workout : null;
-  const exercises = Array.isArray(workout?.exercises) ? workout.exercises : [];
-  const logs = session?.logs && typeof session.logs === 'object' ? session.logs : {};
-  const ui = session?.ui && typeof session.ui === 'object' ? session.ui : {};
-  const settings = props?.settings && typeof props.settings === 'object' ? props.settings : null;
-  const teamworkV2Enabled = settings?.featuresKillSwitch !== true && settings?.featureTeamworkV2 === true;
-  const defaultRestSeconds = (() => {
-    const raw = Number(settings?.restTimerDefaultSeconds ?? 90);
-    if (!Number.isFinite(raw)) return 90;
-    return Math.max(15, Math.min(600, Math.round(raw)));
-  })();
-  const autoStartDefaultRest = Boolean(settings?.autoRestTimerWhenMissing ?? false);
-  const resolveRestTimeSeconds = (ex) => {
-    const raw = parseTrainingNumber(ex?.restTime ?? ex?.rest_time);
-    if (raw && raw > 0) return raw;
-    if (!autoStartDefaultRest) return 0;
-    return defaultRestSeconds;
-  };
-
-  const requestPostWorkoutCheckin = async () => {
-    if (postCheckinOpen) return null;
-    return await new Promise((resolve) => {
-      postCheckinResolveRef.current = (value) => {
-        resolve(value ?? null);
-      };
-      setPostCheckinDraft({ rpe: '', satisfaction: '', soreness: '', notes: '' });
-      setPostCheckinOpen(true);
-    });
-  };
-
-  const [ticker, setTicker] = useState(Date.now());
-  const [collapsed, setCollapsed] = useState(() => new Set());
-  const [finishing, setFinishing] = useState(false);
-  const [openNotesKeys, setOpenNotesKeys] = useState(() => new Set());
-  const [openAiHints, setOpenAiHints] = useState(() => new Set());
-  const [clusterModal, setClusterModal] = useState(null);
-  const [restPauseModal, setRestPauseModal] = useState(null);
-
-  useEffect(() => {
-    if (!teamworkV2Enabled) return;
-    try {
-      if (typeof setPresenceStatus === 'function') setPresenceStatus('in_workout');
-    } catch {}
-    return () => {
-      try {
-        if (typeof setPresenceStatus === 'function') setPresenceStatus('online');
-      } catch {}
-    };
-  }, [setPresenceStatus, teamworkV2Enabled]);
-
-  const shareTeamJoinLink = async () => {
-    try {
-      if (!teamworkV2Enabled) return;
-      if (typeof createJoinCode !== 'function') return;
-      const payloadWorkout = workout && typeof workout === 'object'
-        ? { ...workout, exercises: Array.isArray(workout?.exercises) ? workout.exercises : [] }
-        : { title: 'Treino', exercises: [] };
-      const res = await createJoinCode(payloadWorkout, 90);
-      if (!res?.ok) {
-        await alert('Falha ao gerar link: ' + (res?.error || ''));
-        return;
-      }
-      const url = String(res?.url || '').trim();
-      const code = String(res?.code || '').trim();
-      const text = url ? url : code;
-      try {
-        if (text && navigator?.clipboard?.writeText) await navigator.clipboard.writeText(text);
-      } catch {}
-      try {
-        if (url && navigator?.share) await navigator.share({ title: 'Bora treinar junto', text: 'Entre na sessão do treino:', url });
-      } catch {}
-      await alert(
-        url ? `Link pronto. Código: ${code}` : `Código pronto: ${code}`,
-        'Convite por link'
-      );
-    } catch (e) {
-      const msg = e?.message || String(e || '');
-      await alert('Falha ao gerar link: ' + msg);
-    }
-  };
-  const [dropSetModal, setDropSetModal] = useState(null);
-  const [inviteOpen, setInviteOpen] = useState(false);
-  const [postCheckinOpen, setPostCheckinOpen] = useState(false);
-  const [postCheckinDraft, setPostCheckinDraft] = useState({ rpe: '', satisfaction: '', soreness: '', notes: '' });
-  const postCheckinResolveRef = useRef(null);
-
-  const restPauseRefs = useRef({});
-  const clusterRefs = useRef({});
-  const MAX_EXTRA_SETS_PER_EXERCISE = 50;
-  const MAX_EXTRA_EXERCISES_PER_WORKOUT = 50;
-
-  useEffect(() => {
-    const id = setInterval(() => setTicker(Date.now()), 1000);
-    return () => clearInterval(id);
-  }, []);
-
-  const startedAtMs = useMemo(() => {
-    const raw = session?.startedAt;
-    if (typeof raw === 'number') return raw;
-    const t = new Date(raw || 0).getTime();
-    return Number.isFinite(t) ? t : 0;
-  }, [session?.startedAt]);
-
-  const elapsedSeconds = useMemo(() => {
-    if (!startedAtMs) return 0;
-    return Math.max(0, Math.floor((ticker - startedAtMs) / 1000));
-  }, [ticker, startedAtMs]);
-
-  const formatElapsed = (s) => {
-    const secs = Math.max(0, Number(s) || 0);
-    const m = Math.floor(secs / 60);
-    const sec = secs % 60;
-    return `${m}:${String(sec).padStart(2, '0')}`;
-  };
-
-  const safeUpdateSessionUi = (patch) => {
-    try {
-      if (typeof props?.onUpdateSession !== 'function') return;
-      const baseUi = session?.ui && typeof session.ui === 'object' ? session.ui : {};
-      props.onUpdateSession({ ui: { ...baseUi, ...(patch && typeof patch === 'object' ? patch : {}) } });
-    } catch {}
-  };
-
-  useEffect(() => {
-    try {
-      const focus = ui?.restPauseFocus && typeof ui.restPauseFocus === 'object' ? ui.restPauseFocus : null;
-      const key = String(focus?.key ?? '').trim();
-      const miniIndex = Number(focus?.miniIndex);
-      if (!key) return;
-      if (!Number.isFinite(miniIndex) || miniIndex < 0) return;
-      const input = restPauseRefs.current?.[key]?.[miniIndex];
-      if (input && typeof input.focus === 'function') {
-        input.focus();
-        try {
-          input.select?.();
-        } catch {}
-      }
-      safeUpdateSessionUi({ restPauseFocus: null });
-    } catch {}
-    // eslint-disable-next-line react-hooks/exhaustive-deps
-  }, [ui?.restPauseFocus?.key, ui?.restPauseFocus?.miniIndex]);
-
-  useEffect(() => {
-    try {
-      const focus = ui?.clusterFocus && typeof ui.clusterFocus === 'object' ? ui.clusterFocus : null;
-      const key = String(focus?.key ?? '').trim();
-      const blockIndex = Number(focus?.blockIndex);
-      if (!key) return;
-      if (!Number.isFinite(blockIndex) || blockIndex < 0) return;
-      const input = clusterRefs.current?.[key]?.[blockIndex];
-      if (input && typeof input.focus === 'function') {
-        input.focus();
-        try {
-          input.select?.();
-        } catch {}
-      }
-      safeUpdateSessionUi({ clusterFocus: null });
-    } catch {}
-    // eslint-disable-next-line react-hooks/exhaustive-deps
-  }, [ui?.clusterFocus?.key, ui?.clusterFocus?.blockIndex]);
-
-  const getPlanConfig = (ex, setIdx) => {
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const sd = sdArr?.[setIdx] && typeof sdArr[setIdx] === 'object' ? sdArr[setIdx] : null;
-    const cfg = sd?.advanced_config ?? sd?.advancedConfig ?? null;
-    return isObject(cfg) ? cfg : null;
-  };
-
-  const getPlannedSet = (ex, setIdx) => {
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const sd = sdArr?.[setIdx] && typeof sdArr[setIdx] === 'object' ? sdArr[setIdx] : null;
-    return sd && typeof sd === 'object' ? sd : null;
-  };
-
-  const getLog = (key) => {
-    const v = logs?.[key];
-    return v && typeof v === 'object' ? v : {};
-  };
-
-  const updateLog = (key, patch) => {
-    try {
-      if (typeof props?.onUpdateLog !== 'function') return;
-      const prev = getLog(key);
-      props.onUpdateLog(key, { ...prev, ...(patch && typeof patch === 'object' ? patch : {}) });
-    } catch {}
-  };
-
-  const startTimer = (seconds, context) => {
-    try {
-      if (typeof props?.onStartTimer !== 'function') return;
-      const s = Number(seconds);
-      if (!Number.isFinite(s) || s <= 0) return;
-      props.onStartTimer(s, context);
-    } catch {}
-  };
-
-  const toggleCollapse = (exIdx) => {
-    setCollapsed((prev) => {
-      const next = new Set(prev);
-      if (next.has(exIdx)) next.delete(exIdx);
-      else next.add(exIdx);
-      return next;
-    });
-  };
-
-  const addExtraSetToExercise = async (exIdx) => {
-    if (!workout || typeof props?.onUpdateSession !== 'function') return;
-    const idx = Number(exIdx);
-    if (!Number.isFinite(idx) || idx < 0) return;
-    if (idx >= exercises.length) return;
-    try {
-      const nextExercises = [...exercises];
-      const exRaw = nextExercises[idx] && typeof nextExercises[idx] === 'object' ? nextExercises[idx] : {};
-      const setsHeader = Math.max(0, Number.parseInt(String(exRaw?.sets ?? '0'), 10) || 0);
-      const sdArrRaw = Array.isArray(exRaw?.setDetails) ? exRaw.setDetails : Array.isArray(exRaw?.set_details) ? exRaw.set_details : [];
-      const sdArr = Array.isArray(sdArrRaw) ? [...sdArrRaw] : [];
-      const setsCount = Math.max(setsHeader, sdArr.length);
-      if (setsCount >= MAX_EXTRA_SETS_PER_EXERCISE) return;
-
-      const last = sdArr.length > 0 ? sdArr[sdArr.length - 1] : null;
-      const base = last && typeof last === 'object' ? last : {};
-      const nextDetail = {
-        ...base,
-        set_number: setsCount + 1,
-        weight: null,
-        reps: '',
-        rpe: null,
-        notes: null,
-        is_warmup: false,
-      };
-
-      sdArr.push(nextDetail);
-      nextExercises[idx] = {
-        ...exRaw,
-        sets: setsCount + 1,
-        setDetails: sdArr,
-      };
-      props.onUpdateSession({ workout: { ...workout, exercises: nextExercises } });
-      setCollapsed((prev) => {
-        const next = new Set(prev);
-        if (next.has(idx)) next.delete(idx);
-        return next;
-      });
-    } catch (e) {
-      try {
-        await alert('Não foi possível adicionar série extra: ' + (e?.message || String(e || '')));
-      } catch {}
-    }
-  };
-
-  const finishWorkout = async () => {
-    if (!session || !workout) return;
-    if (finishing) return;
-
-    const minSecondsForFullSession = 30 * 60;
-    const elapsedSafe = Number(elapsedSeconds) || 0;
-    let showReport = true;
-
-    let ok = false;
-    try {
-      ok =
-        typeof confirm === 'function'
-          ? await confirm('Deseja finalizar o treino?', 'Finalizar treino', {
-              confirmText: 'Sim',
-              cancelText: 'Não',
-            })
-          : false;
-    } catch {
-      ok = false;
-    }
-    if (!ok) return;
-
-    const isShort = elapsedSafe > 0 && Number.isFinite(elapsedSafe) && elapsedSafe < minSecondsForFullSession;
-    let shouldSaveHistory = true;
-
-    if (isShort) {
-      let allowSaveShort = false;
-      try {
-        allowSaveShort =
-          typeof confirm === 'function'
-            ? await confirm(
-                'Esse treino durou menos de 30 minutos. Deseja adicioná-lo no histórico?',
-                'Treino curto (< 30 min)',
-                {
-                  confirmText: 'Sim',
-                  cancelText: 'Não',
-                }
-              )
-            : false;
-      } catch {
-        allowSaveShort = false;
-      }
-      shouldSaveHistory = !!allowSaveShort;
-    }
-
-    try {
-      showReport =
-        typeof confirm === 'function'
-          ? await confirm('Deseja o relatório desse treino?', 'Gerar relatório?', {
-              confirmText: 'Sim',
-              cancelText: 'Não',
-            })
-          : true;
-    } catch {
-      showReport = true;
-    }
-
-    const baseExerciseCount = Number(ui?.baseExerciseCount ?? 0) || 0;
-    const hasExtraExercise = !!ui?.pendingTemplateUpdate || (exercises.length > 0 && exercises.length > baseExerciseCount);
-    if (hasExtraExercise) {
-      let shouldSaveTemplate = false;
-      try {
-        shouldSaveTemplate =
-          typeof confirm === 'function'
-            ? await confirm(
-                'Você adicionou exercício(s) extra(s) durante o treino.\nDeseja salvar essa mudança no modelo do treino?',
-                'Salvar no treino?',
-                {
-                  confirmText: 'Sim',
-                  cancelText: 'Não',
-                },
-              )
-            : false;
-      } catch {
-        shouldSaveTemplate = false;
-      }
-      if (shouldSaveTemplate) {
-        try {
-          if (typeof props?.onPersistWorkoutTemplate === 'function') {
-            const res = await props.onPersistWorkoutTemplate(workout);
-            if (!res || res.ok === false) {
-              throw new Error(res?.error || 'Falha ao salvar treino');
-            }
-            try {
-              await alert('Treino atualizado com o(s) exercício(s) extra(s).', 'Treino salvo');
-            } catch {}
-          }
-        } catch (e) {
-          const msg = e?.message ? String(e.message) : String(e);
-          try {
-            await alert('Não foi possível salvar no modelo: ' + (msg || 'erro inesperado'), 'Aviso');
-          } catch {}
-        }
-      }
-    }
-
-    let postCheckin = null;
-    if (shouldSaveHistory) {
-      try {
-        const prompt = settings ? settings.promptPostWorkoutCheckin !== false : true;
-        if (prompt) postCheckin = await requestPostWorkoutCheckin();
-      } catch {
-        postCheckin = null;
-      }
-    }
-
-    setFinishing(true);
-    try {
-      const safeExercises = Array.isArray(workout?.exercises)
-        ? workout.exercises.map((ex) => {
-            if (!ex || typeof ex !== 'object') return null;
-            return {
-              name: String(ex?.name || '').trim(),
-              sets: Number(ex?.sets) || (Array.isArray(ex?.setDetails) ? ex.setDetails.length : 0),
-              reps: ex?.reps ?? '',
-              rpe: ex?.rpe ?? null,
-              cadence: ex?.cadence ?? null,
-              restTime: ex?.restTime ?? ex?.rest_time ?? null,
-              method: ex?.method ?? null,
-              videoUrl: ex?.videoUrl ?? ex?.video_url ?? null,
-              notes: ex?.notes ?? null,
-              setDetails: Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [],
-            };
-          })
-        : [];
-
-      const payload = {
-        workoutTitle: String(workout?.title || 'Treino'),
-        date: new Date().toISOString(),
-        totalTime: elapsedSeconds,
-        realTotalTime: elapsedSeconds,
-        logs: logs && typeof logs === 'object' ? logs : {},
-        exercises: safeExercises.filter((x) => x && typeof x === 'object' && String(x.name || '').length > 0),
-        originWorkoutId: workout?.id ?? null,
-        preCheckin: ui?.preCheckin ?? null,
-        postCheckin,
-        team: (() => {
-          try {
-            const sid = teamSession?.id ? String(teamSession.id) : ''
-            const list = Array.isArray(teamSession?.participants) ? teamSession.participants : []
-            const count = Math.max(0, Number(list.length) || 0)
-            if (!sid && count <= 0) return null
-            return { sessionId: sid || null, participantsCount: count || null }
-          } catch {
-            return null
-          }
-        })(),
-      };
-
-      let savedId = null;
-      if (shouldSaveHistory) {
-        const idempotencyKey = (() => {
-          try {
-            const fromSession = session && typeof session === 'object' ? (session.finishIdempotencyKey ?? session.idempotencyKey ?? session.idempotency_key) : null
-            const raw = String(fromSession ?? '').trim()
-            if (raw) return raw
-          } catch {}
-          try {
-            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') return crypto.randomUUID()
-          } catch {}
-          return `${Date.now()}-${Math.random().toString(16).slice(2)}`
-        })()
-        try {
-          try {
-            const uid = String(props?.user?.id || '').trim()
-            if (uid) await saveLastWorkoutFinishDraft({ userId: uid, idempotencyKey, session: { ...payload, idempotencyKey } })
-          } catch {}
-          const resp = await fetch('/api/workouts/finish', {
-            method: 'POST',
-            headers: { 'Content-Type': 'application/json' },
-            body: JSON.stringify({ session: { ...payload, idempotencyKey }, idempotencyKey }),
-          });
-          const contentType = String(resp?.headers?.get?.('content-type') || '')
-          const json = contentType.includes('application/json') ? await resp.json().catch(() => null) : null
-          if (!resp.ok || !json?.ok) {
-            const httpMsg = !resp.ok ? `http_${resp.status}` : ''
-            const errMsg = String(json?.error || httpMsg || 'Falha ao salvar no histórico')
-            throw new Error(errMsg)
-          }
-          savedId = json?.saved?.id ?? null;
-          try {
-            const uid = String(props?.user?.id || '').trim()
-            if (uid) await clearLastWorkoutFinishDraft({ userId: uid })
-          } catch {}
-          try {
-            trackUserEvent('workout_finish_ok', {
-              type: 'workout',
-              metadata: { id: savedId, title: payload?.workoutTitle || null, durationSeconds: payload?.totalTime || null, idempotent: !!json?.idempotent },
-            })
-          } catch {}
-        } catch (e) {
-          const msg = e?.message ? String(e.message) : String(e);
-          const offline = (() => {
-            try {
-              if (typeof navigator !== 'undefined' && navigator.onLine === false) return true
-            } catch {}
-            const lower = String(msg || '').toLowerCase()
-            return lower.includes('failed to fetch') || lower.includes('network') || lower.includes('fetch') || lower.includes('load failed')
-          })()
-          if (offline) {
-            const uid = String(props?.user?.id || '').trim()
-            if (!uid) {
-              await alert('Você precisa estar logado para salvar e sincronizar o treino offline.', 'Sem sessão')
-              savedId = null
-            } else {
-              try {
-                await enqueueWorkoutFinishJob({ userId: uid, session: { ...payload, idempotencyKey }, idempotencyKey })
-              } catch {}
-              try {
-                await alert('Sem internet. O treino foi salvo e será sincronizado automaticamente quando a conexão voltar.', 'Finalização pendente')
-              } catch {}
-              savedId = null
-              try {
-                trackUserEvent('workout_finish_offline_queued', {
-                  type: 'workout',
-                  metadata: { title: payload?.workoutTitle || null, durationSeconds: payload?.totalTime || null },
-                })
-              } catch {}
-            }
-            try {
-            } catch {}
-          } else {
-            await alert('Erro ao salvar no histórico: ' + (msg || 'erro inesperado'));
-            savedId = null;
-            try {
-              trackUserEvent('workout_finish_error', { type: 'workout', metadata: { message: msg || null } })
-            } catch {}
-          }
-        }
-      }
-
-      const sessionForReport = {
-        ...payload,
-        id: savedId,
-      };
-
-      try {
-        if (typeof props?.onFinish === 'function') {
-          props.onFinish(sessionForReport, showReport);
-        }
-      } catch {}
-    } catch (e) {
-      const msg = e?.message ? String(e.message) : String(e);
-      await alert('Erro ao finalizar: ' + (msg || 'erro inesperado'));
-    } finally {
-      setFinishing(false);
-    }
-  };
-
-  const renderNormalSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const cfg = getPlanConfig(ex, setIdx);
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const restTime = resolveRestTimeSeconds(ex);
-    const weightValue = String(log?.weight ?? cfg?.weight ?? '');
-    const repsValue = String(log?.reps ?? '');
-    const rpeValue = String(log?.rpe ?? '');
-    const notesValue = String(log?.notes ?? '');
-    const done = !!log?.done;
-
-    const plannedReps = String(plannedSet?.reps ?? ex?.reps ?? '').trim();
-    const plannedRpe = String(plannedSet?.rpe ?? ex?.rpe ?? '').trim();
-
-    const isHeaderRow = setIdx === 0;
-    const notesId = `notes-${key}`;
-    const hasNotes = notesValue.trim().length > 0;
-    const isNotesOpen = openNotesKeys.has(key);
-
-    const toggleNotes = () => {
-      setOpenNotesKeys((prev) => {
-        const next = new Set(prev);
-        if (next.has(key)) next.delete(key);
-        else next.add(key);
-        return next;
-      });
-    };
-
-    return (
-      <div className="space-y-1" key={key}>
-        {isHeaderRow && (
-          <div className="hidden sm:flex items-center gap-2 text-[10px] uppercase tracking-widest text-neutral-500 font-bold px-1">
-            <div className="w-10">Série</div>
-            <div className="w-24">Peso (kg)</div>
-            <div className="w-24">Reps</div>
-            <div className="w-24">RPE</div>
-            <div className="ml-auto flex items-center gap-2">Ações</div>
-          </div>
-        )}
-        <div className="rounded-lg bg-neutral-900/40 border border-neutral-800 px-2 py-2 space-y-2 sm:space-y-0">
-          <div className="sm:hidden">
-            <div className="flex items-center justify-between gap-2">
-              <div className="text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-              <div className="flex items-center gap-1 ml-auto">
-                <button
-                  type="button"
-                  onClick={toggleNotes}
-                  className={
-                    isNotesOpen || hasNotes
-                      ? 'inline-flex items-center justify-center rounded-lg p-2 text-yellow-500 bg-yellow-500/10 border border-yellow-500/40 hover:bg-yellow-500/15 transition duration-200'
-                      : 'inline-flex items-center justify-center rounded-lg p-2 text-neutral-400 bg-black/30 border border-neutral-700 hover:border-yellow-500/60 hover:text-yellow-500 transition duration-200'
-                  }
-                >
-                  <MessageSquare size={14} />
-                </button>
-                <button
-                  type="button"
-                  onClick={() => {
-                    const nextDone = !done;
-                    updateLog(key, { done: nextDone, advanced_config: cfg ?? log?.advanced_config ?? null });
-                    if (nextDone && restTime && restTime > 0) {
-                      startTimer(restTime, { kind: 'rest', key });
-                    }
-                  }}
-                  className={
-                    done
-                      ? 'inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-yellow-500 text-black font-black shadow-yellow-500/20 shadow-sm active:scale-95 transition duration-150'
-                      : 'inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700 active:scale-95 transition duration-150'
-                  }
-                >
-                  <Check size={16} />
-                  <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-                </button>
-              </div>
-            </div>
-
-            <div className="grid grid-cols-3 gap-2 mt-2">
-              <input
-                inputMode="decimal"
-                value={weightValue}
-                onChange={(e) => {
-                  const v = e?.target?.value ?? '';
-                  updateLog(key, { weight: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                }}
-                placeholder="Peso (kg)"
-                className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-1.5 text-sm text-white outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0"
-              />
-              <div className="relative">
-                <input
-                  inputMode="decimal"
-                  value={repsValue}
-                  onChange={(e) => {
-                    const v = e?.target?.value ?? '';
-                    updateLog(key, { reps: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                  }}
-                  placeholder="Reps"
-                  className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-1.5 pr-10 text-sm text-white outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0"
-                />
-                {plannedReps ? (
-                  <div className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono text-neutral-500/60">
-                    {plannedReps}
-                  </div>
-                ) : null}
-              </div>
-              <div className="relative">
-                <input
-                  inputMode="decimal"
-                  value={rpeValue}
-                  onChange={(e) => {
-                    const v = e?.target?.value ?? '';
-                    updateLog(key, { rpe: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                  }}
-                  placeholder="RPE"
-                  className="w-full bg-black/30 border border-yellow-500/30 rounded-lg px-3 py-1.5 pr-10 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-yellow-500/50 focus:placeholder:opacity-0"
-                />
-                {plannedRpe ? (
-                  <div className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono text-yellow-500/45">
-                    {plannedRpe}
-                  </div>
-                ) : null}
-              </div>
-            </div>
-          </div>
-
-          <div className="hidden sm:flex items-center gap-2">
-            <div className="w-10 text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-            <div className="w-24">
-              <input
-                inputMode="decimal"
-                value={weightValue}
-                onChange={(e) => {
-                  const v = e?.target?.value ?? '';
-                  updateLog(key, { weight: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                }}
-                placeholder="Peso (kg)"
-                className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-1.5 text-sm text-white outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0"
-              />
-            </div>
-            <div className="w-24 relative">
-              <input
-                inputMode="decimal"
-                value={repsValue}
-                onChange={(e) => {
-                  const v = e?.target?.value ?? '';
-                  updateLog(key, { reps: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                }}
-                placeholder="Reps"
-                className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-1.5 pr-10 text-sm text-white outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0"
-              />
-              {plannedReps ? (
-                <div className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono text-neutral-500/60">
-                  {plannedReps}
-                </div>
-              ) : null}
-            </div>
-            <div className="w-24 relative">
-              <input
-                inputMode="decimal"
-                value={rpeValue}
-                onChange={(e) => {
-                  const v = e?.target?.value ?? '';
-                  updateLog(key, { rpe: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                }}
-                placeholder="RPE"
-                className="w-full bg-black/30 border border-yellow-500/30 rounded-lg px-3 py-1.5 pr-10 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-yellow-500/50 focus:placeholder:opacity-0"
-              />
-              {plannedRpe ? (
-                <div className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono text-yellow-500/35">
-                  {plannedRpe}
-                </div>
-              ) : null}
-            </div>
-            <div className="ml-auto flex items-center gap-2">
-              <button
-                type="button"
-                onClick={toggleNotes}
-                className={
-                  isNotesOpen || hasNotes
-                    ? 'inline-flex items-center justify-center rounded-lg p-2 text-yellow-500 bg-yellow-500/10 border border-yellow-500/40 hover:bg-yellow-500/15 transition duration-200'
-                    : 'inline-flex items-center justify-center rounded-lg p-2 text-neutral-400 bg-black/30 border border-neutral-700 hover:border-yellow-500/60 hover:text-yellow-500 transition duration-200'
-                }
-              >
-                <MessageSquare size={14} />
-              </button>
-              <button
-                type="button"
-                onClick={() => {
-                  const nextDone = !done;
-                  updateLog(key, { done: nextDone, advanced_config: cfg ?? log?.advanced_config ?? null });
-                  if (nextDone && restTime && restTime > 0) {
-                    startTimer(restTime, { kind: 'rest', key });
-                  }
-                }}
-                className={
-                  done
-                    ? 'inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-yellow-500 text-black font-black shadow-yellow-500/20 shadow-sm active:scale-95 transition duration-150'
-                    : 'inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700 active:scale-95 transition duration-150'
-                }
-              >
-                <Check size={16} />
-                <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-              </button>
-            </div>
-          </div>
-        </div>
-        {isNotesOpen && (
-          <div className="px-1">
-            <textarea
-              id={notesId}
-              value={notesValue}
-              onChange={(e) => {
-                const v = e?.target?.value ?? '';
-                updateLog(key, { notes: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-              }}
-              placeholder="Observações da série (opcional)"
-              rows={2}
-              className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500 shadow-sm shadow-yellow-500/10 transition duration-200"
-            />
-          </div>
-        )}
-      </div>
-    );
-  };
-
-  const renderRestPauseSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const cfgRaw = getPlanConfig(ex, setIdx);
-    const method = String(ex?.method || '').trim();
-    const auto = plannedSet?.it_auto && typeof plannedSet.it_auto === 'object' ? plannedSet.it_auto : null;
-    const modeLabel = String(auto?.label || '').trim() || (String(auto?.kind || '') === 'sst' ? 'SST' : 'Rest-P');
-    const cfgMiniRaw = parseTrainingNumber(cfgRaw?.mini_sets);
-    const cfgRestRaw = parseTrainingNumber(cfgRaw?.rest_time_sec);
-    const shouldFillRestPauseDefaults =
-      method === 'Rest-Pause' &&
-      (!isRestPauseConfig(cfgRaw) || !(Number.isFinite(cfgMiniRaw) && cfgMiniRaw >= 1) || !(Number.isFinite(cfgRestRaw) && cfgRestRaw >= 1));
-
-    const cfg = shouldFillRestPauseDefaults
-      ? {
-          ...(isObject(cfgRaw) ? cfgRaw : {}),
-          mini_sets: Number.isFinite(cfgMiniRaw) && cfgMiniRaw >= 1 ? cfgMiniRaw : 2,
-          rest_time_sec: Number.isFinite(cfgRestRaw) && cfgRestRaw >= 1 ? cfgRestRaw : 15,
-        }
-      : cfgRaw;
-    const restTime = resolveRestTimeSeconds(ex);
-
-    const rp = isObject(log?.rest_pause) ? log.rest_pause : {};
-    const pauseSec = parseTrainingNumber(cfg?.rest_time_sec) ?? parseTrainingNumber(rp?.rest_time_sec) ?? 15;
-    const plannedMiniSets = Math.max(0, Math.floor(parseTrainingNumber(cfg?.mini_sets) ?? 0));
-    const savedMiniSets = Math.max(0, Math.floor(parseTrainingNumber(rp?.planned_mini_sets) ?? 0));
-    const miniRepsArrRaw = Array.isArray(rp?.mini_reps) ? rp.mini_reps : [];
-    const miniSets = plannedMiniSets || savedMiniSets || (Array.isArray(miniRepsArrRaw) ? miniRepsArrRaw.length : 0);
-
-    const activation = parseTrainingNumber(rp?.activation_reps) ?? null;
-    const minis = Array.from({ length: miniSets }).map((_, idx) => {
-      const v = miniRepsArrRaw?.[idx];
-      const n = parseTrainingNumber(v);
-      return n;
-    });
-
-    const total = (activation ?? 0) + minis.reduce((acc, v) => acc + (v ?? 0), 0);
-    const done = !!log?.done;
-    const canDone = (activation ?? 0) > 0 && (miniSets === 0 || minis.every((v) => Number.isFinite(v) && v > 0));
-
-    const notesValue = String(log?.notes ?? '');
-    const hasNotes = notesValue.trim().length > 0;
-    const isNotesOpen = openNotesKeys.has(key);
-
-    const toggleNotes = () => {
-      setOpenNotesKeys((prev) => {
-        const next = new Set(prev);
-        if (next.has(key)) next.delete(key);
-        else next.add(key);
-        return next;
-      });
-    };
-
-    return (
-      <div key={key} className="space-y-2">
-        <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-2">
-          <div className="flex items-center gap-2">
-            <div className="w-9 text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-            <input
-              inputMode="decimal"
-              value={String(log?.weight ?? cfg?.weight ?? '')}
-              onChange={(e) => {
-                const v = e?.target?.value ?? '';
-                updateLog(key, { weight: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-              }}
-              placeholder="kg"
-              className="w-20 sm:w-24 bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-            />
-            <button
-              type="button"
-              onClick={() => {
-                const baseWeight = String(log?.weight ?? cfg?.weight ?? '');
-                const baseRpe = String(log?.rpe ?? '').trim();
-                const nextMiniCount = Math.max(0, Math.floor(miniSets));
-                const minis = Array.from({ length: nextMiniCount }).map((_, idx) => {
-                  const v = miniRepsArrRaw?.[idx];
-                  const n = parseTrainingNumber(v);
-                  return n != null && n > 0 ? n : null;
-                });
-                setRestPauseModal({
-                  key,
-                  label: modeLabel,
-                  pauseSec,
-                  miniSets: nextMiniCount,
-                  weight: baseWeight,
-                  activationReps: activation != null && activation > 0 ? activation : null,
-                  minis,
-                  rpe: baseRpe,
-                  cfg: cfg ?? null,
-                  error: '',
-                });
-              }}
-              className="bg-black/30 border border-neutral-700 rounded-lg px-2 sm:px-3 py-2 text-sm text-white outline-none hover:border-yellow-500/60 hover:text-yellow-500 transition-colors inline-flex items-center justify-center gap-2"
-            >
-              <Pencil size={14} />
-              <span className="text-xs font-black hidden sm:inline">Abrir</span>
-            </button>
-          </div>
-
-          <div className="flex items-center gap-2 flex-1 min-w-0">
-            <span className="text-[10px] uppercase tracking-widest font-black text-yellow-500 shrink-0 whitespace-nowrap">{modeLabel === 'SST' ? 'SST' : 'Rest-P'}</span>
-            <span className="text-xs text-neutral-400 sm:truncate">Descanso {pauseSec || 0}s • Total: {total || 0} reps</span>
-          </div>
-
-          <div className="flex items-center gap-2">
-            <button
-              type="button"
-              onClick={toggleNotes}
-              className={
-                isNotesOpen || hasNotes
-                  ? 'inline-flex items-center justify-center rounded-lg p-2 text-yellow-500 bg-yellow-500/10 border border-yellow-500/40 hover:bg-yellow-500/15 transition duration-200'
-                  : 'inline-flex items-center justify-center rounded-lg p-2 text-neutral-400 bg-black/30 border border-neutral-700 hover:border-yellow-500/60 hover:text-yellow-500 transition duration-200'
-              }
-            >
-              <MessageSquare size={14} />
-            </button>
-            <button
-              type="button"
-              disabled={!canDone}
-              onClick={() => {
-                const nextDone = !done;
-                updateLog(key, {
-                  done: nextDone,
-                  reps: String(total || ''),
-                  rest_pause: { ...rp, activation_reps: activation ?? null, mini_reps: minis },
-                  advanced_config: cfg ?? log?.advanced_config ?? null,
-                });
-                if (nextDone && restTime && restTime > 0) startTimer(restTime, { kind: 'rest', key });
-              }}
-              className={
-                canDone
-                  ? done
-                    ? 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                    : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700'
-                  : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800/40 border border-neutral-800 text-neutral-500 font-bold cursor-not-allowed'
-              }
-            >
-              <Check size={16} />
-              <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-            </button>
-          </div>
-        </div>
-
-        {!canDone && (
-          <div className="pl-12 text-[11px] text-neutral-500 font-semibold">
-            {miniSets > 0 ? 'Preencha Ativação e Minis para concluir.' : 'Preencha Ativação para concluir.'}
-          </div>
-        )}
-
-        <div className="pl-12 text-[11px] text-neutral-500 font-semibold">Preencha Ativação e Minis no modal para registrar e usar o timer.</div>
-        {isNotesOpen && (
-          <textarea
-            value={notesValue}
-            onChange={(e) => {
-              const v = e?.target?.value ?? '';
-              updateLog(key, { notes: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-            }}
-            placeholder="Observações da série"
-            rows={2}
-            className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-          />
-        )}
-      </div>
-    );
-  };
-
-  const renderClusterSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const cfg = getPlanConfig(ex, setIdx);
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const restTime = resolveRestTimeSeconds(ex);
-    const cluster = isObject(log?.cluster) ? log.cluster : {};
-
-    const totalRepsPlanned = parseTrainingNumber(cfg?.total_reps);
-    const clusterSize = parseTrainingNumber(cfg?.cluster_size);
-    const intra = parseTrainingNumber(cfg?.intra_rest_sec) ?? 15;
-    let plannedBlocks = buildPlannedBlocks(totalRepsPlanned, clusterSize);
-    let restsByGap = plannedBlocks.length > 1 ? Array.from({ length: plannedBlocks.length - 1 }).map(() => intra) : [];
-    if (!plannedBlocks.length) {
-      const candidates = [
-        plannedSet?.reps,
-        plannedSet?.notes,
-        ex?.reps,
-        ex?.notes,
-      ]
-        .map((v) => String(v ?? '').trim())
-        .filter(Boolean);
-      let parsed = null;
-      for (const c of candidates) {
-        const p = parseClusterPrescription(c);
-        if (p.blocks.length) {
-          parsed = p;
-          break;
-        }
-      }
-      if (!parsed) parsed = { blocks: [], rests: [] };
-      if (parsed.blocks.length) {
-        plannedBlocks = parsed.blocks;
-        restsByGap = parsed.rests;
-      }
-      if (!plannedBlocks.length) {
-        const savedPlannedBlocks = Array.isArray(cluster?.plannedBlocks) ? cluster.plannedBlocks : [];
-        const safe = savedPlannedBlocks.map((n) => parseTrainingNumber(n)).filter((n) => Number.isFinite(n) && n > 0);
-        if (safe.length) {
-          plannedBlocks = safe;
-          restsByGap = safe.length > 1 ? Array.from({ length: safe.length - 1 }).map(() => intra) : [];
-        }
-      }
-    }
-    const blocksRaw = Array.isArray(cluster?.blocks) ? cluster.blocks : [];
-    const blocksDetailedRaw = Array.isArray(cluster?.blocksDetailed) ? cluster.blocksDetailed : [];
-    const blocks = plannedBlocks.map((_, idx) => {
-      const d = blocksDetailedRaw?.[idx];
-      const fromDetailed = isObject(d) ? parseTrainingNumber(d?.reps) : null;
-      const v = fromDetailed != null ? fromDetailed : blocksRaw?.[idx];
-      const n = parseTrainingNumber(v);
-      return n;
-    });
-
-    const total = blocks.reduce((acc, v) => acc + (v ?? 0), 0);
-    const done = !!log?.done;
-    const canDone = plannedBlocks.length > 0 && blocks.every((v) => Number.isFinite(v) && v > 0);
-
-    const notation = plannedBlocks.length ? plannedBlocks.join('+') : '';
-    const notesValue = String(log?.notes ?? '');
-    const hasNotes = notesValue.trim().length > 0;
-    const isNotesOpen = openNotesKeys.has(key);
-
-    const toggleNotes = () => {
-      setOpenNotesKeys((prev) => {
-        const next = new Set(prev);
-        if (next.has(key)) next.delete(key);
-        else next.add(key);
-        return next;
-      });
-    };
-
-    return (
-      <div key={key} className="space-y-2">
-        <div className="flex items-center gap-2">
-          <div className="w-10 text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-          <button
-            type="button"
-            onClick={() => {
-              const baseWeight = String(log?.weight ?? cfg?.weight ?? '');
-              const baseRpe = String(log?.rpe ?? '').trim();
-              const planned = { total_reps: totalRepsPlanned ?? null, cluster_size: clusterSize ?? null, intra_rest_sec: intra ?? null };
-              const blocksDetailed = Array.isArray(cluster?.blocksDetailed) ? cluster.blocksDetailed : [];
-              const initialBlocks = plannedBlocks.map((p, idx) => {
-                const existing = blocksDetailed?.[idx];
-                const w = isObject(existing) && existing?.weight != null ? String(existing.weight) : baseWeight;
-                const r = isObject(existing) ? parseTrainingNumber(existing?.reps) : parseTrainingNumber(blocksRaw?.[idx]);
-                return { planned: p, weight: w, reps: r != null && r > 0 ? r : null };
-              });
-              setClusterModal({
-                key,
-                planned,
-                plannedBlocks,
-                intra,
-                restsByGap,
-                restTime,
-                cfg: cfg ?? null,
-                baseWeight,
-                blocks: initialBlocks,
-                rpe: baseRpe,
-              });
-            }}
-            className="w-24 bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none hover:border-yellow-500/60 hover:text-yellow-500 transition-colors inline-flex items-center justify-center gap-2"
-          >
-            <Pencil size={14} />
-            <span className="text-xs font-black">Abrir</span>
-          </button>
-          <div className="flex items-center gap-2 flex-1 min-w-0">
-            <span className="inline-flex items-center rounded-full px-2 py-1 text-[10px] uppercase tracking-wide font-black text-yellow-500 bg-yellow-500/10 border border-yellow-500/20 shrink-0 whitespace-nowrap">
-              CLUSTER
-            </span>
-            <span className="text-xs text-neutral-400 truncate">
-              {notation ? `(${notation})` : ''} • Intra {restsByGap?.[0] || intra || 0}s • Total: {total || 0} reps
-            </span>
-          </div>
-          <button
-            type="button"
-            onClick={toggleNotes}
-            className={
-              isNotesOpen || hasNotes
-                ? 'inline-flex items-center justify-center rounded-lg p-2 text-yellow-500 bg-yellow-500/10 border border-yellow-500/40 hover:bg-yellow-500/15 transition duration-200'
-                : 'inline-flex items-center justify-center rounded-lg p-2 text-neutral-400 bg-black/30 border border-neutral-700 hover:border-yellow-500/60 hover:text-yellow-500 transition duration-200'
-            }
-          >
-            <MessageSquare size={14} />
-          </button>
-          <button
-            type="button"
-            disabled={!canDone}
-            onClick={() => {
-              const nextDone = !done;
-              updateLog(key, {
-                done: nextDone,
-                reps: String(total || ''),
-                cluster: {
-                  planned: { total_reps: totalRepsPlanned ?? null, cluster_size: clusterSize ?? null, intra_rest_sec: intra ?? null },
-                  blocks,
-                  blocksDetailed: Array.isArray(cluster?.blocksDetailed) ? cluster.blocksDetailed : null,
-                },
-                rpe: log?.rpe ?? null,
-                advanced_config: cfg ?? log?.advanced_config ?? null,
-              });
-              if (nextDone && restTime && restTime > 0) startTimer(restTime, { kind: 'rest', key });
-            }}
-            className={
-              canDone
-                ? done
-                  ? 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                  : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700'
-                : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800/40 border border-neutral-800 text-neutral-500 font-bold cursor-not-allowed'
-            }
-          >
-            <Check size={16} />
-            <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-          </button>
-        </div>
-
-        {!canDone && plannedBlocks.length > 0 && (
-          <div className="pl-12 text-[11px] text-neutral-500 font-semibold">
-            Preencha todos os blocos para concluir.
-          </div>
-        )}
-
-        {plannedBlocks.length > 0 ? (
-          <div className="pl-12 text-[11px] text-neutral-500 font-semibold">
-            Preencha os blocos no modal para registrar kg, reps e descanso.
-          </div>
-        ) : null}
-        {isNotesOpen && (
-          <textarea
-            value={notesValue}
-            onChange={(e) => {
-              const v = e?.target?.value ?? '';
-              updateLog(key, { notes: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-            }}
-            placeholder="Observações da série"
-            rows={2}
-            className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-          />
-        )}
-      </div>
-    );
-  };
-
-  const renderDropSetSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const cfgRaw = plannedSet?.advanced_config ?? plannedSet?.advancedConfig ?? null;
-    const stagesPlannedRaw = Array.isArray(cfgRaw) ? cfgRaw : [];
-    const ds = isObject(log?.drop_set) ? log.drop_set : {};
-    const stagesSavedRaw = Array.isArray(ds?.stages) ? ds.stages : [];
-    const stagesCount = Math.max(stagesPlannedRaw.length, stagesSavedRaw.length);
-    if (!stagesCount) return renderNormalSet(ex, exIdx, setIdx);
-
-    const auto = plannedSet?.it_auto && typeof plannedSet.it_auto === 'object' ? plannedSet.it_auto : null;
-    const modeLabel = String(auto?.label || '').trim() || 'Drop';
-
-    const stages = Array.from({ length: stagesCount }).map((_, idx) => {
-      const saved = stagesSavedRaw?.[idx] && typeof stagesSavedRaw[idx] === 'object' ? stagesSavedRaw[idx] : null;
-      const planned = stagesPlannedRaw?.[idx] && typeof stagesPlannedRaw[idx] === 'object' ? stagesPlannedRaw[idx] : null;
-      const weight = String(saved?.weight ?? planned?.weight ?? '').trim();
-      const reps = parseTrainingNumber(saved?.reps ?? planned?.reps) ?? null;
-      return { weight, reps };
-    });
-
-    const total = stages.reduce((acc, s) => acc + (parseTrainingNumber(s?.reps) ?? 0), 0);
-    const done = !!log?.done;
-    const canDone = stages.every((s) => String(s?.weight || '').trim() && (parseTrainingNumber(s?.reps) ?? 0) > 0);
-
-    const notesValue = String(log?.notes ?? '');
-    const hasNotes = notesValue.trim().length > 0;
-    const isNotesOpen = openNotesKeys.has(key);
-
-    const toggleNotes = () => {
-      setOpenNotesKeys((prev) => {
-        const next = new Set(prev);
-        if (next.has(key)) next.delete(key);
-        else next.add(key);
-        return next;
-      });
-    };
-
-    return (
-      <div key={key} className="space-y-2">
-        <div className="flex items-center gap-2">
-          <div className="w-10 text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-          <button
-            type="button"
-            onClick={() => {
-              const baseStages = stages.map((s) => ({
-                weight: String(s?.weight ?? '').trim(),
-                reps: parseTrainingNumber(s?.reps) ?? null,
-              }));
-              setDropSetModal({ key, label: modeLabel, stages: baseStages, error: '' });
-            }}
-            className="w-24 bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none hover:border-yellow-500/60 hover:text-yellow-500 transition-colors inline-flex items-center justify-center gap-2"
-          >
-            <Pencil size={14} />
-            <span className="text-xs font-black">Abrir</span>
-          </button>
-          <div className="flex items-center gap-2 flex-1 min-w-0">
-            <span className="text-[10px] uppercase tracking-widest font-black text-yellow-500">{modeLabel || 'Drop'}</span>
-            <span className="text-xs text-neutral-400 truncate">Etapas {stagesCount} • Total: {total || 0} reps</span>
-          </div>
-          <button
-            type="button"
-            onClick={toggleNotes}
-            className={
-              isNotesOpen || hasNotes
-                ? 'inline-flex items-center justify-center rounded-lg p-2 text-yellow-500 bg-yellow-500/10 border border-yellow-500/40 hover:bg-yellow-500/15 transition duration-200'
-                : 'inline-flex items-center justify-center rounded-lg p-2 text-neutral-400 bg-black/30 border border-neutral-700 hover:border-yellow-500/60 hover:text-yellow-500 transition duration-200'
-            }
-          >
-            <MessageSquare size={14} />
-          </button>
-          <button
-            type="button"
-            disabled={!canDone}
-            onClick={() => {
-              const nextDone = !done;
-              const lastWeight = String(stages?.[stages.length - 1]?.weight || '').trim();
-              const stageOut = stages.map((s) => ({
-                weight: String(s?.weight ?? '').trim(),
-                reps: parseTrainingNumber(s?.reps) ?? null,
-              }));
-              updateLog(key, {
-                done: nextDone,
-                weight: lastWeight,
-                reps: String(total || ''),
-                drop_set: { stages: stageOut },
-              });
-            }}
-            className={
-              canDone
-                ? done
-                  ? 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                  : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700'
-                : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800/40 border border-neutral-800 text-neutral-500 font-bold cursor-not-allowed'
-            }
-          >
-            <Check size={16} />
-            <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-          </button>
-        </div>
-
-        {!canDone && (
-          <div className="pl-12 text-[11px] text-neutral-500 font-semibold">
-            Preencha peso e reps em todas as etapas no modal para concluir.
-          </div>
-        )}
-
-        {isNotesOpen && (
-          <textarea
-            value={notesValue}
-            onChange={(e) => {
-              const v = e?.target?.value ?? '';
-              updateLog(key, { notes: v });
-            }}
-            placeholder="Observações da série"
-            rows={2}
-            className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-          />
-        )}
-      </div>
-    );
-  };
-
-  const renderSet = (ex, exIdx, setIdx) => {
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const rawCfg = plannedSet?.advanced_config ?? plannedSet?.advancedConfig ?? null;
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const hasDropStages = isObject(log?.drop_set) && Array.isArray(log?.drop_set?.stages) && log.drop_set.stages.length > 0;
-    if (Array.isArray(rawCfg) || hasDropStages) return renderDropSetSet(ex, exIdx, setIdx);
-
-    const cfg = getPlanConfig(ex, setIdx);
-    const method = String(ex?.method || '').trim();
-    const isCluster = method === 'Cluster' || isClusterConfig(cfg);
-    const isRestPause = method === 'Rest-Pause' || isRestPauseConfig(cfg);
-    if (isCluster) return renderClusterSet(ex, exIdx, setIdx);
-    if (isRestPause) return renderRestPauseSet(ex, exIdx, setIdx);
-    return renderNormalSet(ex, exIdx, setIdx);
-  };
-
-  const renderExercise = (ex, exIdx) => {
-    const name = String(ex?.name || '').trim() || `Exercício ${exIdx + 1}`;
-    const observation = String(ex?.notes || '').trim();
-    const setsHeader = Math.max(0, Number.parseInt(String(ex?.sets ?? '0'), 10) || 0);
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const setsCount = Math.max(setsHeader, Array.isArray(sdArr) ? sdArr.length : 0);
-    const collapsedNow = collapsed.has(exIdx);
-    const restTime = resolveRestTimeSeconds(ex);
-    const videoUrl = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-    const aiSuggestion = (() => {
-      const first = Array.isArray(sdArr) && sdArr.length > 0 ? sdArr[0] : null;
-      const cfg = first && typeof first === 'object' ? (first.advanced_config ?? first.advancedConfig ?? null) : null;
-      const sug = cfg && typeof cfg === 'object' ? (cfg.ai_suggestion ?? cfg.aiSuggestion ?? null) : null;
-      if (!sug || typeof sug !== 'object') return null;
-      const rec = String(sug?.recommendation || '').trim();
-      const reason = String(sug?.reason || '').trim();
-      if (!rec) return null;
-      return { recommendation: rec, reason };
-    })();
-    const aiKey = `ai-${exIdx}`;
-    const aiOpen = openAiHints.has(aiKey);
-
-    return (
-      <div key={`ex-${exIdx}`} className="rounded-xl bg-neutral-800 border border-neutral-700 p-4">
-        <div
-          role="button"
-          tabIndex={0}
-          aria-expanded={!collapsedNow}
-          onClick={() => toggleCollapse(exIdx)}
-          onKeyDown={(e) => {
-            if (e.key === 'Enter' || e.key === ' ') {
-              e.preventDefault();
-              toggleCollapse(exIdx);
-            }
-          }}
-          className="w-full flex items-start justify-between gap-3"
-        >
-          <div className="min-w-0 text-left">
-            <div className="flex items-center gap-2">
-              <Dumbbell size={16} className="text-yellow-500" />
-              <h3 className="font-black text-white truncate">{name}</h3>
-            </div>
-            <div className="mt-1 flex items-center gap-2 text-xs text-neutral-400">
-              <span className="font-mono">{setsCount} sets</span>
-              <span className="opacity-30">•</span>
-              <span className="font-mono">{restTime ? `${restTime}s` : '-'}</span>
-              <span className="opacity-30">•</span>
-              <span className="truncate">{String(ex?.method || 'Normal')}</span>
-              {aiSuggestion ? (
-                <>
-                  <span className="opacity-30">•</span>
-                  <button
-                    type="button"
-                    onClick={(e) => {
-                      try {
-                        e.preventDefault();
-                        e.stopPropagation();
-                      } catch {}
-                      setOpenAiHints((prev) => {
-                        const next = new Set(prev);
-                        if (next.has(aiKey)) next.delete(aiKey);
-                        else next.add(aiKey);
-                        return next;
-                      });
-                    }}
-                    className="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-neutral-900/40 border border-neutral-800 text-neutral-300 hover:text-white hover:bg-neutral-900 transition-colors max-w-[260px]"
-                    aria-label="Sugestão da IA"
-                  >
-                    <Sparkles size={12} className="text-yellow-500" />
-                    <span className="truncate">IA: {aiSuggestion.recommendation}</span>
-                  </button>
-                </>
-              ) : null}
-            </div>
-            {aiSuggestion && aiOpen ? (
-              <div className="mt-2 rounded-xl bg-neutral-950/40 border border-neutral-800 px-3 py-2">
-                <div className="text-sm text-neutral-200 whitespace-pre-wrap leading-snug">
-                  {aiSuggestion.recommendation}
-                  {aiSuggestion.reason ? `\n${aiSuggestion.reason}` : ''}
-                </div>
-              </div>
-            ) : null}
-            {observation ? (
-              <div className="mt-2 rounded-xl bg-neutral-900/50 border border-yellow-500/20 px-3 py-2">
-                <div className="text-sm text-neutral-200 whitespace-pre-wrap leading-snug">{observation}</div>
-              </div>
-            ) : null}
-          </div>
-          <div className="mt-1 flex items-center gap-2 text-neutral-400">
-            {videoUrl ? (
-              <button
-                type="button"
-                onClick={(e) => {
-                  try {
-                    e.preventDefault();
-                    e.stopPropagation();
-                  } catch {}
-                  try {
-                    window.open(videoUrl, '_blank', 'noopener,noreferrer');
-                  } catch {}
-                }}
-                className="h-9 w-9 inline-flex flex-col items-center justify-center rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 hover:bg-neutral-800 transition-colors active:scale-95"
-                title="Ver vídeo"
-                aria-label="Ver vídeo"
-              >
-                <Play size={16} />
-                <span className="mt-0.5 text-[10px] leading-none text-neutral-400 opacity-60">Vídeo</span>
-              </button>
-            ) : null}
-            {collapsedNow ? <ChevronDown size={18} /> : <ChevronUp size={18} />}
-          </div>
-        </div>
-
-        {!collapsedNow && (
-          <div className="mt-4 space-y-2">
-            <div className="grid grid-cols-2 gap-2">
-              <ExecutionVideoCapture
-                variant="compact"
-                exerciseName={name}
-                workoutId={workout?.id || null}
-                exerciseId={ex?.id || ex?.exercise_id || null}
-                exerciseLibraryId={ex?.exercise_library_id || null}
-              />
-              <button
-                type="button"
-                onClick={() => {
-                  const pickWeight = () => {
-                    for (let i = 0; i < setsCount; i += 1) {
-                      const w = String(getLog(`${exIdx}-${i}`)?.weight ?? '').trim();
-                      if (w) return w;
-                    }
-                    const cfg0 = getPlanConfig(ex, 0);
-                    const planned = String(cfg0?.weight ?? '').trim();
-                    if (planned) return planned;
-                    return '';
-                  };
-                  const w = pickWeight();
-                  if (!w) {
-                    try {
-                      window.alert('Preencha pelo menos 1 série com peso antes de linkar.');
-                    } catch {}
-                    return;
-                  }
-                  for (let i = 0; i < setsCount; i += 1) {
-                    const key = `${exIdx}-${i}`;
-                    const existing = getLog(key);
-                    const cfg = getPlanConfig(ex, i);
-                    updateLog(key, {
-                      weight: w,
-                      advanced_config: existing?.advanced_config ?? cfg ?? null,
-                    });
-                  }
-                }}
-                className="w-full min-h-[44px] inline-flex items-center justify-center gap-2 rounded-xl bg-black/30 border border-neutral-800 text-neutral-200 font-black hover:bg-neutral-900 active:scale-95 transition-transform"
-              >
-                <Link2 size={16} className="text-yellow-500" />
-                <span className="text-sm">Pesos</span>
-              </button>
-            </div>
-            {Array.from({ length: setsCount }).map((_, setIdx) => renderSet(ex, exIdx, setIdx))}
-            <button
-              type="button"
-              onClick={() => addExtraSetToExercise(exIdx)}
-              className="w-full min-h-[44px] inline-flex items-center justify-center gap-2 rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 font-black hover:bg-neutral-800 active:scale-95 transition-transform"
-            >
-              <Plus size={16} />
-              <span className="text-sm">Série extra</span>
-            </button>
-          </div>
-        )}
-      </div>
-    );
-  };
-
-  const saveClusterModal = async () => {
-    const m = clusterModal && typeof clusterModal === 'object' ? clusterModal : null;
-    const key = String(m?.key || '').trim();
-    if (!key) {
-      setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Série inválida. Feche e abra novamente.' } : prev));
-      return;
-    }
-    const blocks = Array.isArray(m?.blocks) ? m.blocks : [];
-    if (!blocks.length) {
-      setClusterModal((prev) =>
-        prev && typeof prev === 'object'
-          ? { ...prev, error: 'Nenhum bloco encontrado. Verifique a configuração (total reps, cluster size e descanso).' }
-          : prev,
-      );
-      return;
-    }
-    const planned = m?.planned && typeof m.planned === 'object' ? m.planned : {};
-    const intra = Number(m?.intra);
-    const restsByGap = Array.isArray(m?.restsByGap) ? m.restsByGap : [];
-    const done = !!getLog(key)?.done;
-    const baseAdvanced = m?.cfg ?? getLog(key)?.advanced_config ?? null;
-
-    const blocksDetailed = [];
-    const repsBlocks = [];
-    let total = 0;
-    for (let i = 0; i < blocks.length; i += 1) {
-      const b = blocks[i] && typeof blocks[i] === 'object' ? blocks[i] : {};
-      const weight = String(b.weight ?? '').trim();
-      const reps = parseTrainingNumber(b.reps);
-      if (!weight) {
-        setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha o peso (kg) em todos os blocos.' } : prev));
-        return;
-      }
-      if (!reps || reps <= 0) {
-        setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps em todos os blocos.' } : prev));
-        return;
-      }
-      const gapRest = restsByGap?.[i];
-      const restSecAfter = i < blocks.length - 1 ? (Number.isFinite(Number(gapRest)) ? Number(gapRest) : Number.isFinite(intra) ? intra : null) : null;
-      blocksDetailed.push({ weight, reps, restSecAfter });
-      repsBlocks.push(reps);
-      total += reps;
-    }
-
-    const lastWeight = String(blocksDetailed[blocksDetailed.length - 1]?.weight ?? '').trim();
-    const rpe = String(m?.rpe ?? '').trim();
-
-    updateLog(key, {
-      done,
-      weight: lastWeight,
-      reps: String(total || ''),
-      rpe: rpe || '',
-      cluster: {
-        planned: {
-          total_reps: planned?.total_reps ?? null,
-          cluster_size: planned?.cluster_size ?? null,
-          cluster_blocks_count: planned?.cluster_blocks_count ?? null,
-          intra_rest_sec: planned?.intra_rest_sec ?? null,
-        },
-        plannedBlocks: Array.isArray(m?.plannedBlocks) ? m.plannedBlocks : null,
-        blocks: repsBlocks,
-        blocksDetailed,
-      },
-      advanced_config: baseAdvanced,
-    });
-    setClusterModal(null);
-  };
-
-  const saveRestPauseModal = async () => {
-    const m = restPauseModal && typeof restPauseModal === 'object' ? restPauseModal : null;
-    const key = String(m?.key || '').trim();
-    if (!key) {
-      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Série inválida. Feche e abra novamente.' } : prev));
-      return;
-    }
-
-    const weight = String(m?.weight ?? '').trim();
-    if (!weight) {
-      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha o peso (kg).' } : prev));
-      return;
-    }
-
-    const activationReps = parseTrainingNumber(m?.activationReps);
-    if (!activationReps || activationReps <= 0) {
-      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps de ativação.' } : prev));
-      return;
-    }
-
-    const minis = Array.isArray(m?.minis) ? m.minis : [];
-    const miniReps = minis.map((v) => {
-      const n = parseTrainingNumber(v);
-      return n != null && n > 0 ? n : null;
-    });
-    if (miniReps.some((v) => v == null)) {
-      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps de todos os minis.' } : prev));
-      return;
-    }
-
-    const pauseSec = parseTrainingNumber(m?.pauseSec) ?? 15;
-    const rpe = String(m?.rpe ?? '').trim();
-    const cfg = m?.cfg ?? getLog(key)?.advanced_config ?? null;
-
-    const total = (activationReps ?? 0) + miniReps.reduce((acc, v) => acc + (v ?? 0), 0);
-    updateLog(key, {
-      done: !!getLog(key)?.done,
-      weight,
-      reps: String(total || ''),
-      rpe: rpe || '',
-      rest_pause: {
-        activation_reps: activationReps,
-        mini_reps: miniReps,
-        rest_time_sec: pauseSec,
-        planned_mini_sets: miniReps.length,
-      },
-      advanced_config: cfg,
-    });
-    setRestPauseModal(null);
-  };
-
-  const saveDropSetModal = async () => {
-    const m = dropSetModal && typeof dropSetModal === 'object' ? dropSetModal : null;
-    const key = String(m?.key || '').trim();
-    if (!key) {
-      setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Série inválida. Feche e abra novamente.' } : prev));
-      return;
-    }
-    const stagesRaw = Array.isArray(m?.stages) ? m.stages : [];
-    if (stagesRaw.length < 2) {
-      setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Defina pelo menos 2 etapas.' } : prev));
-      return;
-    }
-
-    const stages = [];
-    let total = 0;
-    for (let i = 0; i < stagesRaw.length; i += 1) {
-      const s = stagesRaw[i] && typeof stagesRaw[i] === 'object' ? stagesRaw[i] : {};
-      const weight = String(s?.weight ?? '').trim();
-      const reps = parseTrainingNumber(s?.reps);
-      if (!weight) {
-        setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha o peso (kg) em todas as etapas.' } : prev));
-        return;
-      }
-      if (!reps || reps <= 0) {
-        setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps em todas as etapas.' } : prev));
-        return;
-      }
-      stages.push({ weight, reps });
-      total += reps;
-    }
-
-    const lastWeight = String(stages[stages.length - 1]?.weight ?? '').trim();
-    updateLog(key, {
-      done: !!getLog(key)?.done,
-      weight: lastWeight,
-      reps: String(total || ''),
-      drop_set: { stages },
-    });
-    setDropSetModal(null);
-  };
-
-  if (!session || !workout) {
-    return (
-      <div className="min-h-screen bg-neutral-900 text-white p-6">
-        <div className="max-w-lg mx-auto rounded-xl bg-neutral-800 border border-neutral-700 p-6">
-          <div className="text-sm text-neutral-300">Sessão inválida.</div>
-          <div className="mt-4">
-            <BackButton onClick={props?.onBack} withNavigation={false} />
-          </div>
-        </div>
-      </div>
-    );
-  }
-
-  return (
-    <div className="min-h-screen bg-neutral-900 text-white flex flex-col">
-      <div className="sticky top-0 z-40 bg-neutral-950 border-b border-neutral-800 px-4 md:px-6 py-4 pt-safe">
-        <div className="max-w-6xl mx-auto">
-          <div className="flex items-center justify-between gap-3">
-            <div className="flex items-center gap-2">
-            <BackButton onClick={props?.onBack} withNavigation={false} />
-            <button
-              type="button"
-              onClick={() => {
-                try {
-                  if (typeof props?.onEditWorkout === 'function') props.onEditWorkout(workout);
-                } catch {}
-              }}
-              className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 hover:bg-neutral-800 transition-colors active:scale-95"
-              title="Editar treino"
-            >
-              <Pencil size={16} className="text-yellow-500" />
-              <span className="text-sm font-black hidden sm:inline">Editar</span>
-            </button>
-            <button
-              type="button"
-              onClick={() => {
-                try {
-                  if (typeof props?.onAddExercise === 'function') {
-                    props.onAddExercise();
-                    return;
-                  }
-                  if (typeof props?.onEditWorkout === 'function') props.onEditWorkout(workout);
-                } catch {}
-              }}
-              className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500 text-black hover:bg-yellow-400 transition-colors active:scale-95"
-              title="Adicionar exercício extra"
-            >
-              <Plus size={16} />
-              <span className="text-sm font-black hidden sm:inline">Exercício</span>
-            </button>
-            <button
-              type="button"
-              onClick={() => setInviteOpen(true)}
-              className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 hover:text-yellow-400 hover:bg-neutral-800 transition-colors active:scale-95"
-              title="Convidar para treinar junto"
-            >
-              <UserPlus size={16} />
-              <span className="text-sm font-black hidden sm:inline">Convidar</span>
-            </button>
-            {teamworkV2Enabled ? (
-              <button
-                type="button"
-                onClick={shareTeamJoinLink}
-                className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 hover:bg-neutral-800 transition-colors active:scale-95"
-                title="Convite por link/QR"
-              >
-                <Link2 size={16} className="text-yellow-500" />
-                <span className="text-sm font-black hidden sm:inline">Link</span>
-              </button>
-            ) : null}
-            </div>
-            <div className="text-xs text-neutral-400 flex items-center justify-end gap-2">
-              <Clock size={14} className="text-yellow-500" />
-              <span className="font-mono text-yellow-500">{formatElapsed(elapsedSeconds)}</span>
-            </div>
-          </div>
-          {teamworkV2Enabled && teamSession?.id ? (
-            <div className="mt-2 px-1 flex items-center justify-center gap-2">
-              <div className="px-3 py-1.5 rounded-xl bg-neutral-900 border border-neutral-800 text-[11px] font-black uppercase tracking-widest text-neutral-200">
-                Equipe: {(Array.isArray(teamSession?.participants) ? teamSession.participants.length : 1)}
-              </div>
-            </div>
-          ) : null}
-          {teamworkV2Enabled ? <TeamRoomCard teamSession={teamSession} presence={presence} /> : null}
-          <div className="mt-2 px-1">
-            <div className="font-black text-white text-center leading-tight break-words">
-              {String(workout?.title || 'Treino')}
-            </div>
-          </div>
-        </div>
-      </div>
-
-      <InviteManager
-        isOpen={inviteOpen}
-        onClose={() => setInviteOpen(false)}
-        onInvite={async (targetUser) => {
-          try {
-            const payloadWorkout = workout && typeof workout === 'object'
-              ? { ...workout, exercises: Array.isArray(workout?.exercises) ? workout.exercises : [] }
-              : { title: 'Treino', exercises: [] };
-            await sendInvite(targetUser, payloadWorkout);
-          } catch (e) {
-            const msg = e?.message || String(e || '');
-            await alert('Falha ao enviar convite: ' + msg);
-          }
-        }}
-      />
-
-      {clusterModal && (
-        <div
-          className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => setClusterModal(null)}
-        >
-          <div
-            className="w-full max-w-2xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-            onClick={(e) => e.stopPropagation()}
-          >
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Cluster</div>
-                <div className="text-white font-black text-lg truncate">Preencher blocos</div>
-                <div className="text-xs text-neutral-400 truncate">
-                  {Array.isArray(clusterModal?.plannedBlocks) ? `${clusterModal.plannedBlocks.length} blocos` : 'Blocos'}
-                  {Array.isArray(clusterModal?.restsByGap) && clusterModal.restsByGap.length
-                    ? ` • descanso ${clusterModal.restsByGap[0]}s`
-                    : clusterModal?.intra
-                      ? ` • descanso ${clusterModal.intra}s`
-                      : ''}
-                </div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setClusterModal(null)}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-
-            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-              {clusterModal?.error ? (
-                <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/10 p-3 text-sm text-neutral-200">
-                  {String(clusterModal.error)}
-                </div>
-              ) : null}
-              {Array.isArray(clusterModal?.blocks) && clusterModal.blocks.length > 0 ? (
-                <div className="flex items-center justify-end">
-                  <button
-                    type="button"
-                    onClick={() => {
-                      const pickWeight = () => {
-                        const blocks = Array.isArray(clusterModal?.blocks) ? clusterModal.blocks : []
-                        for (const b of blocks) {
-                          const w = String(b?.weight ?? '').trim()
-                          if (w) return w
-                        }
-                        return ''
-                      }
-                      const w = pickWeight()
-                      if (!w) {
-                        try {
-                          window.alert('Preencha pelo menos 1 bloco com peso antes de linkar.')
-                        } catch {}
-                        return
-                      }
-                      setClusterModal((prev) => {
-                        if (!prev || typeof prev !== 'object') return prev
-                        const blocks = Array.isArray(prev.blocks) ? prev.blocks : []
-                        const nextBlocks = blocks.map((b) => {
-                          const cur = b && typeof b === 'object' ? b : {}
-                          return { ...cur, weight: w }
-                        })
-                        return { ...prev, blocks: nextBlocks, error: '' }
-                      })
-                    }}
-                    className="min-h-[36px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 inline-flex items-center gap-2"
-                  >
-                    <Link2 size={14} className="text-yellow-500" />
-                    Linkar pesos
-                  </button>
-                </div>
-              ) : null}
-              {Array.isArray(clusterModal?.blocks) && clusterModal.blocks.length === 0 ? (
-                <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                  <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Configurar Cluster</div>
-                  <div className="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
-                    <input
-                      inputMode="decimal"
-                      value={String(clusterModal?.planned?.total_reps ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return { ...prev, planned: { ...planned, total_reps: v ?? null }, error: '' };
-                        });
-                      }}
-                      placeholder="Total reps (ex.: 12)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                    <input
-                      inputMode="decimal"
-                      value={String(clusterModal?.planned?.cluster_blocks_count ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return { ...prev, planned: { ...planned, cluster_blocks_count: v ?? null }, error: '' };
-                        });
-                      }}
-                      placeholder="Blocos (ex.: 3)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                    <input
-                      inputMode="decimal"
-                      value={String(clusterModal?.planned?.intra_rest_sec ?? clusterModal?.intra ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return { ...prev, planned: { ...planned, intra_rest_sec: v ?? null }, intra: v ?? prev.intra ?? 15, error: '' };
-                        });
-                      }}
-                      placeholder="Descanso (s) (ex.: 15)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                  </div>
-                  <div className="mt-2 flex items-center justify-end">
-                    <button
-                      type="button"
-                      onClick={() => {
-                        const total = parseTrainingNumber(clusterModal?.planned?.total_reps);
-                        const blocksCount = parseTrainingNumber(clusterModal?.planned?.cluster_blocks_count);
-                        const intra = parseTrainingNumber(clusterModal?.planned?.intra_rest_sec) ?? parseTrainingNumber(clusterModal?.intra) ?? 15;
-                        const plannedBlocks = buildBlocksByCount(total, blocksCount);
-                        if (!plannedBlocks.length) {
-                          setClusterModal((prev) =>
-                            prev && typeof prev === 'object'
-                              ? { ...prev, error: 'Configuração inválida. Preencha total reps e quantidade de blocos.' }
-                              : prev,
-                          );
-                          return;
-                        }
-                        const restsByGap = plannedBlocks.length > 1 ? Array.from({ length: plannedBlocks.length - 1 }).map(() => intra) : [];
-                        const baseWeight = String(clusterModal?.baseWeight ?? '').trim();
-                        const blocks = plannedBlocks.map((p) => ({ planned: p, weight: baseWeight, reps: null }));
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return {
-                            ...prev,
-                            intra,
-                            planned: { ...planned, total_reps: total ?? null, cluster_blocks_count: blocksCount ?? null, intra_rest_sec: intra ?? null },
-                            plannedBlocks,
-                            restsByGap,
-                            blocks,
-                            error: '',
-                          };
-                        });
-                      }}
-                      className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-                    >
-                      Gerar blocos
-                    </button>
-                  </div>
-                </div>
-              ) : null}
-              {Array.isArray(clusterModal?.blocks) &&
-                clusterModal.blocks.map((b, idx) => {
-                  const planned = b?.planned ?? null;
-                  const repsValue = b?.reps == null ? '' : String(b.reps);
-                  const weightValue = String(b?.weight ?? '');
-                  const isLast = idx >= clusterModal.blocks.length - 1;
-                  const restSec = Array.isArray(clusterModal?.restsByGap) ? Number(clusterModal.restsByGap?.[idx]) : Number(clusterModal?.intra);
-                  const safeRestSec = Number.isFinite(restSec) && restSec > 0 ? restSec : 0;
-                  return (
-                    <div key={`cluster-block-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3 relative">
-                      <div className="flex items-center justify-between gap-2">
-                        <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Bloco {idx + 1}</div>
-                        {planned ? <div className="text-[10px] font-mono text-neutral-500">plan {planned}</div> : <div />}
-                      </div>
-                      {!isLast && safeRestSec ? (
-                        <button
-                          type="button"
-                          onClick={() => {
-                            startTimer(safeRestSec, { kind: 'cluster', key: clusterModal?.key, blockIndex: idx });
-                          }}
-                          className="absolute top-3 right-3 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 active:scale-95 transition-transform z-10"
-                          aria-label={`Iniciar descanso ${safeRestSec}s`}
-                        >
-                          <Clock size={14} className="text-yellow-500" />
-                          <span className="text-xs font-black">{safeRestSec}s</span>
-                        </button>
-                      ) : null}
-                      <div className="mt-2 grid grid-cols-2 gap-2">
-                        <input
-                          inputMode="decimal"
-                          value={weightValue}
-                          onChange={(e) => {
-                            const v = e?.target?.value ?? '';
-                            setClusterModal((prev) => {
-                              if (!prev || typeof prev !== 'object') return prev;
-                              const nextBlocks = Array.isArray(prev.blocks) ? [...prev.blocks] : [];
-                              const cur = nextBlocks[idx] && typeof nextBlocks[idx] === 'object' ? nextBlocks[idx] : {};
-                              nextBlocks[idx] = { ...cur, weight: v };
-                              return { ...prev, blocks: nextBlocks, error: '' };
-                            });
-                          }}
-                          placeholder="kg"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                        <input
-                          inputMode="decimal"
-                          value={repsValue}
-                          onChange={(e) => {
-                            const v = parseTrainingNumber(e?.target?.value);
-                            const next = v != null && v > 0 ? v : null;
-                            setClusterModal((prev) => {
-                              if (!prev || typeof prev !== 'object') return prev;
-                              const nextBlocks = Array.isArray(prev.blocks) ? [...prev.blocks] : [];
-                              const cur = nextBlocks[idx] && typeof nextBlocks[idx] === 'object' ? nextBlocks[idx] : {};
-                              nextBlocks[idx] = { ...cur, reps: next };
-                              return { ...prev, blocks: nextBlocks, error: '' };
-                            });
-                          }}
-                          placeholder="reps"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                      </div>
-                      {!isLast ? <div className="mt-2 text-xs text-neutral-500">Descanso: {safeRestSec}s</div> : null}
-                    </div>
-                  );
-                })}
-
-              <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">RPE da série</div>
-                <input
-                  inputMode="decimal"
-                  value={String(clusterModal?.rpe ?? '')}
-                  onChange={(e) => {
-                    const v = e?.target?.value ?? '';
-                    setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, rpe: v, error: '' } : prev));
-                  }}
-                  placeholder="RPE (0-10)"
-                  className="mt-2 w-full bg-black/30 border border-yellow-500/30 rounded-lg px-3 py-2 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500"
-                />
-              </div>
-            </div>
-
-            <div className="p-4 border-t border-neutral-800 flex items-center justify-between gap-2">
-              <button
-                type="button"
-                onClick={() => setClusterModal(null)}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={saveClusterModal}
-                disabled={!Array.isArray(clusterModal?.blocks) || clusterModal.blocks.length === 0}
-                className={
-                  !Array.isArray(clusterModal?.blocks) || clusterModal.blocks.length === 0
-                    ? 'min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500/40 text-black/60 font-black text-xs uppercase tracking-widest inline-flex items-center gap-2 cursor-not-allowed'
-                    : 'min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center gap-2'
-                }
-              >
-                <Save size={16} />
-                Salvar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      {restPauseModal && (
-        <div
-          className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => setRestPauseModal(null)}
-        >
-          <div
-            className="w-full max-w-2xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-            onClick={(e) => e.stopPropagation()}
-          >
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">{String(restPauseModal?.label || '').trim() === 'SST' ? 'SST' : 'Rest-P'}</div>
-                <div className="text-white font-black text-lg truncate">Preencher minis</div>
-                <div className="text-xs text-neutral-400 truncate">
-                  {Number(restPauseModal?.miniSets || 0)} minis • descanso {Number(restPauseModal?.pauseSec || 0)}s
-                </div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setRestPauseModal(null)}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-
-            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-              {restPauseModal?.error ? (
-                <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/10 p-3 text-sm text-neutral-200">
-                  {String(restPauseModal.error)}
-                </div>
-              ) : null}
-
-              {Number(restPauseModal?.miniSets || 0) <= 0 ? (
-                <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                  <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Configurar Rest-P</div>
-                  <div className="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
-                    <input
-                      inputMode="decimal"
-                      value={String(restPauseModal?.miniSets ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, miniSets: v ?? 0, error: '' } : prev));
-                      }}
-                      placeholder="Minis (ex.: 2)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                    <input
-                      inputMode="decimal"
-                      value={String(restPauseModal?.pauseSec ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, pauseSec: v ?? 15, error: '' } : prev));
-                      }}
-                      placeholder="Descanso (s) (ex.: 15)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                    <input
-                      inputMode="decimal"
-                      value={String(restPauseModal?.weight ?? '')}
-                      onChange={(e) => {
-                        const v = e?.target?.value ?? '';
-                        setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, weight: v, error: '' } : prev));
-                      }}
-                      placeholder="kg"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                  </div>
-                  <div className="mt-2 flex items-center justify-end">
-                    <button
-                      type="button"
-                      onClick={() => {
-                        const minisCount = Math.max(0, Math.floor(parseTrainingNumber(restPauseModal?.miniSets) ?? 0));
-                        if (!minisCount) {
-                          setRestPauseModal((prev) =>
-                            prev && typeof prev === 'object' ? { ...prev, error: 'Defina a quantidade de minis.' } : prev,
-                          );
-                          return;
-                        }
-                        setRestPauseModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          return { ...prev, miniSets: minisCount, minis: Array.from({ length: minisCount }).map(() => null), error: '' };
-                        });
-                      }}
-                      className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-                    >
-                      Gerar minis
-                    </button>
-                  </div>
-                </div>
-              ) : null}
-
-              <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3 relative">
-                <div className="flex items-center justify-between gap-2">
-                  <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Ativação</div>
-                  <div />
-                </div>
-                {Number(restPauseModal?.miniSets || 0) > 0 && Number(restPauseModal?.pauseSec || 0) > 0 ? (
-                  <button
-                    type="button"
-                    onClick={() => {
-                      const sec = Number(restPauseModal?.pauseSec || 0);
-                      if (!sec) return;
-                      startTimer(sec, { kind: 'rest_pause', key: restPauseModal?.key, phase: 'activation' });
-                    }}
-                    className="absolute top-3 right-3 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 active:scale-95 transition-transform z-10"
-                    aria-label={`Iniciar descanso ${Number(restPauseModal?.pauseSec || 0)}s`}
-                  >
-                    <Clock size={14} className="text-yellow-500" />
-                    <span className="text-xs font-black">{Number(restPauseModal?.pauseSec || 0)}s</span>
-                  </button>
-                ) : null}
-                <div className="mt-2 grid grid-cols-2 gap-2">
-                  <input
-                    inputMode="decimal"
-                    value={String(restPauseModal?.weight ?? '')}
-                    onChange={(e) => {
-                      const v = e?.target?.value ?? '';
-                      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, weight: v, error: '' } : prev));
-                    }}
-                    placeholder="kg"
-                    className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                  <input
-                    inputMode="decimal"
-                    value={restPauseModal?.activationReps == null ? '' : String(restPauseModal.activationReps)}
-                    onChange={(e) => {
-                      const v = parseTrainingNumber(e?.target?.value);
-                      const next = v != null && v > 0 ? v : null;
-                      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, activationReps: next, error: '' } : prev));
-                    }}
-                    placeholder="reps"
-                    className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                </div>
-              </div>
-
-              {Array.isArray(restPauseModal?.minis) &&
-                restPauseModal.minis.map((v, idx) => {
-                  const repsValue = v == null ? '' : String(v);
-                  const isLast = idx >= restPauseModal.minis.length - 1;
-                  const safeRest = Number(restPauseModal?.pauseSec || 0);
-                  return (
-                    <div key={`rp-mini-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3 relative">
-                      <div className="flex items-center justify-between gap-2">
-                        <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Mini {idx + 1}</div>
-                        <div />
-                      </div>
-                      {!isLast && safeRest ? (
-                        <button
-                          type="button"
-                          onClick={() => {
-                            startTimer(safeRest, { kind: 'rest_pause', key: restPauseModal?.key, miniIndex: idx + 1 });
-                          }}
-                          className="absolute top-3 right-3 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 active:scale-95 transition-transform z-10"
-                          aria-label={`Iniciar descanso ${safeRest}s`}
-                        >
-                          <Clock size={14} className="text-yellow-500" />
-                          <span className="text-xs font-black">{safeRest}s</span>
-                        </button>
-                      ) : null}
-                      <div className="mt-2 grid grid-cols-2 gap-2">
-                        <input
-                          inputMode="decimal"
-                          value={String(restPauseModal?.weight ?? '')}
-                          onChange={(e) => {
-                            const w = e?.target?.value ?? '';
-                            setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, weight: w, error: '' } : prev));
-                          }}
-                          placeholder="kg"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                        <input
-                          inputMode="decimal"
-                          value={repsValue}
-                          onChange={(e) => {
-                            const n = parseTrainingNumber(e?.target?.value);
-                            const next = n != null && n > 0 ? n : null;
-                            setRestPauseModal((prev) => {
-                              if (!prev || typeof prev !== 'object') return prev;
-                              const minis = Array.isArray(prev.minis) ? [...prev.minis] : [];
-                              minis[idx] = next;
-                              return { ...prev, minis, error: '' };
-                            });
-                          }}
-                          placeholder="reps"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                      </div>
-                    </div>
-                  );
-                })}
-
-              <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">RPE da série</div>
-                <input
-                  inputMode="decimal"
-                  value={String(restPauseModal?.rpe ?? '')}
-                  onChange={(e) => {
-                    const v = e?.target?.value ?? '';
-                    setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, rpe: v, error: '' } : prev));
-                  }}
-                  placeholder="RPE (0-10)"
-                  className="mt-2 w-full bg-black/30 border border-yellow-500/30 rounded-lg px-3 py-2 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500"
-                />
-              </div>
-            </div>
-
-            <div className="p-4 border-t border-neutral-800 flex items-center justify-between gap-2">
-              <button
-                type="button"
-                onClick={() => setRestPauseModal(null)}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={saveRestPauseModal}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center gap-2"
-              >
-                <Save size={16} />
-                Salvar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      {dropSetModal && (
-        <div
-          className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => setDropSetModal(null)}
-        >
-          <div
-            className="w-full max-w-2xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-            onClick={(e) => e.stopPropagation()}
-          >
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">{String(dropSetModal?.label || 'Drop')}</div>
-                <div className="text-white font-black text-lg truncate">Preencher etapas</div>
-                <div className="text-xs text-neutral-400 truncate">{Array.isArray(dropSetModal?.stages) ? dropSetModal.stages.length : 0} etapas</div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setDropSetModal(null)}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-
-            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-              {dropSetModal?.error ? (
-                <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/10 p-3 text-sm text-neutral-200">
-                  {String(dropSetModal.error)}
-                </div>
-              ) : null}
-
-              <div className="flex items-center justify-between gap-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Etapas</div>
-                <div className="flex items-center gap-2">
-                  <button
-                    type="button"
-                    onClick={() => {
-                      const pickWeight = () => {
-                        const stages = Array.isArray(dropSetModal?.stages) ? dropSetModal.stages : []
-                        for (const st of stages) {
-                          const w = String(st?.weight ?? '').trim()
-                          if (w) return w
-                        }
-                        return ''
-                      }
-                      const w = pickWeight()
-                      if (!w) {
-                        try {
-                          window.alert('Preencha pelo menos 1 etapa com peso antes de linkar.')
-                        } catch {}
-                        return
-                      }
-                      setDropSetModal((prev) => {
-                        if (!prev || typeof prev !== 'object') return prev
-                        const stages = Array.isArray(prev.stages) ? prev.stages : []
-                        const nextStages = stages.map((st) => {
-                          const cur = st && typeof st === 'object' ? st : {}
-                          return { ...cur, weight: w }
-                        })
-                        return { ...prev, stages: nextStages, error: '' }
-                      })
-                    }}
-                    className="min-h-[36px] px-3 py-2 rounded-xl bg-black border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-950 inline-flex items-center gap-2"
-                  >
-                    <Link2 size={14} className="text-yellow-500" />
-                    Linkar
-                  </button>
-                  <button
-                    type="button"
-                    onClick={() => {
-                      setDropSetModal((prev) => {
-                        if (!prev || typeof prev !== 'object') return prev
-                        const list = Array.isArray(prev.stages) ? [...prev.stages] : []
-                        if (list.length >= 20) return prev
-                        list.push({ weight: '', reps: null })
-                        return { ...prev, stages: list, error: '' }
-                      })
-                    }}
-                    className="min-h-[36px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 inline-flex items-center gap-2"
-                  >
-                    <Plus size={14} />
-                    Adicionar
-                  </button>
-                </div>
-              </div>
-
-              {Array.isArray(dropSetModal?.stages) &&
-                dropSetModal.stages.map((st, idx) => (
-                  <div key={`ds-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                    <div className="flex items-center justify-between gap-2">
-                      <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Etapa {idx + 1}</div>
-                      <button
-                        type="button"
-                        onClick={() => {
-                          setDropSetModal((prev) => {
-                            if (!prev || typeof prev !== 'object') return prev
-                            const list = Array.isArray(prev.stages) ? [...prev.stages] : []
-                            list.splice(idx, 1)
-                            return { ...prev, stages: list, error: '' }
-                          })
-                        }}
-                        className="h-9 w-9 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 inline-flex items-center justify-center"
-                        aria-label="Remover etapa"
-                      >
-                        <X size={14} />
-                      </button>
-                    </div>
-                    <div className="mt-2 grid grid-cols-2 gap-2">
-                      <input
-                        inputMode="decimal"
-                        value={String(st?.weight ?? '')}
-                        onChange={(e) => {
-                          const v = e?.target?.value ?? ''
-                          setDropSetModal((prev) => {
-                            if (!prev || typeof prev !== 'object') return prev
-                            const list = Array.isArray(prev.stages) ? [...prev.stages] : []
-                            const cur = list[idx] && typeof list[idx] === 'object' ? list[idx] : {}
-                            list[idx] = { ...cur, weight: v }
-                            return { ...prev, stages: list, error: '' }
-                          })
-                        }}
-                        placeholder="kg"
-                        className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                      />
-                      <input
-                        inputMode="decimal"
-                        value={st?.reps == null ? '' : String(st.reps)}
-                        onChange={(e) => {
-                          const n = parseTrainingNumber(e?.target?.value)
-                          const next = n != null && n > 0 ? n : null
-                          setDropSetModal((prev) => {
-                            if (!prev || typeof prev !== 'object') return prev
-                            const list = Array.isArray(prev.stages) ? [...prev.stages] : []
-                            const cur = list[idx] && typeof list[idx] === 'object' ? list[idx] : {}
-                            list[idx] = { ...cur, reps: next }
-                            return { ...prev, stages: list, error: '' }
-                          })
-                        }}
-                        placeholder="reps"
-                        className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                      />
-                    </div>
-                  </div>
-                ))}
-            </div>
-
-            <div className="p-4 border-t border-neutral-800 flex items-center justify-between gap-2">
-              <button
-                type="button"
-                onClick={() => setDropSetModal(null)}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={saveDropSetModal}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center gap-2"
-              >
-                <Save size={16} />
-                Salvar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      {postCheckinOpen && (
-        <div
-          className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => {
-            setPostCheckinOpen(false);
-            const r = postCheckinResolveRef.current;
-            postCheckinResolveRef.current = null;
-            if (typeof r === 'function') r(null);
-          }}
-        >
-          <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Check-in</div>
-                <div className="text-white font-black text-lg truncate">Pós-treino</div>
-                <div className="text-xs text-neutral-400 truncate">{String(workout?.title || 'Treino')}</div>
-              </div>
-              <button
-                type="button"
-                onClick={() => {
-                  setPostCheckinOpen(false);
-                  const r = postCheckinResolveRef.current;
-                  postCheckinResolveRef.current = null;
-                  if (typeof r === 'function') r(null);
-                }}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-            <div className="p-4 space-y-4">
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Esforço (RPE 1–10)</div>
-                <select
-                  value={String(postCheckinDraft?.rpe ?? '')}
-                  onChange={(e) => setPostCheckinDraft((prev) => ({ ...prev, rpe: String(e.target.value || '') }))}
-                  className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                >
-                  <option value="">Não informar</option>
-                  {Array.from({ length: 10 }).map((_, i) => (
-                    <option key={i + 1} value={String(i + 1)}>
-                      {i + 1}
-                    </option>
-                  ))}
-                </select>
-              </div>
-
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Satisfação (1–5)</div>
-                <div className="grid grid-cols-5 gap-2">
-                  {[1, 2, 3, 4, 5].map((n) => (
-                    <button
-                      key={n}
-                      type="button"
-                      onClick={() => setPostCheckinDraft((prev) => ({ ...prev, satisfaction: String(n) }))}
-                      className={
-                        String(postCheckinDraft?.satisfaction || '') === String(n)
-                          ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                          : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                      }
-                    >
-                      {n}
-                    </button>
-                  ))}
-                </div>
-              </div>
-
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Dor / Soreness (0–10)</div>
-                <select
-                  value={String(postCheckinDraft?.soreness ?? '')}
-                  onChange={(e) => setPostCheckinDraft((prev) => ({ ...prev, soreness: String(e.target.value || '') }))}
-                  className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                >
-                  <option value="">Não informar</option>
-                  {Array.from({ length: 11 }).map((_, i) => (
-                    <option key={i} value={String(i)}>
-                      {i}
-                    </option>
-                  ))}
-                </select>
-              </div>
-
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Observações (opcional)</div>
-                <textarea
-                  value={String(postCheckinDraft?.notes || '')}
-                  onChange={(e) => setPostCheckinDraft((prev) => ({ ...prev, notes: String(e.target.value || '') }))}
-                  className="w-full min-h-[90px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none"
-                  placeholder="Ex.: treino pesado, boa técnica, ajustar carga na próxima…"
-                />
-              </div>
-            </div>
-            <div className="p-4 border-t border-neutral-800 flex items-center gap-2">
-              <button
-                type="button"
-                onClick={() => {
-                  setPostCheckinOpen(false);
-                  const r = postCheckinResolveRef.current;
-                  postCheckinResolveRef.current = null;
-                  if (typeof r === 'function') r(null);
-                }}
-                className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-              >
-                Pular
-              </button>
-              <button
-                type="button"
-                onClick={() => {
-                  setPostCheckinOpen(false);
-                  const r = postCheckinResolveRef.current;
-                  postCheckinResolveRef.current = null;
-                  if (typeof r === 'function') r(postCheckinDraft);
-                }}
-                className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-              >
-                Continuar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      <div className="flex-1 w-full max-w-6xl mx-auto px-4 md:px-6 py-4 pb-28 space-y-4">
-        {exercises.length === 0 ? (
-          <div className="rounded-xl bg-neutral-800 border border-neutral-700 p-6 text-neutral-300">Sem exercícios neste treino.</div>
-        ) : (
-          exercises.map((ex, exIdx) => renderExercise(ex, exIdx))
-        )}
-      </div>
-
-      <div className="fixed bottom-0 left-0 right-0 z-50 bg-neutral-950/95 backdrop-blur border-t border-neutral-800 px-4 md:px-6 py-3 pb-safe">
-        <div className="max-w-6xl mx-auto flex items-center justify-between gap-2">
-          <button
-            type="button"
-            onClick={async () => {
-              const ok = await confirm('Cancelar treino em andamento? (não salva no histórico)', 'Cancelar');
-              if (!ok) return;
-              try {
-                if (typeof props?.onFinish === 'function') props.onFinish(null, false);
-              } catch {}
-            }}
-            className="inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-          >
-            <X size={16} />
-            <span className="text-sm">Cancelar</span>
-          </button>
-
-          <button
-            type="button"
-            disabled={finishing}
-            onClick={finishWorkout}
-            className={
-              finishing
-                ? 'inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-yellow-500/70 text-black font-black cursor-wait'
-                : 'inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400'
-            }
-          >
-            <Save size={16} />
-            <span className="text-sm">Finalizar</span>
-          </button>
-        </div>
-      </div>
-    </div>
-  );
-}
diff --git a/_archive/duplicates/src/components/AdminPanelV2 2.js b/_archive/duplicates/src/components/AdminPanelV2 2.js
deleted file mode 100644
index 375efd2..0000000
--- a/_archive/duplicates/src/components/AdminPanelV2 2.js	
+++ /dev/null
@@ -1,5055 +0,0 @@
-"use client";
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
-import { useRouter } from 'next/navigation';
-import Image from 'next/image';
-import {
-	Crown, X, UserCog, AlertCircle, Trash2, Megaphone, Plus, Copy, ArrowLeft,
-	MessageSquare, Send, RefreshCw, Dumbbell, Share2, UserPlus, AlertTriangle, Edit3, ShieldAlert,
-		ChevronDown, FileText, Download, History, Search, Play, Video
-} from 'lucide-react';
-import { Bar } from 'react-chartjs-2';
-import {
-	Chart as ChartJS,
-	CategoryScale,
-	LinearScale,
-	BarElement,
-	Tooltip,
-	Legend
-} from 'chart.js';
-import { createClient } from '@/utils/supabase/client';
-import AdminWorkoutEditor from './AdminWorkoutEditor';
-import { workoutPlanHtml } from '@/utils/report/templates';
-import { useDialog } from '@/contexts/DialogContext';
-import { sendBroadcastMessage, clearAllStudents, clearAllTeachers, clearAllWorkouts, deleteTeacher, updateTeacher, addTeacher, exportAllData, importAllData } from '@/actions/admin-actions';
-import { updateWorkout, deleteWorkout } from '@/actions/workout-actions';
-import AssessmentButton from '@/components/assessment/AssessmentButton';
-import HistoryList from '@/components/HistoryList';
-import { normalizeWorkoutTitle, workoutTitleKey } from '@/utils/workoutTitle';
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName';
-
-const COACH_INBOX_INACTIVE_THRESHOLD_DAYS = 7;
-const COACH_INBOX_DEFAULTS = {
-    churnDays: 7,
-    volumeDropPct: 30,
-    loadSpikePct: 60,
-    minPrev7Volume: 500,
-    minCurrent7VolumeSpike: 800,
-    snoozeDefaultMinutes: 1440,
-};
-
-ChartJS.register(CategoryScale, LinearScale, BarElement, Tooltip, Legend);
-
-const AdminPanelV2 = ({ user, onClose }) => {
-    const { alert, confirm, prompt } = useDialog();
-    const supabaseRef = useRef(null);
-    if (!supabaseRef.current) supabaseRef.current = createClient();
-    const supabase = supabaseRef.current;
-    
-    // Permission Logic
-    const isAdmin = user?.role === 'admin';
-    const isTeacher = user?.role === 'teacher';
-    const unauthorized = !isAdmin && !isTeacher;
-
-    const getSetsCount = (value) => {
-        if (Array.isArray(value)) return value.length;
-        if (typeof value === 'number') return Number.isFinite(value) ? value : 0;
-        if (typeof value === 'string') {
-            const n = Number(value);
-            return Number.isFinite(n) ? n : 0;
-        }
-        return 0;
-    };
-
-    const router = useRouter();
-    const executionVideoEnabled = (() => {
-        try {
-            const raw = String(process.env.NEXT_PUBLIC_ENABLE_EXECUTION_VIDEO ?? '').trim().toLowerCase();
-            if (raw === 'false') return false;
-            if (raw === 'true') return true;
-            return true;
-        } catch {
-            return true;
-        }
-    })();
-
-    const [tab, setTab] = useState('dashboard');
-    const [usersList, setUsersList] = useState([]);
-    const [teachersList, setTeachersList] = useState([]);
-    const [selectedTeacher, setSelectedTeacher] = useState(null);
-    const [teacherDetailTab, setTeacherDetailTab] = useState('students');
-    const [teacherStudents, setTeacherStudents] = useState([]);
-    const [teacherStudentsLoading, setTeacherStudentsLoading] = useState(false);
-    const [teacherTemplatesRows, setTeacherTemplatesRows] = useState([]);
-    const [teacherTemplatesLoading, setTeacherTemplatesLoading] = useState(false);
-    const [teacherTemplatesCursor, setTeacherTemplatesCursor] = useState(null);
-    const [teacherHistoryRows, setTeacherHistoryRows] = useState([]);
-    const [teacherHistoryLoading, setTeacherHistoryLoading] = useState(false);
-    const [teacherHistoryCursor, setTeacherHistoryCursor] = useState(null);
-    const [teacherInboxItems, setTeacherInboxItems] = useState([]);
-    const [teacherInboxLoading, setTeacherInboxLoading] = useState(false);
-    const [templates, setTemplates] = useState([]);
-    const [templatesUserId, setTemplatesUserId] = useState('');
-    const [myWorkoutsCount, setMyWorkoutsCount] = useState(0);
-    const [selectedStudent, setSelectedStudent] = useState(null);
-    const [subTab, setSubTab] = useState('workouts');
-    const [studentWorkouts, setStudentWorkouts] = useState([]);
-    const [syncedWorkouts, setSyncedWorkouts] = useState([]);
-    const [assessments, setAssessments] = useState([]);
-    const [editingStudent, setEditingStudent] = useState(false);
-    const [editedStudent, setEditedStudent] = useState({ name: '', email: '' });
-    const [editingTemplate, setEditingTemplate] = useState(null);
-    const [editingStudentWorkout, setEditingStudentWorkout] = useState(null);
-    const [viewWorkout, setViewWorkout] = useState(null);
-    const [exportOpen, setExportOpen] = useState(false);
-    const [historyOpen, setHistoryOpen] = useState(false);
-    const [executionVideos, setExecutionVideos] = useState([]);
-    const [executionVideosLoading, setExecutionVideosLoading] = useState(false);
-    const [executionVideosError, setExecutionVideosError] = useState('');
-    const [executionVideoModalOpen, setExecutionVideoModalOpen] = useState(false);
-    const [executionVideoModalUrl, setExecutionVideoModalUrl] = useState('');
-    const [executionVideoFeedbackDraft, setExecutionVideoFeedbackDraft] = useState({});
-    const [studentCheckinsRange, setStudentCheckinsRange] = useState('7d');
-    const [studentCheckinsFilter, setStudentCheckinsFilter] = useState('all');
-    const [studentCheckinsLoading, setStudentCheckinsLoading] = useState(false);
-    const [studentCheckinsError, setStudentCheckinsError] = useState('');
-    const [studentCheckinsRows, setStudentCheckinsRows] = useState([]);
-    const loadedStudentInfo = useRef(new Set());
-    const [systemExporting, setSystemExporting] = useState(false);
-    const [systemImporting, setSystemImporting] = useState(false);
-    const systemFileInputRef = useRef(null);
-    const [dangerOpen, setDangerOpen] = useState(false);
-    const [moreTabsOpen, setMoreTabsOpen] = useState(false);
-    const [dangerStudentsConfirm, setDangerStudentsConfirm] = useState('');
-    const [dangerTeachersConfirm, setDangerTeachersConfirm] = useState('');
-    const [dangerWorkoutsConfirm, setDangerWorkoutsConfirm] = useState('');
-    const [dangerActionLoading, setDangerActionLoading] = useState(null);
-
-    const [studentQuery, setStudentQuery] = useState('');
-    const [studentStatusFilter, setStudentStatusFilter] = useState('all');
-    const [teacherQuery, setTeacherQuery] = useState('');
-    const [teacherStatusFilter, setTeacherStatusFilter] = useState('all');
-    const [templateQuery, setTemplateQuery] = useState('');
-
-    const [videoExerciseName, setVideoExerciseName] = useState('');
-    const [videoQueue, setVideoQueue] = useState([]);
-    const [videoLoading, setVideoLoading] = useState(false);
-
-    const [prioritiesItems, setPrioritiesItems] = useState([]);
-    const [prioritiesLoading, setPrioritiesLoading] = useState(false);
-    const [prioritiesError, setPrioritiesError] = useState('');
-    const [prioritiesSettingsOpen, setPrioritiesSettingsOpen] = useState(false);
-    const [prioritiesSettingsLoading, setPrioritiesSettingsLoading] = useState(false);
-    const [prioritiesSettingsError, setPrioritiesSettingsError] = useState('');
-    const [prioritiesSettings, setPrioritiesSettings] = useState(() => ({ ...COACH_INBOX_DEFAULTS }));
-    const prioritiesSettingsPrefRef = useRef(null);
-    const [prioritiesComposeOpen, setPrioritiesComposeOpen] = useState(false);
-    const [prioritiesComposeStudentId, setPrioritiesComposeStudentId] = useState('');
-    const [prioritiesComposeKind, setPrioritiesComposeKind] = useState('');
-    const [prioritiesComposeText, setPrioritiesComposeText] = useState('');
-    const [videoBackfillLimit, setVideoBackfillLimit] = useState('20');
-    const [videoMissingCount, setVideoMissingCount] = useState(null);
-    const [videoMissingLoading, setVideoMissingLoading] = useState(false);
-    const [videoCycleRunning, setVideoCycleRunning] = useState(false);
-    const [videoCycleStats, setVideoCycleStats] = useState({ processed: 0, created: 0, skipped: 0 });
-    const videoCycleStopRef = useRef(false);
-
-    const [errorReports, setErrorReports] = useState([]);
-    const [errorsLoading, setErrorsLoading] = useState(false);
-    const [errorsQuery, setErrorsQuery] = useState('');
-    const [errorsStatusFilter, setErrorsStatusFilter] = useState('all');
-
-    const [exerciseAliasesReview, setExerciseAliasesReview] = useState([]);
-    const [exerciseAliasesLoading, setExerciseAliasesLoading] = useState(false);
-    const [exerciseAliasesError, setExerciseAliasesError] = useState('');
-    const [exerciseAliasesBackfillLoading, setExerciseAliasesBackfillLoading] = useState(false);
-    const [exerciseAliasesNotice, setExerciseAliasesNotice] = useState('');
-
-    useEffect(() => {
-        if (unauthorized) onClose && onClose();
-    }, [unauthorized, onClose]);
-
-    useEffect(() => {
-        if (!moreTabsOpen) return;
-        const onKeyDown = (e) => {
-            if (e?.key === 'Escape') setMoreTabsOpen(false);
-        };
-        window.addEventListener('keydown', onKeyDown);
-        return () => window.removeEventListener('keydown', onKeyDown);
-    }, [moreTabsOpen]);
-
-    const normalizeText = useCallback((value) => String(value || '').toLowerCase(), []);
-
-    const statusMatches = useCallback((rowStatus, selected) => {
-        if (!selected || selected === 'all') return true;
-        return normalizeText(rowStatus) === normalizeText(selected);
-    }, [normalizeText]);
-
-    const studentMatchesQuery = useCallback((s) => {
-        const q = normalizeText(studentQuery).trim();
-        if (!q) return true;
-        return normalizeText(s?.name).includes(q) || normalizeText(s?.email).includes(q);
-    }, [normalizeText, studentQuery]);
-
-    const teacherMatchesQuery = useCallback((t) => {
-        const q = normalizeText(teacherQuery).trim();
-        if (!q) return true;
-        return normalizeText(t?.name).includes(q) || normalizeText(t?.email).includes(q);
-    }, [normalizeText, teacherQuery]);
-
-    const templateMatchesQuery = useCallback((t) => {
-        const q = normalizeText(templateQuery).trim();
-        if (!q) return true;
-        return normalizeText(t?.name).includes(q);
-    }, [normalizeText, templateQuery]);
-
-    const studentsWithTeacherFiltered = useMemo(() => {
-        const list = Array.isArray(usersList) ? usersList : [];
-        return list
-            .filter((s) => !!s?.teacher_id)
-            .filter(studentMatchesQuery)
-            .filter((s) => statusMatches(s?.status || 'pendente', studentStatusFilter));
-    }, [studentStatusFilter, studentMatchesQuery, statusMatches, usersList]);
-
-    const studentsWithoutTeacherFiltered = useMemo(() => {
-        const list = Array.isArray(usersList) ? usersList : [];
-        return list
-            .filter((s) => !s?.teacher_id)
-            .filter(studentMatchesQuery)
-            .filter((s) => statusMatches(s?.status || 'pendente', studentStatusFilter));
-    }, [studentStatusFilter, studentMatchesQuery, statusMatches, usersList]);
-
-	const teachersFiltered = useMemo(() => {
-		const list = Array.isArray(teachersList) ? teachersList : [];
-		return list
-			.filter(teacherMatchesQuery)
-			.filter((t) => statusMatches(t?.status || 'pendente', teacherStatusFilter));
-	}, [statusMatches, teacherMatchesQuery, teacherStatusFilter, teachersList]);
-
-	const templatesFiltered = useMemo(() => {
-		const list = Array.isArray(templates) ? templates : [];
-		return list.filter(templateMatchesQuery);
-	}, [templateMatchesQuery, templates]);
-
-    const errorsFiltered = useMemo(() => {
-        const list = Array.isArray(errorReports) ? errorReports : [];
-        const q = normalizeText(errorsQuery).trim();
-        return list
-            .filter((r) => {
-                if (!errorsStatusFilter || errorsStatusFilter === 'all') return true;
-                return normalizeText(r?.status || '') === normalizeText(errorsStatusFilter);
-            })
-            .filter((r) => {
-                if (!q) return true;
-                const msg = normalizeText(r?.message || '');
-                const email = normalizeText(r?.user_email || r?.userEmail || '');
-                const path = normalizeText(r?.pathname || '');
-                return msg.includes(q) || email.includes(q) || path.includes(q);
-            });
-    }, [errorReports, errorsQuery, errorsStatusFilter, normalizeText]);
-
-	const coachInboxItems = useMemo(() => {
-		if (!isTeacher) return [];
-		const list = Array.isArray(usersList) ? usersList : [];
-        const today = new Date();
-        const todayMs = today.getTime();
-        if (!Number.isFinite(todayMs)) return [];
-
-        const safeDays = (value) => {
-            const n = Number(value);
-            if (!Number.isFinite(n) || n < 0) return 0;
-            return n;
-        };
-
-        const items = list
-            .filter((s) => s && typeof s === 'object' && s.teacher_id === user?.id)
-            .map((s) => {
-                const workouts = Array.isArray(s.workouts) ? s.workouts : [];
-                const nonTemplate = workouts.filter((w) => w && typeof w === 'object' && w.is_template !== true);
-
-                if (!nonTemplate.length) {
-                    return {
-                        id: s.id,
-                        name: s.name || s.email || '',
-                        email: s.email || '',
-                        status: s.status || 'pendente',
-                        hasWorkouts: false,
-                        daysSinceLastWorkout: null,
-                    };
-                }
-
-                let lastWorkoutMs = 0;
-                nonTemplate.forEach((w) => {
-                    try {
-                        const raw = w.date || w.completed_at || w.created_at;
-                        if (!raw) return;
-                        const d = raw?.toDate ? raw.toDate() : new Date(raw);
-                        const t = d?.getTime ? d.getTime() : NaN;
-                        if (!Number.isFinite(t)) return;
-                        if (t > lastWorkoutMs) lastWorkoutMs = t;
-                    } catch {}
-                });
-
-                if (!lastWorkoutMs) {
-                    return {
-                        id: s.id,
-                        name: s.name || s.email || '',
-                        email: s.email || '',
-                        status: s.status || 'pendente',
-                        hasWorkouts: false,
-                        daysSinceLastWorkout: null,
-                    };
-                }
-
-                const diffMs = todayMs - lastWorkoutMs;
-                const days = diffMs > 0 ? Math.floor(diffMs / (1000 * 60 * 60 * 24)) : 0;
-
-                return {
-                    id: s.id,
-                    name: s.name || s.email || '',
-                    email: s.email || '',
-                    status: s.status || 'pendente',
-                    hasWorkouts: true,
-                    daysSinceLastWorkout: days,
-                };
-            })
-            .filter((item) => item && typeof item === 'object')
-            .filter((item) => {
-                if (!item.hasWorkouts) return true;
-                const days = safeDays(item.daysSinceLastWorkout);
-                return days >= COACH_INBOX_INACTIVE_THRESHOLD_DAYS;
-            });
-
-        items.sort((a, b) => {
-            const aDays = a.hasWorkouts ? safeDays(a.daysSinceLastWorkout) : Number.MAX_SAFE_INTEGER;
-            const bDays = b.hasWorkouts ? safeDays(b.daysSinceLastWorkout) : Number.MAX_SAFE_INTEGER;
-            return bDays - aDays;
-        });
-
-        return items.slice(0, 5);
-	}, [isTeacher, usersList, user?.id]);
-
-    useEffect(() => {
-        if (!selectedStudent) setHistoryOpen(false);
-    }, [selectedStudent]);
-
-    useEffect(() => {
-        if (selectedStudent) setSelectedTeacher(null);
-    }, [selectedStudent]);
-
-    const handleExportSystem = async () => {
-        try {
-            setSystemExporting(true);
-            const res = await exportAllData();
-            if (res?.error) throw new Error(res.error);
-            const json = JSON.stringify(res.data || {}, null, 2);
-            const blob = new Blob([json], { type: 'application/json' });
-            const url = URL.createObjectURL(blob);
-            const a = document.createElement('a');
-            a.href = url;
-            a.download = `irontracks_full_backup_${new Date().toISOString()}.json`;
-            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        } catch (e) {
-            await alert('Erro ao exportar: ' + (e?.message ?? String(e)));
-        } finally {
-            setSystemExporting(false);
-        }
-    };
-
-    const handleImportSystemClick = () => {
-        systemFileInputRef.current?.click();
-    };
-
-    const handleImportSystem = async (e) => {
-        const file = e.target.files?.[0];
-        if (!file) return;
-        try {
-            setSystemImporting(true);
-            const text = await file.text();
-            const data = JSON.parse(text);
-            if (!(await confirm('Importar backup completo do sistema?', 'Importar Backup'))) return;
-            const res = await importAllData(data);
-            if (res?.error) throw new Error(res.error);
-            await alert('Backup importado com sucesso!');
-        } catch (err) {
-            await alert('Erro ao importar: ' + (err?.message ?? String(err)));
-        } finally {
-            setSystemImporting(false);
-            if (e?.target) e.target.value = '';
-        }
-    };
-
-    const handleExportPdf = async () => {
-        try {
-            const html = workoutPlanHtml({
-                title: viewWorkout.name,
-                exercises: (viewWorkout.exercises || []).map(ex => ({
-                    name: ex.name,
-                    sets: getSetsCount(ex?.sets),
-                    reps: ex.reps ?? '10',
-                    rpe: ex.rpe ?? 8,
-                    cadence: ex.cadence || '2020',
-                    restTime: ex.rest_time ?? ex.restTime,
-                    method: ex.method,
-                    notes: ex.notes
-                }))
-            }, user);
-            const win = window.open('', '_blank');
-            if (!win) return;
-            win.document.open();
-            win.document.write(html);
-            win.document.close();
-            win.focus();
-            setTimeout(() => { try { win.print(); } catch {} }, 300);
-            setExportOpen(false);
-        } catch (e) {
-            await alert('Erro ao gerar PDF: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleExportJson = () => {
-        const json = JSON.stringify({
-            workout: {
-                title: viewWorkout.name,
-                exercises: (viewWorkout.exercises || []).map(ex => ({
-                    name: ex.name,
-                    sets: getSetsCount(ex?.sets),
-                    reps: ex.reps,
-                    rpe: ex.rpe,
-                    cadence: ex.cadence,
-                    restTime: ex.rest_time ?? ex.restTime,
-                    method: ex.method,
-                    videoUrl: ex.video_url || ex.videoUrl,
-                    notes: ex.notes
-                }))
-            }
-        }, null, 2);
-        const blob = new Blob([json], { type: 'application/json' });
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement('a');
-        a.href = url;
-        a.download = `${(viewWorkout.name || 'treino').replace(/\s+/g,'_')}.json`;
-        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        setExportOpen(false);
-    };
-
-    const openEditWorkout = (e, w) => {
-        e?.stopPropagation?.();
-        setEditingStudentWorkout({
-            id: w.id,
-            title: w.name,
-            exercises: (w.exercises || []).map(ex => ({
-                name: ex.name || '',
-                sets: getSetsCount(ex?.sets) || 4,
-                reps: ex.reps ?? '10',
-                rpe: ex.rpe ?? 8,
-                cadence: ex.cadence || '2020',
-                restTime: ex.rest_time ?? 60,
-                method: ex.method || 'Normal',
-                videoUrl: ex.video_url || '',
-                notes: ex.notes || ''
-            }))
-        });
-    };
-
-    const openEditTemplate = (t) => {
-        setEditingTemplate({
-            id: t.id,
-            title: t.name,
-            exercises: (t.exercises || []).map(ex => ({
-                name: ex.name || '',
-                sets: getSetsCount(ex?.sets) || 4,
-                reps: ex.reps ?? '10',
-                rpe: ex.rpe ?? 8,
-                cadence: ex.cadence || '2020',
-                restTime: ex.rest_time ?? 60,
-                method: ex.method || 'Normal',
-                videoUrl: ex.video_url || '',
-                notes: ex.notes || ''
-            }))
-        });
-    };
-    const [loading, setLoading] = useState(false);
-
-    const [showRegisterModal, setShowRegisterModal] = useState(false);
-    const [newStudent, setNewStudent] = useState({ name: '', email: '' });
-    const [registering, setRegistering] = useState(false);
-
-    const [broadcastMsg, setBroadcastMsg] = useState('');
-    const [broadcastTitle, setBroadcastTitle] = useState('');
-    const [sendingBroadcast, setSendingBroadcast] = useState(false);
-
-    const [showTeacherModal, setShowTeacherModal] = useState(false);
-    const [newTeacher, setNewTeacher] = useState({ name: '', email: '', phone: '', birth_date: '' });
-    const [addingTeacher, setAddingTeacher] = useState(false);
-    const [editingTeacher, setEditingTeacher] = useState(null); // For edit modal/state
-
-    // DIAGNOSTIC MODE: Connection Test
-    const [debugError, setDebugError] = useState(null);
-
-    useEffect(() => {
-        const testConnection = async () => {
-            try {
-                // AÇÃO 2: Teste agressivo sem filtros
-                const { data, error } = await supabase.from('workouts').select('*').limit(1);
-                
-                if (error) {
-                    console.error("ERRO CRÍTICO SUPABASE:", error);
-                    setDebugError("Erro Supabase: " + error.message + " | Detalhes: " + JSON.stringify(error));
-                } else if (!data || data.length === 0) {
-                    // Se não retornar nada, pode ser RLS ou tabela vazia, mas a conexão funcionou
-                    // setDebugError("Conexão OK, mas tabela vazia ou bloqueada por RLS.");
-                    console.log("Conexão OK (tabela vazia ou RLS)");
-                } else {
-                    console.log("Conexão OK (dados encontrados)");
-                }
-            } catch (e) {
-                console.error("ERRO DE CONEXÃO/FETCH:", e);
-                setDebugError("Erro Catch: " + (e?.message ?? String(e)));
-            }
-        };
-        testConnection();
-    }, [supabase]);
-
-    useEffect(() => {
-        const fetchStudents = async () => {
-            setLoading(true);
-            const { data: { user: currentUser } } = await supabase.auth.getUser();
-            if (!currentUser) { setLoading(false); return; }
-            try {
-                let list = [];
-                if (isAdmin) {
-                    const res = await fetch('/api/admin/students/list');
-                    const json = await res.json();
-                    if (json.ok) list = json.students || [];
-                    const legacyRes = await fetch('/api/admin/legacy-students');
-                    const legacyJson = await legacyRes.json();
-                    if (legacyJson.ok && legacyJson.students) {
-                        const existingIds = new Set(list.map(s => s.user_id || s.id));
-                        const newLegacy = legacyJson.students.filter(s => !existingIds.has(s.id));
-                        list = [...list, ...newLegacy];
-
-                        // Dedup by email, prefer entries that already have teacher_id
-                        const byEmail = new Map();
-                        for (const s of (list || [])) {
-                            const key = (s.email || '').toLowerCase();
-                            const prev = byEmail.get(key);
-                            if (!prev || (!!s.teacher_id && !prev.teacher_id)) {
-                                byEmail.set(key, s);
-                            }
-                        }
-                        list = Array.from(byEmail.values());
-                    }
-                    if (list.length === 0) {
-                        const { data: profiles } = await supabase
-                            .from('profiles')
-                            .select('id, display_name, email, role')
-                            .neq('role', 'teacher')
-                            .order('display_name');
-                        // Fetch teachers via admin API to exclude
-                        let teacherEmails = new Set();
-                        try {
-                            const tRes = await fetch('/api/admin/teachers/list');
-                            const tJson = await tRes.json();
-                            if (tJson.ok) teacherEmails = new Set((tJson.teachers || []).map(t => (t.email || '').toLowerCase()));
-                        } catch {}
-                        list = (profiles || [])
-                            .filter(p => !p.email || !teacherEmails.has(p.email.toLowerCase()))
-                            .map(p => ({ id: p.id, name: p.display_name, email: p.email, teacher_id: null, user_id: p.id }));
-                        // FINAL FALLBACK: students table (teacher/created_by), same do branch não-admin
-                        if ((list || []).length === 0) {
-                            let query = supabase
-                                .from('students')
-                                .select('*, workouts(*)')
-                                .order('name');
-                            const uid = currentUser?.id ? String(currentUser.id) : '';
-                            if (uid) query = query.or(`teacher_id.eq.${uid},user_id.eq.${uid}`);
-                            const { data: studentsData } = await query;
-                            list = (studentsData || []).filter(s => (s.email || '').toLowerCase() !== (currentUser.email || '').toLowerCase());
-                        }
-                    }
-                    // Extra client-side filter: exclude teachers
-                    const { data: tList } = await supabase.from('teachers').select('id, name, email, user_id');
-                    const tEmails = new Set((tList || []).map(t => (t.email || '').toLowerCase()));
-                    const filtered = (list || []).filter(s => {
-                        const email = (s.email || '').toLowerCase();
-                        const uid = s.user_id || s.id;
-                        if (email && tEmails.has(email)) return false;
-                        return true;
-                    });
-                    // Overlay cached teacher assignment by email to ensure UI reflects recent changes
-                    try {
-                        list = (filtered || []).map(s => {
-                            const key = 'student_teacher_' + (s.email || '');
-                            let tid = null;
-                            try { tid = localStorage.getItem(key) || null; } catch {}
-                            return tid && !s.teacher_id ? { ...s, teacher_id: tid } : s;
-                        });
-                    } catch { list = filtered; }
-                    // Ensure dropdown has teachers (enriched with profiles.id mapping)
-                    if (teachersList.length === 0) {
-                        const resT = await fetch('/api/admin/teachers/list');
-                        const jsonT = await resT.json();
-                        if (jsonT.ok) {
-                            const base = jsonT.teachers || [];
-                            try {
-                                const emails = base.map(t => t.email).filter(Boolean);
-                                if (emails.length > 0) {
-                                    const { data: profilesMap } = await supabase
-                                        .from('profiles')
-                                        .select('id, email')
-                                        .in('email', emails);
-                                    const idByEmail = new Map((profilesMap || []).map(p => [p.email, p.id]));
-                                    const enriched = base.map(t => ({ ...t, user_id: idByEmail.get(t.email) || null }));
-                                    // Ensure currently assigned teacher appears in dropdown
-                                    if (selectedStudent?.teacher_id && !enriched.some(t => t.user_id === selectedStudent.teacher_id)) {
-                                        const { data: curProfile } = await supabase
-                                            .from('profiles')
-                                            .select('id, display_name, email')
-                                            .eq('id', selectedStudent.teacher_id)
-                                            .maybeSingle();
-                                        if (curProfile) enriched.unshift({ id: curProfile.id, name: curProfile.display_name, email: curProfile.email, user_id: curProfile.id, status: 'active' })
-                                    }
-                                    setTeachersList(enriched);
-                                } else {
-                                    setTeachersList(base);
-                                }
-                            } catch { setTeachersList(base); }
-                        }
-                    }
-                } else {
-                    let query = supabase
-                        .from('students')
-                        .select('*, workouts(*)')
-                        .order('name');
-                    const uid = currentUser?.id ? String(currentUser.id) : '';
-                    if (uid) query = query.or(`teacher_id.eq.${uid},user_id.eq.${uid}`);
-                    const { data: studentsData } = await query;
-                    list = (studentsData || []).filter(s => (s.email || '').toLowerCase() !== (currentUser.email || '').toLowerCase());
-                    // Overlay cached teacher assignment by email to ensure UI reflects recent changes
-                    try {
-                        list = (list || []).map(s => {
-                            const key = 'student_teacher_' + (s.email || '');
-                            let tid = null;
-                            try { tid = localStorage.getItem(key) || null; } catch {}
-                            return tid && !s.teacher_id ? { ...s, teacher_id: tid } : s;
-                        });
-                    } catch {}
-                }
-                setUsersList(list || []);
-            } finally { setLoading(false); }
-        };
-        fetchStudents();
-    }, [registering, isAdmin, supabase, selectedStudent?.teacher_id, teachersList.length]);
-
-    useEffect(() => {
-        if (tab === 'teachers' && isAdmin) {
-            const fetchTeachers = async () => {
-                const res = await fetch('/api/admin/teachers/list');
-                const json = await res.json();
-                if (json.ok) {
-                    const list = json.teachers || [];
-                    const dedup = [];
-                    const seen = new Set();
-                    for (const t of list) {
-                        const key = (t.email || '').toLowerCase();
-                        if (!seen.has(key)) { seen.add(key); dedup.push(t); }
-                    }
-                    try {
-                        const emails = dedup.map(t => t.email).filter(Boolean);
-                        if (emails.length > 0) {
-                            const { data: profilesMap } = await supabase
-                                .from('profiles')
-                                .select('id, email')
-                                .in('email', emails);
-                            const idByEmail = new Map((profilesMap || []).map(p => [p.email, p.id]));
-                            const enriched = dedup.map(t => ({ ...t, user_id: idByEmail.get(t.email) || null }));
-                            setTeachersList(enriched);
-                        } else {
-                            setTeachersList(dedup);
-                        }
-                    } catch {
-                        setTeachersList(dedup);
-                    }
-                }
-            };
-            fetchTeachers();
-        }
-    }, [tab, isAdmin, addingTeacher, editingTeacher, supabase]);
-
-    const loadTeacherStudents = useCallback(async (teacher) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherStudents([]); return; }
-        setTeacherStudentsLoading(true);
-        try {
-            const res = await fetch(`/api/admin/teachers/students?teacher_user_id=${encodeURIComponent(uid)}`);
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) { setTeacherStudents([]); return; }
-            setTeacherStudents(Array.isArray(json.students) ? json.students : []);
-        } finally {
-            setTeacherStudentsLoading(false);
-        }
-    }, []);
-
-    const loadTeacherTemplates = useCallback(async (teacher, reset = false) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherTemplatesRows([]); setTeacherTemplatesCursor(null); return; }
-        if (reset) { setTeacherTemplatesRows([]); setTeacherTemplatesCursor(null); }
-        setTeacherTemplatesLoading(true);
-        try {
-            const cursor = reset ? '' : String(teacherTemplatesCursor || '');
-            const qs = new URLSearchParams({ teacher_user_id: uid, limit: '80' });
-            if (cursor) qs.set('cursor', cursor);
-            const res = await fetch(`/api/admin/teachers/workouts/templates?${qs.toString()}`);
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return;
-            const rows = Array.isArray(json.rows) ? json.rows : [];
-            setTeacherTemplatesRows((prev) => reset ? rows : [...(Array.isArray(prev) ? prev : []), ...rows]);
-            setTeacherTemplatesCursor(json.next_cursor || null);
-        } finally {
-            setTeacherTemplatesLoading(false);
-        }
-    }, [teacherTemplatesCursor]);
-
-    const loadTeacherHistory = useCallback(async (teacher, reset = false) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherHistoryRows([]); setTeacherHistoryCursor(null); return; }
-        if (reset) { setTeacherHistoryRows([]); setTeacherHistoryCursor(null); }
-        setTeacherHistoryLoading(true);
-        try {
-            const qs = new URLSearchParams({ teacher_user_id: uid, limit: '80' });
-            const cur = reset ? null : teacherHistoryCursor;
-            if (cur?.cursor_date) qs.set('cursor_date', String(cur.cursor_date));
-            if (cur?.cursor_created_at) qs.set('cursor_created_at', String(cur.cursor_created_at));
-            const res = await fetch(`/api/admin/teachers/workouts/history?${qs.toString()}`);
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return;
-            const rows = Array.isArray(json.rows) ? json.rows : [];
-            setTeacherHistoryRows((prev) => reset ? rows : [...(Array.isArray(prev) ? prev : []), ...rows]);
-            setTeacherHistoryCursor(json.next_cursor || null);
-        } finally {
-            setTeacherHistoryLoading(false);
-        }
-    }, [teacherHistoryCursor]);
-
-    const loadTeacherInbox = useCallback(async (teacher) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherInboxItems([]); return; }
-        setTeacherInboxLoading(true);
-        try {
-            const res = await fetch(`/api/admin/teachers/inbox?teacher_user_id=${encodeURIComponent(uid)}&limit=80`);
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) { setTeacherInboxItems([]); return; }
-            setTeacherInboxItems(Array.isArray(json.items) ? json.items : []);
-        } finally {
-            setTeacherInboxLoading(false);
-        }
-    }, []);
-
-    useEffect(() => {
-        if (!selectedTeacher || !isAdmin) return;
-        setTeacherDetailTab('students');
-        setTeacherTemplatesRows([]);
-        setTeacherTemplatesCursor(null);
-        setTeacherHistoryRows([]);
-        setTeacherHistoryCursor(null);
-        setTeacherInboxItems([]);
-        loadTeacherStudents(selectedTeacher).catch(() => {});
-    }, [isAdmin, loadTeacherStudents, selectedTeacher]);
-
-    useEffect(() => {
-        if (!selectedTeacher || !isAdmin) return;
-        if (teacherDetailTab === 'templates' && teacherTemplatesRows.length === 0) loadTeacherTemplates(selectedTeacher, true).catch(() => {});
-        if (teacherDetailTab === 'history' && teacherHistoryRows.length === 0) loadTeacherHistory(selectedTeacher, true).catch(() => {});
-        if (teacherDetailTab === 'inbox' && teacherInboxItems.length === 0) loadTeacherInbox(selectedTeacher).catch(() => {});
-    }, [isAdmin, loadTeacherHistory, loadTeacherInbox, loadTeacherTemplates, selectedTeacher, teacherDetailTab, teacherHistoryRows.length, teacherInboxItems.length, teacherTemplatesRows.length]);
-
-    // URL Persistence for Tabs (Fixed)
-    useEffect(() => {
-       if (typeof window === 'undefined') return;
-       const sp = new URLSearchParams(window.location.search);
-       const t = sp.get('tab');
-       // Only restore if valid tab, otherwise default to dashboard
-       if (t && ['dashboard','students','teachers','templates','videos','broadcast','system'].includes(t)) {
-           setTab(t);
-       }
-    }, []);
-
-    useEffect(() => {
-       if (typeof window === 'undefined') return;
-       const sp = new URLSearchParams(window.location.search);
-       if (sp.get('tab') !== tab) {
-           sp.set('tab', tab);
-           // Use replaceState to avoid cluttering history, unless user wants back button support
-           // Here we use replaceState to just keep URL in sync
-           const url = `${window.location.pathname}?${sp.toString()}`;
-           window.history.replaceState(null, '', url);
-       }
-       try {
-           sessionStorage.setItem('irontracks_admin_panel_open', '1');
-           sessionStorage.setItem('irontracks_admin_panel_tab', String(tab || 'dashboard'));
-       } catch {}
-    }, [tab]);
-
-    useEffect(() => {
-        if (tab !== 'templates') return;
-        const fetchTemplates = async () => {
-            try {
-                const { data: { user: currentUser } } = await supabase.auth.getUser();
-                if (!currentUser) return;
-                setTemplatesUserId(currentUser.id || '');
-                let list = [];
-                if (isAdmin || isTeacher) {
-                    try {
-                        const res = await fetch('/api/admin/workouts/mine');
-                        const json = await res.json();
-                        if (json.ok) {
-                            list = (json.rows || []).filter((w) => w?.is_template === true && w?.user_id === currentUser.id);
-                        }
-                    } catch (e) { console.error("API fetch error", e); }
-
-                    if ((list || []).length === 0) {
-                        try {
-                            const { data } = await supabase
-                                .from('workouts')
-                                .select('*, exercises(*, sets(*))')
-                                .eq('is_template', true)
-                                .eq('user_id', currentUser.id)
-                                .order('name');
-                            list = (data || []).filter((w) => w?.is_template === true && w?.user_id === currentUser.id);
-                        } catch (e) { console.error("Supabase fetch error", e); }
-                    }
-                } else {
-                    try {
-                        const { data } = await supabase
-                            .from('workouts')
-                            .select('*, exercises(*, sets(*))')
-                            .eq('is_template', true)
-                            .eq('user_id', currentUser.id)
-                            .order('name');
-                        list = data || [];
-                    } catch (e) { console.error("Supabase fetch error", e); }
-                }
-                try {
-                    const resLegacy = await fetch('/api/workouts/list');
-                    const jsonLegacy = await resLegacy.json();
-                    if (jsonLegacy.ok) {
-                        const legacy = (jsonLegacy.rows || []).map(w => ({ id: w.id || w.uuid, name: w.name, exercises: [] }));
-                        list = [...list, ...legacy];
-                    }
-                } catch {}
-                // Deduplicar por título, priorizando treinos completos (maior número de exercícios)
-                const score = (w) => {
-                    const exs = Array.isArray(w.exercises) ? w.exercises : [];
-                    const exCount = exs.length;
-                    return exCount;
-                };
-                const byTitle = new Map();
-                for (const w of (list || [])) {
-                    if (!w || !w.name) continue; // Defensive check
-                    try {
-                        const key = workoutTitleKey(w.name);
-                        const prev = byTitle.get(key);
-                        const curHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(w?.name || ''));
-                        const prevHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(prev?.name || ''));
-                        if (
-                            !prev
-                            || score(w) > score(prev)
-                            || (score(w) === score(prev) && curHasPrefix && !prevHasPrefix)
-                            || (score(w) === score(prev) && !!w.is_template && !prev.is_template)
-                        ) {
-                            byTitle.set(key, w);
-                        }
-                    } catch (e) { console.error("Error processing workout", w, e); }
-                }
-                const deduped = Array.from(byTitle.values())
-                    .map((w) => ({ ...w, name: normalizeWorkoutTitle(w?.name || '') }))
-                    .sort((a,b) => (a.name||'').localeCompare(b.name||''));
-                setTemplates(deduped || []);
-            } catch (err) {
-                console.error("Critical error fetching templates", err);
-            }
-        };
-        fetchTemplates();
-    }, [tab, isAdmin, isTeacher, supabase]);
-
-    useEffect(() => {
-        if (tab !== 'videos' || !isAdmin) return;
-        const normalizeExercise = (value) => {
-            const s = String(value || '').trim().toLowerCase();
-            if (!s) return '';
-            return s
-                .normalize('NFD')
-                .replace(/[\u0300-\u036f]/g, '')
-                .replace(/[^a-z0-9]+/g, ' ')
-                .trim()
-                .replace(/\s+/g, ' ');
-        };
-
-        const fetchMissing = async () => {
-            setVideoMissingLoading(true);
-            try {
-                const { data: rows, error } = await supabase
-                    .from('exercises')
-                    .select('name, video_url')
-                    .or('video_url.is.null,video_url.eq.')
-                    .limit(2000);
-
-                if (error) throw error;
-
-                const normalized = new Set();
-                for (const r of (rows || [])) {
-                    const name = String(r?.name || '').trim();
-                    if (!name) continue;
-                    const n = normalizeExercise(name);
-                    if (!n) continue;
-                    normalized.add(n);
-                    if (normalized.size >= 1000) break;
-                }
-
-                const normalizedList = Array.from(normalized);
-                if (!normalizedList.length) {
-                    setVideoMissingCount(0);
-                    return;
-                }
-
-                const { data: libRows } = await supabase
-                    .from('exercise_library')
-                    .select('normalized_name, video_url')
-                    .in('normalized_name', normalizedList)
-                    .limit(normalizedList.length);
-
-                const withVideo = new Set(
-                    (libRows || [])
-                        .filter((x) => !!String(x?.video_url || '').trim())
-                        .map((x) => String(x?.normalized_name || '').trim())
-                        .filter(Boolean)
-                );
-
-                let missing = 0;
-                for (const n of normalizedList) {
-                    if (!withVideo.has(n)) missing += 1;
-                }
-                setVideoMissingCount(missing);
-            } catch {
-                setVideoMissingCount(null);
-            } finally {
-                setVideoMissingLoading(false);
-            }
-        };
-
-        const fetchVideos = async () => {
-            setVideoLoading(true);
-            try {
-                const { data, error } = await supabase
-                    .from('exercise_videos')
-                    .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                    .eq('status', 'pending')
-                    .order('created_at', { ascending: false })
-                    .limit(60);
-                if (!error) setVideoQueue(data || []);
-            } catch {
-                setVideoQueue([]);
-            } finally {
-                setVideoLoading(false);
-            }
-        };
-        fetchVideos();
-        fetchMissing();
-    }, [tab, isAdmin, supabase]);
-
-    useEffect(() => {
-        if (tab !== 'errors' || !isAdmin) return;
-        let cancelled = false;
-        const fetchErrors = async () => {
-            setErrorsLoading(true);
-            try {
-                const { data, error } = await supabase
-                    .from('error_reports')
-                    .select('id, user_id, user_email, message, stack, pathname, url, user_agent, app_version, source, meta, status, created_at, updated_at, resolved_at, resolved_by')
-                    .order('created_at', { ascending: false })
-                    .limit(200);
-                if (cancelled) return;
-                if (error) {
-                    setErrorReports([]);
-                    return;
-                }
-                setErrorReports(Array.isArray(data) ? data : []);
-            } catch {
-                if (!cancelled) setErrorReports([]);
-            } finally {
-                if (!cancelled) setErrorsLoading(false);
-            }
-        };
-        fetchErrors();
-        return () => {
-            cancelled = true;
-        };
-    }, [tab, isAdmin, supabase]);
-
-    useEffect(() => {
-        if (tab !== 'system' || !isAdmin) return;
-        let cancelled = false;
-        const fetchAliases = async () => {
-            setExerciseAliasesLoading(true);
-            setExerciseAliasesError('');
-            try {
-                const { data, error } = await supabase
-                    .from('exercise_aliases')
-                    .select('id, user_id, canonical_id, alias, normalized_alias, confidence, source, needs_review, created_at, updated_at')
-                    .eq('needs_review', true)
-                    .order('created_at', { ascending: false })
-                    .limit(200);
-                if (cancelled) return;
-                if (error) {
-                    setExerciseAliasesReview([]);
-                    const msg = String(error?.message || '');
-                    if (msg) setExerciseAliasesError(msg);
-                    return;
-                }
-                setExerciseAliasesReview(Array.isArray(data) ? data : []);
-            } catch (e) {
-                if (!cancelled) {
-                    setExerciseAliasesReview([]);
-                    const msg = e?.message ? String(e.message) : '';
-                    if (msg) setExerciseAliasesError(msg);
-                }
-            } finally {
-                if (!cancelled) setExerciseAliasesLoading(false);
-            }
-        };
-        fetchAliases();
-        return () => {
-            cancelled = true;
-        };
-    }, [tab, isAdmin, supabase]);
-
-    useEffect(() => {
-        const fetchMyWorkoutsCount = async () => {
-            const { data: { user: currentUser } } = await supabase.auth.getUser();
-            if (!currentUser) { setMyWorkoutsCount(0); return; }
-            try {
-                if (isAdmin) {
-                    const res = await fetch('/api/admin/workouts/mine');
-                    const json = await res.json();
-                    if (json.ok) {
-                        const byTitle = new Map();
-                        for (const w of (json.rows || [])) {
-                            const key = workoutTitleKey(w.name);
-                            if (!byTitle.has(key)) byTitle.set(key, w);
-                        }
-                        const count = byTitle.size;
-                        if (count > 0) setMyWorkoutsCount(count);
-                        else {
-                            const { data } = await supabase
-                                .from('workouts')
-                                .select('id, name, is_template, created_by, user_id')
-                                .or(`created_by.eq.${currentUser.id},user_id.eq.${currentUser.id},is_template.eq.true`)
-                                .order('name');
-                            const list = (data || []).filter(w => (w.is_template === true || w.created_by === currentUser.id || w.user_id === currentUser.id));
-                            setMyWorkoutsCount(list.length);
-                        }
-                    } else {
-                        const { data } = await supabase
-                            .from('workouts')
-                            .select('id, name, is_template, created_by, user_id')
-                            .or(`created_by.eq.${currentUser.id},user_id.eq.${currentUser.id},is_template.eq.true`)
-                            .order('name');
-                        const list = (data || []).filter(w => (w.is_template === true || w.created_by === currentUser.id || w.user_id === currentUser.id));
-                        setMyWorkoutsCount(list.length);
-                    }
-                } else {
-                    const { data } = await supabase
-                        .from('workouts')
-                        .select('id, name, is_template, created_by, user_id')
-                        .or(`created_by.eq.${currentUser.id},user_id.eq.${currentUser.id}`)
-                        .order('name');
-                    const list = (data || []).filter(w => (w.is_template === true || w.created_by === currentUser.id || w.user_id === currentUser.id));
-                    setMyWorkoutsCount(list.length);
-                }
-            } catch {
-                setMyWorkoutsCount(0);
-            }
-        };
-        if (tab === 'dashboard') fetchMyWorkoutsCount();
-    }, [tab, isAdmin, supabase]);
-
-    const fetchPriorities = useCallback(async () => {
-        try {
-            setPrioritiesLoading(true);
-            setPrioritiesError('');
-            const res = await fetch('/api/teacher/inbox/feed?limit=80', { cache: 'no-store', credentials: 'include' });
-            const json = await res.json().catch(() => null);
-            if (!res.ok || !json?.ok) {
-                setPrioritiesItems([]);
-                setPrioritiesError(String(json?.error || `Falha ao carregar (${res.status})`));
-                return;
-            }
-            setPrioritiesItems(Array.isArray(json.items) ? json.items : []);
-        } catch (e) {
-            setPrioritiesItems([]);
-            setPrioritiesError(e?.message ? String(e.message) : 'Erro ao carregar');
-        } finally {
-            setPrioritiesLoading(false);
-        }
-    }, []);
-
-    const normalizeCoachInboxSettings = useCallback((raw) => {
-        const s = raw && typeof raw === 'object' ? raw : {};
-        const toInt = (v, min, max, fallback) => {
-            const n = Number(v);
-            if (!Number.isFinite(n)) return fallback;
-            const x = Math.floor(n);
-            return Math.max(min, Math.min(max, x));
-        };
-        return {
-            churnDays: toInt(s?.churnDays, 1, 60, COACH_INBOX_DEFAULTS.churnDays),
-            volumeDropPct: toInt(s?.volumeDropPct, 5, 90, COACH_INBOX_DEFAULTS.volumeDropPct),
-            loadSpikePct: toInt(s?.loadSpikePct, 10, 300, COACH_INBOX_DEFAULTS.loadSpikePct),
-            minPrev7Volume: toInt(s?.minPrev7Volume, 0, 1000000, COACH_INBOX_DEFAULTS.minPrev7Volume),
-            minCurrent7VolumeSpike: toInt(s?.minCurrent7VolumeSpike, 0, 1000000, COACH_INBOX_DEFAULTS.minCurrent7VolumeSpike),
-            snoozeDefaultMinutes: toInt(s?.snoozeDefaultMinutes, 5, 10080, COACH_INBOX_DEFAULTS.snoozeDefaultMinutes),
-        };
-    }, []);
-
-    const loadPrioritiesSettings = useCallback(async () => {
-        try {
-            setPrioritiesSettingsLoading(true);
-            setPrioritiesSettingsError('');
-            const uid = user?.id ? String(user.id) : '';
-            if (!uid) return;
-            const { data, error } = await supabase
-                .from('user_settings')
-                .select('preferences')
-                .eq('user_id', uid)
-                .maybeSingle();
-            if (error) {
-                const msg = String(error?.message || '');
-                const code = String(error?.code || '');
-                const missing = code === '42P01' || /does not exist/i.test(msg) || /not found/i.test(msg);
-                if (missing) {
-                    prioritiesSettingsPrefRef.current = null;
-                    setPrioritiesSettings({ ...COACH_INBOX_DEFAULTS });
-                    setPrioritiesSettingsError('Tabela user_settings não disponível (migrations pendentes).');
-                    return;
-                }
-                setPrioritiesSettingsError(msg || 'Falha ao carregar configurações.');
-                return;
-            }
-            const prefs = data?.preferences && typeof data.preferences === 'object' ? data.preferences : {};
-            prioritiesSettingsPrefRef.current = prefs;
-            const next = normalizeCoachInboxSettings(prefs?.coachInbox);
-            setPrioritiesSettings(next);
-        } catch (e) {
-            setPrioritiesSettingsError(e?.message ? String(e.message) : 'Falha ao carregar configurações.');
-        } finally {
-            setPrioritiesSettingsLoading(false);
-        }
-    }, [normalizeCoachInboxSettings, supabase, user?.id]);
-
-    const savePrioritiesSettings = useCallback(async () => {
-        try {
-            const uid = user?.id ? String(user.id) : '';
-            if (!uid) return false;
-            setPrioritiesSettingsLoading(true);
-            setPrioritiesSettingsError('');
-            const basePrefs = prioritiesSettingsPrefRef.current && typeof prioritiesSettingsPrefRef.current === 'object'
-                ? prioritiesSettingsPrefRef.current
-                : {};
-            const payload = {
-                user_id: uid,
-                preferences: { ...basePrefs, coachInbox: normalizeCoachInboxSettings(prioritiesSettings) },
-                updated_at: new Date().toISOString(),
-            };
-            const { error } = await supabase.from('user_settings').upsert(payload, { onConflict: 'user_id' });
-            if (error) {
-                setPrioritiesSettingsError(String(error?.message || 'Falha ao salvar.'));
-                return false;
-            }
-            prioritiesSettingsPrefRef.current = payload.preferences;
-            return true;
-        } catch (e) {
-            setPrioritiesSettingsError(e?.message ? String(e.message) : 'Falha ao salvar.');
-            return false;
-        } finally {
-            setPrioritiesSettingsLoading(false);
-        }
-    }, [normalizeCoachInboxSettings, prioritiesSettings, supabase, user?.id]);
-
-    useEffect(() => {
-        if (tab !== 'priorities') return;
-        fetchPriorities();
-    }, [tab, fetchPriorities]);
-
-    useEffect(() => {
-        if (!selectedStudent) return;
-        const fetchDetails = async () => {
-            setLoading(true);
-            const expectedStudentId = selectedStudent?.id || null;
-            let targetUserId = selectedStudent.user_id || '';
-            if (!targetUserId && selectedStudent.email) {
-                const { data: profile } = await supabase
-                    .from('profiles')
-                    .select('id')
-                    .ilike('email', selectedStudent.email)
-                    .maybeSingle();
-                targetUserId = profile?.id || targetUserId;
-            }
-            try {
-                const key = selectedStudent?.id || selectedStudent?.email || targetUserId;
-                if (key && !loadedStudentInfo.current.has(key)) {
-                    const resp = await fetch('/api/admin/students/list');
-                    const js = await resp.json();
-                    if (js.ok) {
-                        const row = (js.students || []).find(s => (s.id === selectedStudent.id) || (s.user_id && s.user_id === (selectedStudent.user_id || targetUserId)) || ((s.email || '').toLowerCase() === (selectedStudent.email || '').toLowerCase()));
-                        if (row) {
-                            const nextTeacher = row.teacher_id || null;
-                            const nextUserId = row.user_id ? String(row.user_id) : '';
-                            const shouldUpdate = (nextTeacher !== selectedStudent.teacher_id) || (nextUserId !== String(selectedStudent.user_id || ''));
-                            if (shouldUpdate) {
-                                setSelectedStudent(prev => {
-                                    if (expectedStudentId && prev?.id && String(prev.id) !== String(expectedStudentId)) return prev;
-                                    return { ...prev, teacher_id: nextTeacher, user_id: nextUserId || null };
-                                });
-                            }
-                        }
-                        loadedStudentInfo.current.add(key);
-                    }
-                }
-            } catch {}
-            try {
-                if (!selectedStudent.teacher_id && selectedStudent.email) {
-                    const cached = localStorage.getItem('student_teacher_'+selectedStudent.email);
-                    if (cached != null && cached !== String(selectedStudent.teacher_id || '')) {
-                        setSelectedStudent(prev => ({ ...prev, teacher_id: cached || null }));
-                    }
-                }
-            } catch {}
-            if (targetUserId) {
-                let wData = [];
-                const { data } = await supabase
-                    .from('workouts')
-                    .select('*, exercises(*, sets(*))')
-                    .eq('user_id', targetUserId)
-                    .eq('is_template', true)
-                    .order('name');
-                wData = data || [];
-
-                wData = (Array.isArray(wData) ? wData : []).filter((w) => w && typeof w === 'object' && w.is_template === true);
-                
-                const studentDeduped = (wData || []).sort((a,b) => (a.name||'').localeCompare(b.name||''));
-                const synced = (studentDeduped || []).filter(w => (String(w?.created_by || '') === String(user.id)) && (String(w?.user_id || '') === String(targetUserId)));
-                const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-                const others = (studentDeduped || []).filter(w => !syncedIds.has(w?.id));
-                setStudentWorkouts(others || []);
-                setSyncedWorkouts(synced || []);
-            } else {
-                setStudentWorkouts([]);
-                setSyncedWorkouts([]);
-                setAssessments([]);
-            }
-
-            // Load "Meus Treinos" for assignment list
-            const { data: { user: me } } = await supabase.auth.getUser();
-            if (me) {
-                let my = [];
-                try {
-                    const resMine = await fetch('/api/admin/workouts/mine');
-                    const jsonMine = await resMine.json();
-                    if (jsonMine.ok) my = jsonMine.rows || [];
-                    else {
-                        const { data } = await supabase
-                            .from('workouts')
-                            .select('*, exercises(*, sets(*))')
-                            .or(`created_by.eq.${me.id},user_id.eq.${me.id}`)
-                            .order('name');
-                        my = data || [];
-                    }
-                } catch {
-                    const { data } = await supabase
-                        .from('workouts')
-                        .select('*, exercises(*, sets(*))')
-                        .or(`created_by.eq.${me.id},user_id.eq.${me.id},is_template.eq.true`)
-                        .order('name');
-                    my = data || [];
-                }
-
-                my = (my || []).filter(w => (w?.user_id === me.id) && (w?.is_template === true));
-                
-                // Helper reintroduzido para deduplicação de TEMPLATES (Meus Treinos)
-                const tMap = new Map();
-                for (const w of (my || [])) {
-                    const key = workoutTitleKey(w.name);
-                    const prev = tMap.get(key);
-                    const exs = Array.isArray(w.exercises) ? w.exercises : [];
-                    const prevExs = Array.isArray(prev?.exercises) ? prev.exercises : [];
-                    const score = (x) => (Array.isArray(x) ? x.length : 0);
-                    const curHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(w?.name || ''));
-                    const prevHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(prev?.name || ''));
-                    if (
-                        !prev
-                        || score(exs) > score(prevExs)
-                        || (score(exs) === score(prevExs) && curHasPrefix && !prevHasPrefix)
-                        || (score(exs) === score(prevExs) && !!w.is_template && !prev?.is_template)
-                    ) {
-                        tMap.set(key, w);
-                    }
-                }
-                try {
-                    const resLegacy = await fetch('/api/workouts/list');
-                    const jsonLegacy = await resLegacy.json();
-                    if (jsonLegacy.ok) {
-                        for (const r of (jsonLegacy.rows || [])) {
-                            const key = workoutTitleKey(r.name);
-                            const prev = tMap.get(key);
-                            const candidate = { id: r.id || r.uuid, name: normalizeWorkoutTitle(r.name), exercises: [] };
-                            const prevExs = Array.isArray(prev?.exercises) ? prev.exercises : [];
-                            if (!prev || prevExs.length < 1) tMap.set(key, candidate);
-                        }
-                    }
-                } catch {}
-                const dedupTemplates = Array.from(tMap.values())
-                    .map((w) => ({ ...w, name: normalizeWorkoutTitle(w?.name || '') }))
-                    .sort((a,b) => (a.name||'').localeCompare(b.name||''));
-                setTemplates(dedupTemplates || []);
-            }
-            if (targetUserId) {
-                const assessmentOrParts = [];
-                if (selectedStudent?.id) assessmentOrParts.push(`student_id.eq.${selectedStudent.id}`);
-                if (targetUserId) assessmentOrParts.push(`user_id.eq.${targetUserId}`);
-                if (assessmentOrParts.length > 0) {
-                    const { data: aData } = await supabase
-                        .from('assessments')
-                        .select('*')
-                        .or(assessmentOrParts.join(','))
-                        .order('date', { ascending: false });
-                    setAssessments(aData || []);
-                } else {
-                    setAssessments([]);
-                }
-            }
-            setLoading(false);
-        };
-        fetchDetails();
-    }, [selectedStudent, supabase, user?.id, isAdmin, isTeacher]);
-
-    useEffect(() => {
-        if (!executionVideoEnabled) return;
-        if (!selectedStudent) return;
-        if (subTab !== 'videos') return;
-        let cancelled = false;
-        const run = async () => {
-            const studentUserId = selectedStudent?.user_id ? String(selectedStudent.user_id) : '';
-            if (!studentUserId) return;
-            setExecutionVideosLoading(true);
-            setExecutionVideosError('');
-            try {
-                const res = await fetch(`/api/teacher/execution-videos/by-student?student_user_id=${encodeURIComponent(studentUserId)}`, { cache: 'no-store', credentials: 'include' });
-                const json = await res.json().catch(() => null);
-                if (cancelled) return;
-                if (!res.ok || !json?.ok) {
-                    setExecutionVideos([]);
-                    setExecutionVideosError(String(json?.error || `Falha ao carregar (${res.status})`));
-                    return;
-                }
-                setExecutionVideos(Array.isArray(json.items) ? json.items : []);
-            } catch (e) {
-                if (!cancelled) {
-                    setExecutionVideos([]);
-                    setExecutionVideosError(e?.message ? String(e.message) : 'Erro ao carregar');
-                }
-            } finally {
-                if (!cancelled) setExecutionVideosLoading(false);
-            }
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [executionVideoEnabled, selectedStudent, subTab]);
-
-    useEffect(() => {
-        if (!selectedStudent) return;
-        if (subTab !== 'checkins') return;
-        let cancelled = false;
-        const run = async () => {
-            try {
-                setStudentCheckinsLoading(true);
-                setStudentCheckinsError('');
-                const looksLikeUuid = (v) => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(v || '').trim());
-                const rawCandidate = selectedStudent?.user_id || selectedStudent?.id || '';
-                const studentUserId = looksLikeUuid(rawCandidate) ? String(rawCandidate) : '';
-                if (!studentUserId) {
-                    setStudentCheckinsRows([]);
-                    setStudentCheckinsError('Aluno sem user_id (não é possível buscar check-ins).');
-                    return;
-                }
-
-                const days = String(studentCheckinsRange || '7d') === '30d' ? 30 : 7;
-                const startIso = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
-                let q = supabase
-                    .from('workout_checkins')
-                    .select('id, kind, created_at, energy, mood, soreness, notes, answers, workout_id, planned_workout_id')
-                    .eq('user_id', studentUserId)
-                    .gte('created_at', startIso)
-                    .order('created_at', { ascending: false })
-                    .limit(400);
-                if (studentCheckinsFilter && studentCheckinsFilter !== 'all') q = q.eq('kind', String(studentCheckinsFilter));
-                const { data, error } = await q;
-                if (error) throw error;
-                if (cancelled) return;
-                setStudentCheckinsRows(Array.isArray(data) ? data : []);
-            } catch (e) {
-                if (cancelled) return;
-                setStudentCheckinsRows([]);
-                setStudentCheckinsError(e?.message ? String(e.message) : 'Falha ao carregar check-ins.');
-            } finally {
-                if (!cancelled) setStudentCheckinsLoading(false);
-            }
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [selectedStudent, subTab, studentCheckinsFilter, studentCheckinsRange, supabase]);
-
-    // Ensure teachers list available when viewing a student (for assignment)
-    useEffect(() => {
-        if (!selectedStudent || !isAdmin) return;
-        const loadTeachers = async () => {
-            try {
-                const res = await fetch('/api/admin/teachers/list');
-                const json = await res.json();
-                if (json.ok) {
-                    const base = json.teachers || [];
-                    let enriched = base;
-                    try {
-                        const emails = base.map(t => t.email).filter(Boolean);
-                        if (emails.length > 0) {
-                            const { data: profilesMap } = await supabase
-                                .from('profiles')
-                                .select('id, email')
-                                .in('email', emails);
-                            const idByEmail = new Map((profilesMap || []).map(p => [p.email, p.id]));
-                            enriched = base.map(t => ({ ...t, user_id: idByEmail.get(t.email) || null }));
-                        }
-                    } catch {}
-                    const currentUid = selectedStudent?.teacher_id || '';
-                    if (currentUid && !enriched.some(t => t.user_id === currentUid)) {
-                        try {
-                            const { data: curProfile } = await supabase
-                                .from('profiles')
-                                .select('id, display_name, email')
-                                .eq('id', currentUid)
-                                .maybeSingle();
-                            if (curProfile) {
-                                enriched = [{ id: curProfile.id, name: curProfile.display_name, email: curProfile.email, user_id: curProfile.id, status: 'active' }, ...enriched];
-                            } else {
-                                enriched = [{ id: currentUid, name: 'Professor atribuído', email: '', user_id: currentUid, status: 'active' }, ...enriched];
-                            }
-                        } catch {
-                            enriched = [{ id: currentUid, name: 'Professor atribuído', email: '', user_id: currentUid, status: 'active' }, ...enriched];
-                        }
-                    }
-                    setTeachersList(enriched);
-                }
-            } catch {}
-        };
-        loadTeachers();
-    }, [selectedStudent, isAdmin, supabase]);
-
-    const handleRegisterStudent = async () => {
-        if (!newStudent.name || !newStudent.email) return await alert('Preencha nome e email.');
-        setRegistering(true);
-        try {
-            const { data, error } = await supabase
-                .from('students')
-                .insert({ name: newStudent.name, email: newStudent.email, teacher_id: user.id })
-                .select();
-            if (error) throw error;
-            setUsersList(prev => (data?.[0] ? [data[0], ...prev] : prev));
-            setShowRegisterModal(false);
-            setNewStudent({ name: '', email: '' });
-            await alert('Aluno cadastrado com sucesso!', 'Sucesso');
-        } catch (e) {
-            await alert('Erro ao cadastrar: ' + (e?.message ?? String(e)));
-        } finally {
-            setRegistering(false);
-        }
-    };
-
-    // Assign template workout to selected student (clone workout and exercises)
-    const handleAddTemplateToStudent = async (template) => {
-        if (!selectedStudent) return;
-        const targetUserId = selectedStudent.user_id || '';
-        if (!targetUserId) { await alert('Aluno sem conta (user_id).'); return; }
-        if (!(await confirm(`Adicionar treino "${template?.name || 'Treino'}" para ${selectedStudent.name || selectedStudent.email}?`))) return;
-        try {
-            const payload = {
-                user_id: targetUserId,
-                created_by: user?.id,
-                is_template: true,
-                name: template?.name || '',
-                notes: template?.notes || ''
-            };
-            const { data: newWorkout, error: wErr } = await supabase
-                .from('workouts')
-                .insert(payload)
-                .select()
-                .single();
-            if (wErr) throw wErr;
-            const toInsert = (template?.exercises || []).map(e => ({
-                workout_id: newWorkout.id,
-                name: e?.name || '',
-                sets: getSetsCount(e?.sets) || 4,
-                reps: e?.reps ?? '10',
-                rpe: e?.rpe ?? 8,
-                cadence: e?.cadence || '2020',
-                rest_time: e?.rest_time ?? 60,
-                method: e?.method || 'Normal',
-                video_url: e?.video_url || '',
-                notes: e?.notes || ''
-            }));
-            let newExs = [];
-            if (toInsert.length) {
-                const { data: exRows, error: exErr } = await supabase.from('exercises').insert(toInsert).select();
-                if (exErr) throw exErr;
-                newExs = exRows || [];
-            }
-            for (let i = 0; i < (template?.exercises || []).length; i++) {
-                const srcEx = template?.exercises?.[i] || {};
-                const dstEx = newExs[i] || null;
-                const setsArr = Array.isArray(srcEx?.sets) ? srcEx.sets : [];
-                if (dstEx && setsArr.length) {
-                    const newSets = setsArr.map(s => ({
-                        exercise_id: dstEx.id,
-                        weight: s?.weight ?? null,
-                        reps: s?.reps ?? null,
-                        rpe: s?.rpe ?? null,
-                        set_number: s?.set_number ?? 1,
-                        completed: s?.completed ?? false
-                    }));
-                    if (newSets.length) {
-                        const { error: setErr } = await supabase.from('sets').insert(newSets);
-                        if (setErr) throw setErr;
-                    }
-                }
-            }
-            let refreshed = [];
-            const targetUserId = selectedStudent.user_id || '';
-            if (!targetUserId) { await alert('Aluno sem conta (user_id).'); return; }
-            const { data } = await supabase
-                .from('workouts')
-                .select('*, exercises(*, sets(*))')
-                .eq('user_id', targetUserId)
-                .eq('is_template', true)
-                .order('name');
-            refreshed = data || [];
-            refreshed = (Array.isArray(refreshed) ? refreshed : []).filter((w) => w && typeof w === 'object' && w.is_template === true);
-            const synced = (refreshed || []).filter(w => (String(w?.created_by || '') === String(user.id)) && (String(w?.user_id || '') === String(targetUserId)));
-            const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-            const others = (refreshed || []).filter(w => !syncedIds.has(w?.id));
-            setStudentWorkouts(others || []);
-            setSyncedWorkouts(synced || []);
-            await alert('Treino enviado com sucesso!', 'Sucesso');
-        } catch (e) {
-            await alert('Erro ao enviar: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleSendBroadcast = async () => {
-        if (!broadcastTitle || !broadcastMsg) return await alert('Preencha título e mensagem.');
-        setSendingBroadcast(true);
-        try {
-            const res = await sendBroadcastMessage(broadcastTitle, broadcastMsg);
-            if (res.error) throw new Error(res.error);
-            await alert('Aviso enviado!', 'Sucesso');
-            setBroadcastTitle('');
-            setBroadcastMsg('');
-        } catch (e) {
-            await alert('Erro ao enviar: ' + (e?.message ?? String(e)));
-        } finally {
-            setSendingBroadcast(false);
-        }
-    };
-
-    const handleEditStudent = () => {
-        if (!selectedStudent) return;
-        setEditedStudent({ name: selectedStudent.name || '', email: selectedStudent.email || '' });
-        setEditingStudent(true);
-    };
-
-    const handleSaveStudentEdit = async () => {
-        if (!selectedStudent || !editedStudent.name || !editedStudent.email) return await alert('Preencha todos os campos.');
-        try {
-            const { error } = await supabase
-                .from('students')
-                .update({ name: editedStudent.name, email: editedStudent.email })
-                .eq('id', selectedStudent.id);
-            if (error) throw error;
-            setSelectedStudent(prev => ({ ...prev, name: editedStudent.name, email: editedStudent.email }));
-            setUsersList(prev => prev.map(s => s.id === selectedStudent.id ? { ...s, name: editedStudent.name, email: editedStudent.email } : s));
-            setEditingStudent(false);
-            await alert('Dados do aluno atualizados.');
-        } catch (e) {
-            await alert('Erro ao salvar: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleAddTeacher = async () => {
-        if (!newTeacher.name || !newTeacher.email) return await alert('Preencha nome e email.');
-        setAddingTeacher(true);
-        try {
-            const res = await addTeacher(newTeacher.name, newTeacher.email, newTeacher.phone, newTeacher.birth_date);
-            if (res.error) throw new Error(res.error);
-            
-            await alert('Professor adicionado com sucesso!');
-            setShowTeacherModal(false);
-            setNewTeacher({ name: '', email: '', phone: '', birth_date: '' });
-            // Trigger refresh (simple way)
-            setTab('dashboard'); setTimeout(() => setTab('teachers'), 100);
-        } catch (e) {
-            await alert('Erro ao adicionar professor: ' + (e?.message ?? String(e)));
-        } finally {
-            setAddingTeacher(false);
-        }
-    };
-
-    const handleUpdateTeacher = async () => {
-        if (!editingTeacher || !editingTeacher.name || !editingTeacher.email) return await alert('Preencha nome e email.');
-        try {
-            const res = await updateTeacher(editingTeacher.id, {
-                name: editingTeacher.name,
-                email: editingTeacher.email,
-                phone: editingTeacher.phone,
-                birth_date: editingTeacher.birth_date
-            });
-            if (res.error) throw new Error(res.error);
-            await alert('Professor atualizado com sucesso!');
-            setEditingTeacher(null);
-            // Trigger refresh
-            setTab('dashboard'); setTimeout(() => setTab('teachers'), 100);
-        } catch (e) {
-            await alert('Erro ao atualizar professor: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleDangerAction = async (actionName, actionFn) => {
-        if (!(await confirm(`Tem certeza que deseja ${actionName}?`, 'ATENÇÃO - PERIGO'))) return false;
-        if (!(await confirm(`Esta ação é IRREVERSÍVEL. Todos os dados serão perdidos. Confirmar mesmo?`, 'CONFIRMAÇÃO FINAL'))) return false;
-
-        try {
-            const res = await actionFn();
-            if (res?.error) throw new Error(res.error);
-            await alert(`${actionName} realizado com sucesso.`, 'Sucesso');
-            setUsersList([]);
-            setTeachersList([]);
-            setTemplates([]);
-            return true;
-        } catch (e) {
-            await alert(`Erro ao executar ${actionName}: ` + (e?.message ?? String(e)));
-            return false;
-        }
-    };
-
-	const runDangerAction = async (actionKey, actionName, actionFn, resetInput) => {
-		setDangerActionLoading(actionKey);
-		try {
-			const ok = await handleDangerAction(actionName, actionFn);
-			if (ok) resetInput();
-		} finally {
-			setDangerActionLoading(null);
-		}
-	};
-
-	let TAB_LABELS = { dashboard: 'VISÃO GERAL', students: 'ALUNOS', templates: 'TREINOS' };
-	if (isAdmin) {
-		TAB_LABELS = { ...TAB_LABELS, teachers: 'PROFESSORES', videos: 'VÍDEOS', errors: 'ERROS', system: 'SISTEMA' };
-	}
-	if (isTeacher && !isAdmin) {
-		TAB_LABELS = { ...TAB_LABELS, priorities: 'PRIORIDADES' };
-	}
-	if (isAdmin) {
-		TAB_LABELS = { ...TAB_LABELS, priorities: 'PRIORIDADES' };
-	}
-
-	const tabKeys = Object.keys(TAB_LABELS);
-	const currentTabLabel = TAB_LABELS[tab] || 'VISÃO GERAL';
-
-	const totalStudents = Array.isArray(usersList) ? usersList.length : 0;
-	const studentsWithTeacher = Array.isArray(usersList) ? usersList.filter(s => !!s.teacher_id).length : 0;
-	const studentsWithoutTeacher = Array.isArray(usersList) ? usersList.filter(s => !s.teacher_id).length : 0;
-	const totalTeachers = Array.isArray(teachersList) ? teachersList.length : 0;
-
-	const studentStatusStats = useMemo(() => {
-		const list = Array.isArray(usersList) ? usersList : [];
-		const stats = { pago: 0, pendente: 0, atrasado: 0, cancelar: 0, outros: 0 };
-		for (const s of list) {
-			try {
-				const rawStatus = s && typeof s === 'object' ? s.status : null;
-				const key = String(rawStatus || 'pendente').toLowerCase().trim();
-				if (Object.prototype.hasOwnProperty.call(stats, key)) {
-					stats[key] += 1;
-				} else {
-					stats.outros += 1;
-				}
-			} catch {}
-		}
-		return stats;
-	}, [usersList]);
-
-	const dashboardCharts = useMemo(() => {
-		const baseTotalStudents = typeof totalStudents === 'number' && Number.isFinite(totalStudents) && totalStudents > 0 ? totalStudents : 0;
-		const baseWith = typeof studentsWithTeacher === 'number' && Number.isFinite(studentsWithTeacher) && studentsWithTeacher > 0 ? studentsWithTeacher : 0;
-		const baseWithout = typeof studentsWithoutTeacher === 'number' && Number.isFinite(studentsWithoutTeacher) && studentsWithoutTeacher > 0 ? studentsWithoutTeacher : 0;
-
-		const teacherData = {
-			labels: ['Com professor', 'Sem professor'],
-			datasets: [
-				{
-					label: 'Alunos',
-					data: [baseWith, baseWithout],
-					backgroundColor: ['rgba(250, 204, 21, 0.9)', 'rgba(82, 82, 82, 0.9)'],
-					borderRadius: 999,
-					maxBarThickness: 40
-				}
-			]
-		};
-
-		const totalStatus =
-			studentStatusStats.pago +
-			studentStatusStats.pendente +
-			studentStatusStats.atrasado +
-			studentStatusStats.cancelar +
-			studentStatusStats.outros;
-
-		const statusValues =
-			totalStatus > 0
-				? [
-					studentStatusStats.pago,
-					studentStatusStats.pendente,
-					studentStatusStats.atrasado,
-					studentStatusStats.cancelar,
-					studentStatusStats.outros
-				]
-				: [0, 0, 0, 0, 0];
-
-		const statusData = {
-			labels: ['Pago', 'Pendente', 'Atrasado', 'Cancelar', 'Outros'],
-			datasets: [
-				{
-					label: 'Alunos',
-					data: statusValues,
-					backgroundColor: [
-						'rgba(34, 197, 94, 0.9)',
-						'rgba(234, 179, 8, 0.9)',
-						'rgba(248, 113, 113, 0.9)',
-						'rgba(148, 163, 184, 0.9)',
-						'rgba(82, 82, 82, 0.9)'
-					],
-					borderRadius: 12,
-					maxBarThickness: 32
-				}
-			]
-		};
-
-		const baseOptions = {
-			responsive: true,
-			maintainAspectRatio: false,
-			plugins: {
-				legend: {
-					display: false,
-					labels: {
-						color: '#a3a3a3',
-						font: { size: 10, weight: '600' }
-					}
-				},
-				tooltip: {
-					enabled: true,
-					backgroundColor: 'rgba(10,10,10,0.9)',
-					borderColor: '#404040',
-					borderWidth: 1,
-					titleColor: '#fafafa',
-					bodyColor: '#e5e5e5',
-					padding: 8,
-					displayColors: false
-				}
-			},
-			scales: {
-				x: {
-					grid: {
-						display: false,
-						drawBorder: false
-					},
-					ticks: {
-						color: '#a3a3a3',
-						font: { size: 10, weight: '600' }
-					}
-				},
-				y: {
-					beginAtZero: true,
-					grid: {
-						color: 'rgba(64,64,64,0.6)',
-						drawBorder: false
-					},
-					ticks: {
-						color: '#737373',
-						font: { size: 9, weight: '500' },
-						precision: 0,
-						stepSize: 1
-					}
-				}
-			}
-		};
-
-		const teacherOptions = {
-			...baseOptions,
-			onClick: () => {
-				try {
-					setTab('students');
-					setSelectedStudent(null);
-				} catch {}
-			}
-		};
-
-		const statusOptions = {
-			...baseOptions,
-			onClick: (evt, elements) => {
-				try {
-					if (!elements || elements.length === 0) return;
-					const first = elements[0];
-					const index = typeof first?.index === 'number' ? first.index : null;
-					if (index == null || !Number.isFinite(index)) return;
-					const mapping = ['pago', 'pendente', 'atrasado', 'cancelar', 'outros'];
-					const key = mapping[index];
-					if (!key) return;
-					setStudentStatusFilter(key);
-					setTab('students');
-					setSelectedStudent(null);
-				} catch {}
-			}
-		};
-
-		return {
-			teacherDistribution: {
-				data: teacherData,
-				options: teacherOptions
-			},
-			statusDistribution: {
-				data: statusData,
-				options: statusOptions
-			},
-			statusTotal: totalStatus,
-			totalStudents: baseTotalStudents
-		};
-	}, [totalStudents, studentsWithTeacher, studentsWithoutTeacher, studentStatusStats, setStudentStatusFilter, setTab, setSelectedStudent]);
-
-	if (!isAdmin && !isTeacher) return null;
-
-	const selectedStatus = normalizeText(selectedStudent?.status || '');
-    const selectedStatusLabel = String(selectedStudent?.status || 'pendente');
-    const selectedStatusTone = selectedStatus === 'pago'
-        ? 'bg-green-500/10 text-green-400 border-green-500/30'
-        : (selectedStatus === 'atrasado'
-            ? 'bg-red-500/10 text-red-400 border-red-500/30'
-            : (selectedStatus === 'cancelar'
-                ? 'bg-neutral-500/10 text-neutral-300 border-neutral-500/25'
-                : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30'));
-
-    return (
-        <div data-tour="adminpanel.root" className="fixed inset-0 z-50 bg-neutral-950 text-white flex flex-col overflow-hidden">
-            <div className="sticky top-0 z-50 bg-neutral-950/90 backdrop-blur-xl border-b border-neutral-800 shadow-[0_16px_40px_rgba(0,0,0,0.55)] pt-safe flex-shrink-0">
-                {debugError && (
-                    <div className="bg-red-600 text-white font-bold p-4 text-center text-xs break-all mb-2 rounded-xl">
-                        DIAGNOSTIC MODE: {debugError}
-                    </div>
-                )}
-				<div className="px-4 md:px-8 py-2">
-					<div className="w-full flex flex-col md:flex-row md:items-center md:justify-between gap-1 md:gap-4">
-						<div className="flex items-center justify-between gap-3">
-							<div className="flex items-center gap-3">
-                                <button
-                                    type="button"
-                                    onClick={() => { setSelectedStudent(null); setTab('dashboard'); }}
-                                    className="flex items-center gap-3 cursor-pointer group active:scale-[0.99] transition-transform"
-                                >
-                                    <div className="w-10 h-10 rounded-2xl bg-yellow-500 flex items-center justify-center shadow-lg shadow-yellow-500/20 border border-yellow-400/40">
-                                        <Crown size={20} className="text-black" />
-                                    </div>
-                                    <div className="flex flex-col items-start">
-                                        <span className="text-[11px] font-bold uppercase tracking-[0.2em] text-yellow-500/80">IronTracks</span>
-                                        <span className="text-sm md:text-base font-black text-white leading-tight">Painel de Controle</span>
-                                    </div>
-                                </button>
-                                <div className="hidden md:block text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Operações do seu negócio</div>
-                            </div>
-							<button
-								onClick={() => onClose && onClose()}
-								className="md:hidden flex-shrink-0 w-10 h-10 rounded-full bg-neutral-900/70 hover:bg-neutral-800 text-neutral-300 hover:text-white flex items-center justify-center transition-all border border-neutral-800 active:scale-95"
-							>
-								<X size={18} className="font-bold" />
-							</button>
-						</div>
-						
-						<div className="flex items-center gap-2 min-w-0 mt-1 md:mt-0">
-                            <div className="flex-1 min-w-0">
-                                <div data-tour="adminpanel.tabs" className="hidden md:flex items-center gap-2 justify-end flex-wrap">
-                                    {Object.entries(TAB_LABELS).map(([key, label]) => (
-                                        <button
-                                            key={key}
-                                            onClick={() => { setTab(key); setSelectedStudent(null); setMoreTabsOpen(false); }}
-                                            className={`min-h-[40px] px-3.5 md:px-4 py-2 rounded-full font-black text-[11px] uppercase tracking-wide whitespace-nowrap transition-all duration-300 border active:scale-95 ${
-                                                tab === key
-                                                    ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/20'
-                                                    : 'bg-neutral-900/70 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            {label}
-                                        </button>
-                                    ))}
-                                    <button
-                                        onClick={() => onClose && onClose()}
-                                        className="hidden md:inline-flex items-center justify-center w-10 h-10 rounded-full bg-neutral-900/70 hover:bg-neutral-800 text-neutral-300 hover:text-white transition-all border border-neutral-800 active:scale-95 ml-1"
-                                    >
-                                        <X size={18} className="font-bold" />
-                                    </button>
-                                </div>
-
-                                <div className="md:hidden flex items-center gap-2">
-                                    <button
-                                        type="button"
-                                        data-tour="adminpanel.tabs"
-                                        onClick={() => setMoreTabsOpen(true)}
-                                        className="flex-1 min-h-[44px] px-4 rounded-2xl bg-neutral-900/80 border border-neutral-800 flex items-center justify-between gap-3 shadow-[0_10px_30px_rgba(0,0,0,0.35)] active:scale-95 transition-all duration-300"
-                                    >
-                                        <span className="text-[11px] font-black uppercase tracking-widest text-neutral-100 truncate">{currentTabLabel}</span>
-                                        <ChevronDown size={18} className="text-neutral-300" />
-                                    </button>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                </div>
-            </div>
-
-            {moreTabsOpen && (
-                <div
-                    className="md:hidden fixed inset-0 z-[60]"
-                    role="dialog"
-                    aria-modal="true"
-                    onClick={() => setMoreTabsOpen(false)}
-                >
-                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" />
-                    <div className="absolute inset-x-0 bottom-0 pb-safe" onClick={(e) => e.stopPropagation()}>
-                        <div className="mx-auto w-full max-w-md rounded-t-3xl bg-neutral-950 border border-neutral-800 shadow-[0_-20px_60px_rgba(0,0,0,0.65)] overflow-hidden">
-                            <div className="px-4 pt-3 pb-2 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Mais</div>
-                                    <div className="text-base font-black text-white">Navegação</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => setMoreTabsOpen(false)}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-3 grid gap-2">
-                                {(Array.isArray(tabKeys) ? tabKeys : []).map((key) => {
-                                    const isActive = tab === key;
-                                    const label = TAB_LABELS[key] || key;
-                                    let subtitle = '';
-                                    if (key === 'dashboard') subtitle = 'Visão geral do negócio';
-                                    else if (key === 'students') subtitle = 'Gestão de alunos e status';
-                                    else if (key === 'templates') subtitle = 'Biblioteca de treinos-base';
-                                    else if (key === 'teachers') subtitle = 'Gestão de professores e convites';
-                                    else if (key === 'videos') subtitle = 'Fila de vídeos por exercício';
-                                    else if (key === 'priorities') subtitle = 'Triagem inteligente do coach';
-                                    else if (key === 'errors') subtitle = 'Erros reportados pelos usuários';
-                                    else if (key === 'system') subtitle = 'Backup, broadcasts e operações críticas';
-
-                                    let iconColor = isActive ? 'text-yellow-400' : 'text-neutral-400';
-                                    let badgeClass = isActive
-                                        ? 'bg-yellow-500/15 border-yellow-500/40'
-                                        : 'bg-neutral-900 border-neutral-800';
-
-                                    if (key === 'system') {
-                                        iconColor = isActive ? 'text-red-400' : 'text-red-300';
-                                        badgeClass = isActive
-                                            ? 'bg-red-900/60 border-red-500/60'
-                                            : 'bg-red-950/70 border-red-700/70';
-                                    }
-
-                                    return (
-                                        <button
-                                            key={key}
-                                            type="button"
-                                            onClick={() => { setTab(key); setSelectedStudent(null); setMoreTabsOpen(false); }}
-                                            className={`w-full min-h-[56px] px-4 rounded-2xl border flex items-center justify-between gap-3 transition-all duration-300 active:scale-[0.99] ${
-                                                isActive
-                                                    ? key === 'system'
-                                                        ? 'bg-red-900/20 text-red-300 border-red-500/40 shadow-lg shadow-red-500/20'
-                                                        : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30 shadow-lg shadow-yellow-500/10'
-                                                    : key === 'system'
-                                                        ? 'bg-neutral-900/80 text-red-300 border-red-800 hover:bg-neutral-900'
-                                                        : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className={`w-9 h-9 rounded-2xl flex items-center justify-center flex-shrink-0 border ${badgeClass}`}>
-                                                    {key === 'dashboard' && <Crown size={16} className={iconColor} />}
-                                                    {key === 'students' && <UserPlus size={16} className={iconColor} />}
-                                                    {key === 'templates' && <Dumbbell size={16} className={iconColor} />}
-                                                    {key === 'teachers' && <UserCog size={16} className={iconColor} />}
-                                                    {key === 'videos' && <Play size={16} className={iconColor} />}
-                                                    {key === 'priorities' && <AlertCircle size={16} className={iconColor} />}
-                                                    {key === 'errors' && <AlertTriangle size={16} className={iconColor} />}
-                                                    {key === 'system' && <ShieldAlert size={16} className={iconColor} />}
-                                                </div>
-                                                <div className="min-w-0 text-left">
-                                                    <div className="font-black text-[12px] uppercase tracking-widest truncate">{label}</div>
-                                                    {subtitle && (
-                                                        <div className="text-[11px] text-neutral-400 truncate">
-                                                            {subtitle}
-                                                        </div>
-                                                    )}
-                                                </div>
-                                            </div>
-                                            <ChevronDown
-                                                size={16}
-                                                className={`transition-transform text-neutral-500 ${isActive ? 'rotate-90' : '-rotate-90'}`}
-                                            />
-                                        </button>
-                                    );
-                                })}
-                            </div>
-                        </div>
-                    </div>
-                </div>
-            )}
-
-			<div className="flex-1 min-h-0 overflow-y-auto p-4 pb-20 pb-safe">
-				{tab === 'dashboard' && !selectedStudent && (
-					<div className="w-full">
-						<div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
-							<div
-								className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-								onClick={() => { setTab('students'); setSelectedStudent(null); }}
-							>
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Total Alunos</h3>
-								<p className="text-3xl font-black text-white mt-1">{totalStudents}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Clique para ir direto à aba Alunos.</p>
-							</div>
-							<div className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800">
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Com Professor</h3>
-								<p className="text-3xl font-black text-green-400 mt-1">{studentsWithTeacher}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Alunos vinculados a pelo menos um professor.</p>
-							</div>
-							<div
-								className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-								onClick={() => { setTab('students'); setSelectedStudent(null); }}
-							>
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Sem Professor</h3>
-								<p className="text-3xl font-black text-yellow-500 mt-1">{studentsWithoutTeacher}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Alunos aguardando vínculo ou triagem.</p>
-							</div>
-							<div
-								className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-								onClick={() => { setTab('templates'); setSelectedStudent(null); }}
-							>
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Treinos Criados</h3>
-								<p className="text-3xl font-black text-white mt-1">{myWorkoutsCount ?? '-'}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Modelos de treino disponíveis para uso imediato.</p>
-							</div>
-							{isAdmin && (
-								<div
-									className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-									onClick={() => { setTab('teachers'); setSelectedStudent(null); }}
-								>
-									<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Professores Ativos</h3>
-									<p className="text-3xl font-black text-white mt-1">{totalTeachers}</p>
-									<p className="mt-2 text-[11px] text-neutral-500">Gestão completa na aba Professores.</p>
-								</div>
-							)}
-						</div>
-
-						<div className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
-							<div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)] h-64">
-								<div className="flex items-center justify-between gap-3 mb-3">
-									<div>
-										<h3 className="text-[11px] font-black uppercase tracking-widest text-neutral-400">Distribuição Alunos</h3>
-										<p className="text-[11px] text-neutral-500 mt-1">Com professor vs sem professor.</p>
-									</div>
-									<div className="text-[11px] text-neutral-500 font-semibold">
-										{dashboardCharts.totalStudents} total
-									</div>
-								</div>
-								<div className="h-[180px]">
-									{dashboardCharts?.teacherDistribution && (
-										<Bar data={dashboardCharts.teacherDistribution.data} options={dashboardCharts.teacherDistribution.options} />
-									)}
-								</div>
-							</div>
-							<div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)] h-64">
-								<div className="flex items-center justify-between gap-3 mb-3">
-									<div>
-										<h3 className="text-[11px] font-black uppercase tracking-widest text-neutral-400">Status de Pagamento</h3>
-										<p className="text-[11px] text-neutral-500 mt-1">Distribuição rápida por status financeiro.</p>
-									</div>
-									<div className="text-[11px] text-neutral-500 font-semibold">
-										{dashboardCharts.statusTotal} registros
-									</div>
-								</div>
-								<div className="h-[180px]">
-									{dashboardCharts?.statusDistribution && (
-										<Bar data={dashboardCharts.statusDistribution.data} options={dashboardCharts.statusDistribution.options} />
-									)}
-								</div>
-							</div>
-						</div>
-						
-						{isTeacher && coachInboxItems.length > 0 && (
-							<div data-tour="adminpanel.dashboard.coachInbox" className="mt-6 bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3 mb-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Coach Inbox</div>
-                                        <div className="text-xs text-neutral-400 mt-1">
-                                            Alunos que mais precisam de atenção com base na atividade recente.
-                                        </div>
-                                    </div>
-                                    <div className="text-[11px] font-bold text-neutral-400">
-                                        {coachInboxItems.length} prioridade{coachInboxItems.length > 1 ? 's' : ''}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    {coachInboxItems.map((item) => (
-                                        <button
-                                            key={item.id}
-                                            type="button"
-                                            onClick={() => {
-                                                const list = Array.isArray(usersList) ? usersList : [];
-                                                const target = list.find((s) => s && s.id === item.id);
-                                                if (target) setSelectedStudent(target);
-                                            }}
-                                            className="w-full text-left bg-neutral-900 border border-neutral-800 hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 rounded-2xl px-3 py-3 flex items-center justify-between gap-3 transition-all duration-300 active:scale-[0.99]"
-                                        >
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-full bg-neutral-950 border border-neutral-700 flex items-center justify-center text-xs font-black text-neutral-200 flex-shrink-0">
-                                                    {(item.name || item.email || '?').slice(0, 2).toUpperCase()}
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-sm font-semibold text-white truncate">{item.name || item.email}</div>
-                                                    <div className="text-[11px] text-neutral-500 truncate">{item.email}</div>
-                                                </div>
-                                            </div>
-                                            <div className="flex flex-col items-end gap-1 flex-shrink-0">
-                                                <div
-                                                    className={
-                                                        item.hasWorkouts
-                                                            ? 'px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-yellow-500/10 text-yellow-400 border border-yellow-500/40'
-                                                            : 'px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-500/10 text-red-400 border border-red-500/40'
-                                                    }
-                                                >
-                                                    {item.hasWorkouts
-                                                        ? `${item.daysSinceLastWorkout ?? 0}d sem treino`
-                                                        : 'Nenhum treino registrado'}
-                                                </div>
-                                                <div className="text-[10px] text-neutral-500 font-semibold capitalize truncate">
-                                                    Status: {String(item.status || 'pendente')}
-                                                </div>
-                                            </div>
-                                        </button>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-                    </div>
-                )}
-
-				{tab === 'priorities' && !selectedStudent && (
-					<div className="w-full space-y-4">
-						<div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-							<div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-								<div className="min-w-0">
-									<div className="flex items-center gap-2">
-										<AlertCircle size={18} className="text-yellow-500" />
-										<h2 className="text-base md:text-lg font-black tracking-tight">Prioridades</h2>
-									</div>
-									<div className="mt-1 text-xs text-neutral-400 font-semibold">
-										{prioritiesLoading ? 'Carregando...' : `${Array.isArray(prioritiesItems) ? prioritiesItems.length : 0} item(ns)`}
-									</div>
-								</div>
-								<div className="flex flex-col sm:flex-row gap-2">
-									<button
-										type="button"
-										onClick={async () => {
-											try {
-												setPrioritiesSettingsOpen(true);
-												await loadPrioritiesSettings();
-											} catch {}
-										}}
-										className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95"
-									>
-										Configurar
-									</button>
-									<button
-										type="button"
-										onClick={() => fetchPriorities()}
-										disabled={prioritiesLoading}
-										className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 disabled:opacity-60"
-									>
-										Atualizar
-									</button>
-								</div>
-							</div>
-						</div>
-
-						{prioritiesError ? (
-							<div className="bg-neutral-900/60 border border-red-500/30 rounded-2xl p-4 text-red-200 font-bold text-sm">
-								{prioritiesError}
-							</div>
-						) : null}
-
-						{prioritiesLoading ? (
-							<div className="text-center animate-pulse text-neutral-400 font-semibold">Carregando prioridades...</div>
-						) : !Array.isArray(prioritiesItems) || prioritiesItems.length === 0 ? (
-							<div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 text-neutral-400 font-semibold">
-								Nenhuma prioridade no momento.
-							</div>
-						) : (
-							<div className="space-y-3">
-								{prioritiesItems.map((it) => {
-									const itemId = String(it?.id || '').trim();
-									const studentId = String(it?.student_user_id || '').trim();
-									const studentName = String(it?.student_name || '').trim();
-									const kind = String(it?.kind || '').trim();
-									const title = String(it?.title || '').trim();
-									const reason = String(it?.reason || '').trim();
-									const msg = String(it?.suggested_message || '').trim();
-									const badgeTone =
-										kind === 'load_spike'
-											? 'border-red-500/30 text-red-300'
-											: kind === 'checkins_alert'
-												? 'border-red-500/30 text-red-300'
-											: kind === 'volume_drop'
-												? 'border-yellow-500/30 text-yellow-300'
-												: 'border-neutral-500/30 text-neutral-200';
-									return (
-										<div key={itemId || `${studentId}:${kind}`} className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-											<div className="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
-												<div className="min-w-0">
-													<div className="flex flex-wrap items-center gap-2">
-														<div className="text-base font-black text-white truncate">{studentName || 'Aluno'}</div>
-														<span className={`px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${badgeTone}`}>{title || kind}</span>
-													</div>
-													{reason ? (
-														<div className="mt-1 text-xs text-neutral-400 font-semibold">{reason}</div>
-													) : null}
-												</div>
-												<div className="flex flex-col sm:flex-row gap-2">
-													<button
-														type="button"
-														onClick={() => {
-															try {
-																const found = (Array.isArray(usersList) ? usersList : []).find((s) => String(s?.user_id || '').trim() === studentId);
-																setTab('students');
-																setSelectedStudent(found || null);
-																if (!found) setStudentQuery(studentName || '');
-															} catch {}
-														}}
-														className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Ver aluno
-													</button>
-													<button
-														type="button"
-														onClick={() => {
-															setPrioritiesComposeStudentId(studentId);
-															setPrioritiesComposeKind(kind);
-															setPrioritiesComposeText(msg);
-															setPrioritiesComposeOpen(true);
-														}}
-														className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Enviar mensagem
-													</button>
-													<button
-														type="button"
-														onClick={async () => {
-															try {
-																const v = await prompt('Sonecar (minutos)', String(prioritiesSettings?.snoozeDefaultMinutes ?? COACH_INBOX_DEFAULTS.snoozeDefaultMinutes));
-																const minutes = Number(String(v || '').trim());
-																if (!Number.isFinite(minutes) || minutes <= 0) return;
-																const res = await fetch('/api/teacher/inbox/action', {
-																	method: 'POST',
-																	credentials: 'include',
-																	headers: { 'content-type': 'application/json' },
-																	body: JSON.stringify({ student_user_id: studentId, kind, action: 'snooze', snooze_minutes: minutes }),
-																});
-																const json = await res.json().catch(() => null);
-																if (!res.ok || !json?.ok) {
-																	await alert(String(json?.error || `Falha ao sonecar (${res.status})`));
-																	return;
-																}
-																setPrioritiesItems((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== itemId) : prev));
-															} catch (e) {
-																await alert('Erro: ' + (e?.message ?? String(e)));
-															}
-														}}
-														className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Sonecar
-													</button>
-													<button
-														type="button"
-														onClick={async () => {
-															try {
-																const ok = await confirm('Concluir este item?', 'Prioridades');
-																if (!ok) return;
-																const res = await fetch('/api/teacher/inbox/action', {
-																	method: 'POST',
-																	credentials: 'include',
-																	headers: { 'content-type': 'application/json' },
-																	body: JSON.stringify({ student_user_id: studentId, kind, action: 'done' }),
-																});
-																const json = await res.json().catch(() => null);
-																if (!res.ok || !json?.ok) {
-																	await alert(String(json?.error || `Falha ao concluir (${res.status})`));
-																	return;
-																}
-																setPrioritiesItems((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== itemId) : prev));
-															} catch (e) {
-																await alert('Erro: ' + (e?.message ?? String(e)));
-															}
-														}}
-														className="min-h-[44px] px-4 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Concluir
-													</button>
-												</div>
-											</div>
-										</div>
-									);
-								})}
-							</div>
-						)}
-					</div>
-				)}
-
-				{tab === 'students' && !selectedStudent && (
-					<div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <UserCog size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Alunos</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                        {totalStudents} no total • {studentsWithTeacher} com professor • {studentsWithoutTeacher} sem professor
-                                    </div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        data-tour="adminpanel.students.create"
-                                        onClick={() => setShowRegisterModal(true)}
-                                        className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95"
-                                    >
-                                        <UserPlus size={18} /> CADASTRAR
-                                    </button>
-                                </div>
-                            </div>
-                            <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-2">
-                                <div className="relative lg:col-span-2">
-                                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                    <input
-                                        data-tour="adminpanel.students.search"
-                                        value={studentQuery}
-                                        onChange={(e) => setStudentQuery(e.target.value)}
-                                        placeholder="Buscar aluno por nome ou email"
-                                        className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                    />
-                                </div>
-                                <div data-tour="adminpanel.students.statusFilter" className="flex items-center gap-2 overflow-x-auto no-scrollbar">
-                                    {[
-                                        { key: 'all', label: 'Todos' },
-                                        { key: 'pago', label: 'Pago' },
-                                        { key: 'pendente', label: 'Pendente' },
-                                        { key: 'atrasado', label: 'Atrasado' },
-                                        { key: 'cancelar', label: 'Cancelar' }
-                                    ].map((opt) => (
-                                        <button
-                                            key={opt.key}
-                                            type="button"
-                                            onClick={() => setStudentStatusFilter(opt.key)}
-                                            className={`whitespace-nowrap min-h-[40px] px-3 py-2 rounded-full text-[11px] font-black uppercase tracking-wide border transition-all duration-300 active:scale-95 ${
-                                                studentStatusFilter === opt.key
-                                                    ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/15'
-                                                    : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            {opt.label}
-                                        </button>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-
-                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
-                            <div className="space-y-3">
-                                <div className="flex items-center justify-between gap-3">
-                                    <h3 className="text-xs font-black uppercase tracking-widest text-neutral-500">Com Professor</h3>
-                                    <span className="text-[11px] font-bold text-neutral-400">{studentsWithTeacherFiltered.length}</span>
-                                </div>
-                                {studentsWithTeacherFiltered.length === 0 ? (
-                                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-4">
-                                        <p className="text-neutral-500 text-sm">Nenhum aluno encontrado.</p>
-                                    </div>
-                                ) : (
-                                    <div className="space-y-3">
-                                        {studentsWithTeacherFiltered.map(s => (
-                                            <div key={s.id} onClick={() => setSelectedStudent(s)} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300 cursor-pointer w-full max-w-[100vw] overflow-hidden">
-                                                <div className="flex items-center gap-4">
-                                                    <div className="w-12 h-12 rounded-full bg-neutral-900 border border-neutral-700 flex items-center justify-center font-black text-lg text-neutral-200 flex-shrink-0">{(s.name || s.email || '?')[0]}</div>
-                                                    <div className="min-w-0 flex-1">
-                                                        <h3 className="font-black text-white truncate">{s.name || s.email}</h3>
-                                                        <p className="text-xs text-neutral-400 truncate">{s.email}</p>
-                                                    </div>
-                                                </div>
-
-                                                <div className="mt-3 flex flex-col sm:flex-row sm:items-center gap-2">
-                                                    <span className="px-3 py-1.5 rounded-full text-[11px] font-black uppercase tracking-wide bg-yellow-500/10 text-yellow-400 border border-yellow-500/30 w-fit">
-                                                        {isTeacher && s.teacher_id === user.id ? 'Seu aluno' : 'Vinculado'}
-                                                    </span>
-                                                    {(isAdmin || (isTeacher && s.teacher_id === user.id)) && (
-                                                        <select
-                                                            value={s.status || 'pendente'}
-                                                            onClick={(e) => e.stopPropagation()}
-                                                            onPointerDown={(e) => e.stopPropagation()}
-                                                            onMouseDown={(e) => e.stopPropagation()}
-                                                            onChange={async (e) => {
-                                                                const newStatus = e.target.value;
-                                                                try {
-                                                                    const res = await fetch('/api/admin/students/status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: s.id, status: newStatus }) });
-                                                                    const json = await res.json();
-                                                                    if (json.ok) setUsersList(prev => prev.map(x => x.id === s.id ? { ...x, status: newStatus } : x));
-                                                                } catch {}
-                                                            }}
-                                                            className="min-h-[40px] bg-neutral-900/70 text-neutral-200 rounded-xl px-3 py-2 text-xs w-full sm:w-auto max-w-full border border-neutral-700 focus:border-yellow-500 focus:outline-none"
-                                                        >
-                                                            <option value="pago">pago</option>
-                                                            <option value="pendente">pendente</option>
-                                                            <option value="atrasado">atrasado</option>
-                                                            <option value="cancelar">cancelar</option>
-                                                        </select>
-                                                    )}
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                            </div>
-
-                            <div className="space-y-3">
-                                <div className="flex items-center justify-between gap-3">
-                                    <h3 className="text-xs font-black uppercase tracking-widest text-neutral-500">Sem Professor</h3>
-                                    <span className="text-[11px] font-bold text-neutral-400">{studentsWithoutTeacherFiltered.length}</span>
-                                </div>
-                                {studentsWithoutTeacherFiltered.length === 0 ? (
-                                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-4">
-                                        <p className="text-neutral-500 text-sm">Nenhum aluno encontrado.</p>
-                                    </div>
-                                ) : (
-                                    <div className="space-y-3">
-                                        {studentsWithoutTeacherFiltered.map(s => (
-                                            <div key={s.id} onClick={() => setSelectedStudent(s)} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300 cursor-pointer w-full max-w-[100vw] overflow-hidden">
-                                                <div className="flex items-center gap-4">
-                                                    <div className="w-12 h-12 rounded-full bg-neutral-900 border border-neutral-700 flex items-center justify-center font-black text-lg text-neutral-200 flex-shrink-0">{(s.name || s.email || '?')[0]}</div>
-                                                    <div className="min-w-0 flex-1">
-                                                        <h3 className="font-black text-white truncate">{s.name || s.email}</h3>
-                                                        <p className="text-xs text-neutral-400 truncate">{s.email}</p>
-                                                    </div>
-                                                </div>
-
-                                                <div className="mt-3 flex flex-wrap items-center gap-2">
-                                                    <span className="px-3 py-1.5 rounded-full text-[11px] font-black uppercase tracking-wide bg-neutral-900 text-neutral-300 border border-neutral-700 w-fit">Sem professor</span>
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-				{tab === 'templates' && !selectedStudent && (
-					<div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <Dumbbell size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Treinos</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{(Array.isArray(templates) ? templates.length : 0)} no total</div>
-                                </div>
-                                <div className="text-[11px] font-bold text-neutral-400">{templatesFiltered.length} visíveis</div>
-                            </div>
-                            <div className="mt-4 relative">
-                                <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                <input
-                                    value={templateQuery}
-                                    onChange={(e) => setTemplateQuery(e.target.value)}
-                                    placeholder="Buscar treino por nome"
-                                    className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                />
-                            </div>
-                        </div>
-
-                        {templatesFiltered.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhum treino encontrado.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {templatesFiltered.map(t => (
-                                    <div
-                                        key={t.id}
-                                        className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 flex justify-between items-center cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-                                        onClick={() => openEditTemplate(t)}
-                                    >
-                                        <div className="min-w-0">
-                                            <h3 className="font-black text-white truncate">{normalizeWorkoutTitle(t.name)}</h3>
-                                            <p className="text-xs text-neutral-500">{t.exercises?.length || 0} exercícios</p>
-                                        </div>
-                                        <div className="flex items-center gap-2 flex-shrink-0">
-                                            <button
-                                                onClick={(e) => { e.stopPropagation(); openEditTemplate(t); }}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-yellow-500/40 hover:bg-yellow-500/10 text-neutral-300 hover:text-yellow-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Edit3 size={16} />
-                                            </button>
-                                            <button
-                                                onClick={async (e) => {
-                                                    e.stopPropagation();
-                                                    if (!(await confirm('Excluir este treino?', 'Apagar Treino'))) return;
-                                                    try {
-                                                        if (templatesUserId && t?.user_id && String(t.user_id) !== String(templatesUserId)) {
-                                                            await alert('Esse treino pertence a um aluno. Para não apagar o treino dele, a exclusão aqui é bloqueada.');
-                                                            return;
-                                                        }
-                                                        const res = await deleteWorkout(t.id);
-                                                        if (!res?.success) {
-                                                            await alert('Erro ao excluir: ' + (res?.error || 'Falha ao excluir treino'));
-                                                            return;
-                                                        }
-                                                        setTemplates(prev => prev.filter(x => x.id !== t.id));
-                                                    } catch (err) { await alert('Erro ao excluir: ' + (err?.message ?? String(err))); }
-                                                }}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-red-500/40 hover:bg-red-900/20 text-neutral-300 hover:text-red-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Trash2 size={16} />
-                                            </button>
-                                        </div>
-                                    </div>
-                                ))}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'videos' && !selectedStudent && isAdmin && (
-                    <div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <Play size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Vídeos (Fila)</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{videoQueue.length} pendentes</div>
-                                </div>
-                            </div>
-
-                            <div className="mt-3 rounded-2xl bg-neutral-950/60 border border-neutral-800 p-3 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Diagnóstico</div>
-                                    <div className="text-xs text-neutral-300 font-semibold">
-                                        {videoMissingLoading
-                                            ? 'Calculando exercícios sem vídeo...'
-                                            : (typeof videoMissingCount === 'number'
-                                                ? `${videoMissingCount} exercícios sem vídeo (estimativa)`
-                                                : 'Não foi possível calcular agora')}
-                                    </div>
-                                    {videoCycleRunning ? (
-                                        <div className="mt-1 text-[11px] text-neutral-500 font-semibold">
-                                            Ciclo: processados {videoCycleStats.processed} • criados {videoCycleStats.created} • pulados {videoCycleStats.skipped}
-                                        </div>
-                                    ) : null}
-                                </div>
-                                <div className="flex items-center gap-2 flex-shrink-0">
-                                    {typeof videoMissingCount === 'number' && videoMissingCount > 0 ? (
-                                        <button
-                                            type="button"
-                                            disabled={videoLoading || videoCycleRunning}
-                                            onClick={async () => {
-                                                const limit = Math.max(1, Math.min(50, Math.min(videoMissingCount, Number(videoBackfillLimit) || 20)));
-                                                if (!(await confirm(`Gerar sugestões para até ${limit} exercícios sem vídeo?`, 'Gerar Sugestões (lote)'))) return;
-                                                setVideoLoading(true);
-                                                try {
-                                                    const res = await fetch('/api/admin/exercise-videos/backfill', {
-                                                        method: 'POST',
-                                                        headers: { 'Content-Type': 'application/json' },
-                                                        body: JSON.stringify({ limit }),
-                                                    });
-                                                    const json = await res.json().catch(() => ({}));
-                                                    if (!json?.ok) throw new Error(json?.error || 'Falha no backfill');
-                                                    const { data, error } = await supabase
-                                                        .from('exercise_videos')
-                                                        .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                        .eq('status', 'pending')
-                                                        .order('created_at', { ascending: false })
-                                                        .limit(60);
-                                                    if (!error) setVideoQueue(data || []);
-                                                    await alert(`Criados: ${json.created ?? 0} | Processados: ${json.processed ?? 0} | Pulados: ${json.skipped ?? 0}`);
-                                                } catch (e) {
-                                                    await alert('Erro: ' + (e?.message ?? String(e)));
-                                                } finally {
-                                                    setVideoLoading(false);
-                                                }
-                                            }}
-                                            className="min-h-[40px] px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black font-black text-[11px] uppercase tracking-widest border border-yellow-400/60 active:scale-95 transition-all disabled:opacity-50"
-                                        >
-                                            Gerar Lote
-                                        </button>
-                                    ) : null}
-
-                                    {!videoCycleRunning && typeof videoMissingCount === 'number' && videoMissingCount > 0 ? (
-                                        <button
-                                            type="button"
-                                            disabled={videoLoading}
-                                            onClick={async () => {
-                                                const perCycle = Math.max(1, Math.min(50, Number(videoBackfillLimit) || 20));
-                                                if (!(await confirm(`Rodar backfill em ciclos de ${perCycle} até acabar?`, 'Backfill contínuo'))) return;
-                                                videoCycleStopRef.current = false;
-                                                setVideoCycleRunning(true);
-                                                setVideoCycleStats({ processed: 0, created: 0, skipped: 0 });
-                                                try {
-                                                    while (!videoCycleStopRef.current) {
-                                                        const res = await fetch('/api/admin/exercise-videos/backfill', {
-                                                            method: 'POST',
-                                                            headers: { 'Content-Type': 'application/json' },
-                                                            body: JSON.stringify({ limit: perCycle }),
-                                                        });
-                                                        const json = await res.json().catch(() => ({}));
-                                                        if (!json?.ok) throw new Error(json?.error || 'Falha no backfill');
-
-                                                        setVideoCycleStats((prev) => ({
-                                                            processed: prev.processed + (json.processed ?? 0),
-                                                            created: prev.created + (json.created ?? 0),
-                                                            skipped: prev.skipped + (json.skipped ?? 0),
-                                                        }));
-
-                                                        if ((json.processed ?? 0) <= 0 || (json.created ?? 0) <= 0) break;
-                                                    }
-                                                    const { data, error } = await supabase
-                                                        .from('exercise_videos')
-                                                        .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                        .eq('status', 'pending')
-                                                        .order('created_at', { ascending: false })
-                                                        .limit(60);
-                                                    if (!error) setVideoQueue(data || []);
-                                                } catch (e) {
-                                                    await alert('Erro: ' + (e?.message ?? String(e)));
-                                                } finally {
-                                                    setVideoCycleRunning(false);
-                                                }
-                                            }}
-                                            className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all disabled:opacity-50"
-                                        >
-                                            Rodar contínuo
-                                        </button>
-                                    ) : null}
-
-                                    {videoCycleRunning ? (
-                                        <button
-                                            type="button"
-                                            onClick={() => {
-                                                videoCycleStopRef.current = true;
-                                            }}
-                                            className="min-h-[40px] px-4 py-2 rounded-xl bg-red-900/30 border border-red-700 hover:bg-red-900/40 text-red-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all"
-                                        >
-                                            Pausar
-                                        </button>
-                                    ) : null}
-                                </div>
-                            </div>
-
-                            <div className="mt-4 flex flex-col sm:flex-row gap-2">
-                                <input
-                                    value={videoExerciseName}
-                                    onChange={(e) => setVideoExerciseName(e.target.value)}
-                                    placeholder="Ex.: Supino reto com barra"
-                                    className="flex-1 min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-4 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                />
-                                <button
-                                    type="button"
-                                    disabled={videoLoading || !String(videoExerciseName || '').trim()}
-                                    onClick={async () => {
-                                        const name = String(videoExerciseName || '').trim();
-                                        if (!name) return;
-                                        setVideoLoading(true);
-                                        try {
-                                            const res = await fetch('/api/admin/exercise-videos/suggest', {
-                                                method: 'POST',
-                                                headers: { 'Content-Type': 'application/json' },
-                                                body: JSON.stringify({ name }),
-                                            });
-                                            const json = await res.json().catch(() => ({}));
-                                            if (!json?.ok) throw new Error(json?.error || 'Falha ao gerar sugestões');
-                                            setVideoExerciseName('');
-                                            const { data, error } = await supabase
-                                                .from('exercise_videos')
-                                                .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                .eq('status', 'pending')
-                                                .order('created_at', { ascending: false })
-                                                .limit(60);
-                                            if (!error) setVideoQueue(data || []);
-                                            await alert(`Sugestões criadas: ${json?.created ?? 0}`);
-                                        } catch (e) {
-                                            await alert('Erro: ' + (e?.message ?? String(e)));
-                                        } finally {
-                                            setVideoLoading(false);
-                                        }
-                                    }}
-                                    className="w-full sm:w-auto min-h-[44px] px-5 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-yellow-500 hover:bg-yellow-400 text-black border border-yellow-400/60 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-all"
-                                >
-                                    {videoLoading ? 'Gerando...' : 'Gerar Sugestões'}
-                                </button>
-                            </div>
-
-                            <div className="mt-3 flex flex-col sm:flex-row gap-2">
-                                <input
-                                    value={videoBackfillLimit}
-                                    onChange={(e) => setVideoBackfillLimit(e.target.value)}
-                                    inputMode="numeric"
-                                    placeholder="20"
-                                    className="w-full sm:w-28 min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-4 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                />
-                                <button
-                                    type="button"
-                                    disabled={videoLoading}
-                                    onClick={async () => {
-                                        const limit = Math.max(1, Math.min(50, Number(videoBackfillLimit) || 20));
-                                        if (!(await confirm(`Gerar sugestões em lote para até ${limit} exercícios sem vídeo?`, 'Backfill de Vídeos'))) return;
-                                        setVideoLoading(true);
-                                        try {
-                                            const res = await fetch('/api/admin/exercise-videos/backfill', {
-                                                method: 'POST',
-                                                headers: { 'Content-Type': 'application/json' },
-                                                body: JSON.stringify({ limit }),
-                                            });
-                                            const json = await res.json().catch(() => ({}));
-                                            if (!json?.ok) throw new Error(json?.error || 'Falha no backfill');
-                                            const { data, error } = await supabase
-                                                .from('exercise_videos')
-                                                .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                .eq('status', 'pending')
-                                                .order('created_at', { ascending: false })
-                                                .limit(60);
-                                            if (!error) setVideoQueue(data || []);
-                                            await alert(`Backfill concluído. Processados: ${json.processed ?? 0} | Criados: ${json.created ?? 0} | Pulados: ${json.skipped ?? 0}`);
-                                        } catch (e) {
-                                            await alert('Erro no backfill: ' + (e?.message ?? String(e)));
-                                        } finally {
-                                            setVideoLoading(false);
-                                        }
-                                    }}
-                                    className="w-full sm:w-auto min-h-[44px] px-5 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 text-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-all"
-                                >
-                                    {videoLoading ? 'Executando...' : 'Backfill (lote)'}
-                                </button>
-                                <div className="text-[11px] text-neutral-500 font-semibold flex items-center px-1">
-                                    Limite por execução (1–50)
-                                </div>
-                            </div>
-                        </div>
-
-                        {videoLoading && videoQueue.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Carregando fila...</p>
-                            </div>
-                        ) : videoQueue.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhuma sugestão pendente.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {(videoQueue || []).map((row) => {
-                                    const exName = String(row?.exercise_library?.display_name_pt || row?.normalized_name || '').trim() || 'Exercício';
-                                    const title = String(row?.title || '').trim() || 'Vídeo';
-                                    const channel = String(row?.channel_title || '').trim();
-                                    const url = String(row?.url || '').trim();
-                                    const exerciseLibraryId = row?.exercise_library_id || null;
-                                    return (
-                                        <div
-                                            key={row.id}
-                                            className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 flex flex-col gap-3"
-                                        >
-                                            <div className="flex items-start justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Exercício</div>
-                                                    <div className="font-black text-white truncate">{exName}</div>
-                                                    <div className="mt-2 text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Sugestão</div>
-                                                    <div className="text-sm text-neutral-200 truncate">{title}</div>
-                                                    {channel ? <div className="text-xs text-neutral-500 truncate">{channel}</div> : null}
-                                                    {url ? (
-                                                        <button
-                                                            type="button"
-                                                            onClick={(e) => {
-                                                                try {
-                                                                    e.preventDefault();
-                                                                    e.stopPropagation();
-                                                                } catch {}
-                                                                try {
-                                                                    window.open(url, '_blank', 'noopener,noreferrer');
-                                                                } catch {}
-                                                            }}
-                                                            className="mt-2 inline-flex items-center gap-2 text-yellow-400 hover:text-yellow-300 text-xs font-bold"
-                                                        >
-                                                            <Play size={14} />
-                                                            Abrir no YouTube
-                                                        </button>
-                                                    ) : null}
-                                                </div>
-                                                <div className="flex items-center gap-2 flex-shrink-0">
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            if (!exerciseLibraryId) return;
-                                                            setVideoLoading(true);
-                                                            try {
-                                                                await supabase
-                                                                    .from('exercise_videos')
-                                                                    .update({ is_primary: false })
-                                                                    .eq('exercise_library_id', exerciseLibraryId);
-                                                                const { error } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .update({ status: 'approved', is_primary: true, approved_at: new Date().toISOString() })
-                                                                    .eq('id', row.id);
-                                                                if (error) throw error;
-                                                                await supabase
-                                                                    .from('exercise_library')
-                                                                    .update({ video_url: url })
-                                                                    .eq('id', exerciseLibraryId);
-                                                                const { data, error: refreshErr } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                                    .eq('status', 'pending')
-                                                                    .order('created_at', { ascending: false })
-                                                                    .limit(60);
-                                                                if (!refreshErr) setVideoQueue(data || []);
-                                                                await alert('Vídeo aprovado e definido como padrão.');
-                                                            } catch (e) {
-                                                                await alert('Erro ao aprovar: ' + (e?.message ?? String(e)));
-                                                            } finally {
-                                                                setVideoLoading(false);
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl bg-green-600 hover:bg-green-500 text-white font-black text-[11px] uppercase tracking-widest border border-green-400/40 active:scale-95 transition-all disabled:opacity-50"
-                                                        disabled={videoLoading}
-                                                    >
-                                                        Aprovar
-                                                    </button>
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            setVideoLoading(true);
-                                                            try {
-                                                                const { error } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .update({ status: 'rejected', is_primary: false })
-                                                                    .eq('id', row.id);
-                                                                if (error) throw error;
-                                                                const { data, error: refreshErr } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                                    .eq('status', 'pending')
-                                                                    .order('created_at', { ascending: false })
-                                                                    .limit(60);
-                                                                if (!refreshErr) setVideoQueue(data || []);
-                                                            } catch (e) {
-                                                                await alert('Erro ao rejeitar: ' + (e?.message ?? String(e)));
-                                                            } finally {
-                                                                setVideoLoading(false);
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all disabled:opacity-50"
-                                                        disabled={videoLoading}
-                                                    >
-                                                        Rejeitar
-                                                    </button>
-                                                </div>
-                                            </div>
-                                        </div>
-                                    );
-                                })}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'errors' && !selectedStudent && isAdmin && (
-                    <div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <AlertTriangle size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Erros reportados</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{errorsFiltered.length} visíveis</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={async () => {
-                                        setErrorsLoading(true);
-                                        try {
-                                            const { data, error } = await supabase
-                                                .from('error_reports')
-                                                .select('id, user_id, user_email, message, stack, pathname, url, user_agent, app_version, source, meta, status, created_at, updated_at, resolved_at, resolved_by')
-                                                .order('created_at', { ascending: false })
-                                                .limit(200);
-                                            if (!error) setErrorReports(Array.isArray(data) ? data : []);
-                                        } catch {} finally {
-                                            setErrorsLoading(false);
-                                        }
-                                    }}
-                                    disabled={errorsLoading}
-                                    className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all disabled:opacity-50"
-                                >
-                                    {errorsLoading ? 'Atualizando...' : 'Atualizar'}
-                                </button>
-                            </div>
-
-                            <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
-                                <div className="md:col-span-2 relative">
-                                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                    <input
-                                        value={errorsQuery}
-                                        onChange={(e) => setErrorsQuery(e.target.value)}
-                                        placeholder="Buscar por mensagem, usuário ou rota"
-                                        className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                    />
-                                </div>
-                                <select
-                                    value={errorsStatusFilter}
-                                    onChange={(e) => setErrorsStatusFilter(e.target.value)}
-                                    className="min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-yellow-500"
-                                >
-                                    <option value="all">Todos</option>
-                                    <option value="new">Novos</option>
-                                    <option value="triaged">Triados</option>
-                                    <option value="resolved">Resolvidos</option>
-                                    <option value="ignored">Ignorados</option>
-                                </select>
-                            </div>
-                        </div>
-
-                        {errorsLoading ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center text-neutral-400 font-semibold">
-                                Carregando erros...
-                            </div>
-                        ) : errorsFiltered.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhum erro reportado encontrado.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {errorsFiltered.map((r) => {
-                                    const status = String(r?.status || 'new');
-                                    const statusTone =
-                                        status === 'resolved'
-                                            ? 'bg-green-500/10 text-green-400 border-green-500/30'
-                                            : status === 'ignored'
-                                                ? 'bg-neutral-500/10 text-neutral-300 border-neutral-500/25'
-                                                : status === 'triaged'
-                                                    ? 'bg-blue-500/10 text-blue-300 border-blue-500/30'
-                                                    : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30';
-                                    const createdAt = (() => {
-                                        try {
-                                            const raw = r?.created_at || r?.createdAt;
-                                            if (!raw) return '';
-                                            const d = raw?.toDate ? raw.toDate() : new Date(raw);
-                                            const t = d?.toLocaleString ? d.toLocaleString('pt-BR') : String(raw);
-                                            return t || '';
-                                        } catch {
-                                            return '';
-                                        }
-                                    })();
-                                    const email = String(r?.user_email || r?.userEmail || '').trim();
-                                    const message = String(r?.message || '').trim();
-                                    const pathname = String(r?.pathname || '').trim();
-                                    const stack = String(r?.stack || '').trim();
-
-                                    return (
-                                        <div key={r.id} className="bg-neutral-800 border border-neutral-700 rounded-2xl p-4">
-                                            <div className="flex items-start justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="flex items-center gap-2 flex-wrap">
-                                                        <div className={`px-2 py-1 rounded-full border text-[10px] font-black uppercase tracking-widest ${statusTone}`}>
-                                                            {status}
-                                                        </div>
-                                                        {createdAt ? (
-                                                            <div className="text-[11px] text-neutral-500 font-semibold">{createdAt}</div>
-                                                        ) : null}
-                                                        {email ? (
-                                                            <div className="text-[11px] text-neutral-400 font-semibold truncate">• {email}</div>
-                                                        ) : null}
-                                                        {pathname ? (
-                                                            <div className="text-[11px] text-neutral-500 font-semibold truncate">• {pathname}</div>
-                                                        ) : null}
-                                                    </div>
-                                                    <div className="mt-2 text-sm text-neutral-100 font-semibold whitespace-pre-wrap break-words">
-                                                        {message || '—'}
-                                                    </div>
-                                                </div>
-                                                <div className="flex items-center gap-2 flex-shrink-0">
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            try {
-                                                                const nextStatus = status === 'resolved' ? 'new' : 'resolved';
-                                                                const patch = nextStatus === 'resolved'
-                                                                    ? { status: nextStatus, resolved_at: new Date().toISOString(), resolved_by: user?.id ?? null }
-                                                                    : { status: nextStatus, resolved_at: null, resolved_by: null };
-                                                                const { error } = await supabase.from('error_reports').update(patch).eq('id', r.id);
-                                                                if (error) throw error;
-                                                                setErrorReports((prev) => {
-                                                                    const list = Array.isArray(prev) ? prev : [];
-                                                                    return list.map((x) => (x?.id === r.id ? { ...x, ...patch } : x));
-                                                                });
-                                                            } catch (e) {
-                                                                await alert('Erro ao atualizar status: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all"
-                                                    >
-                                                        {status === 'resolved' ? 'Reabrir' : 'Resolver'}
-                                                    </button>
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            try {
-                                                                const { error } = await supabase.from('error_reports').update({ status: 'ignored' }).eq('id', r.id);
-                                                                if (error) throw error;
-                                                                setErrorReports((prev) => {
-                                                                    const list = Array.isArray(prev) ? prev : [];
-                                                                    return list.map((x) => (x?.id === r.id ? { ...x, status: 'ignored' } : x));
-                                                                });
-                                                            } catch (e) {
-                                                                await alert('Erro ao ignorar: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all"
-                                                    >
-                                                        Ignorar
-                                                    </button>
-                                                </div>
-                                            </div>
-
-                                            {(stack || r?.url) ? (
-                                                <details className="mt-3">
-                                                    <summary className="cursor-pointer text-[11px] font-black uppercase tracking-widest text-neutral-400 hover:text-white">
-                                                        Detalhes
-                                                    </summary>
-                                                    <div className="mt-2 grid gap-2">
-                                                        {String(r?.url || '').trim() ? (
-                                                            <div className="text-[11px] text-neutral-400 break-all">
-                                                                <span className="font-black text-neutral-300">URL:</span> {String(r.url)}
-                                                            </div>
-                                                        ) : null}
-                                                        {String(r?.source || '').trim() ? (
-                                                            <div className="text-[11px] text-neutral-400 break-all">
-                                                                <span className="font-black text-neutral-300">Fonte:</span> {String(r.source)}
-                                                            </div>
-                                                        ) : null}
-                                                        {String(r?.app_version || r?.appVersion || '').trim() ? (
-                                                            <div className="text-[11px] text-neutral-400 break-all">
-                                                                <span className="font-black text-neutral-300">Versão:</span> {String(r.app_version || r.appVersion)}
-                                                            </div>
-                                                        ) : null}
-                                                        {stack ? (
-                                                            <pre className="text-[11px] text-neutral-300 whitespace-pre-wrap break-words bg-neutral-950/60 border border-neutral-800 rounded-xl p-3 overflow-auto max-h-[260px]">
-                                                                {stack}
-                                                            </pre>
-                                                        ) : null}
-                                                    </div>
-                                                </details>
-                                            ) : null}
-                                        </div>
-                                    );
-                                })}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'system' && !selectedStudent && (
-                    <div className="space-y-8">
-                        <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 space-y-4">
-                            <h3 className="font-bold text-white flex items-center gap-2"><Download size={20} className="text-yellow-500"/> BACKUP DO SISTEMA</h3>
-                            <div className="flex gap-2">
-                                <button onClick={handleExportSystem} disabled={systemExporting} className="flex-1 min-h-[44px] py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl disabled:opacity-50">Exportar JSON</button>
-                                <button onClick={handleImportSystemClick} disabled={systemImporting} className="flex-1 min-h-[44px] py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl hover:bg-neutral-700 disabled:opacity-50">Importar JSON</button>
-                                <input ref={systemFileInputRef} type="file" accept=".json" className="hidden" onChange={handleImportSystem} />
-                            </div>
-                        </div>
-                        {/* Broadcast Section */}
-                        <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 space-y-4">
-                            <h3 className="font-bold text-white flex items-center gap-2"><Megaphone size={20} className="text-yellow-500"/> ENVIAR COMUNICADO</h3>
-                            <div>
-                                <label className="text-xs font-bold text-neutral-500 uppercase">Título do Aviso</label>
-                                <input value={broadcastTitle} onChange={e => setBroadcastTitle(e.target.value)} className="w-full bg-neutral-900 p-3 rounded-lg text-white font-bold mt-1 border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs font-bold text-neutral-500 uppercase">Mensagem</label>
-                                <textarea value={broadcastMsg} onChange={e => setBroadcastMsg(e.target.value)} className="w-full bg-neutral-900 p-3 rounded-lg text-white mt-1 border border-neutral-700 focus:border-yellow-500 outline-none h-32" />
-                            </div>
-                            <button onClick={handleSendBroadcast} disabled={sendingBroadcast} className="w-full py-4 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl flex items-center justify-center gap-2 disabled:opacity-50">
-                                {sendingBroadcast ? 'Enviando...' : 'ENVIAR AVISO'}
-                            </button>
-                        </div>
-
-                        <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 space-y-4">
-                            <div className="flex items-start justify-between gap-3">
-                                <div className="min-w-0">
-                                    <h3 className="font-bold text-white flex items-center gap-2"><Dumbbell size={20} className="text-yellow-500"/> REVISAR EXERCÍCIOS (ALIASES)</h3>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                        {exerciseAliasesLoading ? 'Carregando...' : `${Array.isArray(exerciseAliasesReview) ? exerciseAliasesReview.length : 0} pendentes`}
-                                    </div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        type="button"
-                                        onClick={async () => {
-                                            if (!isAdmin) return;
-                                            if (exerciseAliasesBackfillLoading) return;
-                                            setExerciseAliasesBackfillLoading(true);
-                                            setExerciseAliasesNotice('');
-                                            try {
-                                                const res = await fetch('/api/admin/exercises/canonicalize/backfill', {
-                                                    method: 'POST',
-                                                    headers: { 'content-type': 'application/json' },
-                                                    body: JSON.stringify({ limit: 30 }),
-                                                });
-                                                const json = await res.json().catch(() => null);
-                                                if (!res.ok || !json?.ok) {
-                                                    const msg = String(json?.error || `Falha ao processar (${res.status})`);
-                                                    setExerciseAliasesNotice(msg);
-                                                    return;
-                                                }
-                                                const msg = `Processados: ${json.processed || 0} · Atualizados: ${json.updated || 0} · Falhas: ${json.failed || 0}`;
-                                                setExerciseAliasesNotice(msg);
-                                            } catch (e) {
-                                                const msg = e?.message ? String(e.message) : '';
-                                                if (msg) setExerciseAliasesNotice(msg);
-                                            } finally {
-                                                setExerciseAliasesBackfillLoading(false);
-                                            }
-                                        }}
-                                        disabled={exerciseAliasesBackfillLoading}
-                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-yellow-500 hover:bg-yellow-400 text-black disabled:opacity-50"
-                                    >
-                                        {exerciseAliasesBackfillLoading ? 'Processando...' : 'Processar (Gemini)'}
-                                    </button>
-                                    <button
-                                        type="button"
-                                        onClick={async () => {
-                                            if (!isAdmin) return;
-                                            setExerciseAliasesLoading(true);
-                                            setExerciseAliasesError('');
-                                            setExerciseAliasesNotice('');
-                                            try {
-                                                const { data, error } = await supabase
-                                                    .from('exercise_aliases')
-                                                    .select('id, user_id, canonical_id, alias, normalized_alias, confidence, source, needs_review, created_at, updated_at')
-                                                    .eq('needs_review', true)
-                                                    .order('created_at', { ascending: false })
-                                                    .limit(200);
-                                                if (error) {
-                                                    setExerciseAliasesReview([]);
-                                                    const msg = String(error?.message || '');
-                                                    if (msg) setExerciseAliasesError(msg);
-                                                    return;
-                                                }
-                                                setExerciseAliasesReview(Array.isArray(data) ? data : []);
-                                            } catch (e) {
-                                                setExerciseAliasesReview([]);
-                                                const msg = e?.message ? String(e.message) : '';
-                                                if (msg) setExerciseAliasesError(msg);
-                                            } finally {
-                                                setExerciseAliasesLoading(false);
-                                            }
-                                        }}
-                                        disabled={exerciseAliasesLoading}
-                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 disabled:opacity-50"
-                                    >
-                                        {exerciseAliasesLoading ? 'Atualizando...' : 'Atualizar'}
-                                    </button>
-                                </div>
-                            </div>
-
-                            {exerciseAliasesNotice ? (
-                                <div className="text-xs text-neutral-200 font-bold bg-neutral-900 border border-neutral-700 rounded-xl p-3">
-                                    {exerciseAliasesNotice}
-                                </div>
-                            ) : null}
-
-                            {exerciseAliasesError ? (
-                                <div className="text-xs text-red-300 font-bold bg-neutral-900 border border-neutral-700 rounded-xl p-3">
-                                    {exerciseAliasesError}
-                                </div>
-                            ) : null}
-
-                            {exerciseAliasesLoading ? (
-                                <div className="text-xs text-neutral-400 font-semibold">Carregando aliases pendentes...</div>
-                            ) : !Array.isArray(exerciseAliasesReview) || exerciseAliasesReview.length === 0 ? (
-                                <div className="text-xs text-neutral-400 font-semibold">Nenhum alias pendente de revisão.</div>
-                            ) : (
-                                <div className="space-y-2">
-                                    {exerciseAliasesReview.slice(0, 30).map((row) => {
-                                        const id = row?.id ? String(row.id) : '';
-                                        const userId = row?.user_id ? String(row.user_id) : '';
-                                        const alias = row?.alias ? String(row.alias) : '';
-                                        const conf = Number(row?.confidence);
-                                        const src = row?.source ? String(row.source) : '';
-                                        return (
-                                            <div key={id || `${userId}-${alias}`} className="bg-neutral-900/60 border border-neutral-800 rounded-xl p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="text-sm font-black text-white truncate">{alias || '—'}</div>
-                                                    <div className="text-[11px] text-neutral-400 break-all">
-                                                        <span className="font-black text-neutral-300">User:</span> {userId ? `${userId.slice(0, 8)}...` : '—'}{' '}
-                                                        <span className="mx-2">·</span>
-                                                        <span className="font-black text-neutral-300">Fonte:</span> {src || '—'}{' '}
-                                                        <span className="mx-2">·</span>
-                                                        <span className="font-black text-neutral-300">Conf:</span> {Number.isFinite(conf) ? conf.toFixed(2) : '—'}
-                                                    </div>
-                                                </div>
-                                                <div className="flex flex-col sm:flex-row gap-2">
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            try {
-                                                                const name = await prompt('Defina o nome canônico', 'Resolver alias', alias);
-                                                                const canon = String(name || '').trim();
-                                                                if (!canon) return;
-                                                                const norm = normalizeExerciseName(canon);
-                                                                if (!norm) return;
-                                                                const { data: canonRow, error: canonErr } = await supabase
-                                                                    .from('exercise_canonical')
-                                                                    .upsert(
-                                                                        { user_id: userId, display_name: canon, normalized_name: norm },
-                                                                        { onConflict: 'user_id,normalized_name' }
-                                                                    )
-                                                                    .select('id')
-                                                                    .maybeSingle();
-                                                                if (canonErr || !canonRow?.id) {
-                                                                    await alert('Falha ao salvar canônico: ' + String(canonErr?.message || ''));
-                                                                    return;
-                                                                }
-                                                                const canonicalId = String(canonRow.id);
-                                                                const { error: upErr } = await supabase
-                                                                    .from('exercise_aliases')
-                                                                    .update({ canonical_id: canonicalId, confidence: 1, source: 'human', needs_review: false })
-                                                                    .eq('id', id);
-                                                                if (upErr) {
-                                                                    await alert('Falha ao atualizar alias: ' + String(upErr?.message || ''));
-                                                                    return;
-                                                                }
-                                                                setExerciseAliasesReview((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== id) : prev));
-                                                            } catch (e) {
-                                                                await alert('Falha ao resolver: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-yellow-500 hover:bg-yellow-400 text-black active:scale-95 transition-transform"
-                                                    >
-                                                        Resolver
-                                                    </button>
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            try {
-                                                                if (!(await confirm('Ignorar este alias? (não aparecerá mais para revisão)', 'Ignorar'))) return;
-                                                                const { error: upErr } = await supabase.from('exercise_aliases').update({ needs_review: false }).eq('id', id);
-                                                                if (upErr) {
-                                                                    await alert('Falha ao ignorar: ' + String(upErr?.message || ''));
-                                                                    return;
-                                                                }
-                                                                setExerciseAliasesReview((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== id) : prev));
-                                                            } catch (e) {
-                                                                await alert('Falha ao ignorar: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 active:scale-95 transition-transform"
-                                                    >
-                                                        Ignorar
-                                                    </button>
-                                                </div>
-                                            </div>
-                                        );
-                                    })}
-                                </div>
-                            )}
-                        </div>
-
-                        <div className="bg-red-950/40 p-4 rounded-2xl border border-red-500/40 shadow-[0_16px_40px_rgba(0,0,0,0.75)]">
-                            <button
-                                type="button"
-                                onClick={() => setDangerOpen(v => !v)}
-                                className="w-full flex items-center justify-between gap-3 active:scale-[0.99] transition-transform"
-                            >
-                                <div className="flex items-center gap-3 min-w-0">
-                                    <div className="w-10 h-10 rounded-2xl bg-red-900/70 border border-red-500/60 flex items-center justify-center flex-shrink-0 shadow-[0_0_25px_rgba(248,113,113,0.35)]">
-                                        <ShieldAlert size={18} className="text-red-300" />
-                                    </div>
-                                    <div className="min-w-0 text-left">
-                                        <div className="font-black text-red-400 tracking-[0.18em] text-[11px] uppercase">Danger Zone</div>
-                                        <div className="text-xs text-neutral-300 font-semibold">Ações irreversíveis com confirmação dupla. Não há como desfazer.</div>
-                                    </div>
-                                </div>
-                                <div className={`w-9 h-9 rounded-full bg-neutral-900 border border-red-700 flex items-center justify-center transition-all duration-300 ${dangerOpen ? 'rotate-180' : ''}`}>
-                                    <ChevronDown size={16} className="text-red-300" />
-                                </div>
-                            </button>
-
-                            {dangerOpen && (
-                                <div className="mt-4 space-y-3">
-                                    <div className="bg-red-900/20 border border-red-500/40 rounded-2xl p-3 space-y-3">
-                                        <div className="flex items-start justify-between gap-3">
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-2xl bg-red-950/60 border border-red-500/60 flex items-center justify-center flex-shrink-0">
-                                                    <Trash2 size={16} className="text-red-300" />
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-[12px] font-black uppercase tracking-widest text-red-300 truncate">Zerar todos os alunos</div>
-                                                    <div className="text-[11px] text-neutral-300">Remove definitivamente todos os cadastros de alunos e seus vínculos.</div>
-                                                </div>
-                                            </div>
-                                            <span className="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-950/80 border border-red-500/60 text-red-300">Irreversível</span>
-                                        </div>
-                                        <div className="space-y-2">
-                                            <div className="text-[11px] text-neutral-300 font-semibold">Para confirmar, digite <span className="font-black text-red-300">APAGAR</span> no campo abaixo.</div>
-                                            <div className="flex flex-col sm:flex-row gap-2">
-                                                <input
-                                                    value={dangerStudentsConfirm}
-                                                    onChange={(e) => setDangerStudentsConfirm(e.target.value)}
-                                                    placeholder="Digite APAGAR para confirmar"
-                                                    className="flex-1 min-h-[40px] bg-neutral-950/80 border border-red-800 rounded-xl px-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-red-500"
-                                                />
-                                                <button
-                                                    type="button"
-                                                    disabled={
-                                                        dangerActionLoading === 'students' ||
-                                                        String(dangerStudentsConfirm || '').trim().toUpperCase() !== 'APAGAR'
-                                                    }
-                                                    onClick={() =>
-                                                        runDangerAction('students', 'ZERAR TODOS OS ALUNOS', clearAllStudents, () =>
-                                                            setDangerStudentsConfirm('')
-                                                        )
-                                                    }
-                                                    className="w-full sm:w-auto min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 bg-red-600 hover:bg-red-500 text-white border border-red-400 shadow-[0_0_25px_rgba(248,113,113,0.35)] disabled:opacity-40 disabled:cursor-not-allowed"
-                                                >
-                                                    {dangerActionLoading === 'students' ? 'Executando...' : 'Apagar tudo'}
-                                                </button>
-                                            </div>
-                                        </div>
-                                    </div>
-
-                                    <div className="bg-red-900/20 border border-red-500/40 rounded-2xl p-3 space-y-3">
-                                        <div className="flex items-start justify-between gap-3">
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-2xl bg-red-950/60 border border-red-500/60 flex items-center justify-center flex-shrink-0">
-                                                    <Trash2 size={16} className="text-red-300" />
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-[12px] font-black uppercase tracking-widest text-red-300 truncate">Zerar todos os professores</div>
-                                                    <div className="text-[11px] text-neutral-300">Exclui todos os professores cadastrados e seus acessos à plataforma.</div>
-                                                </div>
-                                            </div>
-                                            <span className="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-950/80 border border-red-500/60 text-red-300">Irreversível</span>
-                                        </div>
-                                        <div className="space-y-2">
-                                            <div className="text-[11px] text-neutral-300 font-semibold">Para confirmar, digite <span className="font-black text-red-300">APAGAR</span> no campo abaixo.</div>
-                                            <div className="flex flex-col sm:flex-row gap-2">
-                                                <input
-                                                    value={dangerTeachersConfirm}
-                                                    onChange={(e) => setDangerTeachersConfirm(e.target.value)}
-                                                    placeholder="Digite APAGAR para confirmar"
-                                                    className="flex-1 min-h-[40px] bg-neutral-950/80 border border-red-800 rounded-xl px-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-red-500"
-                                                />
-                                                <button
-                                                    type="button"
-                                                    disabled={
-                                                        dangerActionLoading === 'teachers' ||
-                                                        String(dangerTeachersConfirm || '').trim().toUpperCase() !== 'APAGAR'
-                                                    }
-                                                    onClick={() =>
-                                                        runDangerAction('teachers', 'ZERAR TODOS OS PROFESSORES', clearAllTeachers, () =>
-                                                            setDangerTeachersConfirm('')
-                                                        )
-                                                    }
-                                                    className="w-full sm:w-auto min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 bg-red-600 hover:bg-red-500 text-white border border-red-400 shadow-[0_0_25px_rgba(248,113,113,0.35)] disabled:opacity-40 disabled:cursor-not-allowed"
-                                                >
-                                                    {dangerActionLoading === 'teachers' ? 'Executando...' : 'Apagar tudo'}
-                                                </button>
-                                            </div>
-                                        </div>
-                                    </div>
-
-                                    <div className="bg-red-900/20 border border-red-500/40 rounded-2xl p-3 space-y-3">
-                                        <div className="flex items-start justify-between gap-3">
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-2xl bg-red-950/60 border border-red-500/60 flex items-center justify-center flex-shrink-0">
-                                                    <Trash2 size={16} className="text-red-300" />
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-[12px] font-black uppercase tracking-widest text-red-300 truncate">Zerar todos os treinos</div>
-                                                    <div className="text-[11px] text-neutral-300">Remove todos os treinos cadastrados, incluindo templates e históricos associados.</div>
-                                                </div>
-                                            </div>
-                                            <span className="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-950/80 border border-red-500/60 text-red-300">Irreversível</span>
-                                        </div>
-                                        <div className="space-y-2">
-                                            <div className="text-[11px] text-neutral-300 font-semibold">Para confirmar, digite <span className="font-black text-red-300">APAGAR</span> no campo abaixo.</div>
-                                            <div className="flex flex-col sm:flex-row gap-2">
-                                                <input
-                                                    value={dangerWorkoutsConfirm}
-                                                    onChange={(e) => setDangerWorkoutsConfirm(e.target.value)}
-                                                    placeholder="Digite APAGAR para confirmar"
-                                                    className="flex-1 min-h-[40px] bg-neutral-950/80 border border-red-800 rounded-xl px-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-red-500"
-                                                />
-                                                <button
-                                                    type="button"
-                                                    disabled={
-                                                        dangerActionLoading === 'workouts' ||
-                                                        String(dangerWorkoutsConfirm || '').trim().toUpperCase() !== 'APAGAR'
-                                                    }
-                                                    onClick={() =>
-                                                        runDangerAction('workouts', 'ZERAR TODOS OS TREINOS', clearAllWorkouts, () =>
-                                                            setDangerWorkoutsConfirm('')
-                                                        )
-                                                    }
-                                                    className="w-full sm:w-auto min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 bg-red-600 hover:bg-red-500 text-white border border-red-400 shadow-[0_0_25px_rgba(248,113,113,0.35)] disabled:opacity-40 disabled:cursor-not-allowed"
-                                                >
-                                                    {dangerActionLoading === 'workouts' ? 'Executando...' : 'Apagar tudo'}
-                                                </button>
-                                            </div>
-                                        </div>
-                                    </div>
-                                </div>
-                            )}
-                        </div>
-                    </div>
-                )}
-
-				{tab === 'teachers' && isAdmin && !selectedStudent && !selectedTeacher && (
-					<div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <UserCog size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Professores</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{(Array.isArray(teachersList) ? teachersList.length : 0)} cadastrados</div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        onClick={() => setShowTeacherModal(true)}
-                                        className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95"
-                                    >
-                                        <Plus size={18} /> ADICIONAR
-                                    </button>
-                                </div>
-                            </div>
-                            <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-2">
-                                <div className="relative lg:col-span-2">
-                                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                    <input
-                                        value={teacherQuery}
-                                        onChange={(e) => setTeacherQuery(e.target.value)}
-                                        placeholder="Buscar professor por nome ou email"
-                                        className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                    />
-                                </div>
-                                <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
-                                    {[
-                                        { key: 'all', label: 'Todos' },
-                                        { key: 'pago', label: 'Pago' },
-                                        { key: 'pendente', label: 'Pendente' },
-                                        { key: 'atrasado', label: 'Atrasado' },
-                                        { key: 'cancelar', label: 'Cancelar' }
-                                    ].map((opt) => (
-                                        <button
-                                            key={opt.key}
-                                            type="button"
-                                            onClick={() => setTeacherStatusFilter(opt.key)}
-                                            className={`whitespace-nowrap min-h-[40px] px-3 py-2 rounded-full text-[11px] font-black uppercase tracking-wide border transition-all duration-300 active:scale-95 ${
-                                                teacherStatusFilter === opt.key
-                                                    ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/15'
-                                                    : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            {opt.label}
-                                        </button>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-
-                        {teachersFiltered.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhum professor encontrado.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {teachersFiltered.map(t => (
-                                    <div
-                                        key={t.id}
-                                        className="bg-neutral-800 p-4 rounded-2xl flex justify-between items-center border border-neutral-700 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-                                        onClick={() => { setSelectedTeacher(t); }}
-                                    >
-                                        <div className="min-w-0">
-                                            <h3 className="font-black text-white truncate">{normalizeWorkoutTitle(t.name)}</h3>
-                                            <p className="text-xs text-neutral-400 truncate">{t.email}</p>
-                                            <div className="mt-2 flex flex-wrap items-center gap-2">
-                                                <span className="px-3 py-1.5 rounded-full bg-neutral-900 border border-neutral-700 text-[11px] font-black uppercase tracking-wide text-neutral-200">
-                                                    {t.status || 'pendente'}
-                                                </span>
-                                                <span className="text-[11px] font-semibold text-neutral-500">{t.phone || 'Sem telefone'}</span>
-                                                <span className="text-[11px] font-semibold text-neutral-500">Nascimento: {t.birth_date ? new Date(t.birth_date).toLocaleDateString() : '-'}</span>
-                                            </div>
-                                        </div>
-                                        <div className="flex items-center gap-2 flex-shrink-0" onClick={(e) => e.stopPropagation()}>
-                                            <button
-                                                onClick={() => setEditingTeacher(t)}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-yellow-500/40 hover:bg-yellow-500/10 text-neutral-300 hover:text-yellow-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Edit3 size={16} />
-                                            </button>
-                                            <select
-                                                value={t.status || 'pendente'}
-                                                onChange={async (e) => {
-                                                    const newStatus = e.target.value;
-                                                    const res = await fetch('/api/admin/teachers/status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: t.id, status: newStatus }) });
-                                                    const json = await res.json();
-                                                    if (json.ok) setTeachersList(prev => prev.map(x => x.id === t.id ? { ...x, status: newStatus } : x));
-                                                }}
-                                                className="min-h-[40px] bg-neutral-900/70 text-neutral-200 rounded-xl px-3 py-2 text-xs border border-neutral-700 focus:border-yellow-500 focus:outline-none"
-                                            >
-                                                <option value="pago">pago</option>
-                                                <option value="pendente">pendente</option>
-                                                <option value="atrasado">atrasado</option>
-                                                <option value="cancelar">cancelar</option>
-                                            </select>
-                                            <button
-                                                onClick={async () => {
-                                                    if (await confirm(`Excluir professor ${t.name}?`)) {
-                                                        try {
-                                                            const res = await fetch('/api/admin/teachers/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: t.id }) });
-                                                            const json = await res.json();
-                                                            if (!json.ok) throw new Error(json.error || 'Falha ao excluir');
-                                                            setTeachersList(prev => prev.filter(x => x.id !== t.id));
-                                                        } catch (err) {
-                                                            await alert('Erro: ' + (err?.message ?? String(err)));
-                                                        }
-                                                    }
-                                                }}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-red-500/40 hover:bg-red-900/20 text-neutral-300 hover:text-red-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Trash2 size={16} />
-                                            </button>
-                                            {isAdmin && (t.status === 'pending' || t.status === 'pendente') && (
-                                                <button
-                                                    onClick={async () => {
-                                                        try {
-                                                            const res = await fetch('/api/admin/teachers/status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: t.id, status: 'active' }) });
-                                                            const json = await res.json();
-                                                            if (!json.ok) throw new Error(json.error || '');
-                                                            setTeachersList(prev => prev.map(x => x.id === t.id ? { ...x, status: 'active' } : x));
-                                                        } catch (err) {
-                                                            await alert('Erro ao aprovar: ' + (err?.message ?? String(err)));
-                                                        }
-                                                    }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-green-600 hover:bg-green-500 text-white text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Aprovar
-                                                </button>
-                                            )}
-                                        </div>
-                                    </div>
-                                ))}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'teachers' && isAdmin && !selectedStudent && selectedTeacher && (
-                    <div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-start justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Professor</div>
-                                    <h2 className="text-base md:text-lg font-black text-white truncate">{normalizeWorkoutTitle(selectedTeacher?.name || '') || 'Professor'}</h2>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold truncate">{selectedTeacher?.email || ''}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => { setSelectedTeacher(null); }}
-                                    className="w-11 h-11 rounded-2xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Voltar"
-                                >
-                                    <ArrowLeft size={18} />
-                                </button>
-                            </div>
-
-                            <div className="mt-4 flex items-center gap-2 overflow-x-auto no-scrollbar">
-                                {[
-                                    { key: 'students', label: 'Alunos' },
-                                    { key: 'templates', label: 'Treinos' },
-                                    { key: 'history', label: 'Histórico' },
-                                    { key: 'inbox', label: 'Interações' },
-                                ].map((opt) => (
-                                    <button
-                                        key={opt.key}
-                                        type="button"
-                                        onClick={() => setTeacherDetailTab(opt.key)}
-                                        className={`whitespace-nowrap min-h-[40px] px-3 py-2 rounded-full text-[11px] font-black uppercase tracking-wide border transition-all duration-300 active:scale-95 ${
-                                            teacherDetailTab === opt.key
-                                                ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/15'
-                                                : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                        }`}
-                                    >
-                                        {opt.label}
-                                    </button>
-                                ))}
-                            </div>
-                        </div>
-
-                        {teacherDetailTab === 'students' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Alunos</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherStudentsLoading ? 'Carregando…' : `${(Array.isArray(teacherStudents) ? teacherStudents.length : 0)} alunos`}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => loadTeacherStudents(selectedTeacher)}
-                                        className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                    >
-                                        Atualizar
-                                    </button>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherStudents) ? teacherStudents : []).length === 0 && !teacherStudentsLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhum aluno atribuído.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherStudents) ? teacherStudents : []).map((s) => (
-                                        <div
-                                            key={s.id}
-                                            className="bg-neutral-800 p-4 rounded-2xl flex justify-between items-center border border-neutral-700 hover:border-yellow-500/40 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-                                        >
-                                            <div className="min-w-0">
-                                                <div className="font-black text-white truncate">{normalizeWorkoutTitle(s.name) || s.email}</div>
-                                                <div className="text-xs text-neutral-400 truncate">{s.email}</div>
-                                            </div>
-                                            <button
-                                                type="button"
-                                                onClick={() => { setSelectedStudent(s); setSubTab('workouts'); }}
-                                                className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                            >
-                                                Ver aluno
-                                            </button>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-
-                        {teacherDetailTab === 'templates' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Treinos (Templates)</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherTemplatesLoading ? 'Carregando…' : `${(Array.isArray(teacherTemplatesRows) ? teacherTemplatesRows.length : 0)} itens`}</div>
-                                    </div>
-                                    <div className="flex items-center gap-2">
-                                        <button
-                                            type="button"
-                                            onClick={() => loadTeacherTemplates(selectedTeacher, true)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                        >
-                                            Atualizar
-                                        </button>
-                                        <button
-                                            type="button"
-                                            disabled={!teacherTemplatesCursor || teacherTemplatesLoading}
-                                            onClick={() => loadTeacherTemplates(selectedTeacher, false)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
-                                        >
-                                            Mais
-                                        </button>
-                                    </div>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherTemplatesRows) ? teacherTemplatesRows : []).length === 0 && !teacherTemplatesLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhum treino encontrado.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherTemplatesRows) ? teacherTemplatesRows : []).map((w) => (
-                                        <div key={w.id} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
-                                            <div className="flex items-center justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="font-black text-white truncate">{normalizeWorkoutTitle(w.name) || 'Treino'}</div>
-                                                    <div className="text-xs text-neutral-400 truncate">{w.student_name || ''}</div>
-                                                </div>
-                                                <button
-                                                    type="button"
-                                                    onClick={() => { setSelectedStudent({ user_id: w.user_id, name: w.student_name || '' }); setSubTab('workouts'); }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Abrir
-                                                </button>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-
-                        {teacherDetailTab === 'history' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Histórico de Treinos</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherHistoryLoading ? 'Carregando…' : `${(Array.isArray(teacherHistoryRows) ? teacherHistoryRows.length : 0)} itens`}</div>
-                                    </div>
-                                    <div className="flex items-center gap-2">
-                                        <button
-                                            type="button"
-                                            onClick={() => loadTeacherHistory(selectedTeacher, true)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                        >
-                                            Atualizar
-                                        </button>
-                                        <button
-                                            type="button"
-                                            disabled={!teacherHistoryCursor || teacherHistoryLoading}
-                                            onClick={() => loadTeacherHistory(selectedTeacher, false)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
-                                        >
-                                            Mais
-                                        </button>
-                                    </div>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherHistoryRows) ? teacherHistoryRows : []).length === 0 && !teacherHistoryLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhum treino executado encontrado.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherHistoryRows) ? teacherHistoryRows : []).map((w) => (
-                                        <div key={w.id} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
-                                            <div className="flex items-center justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="font-black text-white truncate">{normalizeWorkoutTitle(w.name) || 'Treino'}</div>
-                                                    <div className="text-xs text-neutral-400 truncate">{w.student_name || ''}{w.date ? ` • ${new Date(w.date).toLocaleDateString()}` : ''}</div>
-                                                </div>
-                                                <button
-                                                    type="button"
-                                                    onClick={() => { setSelectedStudent({ user_id: w.user_id, name: w.student_name || '' }); setSubTab('workouts'); }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Abrir
-                                                </button>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-
-                        {teacherDetailTab === 'inbox' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Interações (Inbox)</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherInboxLoading ? 'Carregando…' : `${(Array.isArray(teacherInboxItems) ? teacherInboxItems.length : 0)} itens`}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => loadTeacherInbox(selectedTeacher)}
-                                        className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                    >
-                                        Atualizar
-                                    </button>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherInboxItems) ? teacherInboxItems : []).length === 0 && !teacherInboxLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhuma interação sugerida.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherInboxItems) ? teacherInboxItems : []).map((it) => (
-                                        <div key={it.id} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
-                                            <div className="flex items-start justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="font-black text-white truncate">{it.title || 'Alerta'}</div>
-                                                    <div className="text-xs text-neutral-400 truncate">{it.student_name || ''}</div>
-                                                    <div className="mt-2 text-xs text-neutral-300">{it.reason || ''}</div>
-                                                </div>
-                                                <button
-                                                    type="button"
-                                                    onClick={() => { setSelectedStudent({ user_id: it.student_user_id, name: it.student_name || '' }); setSubTab('workouts'); }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Abrir
-                                                </button>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {selectedStudent && (
-                    <div className="animate-slide-up">
-                        {editingStudent ? (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-[0_16px_40px_rgba(0,0,0,0.35)] mb-6">
-                                <div className="flex items-center justify-between gap-3 mb-4">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Aluno</div>
-                                        <h3 className="text-base md:text-lg font-black text-white truncate">Editar informações</h3>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => setEditingStudent(false)}
-                                        className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                        aria-label="Fechar"
-                                    >
-                                        <X size={18} />
-                                    </button>
-                                </div>
-                                <div className="space-y-4">
-                                    <div>
-                                        <label className="block text-[11px] font-black uppercase tracking-widest text-neutral-500 mb-2">Nome</label>
-                                        <input type="text" value={editedStudent.name || ''} onChange={(e) => setEditedStudent(prev => ({ ...prev, name: e.target.value }))} className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none" />
-                                    </div>
-                                    <div>
-                                        <label className="block text-[11px] font-black uppercase tracking-widest text-neutral-500 mb-2">Email</label>
-                                        <input type="email" value={editedStudent.email || ''} onChange={(e) => setEditedStudent(prev => ({ ...prev, email: e.target.value }))} className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none" />
-                                    </div>
-                                    <div className="flex gap-3 pt-4">
-                                        <button onClick={handleSaveStudentEdit} className="flex-1 min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95">Salvar</button>
-                                        <button onClick={() => setEditingStudent(false)} className="flex-1 min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95">Cancelar</button>
-                                    </div>
-                                </div>
-                            </div>
-                        ) : (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 md:p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)] mb-6">
-                                <div className="grid gap-3 md:grid-cols-[1fr_auto] md:items-center">
-                                    <div className="flex items-start gap-3 md:gap-4 min-w-0">
-                                        <button
-                                            type="button"
-                                            onClick={() => { setSelectedStudent(null); setSubTab('workouts'); }}
-                                            className="w-11 h-11 rounded-2xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            aria-label="Voltar"
-                                        >
-                                            <ArrowLeft size={18} />
-                                        </button>
-                                        <div className="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-neutral-900 border border-neutral-800 flex items-center justify-center font-black text-lg md:text-xl text-neutral-100 flex-shrink-0">
-                                            {(selectedStudent?.name || selectedStudent?.email || '?')[0]}
-                                        </div>
-                                        <div className="min-w-0 flex-1">
-                                            <div className="flex flex-wrap items-center gap-2">
-                                                <h2 className="text-lg md:text-2xl font-black text-white truncate">{selectedStudent?.name || selectedStudent?.email}</h2>
-                                                <span className={`px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${selectedStatusTone}`}> {selectedStatusLabel}</span>
-                                            </div>
-                                            <p className="text-xs md:text-sm text-neutral-400 font-semibold truncate">{selectedStudent?.email}</p>
-                                        </div>
-                                    </div>
-
-                                    <div className="flex flex-col sm:flex-row md:flex-row items-stretch md:items-center gap-2">
-                                        {isAdmin && (Array.isArray(teachersList) ? teachersList.length : 0) > 0 && (
-                                            <div className="flex items-center gap-2 w-full sm:w-auto">
-                                                <span className="hidden lg:inline text-[10px] font-black uppercase tracking-widest text-neutral-500">Professor</span>
-                                                {(() => {
-                                                    const currentUid = selectedStudent.teacher_id || '';
-                                                    const list = Array.isArray(teachersList) ? [...teachersList] : [];
-                                                    if (currentUid && !list.some(t => t.user_id === currentUid)) {
-                                                        list.unshift({ id: currentUid, name: 'Professor atribuído', email: '', user_id: currentUid, status: 'active' });
-                                                    }
-                                                    const currentValue = currentUid ? `uid:${currentUid}` : '';
-                                                    return (
-                                                        <select
-                                                            value={currentValue}
-                                                            onChange={async (e) => {
-                                                                const raw = String(e.target.value || '').trim();
-                                                                const teacherUserId = raw.startsWith('uid:') ? raw.slice(4) : '';
-                                                                try {
-                                                                    const res = await fetch('/api/admin/students/assign-teacher', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ student_id: selectedStudent.id || selectedStudent.user_id, email: selectedStudent.email || '', teacher_user_id: teacherUserId || null })});
-                                                                    const json = await res.json();
-                                                                    if (json.ok) {
-                                                                        const nextTid = json.teacher_user_id || teacherUserId || null;
-                                                                        setSelectedStudent(prev => ({ ...prev, teacher_id: nextTid }));
-                                                                        setUsersList(prev => prev.map(x => (
-                                                                            (x.id === selectedStudent.id)
-                                                                            || (x.user_id === selectedStudent.user_id)
-                                                                            || ((x.email || '').toLowerCase() === (selectedStudent.email || '').toLowerCase())
-                                                                        ) ? { ...x, teacher_id: nextTid } : x));
-                                                                        try { if (selectedStudent.email) localStorage.setItem('student_teacher_'+selectedStudent.email, nextTid || ''); } catch {}
-                                                                        try {
-                                                                            const resp = await fetch('/api/admin/students/list');
-                                                                            const js = await resp.json();
-                                                                            if (js.ok) setUsersList(js.students || []);
-                                                                        } catch {}
-                                                                    } else {
-                                                                        await alert('Erro: ' + (json.error || 'Falha ao atualizar professor'));
-                                                                    }
-                                                                } catch (e) {
-                                                                    await alert('Erro: ' + (e?.message ?? String(e)));
-                                                                }
-                                                            }}
-                                                            className="min-h-[44px] bg-neutral-900/70 text-neutral-200 rounded-xl px-3 py-2 text-xs w-full sm:w-64 md:w-72 border border-neutral-800 focus:border-yellow-500 focus:outline-none"
-                                                        >
-                                                            <option value="">Sem Professor</option>
-                                                            {list.map(t => (
-                                                                <option
-                                                                    key={t.id || t.user_id || t.email || Math.random().toString(36).slice(2)}
-                                                                    value={t.user_id ? `uid:${t.user_id}` : ''}
-                                                                    disabled={!t.user_id}
-                                                                >
-                                                                    {(t.name || t.email || (t.user_id ? t.user_id.slice(0,8) : 'Professor')) + (!t.user_id ? ' (sem conta)' : '')}
-                                                                </option>
-                                                            ))}
-                                                        </select>
-                                                    );
-                                                })()}
-                                            </div>
-                                        )}
-                                        <button
-                                            type="button"
-                                            onClick={() => setEditingStudent(true)}
-                                            className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 shrink-0"
-                                            title="Editar"
-                                        >
-                                            <Edit3 size={18} className="text-yellow-500" /> Editar
-                                        </button>
-                                    </div>
-                                </div>
-
-                                <div className="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
-                                    <div className="bg-neutral-950/40 border border-neutral-800 rounded-2xl p-3">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Treinos</div>
-                                        <div className="mt-1 text-lg font-black text-white">{(Array.isArray(studentWorkouts) ? studentWorkouts.length : 0) + (Array.isArray(syncedWorkouts) ? syncedWorkouts.length : 0)}</div>
-                                    </div>
-                                    <div className="bg-neutral-950/40 border border-neutral-800 rounded-2xl p-3">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Avaliações</div>
-                                        <div className="mt-1 text-lg font-black text-white">{Array.isArray(assessments) ? assessments.length : 0}</div>
-                                    </div>
-                                    <div className="bg-neutral-950/40 border border-neutral-800 rounded-2xl p-3">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Status</div>
-                                        <div className="mt-1 text-lg font-black text-white truncate">{selectedStatusLabel}</div>
-                                    </div>
-                                </div>
-                            </div>
-                        )}
-
-                        <div className="mb-6">
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-full p-1 flex items-center gap-1 shadow-[0_10px_30px_rgba(0,0,0,0.35)]">
-                                <button
-                                    type="button"
-                                    onClick={() => setSubTab('workouts')}
-                                    className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        subTab === 'workouts'
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                            : 'text-neutral-200'
-                                    }`}
-                                >
-                                    Treinos
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => setSubTab('evolution')}
-                                    className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        subTab === 'evolution'
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                            : 'text-neutral-200'
-                                    }`}
-                                >
-                                    Evolução
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => setSubTab('checkins')}
-                                    className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        subTab === 'checkins'
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                            : 'text-neutral-200'
-                                    }`}
-                                >
-                                    Check-ins
-                                </button>
-                                {executionVideoEnabled ? (
-                                    <button
-                                        type="button"
-                                        onClick={() => setSubTab('videos')}
-                                        className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                            subTab === 'videos'
-                                                ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                                : 'text-neutral-200'
-                                        }`}
-                                    >
-                                        Vídeos
-                                    </button>
-                                ) : null}
-                            </div>
-                        </div>
-
-                        {loading && <p className="text-center animate-pulse">Carregando dados...</p>}
-
-                        {!loading && subTab === 'workouts' && (
-                            <div className="space-y-4">
-                                <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                        <div className="min-w-0">
-                                            <div className="flex items-center gap-2">
-                                                <Dumbbell size={18} className="text-yellow-500" />
-                                                <h3 className="text-base font-black text-white tracking-tight">Treinos do aluno</h3>
-                                            </div>
-                                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                                {(Array.isArray(studentWorkouts) ? studentWorkouts.length : 0) + (Array.isArray(syncedWorkouts) ? syncedWorkouts.length : 0)} atribuídos
-                                            </div>
-                                        </div>
-                                        <div className="flex flex-col sm:flex-row gap-2">
-                                            <button
-                                                type="button"
-                                                data-tour="adminpanel.student.workouts.history"
-                                                onClick={() => setHistoryOpen(true)}
-                                                className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-yellow-500/25 text-yellow-400 rounded-xl text-[11px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-yellow-500/10 transition-all duration-300 active:scale-95"
-                                            >
-                                                <History size={16} /> Histórico
-                                            </button>
-                                            <button
-                                                type="button"
-                                                data-tour="adminpanel.student.workouts.create"
-                                                onClick={() => setEditingStudentWorkout({ id: null, title: '', exercises: [] })}
-                                                className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl text-[11px] font-black uppercase tracking-widest transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95"
-                                            >
-                                                Criar treino
-                                            </button>
-                                        </div>
-                                    </div>
-                                </div>
-                                {templates.length > 0 && (
-                                    <button onClick={async () => {
-                                            try {
-                                                const looksLikeUuid = (v) => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(v || '').trim());
-                                                const maybeId = selectedStudent.user_id || selectedStudent.id || null;
-                                                let payloadId = looksLikeUuid(maybeId) ? String(maybeId) : undefined;
-                                                const payloadEmail = String(selectedStudent.email || '').trim();
-                                                if (!payloadId && payloadEmail) {
-                                                    try {
-                                                        const { data: profile } = await supabase
-                                                            .from('profiles')
-                                                            .select('id')
-                                                            .ilike('email', payloadEmail)
-                                                            .maybeSingle();
-                                                        if (profile?.id) payloadId = String(profile.id);
-                                                    } catch {}
-                                                }
-                                                if (!payloadId && !payloadEmail) {
-                                                    await alert('Aluno sem conta (user_id) e sem email; não é possível sincronizar.');
-                                                    return;
-                                                }
-                                                if (!payloadId && payloadEmail) {
-                                                    await alert('Aluno sem conta (user_id). Não é possível sincronizar.');
-                                                    return;
-                                                }
-                                                const normalize = (s) => (s || '')
-                                                    .toLowerCase()
-                                                    .normalize('NFD')
-                                                    .replace(/[\u0300-\u036f]/g, '')
-                                                    .replace(/\s+/g, ' ')
-                                                    .trim();
-                                            const extractLetter = (rawName) => {
-                                                const nn = normalize(rawName);
-                                                if (!nn) return null;
-                                                const m = nn.match(/^treino\s*\(?([a-z])/);
-                                                if (m && m[1]) return m[1];
-                                                const m2 = nn.match(/\(([a-z])\)/);
-                                                if (m2 && m2[1]) return m2[1];
-                                                return null;
-                                            };
-                                            const res = await fetch('/api/admin/workouts/sync-templates', {
-                                                method: 'POST', headers: { 'Content-Type': 'application/json' },
-                                                body: JSON.stringify({
-                                                    id: payloadId,
-                                                    email: payloadEmail,
-                                                    mode: 'all'
-                                                })
-                                            })
-                                            const json = await res.json();
-                                            if (json.ok) {
-                                                const resolvedTargetUserId = String(json?.debug?.targetUserId || selectedStudent.user_id || '').trim();
-                                                // Se rota retorna vazio, reforçar fetch direto por OR user_id/student_id
-                                                let rows = json.rows || [];
-                                                if (!rows || rows.length === 0) {
-                                                    try {
-                                                        const { data: refreshed } = await supabase
-                                                            .from('workouts')
-                                                            .select('*, exercises(*, sets(*))')
-                                                            .eq('user_id', resolvedTargetUserId)
-                                                            .eq('is_template', true)
-                                                            .order('name');
-                                                        rows = refreshed || [];
-                                                    } catch {}
-                                                }
-                                                const scoped = (rows || []).filter(w => String(w?.user_id || '') === resolvedTargetUserId)
-                                                const synced = (scoped || []).filter(w => (w?.is_template && String(w?.created_by || '') === String(user.id)))
-                                                const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-                                                const others = (scoped || []).filter(w => !syncedIds.has(w?.id));
-                                                setStudentWorkouts(others)
-                                                setSyncedWorkouts(synced)
-                                                const msg = `Sincronização contínua ativada: ${json.created_count || 0} criado(s), ${json.updated_count || 0} atualizado(s)`
-                                                if ((json.created_count || 0) + (json.updated_count || 0) === 0 && json.debug) {
-                                                    const d = json.debug || {}
-                                                    const extra = `\n\nDiagnóstico:\n- sourceUserId: ${d.sourceUserId || '-'}\n- source_mode: ${d.source_mode || '-'}\n- owner_raw: ${d.owner_raw_count ?? '-'}\n- owner_matched: ${d.owner_matched_count ?? '-'}\n- source_count: ${d.source_count ?? '-'}\n- picked: ${d.picked_count ?? '-'}\n- picked_names: ${(d.picked_names || []).slice(0, 3).join(' | ') || '-'}\n- sample: ${(d.source_sample_names || []).slice(0, 3).join(' | ') || '-'}`
-                                                    await alert(msg + extra)
-                                                } else {
-                                                    await alert(msg)
-                                                }
-                                            } else {
-                                                const d = json?.debug || null
-                                                if (d) {
-                                                    const sample = Array.isArray(d.owner_sample_names) ? d.owner_sample_names.slice(0, 3).join(' | ') : '-'
-                                                    const extra = `\n\nDiagnóstico:\n- authUserId: ${d.authUserId || '-'}\n- sourceUserId: ${d.sourceUserId || '-'}\n- syncMode: ${d.syncMode || '-'}\n- owner_raw: ${d.owner_raw_count ?? '-'}\n- owner_owned: ${d.owner_owned_count ?? '-'}\n- owner_matched: ${d.owner_matched_count ?? '-'}\n- sample: ${sample}`
-                                                    await alert('Erro: ' + (json.error || 'Falha ao sincronizar') + extra)
-                                                } else {
-                                                    await alert('Erro: ' + (json.error || 'Falha ao sincronizar'))
-                                                }
-                                            }
-                                        } catch (e) { await alert('Erro ao sincronizar: ' + (e?.message ?? String(e))) }
-                                    }} className="px-3 py-2 bg-neutral-800 border border-neutral-700 text-neutral-200 rounded-lg text-xs font-bold">Sincronizar com Meus Treinos</button>
-                                )}
-                                {syncedWorkouts.length > 0 && (
-                                    <div className="mt-4">
-                                        <h3 className="font-bold text-yellow-500 text-xs uppercase tracking-widest mb-2">Treinos sincronizados</h3>
-                                        {syncedWorkouts.map(w => (
-                                            <div key={w.id} className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 flex justify-between items-center cursor-pointer" onClick={() => setViewWorkout(w)}>
-                                                <div>
-                                                    <h4 className="font-bold text-white">{normalizeWorkoutTitle(w.name)}</h4>
-                                                    <p className="text-xs text-neutral-500">{w.exercises?.length || 0} exercícios</p>
-                                                </div>
-                                                <div className="flex items-center gap-2">
-                                                    <button onClick={(e) => openEditWorkout(e, w)} className="p-2 bg-neutral-700 hover:bg-yellow-500 text-neutral-300 hover:text-black rounded"><Edit3 size={16}/></button>
-                                                    <button onClick={async (e) => { e.stopPropagation(); if (!(await confirm('Remover este treino do aluno?'))) return; try { const res = await fetch('/api/admin/workouts/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: w.id }) }); const json = await res.json(); if (!json.ok) throw new Error(json.error || 'Falha ao remover'); setStudentWorkouts(prev => prev.filter(x => x.id !== w.id)); setSyncedWorkouts(prev => prev.filter(x => x.id !== w.id)); } catch (e) { await alert('Erro ao remover: ' + (e?.message ?? String(e))); } }} className="p-2 text-red-500 hover:bg-red-900/20 rounded"><Trash2 size={18}/></button>
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                                {studentWorkouts.length === 0 && <p className="text-neutral-500 text-sm">Nenhum treino atribuído.</p>}
-                                {studentWorkouts.map(w => (
-                            <div key={w.id} className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 flex justify-between items-center cursor-pointer" onClick={() => setViewWorkout(w)}>
-                                <div>
-                                    <h4 className="font-bold text-white">{normalizeWorkoutTitle(w.name)}</h4>
-                                    <p className="text-xs text-neutral-500">{w.exercises?.length || 0} exercícios</p>
-                                </div>
-                                <div className="flex items-center gap-2">
-                                    <button onClick={(e) => openEditWorkout(e, w)} className="p-2 bg-neutral-700 hover:bg-yellow-500 text-neutral-300 hover:text-black rounded"><Edit3 size={16}/></button>
-                                    <button onClick={async (e) => { e.stopPropagation(); if (!(await confirm('Remover este treino do aluno?'))) return; try { const res = await fetch('/api/admin/workouts/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: w.id }) }); const json = await res.json(); if (!json.ok) throw new Error(json.error || 'Falha ao remover'); setStudentWorkouts(prev => prev.filter(x => x.id !== w.id)); } catch (e) { await alert('Erro ao remover: ' + (e?.message ?? String(e))); } }} className="p-2 text-red-500 hover:bg-red-900/20 rounded"><Trash2 size={18}/></button>
-                        </div>
-                    </div>
-                ))}
-                <div className="mt-6">
-                    <h3 className="font-bold text-yellow-500 text-xs uppercase tracking-widest mb-2">Meus Treinos</h3>
-                    {templates.length === 0 && <p className="text-neutral-500 text-sm">Nenhum treino seu encontrado.</p>}
-                    {templates.map(t => (
-                        <button key={t.id} onClick={() => handleAddTemplateToStudent(t)} className="w-full text-left p-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl border border-neutral-700 flex justify-between group">
-                            <span>{t.name}</span>
-                            <Plus className="text-neutral-500 group-hover:text-yellow-500"/>
-                        </button>
-                    ))}
-                </div>
-            </div>
-        )}
-
-        {!loading && executionVideoEnabled && subTab === 'videos' && (
-            <div className="space-y-4">
-                <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                        <div className="min-w-0">
-                            <div className="flex items-center gap-2">
-                                <Video size={18} className="text-yellow-500" />
-                                <h3 className="text-base font-black text-white tracking-tight">Vídeos de execução</h3>
-                            </div>
-                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                {executionVideosLoading ? 'Carregando...' : `${Array.isArray(executionVideos) ? executionVideos.length : 0} enviado(s)`}
-                            </div>
-                        </div>
-                        <button
-                            type="button"
-                            onClick={async () => {
-                                try {
-                                    if (!selectedStudent?.user_id) return;
-                                    setExecutionVideosLoading(true);
-                                    setExecutionVideosError('');
-                                    const res = await fetch(`/api/teacher/execution-videos/by-student?student_user_id=${encodeURIComponent(String(selectedStudent.user_id))}`, { cache: 'no-store', credentials: 'include' });
-                                    const json = await res.json().catch(() => null);
-                                    if (!res.ok || !json?.ok) {
-                                        setExecutionVideos([]);
-                                        setExecutionVideosError(String(json?.error || `Falha ao carregar (${res.status})`));
-                                        return;
-                                    }
-                                    setExecutionVideos(Array.isArray(json.items) ? json.items : []);
-                                } catch (e) {
-                                    setExecutionVideos([]);
-                                    setExecutionVideosError(e?.message ? String(e.message) : 'Erro ao carregar');
-                                } finally {
-                                    setExecutionVideosLoading(false);
-                                }
-                            }}
-                            disabled={executionVideosLoading}
-                            className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 disabled:opacity-60"
-                        >
-                            Atualizar
-                        </button>
-                    </div>
-                </div>
-
-                {executionVideosError ? (
-                    <div className="bg-neutral-900/60 border border-red-500/30 rounded-2xl p-4 text-red-200 font-bold text-sm">
-                        {executionVideosError}
-                    </div>
-                ) : null}
-
-                {executionVideosLoading ? (
-                    <div className="text-center animate-pulse text-neutral-400 font-semibold">Carregando vídeos...</div>
-                ) : !Array.isArray(executionVideos) || executionVideos.length === 0 ? (
-                    <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 text-neutral-400 font-semibold">
-                        Nenhum vídeo enviado ainda.
-                    </div>
-                ) : (
-                    <div className="space-y-3">
-                        {executionVideos.map((it) => {
-                            const id = it?.id ? String(it.id) : '';
-                            const when = it?.created_at ? new Date(it.created_at) : null;
-                            const title = String(it?.exercise_name || 'Execução').trim();
-                            const status = String(it?.status || 'pending').toLowerCase();
-                            const draft = executionVideoFeedbackDraft && typeof executionVideoFeedbackDraft === 'object' ? executionVideoFeedbackDraft[id] : '';
-                            const statusLabel = status === 'approved' ? 'Aprovado' : status === 'rejected' ? 'Reprovado' : 'Pendente';
-                            const statusTone =
-                                status === 'approved'
-                                    ? 'border-green-500/30 text-green-300'
-                                    : status === 'rejected'
-                                      ? 'border-red-500/30 text-red-300'
-                                      : 'border-yellow-500/30 text-yellow-300';
-                            return (
-                                <div key={id || Math.random().toString(36).slice(2)} className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                                    <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
-                                        <div className="min-w-0">
-                                            <div className="flex flex-wrap items-center gap-2">
-                                                <div className="text-base font-black text-white truncate">{title}</div>
-                                                <span className={`px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${statusTone}`}>{statusLabel}</span>
-                                            </div>
-                                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                                {when ? when.toLocaleString() : ''}
-                                            </div>
-                                        </div>
-                                        <div className="flex flex-col sm:flex-row gap-2">
-                                            <button
-                                                type="button"
-                                                onClick={async () => {
-                                                    try {
-                                                        const res = await fetch('/api/execution-videos/media', {
-                                                            method: 'POST',
-                                                            credentials: 'include',
-                                                            headers: { 'content-type': 'application/json' },
-                                                            body: JSON.stringify({ submission_id: id }),
-                                                        });
-                                                        const json = await res.json().catch(() => null);
-                                                        if (!res.ok || !json?.ok || !json?.url) {
-                                                            await alert(String(json?.error || `Falha ao abrir (${res.status})`));
-                                                            return;
-                                                        }
-                                                        setExecutionVideoModalUrl(String(json.url));
-                                                        setExecutionVideoModalOpen(true);
-                                                    } catch (e) {
-                                                        await alert('Erro: ' + (e?.message ?? String(e)));
-                                                    }
-                                                }}
-                                                className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95"
-                                            >
-                                                Assistir
-                                            </button>
-                                            <button
-                                                type="button"
-                                                onClick={async () => {
-                                                    try {
-                                                        const feedback = String(draft || '').trim();
-                                                        const res = await fetch('/api/teacher/execution-videos/review', {
-                                                            method: 'POST',
-                                                            credentials: 'include',
-                                                            headers: { 'content-type': 'application/json' },
-                                                            body: JSON.stringify({ submission_id: id, status: 'approved', feedback, send_message: true }),
-                                                        });
-                                                        const json = await res.json().catch(() => null);
-                                                        if (!res.ok || !json?.ok) {
-                                                            await alert(String(json?.error || `Falha ao aprovar (${res.status})`));
-                                                            return;
-                                                        }
-                                                        setExecutionVideos((prev) => (Array.isArray(prev) ? prev.map((x) => (String(x?.id || '') === id ? { ...x, status: 'approved', teacher_feedback: feedback } : x)) : prev));
-                                                    } catch (e) {
-                                                        await alert('Erro: ' + (e?.message ?? String(e)));
-                                                    }
-                                                }}
-                                                className="min-h-[44px] px-4 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-black transition-all duration-300 active:scale-95"
-                                            >
-                                                Aprovar
-                                            </button>
-                                            <button
-                                                type="button"
-                                                onClick={async () => {
-                                                    try {
-                                                        const feedback = String(draft || '').trim();
-                                                        const res = await fetch('/api/teacher/execution-videos/review', {
-                                                            method: 'POST',
-                                                            credentials: 'include',
-                                                            headers: { 'content-type': 'application/json' },
-                                                            body: JSON.stringify({ submission_id: id, status: 'rejected', feedback, send_message: true }),
-                                                        });
-                                                        const json = await res.json().catch(() => null);
-                                                        if (!res.ok || !json?.ok) {
-                                                            await alert(String(json?.error || `Falha ao reprovar (${res.status})`));
-                                                            return;
-                                                        }
-                                                        setExecutionVideos((prev) => (Array.isArray(prev) ? prev.map((x) => (String(x?.id || '') === id ? { ...x, status: 'rejected', teacher_feedback: feedback } : x)) : prev));
-                                                    } catch (e) {
-                                                        await alert('Erro: ' + (e?.message ?? String(e)));
-                                                    }
-                                                }}
-                                                className="min-h-[44px] px-4 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-black transition-all duration-300 active:scale-95"
-                                            >
-                                                Reprovar
-                                            </button>
-                                        </div>
-                                    </div>
-
-                                    <div className="mt-3">
-                                        <label className="block text-[11px] font-black uppercase tracking-widest text-neutral-500 mb-2">Mensagem para o aluno</label>
-                                        <textarea
-                                            value={String(draft || '')}
-                                            onChange={(e) => {
-                                                const v = e?.target?.value ?? '';
-                                                setExecutionVideoFeedbackDraft((prev) => ({ ...(prev && typeof prev === 'object' ? prev : {}), [id]: v }));
-                                            }}
-                                            rows={3}
-                                            className="w-full bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none"
-                                            placeholder="Escreva seu feedback..."
-                                        />
-                                    </div>
-                                </div>
-                            );
-                        })}
-                    </div>
-                )}
-            </div>
-        )}
-
-        {!loading && subTab === 'checkins' && (
-            <div className="space-y-4">
-                <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                        <div className="min-w-0">
-                            <div className="flex items-center gap-2">
-                                <History size={18} className="text-yellow-500" />
-                                <h3 className="text-base font-black text-white tracking-tight">Check-ins do aluno</h3>
-                            </div>
-                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                {studentCheckinsLoading ? 'Carregando...' : `${Array.isArray(studentCheckinsRows) ? studentCheckinsRows.length : 0} item(s)`}
-                            </div>
-                        </div>
-                        <div className="flex flex-col sm:flex-row gap-2">
-                            {['7d', '30d'].map((k) => (
-                                <button
-                                    key={k}
-                                    type="button"
-                                    onClick={() => setStudentCheckinsRange(k)}
-                                    className={`min-h-[44px] px-4 py-3 rounded-xl text-[11px] font-black uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        String(studentCheckinsRange || '7d') === k
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/15'
-                                            : 'bg-neutral-900/70 border border-neutral-800 text-neutral-200 hover:bg-neutral-900'
-                                    }`}
-                                >
-                                    {k === '7d' ? '7 dias' : '30 dias'}
-                                </button>
-                            ))}
-                            {['all', 'pre', 'post'].map((k) => (
-                                <button
-                                    key={k}
-                                    type="button"
-                                    onClick={() => setStudentCheckinsFilter(k)}
-                                    className={`min-h-[44px] px-4 py-3 rounded-xl text-[11px] font-black uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        String(studentCheckinsFilter || 'all') === k
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/15'
-                                            : 'bg-neutral-900/70 border border-neutral-800 text-neutral-200 hover:bg-neutral-900'
-                                    }`}
-                                >
-                                    {k === 'all' ? 'Todos' : k === 'pre' ? 'Pré' : 'Pós'}
-                                </button>
-                            ))}
-                        </div>
-                    </div>
-                </div>
-
-                {studentCheckinsError ? (
-                    <div className="bg-neutral-950/40 border border-yellow-500/20 rounded-2xl p-4 text-sm text-neutral-200">
-                        {studentCheckinsError}
-                    </div>
-                ) : null}
-
-                {(() => {
-                    const rows = Array.isArray(studentCheckinsRows) ? studentCheckinsRows : [];
-                    const filter = String(studentCheckinsFilter || 'all');
-                    const filtered = filter === 'all' ? rows : rows.filter((r) => String(r?.kind || '').trim() === filter);
-
-                    const toNumberOrNull = (v) => {
-                        const n = typeof v === 'number' ? v : Number(String(v ?? '').replace(',', '.'));
-                        return Number.isFinite(n) ? n : null;
-                    };
-                    const avg = (vals) => {
-                        const list = Array.isArray(vals) ? vals.filter((v) => typeof v === 'number' && Number.isFinite(v)) : [];
-                        if (!list.length) return null;
-                        return list.reduce((a, b) => a + b, 0) / list.length;
-                    };
-
-                    const preRows = rows.filter((r) => String(r?.kind || '').trim() === 'pre');
-                    const postRows = rows.filter((r) => String(r?.kind || '').trim() === 'post');
-                    const preAvgEnergy = avg(preRows.map((r) => toNumberOrNull(r?.energy)));
-                    const preAvgSoreness = avg(preRows.map((r) => toNumberOrNull(r?.soreness)));
-                    const preAvgTime = avg(preRows.map((r) => {
-                        const answers = r?.answers && typeof r.answers === 'object' ? r.answers : {};
-                        return toNumberOrNull(answers?.time_minutes ?? answers?.timeMinutes);
-                    }));
-                    const postAvgSoreness = avg(postRows.map((r) => toNumberOrNull(r?.soreness)));
-                    const postAvgSatisfaction = avg(postRows.map((r) => toNumberOrNull(r?.mood)));
-                    const postAvgRpe = avg(postRows.map((r) => {
-                        const answers = r?.answers && typeof r.answers === 'object' ? r.answers : {};
-                        return toNumberOrNull(answers?.rpe);
-                    }));
-
-                    const highSorenessCount = rows.filter((r) => {
-                        const s = toNumberOrNull(r?.soreness);
-                        return s != null && s >= 7;
-                    }).length;
-                    const lowEnergyCount = preRows.filter((r) => {
-                        const e = toNumberOrNull(r?.energy);
-                        return e != null && e <= 2;
-                    }).length;
-                    const alerts = [];
-                    if (highSorenessCount >= 3) alerts.push('Dor alta (≥ 7) apareceu 3+ vezes no período.');
-                    if (preAvgSoreness != null && preAvgSoreness >= 7) alerts.push('Média de dor no pré está alta (≥ 7).');
-                    if (lowEnergyCount >= 3) alerts.push('Energia baixa (≤ 2) apareceu 3+ vezes no período.');
-                    if (postAvgSatisfaction != null && postAvgSatisfaction <= 2) alerts.push('Satisfação média no pós está baixa (≤ 2).');
-
-                    const suggestions = [];
-                    if (highSorenessCount >= 3 || (preAvgSoreness != null && preAvgSoreness >= 7) || (postAvgSoreness != null && postAvgSoreness >= 7)) {
-                        suggestions.push('Dor alta: reduzir volume/carga 20–30% e priorizar técnica + mobilidade.');
-                    }
-                    if (lowEnergyCount >= 3 || (preAvgEnergy != null && preAvgEnergy <= 2.2)) {
-                        suggestions.push('Energia baixa: treino mais curto, sem falha, foco em recuperação (sono/estresse).');
-                    }
-                    if (postAvgRpe != null && postAvgRpe >= 9) {
-                        suggestions.push('RPE médio alto: reduzir intensidade e aumentar descanso entre séries.');
-                    }
-                    if (postAvgSatisfaction != null && postAvgSatisfaction <= 2) {
-                        suggestions.push('Satisfação baixa: revisar seleção de exercícios e meta da sessão.');
-                    }
-                    if (preAvgTime != null && preAvgTime > 0 && preAvgTime < 45) {
-                        suggestions.push('Pouco tempo: usar treino “mínimo efetivo” (menos exercícios e mais foco).');
-                    }
-
-                    return (
-                        <div className="space-y-4">
-                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Pré</div>
-                                    <div className="mt-2 grid grid-cols-3 gap-3">
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Energia</div>
-                                            <div className="font-black text-white">{preAvgEnergy == null ? '—' : preAvgEnergy.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Dor</div>
-                                            <div className="font-black text-white">{preAvgSoreness == null ? '—' : preAvgSoreness.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Tempo</div>
-                                            <div className="font-black text-white">{preAvgTime == null ? '—' : `${Math.round(preAvgTime)}m`}</div>
-                                        </div>
-                                    </div>
-                                </div>
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Pós</div>
-                                    <div className="mt-2 grid grid-cols-3 gap-3">
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">RPE</div>
-                                            <div className="font-black text-white">{postAvgRpe == null ? '—' : postAvgRpe.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Satisf.</div>
-                                            <div className="font-black text-white">{postAvgSatisfaction == null ? '—' : postAvgSatisfaction.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Dor</div>
-                                            <div className="font-black text-white">{postAvgSoreness == null ? '—' : postAvgSoreness.toFixed(1)}</div>
-                                        </div>
-                                    </div>
-                                </div>
-                            </div>
-
-                            {alerts.length ? (
-                                <div className="rounded-2xl border border-yellow-500/20 bg-yellow-500/10 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Alertas</div>
-                                    <div className="mt-2 space-y-1 text-sm text-neutral-200">
-                                        {alerts.map((a) => (
-                                            <div key={a}>{a}</div>
-                                        ))}
-                                    </div>
-                                </div>
-                            ) : null}
-
-                            {suggestions.length ? (
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-neutral-200">Sugestões</div>
-                                    <div className="mt-2 space-y-1 text-sm text-neutral-200">
-                                        {suggestions.map((s) => (
-                                            <div key={s}>{s}</div>
-                                        ))}
-                                    </div>
-                                </div>
-                            ) : null}
-
-                            {filtered.length === 0 ? (
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4 text-sm text-neutral-400">
-                                    Nenhum check-in encontrado.
-                                </div>
-                            ) : (
-                                <div className="space-y-2">
-                                    {filtered.map((r) => {
-                                        const kind = String(r?.kind || '').trim();
-                                        const createdAt = r?.created_at ? new Date(String(r.created_at)) : null;
-                                        const dateLabel = createdAt && !Number.isNaN(createdAt.getTime()) ? createdAt.toLocaleString('pt-BR') : '—';
-                                        const energy = r?.energy != null ? String(r.energy) : '—';
-                                        const soreness = r?.soreness != null ? String(r.soreness) : '—';
-                                        const mood = r?.mood != null ? String(r.mood) : '—';
-                                        const answers = r?.answers && typeof r.answers === 'object' ? r.answers : {};
-                                        const rpe = answers?.rpe != null ? String(answers.rpe) : '—';
-                                        const timeMinutes = answers?.time_minutes != null ? String(answers.time_minutes) : answers?.timeMinutes != null ? String(answers.timeMinutes) : '—';
-                                        const notes = r?.notes ? String(r.notes) : '';
-                                        return (
-                                            <div key={String(r?.id || dateLabel)} className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                                <div className="flex items-start justify-between gap-3">
-                                                    <div className="min-w-0">
-                                                        <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">{kind === 'pre' ? 'Pré' : 'Pós'}</div>
-                                                        <div className="text-xs text-neutral-500">{dateLabel}</div>
-                                                    </div>
-                                                    <div className="text-xs text-neutral-300 font-mono">
-                                                        {kind === 'pre' ? `E:${energy} D:${soreness} T:${timeMinutes}` : `RPE:${rpe} Sat:${mood} D:${soreness}`}
-                                                    </div>
-                                                </div>
-                                                {notes ? <div className="mt-2 text-sm text-neutral-200">{notes}</div> : null}
-                                            </div>
-                                        );
-                                    })}
-                                </div>
-                            )}
-                        </div>
-                    );
-                })()}
-            </div>
-        )}
-
-        {!loading && subTab === 'evolution' && (
-                            <div className="space-y-4">
-                                <AssessmentButton studentId={selectedStudent.user_id || selectedStudent.id} studentName={selectedStudent.name} variant="card" />
-                                {assessments.length > 0 && (
-                                    <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700">
-                                        <h4 className="font-bold text-white mb-3">Avaliações Anteriores</h4>
-                                        {assessments.map(a => (
-                                            <div key={a.id} className="flex justify-between items-center py-2 border-b border-neutral-700 last:border-0">
-                                                <span className="text-neutral-400">{new Date(a.date).toLocaleDateString()}</span>
-                                                <div className="text-right">
-                                                    <span className="block font-bold text-white">{a.bf}% Gordura</span>
-                                                    <span className="text-xs text-neutral-500">{a.weight}kg</span>
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                            </div>
-                )}
-            </div>
-        )}
-
-                {prioritiesComposeOpen ? (
-                    <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setPrioritiesComposeOpen(false)}>
-                        <div className="bg-neutral-900 w-full max-w-2xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="font-black text-white">Enviar mensagem</div>
-                                <button
-                                    type="button"
-                                    onClick={() => setPrioritiesComposeOpen(false)}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-3">
-                                <textarea
-                                    value={prioritiesComposeText}
-                                    onChange={(e) => setPrioritiesComposeText(e.target.value)}
-                                    rows={5}
-                                    className="w-full bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none"
-                                    placeholder="Escreva sua mensagem..."
-                                />
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        type="button"
-                                        onClick={() => setPrioritiesComposeOpen(false)}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95"
-                                    >
-                                        Cancelar
-                                    </button>
-                                    <button
-                                        type="button"
-                                        onClick={async () => {
-                                            try {
-                                                const content = String(prioritiesComposeText || '').trim();
-                                                const studentId = String(prioritiesComposeStudentId || '').trim();
-                                                const kind = String(prioritiesComposeKind || '').trim();
-                                                if (!content || !studentId || !kind) return;
-                                                const res = await fetch('/api/teacher/inbox/send-message', {
-                                                    method: 'POST',
-                                                    credentials: 'include',
-                                                    headers: { 'content-type': 'application/json' },
-                                                    body: JSON.stringify({ student_user_id: studentId, content }),
-                                                });
-                                                const json = await res.json().catch(() => null);
-                                                if (!res.ok || !json?.ok) {
-                                                    await alert(String(json?.error || `Falha ao enviar (${res.status})`));
-                                                    return;
-                                                }
-                                                try {
-                                                    await fetch('/api/teacher/inbox/action', {
-                                                        method: 'POST',
-                                                        credentials: 'include',
-                                                        headers: { 'content-type': 'application/json' },
-                                                        body: JSON.stringify({ student_user_id: studentId, kind, action: 'done' }),
-                                                    });
-                                                } catch {}
-                                                setPrioritiesComposeOpen(false);
-                                                setPrioritiesComposeStudentId('');
-                                                setPrioritiesComposeKind('');
-                                                setPrioritiesComposeText('');
-                                                fetchPriorities();
-                                            } catch (e) {
-                                                await alert('Erro: ' + (e?.message ?? String(e)));
-                                            }
-                                        }}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 active:scale-95"
-                                    >
-                                        Enviar
-                                    </button>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                ) : null}
-
-                {prioritiesSettingsOpen ? (
-                    <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setPrioritiesSettingsOpen(false)}>
-                        <div className="bg-neutral-900 w-full max-w-2xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="font-black text-white">Configurar Prioridades</div>
-                                <button
-                                    type="button"
-                                    onClick={() => setPrioritiesSettingsOpen(false)}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-4">
-                                {prioritiesSettingsError ? (
-                                    <div className="bg-neutral-900/60 border border-red-500/30 rounded-2xl p-4 text-red-200 font-bold text-sm">
-                                        {prioritiesSettingsError}
-                                    </div>
-                                ) : null}
-                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Churn (dias sem treino)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.churnDays ?? COACH_INBOX_DEFAULTS.churnDays)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), churnDays: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Queda de volume (%)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.volumeDropPct ?? COACH_INBOX_DEFAULTS.volumeDropPct)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), volumeDropPct: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Aumento de carga (%)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.loadSpikePct ?? COACH_INBOX_DEFAULTS.loadSpikePct)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), loadSpikePct: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Volume mínimo (7d anterior)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.minPrev7Volume ?? COACH_INBOX_DEFAULTS.minPrev7Volume)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), minPrev7Volume: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Volume mínimo (7d atual p/ spike)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.minCurrent7VolumeSpike ?? COACH_INBOX_DEFAULTS.minCurrent7VolumeSpike)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), minCurrent7VolumeSpike: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Soneca padrão (min)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.snoozeDefaultMinutes ?? COACH_INBOX_DEFAULTS.snoozeDefaultMinutes)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), snoozeDefaultMinutes: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        type="button"
-                                        disabled={prioritiesSettingsLoading}
-                                        onClick={() => {
-                                            setPrioritiesSettings({ ...COACH_INBOX_DEFAULTS });
-                                            setPrioritiesSettingsError('');
-                                        }}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95 disabled:opacity-60"
-                                    >
-                                        Resetar
-                                    </button>
-                                    <button
-                                        type="button"
-                                        disabled={prioritiesSettingsLoading}
-                                        onClick={async () => {
-                                            const ok = await savePrioritiesSettings();
-                                            if (!ok) return;
-                                            setPrioritiesSettingsOpen(false);
-                                            fetchPriorities();
-                                        }}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 active:scale-95 disabled:opacity-60"
-                                    >
-                                        {prioritiesSettingsLoading ? 'Salvando...' : 'Salvar'}
-                                    </button>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                ) : null}
-
-                {executionVideoModalOpen && executionVideoModalUrl ? (
-                    <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => { setExecutionVideoModalOpen(false); setExecutionVideoModalUrl(''); }}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="font-black text-white">Vídeo de execução</div>
-                                <button
-                                    type="button"
-                                    onClick={() => { setExecutionVideoModalOpen(false); setExecutionVideoModalUrl(''); }}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4">
-                                <video src={executionVideoModalUrl} controls className="w-full rounded-xl bg-black" />
-                            </div>
-                        </div>
-                    </div>
-                ) : null}
-
-                {editingTemplate && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setEditingTemplate(null)}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Editar Treino</h3>
-                                <button onClick={() => setEditingTemplate(null)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 max-h-[75vh] overflow-y-auto">
-                                <AdminWorkoutEditor
-                                    initialData={editingTemplate}
-                                    onSave={async (data) => {
-                                        try {
-                                            const res = await updateWorkout(editingTemplate.id, data);
-                                            const sync = res?.sync || null;
-                                            const { data: refreshed } = await supabase
-                                                .from('workouts')
-                                                .select('*, exercises(*, sets(*))')
-                                                .or(`created_by.eq.${user.id},user_id.eq.${user.id}`)
-                                                .order('name');
-                                            setTemplates(refreshed || []);
-                                            setEditingTemplate(null);
-                                            if (sync) {
-                                                const created = Number(sync?.created || 0);
-                                                const updated = Number(sync?.updated || 0);
-                                                const failed = Number(sync?.failed || 0);
-                                                const msg = sync?.error
-                                                    ? `Treino salvo. Sincronização falhou: ${String(sync.error)}`
-                                                    : `Treino salvo. Sincronizados: ${updated} atualizado(s), ${created} criado(s)${failed ? `, ${failed} falha(s)` : ''}.`;
-                                                await alert(msg, 'Sucesso');
-                                            } else {
-                                                await alert('Treino salvo com sucesso!', 'Sucesso');
-                                            }
-                                        } catch (e) { await alert('Erro ao salvar: ' + (e?.message ?? String(e))); }
-                                    }}
-                                    onCancel={() => setEditingTemplate(null)}
-                                />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {historyOpen && selectedStudent && (
-                    <div className="fixed inset-0 z-[1500] bg-neutral-900 overflow-y-auto">
-                        <HistoryList
-                            user={user}
-                            targetId={selectedStudent?.user_id || selectedStudent?.id}
-                            targetEmail={selectedStudent?.email || ''}
-                            readOnly
-                            title={`Histórico - ${selectedStudent?.name || selectedStudent?.email || 'Aluno'}`}
-                            onBack={() => setHistoryOpen(false)}
-                        />
-                    </div>
-                )}
-
-                {editingStudentWorkout && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setEditingStudentWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Editar Treino do Aluno</h3>
-                                <button onClick={() => setEditingStudentWorkout(null)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 max-h-[75vh] overflow-y-auto">
-                                <AdminWorkoutEditor
-                                    initialData={editingStudentWorkout}
-                                    onSave={async (data) => {
-                                        try {
-                                            const targetUserId = selectedStudent.user_id || '';
-                                            if (!targetUserId) { await alert('Aluno sem conta (user_id).'); return; }
-                                            if (editingStudentWorkout.id) {
-                                                await updateWorkout(editingStudentWorkout.id, data);
-                                            } else {
-                                            const { data: nw } = await supabase
-                                                .from('workouts')
-                                                .insert({ user_id: targetUserId, name: data.title || 'Novo Treino', notes: '', created_by: user.id, is_template: true })
-                                                .select()
-                                                .single();
-                                                const toInsert = (data.exercises || []).map(e => ({
-                                                    workout_id: nw.id,
-                                                    name: e.name || '',
-                                                    sets: getSetsCount(e?.sets) || 4,
-                                                    reps: e.reps ?? '10',
-                                                    rpe: e.rpe ?? 8,
-                                                    cadence: e.cadence || '2020',
-                                                    rest_time: e.restTime ?? e.rest_time ?? 60,
-                                                    method: e.method || 'Normal',
-                                                    video_url: e.videoUrl || e.video_url || '',
-                                                    notes: e.notes || ''
-                                                }));
-                                                if (toInsert.length) await supabase.from('exercises').insert(toInsert);
-                                            }
-                const { data: refreshed } = await supabase
-                    .from('workouts')
-                    .select('*, exercises(*, sets(*))')
-                    .eq('user_id', targetUserId)
-                    .eq('is_template', true)
-                    .order('name');
-                const list = refreshed || [];
-                const synced = (list || []).filter(w => (String(w?.created_by || '') === String(user.id)) && (String(w?.user_id || '') === String(targetUserId)));
-                const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-                const others = (list || []).filter(w => !syncedIds.has(w?.id));
-                setStudentWorkouts(others || []);
-                setSyncedWorkouts(synced || []);
-                setEditingStudentWorkout(null);
-            } catch (e) { await alert('Erro ao salvar: ' + (e?.message ?? String(e))); }
-                                    }}
-                                    onCancel={() => setEditingStudentWorkout(null)}
-                                />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {viewWorkout && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setViewWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Treino: {normalizeWorkoutTitle(viewWorkout.name)}</h3>
-                                <button onClick={() => setViewWorkout(null)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 space-y-4 max-h-[75vh] overflow-y-auto">
-                                <div className="space-y-2">
-                                    {(viewWorkout.exercises || []).map((e, i) => (
-                                        <div key={i} className="bg-neutral-800 p-3 rounded-lg border border-neutral-700">
-                                            <div className="font-bold text-white">{e.name}</div>
-                                            <div className="text-xs text-neutral-400">Sets {getSetsCount(e?.sets)} • Reps {e.reps ?? '-'} • RPE {e.rpe ?? '-'} • Rest {e.rest_time ?? e.restTime ?? '-'}s • Cad {e.cadence ?? '-'}</div>
-                                            {e.notes && <div className="text-xs text-neutral-300 mt-1">{e.notes}</div>}
-                                        </div>
-                                    ))}
-                                </div>
-                                <div className="flex gap-2">
-                                    <div className="relative">
-                                        <button onClick={() => setExportOpen(true)} className="px-4 py-2 bg-yellow-500 text-black font-bold rounded-lg inline-flex items-center gap-2">
-                                            <Download size={16}/> Salvar / Exportar
-                                        </button>
-                                    </div>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {exportOpen && viewWorkout && (
-                    <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setExportOpen(false)}>
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Como deseja salvar?</h3>
-                                <button onClick={() => setExportOpen(false)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 space-y-3">
-                                <button onClick={handleExportPdf} className="w-full px-4 py-3 bg-yellow-500 text-black font-bold rounded-xl inline-flex items-center justify-center gap-2">
-                                    <FileText size={18}/> Baixar PDF
-                                </button>
-                                <button onClick={handleExportJson} className="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl inline-flex items-center justify-center gap-2">
-                                    <Download size={18}/> Baixar JSON
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-            </div>
-
-            {showRegisterModal && (
-                <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
-                    <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 shadow-2xl">
-                        <h3 className="font-bold text-white text-xl mb-4 flex items-center gap-2"><UserPlus size={24} className="text-yellow-500"/> Novo Aluno</h3>
-                        <div className="space-y-3">
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Nome Completo</label>
-                                <input value={newStudent.name} onChange={e => setNewStudent({ ...newStudent, name: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Email</label>
-                                <input value={newStudent.email} onChange={e => setNewStudent({ ...newStudent, email: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                        </div>
-                        <div className="flex gap-2 mt-6">
-                            <button onClick={() => setShowRegisterModal(false)} className="flex-1 p-3 bg-neutral-800 text-neutral-400 font-bold rounded-xl hover:bg-neutral-700">Cancelar</button>
-                            <button onClick={handleRegisterStudent} disabled={registering} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 disabled:opacity-50">{registering ? 'Cadastrando...' : 'CADASTRAR'}</button>
-                        </div>
-                    </div>
-                </div>
-            )}
-
-            {showTeacherModal && (
-                <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
-                    <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 shadow-2xl">
-                        <h3 className="font-bold text-white text-xl mb-4 flex items-center gap-2"><UserPlus size={24} className="text-yellow-500"/> Novo Professor</h3>
-                        <div className="space-y-3">
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Nome Completo</label>
-                                <input value={newTeacher.name} onChange={e => setNewTeacher({ ...newTeacher, name: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Email</label>
-                                <input value={newTeacher.email} onChange={e => setNewTeacher({ ...newTeacher, email: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">WhatsApp / Telefone</label>
-                                <input value={newTeacher.phone} onChange={e => setNewTeacher({ ...newTeacher, phone: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                        </div>
-                        <div className="flex gap-2 mt-6">
-                            <button onClick={() => setShowTeacherModal(false)} className="flex-1 p-3 bg-neutral-800 text-neutral-400 font-bold rounded-xl hover:bg-neutral-700">Cancelar</button>
-                            <button onClick={handleAddTeacher} disabled={addingTeacher} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 disabled:opacity-50">{addingTeacher ? 'Salvando...' : 'ADICIONAR'}</button>
-                        </div>
-                    </div>
-                </div>
-            )}
-
-            {editingTeacher && (
-                <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
-                    <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 shadow-2xl">
-                        <h3 className="font-bold text-white text-xl mb-4 flex items-center gap-2"><Edit3 size={24} className="text-yellow-500"/> Editar Professor</h3>
-                        <div className="space-y-3">
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Nome Completo</label>
-                                <input value={editingTeacher.name} onChange={e => setEditingTeacher({ ...editingTeacher, name: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Email</label>
-                                <input value={editingTeacher.email} onChange={e => setEditingTeacher({ ...editingTeacher, email: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">WhatsApp / Telefone</label>
-                                <input value={editingTeacher.phone || ''} onChange={e => setEditingTeacher({ ...editingTeacher, phone: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Data de Nascimento</label>
-                                <input type="date" value={editingTeacher.birth_date || ''} onChange={e => setEditingTeacher({ ...editingTeacher, birth_date: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                        </div>
-                        <div className="flex gap-2 mt-6">
-                            <button onClick={() => setEditingTeacher(null)} className="flex-1 p-3 bg-neutral-800 text-neutral-400 font-bold rounded-xl hover:bg-neutral-700">Cancelar</button>
-                            <button onClick={handleUpdateTeacher} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400">SALVAR</button>
-                        </div>
-                    </div>
-                </div>
-            )}
-        </div>
-    );
-};
-
-export default AdminPanelV2;
diff --git a/_archive/duplicates/src/components/ExerciseEditor 2.js b/_archive/duplicates/src/components/ExerciseEditor 2.js
deleted file mode 100644
index 5730e8d..0000000
--- a/_archive/duplicates/src/components/ExerciseEditor 2.js	
+++ /dev/null
@@ -1,1479 +0,0 @@
-import React from 'react';
-import { Trash2, Plus, ArrowLeft, Save, Upload, Link2, Play, X, Image as ImageIcon } from 'lucide-react';
-import { useDialog } from '@/contexts/DialogContext';
-import { createClient } from '@/utils/supabase/client';
-import { normalizeWorkoutTitle } from '@/utils/workoutTitle';
-import { resolveCanonicalExerciseName } from '@/utils/exerciseCanonical';
-import { parseExerciseNotesToSetOverrides } from '@/utils/training/notesMethodParser';
-
-const REST_PAUSE_DEFAULT_PAUSE_SEC = 20;
-const DEFAULT_CARDIO_OPTION = 'Esteira';
-
-const ExerciseEditor = ({ workout, onSave, onCancel, onChange, onSaved }) => {
-	const { confirm, alert, closeDialog, showLoading } = useDialog();
-    const [saving, setSaving] = React.useState(false);
-    const [scannerLoading, setScannerLoading] = React.useState(false);
-    const [scannerError, setScannerError] = React.useState('');
-
-    const fileInputRef = React.useRef(null);
-    const scannerFileInputRef = React.useRef(null);
-
-    const normalizeMethod = React.useCallback((method) => {
-        const raw = String(method || '').trim();
-        const lower = raw.toLowerCase();
-        if (!raw) return 'Normal';
-        if (lower === 'warm-up' || lower === 'warm_up' || lower === 'warmup') return 'Normal';
-        if (lower === 'drop-set' || lower === 'drop set' || lower === 'dropset') return 'Drop-set';
-        if (lower === 'rest-pause' || lower === 'rest pause' || lower === 'restpause') return 'Rest-Pause';
-        if (lower === 'bi-set' || lower === 'bi set' || lower === 'biset') return 'Bi-Set';
-        if (lower === 'cluster' || lower === 'cluster set' || lower === 'clusterset') return 'Cluster';
-        if (lower === 'cardio') return 'Cardio';
-        return raw;
-    }, []);
-
-    const buildDefaultSetDetail = React.useCallback((exercise, setNumber) => {
-        const reps = (exercise?.reps ?? '')
-        const rpeNum = Number(exercise?.rpe)
-        return {
-            set_number: setNumber,
-            reps: reps === '' ? null : String(reps),
-            rpe: Number.isFinite(rpeNum) ? rpeNum : null,
-            weight: null,
-            is_warmup: false,
-            advanced_config: null
-        };
-    }, []);
-
-    const ensureSetDetails = React.useCallback((exercise, desiredCount) => {
-        const existing = Array.isArray(exercise?.setDetails) ? exercise.setDetails : [];
-        const next = [];
-        for (let i = 0; i < desiredCount; i++) {
-            const setNumber = i + 1;
-            const current = existing[i];
-            next.push({
-                ...buildDefaultSetDetail(exercise, setNumber),
-                ...(current && typeof current === 'object' ? current : null),
-                set_number: (current?.set_number ?? setNumber)
-            });
-        }
-        return next;
-    }, [buildDefaultSetDetail]);
-
-	React.useEffect(() => {
-		if (!Array.isArray(workout?.exercises)) return;
-		const validExercises = workout.exercises.filter(e => e && typeof e === 'object');
-		if (validExercises.length !== workout.exercises.length) {
-			onChange?.({ ...workout, exercises: validExercises });
-		}
-    }, [workout, onChange]);
-    React.useEffect(() => {
-        if (!Array.isArray(workout?.exercises)) return;
-        let changed = false;
-        const nextExercises = workout.exercises.map((ex) => {
-            if (!ex || typeof ex !== 'object') return ex;
-
-            const existingDetailsRaw = Array.isArray(ex?.setDetails) ? ex.setDetails : [];
-            const setsFromField = Math.max(0, parseInt(ex?.sets) || 0);
-            const setsFromDetails = Array.isArray(existingDetailsRaw) ? existingDetailsRaw.length : 0;
-            const desiredCount = Math.max(setsFromField, setsFromDetails);
-            if (!desiredCount) return ex;
-
-            const nextDetails = ensureSetDetails(ex, desiredCount);
-            let next = ex;
-
-            if (setsFromField !== desiredCount || ex?.sets === '' || ex?.sets == null) {
-                next = { ...next, sets: desiredCount };
-                changed = true;
-            }
-
-            const detailsString = JSON.stringify(existingDetailsRaw || []);
-            const nextDetailsString = JSON.stringify(nextDetails || []);
-            if (detailsString !== nextDetailsString) {
-                next = { ...next, setDetails: nextDetails };
-                changed = true;
-            }
-
-            const method = normalizeMethod(next?.method);
-            if (method !== 'Rest-Pause') return next;
-
-            const findRpConfig = () => {
-                for (const s of nextDetails) {
-                    const cfg = s?.advanced_config ?? s?.advancedConfig ?? null;
-                    if (!cfg || typeof cfg !== 'object' || Array.isArray(cfg)) continue;
-                    const hasAny =
-                        Object.prototype.hasOwnProperty.call(cfg, 'initial_reps') ||
-                        Object.prototype.hasOwnProperty.call(cfg, 'mini_sets') ||
-                        Object.prototype.hasOwnProperty.call(cfg, 'rest_time_sec');
-                    if (hasAny) return cfg;
-                }
-                return null;
-            };
-
-            const template = findRpConfig();
-            const repsNum = Number.parseInt(String(next?.reps ?? ''), 10);
-            const fallbackTemplate = {
-                initial_reps: Number.isFinite(repsNum) ? repsNum : null,
-                mini_sets: null,
-                rest_time_sec: REST_PAUSE_DEFAULT_PAUSE_SEC,
-            };
-
-            const rp = template || fallbackTemplate;
-
-            const propagated = nextDetails.map((s) => {
-                const cfg = s?.advanced_config ?? s?.advancedConfig ?? null;
-                const baseCfg = cfg && typeof cfg === 'object' && !Array.isArray(cfg) ? cfg : {};
-                const nextCfg = {
-                    ...baseCfg,
-                    initial_reps: baseCfg?.initial_reps ?? rp.initial_reps,
-                    mini_sets: baseCfg?.mini_sets ?? rp.mini_sets,
-                    rest_time_sec: baseCfg?.rest_time_sec ?? rp.rest_time_sec,
-                };
-                return { ...s, advanced_config: nextCfg };
-            });
-
-            const propagatedString = JSON.stringify(propagated || []);
-            if (propagatedString !== nextDetailsString) {
-                next = { ...next, setDetails: propagated };
-                changed = true;
-            }
-
-            return next;
-        });
-
-        if (!changed) return;
-        onChange?.({ ...workout, exercises: nextExercises });
-    }, [ensureSetDetails, normalizeMethod, workout, onChange]);
-	if (!workout) return null;
-
-
-    const detectRestPauseConfig = (name, reps, notes) => {
-        const text = `${String(name || '')} ${String(reps || '')} ${String(notes || '')}`.toLowerCase();
-        const hasRestPause = text.includes('rest-pause') || text.includes('rest pause') || text.includes('restpause');
-        if (!hasRestPause) return null;
-
-        const source = String(reps || notes || '');
-
-        const plusPattern = /(\d+)\s*\+\s*(\d+)(?:\s*\+\s*(\d+))*/i;
-        const plusMatch = source.match(plusPattern);
-        if (plusMatch) {
-            const numbers = plusMatch[0]
-                .split('+')
-                .map((part) => parseInt(part.trim(), 10))
-                .filter((n) => Number.isFinite(n) && n > 0);
-            if (numbers.length) {
-                const initialReps = numbers[0];
-                const miniSets = Math.max(0, numbers.length - 1);
-                const cleanedNotes = String(notes || '')
-                    .replace(plusMatch[0], `rest-pause ${numbers.join('+')}`)
-                    .trim();
-
-                return {
-                    method: 'Rest-Pause',
-                    normalizedReps: String(reps || initialReps).trim() || String(initialReps),
-                    cleanedNotes,
-                    config: {
-                        initial_reps: initialReps,
-                        mini_sets: miniSets || null,
-                        rest_time_sec: REST_PAUSE_DEFAULT_PAUSE_SEC
-                    }
-                };
-            }
-        }
-
-        const rangePattern = /(\d+)\s*(?:a|-|to)\s*(\d+)/i;
-        const rangeMatch = source.match(rangePattern);
-        if (rangeMatch) {
-            const first = parseInt(rangeMatch[1], 10);
-            const second = parseInt(rangeMatch[2], 10);
-            const low = Number.isFinite(first) ? first : second;
-            const high = Number.isFinite(second) ? second : first;
-            const initialReps = Number.isFinite(high) ? high : low;
-            const normalizedReps = `${low}-${high}`;
-            const cleanedNotes = String(notes || '')
-                .replace(/rest[- ]?pause/gi, '')
-                .trim();
-
-            return {
-                method: 'Rest-Pause',
-                normalizedReps,
-                cleanedNotes,
-                config: {
-                    initial_reps: initialReps,
-                    mini_sets: 2,
-                    rest_time_sec: REST_PAUSE_DEFAULT_PAUSE_SEC
-                }
-            };
-        }
-
-        return {
-            method: 'Rest-Pause',
-            normalizedReps: String(reps || '').trim() || '10',
-            cleanedNotes: String(notes || '').trim(),
-            config: {
-                initial_reps: null,
-                mini_sets: null,
-                rest_time_sec: REST_PAUSE_DEFAULT_PAUSE_SEC
-            }
-        };
-    };
-
-    const extractRepsTargets = (primaryReps, notes) => {
-        const normalize = (value) => {
-            const raw = String(value || '').trim();
-            if (!raw) return '';
-            const rangePattern = /(\d+)\s*(?:a|-|to)\s*(\d+)/i;
-            const rangeMatch = raw.match(rangePattern);
-            if (rangeMatch) {
-                const first = parseInt(rangeMatch[1], 10);
-                const second = parseInt(rangeMatch[2], 10);
-                if (Number.isFinite(first) && Number.isFinite(second)) return `${first}-${second}`;
-            }
-            const numMatch = raw.match(/\d+/);
-            if (numMatch) return numMatch[0];
-            return raw;
-        };
-
-        const targets = [];
-        const normalizedPrimary = normalize(primaryReps);
-        if (normalizedPrimary) targets.push(normalizedPrimary);
-
-        const text = String(notes || '');
-        const parts = text
-            .split(/\n|,|;|\|/)
-            .map((p) => String(p || '').trim())
-            .filter((p) => p.length > 0);
-
-        for (let i = 0; i < parts.length; i += 1) {
-            const part = parts[i];
-            const normalized = normalize(part);
-            if (!normalized) continue;
-            const prev = targets[targets.length - 1];
-            if (prev === normalized) continue;
-            targets.push(normalized);
-        }
-
-        return targets;
-    };
-
-    const updateSetDetail = (exerciseIndex, setIndex, patch) => {
-        const newExercises = [...(workout.exercises || [])];
-        const ex = newExercises[exerciseIndex] || {};
-        const setsCount = Math.max(0, parseInt(ex?.sets) || 0);
-        const setDetails = ensureSetDetails(ex, setsCount);
-        const current = setDetails[setIndex] || buildDefaultSetDetail(ex, setIndex + 1);
-        const next = { ...current, ...patch };
-        setDetails[setIndex] = next;
-
-        if (Object.prototype.hasOwnProperty.call(patch || {}, 'is_warmup')) {
-            if (setIndex !== 0 && next.is_warmup) {
-                setDetails[setIndex] = { ...next, is_warmup: false };
-            }
-            if (setIndex === 0 && next.is_warmup) {
-                for (let i = 1; i < setDetails.length; i += 1) {
-                    const other = setDetails[i] || buildDefaultSetDetail(ex, i + 1);
-                    setDetails[i] = { ...other, is_warmup: false };
-                }
-            }
-        }
-        newExercises[exerciseIndex] = { ...ex, setDetails };
-        onChange?.({ ...workout, exercises: newExercises });
-    };
-
-	const updateExercise = (index, field, value) => {
-		const newExercises = [...(workout.exercises || [])];
-		if (field === 'duplicate') {
-			newExercises.splice(index + 1, 0, { ...newExercises[index] });
-			} else {
-				const ex = newExercises[index] || {};
-				if (field === 'sets') {
-					const nextCount = Math.max(0, parseInt(value) || 0);
-					const nextDetails = ensureSetDetails(ex, nextCount);
-					newExercises[index] = { ...ex, sets: value, setDetails: nextDetails };
-				} else if (field === 'method') {
-				const prevMethod = normalizeMethod(ex?.method);
-				const nextMethod = normalizeMethod(value);
-				const currentCount = Math.max(0, parseInt(ex?.sets) || 0);
-				const nextIsSpecial =
-					nextMethod === 'Drop-set' ||
-					nextMethod === 'Rest-Pause' ||
-					nextMethod === 'Cluster';
-				const prevIsSpecial =
-					prevMethod === 'Drop-set' ||
-					prevMethod === 'Rest-Pause' ||
-					prevMethod === 'Cluster';
-				const setsCount = nextIsSpecial ? Math.max(1, currentCount || 1) : (currentCount || 4);
-				const switchingBetweenSpecial = prevIsSpecial && nextIsSpecial && prevMethod !== nextMethod;
-				const shouldResetConfig =
-					nextMethod === 'Normal' ||
-					nextMethod === 'Bi-Set' ||
-					nextMethod === 'Cardio' ||
-					switchingBetweenSpecial;
-				const baseDetails = ensureSetDetails({ ...ex, method: nextMethod }, setsCount);
-				const nextDetails = shouldResetConfig
-					? baseDetails.map((s) => ({
-							...s,
-							advanced_config: null
-					  }))
-					: baseDetails;
-				const currentRestTime = ex?.restTime ?? ex?.rest_time ?? null;
-				const currentRestTimeNum = currentRestTime === '' ? NaN : Number(currentRestTime);
-				const shouldSuggestRestZero = nextMethod === 'Bi-Set' && (!Number.isFinite(currentRestTimeNum) || currentRestTimeNum === 60);
-				newExercises[index] = {
-					...ex,
-					method: nextMethod,
-					restTime: shouldSuggestRestZero ? 0 : (ex?.restTime ?? ex?.rest_time ?? null),
-					sets: setsCount,
-					setDetails: nextDetails
-				};
-			} else if (field === 'reps' || field === 'rpe') {
-                const prevValue = ex[field];
-                const nextValue = value;
-                const setsCount = Math.max(0, parseInt(ex?.sets) || 0);
-                const existingDetails = ensureSetDetails(ex, setsCount);
-                const updatedDetails = existingDetails.map((s) => {
-                    if (field === 'reps') {
-                        const currentReps = s?.reps;
-                        if (currentReps == null || currentReps === '' || currentReps === prevValue) {
-                            return { ...s, reps: nextValue };
-                        }
-                    }
-                    if (field === 'rpe') {
-                        const currentRpe = s?.rpe;
-                        if (currentRpe == null || currentRpe === '' || String(currentRpe) === String(prevValue)) {
-                            return { ...s, rpe: nextValue === '' ? null : Number(nextValue) };
-                        }
-                    }
-                    return s;
-                });
-                newExercises[index] = { ...ex, [field]: value, setDetails: updatedDetails };
-            } else if (field === 'notes') {
-                const setsCount = Math.max(0, parseInt(ex?.sets) || 0);
-                const existingDetails = ensureSetDetails(ex, setsCount);
-                const parsed = parseExerciseNotesToSetOverrides({ notes: value, setsCount });
-                const overrides = Array.isArray(parsed?.overrides) ? parsed.overrides : [];
-                const hash = String(parsed?.hash || '').trim();
-
-                const updatedDetails = existingDetails.map((sd, setIdx) => {
-                    const current = sd && typeof sd === 'object' ? sd : buildDefaultSetDetail(ex, setIdx + 1);
-                    const auto = current?.it_auto && typeof current.it_auto === 'object' ? current.it_auto : null;
-                    const isAuto = String(auto?.source || '') === 'notes';
-                    const override = overrides?.[setIdx] && typeof overrides[setIdx] === 'object' ? overrides[setIdx] : null;
-
-                    if (!override) {
-                        if (!isAuto) return current;
-                        return { ...current, it_auto: null, advanced_config: null };
-                    }
-
-                    const canOverwrite = isAuto || current?.advanced_config == null;
-                    if (!canOverwrite) return current;
-
-                    const nextAuto = {
-                        source: 'notes',
-                        kind: String(override.kind || ''),
-                        label: String(override.label || ''),
-                        hash,
-                    };
-
-                    const next = {
-                        ...current,
-                        it_auto: nextAuto,
-                        advanced_config: override.advanced_config ?? null,
-                    };
-
-                    const plannedReps = String(override.plannedReps || '').trim();
-                    if (plannedReps) {
-                        const existingReps = current?.reps == null ? '' : String(current.reps).trim();
-                        if (!existingReps || isAuto) next.reps = plannedReps;
-                    }
-
-                    return next;
-                });
-
-                newExercises[index] = { ...ex, notes: value, setDetails: updatedDetails };
-            } else {
-                newExercises[index] = { ...ex, [field]: value };
-            }
-        }
-        onChange?.({ ...workout, exercises: newExercises });
-    };
-
-    const removeExercise = async (index) => {
-        if (await confirm('Tem certeza que deseja remover este exercício?', 'Remover Exercício')) {
-            const newExercises = [...(workout.exercises || [])];
-            newExercises.splice(index, 1);
-            onChange?.({ ...workout, exercises: newExercises });
-        }
-    };
-
-    const handleCancel = async () => {
-        if (await confirm('Deseja mesmo cancelar?', 'Cancelar Edição')) {
-            onCancel?.();
-        }
-    };
-
-    const CARDIO_OPTIONS = ['Escada', 'Esteira', 'Bicicleta', 'Bike Outdoor', 'Corrida', 'Caminhada', 'Elíptico'];
-
-    const getExerciseType = (ex) => {
-        if (ex.type) return ex.type;
-        return ex.method === 'Cardio' ? 'cardio' : 'strength';
-    };
-
-    const detectCardioFromScanner = (name, reps, notes) => {
-        const rawName = String(name || '').trim();
-        const text = `${rawName} ${String(reps || '')} ${String(notes || '')}`.toLowerCase();
-
-        const looksLikeCardio =
-            text.includes('cardio') ||
-            text.includes('min') ||
-            text.includes('minuto') ||
-            text.includes('esteira') ||
-            text.includes('treadmill') ||
-            text.includes('bike') ||
-            text.includes('bici') ||
-            text.includes('bicicleta') ||
-            text.includes('spinning') ||
-            text.includes('escada') ||
-            text.includes('corrida') ||
-            text.includes('caminhada') ||
-            text.includes('eliptico') ||
-            text.includes('elíptico');
-
-        if (!looksLikeCardio) return null;
-
-        let modality = '';
-        const isOutdoor = text.includes('out') || text.includes('rua') || text.includes('extern') || text.includes('outdoor');
-        const isBike = text.includes('bicicleta') || text.includes('bike') || text.includes('bici') || text.includes('spinning') || text.includes('cicl') || text.includes('pedal');
-        if (isBike && isOutdoor) {
-            modality = 'Bike Outdoor';
-        } else if (isBike) {
-            modality = 'Bicicleta';
-        } else if (text.includes('esteira') || text.includes('treadmill')) {
-            modality = 'Esteira';
-        } else if (text.includes('escada')) {
-            modality = 'Escada';
-        } else if (text.includes('corrida')) {
-            modality = 'Corrida';
-        } else if (text.includes('caminhada')) {
-            modality = 'Caminhada';
-        } else if (text.includes('eliptico') || text.includes('elíptico')) {
-            modality = 'Elíptico';
-        }
-
-        const nameIsKnownCardio = CARDIO_OPTIONS.includes(rawName);
-        const resolvedModality = nameIsKnownCardio
-            ? rawName
-            : (CARDIO_OPTIONS.includes(modality) ? modality : DEFAULT_CARDIO_OPTION);
-
-        const minutesMatch = text.match(/(\d+)\s*(?:min|mins|minuto|minutos)/i) || text.match(/\b(\d+)\b/);
-        const minutes = minutesMatch ? parseInt(minutesMatch[1], 10) : NaN;
-        const resolvedMinutes = Number.isFinite(minutes) && minutes > 0 ? minutes : 20;
-
-        return {
-            modality: resolvedModality,
-            minutes: resolvedMinutes
-        };
-    };
-
-    const handleScannerFileClick = () => {
-        if (scannerLoading) return;
-        if (scannerFileInputRef.current) {
-            scannerFileInputRef.current.click();
-        }
-    };
-
-    const handleScannerFileChange = async (e) => {
-        try {
-            setScannerError('');
-            const files = e?.target?.files;
-            if (!files || files.length === 0) return;
-
-            const selectedFiles = Array.from(files).filter((f) => !!f);
-            if (selectedFiles.length === 0) return;
-
-            setScannerLoading(true);
-
-            const allRawExercises = [];
-            let detectedTitle = '';
-
-            for (let i = 0; i < selectedFiles.length; i += 1) {
-                const file = selectedFiles[i];
-                const formData = new FormData();
-                formData.append('file', file);
-
-                const res = await fetch('/api/iron-scanner', {
-                    method: 'POST',
-                    body: formData
-                });
-
-                const json = await res.json().catch(() => ({ ok: false, error: 'Resposta inválida do servidor' }));
-                if (!res.ok || !json?.ok) {
-                    const msg = json?.error || 'Não conseguimos ler o treino. Tente uma foto mais nítida.';
-                    setScannerError(msg);
-                    await alert(msg, 'Falha na importação');
-                    return;
-                }
-
-                const titleCandidate = String(json?.workoutTitle ?? '').trim();
-                if (!detectedTitle && titleCandidate) detectedTitle = titleCandidate;
-                const list = Array.isArray(json.exercises) ? json.exercises : [];
-                if (list.length === 0) {
-                    const msg = 'Não encontramos exercícios válidos em uma das imagens.';
-                    setScannerError(msg);
-                    await alert(msg, 'Sem exercícios detectados');
-                    return;
-                }
-
-                allRawExercises.push(...list);
-            }
-
-            if (allRawExercises.length === 0) {
-                const msg = 'Não encontramos exercícios válidos nas imagens selecionadas.';
-                setScannerError(msg);
-                await alert(msg, 'Sem exercícios válidos');
-                return;
-            }
-
-            const mappedExercises = allRawExercises
-                .map((item) => {
-                    const rawName = String(item?.name || '').trim();
-                    const canonical = resolveCanonicalExerciseName(rawName);
-                    const name = String(canonical?.canonical || rawName).trim();
-                    const setsRaw = item?.sets;
-                    const setsNum = typeof setsRaw === 'number' ? setsRaw : parseInt(String(setsRaw || '0')) || 0;
-                    const repsRaw = String(item?.reps ?? '').trim();
-                    const notesRaw = String(item?.notes ?? '').trim();
-                    const baseSets = Number.isFinite(setsNum) && setsNum > 0 ? setsNum : 4;
-
-                    const cardioInfo = detectCardioFromScanner(name, repsRaw, notesRaw);
-                    if (cardioInfo) {
-                        const minutesStr = String(cardioInfo.minutes);
-                        const exercise = {
-                            name: cardioInfo.modality,
-                            type: 'cardio',
-                            method: 'Cardio',
-                            sets: 1,
-                            reps: minutesStr,
-                            rpe: '5',
-                            cadence: '',
-                            restTime: 0,
-                            videoUrl: '',
-                            notes: notesRaw
-                        };
-                        const setDetails = ensureSetDetails(exercise, 1);
-                        setDetails[0] = { ...(setDetails[0] || buildDefaultSetDetail(exercise, 1)), reps: minutesStr };
-                        return { ...exercise, setDetails };
-                    }
-
-                    const restPauseInfo = detectRestPauseConfig(name, repsRaw, notesRaw);
-                    const method = restPauseInfo?.method || 'Normal';
-                    const reps = restPauseInfo?.normalizedReps || repsRaw || '10';
-                    const notes = restPauseInfo?.cleanedNotes ?? notesRaw;
-
-                    const exercise = {
-                        name,
-                        sets: baseSets,
-                        reps,
-                        rpe: '8',
-                        cadence: '2020',
-                        restTime: 60,
-                        method,
-                        videoUrl: '',
-                        notes
-                    };
-
-                    const setDetails = ensureSetDetails(exercise, baseSets);
-
-                    const repsTargets = extractRepsTargets(reps, notesRaw);
-                    for (let i = 0; i < setDetails.length; i += 1) {
-                        const target = repsTargets[i];
-                        if (!target) continue;
-                        const current = setDetails[i] || buildDefaultSetDetail(exercise, i + 1);
-                        setDetails[i] = { ...current, reps: target };
-                    }
-
-                    if (method === 'Rest-Pause' && restPauseInfo?.config && setDetails.length > 0) {
-                        const lastIndex = setDetails.length - 1;
-                        const last = setDetails[lastIndex] || buildDefaultSetDetail(exercise, lastIndex + 1);
-                        setDetails[lastIndex] = {
-                            ...last,
-                            advanced_config: {
-                                ...(last.advanced_config && typeof last.advanced_config === 'object' ? last.advanced_config : {}),
-                                ...restPauseInfo.config
-                            }
-                        };
-                    }
-
-                    return {
-                        ...exercise,
-                        setDetails
-                    };
-                })
-                .filter((ex) => String(ex.name || '').trim().length > 0);
-
-            if (!mappedExercises.length) {
-                const msg = 'Não encontramos exercícios utilizáveis nas imagens.';
-                setScannerError(msg);
-                await alert(msg, 'Sem exercícios válidos');
-                return;
-            }
-
-            let titleToApply = '';
-            if (detectedTitle) {
-                try {
-                    const ok = await confirm(`Definir título como "${detectedTitle}"?`, 'Scanner');
-                    if (ok) titleToApply = detectedTitle;
-                } catch {}
-            }
-
-            try {
-                const preview = mappedExercises.slice(0, 10).map((x) => `• ${String(x?.name || '').trim()}`).join('\n');
-                const ok = await confirm(
-                    `Importar ${mappedExercises.length} exercício(s)?\n\n${preview}${mappedExercises.length > 10 ? '\n…' : ''}`,
-                    'Scanner'
-                );
-                if (!ok) return;
-            } catch {}
-
-            const nextWorkout = {
-                ...(workout || {}),
-                ...(titleToApply ? { title: titleToApply } : {}),
-                exercises: mappedExercises
-            };
-
-            onChange?.(nextWorkout);
-            await alert('Treino importado pela IA. Revise antes de salvar.', 'Importação concluída');
-        } catch (err) {
-            const msg = err?.message ? String(err.message) : String(err);
-            const friendly = msg || 'Não conseguimos ler o treino. Tente uma foto mais nítida.';
-            setScannerError(friendly);
-            await alert(friendly, 'Erro na importação');
-        } finally {
-            setScannerLoading(false);
-            if (e?.target) {
-                e.target.value = '';
-            }
-        }
-    };
-
-    const toggleExerciseType = (index, currentType) => {
-        const newType = currentType === 'strength' ? 'cardio' : 'strength';
-        const newExercises = [...(workout.exercises || [])];
-        const ex = newExercises[index];
-
-        if (newType === 'cardio') {
-            newExercises[index] = {
-                ...ex,
-                type: 'cardio',
-                method: 'Cardio',
-                sets: 1,
-                name: CARDIO_OPTIONS.includes(ex.name) ? ex.name : DEFAULT_CARDIO_OPTION,
-                reps: ex.reps || '20',
-                rpe: ex.rpe || 5
-            };
-        } else {
-            newExercises[index] = {
-                ...ex,
-                type: 'strength',
-                method: 'Normal',
-                sets: 4,
-                name: '',
-                reps: '10',
-                rpe: 8
-            };
-        }
-        onChange?.({ ...workout, exercises: newExercises });
-    };
-
-    const toggleBiSetWithNext = async (index) => {
-        try {
-            const list = Array.isArray(workout?.exercises) ? workout.exercises : [];
-            const current = list[index];
-            const next = list[index + 1];
-            if (!current || !next) return;
-
-            const currentType = getExerciseType(current);
-            const nextType = getExerciseType(next);
-            if (currentType === 'cardio' || nextType === 'cardio') {
-                await alert('Bi-set só pode ser usado entre exercícios de força.', 'Atenção');
-                return;
-            }
-
-            const currentMethod = normalizeMethod(current?.method);
-            if (currentMethod === 'Bi-Set') {
-                updateExercise(index, 'method', 'Normal');
-                return;
-            }
-
-            const allowedMethods = new Set(['Normal', 'Bi-Set']);
-            if (!allowedMethods.has(currentMethod)) {
-                const ok = await confirm('Isso vai trocar o método para Bi-Set. Continuar?', 'Linkar com Próximo');
-                if (!ok) return;
-            }
-
-            updateExercise(index, 'method', 'Bi-Set');
-        } catch (e) {
-            await alert('Não foi possível atualizar o link. ' + (e?.message ?? String(e)), 'Erro');
-        }
-    };
-
-    const addExercise = () => {
-        onChange?.({
-            ...workout,
-            exercises: [
-                ...(workout.exercises || []),
-                {
-                    name: '',
-                    sets: 4,
-                    reps: '10',
-                    rpe: '8',
-                    cadence: '2020',
-                    restTime: 60,
-                    method: 'Normal',
-                    videoUrl: '',
-                    notes: ''
-                }
-            ]
-        });
-    };
-
-    const handleImportJsonClick = () => fileInputRef.current?.click();
-    const handleImportJson = async (e) => {
-        const file = e.target.files?.[0];
-        if (!file) return;
-        try {
-            const text = await file.text();
-            const raw = JSON.parse(text);
-            const src = raw.workout || raw.session || raw;
-            const title = src.title || src.workoutTitle || workout.title || 'Treino Importado';
-            const exs = Array.isArray(src.exercises) ? src.exercises : [];
-            const mapped = exs.map(ex => ({
-                name: ex.name || '',
-                sets: Number(ex.sets) || (Array.isArray(ex?.setDetails) ? ex.setDetails.length : (Array.isArray(ex?.set_details) ? ex.set_details.length : (Array.isArray(ex?.sets) && ex.sets.length && typeof ex.sets[0] === 'object' ? ex.sets.length : 0))),
-                reps: String(ex.reps || ''),
-                rpe: Number(ex.rpe || ex.intensity || 8),
-                cadence: ex.cadence || '2020',
-                restTime: Number(ex.restTime || ex.rest_time || 0),
-                method: normalizeMethod(ex.method || 'Normal'),
-                videoUrl: ex.videoUrl || ex.video_url || '',
-                notes: ex.notes || '',
-                setDetails: Array.isArray(ex?.setDetails)
-                    ? ex.setDetails
-                    : (Array.isArray(ex?.set_details)
-                        ? ex.set_details
-                        : (Array.isArray(ex?.sets) && ex.sets.length && typeof ex.sets[0] === 'object' ? ex.sets : []))
-            }));
-            const imported = { title, exercises: mapped };
-            onChange?.(imported);
-            if (await confirm('Importar e salvar este treino agora?', 'Salvar')) {
-                const res = await onSave?.(imported);
-                if (res && typeof res === 'object' && res.ok === false) {
-                    await alert(`Erro ao salvar: ${res.error || 'Falha ao salvar treino'}`);
-                }
-            }
-        } catch (err) {
-            const msg = (err && typeof err === 'object' && 'message' in err) ? err.message : String(err || '');
-            await alert(`Falha ao importar JSON${msg ? `: ${msg}` : ''}`, 'Erro');
-        } finally {
-            e.target.value = '';
-        }
-    };
-
-    const handleSave = async () => {
-        if (!workout.title || !workout.title.trim()) {
-            return await alert("Dê um nome ao treino!", "Atenção");
-        }
-
-		setSaving(true);
-		if (typeof showLoading === 'function') {
-			showLoading('Seu treino está sendo salvo. Aguarde...', 'Salvando');
-		}
-	try {
-            const supabase = createClient();
-            const { data: { user } } = await supabase.auth.getUser();
-            
-            if (!user) {
-                await alert("Usuário não logado. O treino não será salvo sem dono.", "Erro");
-                return;
-            }
-
-			if (onSave) {
-				 const res = await onSave({ ...workout, created_by: user.id, user_id: user.id });
-                 if (res && typeof res === 'object' && res.ok === false) {
-                    await alert(`Erro ao salvar: ${res.error || 'Falha ao salvar treino'}`);
-                    return;
-                 }
-                 if (res && typeof res === 'object' && res.deferred === true) {
-                    await alert('Exercício adicionado ao treino ativo.\nAo finalizar o treino, você poderá escolher se deseja salvar essa mudança no modelo.', 'Exercício adicionado');
-                    if (typeof onSaved === 'function') onSaved();
-                    return;
-                 }
-				 const sync = res?.sync || null;
-				 if (sync) {
-					const created = Number(sync?.created || 0);
-					const updated = Number(sync?.updated || 0);
-					const failed = Number(sync?.failed || 0);
-					const extra = sync?.error
-						? `\n\nSincronização: falhou (${String(sync.error)})`
-						: `\n\nSincronização: ${updated} atualizado(s), ${created} criado(s)${failed ? `, ${failed} falha(s)` : ''}`;
-					await alert("Treino Salvo com Sucesso!" + extra, "Sucesso");
-					if (typeof onSaved === 'function') onSaved();
-					return;
-				 }
-			} else {
-                 const exercisesPayload = (workout.exercises || []).map((ex, idx) => {
-                    const setDetails = Array.isArray(ex?.setDetails)
-                        ? ex.setDetails
-                        : (Array.isArray(ex?.set_details) ? ex.set_details : null);
-                    const headerSets = Number.parseInt(ex?.sets, 10) || 0;
-                    const numSets = headerSets || (Array.isArray(setDetails) ? setDetails.length : 0);
-                    const sets = [];
-                    for (let i = 0; i < numSets; i += 1) {
-                        const s = Array.isArray(setDetails) ? (setDetails[i] || null) : null;
-                        sets.push({
-                            weight: s?.weight ?? null,
-                            reps: s?.reps ?? ex?.reps ?? null,
-                            rpe: s?.rpe ?? ex?.rpe ?? null,
-                            set_number: s?.set_number ?? (i + 1),
-                            completed: false,
-                            is_warmup: !!(s?.is_warmup ?? s?.isWarmup),
-                            advanced_config: s?.advanced_config ?? s?.advancedConfig ?? null,
-                        });
-                    }
-                    return {
-                        name: ex?.name || '',
-                        notes: ex?.notes || '',
-                        video_url: ex?.videoUrl || null,
-                        rest_time: ex?.restTime ?? null,
-                        cadence: ex?.cadence ?? null,
-                        method: ex?.method ?? null,
-                        order: idx,
-                        sets
-                    };
-                 });
-
-                 const { data: workoutId, error } = await supabase.rpc('save_workout_atomic', {
-                    p_workout_id: workout.id || null,
-                    p_user_id: user.id,
-                    p_created_by: user.id,
-                    p_is_template: true,
-                    p_name: normalizeWorkoutTitle(workout.title),
-                    p_notes: workout.notes,
-                    p_exercises: exercisesPayload
-                 });
-                 if (error) throw error;
-                 if (!workoutId) throw new Error('Falha ao salvar treino');
-			}
-			
-			await alert("Treino Salvo com Sucesso!", "Sucesso");
-			if (typeof onSaved === 'function') {
-				onSaved();
-			}
-            // window.location.href = '/'; // Removido para evitar reload forçado que causava tela preta
-
-		} catch (e) {
-			const msg = e?.message || String(e || '');
-			await alert("Erro ao salvar: " + msg);
-		} finally {
-			if (typeof closeDialog === 'function') {
-				closeDialog();
-			}
-			setSaving(false);
-		}
-	};
-
-	return (
-		<div className="h-full flex flex-col bg-neutral-900">
-			<div className="px-4 py-2 border-b border-neutral-800 flex items-center justify-between bg-neutral-950 sticky top-0 z-30 pt-safe">
-				<div className="w-full flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between min-h-[48px]">
-					<div className="flex items-center justify-between gap-3 min-w-0">
-						<h2 className="text-base md:text-lg font-bold text-white whitespace-nowrap truncate min-w-0">
-							Editar Treino
-						</h2>
-						<div className="shrink-0 flex items-center gap-2">
-							<button
-								type="button"
-								onClick={handleSave}
-								disabled={saving}
-								className="flex items-center gap-2 px-3 sm:px-4 py-2 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded-full transition-colors text-sm disabled:opacity-70 disabled:cursor-not-allowed min-h-[44px]"
-							>
-								<Save size={18} />
-								<span className="hidden sm:inline">{saving ? 'SALVANDO...' : 'SALVAR'}</span>
-							</button>
-							<button
-								type="button"
-								onClick={() => onCancel?.()}
-								className="h-10 w-10 inline-flex items-center justify-center rounded-full bg-neutral-900 border border-neutral-800 text-neutral-200 hover:bg-neutral-800 transition-colors"
-								title="Fechar"
-							>
-								<X size={16} />
-							</button>
-						</div>
-					</div>
-					<div className="flex items-center gap-2 overflow-x-auto whitespace-nowrap [-ms-overflow-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden">
-						<button
-							onClick={handleScannerFileClick}
-							disabled={scannerLoading}
-							className="shrink-0 flex items-center gap-2 px-3 py-2 text-yellow-400 hover:text-yellow-300 rounded-full hover:bg-yellow-500/10 transition-colors min-h-[44px] disabled:opacity-60 disabled:cursor-not-allowed"
-							title="Importar treino via IA (foto/PDF)"
-						>
-							<ImageIcon size={18} />
-							<span className="text-sm font-bold hidden sm:inline">Importar Treino (Foto/PDF)</span>
-							<span className="text-sm font-bold sm:hidden">Importar</span>
-						</button>
-						<input
-							ref={scannerFileInputRef}
-							type="file"
-							accept="image/*,application/pdf"
-							multiple
-							className="hidden"
-							onChange={handleScannerFileChange}
-						/>
-						<button
-							onClick={handleImportJsonClick}
-							className="shrink-0 flex items-center gap-2 px-3 py-2 text-neutral-300 hover:text-white rounded-full hover:bg-neutral-800 transition-colors min-h-[44px]"
-							title="Carregar JSON"
-						>
-							<Upload size={18} />
-							<span className="text-sm font-bold hidden sm:inline">Carregar JSON</span>
-							<span className="text-sm font-bold sm:hidden">JSON</span>
-						</button>
-						<input ref={fileInputRef} type="file" accept=".json,application/json" className="hidden" onChange={handleImportJson} />
-					</div>
-				</div>
-			</div>
-
-				<div className="flex-1 overflow-y-auto p-4 space-y-6">
-					{scannerLoading && (
-						<div className="mb-3 p-3 rounded-xl border border-yellow-500/40 bg-yellow-500/5 text-yellow-200 text-xs font-semibold">
-							A IA está lendo seu treino...
-						</div>
-					)}
-					{!scannerLoading && scannerError && (
-						<div className="mb-3 p-3 rounded-xl border border-red-500/40 bg-red-900/20 text-red-200 text-xs font-semibold">
-							{scannerError}
-						</div>
-					)}
-                <div>
-                    <div className="flex items-center justify-between mb-2">
-                        <div className="flex items-center gap-3">
-                            <button
-                                onClick={handleCancel}
-                                className="inline-flex items-center gap-2 px-3 py-2 text-neutral-300 hover:text-white rounded-full bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 transition-colors text-xs min-h-[44px]"
-                                title="Voltar"
-                            >
-                                <ArrowLeft size={16} />
-                                <span>Voltar</span>
-                            </button>
-                            <label className="text-xs font-bold text-neutral-500 uppercase">Nome do Treino</label>
-                        </div>
-                    </div>
-                    <input
-                        value={workout.title || ''}
-                        onChange={e => onChange?.({ ...workout, title: e.target.value })}
-                        className="w-full bg-neutral-800 text-xl font-bold p-4 rounded-xl border border-neutral-700 outline-none focus:border-yellow-500 text-white placeholder-neutral-600 transition-colors"
-                        placeholder="Ex: Treino A - Peito e Tríceps"
-                    />
-                </div>
-
-                <div className="space-y-4">
-                    <div className="flex items-center justify-between">
-                        <label className="text-xs font-bold text-neutral-500 uppercase">Exercícios ({workout.exercises?.length || 0})</label>
-                    </div>
-
-                    {(workout.exercises || []).map((exercise, index) => {
-                        if (!exercise) return null;
-                        const exerciseType = getExerciseType(exercise);
-                        const safeMethod = normalizeMethod(exercise?.method);
-                        const prev = (workout.exercises || [])[index - 1];
-                        const linkedFromPrev = normalizeMethod(prev?.method) === 'Bi-Set';
-                        const hasNext = index < ((workout.exercises || []).length - 1);
-                        const isBiSet = safeMethod === 'Bi-Set';
-                        const nextExercise = hasNext ? (workout.exercises || [])[index + 1] : null;
-                        const nextType = nextExercise ? getExerciseType(nextExercise) : null;
-                        const canShowLinkButton = hasNext && exerciseType !== 'cardio' && nextType !== 'cardio';
-                        const setsFromField = Math.max(0, parseInt(exercise?.sets) || 0);
-                        const setsFromDetails = Array.isArray(exercise?.setDetails) ? exercise.setDetails.length : 0;
-                        const setsCount = Math.max(setsFromField, setsFromDetails);
-                        const setDetails = ensureSetDetails(exercise, setsCount);
-
-                        return (
-                            <React.Fragment key={index}>
-                                <div
-                                    className={`bg-neutral-800 p-4 border border-neutral-700 relative group transition-all hover:border-neutral-600 ${linkedFromPrev ? '-mt-4 rounded-t-none border-t-0' : 'rounded-xl'} ${isBiSet && hasNext ? 'rounded-b-none' : ''}`}
-                                >
-                                    {(isBiSet || linkedFromPrev) && (
-                                        <div className="pointer-events-none absolute left-0 top-0 bottom-0 w-1 bg-yellow-500/20" />
-                                    )}
-                                    <div className="absolute top-2 right-2 flex gap-2">
-                                        <button
-                                            onClick={() => toggleExerciseType(index, exerciseType)}
-                                            className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border transition-colors ${
-                                                exerciseType === 'cardio'
-                                                ? 'bg-blue-500/20 text-blue-400 border-blue-500/50'
-                                                : 'bg-neutral-700 text-neutral-400 border-neutral-600 hover:border-neutral-400'
-                                            }`}
-                                        >
-                                            {exerciseType === 'cardio' ? 'Cardio' : 'Força'}
-                                        </button>
-                                        {isBiSet && hasNext && (
-                                            <button
-                                                type="button"
-                                                onClick={() => toggleBiSetWithNext(index)}
-                                                className="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border border-yellow-500/30 text-yellow-500 hover:text-yellow-400 hover:border-yellow-500/50 bg-yellow-500/10"
-                                                title="Deslinkar do próximo"
-                                            >
-                                                Deslinkar
-                                            </button>
-                                        )}
-                                        <button
-                                            onClick={() => removeExercise(index)}
-                                            className="text-neutral-600 hover:text-red-500 p-1 transition-colors"
-                                        >
-                                            <Trash2 size={16} />
-                                        </button>
-                                    </div>
-
-                                    <div className="space-y-4 pr-0 pt-6">
-                                    {exerciseType === 'cardio' ? (
-                                        <div>
-                                            <label className="text-[10px] text-neutral-500 uppercase font-bold mb-1 block">Modalidade</label>
-                                            <select
-                                                value={exercise.name || ''}
-                                                onChange={e => updateExercise(index, 'name', e.target.value)}
-                                                className="w-full bg-neutral-900 font-bold text-white text-lg p-3 rounded-xl border border-neutral-700 outline-none focus:border-blue-500 transition-colors appearance-none"
-                                            >
-                                                {CARDIO_OPTIONS.map(opt => (
-                                                    <option key={opt} value={opt}>{opt}</option>
-                                                ))}
-                                            </select>
-                                        </div>
-                                    ) : (
-                                        <div>
-                                            <input
-                                                value={exercise.name || ''}
-                                                onChange={e => updateExercise(index, 'name', e.target.value)}
-                                                className="w-full bg-transparent font-bold text-white text-lg border-b border-neutral-700 pb-2 focus:border-yellow-500 outline-none placeholder-neutral-600 transition-colors"
-                                                placeholder="Nome do exercício"
-                                            />
-                                            {(() => {
-                                                const info = resolveCanonicalExerciseName(exercise.name || '')
-                                                if (!info?.changed || !info?.canonical) return null
-                                                return (
-                                                    <button
-                                                        type="button"
-                                                        onClick={() => updateExercise(index, 'name', info.canonical)}
-                                                        className="mt-2 inline-flex items-center gap-2 px-3 py-1.5 rounded-xl bg-yellow-500/10 border border-yellow-500/30 text-yellow-500 font-bold text-xs hover:bg-yellow-500/15"
-                                                    >
-                                                        Padronizar: {info.canonical}
-                                                    </button>
-                                                )
-                                            })()}
-                                        </div>
-                                    )}
-
-									{exerciseType === 'cardio' ? (
-										<div className="grid grid-cols-2 gap-4">
-											<div>
-												<label className="text-[10px] text-neutral-500 uppercase font-bold text-center block mb-1">
-													{String(exercise?.name || '').toLowerCase() === 'bike outdoor'
-														? 'Tempo (minutos) (opcional)'
-														: 'Tempo (minutos)'}
-												</label>
-									<input
-										type="number"
-										min={String(exercise?.name || '').toLowerCase() === 'bike outdoor' ? undefined : 1}
-										value={exercise.reps || ''}
-										onChange={e => updateExercise(index, 'reps', e.target.value)}
-										className="w-full bg-neutral-900 rounded-xl p-4 text-center text-xl font-bold text-white outline-none focus:ring-1 ring-blue-500 border border-neutral-700"
-										placeholder={String(exercise?.name || '').toLowerCase() === 'bike outdoor' ? 'Livre' : '30'}
-									/>
-											</div>
-											<div>
-												<label className="text-[10px] text-yellow-500 uppercase font-bold text-center block mb-1">Intensidade</label>
-												<input
-                                                    type="number"
-                                                    min="1"
-                                                    value={exercise.rpe || ''}
-                                                    onChange={e => updateExercise(index, 'rpe', e.target.value)}
-                                                    className="w-full bg-neutral-900 border border-yellow-500/20 rounded-xl p-4 text-center text-xl font-bold text-yellow-500 outline-none focus:ring-1 ring-yellow-500 placeholder-yellow-500/30"
-                                                    placeholder="5"
-                                                />
-                                            </div>
-                                        </div>
-                                    ) : (
-                                        <div className="grid grid-cols-3 sm:grid-cols-6 gap-3">
-                                            <div>
-                                                <label className="text-[10px] text-neutral-500 uppercase font-bold text-center block mb-1">Sets</label>
-                                                <div className="flex items-center gap-1">
-                                                    <input
-                                                        type="number"
-                                                        value={setsCount || ''}
-                                                        onChange={e => updateExercise(index, 'sets', e.target.value)}
-                                                        className="w-full bg-neutral-900 rounded-lg p-2 text-center text-sm font-bold text-white outline-none focus:ring-1 ring-yellow-500"
-                                                    />
-                                                    <button
-                                                        onClick={() => updateExercise(index, 'duplicate', true)}
-                                                        className="h-8 w-8 bg-neutral-700 hover:bg-white hover:text-black text-neutral-400 rounded-lg flex items-center justify-center transition-colors"
-                                                        title="Duplicar Série"
-                                                    >
-                                                        <Plus size={14} />
-                                                    </button>
-                                                </div>
-                                            </div>
-                                            <div>
-                                                <label className="text-[10px] text-neutral-500 uppercase font-bold text-center block mb-1">Reps</label>
-                                                <input
-                                                    type="text"
-                                                    value={exercise.reps || ''}
-                                                    onChange={e => updateExercise(index, 'reps', e.target.value)}
-                                                    className="w-full bg-neutral-900 rounded-lg p-2 text-center text-sm font-bold text-white outline-none focus:ring-1 ring-yellow-500"
-                                                />
-                                            </div>
-                                            <div>
-                                                <label className="text-[10px] text-yellow-500 uppercase font-bold text-center block mb-1">RPE</label>
-                                                <input
-                                                    type="number"
-                                                    value={exercise.rpe || ''}
-                                                    onChange={e => updateExercise(index, 'rpe', e.target.value)}
-                                                    className="w-full bg-neutral-900 border border-yellow-500/20 rounded-lg p-2 text-center text-sm font-bold text-yellow-500 outline-none focus:ring-1 ring-yellow-500 placeholder-yellow-500/30"
-                                                    placeholder="8"
-                                                />
-                                            </div>
-                                            <div>
-                                                <label className="text-[10px] text-neutral-500 uppercase font-bold text-center block mb-1">Rest(s)</label>
-                                                <input
-                                                    type="number"
-                                                    value={(exercise.restTime ?? '')}
-                                                    onChange={e => updateExercise(index, 'restTime', e.target.value)}
-                                                    className="w-full bg-neutral-900 rounded-lg p-2 text-center text-sm font-bold text-white outline-none focus:ring-1 ring-yellow-500"
-                                                />
-                                            </div>
-                                            <div>
-                                                <label className="text-[10px] text-neutral-500 uppercase font-bold text-center block mb-1">Cad</label>
-                                                <input
-                                                    type="text"
-                                                    value={exercise.cadence || ''}
-                                                    onChange={e => updateExercise(index, 'cadence', e.target.value)}
-                                                    className="w-full bg-neutral-900 rounded-lg p-2 text-center text-sm font-bold text-white outline-none focus:ring-1 ring-yellow-500"
-                                                />
-                                            </div>
-                                            <div>
-                                                <label className="text-[10px] text-neutral-500 uppercase font-bold text-center block mb-1">Método</label>
-                                                <select
-                                                    value={safeMethod || 'Normal'}
-                                                    onChange={e => updateExercise(index, 'method', e.target.value)}
-                                                    className="w-full bg-neutral-900 rounded-lg p-2 text-center text-[10px] font-bold text-white h-[36px] outline-none focus:ring-1 ring-yellow-500"
-                                                >
-                                                    <option value="Normal">Normal</option>
-                                                    <option value="Drop-set">Drop</option>
-                                                    <option value="Rest-Pause">Rest-P</option>
-                                                    <option value="Bi-Set">Bi-Set</option>
-                                                    <option value="Cluster">Cluster</option>
-                                                </select>
-                                            </div>
-                                        </div>
-                                    )}
-
-                                    <div className="space-y-3 pt-2">
-                                        <div>
-                                            <div className="flex items-center justify-between gap-3 mb-1">
-                                                <label className="text-[10px] text-blue-400 uppercase font-bold block">Vídeo Demonstração (URL)</label>
-                                                {String(exercise.videoUrl || '').trim() ? (
-                                                    <button
-                                                        type="button"
-                                                        onClick={(e) => {
-                                                            try {
-                                                                e.preventDefault();
-                                                                e.stopPropagation();
-                                                            } catch {}
-                                                            try {
-                                                                window.open(String(exercise.videoUrl || '').trim(), '_blank', 'noopener,noreferrer');
-                                                            } catch {}
-                                                        }}
-                                                        className="inline-flex items-center gap-2 text-blue-300 hover:text-blue-200 text-[11px] font-bold opacity-70 hover:opacity-100"
-                                                        title="Ver vídeo"
-                                                    >
-                                                        <Play size={14} />
-                                                        Ver vídeo
-                                                    </button>
-                                                ) : null}
-                                            </div>
-                                            <input
-                                                value={exercise.videoUrl || ''}
-                                                onChange={e => updateExercise(index, 'videoUrl', e.target.value)}
-                                                className="w-full bg-blue-500/5 border border-blue-500/20 rounded-lg p-2 text-xs text-blue-200 focus:border-blue-500 outline-none placeholder-blue-500/30 transition-colors"
-                                                placeholder="https://youtube.com/..."
-                                            />
-                                        </div>
-                                        <div>
-                                            <label className="text-[10px] text-neutral-500 uppercase font-bold mb-1 block">Notas</label>
-                                            <textarea
-                                                value={exercise.notes || ''}
-                                                onChange={e => updateExercise(index, 'notes', e.target.value)}
-                                                className="w-full bg-neutral-900 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500 min-h-[60px] resize-none"
-                                                placeholder="Dicas de execução..."
-                                            />
-                                        </div>
-                                    </div>
-
-                                    {exerciseType !== 'cardio' && setsCount > 0 && (
-                                        <div className="pt-4 space-y-2">
-                                            <div className="flex items-center justify-between">
-                                                <div className="text-[10px] text-neutral-500 uppercase font-bold">Séries</div>
-                                                <div className="text-[10px] text-neutral-600">{setsCount}</div>
-                                            </div>
-
-                                            {setDetails.map((s, setIdx) => {
-                                                const isWarmup = !!(s?.is_warmup ?? s?.isWarmup)
-                                                const borderClass = isWarmup ? 'border-yellow-500/60' : 'border-neutral-700'
-                                                const config = s?.advanced_config ?? s?.advancedConfig ?? null
-                                                const isObj = config && typeof config === 'object' && !Array.isArray(config)
-                                                const isDropCfg = Array.isArray(config)
-                                                const isClusterCfg = isObj && (config?.cluster_size != null || config?.intra_rest_sec != null || config?.total_reps != null)
-                                                const isRestPauseCfg = isObj && (config?.mini_sets != null || config?.rest_time_sec != null || config?.initial_reps != null)
-
-                                                const updateConfig = (nextConfig) => {
-                                                    updateSetDetail(index, setIdx, { advanced_config: nextConfig })
-                                                }
-
-                                                return (
-                                                    <div key={setIdx} className={`bg-neutral-900 border ${borderClass} rounded-xl p-3`}>
-                                                        <div className="flex items-center justify-between gap-3">
-                                                            <div className="flex items-center gap-3">
-                                                                <div className="text-xs font-bold text-white">Série {s?.set_number ?? (setIdx + 1)}</div>
-                                                                <label className="flex items-center gap-2 text-[10px] text-neutral-300 font-bold">
-                                                                    {setIdx === 0 && (
-                                                                        <input
-                                                                            type="checkbox"
-                                                                            checked={isWarmup}
-                                                                            onChange={(e) => updateSetDetail(index, setIdx, { is_warmup: !!e.target.checked })}
-                                                                            className="accent-yellow-500"
-                                                                        />
-                                                                    )}
-                                                                    {setIdx === 0 && 'Série de Aquecimento'}
-                                                                </label>
-                                                            </div>
-                                                        </div>
-
-												{(!isDropCfg && !isClusterCfg && !isRestPauseCfg && (safeMethod === 'Normal' || safeMethod === 'Bi-Set' || safeMethod === 'Rest-Pause' || safeMethod === 'Drop-set' || safeMethod === 'Cluster')) && (
-													<div className="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2">
-														<div>
-															<label className="text-[10px] text-neutral-500 uppercase font-bold">Carga (kg)</label>
-															<input
-																type="number"
-                                                                        value={(s?.weight ?? '')}
-                                                                        onChange={(e) => updateSetDetail(index, setIdx, { weight: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Reps</label>
-                                                                    <input
-                                                                        type="text"
-                                                                        value={(s?.reps ?? '')}
-                                                                        onChange={(e) => updateSetDetail(index, setIdx, { reps: e.target.value })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-yellow-500 uppercase font-bold">RPE</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(s?.rpe ?? '')}
-                                                                        onChange={(e) => updateSetDetail(index, setIdx, { rpe: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-yellow-500/20 rounded-lg p-2 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                            </div>
-                                                        )}
-
-                                                        {(isDropCfg || safeMethod === 'Drop-set') && (
-                                                            <div className="mt-3 space-y-2">
-                                                                <div className="flex items-center justify-between">
-                                                                    <div className="text-[10px] text-neutral-500 uppercase font-bold">Drop Set</div>
-                                                                    <button
-                                                                        type="button"
-                                                                        onClick={() => {
-                                                                            const list = Array.isArray(config) ? config : []
-                                                                            updateConfig([...(list || []), { weight: null, reps: '' }])
-                                                                        }}
-                                                                        className="text-[10px] font-bold text-yellow-500 hover:text-yellow-400"
-                                                                    >
-                                                                        (+) Add Drop
-                                                                    </button>
-                                                                </div>
-
-                                                                {(Array.isArray(config) ? config : []).map((d, dIdx) => (
-                                                                    <div key={dIdx} className="grid grid-cols-[1fr_1fr_auto] gap-2 items-end">
-                                                                        <div>
-                                                                            <label className="text-[10px] text-neutral-500 uppercase font-bold">Peso (kg)</label>
-                                                                            <input
-                                                                                type="number"
-                                                                                value={(d?.weight ?? '')}
-                                                                                onChange={(e) => {
-                                                                                    const list = Array.isArray(config) ? [...config] : []
-                                                                                    const next = { ...(list[dIdx] || {}), weight: e.target.value === '' ? null : Number(e.target.value) }
-                                                                                    list[dIdx] = next
-                                                                                    updateConfig(list)
-                                                                                }}
-                                                                                className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                            />
-                                                                        </div>
-                                                                        <div>
-                                                                            <label className="text-[10px] text-neutral-500 uppercase font-bold">Reps</label>
-                                                                            <input
-                                                                                type="text"
-                                                                                value={(d?.reps ?? '')}
-                                                                                onChange={(e) => {
-                                                                                    const list = Array.isArray(config) ? [...config] : []
-                                                                                    const next = { ...(list[dIdx] || {}), reps: e.target.value }
-                                                                                    list[dIdx] = next
-                                                                                    updateConfig(list)
-                                                                                }}
-                                                                                className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                            />
-                                                                        </div>
-                                                                        <button
-                                                                            type="button"
-                                                                            onClick={() => {
-                                                                                const list = Array.isArray(config) ? [...config] : []
-                                                                                list.splice(dIdx, 1)
-                                                                                updateConfig(list)
-                                                                            }}
-                                                                            className="h-9 w-9 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 hover:text-red-400"
-                                                                            title="Remover drop"
-                                                                        >
-                                                                            <Trash2 size={14} className="mx-auto" />
-                                                                        </button>
-                                                                    </div>
-                                                                ))}
-                                                            </div>
-                                                        )}
-
-													{(isRestPauseCfg || safeMethod === 'Rest-Pause') && !isDropCfg && config && typeof config === 'object' && (
-														<div className="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
-															<div>
-																<label className="text-[10px] text-neutral-500 uppercase font-bold">Carga</label>
-																<input
-																	type="number"
-                                                                        value={(config?.weight ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), weight: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Reps Iniciais</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(config?.initial_reps ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), initial_reps: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Pausa (s)</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(config?.rest_time_sec ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), rest_time_sec: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Mini-sets</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(config?.mini_sets ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), mini_sets: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                            </div>
-                                                        )}
-
-                                                        {(isClusterCfg || safeMethod === 'Cluster') && !isDropCfg && (
-                                                            <div className="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Carga</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(config?.weight ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), weight: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Total Reps</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(config?.total_reps ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), total_reps: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Cluster</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(config?.cluster_size ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), cluster_size: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                                <div>
-                                                                    <label className="text-[10px] text-neutral-500 uppercase font-bold">Intra (s)</label>
-                                                                    <input
-                                                                        type="number"
-                                                                        value={(config?.intra_rest_sec ?? '')}
-                                                                        onChange={(e) => updateConfig({ ...(config && typeof config === 'object' ? config : {}), intra_rest_sec: e.target.value === '' ? null : Number(e.target.value) })}
-                                                                        className="w-full bg-black/30 border border-neutral-700 rounded-lg p-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                                                                    />
-                                                                </div>
-                                                            </div>
-                                                        )}
-
-                                                    </div>
-                                                )
-                                            })}
-                                        </div>
-                                    )}
-                                </div>
-
-                                    {isBiSet && hasNext && (
-                                        <div className="absolute bottom-2 left-1/2 -translate-x-1/2 bg-neutral-900 border border-neutral-700 rounded-full px-3 py-1 flex items-center gap-2 z-20 shadow-lg">
-                                            <Link2 size={14} className="text-yellow-500" />
-                                            <span className="text-[10px] text-neutral-300 font-bold">BI-SET</span>
-                                        </div>
-                                    )}
-                                </div>
-
-                                {canShowLinkButton && !isBiSet && (
-                                    <div className="flex justify-center -mt-4 -mb-4 relative z-10">
-                                        <button
-                                            type="button"
-                                            onClick={() => toggleBiSetWithNext(index)}
-                                            className="mt-3 mb-3 inline-flex items-center gap-2 px-4 py-2 bg-neutral-900 border border-neutral-700 rounded-full text-xs font-bold text-neutral-200 hover:bg-neutral-800 hover:text-white transition-colors min-h-[44px]"
-                                            title="Linkar com próximo (Bi-set)"
-                                        >
-                                            <Link2 size={16} className="text-yellow-500" />
-                                            <span>Linkar com Próximo</span>
-                                        </button>
-                                    </div>
-                                )}
-                            </React.Fragment>
-                        );
-                    })}
-                </div>
-
-                <button
-                    onClick={addExercise}
-                    className="w-full py-4 border-2 border-dashed border-neutral-800 text-neutral-500 rounded-xl font-bold hover:bg-neutral-800 hover:text-white hover:border-neutral-700 transition-all flex items-center justify-center gap-2"
-                >
-                    <Plus size={20} /> Adicionar Exercício
-                </button>
-            </div>
-        </div>
-    );
-};
-
-export default ExerciseEditor;
diff --git a/_archive/duplicates/src/components/HistoryList 2.js b/_archive/duplicates/src/components/HistoryList 2.js
deleted file mode 100644
index 05267f4..0000000
--- a/_archive/duplicates/src/components/HistoryList 2.js	
+++ /dev/null
@@ -1,1437 +0,0 @@
-"use client";
-
-import React, { useEffect, useMemo, useState } from 'react';
-import { CalendarDays, ChevronLeft, Clock, Edit3, History, Plus, Trash2, CheckCircle2, Circle, Download, Loader2 } from 'lucide-react';
-import { createClient } from '@/utils/supabase/client';
-import ExerciseEditor from '@/components/ExerciseEditor';
-import WorkoutReport from '@/components/WorkoutReport';
-import { generatePeriodReportInsights } from '@/actions/workout-actions';
-import { useDialog } from '@/contexts/DialogContext';
-import { buildPeriodReportHtml } from '@/utils/report/buildPeriodReportHtml';
-import { FEATURE_KEYS, isFeatureEnabled } from '@/utils/featureFlags';
-
-const REPORT_DAYS_WEEK = 7;
-const REPORT_DAYS_MONTH = 30;
-const DAY_MS = 24 * 60 * 60 * 1000;
-const PERIOD_SESSIONS_LIMIT = 30;
-const TOP_EXERCISES_LIMIT = 5;
-
-const HistoryList = ({ user, settings, onViewReport, onBack, targetId, targetEmail, readOnly, title, embedded = false }) => {
-    const { confirm, alert } = useDialog();
-    const [history, setHistory] = useState([]);
-    const [loading, setLoading] = useState(true);
-    const supabase = useMemo(() => createClient(), []);
-    const safeUserId = user?.id ? String(user.id) : '';
-    const isReadOnly = !!readOnly;
-    const [range, setRange] = useState(() => (readOnly ? 'all' : '30'));
-    const [showManual, setShowManual] = useState(false);
-    const [manualDate, setManualDate] = useState(new Date().toISOString().slice(0,16));
-    const [manualDuration, setManualDuration] = useState('45');
-    const [manualNotes, setManualNotes] = useState('');
-    const [manualTab, setManualTab] = useState('existing');
-    const weeklyReportCtaEnabled = useMemo(() => isFeatureEnabled(settings, FEATURE_KEYS.weeklyReportCTA), [settings]);
-    const [availableWorkouts, setAvailableWorkouts] = useState([]);
-    const [selectedTemplate, setSelectedTemplate] = useState(null);
-    const [newWorkout, setNewWorkout] = useState({ title: '', exercises: [] });
-    const [manualExercises, setManualExercises] = useState([]);
-    const [showEdit, setShowEdit] = useState(false);
-    const [selectedSession, setSelectedSession] = useState(null);
-    const [editId, setEditId] = useState(null);
-    const [editTitle, setEditTitle] = useState('');
-    const [editDate, setEditDate] = useState(new Date().toISOString().slice(0,16));
-    const [editDuration, setEditDuration] = useState('45');
-    const [editNotes, setEditNotes] = useState('');
-    const [editExercises, setEditExercises] = useState([]);
-    const [isSelectionMode, setIsSelectionMode] = useState(false);
-    const [selectedIds, setSelectedIds] = useState(new Set());
-    const [periodReport, setPeriodReport] = useState(null);
-    const [periodAi, setPeriodAi] = useState({ status: 'idle', ai: null, error: '' });
-    const [periodPdf, setPeriodPdf] = useState({ status: 'idle', url: null, blob: null, error: '' });
-    const [shareError, setShareError] = useState('');
-
-    const toggleSelectionMode = () => {
-        setIsSelectionMode(!isSelectionMode);
-        setSelectedIds(new Set());
-    };
-
-    const toggleItemSelection = (id) => {
-        setSelectedIds(prev => {
-            const next = new Set(prev);
-            if (next.has(id)) next.delete(id);
-            else next.add(id);
-            return next;
-        });
-    };
-
-    const handleBulkDelete = async () => {
-        if (selectedIds.size === 0) return;
-        if (!(await confirm(`Excluir ${selectedIds.size} itens selecionados?`))) return;
-        
-        try {
-            const ids = Array.from(selectedIds);
-            const { error } = await supabase
-                .from('workouts')
-                .delete()
-                .in('id', ids)
-                .eq('is_template', false);
-
-            if (error) throw error;
-            
-            setHistory(prev => prev.filter(h => !selectedIds.has(h.id)));
-            setIsSelectionMode(false);
-            setSelectedIds(new Set());
-            await alert('Itens excluídos com sucesso');
-        } catch (e) {
-            await alert('Erro ao excluir: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const formatHistoryTitle = (title) => {
-        return title || 'Treino';
-    };
-
-    const formatCompletedAt = (dateValue) => {
-        try {
-            if (!dateValue) return 'Data desconhecida';
-            const d = new Date(dateValue);
-            if (isNaN(d.getTime())) return 'Data desconhecida';
-            const dateStr = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
-            const timeStr = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
-            return `${dateStr} • ${timeStr}`;
-        } catch {
-            return 'Data desconhecida';
-        }
-    };
-
-    const rangeLabel = useMemo(() => {
-        if (range === '7') return 'Últimos 7 dias';
-        if (range === '30') return 'Últimos 30 dias';
-        if (range === '90') return 'Últimos 90 dias';
-        return 'Tudo';
-    }, [range]);
-
-    const historyItems = useMemo(() => {
-        return Array.isArray(history) ? history : [];
-    }, [history]);
-
-    const toDateMs = (value) => {
-        try {
-            if (!value) return null;
-            if (value?.toDate) {
-                const d = value.toDate();
-                const t = d instanceof Date ? d.getTime() : new Date(d).getTime();
-                return Number.isFinite(t) ? t : null;
-            }
-            if (value instanceof Date) {
-                const t = value.getTime();
-                return Number.isFinite(t) ? t : null;
-            }
-            if (typeof value === 'object') {
-                const seconds = Number(value?.seconds ?? value?._seconds ?? value?.sec ?? null);
-                const nanos = Number(value?.nanoseconds ?? value?._nanoseconds ?? 0);
-                if (Number.isFinite(seconds) && seconds > 0) {
-                    const t = seconds * 1000 + Math.floor(nanos / 1e6);
-                    return Number.isFinite(t) ? t : null;
-                }
-            }
-            const t = new Date(value).getTime();
-            return Number.isFinite(t) ? t : null;
-        } catch {
-            return null;
-        }
-    };
-
-    const filteredHistory = useMemo(() => {
-        if (range === 'all') return historyItems;
-        const days = Number(range);
-        if (!Number.isFinite(days) || days <= 0) return historyItems;
-        const cutoff = Date.now() - days * DAY_MS;
-        return historyItems.filter((s) => {
-            const t = toDateMs(s?.dateMs) ?? toDateMs(s?.date);
-            return Number.isFinite(t) && t >= cutoff;
-        });
-    }, [historyItems, range]);
-
-    const summary = useMemo(() => {
-        const totalSeconds = filteredHistory.reduce((acc, s) => acc + (Number(s?.totalTime) || 0), 0);
-        const totalMinutes = Math.max(0, Math.round(totalSeconds / 60));
-        const count = filteredHistory.length;
-        const avgMinutes = count > 0 ? Math.max(0, Math.round(totalMinutes / count)) : 0;
-        return { count, totalMinutes, avgMinutes };
-    }, [filteredHistory]);
-
-    const calculateTotalVolumeFromLogs = (logs) => {
-        try {
-            const safeLogs = logs && typeof logs === 'object' ? logs : {};
-            let volume = 0;
-            Object.values(safeLogs).forEach((log) => {
-                if (!log || typeof log !== 'object') return;
-                const w = Number(String(log.weight ?? '').replace(',', '.'));
-                const r = Number(String(log.reps ?? '').replace(',', '.'));
-                if (!Number.isFinite(w) || !Number.isFinite(r)) return;
-                if (w <= 0 || r <= 0) return;
-                volume += w * r;
-            });
-            return volume;
-        } catch {
-            return 0;
-        }
-    };
-
-    const buildPeriodStats = (days) => {
-        try {
-            const historyList = Array.isArray(historyItems) ? historyItems : [];
-            const daysNumber = Number(days);
-            if (!Number.isFinite(daysNumber) || daysNumber <= 0) return null;
-            const cutoff = Date.now() - daysNumber * DAY_MS;
-            const list = historyList.filter((s) => {
-                const t = toDateMs(s?.dateMs) ?? toDateMs(s?.date);
-                return Number.isFinite(t) && t >= cutoff;
-            });
-            if (!list.length) return null;
-            const totalSeconds = list.reduce((acc, s) => acc + (Number(s?.totalTime) || 0), 0);
-            const totalMinutes = Math.max(0, Math.round(totalSeconds / 60));
-            const count = list.length;
-            const avgMinutes = count > 0 ? Math.max(0, Math.round(totalMinutes / count)) : 0;
-            let totalVolumeKg = 0;
-            let totalSets = 0;
-            let totalReps = 0;
-            const uniqueDays = new Set();
-            const exerciseMap = new Map();
-            const sessionSummaries = [];
-            list.forEach((item) => {
-                const raw = item?.rawSession && typeof item.rawSession === 'object' ? item.rawSession : null;
-                const logs = raw?.logs && typeof raw.logs === 'object' ? raw.logs : {};
-                const exercises = Array.isArray(raw?.exercises) ? raw.exercises : [];
-                const v = calculateTotalVolumeFromLogs(logs);
-                const safeVolume = Number.isFinite(v) && v > 0 ? v : 0;
-                if (safeVolume > 0) totalVolumeKg += safeVolume;
-                const dateValue = item?.date ?? raw?.date ?? item?.created_at ?? null;
-                let dayKey = '';
-                try {
-                    const t = toDateMs(dateValue);
-                    if (Number.isFinite(t)) {
-                        dayKey = new Date(t).toISOString().slice(0, 10);
-                        uniqueDays.add(dayKey);
-                    }
-                } catch {}
-                const sessionMinutes = Math.max(0, Math.round((Number(item?.totalTime ?? raw?.totalTime) || 0) / 60));
-                sessionSummaries.push({ date: dateValue, minutes: sessionMinutes, volumeKg: Math.max(0, Math.round(safeVolume || 0)) });
-                Object.entries(logs || {}).forEach(([key, log]) => {
-                    if (!log || typeof log !== 'object') return;
-                    const w = Number(String(log.weight ?? '').replace(',', '.'));
-                    const r = Number(String(log.reps ?? '').replace(',', '.'));
-                    if (!Number.isFinite(w) || !Number.isFinite(r)) return;
-                    if (w <= 0 || r <= 0) return;
-                    totalSets += 1;
-                    totalReps += r;
-                    const exIdx = Number.parseInt(String(key || '').split('-')[0] || '', 10);
-                    const rawName = Number.isFinite(exIdx) ? exercises?.[exIdx]?.name : null;
-                    const name = String(rawName || '').trim() || 'Exercício';
-                    const current = exerciseMap.get(name) || { name, sets: 0, reps: 0, volumeKg: 0, sessions: new Set() };
-                    current.sets += 1;
-                    current.reps += r;
-                    current.volumeKg += w * r;
-                    if (dayKey) current.sessions.add(dayKey);
-                    exerciseMap.set(name, current);
-                });
-            });
-            const avgVolumeKg = count > 0 ? Math.max(0, Math.round(totalVolumeKg / count)) : 0;
-            const exercisesList = Array.from(exerciseMap.values()).map((item) => ({
-                name: String(item?.name || '').trim(),
-                sets: Number(item?.sets) || 0,
-                reps: Number(item?.reps) || 0,
-                volumeKg: Math.max(0, Math.round(Number(item?.volumeKg) || 0)),
-                sessionsCount: item?.sessions ? item.sessions.size : 0
-            })).filter((item) => item.name);
-            const topExercisesByVolume = [...exercisesList]
-                .sort((a, b) => (b.volumeKg || 0) - (a.volumeKg || 0))
-                .slice(0, TOP_EXERCISES_LIMIT);
-            const topExercisesByFrequency = [...exercisesList]
-                .sort((a, b) => (b.sessionsCount || 0) - (a.sessionsCount || 0) || (b.sets || 0) - (a.sets || 0))
-                .slice(0, TOP_EXERCISES_LIMIT);
-            return {
-                days: daysNumber,
-                count,
-                totalMinutes,
-                avgMinutes,
-                totalVolumeKg: Math.max(0, Math.round(totalVolumeKg)),
-                avgVolumeKg,
-                totalSets,
-                totalReps,
-                uniqueDaysCount: uniqueDays.size,
-                topExercisesByVolume,
-                topExercisesByFrequency,
-                sessionSummaries: sessionSummaries.slice(0, PERIOD_SESSIONS_LIMIT)
-            };
-        } catch {
-            return null;
-        }
-    };
-
-    const buildShareText = (report) => {
-        const data = report && typeof report === 'object' ? report : null;
-        if (!data) return '';
-        const label = data.type === 'week' ? 'semanal' : data.type === 'month' ? 'mensal' : 'período';
-        const stats = data.stats && typeof data.stats === 'object' ? data.stats : {};
-        const count = Number(stats.count) || 0;
-        const totalMinutes = Number(stats.totalMinutes) || 0;
-        const avgMinutes = Number(stats.avgMinutes) || 0;
-        const totalVolume = Number(stats.totalVolumeKg) || 0;
-        const avgVolume = Number(stats.avgVolumeKg) || 0;
-        let totalVolumeLabel = '0 kg';
-        let avgVolumeLabel = '0 kg';
-        if (Number.isFinite(totalVolume) && totalVolume > 0) {
-            totalVolumeLabel = `${totalVolume.toLocaleString('pt-BR')} kg`;
-        }
-        if (Number.isFinite(avgVolume) && avgVolume > 0) {
-            avgVolumeLabel = `${avgVolume.toLocaleString('pt-BR')} kg`;
-        }
-        const lines = [
-            'Relatório ' + label + ' IronTracks',
-            'Treinos finalizados: ' + count,
-            'Tempo total: ' + totalMinutes + ' min',
-            'Média por treino: ' + avgMinutes + ' min',
-            'Volume total: ' + totalVolumeLabel,
-            'Volume médio/treino: ' + avgVolumeLabel,
-        ];
-        return lines.join('\n');
-    };
-
-    const openSession = (session) => {
-        const rawSession = session?.rawSession && typeof session.rawSession === 'object' ? session.rawSession : null;
-        const payload = rawSession
-            ? {
-                ...rawSession,
-                id: rawSession.id ?? session?.id ?? null,
-                user_id: session?.raw?.user_id ?? rawSession?.user_id ?? session?.user_id ?? null,
-                student_id: session?.raw?.student_id ?? rawSession?.student_id ?? session?.student_id ?? null
-            }
-            : session;
-        if (typeof onViewReport === 'function') {
-            try {
-                onViewReport(payload);
-                return;
-            } catch {}
-        }
-        setSelectedSession(payload);
-    };
-
-    useEffect(() => {
-        if (!isSelectionMode) return;
-        setSelectedIds(new Set());
-    }, [isSelectionMode, range]);
-
-    useEffect(() => {
-        const loadHistory = async () => {
-            try {
-                setLoading(true);
-                const baseUserId = user?.id;
-                const hasTarget = !!(targetId || targetEmail);
-
-                if (!baseUserId && !hasTarget) {
-                    setHistory([]);
-                    return;
-                }
-
-                let data = [];
-
-                if (hasTarget) {
-                    const qs = targetId
-                        ? `id=${encodeURIComponent(targetId)}`
-                        : `email=${encodeURIComponent(targetEmail || '')}`;
-                    const resp = await fetch(`/api/admin/workouts/history?${qs}`);
-                    const json = await resp.json();
-                    if (!json?.ok) throw new Error(json?.error || 'Falha ao carregar histórico');
-                    data = Array.isArray(json?.rows) ? json.rows : [];
-                } else {
-                    const { data: rows, error } = await supabase
-                        .from('workouts')
-                        .select('*')
-                        .eq('user_id', baseUserId)
-                        .eq('is_template', false)
-                        .order('date', { ascending: false })
-                        .limit(200);
-
-                    if (error) throw error;
-                    data = Array.isArray(rows) ? rows : [];
-                }
-
-                const formatted = (data || []).map(w => {
-                    let raw = null;
-                    try {
-                        if (typeof w.notes === 'string') raw = JSON.parse(w.notes);
-                        else if (typeof w.notes === 'object' && w.notes) raw = w.notes;
-                    } catch (err) {
-                        console.error('Erro ao processar item:', w, err);
-                        raw = null;
-                    }
-                    const dateMs = toDateMs(raw?.date) ?? toDateMs(w?.date) ?? toDateMs(w?.completed_at) ?? toDateMs(w?.created_at) ?? null;
-                    const dateIso = dateMs ? new Date(dateMs).toISOString() : null;
-                    return {
-                        id: w.id,
-                        workoutTitle: raw?.workoutTitle || w.name || 'Treino Recuperado',
-                        date: dateIso,
-                        dateMs,
-                        totalTime: raw?.totalTime || 0,
-                        rawSession: raw,
-                        raw: w,
-                        isTemplate: w.is_template === true
-                    }
-                });
-
-                setHistory(formatted);
-            } catch (e) {
-                console.error("Erro histórico", e);
-                setHistory([]);
-            } finally {
-                setLoading(false);
-            }
-        };
-        loadHistory();
-    }, [supabase, user?.id, targetId, targetEmail]);
-
-    const saveManualExisting = async () => {
-        try {
-            if (!selectedTemplate) throw new Error('Selecione um treino');
-            const exIds = (selectedTemplate.exercises || []).map(e => e.id).filter(Boolean);
-            let setsMap = {};
-            if (exIds.length > 0) {
-                const { data: setsData } = await supabase
-                    .from('sets')
-                    .select('exercise_id, set_number, reps, rpe, weight')
-                    .in('exercise_id', exIds)
-                    .order('set_number');
-                (setsData || []).forEach(s => {
-                    const arr = setsMap[s.exercise_id] || (setsMap[s.exercise_id] = []);
-                    arr.push(s);
-                });
-            }
-            const exercises = (manualExercises.length ? manualExercises : (selectedTemplate.exercises || []).map(e => ({
-                name: e.name || '',
-                sets: (setsMap[e.id] || []).length || (Number(e.sets) || 0),
-                reps: e.reps || '',
-                restTime: Number(e.rest_time) || Number(e.restTime) || 0,
-                cadence: e.cadence || '',
-                notes: e.notes || ''
-            })));
-            const logs = {};
-            exercises.forEach((ex, exIdx) => {
-                const count = Number(ex.sets) || 0;
-                const weights = ex.weights || [];
-                for (let sIdx = 0; sIdx < count; sIdx++) {
-                    logs[`${exIdx}-${sIdx}`] = {
-                        weight: weights[sIdx] ?? '',
-                        reps: (ex.repsPerSet?.[sIdx] ?? ex.reps) ?? '',
-                        done: true
-                    };
-                }
-            });
-            const totalSeconds = parseInt(manualDuration || '0', 10) * 60;
-            const session = {
-                workoutTitle: selectedTemplate.name || 'Treino',
-                date: new Date(manualDate).toISOString(),
-                totalTime: totalSeconds,
-                realTotalTime: totalSeconds,
-                logs,
-                exercises,
-                notes: manualNotes || '',
-                originWorkoutId: selectedTemplate.id
-            };
-            const resp = await fetch('/api/workouts/finish', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ session })
-            });
-            const json = await resp.json();
-            if (!json.ok) throw new Error(json.error || 'Falha ao salvar');
-            setShowManual(false);
-            setHistory(prev => [{ id: json.saved.id, workoutTitle: session.workoutTitle, date: new Date(manualDate), totalTime: parseInt(manualDuration, 10) * 60, rawSession: session }, ...prev]);
-            await alert('Histórico adicionado');
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const saveManualNew = async () => {
-        try {
-            if (!newWorkout.title) throw new Error('Informe o título');
-            const exercises = (newWorkout.exercises || []).map(e => ({
-                name: e.name || '',
-                sets: Number(e.sets) || 0,
-                reps: e.reps || '',
-                restTime: Number(e.restTime) || 0,
-                cadence: e.cadence || '',
-                notes: e.notes || ''
-            }));
-            const logs = {};
-            exercises.forEach((ex, exIdx) => {
-                for (let sIdx = 0; sIdx < (Number(ex.sets) || 0); sIdx++) {
-                    logs[`${exIdx}-${sIdx}`] = { weight: '', reps: ex.reps || '', done: true };
-                }
-            });
-            const totalSeconds = parseInt(manualDuration || '0', 10) * 60;
-            const session = {
-                workoutTitle: newWorkout.title,
-                date: new Date(manualDate).toISOString(),
-                totalTime: totalSeconds,
-                realTotalTime: totalSeconds,
-                logs,
-                exercises,
-                notes: manualNotes || ''
-            };
-            const resp = await fetch('/api/workouts/finish', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ session })
-            });
-            const json = await resp.json();
-            if (!json.ok) throw new Error(json.error || 'Falha ao salvar');
-            setShowManual(false);
-            setHistory(prev => [{ id: json.saved.id, workoutTitle: session.workoutTitle, date: new Date(manualDate), totalTime: parseInt(manualDuration, 10) * 60, rawSession: session }, ...prev]);
-            await alert('Histórico adicionado');
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    useEffect(() => {
-        const fetchAvailableWorkouts = async () => {
-            try {
-                if (!safeUserId) { setAvailableWorkouts([]); return; }
-                const { data } = await supabase
-                    .from('workouts')
-                    .select('id, name')
-                    .eq('user_id', safeUserId)
-                    .eq('is_template', false)
-                    .order('created_at', { ascending: false });
-                setAvailableWorkouts(Array.isArray(data) ? data : []);
-            } catch { setAvailableWorkouts([]); }
-        };
-        if (showManual && manualTab === 'existing') fetchAvailableWorkouts();
-    }, [manualTab, showManual, supabase, safeUserId]);
-
-    useEffect(() => {
-        const buildManualFromTemplate = async () => {
-            if (!selectedTemplate) { setManualExercises([]); return; }
-            const sourceExercises = Array.isArray(selectedTemplate?.exercises) ? selectedTemplate.exercises : [];
-            const exIds = sourceExercises.map(e => e.id).filter(Boolean);
-            let setsMap = {};
-            if (exIds.length > 0) {
-                const { data: setsData } = await supabase
-                    .from('sets')
-                    .select('exercise_id, set_number, reps, rpe, weight')
-                    .in('exercise_id', exIds)
-                    .order('set_number');
-                (setsData || []).forEach(s => {
-                    const arr = setsMap[s.exercise_id] || (setsMap[s.exercise_id] = []);
-                    arr.push(s);
-                });
-            }
-            const exs = sourceExercises.map(e => ({
-                name: e.name || '',
-                sets: (setsMap[e.id] || []).length || (Number(e.sets) || 0),
-                reps: e.reps || '',
-                restTime: Number(e.rest_time) || Number(e.restTime) || 0,
-                cadence: e.cadence || '',
-                notes: e.notes || '',
-                weights: (setsMap[e.id] || []).map(s => s.weight ?? ''),
-                repsPerSet: (setsMap[e.id] || []).map(s => s.reps ?? '')
-            }));
-            setManualExercises(exs);
-        };
-        if (selectedTemplate && manualTab === 'existing') buildManualFromTemplate();
-    }, [manualTab, selectedTemplate, supabase]);
-
-    const updateManualExercise = (idx, field, value) => {
-        setManualExercises(prev => {
-            const next = [...prev];
-            if (field === 'weight') {
-                const [wIdx, val] = value;
-                const weights = Array.from({ length: Number(next[idx].sets) || 0 }, (_, i) => next[idx].weights?.[i] ?? '');
-                weights[wIdx] = val;
-                next[idx] = { ...next[idx], weights };
-            } else if (field === 'rep') {
-                const [rIdx, val] = value;
-                const repsPerSet = Array.from({ length: Number(next[idx].sets) || 0 }, (_, i) => next[idx].repsPerSet?.[i] ?? '');
-                repsPerSet[rIdx] = val;
-                next[idx] = { ...next[idx], repsPerSet };
-            } else {
-                next[idx] = { ...next[idx], [field]: value };
-                if (field === 'sets') {
-                    const n = Number(value) || 0;
-                    const weights = Array.from({ length: n }, (_, i) => next[idx].weights?.[i] ?? '');
-                    const repsPerSet = Array.from({ length: n }, (_, i) => next[idx].repsPerSet?.[i] ?? '');
-                    next[idx] = { ...next[idx], weights, repsPerSet };
-                }
-            }
-            return next;
-        });
-    };
-
-    const handleDeleteClick = async (e, session) => {
-        e.stopPropagation();
-        e.preventDefault();
-
-        if (!window.confirm("Tem certeza que deseja excluir este histórico permanentemente?")) return;
-
-        try {
-            const { error } = await supabase
-                .from('workouts')
-                .delete()
-                .eq('id', session.id)
-                .eq('is_template', false);
-            if (error) throw error;
-            setHistory(prev => prev.filter(h => h.id !== session.id));
-        } catch (error) {
-            await alert("Erro ao excluir: " + (error?.message ?? String(error)));
-        }
-    };
-
-    const openEdit = (session) => {
-        const raw = session.rawSession || (typeof session.notes === 'string' && session.notes?.startsWith('{') ? (() => { try { return JSON.parse(session.notes); } catch { return null; } })() : null);
-        setEditId(session.id);
-        setEditTitle(session.workoutTitle || raw?.workoutTitle || 'Treino');
-        const d = raw?.date ? new Date(raw.date) : new Date(session.date);
-        setEditDate(new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16));
-        setEditDuration(String(Math.floor((raw?.totalTime || session.totalTime || 0) / 60) || 45));
-        setEditNotes(raw?.notes || '');
-        const exs = (raw?.exercises || []).map((ex, exIdx) => {
-            const count = Number(ex.sets) || 0;
-            const weights = Array.from({ length: count }, (_, sIdx) => raw?.logs?.[`${exIdx}-${sIdx}`]?.weight ?? '');
-            const repsPerSet = Array.from({ length: count }, (_, sIdx) => raw?.logs?.[`${exIdx}-${sIdx}`]?.reps ?? ex.reps ?? '');
-            return { name: ex.name || '', sets: count, reps: ex.reps || '', restTime: Number(ex.restTime) || 0, cadence: ex.cadence || '', notes: ex.notes || '', weights, repsPerSet };
-        });
-        setEditExercises(exs);
-        setShowEdit(true);
-    };
-
-    const updateEditExercise = (idx, field, value) => {
-        setEditExercises(prev => {
-            const next = [...prev];
-            if (field === 'weight') {
-                const [wIdx, val] = value;
-                const weights = Array.from({ length: Number(next[idx].sets) || 0 }, (_, i) => next[idx].weights?.[i] ?? '');
-                weights[wIdx] = val;
-                next[idx] = { ...next[idx], weights };
-            } else if (field === 'rep') {
-                const [rIdx, val] = value;
-                const repsPerSet = Array.from({ length: Number(next[idx].sets) || 0 }, (_, i) => next[idx].repsPerSet?.[i] ?? '');
-                repsPerSet[rIdx] = val;
-                next[idx] = { ...next[idx], repsPerSet };
-            } else {
-                next[idx] = { ...next[idx], [field]: value };
-                if (field === 'sets') {
-                    const n = Number(value) || 0;
-                    const weights = Array.from({ length: n }, (_, i) => next[idx].weights?.[i] ?? '');
-                    const repsPerSet = Array.from({ length: n }, (_, i) => next[idx].repsPerSet?.[i] ?? '');
-                    next[idx] = { ...next[idx], weights, repsPerSet };
-                }
-            }
-            return next;
-        });
-    };
-
-    const saveEdit = async () => {
-        try {
-            const exercises = editExercises.map(ex => ({ name: ex.name || '', sets: Number(ex.sets) || 0, reps: ex.reps || '', restTime: Number(ex.restTime) || 0, cadence: ex.cadence || '', notes: ex.notes || '' }));
-            const logs = {};
-            exercises.forEach((ex, exIdx) => {
-                const count = Number(ex.sets) || 0;
-                for (let sIdx = 0; sIdx < count; sIdx++) {
-                    logs[`${exIdx}-${sIdx}`] = { weight: editExercises[exIdx]?.weights?.[sIdx] ?? '', reps: (editExercises[exIdx]?.repsPerSet?.[sIdx] ?? ex.reps) ?? '', done: true };
-                }
-            });
-            const totalSeconds = parseInt(editDuration || '0', 10) * 60;
-            const session = { workoutTitle: editTitle, date: new Date(editDate).toISOString(), totalTime: totalSeconds, realTotalTime: totalSeconds, logs, exercises, notes: editNotes || '' };
-            const { error } = await supabase
-                .from('workouts')
-                .update({ name: editTitle, date: new Date(editDate), notes: JSON.stringify(session) })
-                .eq('id', editId)
-                .eq('user_id', user.id);
-            if (error) throw error;
-            setShowEdit(false);
-            setHistory(prev => prev.map(h => h.id === editId ? { ...h, workoutTitle: editTitle, date: new Date(editDate), totalTime: parseInt(editDuration||'0',10)*60, rawSession: session } : h));
-            await alert('Histórico atualizado');
-        } catch (e) {
-            await alert('Erro: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const openPeriodReport = async (type) => {
-        try {
-            const key = type === 'week' ? REPORT_DAYS_WEEK : type === 'month' ? REPORT_DAYS_MONTH : null;
-            if (!key) return;
-            const stats = buildPeriodStats(key);
-            if (!stats) {
-                await alert('Sem treinos suficientes nesse período para gerar um relatório.');
-                return;
-            }
-            setPeriodReport({ type, stats });
-            setPeriodAi({ status: 'loading', ai: null, error: '' });
-            try {
-                const res = await generatePeriodReportInsights({ type, stats });
-                if (!res?.ok) {
-                    setPeriodAi({ status: 'error', ai: null, error: String(res?.error || 'Falha ao gerar insights') });
-                    return;
-                }
-                setPeriodAi({ status: 'ready', ai: res.ai || null, error: '' });
-            } catch (err) {
-                setPeriodAi({ status: 'error', ai: null, error: String(err?.message || err || 'Falha ao gerar insights') });
-            }
-        } catch (e) {
-            await alert('Erro ao gerar relatório: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const closePeriodReport = () => {
-        setPeriodReport(null);
-        setPeriodAi({ status: 'idle', ai: null, error: '' });
-        try { if (periodPdf?.url) URL.revokeObjectURL(periodPdf.url); } catch {}
-        setPeriodPdf({ status: 'idle', url: null, blob: null, error: '' });
-        setShareError('');
-    };
-
-    const downloadPeriodPdf = async () => {
-        const current = periodReport && typeof periodReport === 'object' ? periodReport : null;
-        if (!current) return;
-        if (periodPdf.status === 'loading') return;
-        setPeriodPdf((prev) => ({ ...(prev || {}), status: 'loading', error: '' }));
-        try {
-            const baseUrl = typeof window !== 'undefined' ? String(window.location.origin || '').trim() : '';
-            const userName = String(user?.displayName || user?.name || user?.email || '').trim();
-            const html = buildPeriodReportHtml({
-                type: current.type,
-                stats: current.stats,
-                ai: periodAi?.ai || null,
-                baseUrl,
-                userName
-            });
-            const dateLabel = new Date().toISOString().slice(0, 10);
-            const kind = current.type === 'week' ? 'Semanal' : current.type === 'month' ? 'Mensal' : 'Periodo';
-            const fileName = `Relatorio_${kind}_${dateLabel}`;
-            const res = await fetch('/api/report', {
-                method: 'POST',
-                credentials: 'include',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ html, fileName })
-            });
-            if (!res.ok) {
-                const txt = await res.text().catch(() => '');
-                throw new Error(txt || `Falha ao gerar PDF (${res.status})`);
-            }
-            const blob = await res.blob();
-            const url = URL.createObjectURL(blob);
-            try {
-                const a = document.createElement('a');
-                a.href = url;
-                a.download = `${fileName}.pdf`;
-                document.body.appendChild(a);
-                a.click();
-                a.remove();
-            } catch {}
-            setPeriodPdf({ status: 'ready', url, blob, error: '' });
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e);
-            setPeriodPdf((prev) => ({ ...(prev || {}), status: 'error', error: msg || 'Falha ao gerar PDF' }));
-        } finally {
-            setTimeout(() => setPeriodPdf((prev) => (prev?.status === 'loading' ? { ...(prev || {}), status: 'idle' } : prev)), 400);
-        }
-    };
-
-    const handleShareReport = async () => {
-        const current = periodReport && typeof periodReport === 'object' ? periodReport : null;
-        if (!current) return;
-        const text = buildShareText(current);
-        if (!text) return;
-
-        const legacyCopy = async () => {
-            try {
-                if (typeof document === 'undefined') return false;
-                const ta = document.createElement('textarea');
-                ta.value = text;
-                ta.setAttribute('readonly', 'true');
-                ta.style.position = 'fixed';
-                ta.style.top = '-1000px';
-                ta.style.left = '-1000px';
-                document.body.appendChild(ta);
-                ta.focus();
-                ta.select();
-                const ok = document.execCommand && document.execCommand('copy');
-                ta.remove();
-                return !!ok;
-            } catch {
-                return false;
-            }
-        };
-
-        try {
-            const nav = typeof navigator !== 'undefined' ? navigator : null;
-            if (nav && typeof nav.share === 'function') {
-                await nav.share({ text });
-                setShareError('');
-                return;
-            }
-        } catch {}
-        try {
-            const nav = typeof navigator !== 'undefined' ? navigator : null;
-            if (nav && nav.clipboard && typeof nav.clipboard.writeText === 'function') {
-                await nav.clipboard.writeText(text);
-                setShareError('');
-                await alert('Texto do relatório copiado para a área de transferência.');
-                return;
-            }
-            const copied = await legacyCopy();
-            if (copied) {
-                setShareError('');
-                await alert('Texto do relatório copiado para a área de transferência.');
-                return;
-            }
-        } catch (e) {
-            const msg = e?.message ? String(e.message) : String(e);
-            const copied = await legacyCopy();
-            if (copied) {
-                setShareError('');
-                await alert('Texto do relatório copiado para a área de transferência.');
-                return;
-            }
-            setShareError(msg || 'Falha ao compartilhar');
-            await alert('Seu navegador bloqueou o compartilhamento/cópia automática. Copie o texto manualmente abaixo.', 'Compartilhamento indisponível');
-            return;
-        }
-        setShareError('O compartilhamento nativo não está disponível neste navegador.');
-        await alert('Compartilhamento nativo indisponível. Copie o texto manualmente abaixo.', 'Compartilhamento indisponível');
-    };
-
-    return (
-        <>
-        <div className={embedded ? "w-full text-white" : "min-h-screen bg-neutral-900 text-white p-4 pb-safe-extra"}>
-            {!embedded && (
-                <div className="mb-4 flex items-center gap-2 sm:gap-3">
-                    <button type="button" onClick={onBack} className="cursor-pointer relative z-10 w-10 h-10 flex items-center justify-center rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 transition-all duration-300 active:scale-95"><ChevronLeft className="pointer-events-none" /></button>
-                    <div className="flex-1 min-w-0">
-                        <div className="min-w-0">
-                            <h2 className="text-xl font-black flex items-center gap-2 truncate"><History className="text-yellow-500" /> {title || 'Histórico'}</h2>
-                            <div className="text-[11px] font-bold uppercase tracking-wider text-neutral-500">{rangeLabel}</div>
-                        </div>
-                    </div>
-                    <div className="flex items-center gap-2 justify-end shrink-0">
-                        {weeklyReportCtaEnabled && !loading && historyItems.length > 0 ? (
-                            <button
-                                type="button"
-                                onClick={() => openPeriodReport('week')}
-                                className="h-9 px-3 rounded-xl font-black text-[11px] uppercase tracking-wider transition-all duration-300 active:scale-95 bg-neutral-800 border border-neutral-700 text-neutral-100 hover:bg-neutral-700"
-                            >
-                                Semanal
-                            </button>
-                        ) : null}
-                        {!isReadOnly && historyItems.length > 0 && (
-                            <button
-                                type="button"
-                                onClick={toggleSelectionMode}
-                                className={`h-9 px-3 rounded-xl font-black text-[11px] uppercase tracking-wider transition-all duration-300 active:scale-95 ${isSelectionMode ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20' : 'bg-neutral-800 border border-neutral-700 text-yellow-400 hover:bg-neutral-700'}`}
-                            >
-                                {isSelectionMode ? 'Cancelar' : 'Selecionar'}
-                            </button>
-                        )}
-                        {!isReadOnly && !isSelectionMode && (
-                            <button
-                                type="button"
-                                onClick={() => setShowManual(true)}
-                                className="cursor-pointer relative z-10 w-9 h-9 bg-yellow-500 text-black rounded-xl hover:bg-yellow-400 font-black flex items-center justify-center shadow-lg shadow-yellow-500/20 transition-all duration-300 active:scale-95"
-                            >
-                                <Plus size={16} />
-                            </button>
-                        )}
-                    </div>
-                </div>
-            )}
-
-            {embedded && (
-                <div className="flex items-center justify-end gap-2 mb-4">
-                    {!isReadOnly && historyItems.length > 0 && (
-                        <button
-                            type="button"
-                            onClick={toggleSelectionMode}
-                            className={`min-h-[44px] px-4 py-2 rounded-xl font-black text-xs uppercase tracking-wider transition-all duration-300 active:scale-95 ${isSelectionMode ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20' : 'bg-neutral-900 border border-neutral-800 text-yellow-400 hover:bg-neutral-800'}`}
-                        >
-                            {isSelectionMode ? 'Cancelar' : 'Selecionar'}
-                        </button>
-                    )}
-                    {!isReadOnly && !isSelectionMode && (
-                        <button
-                            type="button"
-                            onClick={() => setShowManual(true)}
-                            className="cursor-pointer relative z-10 min-h-[44px] px-4 py-2 bg-yellow-500 text-black rounded-xl hover:bg-yellow-400 font-black flex items-center gap-2 shadow-lg shadow-yellow-500/20 transition-all duration-300 active:scale-95"
-                        >
-                            <Plus size={16} />
-                            <span className="hidden sm:inline">Adicionar treino</span>
-                            <span className="sm:hidden">Adicionar</span>
-                        </button>
-                    )}
-                </div>
-            )}
-
-            <div className="space-y-4">
-                <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-4 shadow-lg shadow-black/30 relative overflow-hidden">
-                    <div className="absolute inset-0 bg-gradient-to-b from-yellow-500/10 via-transparent to-transparent pointer-events-none" />
-                    <div className="relative">
-                        <div className="flex items-start justify-between gap-3 flex-wrap">
-                            <div>
-                                <div className="text-[11px] uppercase tracking-wider text-neutral-500 font-bold">Resumo</div>
-                                <div className="text-base font-black tracking-tight text-white">{rangeLabel}</div>
-                            </div>
-                            <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
-                                {[
-                                    { key: '7', label: '7 dias' },
-                                    { key: '30', label: '30 dias' },
-                                    { key: '90', label: '90 dias' },
-                                    { key: 'all', label: 'Tudo' },
-                                ].map((opt) => (
-                                    <button
-                                        key={opt.key}
-                                        type="button"
-                                        onClick={() => setRange(opt.key)}
-                                        className={`min-h-[40px] px-3 rounded-full text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95 whitespace-nowrap ${range === opt.key ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20' : 'bg-neutral-950 border border-neutral-800 text-neutral-300 hover:bg-neutral-900'}`}
-                                    >
-                                        {opt.label}
-                                    </button>
-                                ))}
-                            </div>
-                        </div>
-
-                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-4">
-                            <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3">
-                                <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">Treinos</div>
-                                <div className="text-xl font-black tracking-tight text-white">{summary.count}</div>
-                            </div>
-                            <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3">
-                                <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">Tempo total</div>
-                                <div className="text-xl font-black tracking-tight text-white">{summary.totalMinutes}<span className="text-sm text-neutral-400 font-black ml-1">min</span></div>
-                            </div>
-                            <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3 col-span-2 sm:col-span-1">
-                                <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">Média</div>
-                                <div className="text-xl font-black tracking-tight text-white">{summary.avgMinutes}<span className="text-sm text-neutral-400 font-black ml-1">min</span></div>
-                            </div>
-                        </div>
-                    </div>
-                </div>
-
-                {!loading && historyItems.length > 0 && (
-                    <div className="bg-neutral-900 border border-neutral-800 rounded-2xl p-4 shadow-lg shadow-black/30">
-                        <div className="flex items-start sm:items-center justify-between gap-3 flex-wrap">
-                            <div>
-                                <div className="text-[11px] uppercase tracking-wider text-neutral-500 font-bold">Relatórios rápidos</div>
-                                <div className="text-base font-black tracking-tight text-white">Compartilhe sua evolução</div>
-                            </div>
-                            <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
-                                <button
-                                    type="button"
-                                    onClick={() => openPeriodReport('week')}
-                                    className="min-h-[44px] px-4 rounded-xl bg-yellow-500 text-black text-xs font-black uppercase tracking-wide shadow-lg shadow-yellow-500/20 hover:bg-yellow-400 transition-all duration-300 active:scale-95 w-full sm:w-auto"
-                                >
-                                    Relatório semanal
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => openPeriodReport('month')}
-                                    className="min-h-[44px] px-4 rounded-xl bg-neutral-950 border border-neutral-800 text-neutral-200 text-xs font-black uppercase tracking-wide hover:bg-neutral-900 transition-all duration-300 active:scale-95 w-full sm:w-auto"
-                                >
-                                    Relatório mensal
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {loading && (
-                    <div className="grid gap-3">
-                        {Array.from({ length: 4 }).map((_, idx) => (
-                            <div key={idx} className="bg-neutral-900 border border-neutral-800 rounded-2xl p-4 animate-pulse">
-                                <div className="h-4 bg-neutral-800 rounded w-2/3" />
-                                <div className="mt-3 h-3 bg-neutral-800 rounded w-1/2" />
-                            </div>
-                        ))}
-                    </div>
-                )}
-
-                {!loading && historyItems.length === 0 && (
-                    <div className="text-center py-10 border border-neutral-800 bg-neutral-900 rounded-2xl">
-                        <div className="text-neutral-400 font-bold">Nenhum treino finalizado ainda.</div>
-                        {!isReadOnly && (
-                            <div className="mt-4">
-                                <button
-                                    type="button"
-                                    onClick={() => setShowManual(true)}
-                                    className="min-h-[44px] px-5 py-2.5 bg-yellow-500 text-black rounded-xl hover:bg-yellow-400 font-black shadow-lg shadow-yellow-500/20 transition-all duration-300 active:scale-95"
-                                >
-                                    Adicionar primeiro treino
-                                </button>
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {!loading && historyItems.length > 0 && filteredHistory.length === 0 && (
-                    <div className="border border-neutral-800 bg-neutral-900 rounded-2xl p-4">
-                        <div className="text-white font-black">Sem treinos nesse período</div>
-                        <div className="text-sm text-neutral-400 mt-1">Tente aumentar o período para ver mais resultados.</div>
-                        <div className="mt-4 flex gap-2 flex-wrap">
-                            <button type="button" onClick={() => setRange('all')} className="min-h-[44px] px-4 py-2 rounded-xl bg-yellow-500 text-black font-black shadow-lg shadow-yellow-500/20 transition-all duration-300 active:scale-95">Ver tudo</button>
-                            <button type="button" onClick={() => setRange('90')} className="min-h-[44px] px-4 py-2 rounded-xl bg-neutral-950 border border-neutral-800 text-neutral-200 font-black transition-all duration-300 active:scale-95">Últimos 90 dias</button>
-                        </div>
-                    </div>
-                )}
-
-                {!loading && filteredHistory.length > 0 && (
-                    <div className="space-y-3 pb-24">
-                        {filteredHistory.map((session) => {
-                            const minutes = Math.floor((Number(session?.totalTime) || 0) / 60);
-                            const isSelected = selectedIds.has(session.id);
-                            return (
-                                <div
-                                    key={session.id}
-                                    onClick={() => (isSelectionMode ? toggleItemSelection(session.id) : openSession(session))}
-                                    className={`bg-neutral-900 border rounded-2xl p-4 cursor-pointer transition-all duration-300 ${isSelectionMode ? (isSelected ? 'border-yellow-500/70 shadow-lg shadow-yellow-500/10' : 'border-neutral-800 hover:border-neutral-700') : 'border-neutral-800 hover:border-yellow-500/40 hover:shadow-lg hover:shadow-black/30'}`}
-                                >
-                                    <div className="flex items-start gap-3">
-                                        {isSelectionMode && (
-                                            <div className="mt-0.5">
-                                                {isSelected ? <CheckCircle2 className="text-yellow-500 fill-yellow-500/20" /> : <Circle className="text-neutral-600" />}
-                                            </div>
-                                        )}
-
-                                        <div className="flex-1 min-w-0">
-                                            <div className="flex items-start justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <h3 className="font-black tracking-tight text-white truncate">{formatHistoryTitle(session?.workoutTitle)}</h3>
-                                                    <div className="mt-1 flex items-center gap-3 text-xs text-neutral-400 flex-wrap">
-                                                        <span className="inline-flex items-center gap-1.5">
-                                                            <CalendarDays size={14} className="text-yellow-500/70" />
-                                                            {formatCompletedAt(session?.date)}
-                                                        </span>
-                                                        <span className="inline-flex items-center gap-1.5">
-                                                            <Clock size={14} className="text-yellow-500/70" />
-                                                            {minutes} min
-                                                        </span>
-                                                    </div>
-                                                </div>
-
-                                                {!isReadOnly && !isSelectionMode && (
-                                                    <div className="flex items-center gap-2 shrink-0">
-                                                        <button
-                                                            type="button"
-                                                            onClick={(e) => handleDeleteClick(e, session)}
-                                                            className="cursor-pointer relative z-20 min-h-[44px] min-w-[44px] flex items-center justify-center rounded-xl transition-colors bg-neutral-950 text-neutral-400 border border-neutral-800 hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/20 active:scale-95"
-                                                            aria-label="Excluir"
-                                                        >
-                                                            <Trash2 size={18} className="pointer-events-none" />
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            onClick={(e) => {
-                                                                e.stopPropagation();
-                                                                openEdit(session);
-                                                            }}
-                                                            className="cursor-pointer relative z-20 min-h-[44px] min-w-[44px] flex items-center justify-center rounded-xl transition-colors bg-neutral-950 text-neutral-400 border border-neutral-800 hover:bg-yellow-500/10 hover:text-yellow-400 hover:border-yellow-500/20 active:scale-95"
-                                                            aria-label="Editar"
-                                                        >
-                                                            <Edit3 size={18} className="pointer-events-none" />
-                                                        </button>
-                                                    </div>
-                                                )}
-                                            </div>
-                                        </div>
-                                    </div>
-                                </div>
-                            );
-                        })}
-                    </div>
-                )}
-            </div>
-        </div>
-
-        {!isReadOnly && isSelectionMode && (
-            <div className="fixed bottom-0 left-0 right-0 p-4 bg-neutral-950 border-t border-neutral-800 pb-safe z-50 flex justify-between items-center">
-                <span className="text-neutral-500 text-sm font-bold">{selectedIds.size} selecionado{selectedIds.size !== 1 ? 's' : ''}</span>
-                <button 
-                    onClick={handleBulkDelete} 
-                    disabled={selectedIds.size === 0}
-                    className="px-4 py-2 bg-red-500/10 text-red-500 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50 hover:bg-red-500/20 transition-colors"
-                >
-                    <Trash2 size={18} /> Excluir
-                </button>
-            </div>
-        )}
-
-        {!isReadOnly && showManual && (
-            <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowManual(false)}>
-                <div className="bg-neutral-900 w-full max-w-2xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                    <div className="p-4 border-b border-neutral-800">
-                        <h3 className="font-bold text-white">Adicionar Histórico</h3>
-                        <div className="mt-3 flex gap-2">
-                            <button onClick={() => setManualTab('existing')} className={`px-3 py-2 rounded-lg text-xs font-bold ${manualTab==='existing'?'bg-yellow-500 text-black':'bg-neutral-800 text-neutral-300'}`}>Usar Treino</button>
-                            <button onClick={() => setManualTab('new')} className={`px-3 py-2 rounded-lg text-xs font-bold ${manualTab==='new'?'bg-yellow-500 text-black':'bg-neutral-800 text-neutral-300'}`}>Treino Novo</button>
-                        </div>
-                    </div>
-                    <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto">
-                        <div>
-                            <label className="text-[10px] uppercase font-bold text-neutral-500">Data e Hora</label>
-                            <input type="datetime-local" value={manualDate} onChange={(e)=>setManualDate(e.target.value)} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text-white outline-none" />
-                        </div>
-                        <div>
-                            <label className="text-[10px] uppercase font-bold text-neutral-500">Duração (min)</label>
-                            <input type="number" value={manualDuration} onChange={(e)=>setManualDuration(e.target.value)} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text-white outline-none" />
-                        </div>
-                        <div>
-                            <label className="text-[10px] uppercase font-bold text-neutral-500">Notas</label>
-                            <textarea value={manualNotes} onChange={(e)=>setManualNotes(e.target.value)} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text-white outline-none h-20 resize-none" />
-                        </div>
-                        {manualTab === 'existing' && (
-                            <div className="space-y-2">
-                                <label className="text-[10px] uppercase font-bold text-neutral-500">Selecionar Treino</label>
-                                <select value={selectedTemplate?.id || ''} onChange={async (e) => {
-                                    const id = e.target.value;
-                                    if (!id) { setSelectedTemplate(null); return; }
-                                    const { data } = await supabase
-                                        .from('workouts')
-                                        .select('id, name, exercises(*)')
-                                        .eq('id', id)
-                                        .single();
-                                    setSelectedTemplate(data);
-                                }} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text-white outline-none">
-                                    <option value="">Selecione...</option>
-                                    {availableWorkouts.map(t => (<option key={t.id} value={t.id}>{t.name}</option>))}
-                                </select>
-                                {selectedTemplate && (
-                                    <div className="space-y-2">
-                                        {manualExercises.map((ex,idx)=>(
-                                            <div key={idx} className="p-3 bg-neutral-800 rounded-lg border border-neutral-700 space-y-2">
-                                                <p className="text-sm font-bold text-white">{ex.name}</p>
-                                                <div className="grid grid-cols-4 gap-2">
-                                                    <div>
-                                                        <label className="text-[10px] text-neutral-500">Sets</label>
-                                                        <input type="number" value={ex.sets} onChange={(e)=>updateManualExercise(idx,'sets',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                                    </div>
-                                                    <div>
-                                                        <label className="text-[10px] text-neutral-500">Reps</label>
-                                                        <input value={ex.reps || ''} onChange={(e)=>updateManualExercise(idx,'reps',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                                    </div>
-                                                    <div>
-                                                        <label className="text-[10px] text-neutral-500">Cadência</label>
-                                                        <input value={ex.cadence || ''} onChange={(e)=>updateManualExercise(idx,'cadence',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                                    </div>
-                                                    <div>
-                                                        <label className="text-[10px] text-neutral-500">Descanso (s)</label>
-                                                        <input type="number" value={ex.restTime || 0} onChange={(e)=>updateManualExercise(idx,'restTime',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                                    </div>
-                                                </div>
-                                                        <div>
-                                                    <label className="text-[10px] text-neutral-500">Pesos por série (kg)</label>
-                                                    <div className="grid grid-cols-4 gap-2">
-                                                        {Array.from({ length: Number(ex.sets) || 0 }).map((_, sIdx) => (
-                                                            <input key={sIdx} value={ex.weights?.[sIdx] ?? ''} onChange={(e)=>updateManualExercise(idx,'weight',[sIdx, e.target.value])} className="w-full bg-neutral-900 rounded p-2 text-center text-sm text-white outline-none focus:ring-1 ring-yellow-500 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0" placeholder={`#${sIdx+1}`} />
-                                                        ))}
-                                                    </div>
-                                                </div>
-                                                <div>
-                                                    <label className="text-[10px] text-neutral-500">Reps por série</label>
-                                                    <div className="grid grid-cols-4 gap-2">
-                                                        {Array.from({ length: Number(ex.sets) || 0 }).map((_, sIdx) => (
-                                                            <input key={sIdx} value={ex.repsPerSet?.[sIdx] ?? ''} onChange={(e)=>updateManualExercise(idx,'rep',[sIdx, e.target.value])} className="w-full bg-neutral-900 rounded p-2 text-center text-sm text-white outline-none focus:ring-1 ring-yellow-500 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0" placeholder={`#${sIdx+1}`} />
-                                                        ))}
-                                                    </div>
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                            </div>
-                        )}
-						{manualTab === 'new' && (
-							<div>
-								<ExerciseEditor workout={newWorkout} onSave={setNewWorkout} onCancel={()=>{}} onChange={setNewWorkout} />
-							</div>
-						)}
-                    </div>
-                    <div className="p-4 bg-neutral-900/50 flex gap-2">
-                        <button onClick={()=>setShowManual(false)} className="flex-1 py-3 rounded-xl bg-neutral-800 text-neutral-300 font-bold hover:bg-neutral-700">Cancelar</button>
-                        {manualTab==='existing' ? (
-                            <button onClick={saveManualExisting} className="flex-1 py-3 rounded-xl bg-yellow-500 text-black font-bold hover:bg-yellow-400">Salvar</button>
-                        ) : (
-                            <button onClick={saveManualNew} className="flex-1 py-3 rounded-xl bg-yellow-500 text-black font-bold hover:bg-yellow-400">Salvar</button>
-                        )}
-                    </div>
-                </div>
-            </div>
-        )}
-
-        {periodReport && (
-            <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={closePeriodReport}>
-                <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                    <div className="p-4 border-b border-neutral-800">
-                        <div className="text-[11px] uppercase tracking-wider text-neutral-500 font-bold">Relatório de evolução</div>
-                        <div className="text-lg font-black text-white">
-                            {periodReport.type === 'week' ? 'Resumo semanal' : periodReport.type === 'month' ? 'Resumo mensal' : 'Resumo'}
-                        </div>
-                    </div>
-                    <div className="p-4 space-y-4">
-                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
-                            <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3">
-                                <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">Treinos</div>
-                                <div className="text-xl font-black tracking-tight text-white font-mono">
-                                    {Number(periodReport.stats?.count || 0)}
-                                </div>
-                            </div>
-                            <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3">
-                                <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">Tempo total (min)</div>
-                                <div className="text-xl font-black tracking-tight text-white font-mono">
-                                    {Number(periodReport.stats?.totalMinutes || 0)}
-                                </div>
-                            </div>
-                            <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3">
-                                <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">Média (min)</div>
-                                <div className="text-xl font-black tracking-tight text-white font-mono">
-                                    {Number(periodReport.stats?.avgMinutes || 0)}
-                                </div>
-                            </div>
-                            <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3">
-                                <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">Volume total (kg)</div>
-                                <div className="text-xl font-black tracking-tight text-white font-mono">
-                                    {(() => {
-                                        const v = Number(periodReport.stats?.totalVolumeKg || 0);
-                                        if (!Number.isFinite(v) || v <= 0) return '0';
-                                        return v.toLocaleString('pt-BR');
-                                    })()}
-                                </div>
-                            </div>
-                        </div>
-                        <div className="bg-neutral-950 border border-neutral-800 rounded-xl p-3 space-y-3">
-                            <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold">IA • Insights</div>
-                            {periodAi.status === 'loading' && (
-                                <div className="text-sm text-neutral-300 animate-pulse">Gerando insights com IA...</div>
-                            )}
-                            {periodAi.status === 'error' && (
-                                <div className="text-sm text-red-400">{periodAi.error || 'Falha ao gerar insights.'}</div>
-                            )}
-                            {periodAi.status === 'ready' && periodAi.ai && (
-                                <div className="space-y-3">
-                                    {Array.isArray(periodAi.ai.summary) && periodAi.ai.summary.length > 0 && (
-                                        <div>
-                                            <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Resumo</div>
-                                            <ul className="space-y-1 text-sm text-neutral-100">
-                                                {(Array.isArray(periodAi.ai.summary) ? periodAi.ai.summary : []).map((item, idx) => (
-                                                    <li key={idx}>• {String(item || '').trim()}</li>
-                                                ))}
-                                            </ul>
-                                        </div>
-                                    )}
-                                    {Array.isArray(periodAi.ai.highlights) && periodAi.ai.highlights.length > 0 && (
-                                        <div>
-                                            <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Destaques</div>
-                                            <ul className="space-y-1 text-sm text-neutral-100">
-                                                {(Array.isArray(periodAi.ai.highlights) ? periodAi.ai.highlights : []).map((item, idx) => (
-                                                    <li key={idx}>• {String(item || '').trim()}</li>
-                                                ))}
-                                            </ul>
-                                        </div>
-                                    )}
-                                    {Array.isArray(periodAi.ai.focus) && periodAi.ai.focus.length > 0 && (
-                                        <div>
-                                            <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Foco</div>
-                                            <ul className="space-y-1 text-sm text-neutral-100">
-                                                {(Array.isArray(periodAi.ai.focus) ? periodAi.ai.focus : []).map((item, idx) => (
-                                                    <li key={idx}>• {String(item || '').trim()}</li>
-                                                ))}
-                                            </ul>
-                                        </div>
-                                    )}
-                                    {Array.isArray(periodAi.ai.nextSteps) && periodAi.ai.nextSteps.length > 0 && (
-                                        <div>
-                                            <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Próximos passos</div>
-                                            <ul className="space-y-1 text-sm text-neutral-100">
-                                                {(Array.isArray(periodAi.ai.nextSteps) ? periodAi.ai.nextSteps : []).map((item, idx) => (
-                                                    <li key={idx}>• {String(item || '').trim()}</li>
-                                                ))}
-                                            </ul>
-                                        </div>
-                                    )}
-                                    {Array.isArray(periodAi.ai.warnings) && periodAi.ai.warnings.length > 0 && (
-                                        <div>
-                                            <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Atenções</div>
-                                            <ul className="space-y-1 text-sm text-yellow-400">
-                                                {(Array.isArray(periodAi.ai.warnings) ? periodAi.ai.warnings : []).map((item, idx) => (
-                                                    <li key={idx}>• {String(item || '').trim()}</li>
-                                                ))}
-                                            </ul>
-                                        </div>
-                                    )}
-                                </div>
-                            )}
-                        </div>
-                        <div>
-                            <div className="text-[10px] uppercase tracking-wider text-neutral-500 font-bold mb-1">Texto para compartilhar</div>
-                            <textarea
-                                readOnly
-                                value={buildShareText(periodReport)}
-                                className="w-full bg-neutral-950 border border-neutral-800 rounded-xl p-3 text-sm text-neutral-100 outline-none h-32 resize-none"
-                            />
-                        </div>
-                        {shareError ? (
-                            <div className="rounded-xl border border-red-500/20 bg-red-500/10 p-3 text-sm text-red-200 flex items-start justify-between gap-3">
-                                <div className="min-w-0 break-words">
-                                    <div className="font-black">Falha ao compartilhar</div>
-                                    <div className="text-xs text-red-200/90">{String(shareError).slice(0, 260)}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => {
-                                        try {
-                                            if (typeof window !== 'undefined' && typeof window.dispatchEvent === 'function') {
-                                                window.dispatchEvent(new CustomEvent('irontracks:error', {
-                                                    detail: {
-                                                        error: new Error(String(shareError)),
-                                                        source: 'period_report_share',
-                                                        meta: {
-                                                            reportType: String(periodReport?.type || ''),
-                                                            hasShare: typeof navigator !== 'undefined' && typeof navigator.share === 'function',
-                                                            hasClipboard: typeof navigator !== 'undefined' && !!navigator.clipboard,
-                                                            userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : '',
-                                                        }
-                                                    }
-                                                }));
-                                            }
-                                        } catch {}
-                                    }}
-                                    className="shrink-0 h-9 px-3 rounded-xl bg-neutral-950 border border-neutral-800 text-neutral-200 font-black hover:bg-neutral-900 transition-all duration-300 active:scale-95"
-                                >
-                                    Reportar
-                                </button>
-                            </div>
-                        ) : null}
-                        {periodPdf.status === 'error' && (
-                            <div className="rounded-xl border border-red-500/20 bg-red-500/10 p-3 text-sm text-red-200">
-                                {String(periodPdf.error || 'Falha ao gerar PDF.')}
-                            </div>
-                        )}
-                    </div>
-                    <div className="p-4 bg-neutral-900/50 flex flex-col sm:flex-row gap-2">
-                        <button
-                            type="button"
-                            onClick={closePeriodReport}
-                            className="flex-1 py-3 rounded-xl bg-neutral-800 text-neutral-300 font-bold hover:bg-neutral-700"
-                        >
-                            Fechar
-                        </button>
-                        <button
-                            type="button"
-                            onClick={downloadPeriodPdf}
-                            disabled={periodPdf.status === 'loading'}
-                            className="flex-1 py-3 rounded-xl bg-neutral-950 border border-neutral-800 text-neutral-200 font-bold hover:bg-neutral-900 disabled:opacity-60 inline-flex items-center justify-center gap-2"
-                        >
-                            {periodPdf.status === 'loading' ? <Loader2 size={18} className="animate-spin" /> : <Download size={18} />}
-                            Baixar PDF
-                        </button>
-                        <button
-                            type="button"
-                            onClick={handleShareReport}
-                            className="flex-1 py-3 rounded-xl bg-yellow-500 text-black font-bold hover:bg-yellow-400"
-                        >
-                            Compartilhar
-                        </button>
-                    </div>
-                </div>
-            </div>
-        )}
-
-        {showEdit && (
-            <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setShowEdit(false)}>
-                <div className="bg-neutral-900 w-full max-w-2xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                    <div className="p-4 border-b border-neutral-800">
-                        <h3 className="font-bold text-white">Editar Histórico</h3>
-                    </div>
-                    <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto">
-                        <div className="grid grid-cols-2 gap-2">
-                            <div>
-                                <label className="text-[10px] uppercase font-bold text-neutral-500">Título</label>
-                                <input value={editTitle} onChange={(e)=>setEditTitle(e.target.value)} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text-white outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-[10px] uppercase font-bold text-neutral-500">Duração (min)</label>
-                                <input type="number" value={editDuration} onChange={(e)=>setEditDuration(e.target.value)} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text-white outline-none" />
-                            </div>
-                        </div>
-                        <div>
-                            <label className="text-[10px] uppercase font-bold text-neutral-500">Data e Hora</label>
-                            <input type="datetime-local" value={editDate} onChange={(e)=>setEditDate(e.target.value)} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text-white outline-none" />
-                        </div>
-                        <div>
-                            <label className="text-[10px] uppercase font-bold text-neutral-500">Notas</label>
-                            <textarea value={editNotes} onChange={(e)=>setEditNotes(e.target.value)} className="w-full bg-neutral-800 border border-neutral-700 rounded-xl p-3 text.white outline-none h-20 resize-none" />
-                        </div>
-                        <div className="space-y-2">
-                            {editExercises.map((ex,idx)=>(
-                                <div key={idx} className="p-3 bg-neutral-800 rounded-lg border border-neutral-700 space-y-2">
-                                    <p className="text-sm font-bold text-white">{ex.name}</p>
-                                    <div className="grid grid-cols-4 gap-2">
-                                        <div>
-                                            <label className="text-[10px] text-neutral-500">Sets</label>
-                                            <input type="number" value={ex.sets} onChange={(e)=>updateEditExercise(idx,'sets',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                        </div>
-                                        <div>
-                                            <label className="text-[10px] text-neutral-500">Reps</label>
-                                            <input value={ex.reps || ''} onChange={(e)=>updateEditExercise(idx,'reps',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                        </div>
-                                        <div>
-                                            <label className="text-[10px] text-neutral-500">Cadência</label>
-                                            <input value={ex.cadence || ''} onChange={(e)=>updateEditExercise(idx,'cadence',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                        </div>
-                                        <div>
-                                            <label className="text-[10px] text-neutral-500">Descanso (s)</label>
-                                            <input type="number" value={ex.restTime || 0} onChange={(e)=>updateEditExercise(idx,'restTime',e.target.value)} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" />
-                                        </div>
-                                    </div>
-                                    <div>
-                                        <label className="text-[10px] text-neutral-500">Pesos por série (kg)</label>
-                                        <div className="grid grid-cols-4 gap-2">
-                                            {Array.from({ length: Number(ex.sets) || 0 }).map((_, sIdx) => (
-                                                <input key={sIdx} value={ex.weights?.[sIdx] ?? ''} onChange={(e)=>updateEditExercise(idx,'weight',[sIdx, e.target.value])} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" placeholder={`#${sIdx+1}`} />
-                                            ))}
-                                        </div>
-                                    </div>
-                                    <div>
-                                        <label className="text-[10px] text-neutral-500">Reps por série</label>
-                                        <div className="grid grid-cols-4 gap-2">
-                                            {Array.from({ length: Number(ex.sets) || 0 }).map((_, sIdx) => (
-                                                <input key={sIdx} value={ex.repsPerSet?.[sIdx] ?? ''} onChange={(e)=>updateEditExercise(idx,'rep',[sIdx, e.target.value])} className="w-full bg-neutral-900 rounded p-2 text-center text-sm" placeholder={`#${sIdx+1}`} />
-                                            ))}
-                                        </div>
-                                    </div>
-                                </div>
-                            ))}
-                        </div>
-                    </div>
-                    <div className="p-4 bg-neutral-900/50 flex gap-2">
-                        <button onClick={()=>setShowEdit(false)} className="flex-1 py-3 rounded-xl bg-neutral-800 text-neutral-300 font-bold hover:bg-neutral-700">Cancelar</button>
-                        <button onClick={saveEdit} className="flex-1 py-3 rounded-xl bg-yellow-500 text-black font-bold hover:bg-yellow-400">Salvar</button>
-                    </div>
-                </div>
-            </div>
-        )}
-        {selectedSession && (
-            <div className="fixed inset-0 z-[1200] bg-neutral-900 overflow-y-auto pt-safe" onClick={() => setSelectedSession(null)}>
-                <div onClick={(e) => e.stopPropagation()}>
-                    <WorkoutReport
-                        session={selectedSession}
-                        previousSession={null}
-                        user={user}
-                        onClose={() => setSelectedSession(null)}
-                    />
-                </div>
-            </div>
-        )}
-        </>
-    );
-};
-
-export default HistoryList;
diff --git a/_archive/duplicates/src/components/LoginScreen 2.js b/_archive/duplicates/src/components/LoginScreen 2.js
deleted file mode 100644
index 484925d..0000000
--- a/_archive/duplicates/src/components/LoginScreen 2.js	
+++ /dev/null
@@ -1,713 +0,0 @@
-'use client'
-
-import React, { useEffect, useMemo, useState } from 'react';
-import Image from 'next/image';
-import { Dumbbell, X, CheckCircle2, AlertCircle, Loader2, Mail, ArrowLeft, Lock, User, Phone, Calendar } from 'lucide-react';
-import { APP_VERSION } from '@/lib/version';
-import { createClient } from '@/utils/supabase/client';
-
-const LoginScreen = () => {
-    const [isLoading, setIsLoading] = useState(false);
-    const [errorMsg, setErrorMsg] = useState('');
-    const [recoverCooldownUntil, setRecoverCooldownUntil] = useState(0);
-    const [cooldownTick, setCooldownTick] = useState(0);
-    const [recoveryCode, setRecoveryCode] = useState('');
-    const [recoveryPassword2, setRecoveryPassword2] = useState('');
-    
-    // Auth Mode: 'login', 'signup', 'recover', 'recover_code'
-    // Default to 'login' to skip menu if Google is removed
-    const [authMode, setAuthMode] = useState('login');
-    
-    // Email Auth State
-    const [emailData, setEmailData] = useState({ 
-        email: '', 
-        password: '', 
-        confirmPassword: '',
-        fullName: '',
-        phone: '',
-        birthDate: ''
-    });
-    const [showPassword, setShowPassword] = useState(false);
-    const [rememberMe, setRememberMe] = useState(true);
-
-    // Carregar e-mail salvo
-    useEffect(() => {
-        if (typeof window !== 'undefined') {
-            const savedEmail = localStorage.getItem('it_remembered_email');
-            if (savedEmail) {
-                setEmailData(prev => ({ ...prev, email: savedEmail }));
-                setRememberMe(true);
-            }
-        }
-    }, []);
-
-    // Request Access State
-    const [showRequestModal, setShowRequestModal] = useState(false);
-    const [reqLoading, setReqLoading] = useState(false);
-    const [reqSuccess, setReqSuccess] = useState(false);
-    const [reqError, setReqError] = useState('');
-    const [formData, setFormData] = useState({
-        full_name: '',
-        email: '',
-        phone: '',
-        birth_date: ''
-    });
-
-    const getOAuthHref = (provider) => {
-        const safeProvider = String(provider || '').trim().toLowerCase() === 'apple' ? 'apple' : 'google';
-        try {
-            const url = new URL(window.location.href);
-            const fromQuery = String(url.searchParams.get('next') || '').trim();
-            const nextPath = fromQuery && fromQuery.startsWith('/') ? fromQuery : '/dashboard';
-            return `/auth/login?provider=${encodeURIComponent(safeProvider)}&next=${encodeURIComponent(nextPath)}`;
-        } catch {
-            return `/auth/login?provider=${encodeURIComponent(safeProvider)}&next=${encodeURIComponent('/dashboard')}`;
-        }
-    };
-
-    const recoverCooldownLeft = useMemo(() => {
-        if (!recoverCooldownUntil) return 0;
-        return Math.max(0, Math.ceil((recoverCooldownUntil - Date.now()) / 1000));
-    }, [recoverCooldownUntil, cooldownTick]);
-
-    useEffect(() => {
-        if (!recoverCooldownUntil) return;
-        if (recoverCooldownLeft <= 0) return;
-        const id = setInterval(() => setCooldownTick((t) => t + 1), 500);
-        return () => clearInterval(id);
-    }, [recoverCooldownUntil, recoverCooldownLeft]);
-
-    const handleGoogleLogin = async () => {
-        console.log('Iniciando login Google...');
-        setIsLoading(true);
-        setErrorMsg('');
-        
-        try {
-            const href = getOAuthHref('google');
-            console.log('Navegando para:', href);
-            window.location.assign(href);
-        } catch (error) {
-            console.error("Login Error:", error);
-            setIsLoading(false);
-            const msg = (error && error.message) ? error.message : 'Falha ao fazer login.';
-            setErrorMsg(msg);
-        }
-    };
-
-    const handleAppleLogin = async () => {
-        setIsLoading(true);
-        setErrorMsg('');
-
-        try {
-            const href = getOAuthHref('apple');
-            window.location.assign(href);
-        } catch (error) {
-            console.error("Login Error:", error);
-            setIsLoading(false);
-            const msg = (error && error.message) ? error.message : 'Falha ao fazer login.';
-            setErrorMsg(msg);
-        }
-    };
-
-    const handleEmailAuth = async (e) => {
-        e.preventDefault();
-        if (authMode === 'recover' && recoverCooldownLeft > 0) {
-            setErrorMsg(`Aguarde ${recoverCooldownLeft}s para tentar novamente.`);
-            return;
-        }
-
-        setIsLoading(true);
-        setErrorMsg('');
-
-        try {
-            const supabase = createClient();
-            const email = emailData.email.trim();
-            const password = emailData.password.trim();
-
-            if (authMode === 'login') {
-                const { error } = await supabase.auth.signInWithPassword({ email, password });
-                if (error) throw error;
-                
-                // Salvar e-mail se rememberMe estiver ativo
-                if (rememberMe) {
-                    localStorage.setItem('it_remembered_email', email);
-                } else {
-                    localStorage.removeItem('it_remembered_email');
-                }
-
-                window.location.href = '/dashboard';
-            } 
-            else if (authMode === 'signup') {
-                if (password !== emailData.confirmPassword) {
-                    throw new Error('As senhas não coincidem.');
-                }
-                
-                const cleanPhone = emailData.phone.replace(/\D/g, '');
-                if (cleanPhone.length < 10) {
-                    throw new Error('Telefone inválido (mínimo 10 dígitos com DDD).');
-                }
-
-                try {
-                    const res = await fetch('/api/access-request/create', {
-                        method: 'POST',
-                        headers: { 'Content-Type': 'application/json' },
-                        body: JSON.stringify({ 
-                            email, 
-                            full_name: emailData.fullName,
-                            phone: emailData.phone,
-                            birth_date: emailData.birthDate
-                        }),
-                    });
-                    const json = await res.json().catch(() => ({}));
-                    if (!res.ok || !json?.ok) {
-                        throw new Error(json?.error || 'Não foi possível enviar sua solicitação.');
-                    }
-                } catch (e) {
-                    throw new Error(e?.message || 'Não foi possível enviar sua solicitação.');
-                }
-
-                const { error } = await supabase.auth.signUp({
-                    email,
-                    password,
-                    options: {
-                        data: {
-                            full_name: emailData.fullName,
-                            display_name: emailData.fullName,
-                            phone: emailData.phone,
-                            birth_date: emailData.birthDate
-                        }
-                    }
-                });
-                if (error) throw error;
-
-                // Salvar e-mail se rememberMe estiver ativo
-                if (rememberMe) {
-                    localStorage.setItem('it_remembered_email', email);
-                }
-
-                // Auto login usually happens, or check email confirmation
-                window.location.href = '/wait-approval';
-            }
-            else if (authMode === 'recover') {
-                const { error } = await supabase.auth.resetPasswordForEmail(email, {
-                    redirectTo: window.location.origin + '/auth/recovery'
-                });
-                if (error) throw error;
-                setRecoverCooldownUntil(Date.now() + 60 * 1000);
-                alert('E-mail de recuperação enviado! Verifique sua caixa de entrada.');
-                setAuthMode('login');
-            }
-            else if (authMode === 'recover_code') {
-                const p2 = String(recoveryPassword2 || '').trim();
-                if (password.length < 6) throw new Error('A senha deve ter pelo menos 6 caracteres.');
-                if (password !== p2) throw new Error('As senhas não coincidem.');
-                const code = String(recoveryCode || '').trim();
-                if (!code) throw new Error('Digite o código de recuperação.');
-
-                const res = await fetch('/api/auth/recovery-code', {
-                    method: 'POST',
-                    headers: { 'Content-Type': 'application/json' },
-                    body: JSON.stringify({ email, code, password }),
-                });
-                const json = await res.json().catch(() => ({}));
-                if (!res.ok || !json?.ok) {
-                    throw new Error(json?.error || 'Código inválido.');
-                }
-
-                const { error } = await supabase.auth.signInWithPassword({ email, password });
-                if (error) throw error;
-                window.location.href = '/dashboard';
-            }
-        } catch (err) {
-            console.error("Auth Error:", err);
-            let msg = err.message || 'Erro na autenticação';
-            if (msg.includes('Invalid login')) msg = 'E-mail ou senha incorretos.';
-            if (msg.includes('User already registered')) msg = 'E-mail já cadastrado. Tente entrar ou recuperar senha.';
-            if (msg.toLowerCase().includes('email rate limit')) msg = 'Limite de e-mails excedido. Aguarde alguns minutos e tente novamente.';
-            if (msg.toLowerCase().includes('error sending recovery email')) {
-                msg = 'Falha ao enviar o e-mail de recuperação. Verifique o SMTP no Supabase (domínio verificado no Resend, sender no mesmo domínio e senha = API key re_...).';
-            }
-            setErrorMsg(msg);
-        } finally {
-            setIsLoading(false);
-        }
-    };
-
-    const handleRequestSubmit = async (e) => {
-        e.preventDefault();
-        setReqLoading(true);
-        setReqError('');
-
-        // Client-side Validation
-        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
-        // Basic BR format validation
-        // const phoneRegex = ... (removed unused regex var to avoid lint warning if desired, keeping logic)
-
-        if (!emailRegex.test(formData.email)) {
-            setReqError('Formato de e-mail inválido.');
-            setReqLoading(false);
-            return;
-        }
-
-        // Clean phone for validation check (remove non-digits)
-        const cleanPhone = formData.phone.replace(/\D/g, '');
-        if (cleanPhone.length < 10 || cleanPhone.length > 11) {
-             setReqError('Telefone inválido (DDD + Número).');
-             setReqLoading(false);
-             return;
-        }
-        
-        try {
-            const res = await fetch('/api/access-request/create', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify(formData)
-            });
-            
-            const json = await res.json();
-            
-            if (!res.ok || !json.ok) {
-                throw new Error(json.error || 'Erro ao enviar solicitação.');
-            }
-            
-            setReqSuccess(true);
-        } catch (err) {
-            setReqError(err.message || 'Erro de conexão.');
-        } finally {
-            setReqLoading(false);
-        }
-    };
-
-    const handleInputChange = (e) => {
-        const { name, value } = e.target;
-        setFormData(prev => ({ ...prev, [name]: value }));
-    };
-
-    return (
-        <div className="relative flex flex-col items-center justify-center min-h-[100dvh] overflow-hidden bg-neutral-950 text-white p-6">
-            {/* Spotlight Gradient Background */}
-            <div className="absolute inset-0 pointer-events-none">
-                <div className="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[500px] bg-amber-500/10 rounded-full blur-[120px] opacity-60" />
-                <div className="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjAwIDIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZmlsdGVyIGlkPSJub2lzZUZpbHRlciI+PGZlVHVyYnVsZW5jZSB0eXBlPSJmcmFjdGFsTm9pc2UiIGJhc2VGcmVxdWVuY3k9IjAuNjUiIG51bU9jdGF2ZXM9IjMiIHN0aXRjaFRpbGVzPSJzdGl0Y2giLz48L2ZpbHRlcj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWx0ZXI9InVybCgjbm9pc2VGaWx0ZXIpIiBvcGFjaXR5PSIwLjUiLz48L3N2Zz4=')] opacity-20 brightness-100 contrast-150 mix-blend-overlay" />
-            </div>
-
-            {/* Glassmorphism Card */}
-            <div className="relative z-10 w-full max-w-sm p-8 rounded-[2rem] border border-white/5 bg-neutral-900/40 backdrop-blur-xl shadow-2xl shadow-black/50 flex flex-col items-center transition-all duration-500">
-                
-                <div className="mb-8 p-6 bg-gradient-to-br from-yellow-500 to-amber-600 rounded-3xl shadow-[0_0_40px_-10px_rgba(245,158,11,0.5)] ring-1 ring-white/20 animate-pulse-slow">
-                    <Dumbbell size={48} className="text-black drop-shadow-md" />
-                </div>
-
-                <h1 className="text-4xl font-black mb-2 tracking-tighter italic text-center drop-shadow-lg">
-                    IRON<span className="text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-500">TRACKS</span>
-                </h1>
-                
-                <p className="text-zinc-500 mb-8 text-center text-[10px] uppercase tracking-[0.3em] font-bold">
-                    Sistema de Alta Performance • {APP_VERSION}
-                </p>
-                
-                {authMode === 'menu' && (
-                    <div className="w-full space-y-3 animate-in fade-in slide-in-from-bottom-4 duration-500">
-                        {/* Google button removed */}
-                        <button
-                            type="button"
-                            onClick={() => setAuthMode('login')}
-                            className="w-full flex items-center justify-center gap-3 bg-neutral-800/50 border border-neutral-700 text-white px-6 py-4 rounded-xl font-bold text-sm uppercase tracking-wide hover:bg-neutral-800 hover:border-yellow-500/50 transition-all"
-                        >
-                            <Mail size={20} className="text-yellow-500" />
-                            Entrar com E-mail
-                        </button>
-                    </div>
-                )}
-
-                {(authMode === 'login' || authMode === 'signup' || authMode === 'recover' || authMode === 'recover_code') && (
-                    <form onSubmit={handleEmailAuth} className="w-full space-y-4 animate-in fade-in slide-in-from-right-8 duration-300">
-                        <div className="flex items-center mb-2">
-                            <button 
-                                type="button" 
-                                onClick={() => { setAuthMode('menu'); setErrorMsg(''); }}
-                                className="p-2 -ml-2 text-neutral-400 hover:text-white transition-colors"
-                            >
-                                <ArrowLeft size={20} />
-                            </button>
-                            <span className="text-sm font-bold text-neutral-300 ml-2">
-                                {authMode === 'login' && 'Acessar com E-mail'}
-                                {authMode === 'signup' && 'Criar Nova Conta'}
-                                {authMode === 'recover' && 'Recuperar Senha'}
-                                {authMode === 'recover_code' && 'Recuperar com Código'}
-                            </span>
-                        </div>
-
-                        {authMode === 'signup' && (
-                            <div className="space-y-4">
-                                <div className="relative">
-                                    <User size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                    <input
-                                        required
-                                        type="text"
-                                        placeholder="Nome Completo"
-                                        value={emailData.fullName}
-                                        onChange={e => setEmailData({...emailData, fullName: e.target.value})}
-                                        className="w-full bg-neutral-950 border border-neutral-800 rounded-xl pl-12 pr-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                    />
-                                </div>
-
-                                <div className="grid grid-cols-2 gap-4">
-                                    <div className="relative">
-                                        <Calendar size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                        <input
-                                            required
-                                            type="date"
-                                            value={emailData.birthDate}
-                                            onChange={e => setEmailData({...emailData, birthDate: e.target.value})}
-                                            className="w-full bg-neutral-950 border border-neutral-800 rounded-xl pl-12 pr-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors text-xs"
-                                        />
-                                    </div>
-                                    <div className="relative">
-                                        <Phone size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                        <input
-                                            required
-                                            type="tel"
-                                            placeholder="(DDD) 99999-9999"
-                                            value={emailData.phone}
-                                            onChange={e => {
-                                                let val = e.target.value.replace(/\D/g, '');
-                                                if (val.length > 11) val = val.slice(0, 11);
-                                                if (val.length > 2) val = `(${val.slice(0, 2)}) ${val.slice(2)}`;
-                                                if (val.length > 9) val = `${val.slice(0, 10)}-${val.slice(10)}`;
-                                                setEmailData({...emailData, phone: val});
-                                            }}
-                                            className="w-full bg-neutral-950 border border-neutral-800 rounded-xl pl-12 pr-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors text-xs"
-                                        />
-                                    </div>
-                                </div>
-                            </div>
-                        )}
-
-                        <div className="space-y-1">
-                            <div className="relative">
-                                <Mail size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                <input
-                                        required
-                                        type="email"
-                                        placeholder="seu@email.com"
-                                        autoComplete="username"
-                                        value={emailData.email}
-                                        onChange={e => setEmailData({...emailData, email: e.target.value})}
-                                        className="w-full bg-neutral-950 border border-neutral-800 rounded-xl pl-12 pr-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                    />
-                                </div>
-                            </div>
-
-                            {authMode !== 'recover' && (
-                                <div className="space-y-4">
-                                    <div className="relative">
-                                        <Lock size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                        <input
-                                            required
-                                            type={showPassword ? "text" : "password"}
-                                            placeholder="Senha"
-                                            autoComplete={authMode === 'login' ? 'current-password' : 'new-password'}
-                                            value={emailData.password}
-                                            onChange={e => setEmailData({...emailData, password: e.target.value})}
-                                            className="w-full bg-neutral-950 border border-neutral-800 rounded-xl pl-12 pr-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                        />
-                                    </div>
-                                    
-                                    {authMode === 'signup' && (
-                                        <div className="relative">
-                                            <Lock size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                            <input
-                                                required
-                                                type={showPassword ? "text" : "password"}
-                                                placeholder="Confirmar Senha"
-                                                autoComplete="new-password"
-                                                value={emailData.confirmPassword}
-                                                onChange={e => setEmailData({...emailData, confirmPassword: e.target.value})}
-                                                className="w-full bg-neutral-950 border border-neutral-800 rounded-xl pl-12 pr-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                            />
-                                        </div>
-                                    )}
-                                </div>
-                            )}
-
-                            {authMode === 'login' && (
-                                <div className="flex items-center px-1">
-                                    <label className="flex items-center gap-2 cursor-pointer group">
-                                        <div className="relative flex items-center justify-center w-5 h-5">
-                                            <input
-                                                type="checkbox"
-                                                checked={rememberMe}
-                                                onChange={(e) => setRememberMe(e.target.checked)}
-                                                className="peer appearance-none w-5 h-5 bg-neutral-950 border border-neutral-800 rounded-md checked:bg-yellow-500 checked:border-yellow-500 transition-all cursor-pointer"
-                                            />
-                                            <div className="absolute opacity-0 peer-checked:opacity-100 pointer-events-none text-black">
-                                                <svg className="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round">
-                                                    <polyline points="20 6 9 17 4 12"></polyline>
-                                                </svg>
-                                            </div>
-                                        </div>
-                                        <span className="text-[11px] font-bold text-neutral-500 group-hover:text-neutral-300 transition-colors uppercase tracking-wider">Lembrar meu e-mail</span>
-                                    </label>
-                                </div>
-                            )}
-
-                        {authMode === 'recover_code' && (
-                            <>
-                                <div className="space-y-1">
-                                    <input
-                                        required
-                                        type={showPassword ? "text" : "password"}
-                                        placeholder="Confirmar senha"
-                                        value={recoveryPassword2}
-                                        onChange={e => setRecoveryPassword2(e.target.value)}
-                                        className="w-full bg-neutral-950 border border-neutral-800 rounded-xl px-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                        autoComplete="new-password"
-                                    />
-                                </div>
-                                <div className="space-y-1">
-                                    <input
-                                        required
-                                        type="text"
-                                        placeholder="Código de recuperação (ex: ABCD-EF12-...)"
-                                        value={recoveryCode}
-                                        onChange={e => setRecoveryCode(e.target.value)}
-                                        className="w-full bg-neutral-950 border border-neutral-800 rounded-xl px-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                        autoComplete="one-time-code"
-                                    />
-                                </div>
-                            </>
-                        )}
-
-                        <button
-                            type="submit"
-                            disabled={isLoading || (authMode === 'recover' && recoverCooldownLeft > 0)}
-                            className="w-full bg-gradient-to-r from-yellow-500 to-amber-600 text-black px-6 py-3.5 rounded-xl font-black text-lg shadow-lg hover:shadow-yellow-500/20 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
-                        >
-                            {isLoading ? <Loader2 className="animate-spin mx-auto" /> : (
-                                authMode === 'login' ? 'ENTRAR' : 
-                                authMode === 'signup' ? 'CADASTRAR' : authMode === 'recover_code' ? 'REDEFINIR SENHA' : recoverCooldownLeft > 0 ? `AGUARDE ${recoverCooldownLeft}s` : 'ENVIAR LINK'
-                            )}
-                        </button>
-
-                        {authMode === 'login' && (
-                            <button
-                                type="button"
-                                onClick={handleAppleLogin}
-                                disabled={isLoading}
-                                className="w-full flex items-center justify-center gap-3 bg-white text-black px-6 py-4 rounded-xl font-black text-sm uppercase tracking-wide hover:bg-neutral-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
-                            >
-                                <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
-                                    <path
-                                        fill="currentColor"
-                                        d="M16.365 1.43c0 1.14-.444 2.21-1.21 2.97-.84.84-2.07 1.49-3.27 1.39-.14-1.2.43-2.4 1.2-3.2.85-.88 2.3-1.53 3.28-1.16zM20.79 17.18c-.58 1.33-.85 1.92-1.6 3.1-1.04 1.62-2.5 3.65-4.31 3.67-1.61.02-2.03-1.05-4.22-1.03-2.19.01-2.65 1.05-4.26 1.02-1.81-.02-3.2-1.83-4.24-3.45-2.9-4.5-3.2-9.78-1.41-12.54 1.28-1.97 3.3-3.12 5.2-3.12 1.94 0 3.15 1.06 4.75 1.06 1.55 0 2.49-1.06 4.74-1.06 1.69 0 3.48.92 4.75 2.5-4.18 2.3-3.5 8.3.6 9.85z"
-                                    />
-                                </svg>
-                                Entrar com Apple
-                            </button>
-                        )}
-
-                        {authMode === 'login' && (
-                            <>
-                                <div className="flex justify-between items-center text-xs mt-4 px-1 relative z-20">
-                                    <button 
-                                        type="button" 
-                                        onClick={(e) => { e.preventDefault(); e.stopPropagation(); setAuthMode('recover'); setErrorMsg(''); }} 
-                                        className="text-neutral-400 hover:text-yellow-500 transition-colors cursor-pointer p-2"
-                                    >
-                                        Esqueci a senha
-                                    </button>
-                                    <button 
-                                        type="button" 
-                                        onClick={(e) => { e.preventDefault(); e.stopPropagation(); setAuthMode('signup'); setErrorMsg(''); }} 
-                                        className="text-white font-bold hover:underline cursor-pointer p-2"
-                                    >
-                                        Criar conta
-                                    </button>
-                                </div>
-
-                                {/* Migration Notice */}
-                                <div className="bg-neutral-800/50 border border-neutral-800 rounded-xl p-3 text-center relative z-20">
-                                    <p className="text-[11px] text-neutral-400 mb-2">
-                                        Já usava com Google?
-                                    </p>
-                                    <button 
-                                        type="button" 
-                                        onClick={(e) => { e.preventDefault(); e.stopPropagation(); setAuthMode('recover'); setErrorMsg(''); }}
-                                        className="text-xs font-bold text-yellow-500 hover:text-yellow-400 underline decoration-yellow-500/30 underline-offset-2 cursor-pointer p-1"
-                                    >
-                                        Crie sua senha aqui para acessar
-                                    </button>
-                                </div>
-                            </>
-                        )}
-
-                        {authMode === 'recover' && (
-                            <div className="space-y-2">
-                                <p className="text-[11px] text-neutral-500 text-center leading-relaxed px-2">
-                                    Enviaremos um link para você definir sua senha e acessar sua conta existente.
-                                </p>
-                                <button
-                                    type="button"
-                                    onClick={(e) => {
-                                        e.preventDefault();
-                                        e.stopPropagation();
-                                        setAuthMode('recover_code');
-                                        setErrorMsg('');
-                                    }}
-                                    className="w-full text-[11px] font-bold text-yellow-500 hover:text-yellow-400 underline decoration-yellow-500/30 underline-offset-2"
-                                >
-                                    Tenho um código de recuperação
-                                </button>
-                            </div>
-                        )}
-
-                        {authMode === 'recover_code' && (
-                            <div className="space-y-2">
-                                <p className="text-[11px] text-neutral-500 text-center leading-relaxed px-2">
-                                    Use um código de recuperação gerado nas configurações para redefinir sua senha sem e-mail.
-                                </p>
-                                <button
-                                    type="button"
-                                    onClick={(e) => {
-                                        e.preventDefault();
-                                        e.stopPropagation();
-                                        setAuthMode('recover');
-                                        setErrorMsg('');
-                                    }}
-                                    className="w-full text-[11px] font-bold text-neutral-300 hover:text-white underline decoration-white/20 underline-offset-2"
-                                >
-                                    Voltar para recuperação por e-mail
-                                </button>
-                            </div>
-                        )}
-                    </form>
-                )}
-
-                {errorMsg && (
-                    <div className="mt-6 p-4 bg-red-500/10 border border-red-500/20 rounded-xl w-full text-center animate-shake">
-                        <p className="text-red-400 text-xs font-bold tracking-wide break-words">{errorMsg}</p>
-                    </div>
-                )}
-
-                {/* Request Access Button (only in menu) */}
-                {authMode === 'menu' && (
-                    <button
-                        type="button"
-                        onClick={() => setShowRequestModal(true)}
-                        className="mt-6 text-xs text-neutral-400 font-bold uppercase tracking-widest hover:text-white transition-colors"
-                    >
-                        Não tem acesso? <span className="text-yellow-500 underline decoration-yellow-500/30 underline-offset-4 hover:decoration-yellow-500">Pedir agora</span>
-                    </button>
-                )}
-            </div>
-            
-            <div className="absolute bottom-6 text-[10px] text-zinc-700 font-mono tracking-widest uppercase opacity-50">
-                Exclusive Access Only
-            </div>
-
-            {/* Access Request Modal */}
-            {showRequestModal && (
-                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
-                    <div className="relative w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden">
-                        <div className="p-6 border-b border-neutral-800 flex justify-between items-center bg-neutral-900/50">
-                            <h3 className="text-lg font-black text-white italic">PEDIR ACESSO</h3>
-                            <button onClick={() => setShowRequestModal(false)} className="text-neutral-500 hover:text-white">
-                                <X size={20} />
-                            </button>
-                        </div>
-                        
-                        <div className="p-6">
-                            {reqSuccess ? (
-                                <div className="text-center py-8">
-                                    <div className="w-16 h-16 bg-emerald-500/20 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/30">
-                                        <CheckCircle2 size={32} />
-                                    </div>
-                                    <h4 className="text-xl font-bold text-white mb-2">Solicitação Enviada!</h4>
-                                    <p className="text-neutral-400 text-sm mb-6">
-                                        Recebemos seus dados. Se aprovado, você receberá um e-mail com as instruções de acesso.
-                                    </p>
-                                    <button
-                                        onClick={() => { setShowRequestModal(false); setReqSuccess(false); setFormData({full_name:'', email:'', phone:'', birth_date:''}); }}
-                                        className="w-full py-3 bg-neutral-800 hover:bg-neutral-700 text-white rounded-xl font-bold transition-colors"
-                                    >
-                                        Fechar
-                                    </button>
-                                </div>
-                            ) : (
-                                <form onSubmit={handleRequestSubmit} className="space-y-4">
-                                    {reqError && (
-                                        <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-3">
-                                            <AlertCircle size={16} className="text-red-400 shrink-0" />
-                                            <p className="text-red-300 text-xs font-bold">{reqError}</p>
-                                        </div>
-                                    )}
-
-                                    <div className="space-y-1">
-                                        <label className="text-xs font-bold text-neutral-400 uppercase">Nome Completo</label>
-                                        <input
-                                            required
-                                            name="full_name"
-                                            value={formData.full_name}
-                                            onChange={handleInputChange}
-                                            className="w-full bg-neutral-950 border border-neutral-800 rounded-xl px-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                            placeholder="Ex: João Silva"
-                                        />
-                                    </div>
-
-                                    <div className="space-y-1">
-                                        <label className="text-xs font-bold text-neutral-400 uppercase">E-mail</label>
-                                        <input
-                                            required
-                                            type="email"
-                                            name="email"
-                                            value={formData.email}
-                                            onChange={handleInputChange}
-                                            className="w-full bg-neutral-950 border border-neutral-800 rounded-xl px-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                            placeholder="seu@email.com"
-                                        />
-                                    </div>
-
-                                    <div className="grid grid-cols-2 gap-4">
-                                        <div className="space-y-1">
-                                            <label className="text-xs font-bold text-neutral-400 uppercase">Telefone</label>
-                                            <input
-                                                required
-                                                name="phone"
-                                                value={formData.phone}
-                                                onChange={handleInputChange}
-                                                className="w-full bg-neutral-950 border border-neutral-800 rounded-xl px-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                                placeholder="(11) 99999-9999"
-                                            />
-                                        </div>
-                                        <div className="space-y-1">
-                                            <label className="text-xs font-bold text-neutral-400 uppercase">Nascimento</label>
-                                            <input
-                                                required
-                                                type="date"
-                                                name="birth_date"
-                                                value={formData.birth_date}
-                                                onChange={handleInputChange}
-                                                className="w-full bg-neutral-950 border border-neutral-800 rounded-xl px-4 py-3 text-white focus:border-yellow-500 focus:outline-none transition-colors"
-                                            />
-                                        </div>
-                                    </div>
-
-                                    <button
-                                        type="submit"
-                                        disabled={reqLoading}
-                                        className="w-full mt-2 bg-yellow-500 hover:bg-yellow-400 text-black py-4 rounded-xl font-black text-sm uppercase tracking-wider flex items-center justify-center gap-2 transition-all disabled:opacity-50"
-                                    >
-                                        {reqLoading ? <Loader2 className="animate-spin" size={18} /> : 'ENVIAR SOLICITAÇÃO'}
-                                    </button>
-                                </form>
-                            )}
-                        </div>
-                    </div>
-                </div>
-            )}
-        </div>
-    );
-};
-
-export default LoginScreen;
diff --git a/_archive/duplicates/src/components/ServiceWorkerRegister 2.js b/_archive/duplicates/src/components/ServiceWorkerRegister 2.js
deleted file mode 100644
index 0fb3581..0000000
--- a/_archive/duplicates/src/components/ServiceWorkerRegister 2.js	
+++ /dev/null
@@ -1,23 +0,0 @@
-'use client'
-
-import { useEffect } from 'react'
-
-export default function ServiceWorkerRegister() {
-  useEffect(() => {
-    try {
-      if (!('serviceWorker' in navigator)) return
-      const isLocal = (() => {
-        try {
-          const h = String(window.location.hostname || '')
-          return h === 'localhost' || h === '127.0.0.1' || h.endsWith('.local')
-        } catch {
-          return false
-        }
-      })()
-      if (isLocal) return
-      navigator.serviceWorker.register('/sw.js').catch(() => null)
-    } catch {}
-  }, [])
-  return null
-}
-
diff --git a/_archive/duplicates/src/components/StoryComposer 2.tsx b/_archive/duplicates/src/components/StoryComposer 2.tsx
deleted file mode 100644
index 26a5e8c..0000000
--- a/_archive/duplicates/src/components/StoryComposer 2.tsx	
+++ /dev/null
@@ -1,1520 +0,0 @@
-'use client'
-
-import React, { useEffect, useMemo, useRef, useState, useCallback } from 'react'
-import { Share2, X, Upload, Layout, Move, Info, AlertCircle, CheckCircle2, RotateCcw, Scissors, Loader2 } from 'lucide-react'
-import { createClient } from '@/utils/supabase/client'
-// @ts-ignore
-import { getKcalEstimate } from '@/utils/calories/kcalClient'
-import { motion, AnimatePresence } from 'framer-motion'
-import VideoTrimmer from '@/components/stories/VideoTrimmer'
-import { VideoCompositor } from '@/lib/video/VideoCompositor'
-
-// --- Types ---
-
-
-// --- Types ---
-
-interface StoryComposerProps {
-  open: boolean
-  session: any // We'll refine this if possible, but keeping flexible for now to avoid breaking existing calls
-  onClose: () => void
-}
-
-interface Metrics {
-  title: string
-  date: string
-  volume: number
-  totalTime: number
-  kcal: number
-  teamCount: number
-}
-
-interface LivePosition {
-  x: number
-  y: number
-}
-
-interface LivePositions {
-  [key: string]: LivePosition
-}
-
-interface LayoutOption {
-  id: string
-  label: string
-}
-
-// --- Constants ---
-
-const CANVAS_W = 1080
-const CANVAS_H = 1920
-const SAFE_TOP = 250
-const SAFE_BOTTOM = 420
-const SAFE_SIDE = 90
-
-const STORY_LAYOUTS: LayoutOption[] = [
-  { id: 'bottom-row', label: 'Normal' },
-  { id: 'right-stack', label: 'Direita' },
-  { id: 'left-stack', label: 'Esquerda' },
-  { id: 'top-row', label: 'Topo' },
-  { id: 'live', label: 'LIVE' },
-]
-
-const DEFAULT_LIVE_POSITIONS: LivePositions = {
-  brand: { x: 0.083, y: 0.14 },
-  title: { x: 0.083, y: 0.245 },
-  subtitle: { x: 0.083, y: 0.365 },
-  cardVolume: { x: 0.083, y: 0.66 },
-  cardTempo: { x: 0.37, y: 0.66 },
-  cardKcal: { x: 0.657, y: 0.66 },
-}
-
-// --- Helpers ---
-
-const safeString = (v: any): string => {
-  try {
-    return String(v ?? '').trim()
-  } catch {
-    return ''
-  }
-}
-
-const isIOSUserAgent = (ua: string): boolean => {
-  const s = String(ua || '')
-  if (/(iPad|iPhone|iPod)/i.test(s)) return true
-  try {
-    const nav: any = typeof navigator !== 'undefined' ? navigator : null
-    if (nav && nav.platform === 'MacIntel' && Number(nav.maxTouchPoints || 0) > 1) return true
-  } catch {
-  }
-  return false
-}
-
-const pickFirstSupportedMime = (candidates: string[]): string => {
-  try {
-    return (Array.isArray(candidates) ? candidates : []).find((t) => {
-      try {
-        return !!(t && typeof (MediaRecorder as any)?.isTypeSupported === 'function' && MediaRecorder.isTypeSupported(t))
-      } catch {
-        return false
-      }
-    }) || ''
-  } catch {
-    return ''
-  }
-}
-
-const parseExt = (rawName: string): string => {
-  const n = safeString(rawName).toLowerCase()
-  const i = n.lastIndexOf('.')
-  if (i < 0) return ''
-  const ext = n.slice(i)
-  return ['.jpeg', '.jpg', '.png', '.mp4', '.mov', '.webm'].includes(ext) ? ext : ''
-}
-
-const extFromMime = (mime: string): string => {
-  const t = safeString(mime).toLowerCase()
-  if (t === 'image/png') return '.png'
-  if (t === 'image/jpeg') return '.jpg'
-  if (t === 'video/mp4') return '.mp4'
-  if (t === 'video/quicktime') return '.mov'
-  if (t === 'video/webm') return '.webm'
-  return ''
-}
-
-const guessMediaKind = (mime: string, ext: string): 'video' | 'image' | 'unknown' => {
-  const t = safeString(mime).toLowerCase()
-  if (t.startsWith('video/')) return 'video'
-  if (t.startsWith('image/')) return 'image'
-  const e = safeString(ext).toLowerCase()
-  if (['.mp4', '.mov', '.webm'].includes(e)) return 'video'
-  if (['.jpg', '.jpeg', '.png'].includes(e)) return 'image'
-  return 'unknown'
-}
-
-const formatDatePt = (v: any): string => {
-  try {
-    if (!v) return ''
-    const d = v?.toDate ? v.toDate() : v instanceof Date ? v : new Date(v)
-    if (!(d instanceof Date) || Number.isNaN(d.getTime())) return ''
-    return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' })
-  } catch {
-    return ''
-  }
-}
-
-const formatDuration = (totalSeconds: any): string => {
-  const sec = Number(totalSeconds) || 0
-  if (sec <= 0) return '0min'
-  const h = Math.floor(sec / 3600)
-  const m = Math.floor((sec % 3600) / 60)
-  if (h > 0) return `${h}h ${m}min`
-  return `${m}min`
-}
-
-const calculateTotalVolume = (logs: any): number => {
-  try {
-    if (!logs || typeof logs !== 'object') return 0
-    let total = 0
-    Object.values(logs).forEach((log: any) => {
-      const w = Number(String(log?.weight ?? '').replace(',', '.'))
-      const r = Number(String(log?.reps ?? '').replace(',', '.'))
-      if (Number.isFinite(w) && w > 0 && Number.isFinite(r) && r > 0) {
-        total += w * r
-      }
-    })
-    return total
-  } catch {
-    return 0
-  }
-}
-
-const computeKcal = ({ session, volume }: { session: any; volume: number }): number => {
-  try {
-    const existing = Number(session?.calories) || Number(session?.kcal)
-    if (Number.isFinite(existing) && existing > 0) return Math.round(existing)
-
-    const durationMin = (Number(session?.totalTime) || 0) / 60
-    if (durationMin <= 0) return 0
-
-    // Simple heuristic fallback
-    // Volume factor: 0.05 kcal per kg moved (very rough estimate)
-    // Time factor: 4 kcal per minute (moderate intensity)
-    let k = durationMin * 4
-    if (volume > 0) {
-      k += volume * 0.01
-    }
-    return Math.round(k)
-  } catch {
-    return 0
-  }
-}
-
-const fitCover = ({ canvasW, canvasH, imageW, imageH }: { canvasW: number; canvasH: number; imageW: number; imageH: number }) => {
-  const iw = Number(imageW) || 0
-  const ih = Number(imageH) || 0
-  if (iw <= 0 || ih <= 0) return { scale: 1, dw: 0, dh: 0 }
-  const coverScale = Math.max(canvasW / iw, canvasH / ih)
-  const dw = iw * coverScale
-  const dh = ih * coverScale
-  return { scale: coverScale, dw, dh }
-}
-
-const clamp01 = (n: any) => Math.max(0, Math.min(1, Number(n) || 0))
-
-const clampPctWithSize = ({ pos, size }: { pos: LivePosition; size: { w: number; h: number } }) => {
-  const px = clamp01(pos?.x)
-  const py = clamp01(pos?.y)
-  const sw = clamp01(size?.w)
-  const sh = clamp01(size?.h)
-  return {
-    x: Math.max(0, Math.min(1 - sw, px)),
-    y: Math.max(0, Math.min(1 - sh, py)),
-  }
-}
-
-const drawRoundedRect = (ctx: CanvasRenderingContext2D, x: number, y: number, w: number, h: number, r: number) => {
-  if (w < 2 * r) r = w / 2
-  if (h < 2 * r) r = h / 2
-  ctx.beginPath()
-  ctx.moveTo(x + r, y)
-  ctx.arcTo(x + w, y, x + w, y + h, r)
-  ctx.arcTo(x + w, y + h, x, y + h, r)
-  ctx.arcTo(x, y + h, x, y, r)
-  ctx.arcTo(x, y, x + w, y, r)
-  ctx.closePath()
-}
-
-// --- Canvas Logic ---
-
-const computeLiveSizes = ({ ctx, metrics }: { ctx: CanvasRenderingContext2D | null; metrics: Metrics }) => {
-  try {
-    // Default sizes if no context
-    if (!ctx) {
-      return {
-        brand: { w: 0.5, h: 0.04 },
-        title: { w: 0.7, h: 0.08 },
-        subtitle: { w: 0.8, h: 0.04 },
-        card: { w: 0.26, h: 0.07 },
-        titleLines: [],
-      }
-    }
-
-    const left = SAFE_SIDE
-    const right = CANVAS_W - SAFE_SIDE
-    const title = safeString(metrics?.title).toUpperCase()
-    const words = title.split(/\s+/).filter(Boolean)
-    const lines: string[] = []
-    let line = ''
-    
-    ctx.font = '800 34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-    for (const w of words) {
-      const candidate = line ? `${line} ${w}` : w
-      if (ctx.measureText(candidate).width <= right - left) line = candidate
-      else {
-        if (line) lines.push(line)
-        line = w
-      }
-      if (lines.length >= 2) break
-    }
-    if (line && lines.length < 2) lines.push(line)
-
-    const brandW = (() => {
-      ctx.font = 'italic 900 56px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-      const ironW = ctx.measureText('IRON').width
-      const tracksW = ctx.measureText('TRACKS').width
-      return ironW + tracksW
-    })()
-    const brandH = 56
-
-    const titleW = (() => {
-      ctx.font = '800 34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-      return Math.max(...lines.map((l) => ctx.measureText(l).width), 0)
-    })()
-    const titleH = lines.length * 40
-
-    const subtitleW = (() => {
-      ctx.font = '800 34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-      const dateText = metrics?.date ? `• ${metrics.date}` : ''
-      return ctx.measureText(`RELATÓRIO DO TREINO ${dateText}`.trim()).width
-    })()
-    const subtitleH = 34
-
-    const cardW = Math.floor((right - left - 18 * 2) / 3)
-    const cardH = 130
-
-    return {
-      brand: { w: brandW / CANVAS_W, h: brandH / CANVAS_H },
-      title: { w: titleW / CANVAS_W, h: titleH / CANVAS_H },
-      subtitle: { w: subtitleW / CANVAS_W, h: subtitleH / CANVAS_H },
-      card: { w: cardW / CANVAS_W, h: cardH / CANVAS_H },
-      titleLines: lines,
-    }
-  } catch {
-    return {
-      brand: { w: 0.5, h: 0.04 },
-      title: { w: 0.7, h: 0.08 },
-      subtitle: { w: 0.8, h: 0.04 },
-      card: { w: 0.26, h: 0.07 },
-      titleLines: [],
-    }
-  }
-}
-
-const drawStory = ({
-  ctx,
-  canvasW,
-  canvasH,
-  backgroundImage,
-  metrics,
-  layout,
-  livePositions,
-  transparentBg = false,
-  skipClear = false,
-}: {
-  ctx: CanvasRenderingContext2D
-  canvasW: number
-  canvasH: number
-  backgroundImage: HTMLImageElement | null
-  metrics: Metrics
-  layout: string
-  livePositions: LivePositions
-  transparentBg?: boolean
-  skipClear?: boolean
-}) => {
-  if (!skipClear) ctx.clearRect(0, 0, canvasW, canvasH)
-  
-  // Background
-  if (!transparentBg) {
-    ctx.fillStyle = '#000000'
-    ctx.fillRect(0, 0, canvasW, canvasH)
-
-    if (backgroundImage) {
-        const iw = Number(backgroundImage.naturalWidth) || 0
-        const ih = Number(backgroundImage.naturalHeight) || 0
-        const { scale: coverScale } = fitCover({ canvasW, canvasH, imageW: iw, imageH: ih })
-        const dw = iw * coverScale
-        const dh = ih * coverScale
-        const cx = (canvasW - dw) / 2
-        const cy = (canvasH - dh) / 2
-        ctx.drawImage(backgroundImage, cx, cy, dw, dh)
-    } else {
-        const g = ctx.createLinearGradient(0, 0, canvasW, canvasH)
-        g.addColorStop(0, '#0a0a0a')
-        g.addColorStop(1, '#111827')
-        ctx.fillStyle = g
-        ctx.fillRect(0, 0, canvasW, canvasH)
-    }
-  }
-
-  // Gradient Overlay (Always draw for readability, or maybe lighter if transparentBg?)
-  // If video, we definitely want the gradient to make text pop.
-  const baseOverlay = ctx.createLinearGradient(0, canvasH * 0.35, 0, canvasH)
-  baseOverlay.addColorStop(0, 'rgba(0,0,0,0)')
-  baseOverlay.addColorStop(1, 'rgba(0,0,0,0.78)')
-  ctx.fillStyle = baseOverlay
-  ctx.fillRect(0, 0, canvasW, canvasH)
-
-  const left = SAFE_SIDE
-  const right = canvasW - SAFE_SIDE
-  const safeBottomY = canvasH - SAFE_BOTTOM
-
-  // Team Badge
-  const teamCount = Number(metrics?.teamCount) || 0
-  if (teamCount >= 2) {
-    const label = `EQUIPE • ${teamCount}`
-    ctx.save()
-    ctx.textBaseline = 'top'
-    ctx.font = '900 24px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-    const padX = 18
-    const padY = 12
-    const textW = ctx.measureText(label).width
-    const w = Math.ceil(textW + padX * 2)
-    const h = 46
-    const x = Math.max(left, right - w)
-    const y = SAFE_TOP
-    drawRoundedRect(ctx, x, y, w, h, 18)
-    ctx.fillStyle = 'rgba(250,204,21,0.16)'
-    ctx.fill()
-    ctx.lineWidth = 2
-    ctx.strokeStyle = 'rgba(250,204,21,0.28)'
-    ctx.stroke()
-    ctx.fillStyle = '#facc15'
-    ctx.fillText(label, x + padX, y + padY)
-    ctx.restore()
-  }
-
-  const gap = 18
-  const cardH = 130
-  
-  // Helper to draw card
-  const drawCard = (box: { x: number; y: number; w: number; h: number }, card: { label: string; value: string }) => {
-    drawRoundedRect(ctx, box.x, box.y, box.w, box.h, 24)
-    ctx.fillStyle = 'rgba(0,0,0,0.62)'
-    ctx.fill()
-    ctx.lineWidth = 1.5
-    ctx.strokeStyle = 'rgba(255,255,255,0.18)'
-    ctx.stroke()
-
-    ctx.fillStyle = 'rgba(255,255,255,0.45)'
-    ctx.font = '800 22px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-    ctx.textBaseline = 'top'
-    const labelW = ctx.measureText(card.label).width
-    const labelX = box.x + (box.w - labelW) / 2
-    ctx.fillText(card.label, labelX, box.y + 24)
-
-    ctx.fillStyle = '#ffffff'
-    // Dynamic font size for value to fit
-    let valFont = 48
-    ctx.font = `800 ${valFont}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial`
-    let valW = ctx.measureText(card.value).width
-    while (valW > box.w - 20 && valFont > 24) {
-      valFont -= 2
-      ctx.font = `800 ${valFont}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial`
-      valW = ctx.measureText(card.value).width
-    }
-    const valX = box.x + (box.w - valW) / 2
-    ctx.fillText(card.value, valX, box.y + 64)
-  }
-
-  const layoutId = STORY_LAYOUTS.some((l) => l.id === layout) ? layout : 'bottom-row'
-
-  if (layoutId === 'live') {
-    const safe = livePositions && typeof livePositions === 'object' ? livePositions : DEFAULT_LIVE_POSITIONS
-    const sizes = computeLiveSizes({ ctx, metrics })
-
-    const brandPos = clampPctWithSize({ pos: safe.brand, size: sizes.brand })
-    const titlePos = clampPctWithSize({ pos: safe.title, size: sizes.title })
-    const subtitlePos = clampPctWithSize({ pos: safe.subtitle, size: sizes.subtitle })
-
-    const cardVolumePos = clampPctWithSize({ pos: safe.cardVolume, size: sizes.card })
-    const cardTempoPos = clampPctWithSize({ pos: safe.cardTempo, size: sizes.card })
-    const cardKcalPos = clampPctWithSize({ pos: safe.cardKcal, size: sizes.card })
-
-    const brandX = brandPos.x * CANVAS_W
-    const brandY = brandPos.y * CANVAS_H
-
-    ctx.textBaseline = 'top'
-    ctx.font = 'italic 900 56px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-    ctx.fillStyle = '#ffffff'
-    ctx.fillText('IRON', brandX, brandY)
-    const ironW = ctx.measureText('IRON').width
-    ctx.fillStyle = '#facc15'
-    ctx.fillText('TRACKS', brandX + ironW, brandY)
-
-    const titleX = titlePos.x * CANVAS_W
-    const titleY = titlePos.y * CANVAS_H
-    ctx.fillStyle = '#ffffff'
-    ctx.font = '800 34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-    ;(sizes.titleLines ?? []).forEach((l, idx) => {
-      ctx.fillText(l, titleX, titleY + idx * 40)
-    })
-
-    const subtitleX = subtitlePos.x * CANVAS_W
-    const subtitleY = subtitlePos.y * CANVAS_H
-    ctx.fillStyle = 'rgba(255,255,255,0.85)'
-    ctx.font = '800 34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-    const dateText = metrics?.date ? `• ${metrics.date}` : ''
-    ctx.fillText(`RELATÓRIO DO TREINO ${dateText}`.trim(), subtitleX, subtitleY)
-
-    const cards = [
-      { label: 'VOLUME', value: `${Math.round(Number(metrics?.volume) || 0).toLocaleString('pt-BR')} kg` },
-      { label: 'TEMPO', value: formatDuration(metrics?.totalTime) },
-      { label: 'KCAL', value: String(metrics?.kcal || 0) },
-    ]
-
-    const cardW = Math.floor((CANVAS_W - SAFE_SIDE * 2 - gap * 2) / 3)
-    const cardsBoxes = [
-      { x: cardVolumePos.x * CANVAS_W, y: cardVolumePos.y * CANVAS_H, w: cardW, h: cardH },
-      { x: cardTempoPos.x * CANVAS_W, y: cardTempoPos.y * CANVAS_H, w: cardW, h: cardH },
-      { x: cardKcalPos.x * CANVAS_W, y: cardKcalPos.y * CANVAS_H, w: cardW, h: cardH },
-    ]
-
-    cards.forEach((c, idx) => drawCard(cardsBoxes[idx], c))
-    return
-  }
-
-  // Standard Layouts
-  ctx.textBaseline = 'top'
-
-  const brandY = SAFE_TOP + 24
-  ctx.font = 'italic 900 56px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-  ctx.fillStyle = '#ffffff'
-  ctx.fillText('IRON', left, brandY)
-  const ironW = ctx.measureText('IRON').width
-  ctx.fillStyle = '#facc15'
-  ctx.fillText('TRACKS', left + ironW, brandY)
-
-  const title = safeString(metrics?.title).toUpperCase()
-  ctx.fillStyle = '#ffffff'
-  ctx.font = '800 34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-
-  const lines: string[] = []
-  const words = title.split(/\s+/).filter(Boolean)
-  let line = ''
-  for (const w of words) {
-    const candidate = line ? `${line} ${w}` : w
-    if (ctx.measureText(candidate).width <= right - left) line = candidate
-    else {
-      if (line) lines.push(line)
-      line = w
-    }
-    if (lines.length >= 2) break
-  }
-  if (line && lines.length < 2) lines.push(line)
-
-  const cards = [
-    { label: 'VOLUME', value: `${Math.round(Number(metrics?.volume) || 0).toLocaleString('pt-BR')} kg` },
-    { label: 'TEMPO', value: formatDuration(metrics?.totalTime) },
-    { label: 'KCAL', value: String(metrics?.kcal || 0) },
-  ]
-
-  let titleY = 0
-  let subtitleY = 0
-  let cardsBoxes: { x: number; y: number; w: number; h: number }[] = []
-
-  if (layoutId === 'top-row') {
-    titleY = Math.max(brandY + 92, SAFE_TOP + 130)
-    subtitleY = titleY + lines.length * 40 + 12
-    const cardY = subtitleY + 56
-    const cardW = Math.floor((right - left - gap * 2) / 3)
-    cardsBoxes = cards.map((_, idx) => ({
-      x: left + idx * (cardW + gap),
-      y: cardY,
-      w: cardW,
-      h: cardH,
-    }))
-  } else if (layoutId === 'right-stack' || layoutId === 'left-stack') {
-    const stackW = 360
-    const x = layoutId === 'right-stack' ? right - stackW : left
-    const totalH = cardH * 3 + gap * 2
-    const cardY0 = safeBottomY - 24 - totalH
-    cardsBoxes = cards.map((_, idx) => ({
-      x,
-      y: cardY0 + idx * (cardH + gap),
-      w: stackW,
-      h: cardH,
-    }))
-    subtitleY = cardsBoxes[0].y - 56
-    titleY = Math.max(brandY + 92, subtitleY - 24 - lines.length * 40)
-  } else {
-    // bottom-row
-    const cardY = safeBottomY - 24 - cardH
-    subtitleY = cardY - 56
-    titleY = Math.max(brandY + 92, subtitleY - 24 - lines.length * 40)
-    const cardW = Math.floor((right - left - gap * 2) / 3)
-    cardsBoxes = cards.map((_, idx) => ({
-      x: left + idx * (cardW + gap),
-      y: cardY,
-      w: cardW,
-      h: cardH,
-    }))
-  }
-
-  lines.forEach((l, idx) => {
-    ctx.fillText(l, left, titleY + idx * 40)
-  })
-
-  ctx.fillStyle = 'rgba(255,255,255,0.85)'
-  ctx.font = '800 34px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial'
-  const dateText = metrics?.date ? `• ${metrics.date}` : ''
-  ctx.fillText(`RELATÓRIO DO TREINO ${dateText}`.trim(), left, subtitleY)
-
-  cards.forEach((c, idx) => drawCard(cardsBoxes[idx], c))
-}
-
-// --- Component ---
-
-export default function StoryComposer({ open, session, onClose }: StoryComposerProps) {
-  const overlayRef = useRef<HTMLDivElement>(null)
-  const previewRef = useRef<HTMLDivElement>(null)
-  const previewCanvasRef = useRef<HTMLCanvasElement>(null)
-  const inputRef = useRef<HTMLInputElement>(null)
-  const videoRef = useRef<HTMLVideoElement>(null)
-  const scrollAreaRef = useRef<HTMLDivElement>(null)
-
-  const [selectedFile, setSelectedFile] = useState<File | null>(null)
-  const [mediaKind, setMediaKind] = useState<'image' | 'video'>('image')
-  const [backgroundUrl, setBackgroundUrl] = useState('')
-  const [backgroundImage, setBackgroundImage] = useState<HTMLImageElement | null>(null)
-  const [busy, setBusy] = useState(false)
-  const [busyAction, setBusyAction] = useState<'post' | 'share' | null>(null)
-  const [isExporting, setIsExporting] = useState(false)
-  const [error, setError] = useState('')
-  const [info, setInfo] = useState('')
-  const [showSafeGuide, setShowSafeGuide] = useState(true)
-  const [layout, setLayout] = useState('bottom-row')
-  const [livePositions, setLivePositions] = useState<LivePositions>(DEFAULT_LIVE_POSITIONS)
-  const [kcalEstimate, setKcalEstimate] = useState(0)
-  const [draggingKey, setDraggingKey] = useState<string | null>(null)
-  const dragRef = useRef({ key: null as string | null, pointerId: null as number | null, startX: 0, startY: 0, startPos: { x: 0, y: 0 } })
-  const [mediaLoadIdRef] = useState({ current: 0 })
-  const backgroundUrlRef = useRef('')
-  
-  // Trimming State
-  const [showTrimmer, setShowTrimmer] = useState(false)
-  const [videoDuration, setVideoDuration] = useState(0)
-  const [trimRange, setTrimRange] = useState<[number, number]>([0, 60])
-  const [previewTime, setPreviewTime] = useState(0)
-
-  useEffect(() => {
-    backgroundUrlRef.current = backgroundUrl
-  }, [backgroundUrl])
-
-  // Compute Metrics
-  const metrics: Metrics = useMemo(() => {
-    const title = safeString(session?.workoutTitle || session?.name || 'Treino')
-    const date = formatDatePt(session?.date || session?.completed_at || session?.completedAt || session?.created_at)
-    const logs = session?.logs && typeof session.logs === 'object' ? session.logs : {}
-    const volume = calculateTotalVolume(logs)
-    const totalTime = Number(session?.totalTime) || 0
-    const kcal = Number.isFinite(Number(kcalEstimate)) && Number(kcalEstimate) > 0 ? Number(kcalEstimate) : computeKcal({ session, volume })
-    const teamCountRaw = session?.team?.participantsCount ?? session?.teamParticipantsCount ?? session?.teamSessionParticipantsCount
-    const teamCount = Number(teamCountRaw)
-    return {
-      title,
-      date,
-      volume,
-      totalTime,
-      kcal,
-      teamCount: Number.isFinite(teamCount) ? teamCount : 0,
-    }
-  }, [session, kcalEstimate])
-
-  // Fetch Kcal if needed
-  useEffect(() => {
-    if (!open) return
-    if (!session) return
-    let cancelled = false
-    ;(async () => {
-      try {
-        const kcal = await getKcalEstimate({ session, workoutId: session?.id ?? null })
-        if (cancelled) return
-        if (Number.isFinite(Number(kcal)) && Number(kcal) > 0) setKcalEstimate(Math.round(Number(kcal)))
-      } catch {
-        // silent fail
-      }
-    })()
-    return () => {
-      cancelled = true
-    }
-  }, [open, session])
-
-  // Pre-calculate sizes for LIVE layout interaction
-  const liveSizes = useMemo(() => {
-    try {
-      if (typeof window === 'undefined') return computeLiveSizes({ ctx: null, metrics })
-      const c = document.createElement('canvas')
-      const ctx = c.getContext('2d')
-      if (!ctx) return computeLiveSizes({ ctx: null, metrics })
-      return computeLiveSizes({ ctx, metrics })
-    } catch {
-      return computeLiveSizes({ ctx: null, metrics })
-    }
-  }, [metrics])
-
-  // Compositor Ref
-  const compositorRef = useRef<VideoCompositor | null>(null)
-
-  // Reset state on open/close
-  useEffect(() => {
-    if (!open) {
-      if (compositorRef.current) {
-        compositorRef.current.cancel()
-        compositorRef.current = null
-      }
-      try {
-        const url = String(backgroundUrlRef.current || '')
-        if (url) URL.revokeObjectURL(url)
-      } catch {}
-      setBackgroundUrl('')
-      setBackgroundImage(null)
-      setSelectedFile(null)
-      setMediaKind('image')
-      setError('')
-      setInfo('')
-      setBusy(false)
-      setBusyAction(null)
-      setShowSafeGuide(true)
-      setLivePositions(DEFAULT_LIVE_POSITIONS)
-      setDraggingKey(null)
-      dragRef.current = { key: null, pointerId: null, startX: 0, startY: 0, startPos: { x: 0, y: 0 } }
-      try {
-        if (inputRef?.current) inputRef.current.value = ''
-      } catch {}
-      return
-    }
-    setError('')
-    setInfo('')
-    setBusy(false)
-    setBusyAction(null)
-    setShowSafeGuide(true)
-    setLivePositions(DEFAULT_LIVE_POSITIONS)
-    setDraggingKey(null)
-    dragRef.current = { key: null, pointerId: null, startX: 0, startY: 0, startPos: { x: 0, y: 0 } }
-    setSelectedFile(null)
-    setMediaKind('image')
-    setBackgroundUrl('')
-    setBackgroundImage(null)
-    setShowTrimmer(false)
-    setVideoDuration(0)
-    setTrimRange([0, 60])
-    try {
-      if (inputRef?.current) inputRef.current.value = ''
-    } catch {}
-  }, [open])
-
-  // Lock scroll
-  useEffect(() => {
-    if (!open) return
-
-    const scrollY = window.scrollY
-    const originalStyle = {
-      position: document.body.style.position,
-      top: document.body.style.top,
-      width: document.body.style.width,
-      overflow: document.body.style.overflow,
-    }
-
-    document.body.style.position = 'fixed'
-    document.body.style.top = `-${scrollY}px`
-    document.body.style.width = '100%'
-    document.body.style.overflow = 'hidden'
-
-    return () => {
-      document.body.style.position = originalStyle.position
-      document.body.style.top = originalStyle.top
-      document.body.style.width = originalStyle.width
-      document.body.style.overflow = originalStyle.overflow
-      window.scrollTo(0, scrollY)
-    }
-  }, [open])
-
-  // Prevent gestures
-  useEffect(() => {
-    if (!open) return
-    const prevent = (e: Event) => {
-      try {
-        e.preventDefault()
-      } catch {
-      }
-    }
-    document.addEventListener('gesturestart', prevent, { passive: false })
-    document.addEventListener('gesturechange', prevent, { passive: false })
-    document.addEventListener('gestureend', prevent, { passive: false })
-    return () => {
-      document.removeEventListener('gesturestart', prevent)
-      document.removeEventListener('gesturechange', prevent)
-      document.removeEventListener('gestureend', prevent)
-    }
-  }, [open])
-
-  // Cleanup blob
-  useEffect(() => {
-    return () => {
-      try {
-        if (backgroundUrl) URL.revokeObjectURL(backgroundUrl)
-      } catch {
-      }
-    }
-  }, [backgroundUrl])
-
-  const loadMedia = async (file: File | null) => {
-    try {
-      setError('')
-      setInfo('')
-      if (!file) return
-      const loadId = (mediaLoadIdRef.current || 0) + 1
-      mediaLoadIdRef.current = loadId
-      const rawName = safeString(file?.name).toLowerCase()
-      const ext = parseExt(rawName) || extFromMime(file?.type)
-      const kind = guessMediaKind(file?.type, ext)
-      if (kind !== 'image' && kind !== 'video') {
-        setError('Formato não suportado. Use JPG/PNG ou MP4/MOV/WEBM.')
-        return
-      }
-      if (kind === 'video' && (ext === '.webm' || String(file?.type || '').toLowerCase() === 'video/webm')) {
-        setError('Formato WEBM pode não rodar no Safari. Prefira MP4/MOV.')
-        return
-      }
-      setInfo('Carregando mídia…')
-      const url = URL.createObjectURL(file)
-      try {
-        if (backgroundUrl) URL.revokeObjectURL(backgroundUrl)
-      } catch {
-      }
-      setSelectedFile(file)
-      setMediaKind(kind)
-      setBackgroundUrl(url)
-      if (kind === 'video') {
-        setBackgroundImage(null)
-        setInfo('')
-        
-        // Load video metadata to set defaults
-        const v = document.createElement('video')
-        v.preload = 'metadata'
-        v.onloadedmetadata = () => {
-             const dur = v.duration || 0
-             setVideoDuration(dur)
-             setTrimRange([0, Math.min(dur, 60)])
-        }
-        v.src = url
-        return
-      }
-      const img = new Image()
-      img.crossOrigin = 'anonymous'
-      await new Promise((resolve, reject) => {
-        img.onload = resolve
-        img.onerror = reject
-        img.src = url
-      })
-      if (!open) return
-      if (mediaLoadIdRef.current !== loadId) return
-      setBackgroundImage(img)
-      setInfo('')
-    } catch {
-      setError('Não foi possível carregar a mídia.')
-      setInfo('')
-    }
-  }
-
-  // --- Interaction (LIVE Layout) ---
-
-  const getSizeForKey = (key: string) => {
-    if (key === 'brand') return liveSizes?.brand ?? { w: 0.5, h: 0.05 }
-    if (key === 'title') return liveSizes?.title ?? { w: 0.7, h: 0.08 }
-    if (key === 'subtitle') return liveSizes?.subtitle ?? { w: 0.8, h: 0.05 }
-    return liveSizes?.card ?? { w: 0.26, h: 0.08 }
-  }
-
-  const onPiecePointerDown = (key: string, e: React.PointerEvent) => {
-    try {
-      if (layout !== 'live') return
-      if (!key) return
-      if (!e?.currentTarget) return
-      // @ts-ignore
-      if (typeof e?.pointerId !== 'number') return
-      e.preventDefault?.()
-      e.stopPropagation?.()
-      const startPos = livePositions?.[key] ?? DEFAULT_LIVE_POSITIONS?.[key] ?? { x: 0.1, y: 0.1 }
-      // @ts-ignore
-      dragRef.current = { key, pointerId: e.pointerId, startX: e.clientX, startY: e.clientY, startPos }
-      setDraggingKey(key)
-      // @ts-ignore
-      e.currentTarget?.setPointerCapture?.(e.pointerId)
-    } catch {
-    }
-  }
-
-  const onPiecePointerMove = (key: string, e: React.PointerEvent) => {
-    try {
-      if (layout !== 'live') return
-      const activeKey = dragRef.current?.key
-      const activePointerId = dragRef.current?.pointerId
-      if (!activeKey || activeKey !== key) return
-      if (typeof activePointerId !== 'number') return
-      // @ts-ignore
-      if (e?.pointerId !== activePointerId) return
-      const preview = previewRef.current
-      const rect = preview?.getBoundingClientRect?.()
-      if (!rect?.width || !rect?.height) return
-      e.preventDefault?.()
-      e.stopPropagation?.()
-      const dxPct = (Number(e.clientX) - Number(dragRef.current?.startX || 0)) / rect.width
-      const dyPct = (Number(e.clientY) - Number(dragRef.current?.startY || 0)) / rect.height
-      const startPos = dragRef.current?.startPos ?? { x: 0, y: 0 }
-      const nextPos = { x: (Number(startPos.x) || 0) + dxPct, y: (Number(startPos.y) || 0) + dyPct }
-      const size = getSizeForKey(key)
-      const clamped = clampPctWithSize({ pos: nextPos, size })
-      setLivePositions((prev) => ({ ...(prev ?? DEFAULT_LIVE_POSITIONS), [key]: clamped }))
-    } catch {
-    }
-  }
-
-  const onPiecePointerUp = (key: string, e: React.PointerEvent) => {
-    try {
-      const activeKey = dragRef.current?.key
-      const activePointerId = dragRef.current?.pointerId
-      if (!activeKey || activeKey !== key) return
-      if (typeof activePointerId !== 'number') return
-      // @ts-ignore
-      if (e?.pointerId !== activePointerId) return
-      e.preventDefault?.()
-      e.stopPropagation?.()
-      // @ts-ignore
-      e.currentTarget?.releasePointerCapture?.(activePointerId)
-      dragRef.current = { key: null, pointerId: null, startX: 0, startY: 0, startPos: { x: 0, y: 0 } }
-      setDraggingKey(null)
-    } catch {
-    }
-  }
-
-  const livePieces = useMemo(() => {
-    return [
-      { key: 'brand', label: 'IRONTRACKS' },
-      { key: 'title', label: 'TREINO' },
-      { key: 'subtitle', label: 'RELATÓRIO' },
-      { key: 'cardVolume', label: 'VOLUME' },
-      { key: 'cardTempo', label: 'TEMPO' },
-      { key: 'cardKcal', label: 'KCAL' },
-    ]
-  }, [])
-
-  const onSelectLayout = (nextLayout: string) => {
-    try {
-      const value = safeString(nextLayout)
-      setLayout(value || 'bottom-row')
-      setDraggingKey(null)
-      dragRef.current = { key: null, pointerId: null, startX: 0, startY: 0, startPos: { x: 0, y: 0 } }
-    } catch {
-      setLayout('bottom-row')
-    }
-  }
-
-  // Draw loop
-  useEffect(() => {
-    if (!open) return
-    const canvas = previewCanvasRef.current
-    if (!canvas) return
-    const ctx = canvas.getContext('2d')
-    if (!ctx) return
-    // if (mediaKind === 'video') return // Removed to allow drawing overlay on video
-    let raf = 0
-    const draw = () => {
-      drawStory({ 
-        ctx, 
-        canvasW: CANVAS_W, 
-        canvasH: CANVAS_H, 
-        backgroundImage, 
-        metrics, 
-        layout, 
-        livePositions,
-        transparentBg: mediaKind === 'video' 
-      })
-    }
-    // Only animate if LIVE and dragging, otherwise draw once to save battery
-    if (layout === 'live' && draggingKey) {
-        raf = requestAnimationFrame(draw)
-    } else {
-        draw()
-    }
-    return () => cancelAnimationFrame(raf)
-  }, [open, backgroundImage, layout, livePositions, mediaKind, metrics, draggingKey])
-
-  const renderVideo = async (): Promise<{ blob: Blob; filename: string; mime: string }> => {
-    if (!videoRef.current) throw new Error('Vídeo não disponível')
-    
-    // Initialize compositor
-    compositorRef.current = new VideoCompositor()
-    
-    try {
-        const result = await compositorRef.current.render({
-            videoElement: videoRef.current,
-            trimRange,
-            outputWidth: CANVAS_W,
-            outputHeight: CANVAS_H,
-            fps: 30,
-            onDrawFrame: (ctx, video) => {
-                const vw = video.videoWidth
-                const vh = video.videoHeight
-                if (!vw || !vh) return
-
-                const { scale } = fitCover({ canvasW: CANVAS_W, canvasH: CANVAS_H, imageW: vw, imageH: vh })
-                const dw = vw * scale
-                const dh = vh * scale
-                const cx = (CANVAS_W - dw) / 2
-                const cy = (CANVAS_H - dh) / 2
-                
-                ctx.drawImage(video, cx, cy, dw, dh)
-                
-                drawStory({ 
-                    ctx, 
-                    canvasW: CANVAS_W, 
-                    canvasH: CANVAS_H, 
-                    backgroundImage: null, 
-                    metrics, 
-                    layout, 
-                    livePositions, 
-                    transparentBg: true, 
-                    skipClear: true 
-                })
-            }
-        })
-        return result
-    } catch (e) {
-        console.error('Render failed', e)
-        throw e
-    } finally {
-        compositorRef.current = null
-    }
-  }
-
-  const createImageBlob = async ({ type = 'jpg', quality = 0.95 }): Promise<{ blob: Blob; filename: string; mime: string }> => {
-    if (mediaKind === 'video') {
-      return renderVideo()
-    }
-
-    const canvas = document.createElement('canvas')
-    canvas.width = CANVAS_W
-    canvas.height = CANVAS_H
-    const ctx = canvas.getContext('2d')
-    if (!ctx) throw new Error('canvas_error')
-
-    // If image is loaded, use it
-    if (mediaKind === 'image') {
-        // drawStory already handles this
-    }
-
-    drawStory({ ctx, canvasW: CANVAS_W, canvasH: CANVAS_H, backgroundImage: mediaKind === 'image' ? backgroundImage : null, metrics, layout, livePositions })
-    
-    // If video, we tried to draw the frame above.
-    
-    const mime = type === 'png' ? 'image/png' : 'image/jpeg'
-    const ext = type === 'png' ? 'png' : 'jpg'
-    const filename = `irontracks-story-${Date.now()}.${ext}`
-
-    return new Promise((resolve, reject) => {
-      canvas.toBlob(
-        (blob) => {
-          if (blob) resolve({ blob, filename, mime })
-          else reject(new Error('blob_failed'))
-        },
-        mime,
-        quality
-      )
-    })
-  }
-
-  const downloadBlob = (blob: Blob, filename: string) => {
-    const url = URL.createObjectURL(blob)
-    const a = document.createElement('a')
-    a.href = url
-    a.download = filename
-    document.body.appendChild(a)
-    a.click()
-    a.remove()
-    setTimeout(() => {
-      try {
-        URL.revokeObjectURL(url)
-      } catch {
-      }
-    }, 1000)
-  }
-
-  const shareImage = async () => {
-    setBusy(true)
-    setBusyAction('share')
-    setError('')
-    setInfo('')
-    try {
-      const result = await createImageBlob({ type: 'jpg' })
-      const file = new File([result.blob], result.filename, { type: result.mime })
-      
-      let shared = false
-      if (typeof navigator.share === 'function' && navigator.canShare && navigator.canShare({ files: [file] })) {
-        try {
-          await navigator.share({ files: [file], title: 'Story IronTracks' })
-          shared = true
-        } catch (shareErr: any) {
-          const name = String(shareErr?.name || '').trim()
-          // If user cancelled, stop here
-          if (name === 'AbortError') {
-             setBusy(false)
-             setBusyAction(null)
-             return
-          }
-          // If not allowed or other error, fall through to download
-          console.warn('Share API failed, falling back to download:', shareErr)
-        }
-      }
-
-      if (!shared) {
-        downloadBlob(result.blob, result.filename)
-        setInfo('Baixado com sucesso!')
-      }
-    } catch (e: any) {
-      const name = String(e?.name || '').trim()
-      if (name === 'AbortError') return
-      const msg = String(e?.message || '').trim()
-      setError(msg || 'Não foi possível compartilhar.')
-    } finally {
-      setBusy(false)
-      setBusyAction(null)
-    }
-  }
-
-  const postToIronTracks = async () => {
-    setBusy(true)
-    setBusyAction('post')
-    setError('')
-    setInfo('')
-    try {
-      const supabase = createClient()
-      const { data: authData } = await supabase.auth.getUser()
-      const uid = String(authData?.user?.id || '').trim()
-      if (!uid) throw new Error('unauthorized')
-
-      let path = ''
-      let meta: any = {}
-      
-      if (mediaKind === 'video') {
-        if (!selectedFile) throw new Error('Selecione um vídeo primeiro.')
-        const maxBytes = 200 * 1024 * 1024
-        if (Number(selectedFile.size) > maxBytes) throw new Error('Vídeo muito grande (máx 200MB).')
-        
-        // Renderiza vídeo com layout
-        const { blob, mime } = await createImageBlob({})
-        if (blob.size > maxBytes) throw new Error('Vídeo renderizado muito grande (máx 200MB).')
-        if (String(mime || '').toLowerCase().includes('webm')) {
-          const ua = typeof navigator !== 'undefined' ? String(navigator.userAgent || '') : ''
-          if (isIOSUserAgent(ua)) throw new Error('No iPhone, o vídeo com layout precisa ser MP4. Atualize o iOS/Safari ou poste via desktop.')
-        }
-
-        const ext = mime.includes('mp4') ? '.mp4' : '.webm'
-        const storyId = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`
-        path = `${uid}/stories/${storyId}${ext}`
-        const signResp = await fetch('/api/storage/social-stories/signed-upload', {
-          method: 'POST',
-          headers: { 'content-type': 'application/json' },
-          body: JSON.stringify({ path }),
-        })
-        const signJson = await signResp.json().catch(() => null)
-        if (!signResp.ok || !signJson?.ok || !signJson?.token) throw new Error(String(signJson?.error || 'Falha ao preparar upload'))
-        const { error: upErr } = await supabase.storage
-          .from('social-stories')
-          .uploadToSignedUrl(path, String(signJson.token), blob, { contentType: mime })
-        if (upErr) throw upErr
-        
-        meta = {
-            title: String(metrics?.title || ''),
-            dateText: String(metrics?.date || ''),
-            durationSeconds: Number(metrics?.totalTime || 0),
-            totalVolumeKg: Number(metrics?.volume || 0),
-            kcal: Number(metrics?.kcal || 0),
-            layout: String(layout || ''),
-            mediaKind: 'video',
-        }
-      } else {
-        // Image
-        const result = await createImageBlob({ type: 'jpg', quality: 0.92 })
-        const storyId = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`
-        path = `${uid}/stories/${storyId}.jpg`
-        const signResp = await fetch('/api/storage/social-stories/signed-upload', {
-            method: 'POST',
-            headers: { 'content-type': 'application/json' },
-            body: JSON.stringify({ path }),
-          })
-          const signJson = await signResp.json().catch(() => null)
-          if (!signResp.ok || !signJson?.ok || !signJson?.token) throw new Error(String(signJson?.error || 'Falha ao preparar upload'))
-          const { error: upErr } = await supabase.storage
-            .from('social-stories')
-            .uploadToSignedUrl(path, String(signJson.token), result.blob, { contentType: result.mime })
-          if (upErr) throw upErr
-          meta = {
-            title: String(metrics?.title || ''),
-            dateText: String(metrics?.date || ''),
-            durationSeconds: Number(metrics?.totalTime || 0),
-            totalVolumeKg: Number(metrics?.volume || 0),
-            kcal: Number(metrics?.kcal || 0),
-            layout: String(layout || ''),
-            mediaKind: 'image',
-          }
-      }
-
-      const createResp = await fetch('/api/social/stories/create', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ mediaPath: path, caption: String(metrics?.title || ''), meta }),
-      })
-      const createJson = await createResp.json().catch(() => null)
-      if (!createResp.ok || !createJson?.ok) throw new Error(String(createJson?.error || 'Falha ao publicar'))
-      
-      setInfo('Publicado no IronTracks!')
-      try {
-        window.dispatchEvent(new Event('irontracks:stories:refresh'))
-      } catch {
-      }
-      try {
-        window.setTimeout(() => onClose?.(), 1000)
-      } catch {}
-
-    } catch (err: any) {
-      console.error(err)
-      const msg = String(err?.message || '').trim()
-      setError(msg || 'Falha ao publicar story.')
-    } finally {
-      setBusy(false)
-      setBusyAction(null)
-    }
-  }
-
-  if (!open) return null
-
-  const isVideo = mediaKind === 'video'
-
-  return (
-    <AnimatePresence>
-    {open && (
-    <motion.div
-      initial={{ opacity: 0 }}
-      animate={{ opacity: 1 }}
-      exit={{ opacity: 0 }}
-      className="fixed inset-0 z-[2500] bg-black/95 backdrop-blur-md flex flex-col items-center justify-center sm:p-4"
-    >
-        {/* Mobile Header / Close */}
-        <div className="flex-none px-4 pb-4 pt-14 flex justify-between items-start w-full max-w-md mx-auto sm:hidden bg-transparent border-b border-neutral-800/50">
-            <div className="text-white min-w-0 flex-1 mr-4">
-                <h3 className="font-bold text-lg truncate leading-tight">{metrics.title || 'Story Composer'}</h3>
-                <p className="text-[10px] text-neutral-400 font-bold uppercase tracking-wider mt-1">COMPARTILHE SUA CONQUISTA</p>
-            </div>
-            <button
-              onClick={onClose}
-              className="w-8 h-8 rounded-full bg-neutral-800 text-neutral-400 flex items-center justify-center hover:bg-neutral-700 transition-colors flex-none"
-            >
-              <X size={16} />
-            </button>
-        </div>
-
-      <motion.div
-        initial={{ y: 20, scale: 0.95 }}
-        animate={{ y: 0, scale: 1 }}
-        exit={{ y: 20, scale: 0.95 }}
-        className="w-full h-full sm:h-auto sm:max-h-[90vh] sm:max-w-5xl bg-black sm:bg-neutral-900 sm:border border-neutral-800 sm:rounded-3xl shadow-2xl overflow-hidden flex flex-col"
-      >
-        {/* Desktop Header */}
-        <div className="hidden sm:flex px-6 py-5 border-b border-neutral-800 items-center justify-between flex-none bg-neutral-900">
-            <div>
-                <h2 className="font-bold text-white text-xl">{metrics.title || 'Story Composer'}</h2>
-                <p className="text-xs text-neutral-400 font-bold uppercase tracking-wider mt-1">COMPARTILHE SUA CONQUISTA</p>
-            </div>
-            <button
-              onClick={onClose}
-              className="w-9 h-9 rounded-full bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-white flex items-center justify-center transition-colors"
-            >
-              <X size={18} />
-            </button>
-        </div>
-
-        <div ref={scrollAreaRef} className="flex-1 overflow-y-auto overscroll-contain min-h-0 bg-black sm:bg-transparent">
-          <div className="p-4 sm:p-8 flex flex-col lg:flex-row gap-8 h-full max-w-5xl mx-auto items-center lg:items-start">
-            
-            {/* Preview Column */}
-            <div className="flex-none flex flex-col items-center gap-6">
-              <div
-                ref={previewRef}
-                className="relative w-full max-w-[300px] sm:max-w-[340px] aspect-[9/16] rounded-3xl overflow-hidden border border-neutral-800 bg-neutral-900 shadow-2xl ring-1 ring-white/10 shrink-0"
-              >
-                {isVideo && (
-                  <video
-                    key={backgroundUrl || 'no-video'}
-                    ref={videoRef}
-                    crossOrigin="anonymous"
-                    src={backgroundUrl || undefined}
-                    className="absolute inset-0 w-full h-full object-cover bg-black"
-                    controls={false}
-                    playsInline
-                    muted
-                    autoPlay
-                    loop
-                  />
-                )}
-                
-                <canvas
-                    ref={previewCanvasRef}
-                    width={CANVAS_W}
-                    height={CANVAS_H}
-                    className="absolute inset-0 w-full h-full object-contain pointer-events-none"
-                />
-
-                {showSafeGuide && (
-                  <div className="absolute inset-0 pointer-events-none z-10">
-                    <div
-                      className="absolute border border-yellow-500/20 rounded-3xl border-dashed"
-                      style={{
-                        left: `${(SAFE_SIDE / CANVAS_W) * 100}%`,
-                        right: `${(SAFE_SIDE / CANVAS_W) * 100}%`,
-                        top: `${(SAFE_TOP / CANVAS_H) * 100}%`,
-                        bottom: `${(SAFE_BOTTOM / CANVAS_H) * 100}%`,
-                      }}
-                    />
-                  </div>
-                )}
-
-                {layout === 'live' && (
-                  <div className="absolute inset-0 pointer-events-none z-20">
-                    {livePieces.map((p) => {
-                      const pos = livePositions?.[p.key] ?? DEFAULT_LIVE_POSITIONS?.[p.key] ?? { x: 0.1, y: 0.1 }
-                      const isDragging = draggingKey === p.key
-                      return (
-                        <button
-                          key={p.key}
-                          type="button"
-                          className={[
-                            'absolute pointer-events-auto select-none touch-none',
-                            'px-2 py-1 rounded-lg border text-[10px] font-black uppercase tracking-widest transition-transform active:scale-110',
-                            isDragging
-                              ? 'bg-yellow-500 text-black border-yellow-500 shadow-lg scale-110 z-50'
-                              : 'bg-black/60 backdrop-blur text-white border-white/20 hover:border-yellow-500/50',
-                          ].join(' ')}
-                          style={{
-                            left: `${clamp01(pos.x) * 100}%`,
-                            top: `${clamp01(pos.y) * 100}%`,
-                            cursor: 'grab'
-                          }}
-                          onPointerDown={(e) => onPiecePointerDown(p.key, e)}
-                          onPointerMove={(e) => onPiecePointerMove(p.key, e)}
-                          onPointerUp={(e) => onPiecePointerUp(p.key, e)}
-                          onPointerCancel={(e) => onPiecePointerUp(p.key, e)}
-                        >
-                          {p.label}
-                        </button>
-                      )
-                    })}
-                  </div>
-                )}
-              </div>
-
-              {/* Media Controls */}
-              <div className="w-full max-w-[300px] sm:max-w-[340px] flex items-center gap-3">
-                <label
-                  className={[
-                    'flex-1 h-12 rounded-xl bg-neutral-900 border border-neutral-800 text-white font-bold text-[11px] uppercase tracking-wider hover:bg-neutral-800 hover:border-neutral-700 inline-flex items-center justify-center gap-2 cursor-pointer transition-all active:scale-[0.98]',
-                    busy ? 'opacity-50 pointer-events-none' : '',
-                  ].join(' ')}
-                >
-                  <Upload size={16} className="text-yellow-500" />
-                  {isVideo ? 'TROCAR' : 'TROCAR FOTO'}
-                  <input
-                    ref={inputRef}
-                    type="file"
-                    accept="image/*,video/*"
-                    className="sr-only"
-                    onChange={(e) => {
-                        const f = e.target.files?.[0] || null
-                        if (inputRef.current) inputRef.current.value = ''
-                        loadMedia(f)
-                    }}
-                   />
-                </label>
-                
-                {isVideo && (
-                    <button
-                        type="button"
-                        onClick={() => setShowTrimmer(v => !v)}
-                        className={`w-12 h-12 rounded-xl border flex items-center justify-center transition-colors active:scale-[0.98] ${
-                            showTrimmer 
-                            ? 'bg-yellow-500 text-black border-yellow-500' 
-                            : 'bg-neutral-900 border-neutral-800 text-neutral-400 hover:text-white'
-                        }`}
-                        disabled={busy}
-                    >
-                        <Scissors size={18} />
-                    </button>
-                )}
-
-                <button
-                  type="button"
-                  onClick={() => setShowSafeGuide((v) => !v)}
-                  className={`w-28 h-12 rounded-xl border font-bold text-[10px] uppercase tracking-wider transition-colors active:scale-[0.98] ${
-                    showSafeGuide 
-                        ? 'bg-yellow-500/10 border-yellow-500/30 text-yellow-500' 
-                        : 'bg-neutral-900 border-neutral-800 text-neutral-400 hover:text-white'
-                  }`}
-                  disabled={busy}
-                >
-                  GUIA {showSafeGuide ? 'ON' : 'OFF'}
-                </button>
-              </div>
-            </div>
-
-            {/* Controls Column */}
-            <div className="flex-1 w-full max-w-[360px] flex flex-col gap-6">
-                
-                {/* Trimmer UI */}
-                <AnimatePresence>
-                    {showTrimmer && isVideo && (
-                        <motion.div 
-                            initial={{ height: 0, opacity: 0 }} 
-                            animate={{ height: 'auto', opacity: 1 }} 
-                            exit={{ height: 0, opacity: 0 }}
-                            className="overflow-hidden"
-                        >
-                            <VideoTrimmer 
-                                duration={videoDuration} 
-                                value={trimRange} 
-                                onChange={(val) => {
-                                    setTrimRange(val)
-                                    // Update preview frame if paused
-                                    if (videoRef.current && videoRef.current.paused) {
-                                        videoRef.current.currentTime = val[0]
-                                    }
-                                }}
-                                onPreview={(play) => {
-                                    if (!videoRef.current) return
-                                    if (play) {
-                                        videoRef.current.currentTime = trimRange[0]
-                                        videoRef.current.play()
-                                        const check = () => {
-                                            if (!videoRef.current) return
-                                            setPreviewTime(videoRef.current.currentTime)
-                                            if (videoRef.current.currentTime >= trimRange[1]) {
-                                                videoRef.current.pause()
-                                                videoRef.current.currentTime = trimRange[0]
-                                            } else if (!videoRef.current.paused) {
-                                                requestAnimationFrame(check)
-                                            }
-                                        }
-                                        requestAnimationFrame(check)
-                                    } else {
-                                        videoRef.current.pause()
-                                    }
-                                }}
-                                currentTime={previewTime}
-                            />
-                        </motion.div>
-                    )}
-                </AnimatePresence>
-
-                {/* Layout Selector */}
-                <div className="space-y-3">
-                    <div className="flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider text-yellow-500/80 mb-2">
-                        <Layout size={14} />
-                        ESCOLHA O LAYOUT
-                    </div>
-                    <div className="grid grid-cols-2 gap-3">
-                        {STORY_LAYOUTS.map((l) => (
-                        <button
-                            key={l.id}
-                            type="button"
-                            onClick={() => onSelectLayout(l.id)}
-                            className={[
-                            'h-12 rounded-xl border text-[11px] font-bold uppercase tracking-wider transition-all active:scale-[0.98]',
-                            layout === l.id
-                                ? 'bg-white text-black border-white shadow-lg scale-[1.02]'
-                                : 'bg-neutral-900 text-neutral-400 border-neutral-800 hover:bg-neutral-800 hover:border-neutral-700',
-                            l.id === 'live' ? 'col-span-2' : '' // LIVE spans full width
-                            ].join(' ')}
-                            disabled={busy}
-                        >
-                            {l.label}
-                        </button>
-                        ))}
-                    </div>
-                    {layout === 'live' && (
-                        <div className="p-3 rounded-xl bg-blue-500/10 border border-blue-500/20 flex items-start gap-3 mt-2">
-                            <Move size={16} className="text-blue-400 mt-0.5" />
-                            <div className="flex-1">
-                                <p className="text-xs text-blue-200 font-medium">Modo LIVE ativado</p>
-                                <p className="text-[10px] text-blue-300/70 mt-1">Arraste os elementos na pré-visualização para personalizar.</p>
-                            </div>
-                            <button 
-                                onClick={() => setLivePositions(DEFAULT_LIVE_POSITIONS)}
-                                className="p-1.5 rounded-lg hover:bg-blue-500/20 text-blue-300"
-                                title="Resetar posições"
-                            >
-                                <RotateCcw size={14} />
-                            </button>
-                        </div>
-                    )}
-                </div>
-
-                <div className="flex-1 hidden lg:block" />
-
-                {/* Status Messages */}
-                <AnimatePresence mode="wait">
-                    {info && (
-                        <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20 flex items-center gap-3">
-                            <CheckCircle2 size={18} className="text-emerald-500" />
-                            <p className="text-xs font-bold text-emerald-200">{info}</p>
-                        </motion.div>
-                    )}
-                    {error && (
-                        <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0 }} className="p-4 rounded-xl bg-red-950/40 border border-red-900/50 flex items-center gap-3">
-                            <AlertCircle size={18} className="text-red-400" />
-                            <p className="text-xs font-bold text-red-200">{error}</p>
-                        </motion.div>
-                    )}
-                </AnimatePresence>
-
-                {/* Actions */}
-                <div className="space-y-3 pt-2">
-                    <button
-                        onClick={postToIronTracks}
-                        disabled={busy}
-                        className="h-14 w-full rounded-xl bg-yellow-500 hover:bg-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed text-black font-black text-sm uppercase tracking-wider flex items-center justify-center gap-2 shadow-lg shadow-yellow-500/10 transition-all active:scale-[0.98]"
-                    >
-                        {busyAction === 'post' ? (
-                            <>
-                                <Loader2 className="animate-spin" size={18} />
-                                PROCESSANDO...
-                            </>
-                        ) : 'POSTAR NO IRONTRACKS'}
-                    </button>
-                    
-                    <button
-                        onClick={shareImage}
-                        disabled={busy}
-                        className="h-12 w-full rounded-xl bg-transparent hover:bg-neutral-900 disabled:opacity-50 disabled:cursor-not-allowed text-neutral-400 font-bold text-[10px] uppercase tracking-wider flex items-center justify-center gap-2 border border-transparent hover:border-neutral-800 transition-all active:scale-[0.98]"
-                    >
-                        {busyAction === 'share' ? (
-                            <>
-                                <Loader2 className="animate-spin" size={14} />
-                                PROCESSANDO...
-                            </>
-                        ) : (
-                            <>
-                                <Share2 size={14} />
-                                BAIXAR / COMPARTILHAR
-                            </>
-                        )}
-                    </button>
-                </div>
-
-            </div>
-          </div>
-        </div>
-      </motion.div>
-    </motion.div>
-    )}
-    </AnimatePresence>
-  )
-}
diff --git a/_archive/duplicates/src/components/admin/RequestsTab 2.js b/_archive/duplicates/src/components/admin/RequestsTab 2.js
deleted file mode 100644
index ef218e9..0000000
--- a/_archive/duplicates/src/components/admin/RequestsTab 2.js	
+++ /dev/null
@@ -1,159 +0,0 @@
-'use client'
-
-import React, { useEffect, useState } from 'react'
-import { Check, X, Loader2, Calendar, Mail, Phone, User, Clock } from 'lucide-react'
-import { useDialog } from '@/contexts/DialogContext'
-
-export default function RequestsTab() {
-    const { confirm, alert } = useDialog()
-    const [requests, setRequests] = useState([])
-    const [loading, setLoading] = useState(true)
-    const [processing, setProcessing] = useState(null) // id being processed
-
-    const fetchRequests = async () => {
-        setLoading(true)
-        try {
-            const res = await fetch('/api/admin/access-requests/list?status=pending')
-            const json = await res.json()
-            if (json.ok) {
-                setRequests(json.data || [])
-            } else {
-                console.error(json.error)
-            }
-        } catch (e) {
-            console.error(e)
-        } finally {
-            setLoading(false)
-        }
-    }
-
-    useEffect(() => {
-        fetchRequests()
-    }, [])
-
-    const handleAction = async (req, action) => {
-        if (action === 'reject') {
-            const ok = await confirm(
-                `Tem certeza que deseja recusar o acesso de ${req.full_name}?`,
-                'Recusar Solicitação',
-                { confirmText: 'Recusar', cancelText: 'Cancelar', type: 'danger' }
-            )
-            if (!ok) return
-        } else {
-            const ok = await confirm(
-                `Aceitar solicitação de ${req.full_name}?\nIsso criará uma conta e enviará as credenciais.`,
-                'Aceitar Acesso',
-                { confirmText: 'Criar Conta', cancelText: 'Cancelar' }
-            )
-            if (!ok) return
-        }
-
-        setProcessing(req.id)
-        try {
-            const res = await fetch('/api/admin/access-requests/action', {
-                method: 'POST',
-                headers: { 'Content-Type': 'application/json' },
-                body: JSON.stringify({ requestId: req.id, action })
-            })
-            const json = await res.json()
-
-            if (json.ok) {
-                await alert(json.message || 'Sucesso!')
-                setRequests(prev => prev.filter(r => r.id !== req.id))
-            } else {
-                await alert(json.error || 'Erro ao processar.')
-            }
-        } catch (e) {
-            await alert('Erro de conexão.')
-        } finally {
-            setProcessing(null)
-        }
-    }
-
-    if (loading) {
-        return (
-            <div className="flex items-center justify-center h-64">
-                <Loader2 className="animate-spin text-yellow-500" size={32} />
-            </div>
-        )
-    }
-
-    if (requests.length === 0) {
-        return (
-            <div className="flex flex-col items-center justify-center h-64 text-neutral-500">
-                <div className="w-16 h-16 bg-neutral-900 rounded-full flex items-center justify-center mb-4 border border-neutral-800">
-                    <Check className="text-neutral-700" size={32} />
-                </div>
-                <p className="font-bold text-sm uppercase tracking-widest">Nenhuma solicitação pendente</p>
-            </div>
-        )
-    }
-
-    return (
-        <div className="w-full space-y-4">
-            <div className="flex items-center justify-between px-1">
-                <h3 className="text-xs font-black uppercase tracking-widest text-neutral-400">
-                    Solicitações Pendentes ({requests.length})
-                </h3>
-                <button onClick={fetchRequests} className="text-[10px] font-bold text-yellow-500 hover:text-yellow-400 uppercase">
-                    Atualizar
-                </button>
-            </div>
-
-            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
-                {requests.map(req => (
-                    <div key={req.id} className="bg-neutral-900 border border-neutral-800 rounded-2xl p-5 flex flex-col gap-4 shadow-sm hover:border-yellow-500/30 transition-colors">
-                        <div className="flex items-start justify-between">
-                            <div className="flex items-center gap-3">
-                                <div className="w-10 h-10 rounded-full bg-neutral-800 flex items-center justify-center text-yellow-500 font-black text-lg border border-neutral-700">
-                                    {req.full_name.charAt(0).toUpperCase()}
-                                </div>
-                                <div>
-                                    <h4 className="font-bold text-white text-sm line-clamp-1">{req.full_name}</h4>
-                                    <div className="flex items-center gap-1 text-[10px] text-neutral-500">
-                                        <Clock size={10} />
-                                        <span>{new Date(req.created_at).toLocaleDateString()} às {new Date(req.created_at).toLocaleTimeString().slice(0,5)}</span>
-                                    </div>
-                                </div>
-                            </div>
-                        </div>
-
-                        <div className="space-y-2">
-                            <div className="flex items-center gap-2 text-xs text-neutral-300 bg-black/30 p-2 rounded-lg border border-white/5">
-                                <Mail size={14} className="text-neutral-500" />
-                                <span className="truncate select-all">{req.email}</span>
-                            </div>
-                            <div className="flex items-center gap-2 text-xs text-neutral-300 bg-black/30 p-2 rounded-lg border border-white/5">
-                                <Phone size={14} className="text-neutral-500" />
-                                <span className="select-all">{req.phone}</span>
-                            </div>
-                            <div className="flex items-center gap-2 text-xs text-neutral-300 bg-black/30 p-2 rounded-lg border border-white/5">
-                                <Calendar size={14} className="text-neutral-500" />
-                                <span>{new Date(req.birth_date).toLocaleDateString()}</span>
-                            </div>
-                        </div>
-
-                        <div className="grid grid-cols-2 gap-2 mt-auto pt-2">
-                            <button
-                                onClick={() => handleAction(req, 'reject')}
-                                disabled={processing === req.id}
-                                className="flex items-center justify-center gap-2 py-3 rounded-xl bg-red-500/10 text-red-400 hover:bg-red-500/20 border border-red-500/20 text-xs font-black uppercase transition-colors disabled:opacity-50"
-                            >
-                                {processing === req.id ? <Loader2 className="animate-spin" size={14} /> : <X size={14} />}
-                                Recusar
-                            </button>
-                            <button
-                                onClick={() => handleAction(req, 'accept')}
-                                disabled={processing === req.id}
-                                className="flex items-center justify-center gap-2 py-3 rounded-xl bg-yellow-500 text-black hover:bg-yellow-400 font-black text-xs uppercase transition-colors disabled:opacity-50"
-                            >
-                                {processing === req.id ? <Loader2 className="animate-spin" size={14} /> : <Check size={14} />}
-                                Aceitar
-                            </button>
-                        </div>
-                    </div>
-                ))}
-            </div>
-        </div>
-    )
-}
diff --git a/_archive/duplicates/src/components/assessment/AssessmentButton 2.tsx b/_archive/duplicates/src/components/assessment/AssessmentButton 2.tsx
deleted file mode 100644
index e05f724..0000000
--- a/_archive/duplicates/src/components/assessment/AssessmentButton 2.tsx	
+++ /dev/null
@@ -1,368 +0,0 @@
-"use client";
-import React, { useRef, useState } from 'react';
-import { useRouter } from 'next/navigation';
-import { Plus, FileText, TrendingUp, X, Upload } from 'lucide-react';
-import { AssessmentForm } from './AssessmentForm';
-
-interface AssessmentButtonProps {
-  studentId: string;
-  studentName: string;
-  variant?: 'button' | 'card' | 'icon';
-  className?: string;
-}
-
-export default function AssessmentButton({ 
-  studentId, 
-  studentName, 
-  variant = 'button',
-  className = '' 
-}: AssessmentButtonProps) {
-  const [showForm, setShowForm] = useState(false);
-  const [importing, setImporting] = useState(false);
-  const router = useRouter();
-  const fileInputRef = useRef<HTMLInputElement | null>(null);
-  const scanInputRef = useRef<HTMLInputElement | null>(null);
-
-  const handleNewAssessment = () => {
-    router.push(`/assessments/new/${studentId}`);
-  };
-
-  const handleViewHistory = () => {
-    router.push(`/assessments/${studentId}`);
-  };
-
-  const handleAssessmentComplete = () => {
-    setShowForm(false);
-    // Recarregar a página ou atualizar os dados
-    window.location.reload();
-  };
-
-  const handleImportClick = () => {
-    if (!fileInputRef.current) return;
-    fileInputRef.current.click();
-  };
-
-  const handleScanClick = () => {
-    if (!scanInputRef.current) return;
-    scanInputRef.current.click();
-  };
-
-  const mergeImportedFormData = (base: any, incoming: any) => {
-    const out: any = { ...(base && typeof base === 'object' ? base : {}) };
-    const keys = [
-      'assessment_date',
-      'weight',
-      'height',
-      'age',
-      'gender',
-      'arm_circ',
-      'chest_circ',
-      'waist_circ',
-      'hip_circ',
-      'thigh_circ',
-      'calf_circ',
-      'triceps_skinfold',
-      'biceps_skinfold',
-      'subscapular_skinfold',
-      'suprailiac_skinfold',
-      'abdominal_skinfold',
-      'thigh_skinfold',
-      'calf_skinfold',
-      'observations',
-    ];
-    keys.forEach((k) => {
-      const nextVal = incoming?.[k];
-      if (nextVal === undefined || nextVal === null || nextVal === '') return;
-      const prevVal = out?.[k];
-      if (prevVal === undefined || prevVal === null || prevVal === '') {
-        out[k] = nextVal;
-      }
-    });
-    return out;
-  };
-
-  const handleImportFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
-    try {
-      const file = event.target.files?.[0];
-      if (!file) return;
-
-      const text = await file.text();
-      let parsed: unknown;
-
-      try {
-        parsed = JSON.parse(text);
-      } catch (error) {
-        console.error("Erro ao parsear JSON de avaliação", error);
-        if (typeof window !== "undefined") {
-          window.alert("Arquivo JSON inválido. Verifique o conteúdo exportado.");
-        }
-        return;
-      }
-
-      if (!parsed || typeof parsed !== "object") {
-        if (typeof window !== "undefined") {
-          window.alert("Formato de arquivo não reconhecido para avaliação.");
-        }
-        return;
-      }
-
-      const payload: any = parsed as any;
-      const importedForm = payload.formData || payload;
-      if (!importedForm || typeof importedForm !== "object") {
-        if (typeof window !== "undefined") {
-          window.alert("JSON não contém dados de avaliação válidos.");
-        }
-        return;
-      }
-
-      const hasCoreField =
-        "weight" in importedForm ||
-        "height" in importedForm ||
-        "assessment_date" in importedForm;
-
-      if (!hasCoreField) {
-        if (typeof window !== "undefined") {
-          window.alert("JSON não parece ser uma avaliação física exportada.");
-        }
-        return;
-      }
-
-      if (typeof window !== "undefined") {
-        try {
-          const storageKey = `assessment_import_${studentId}`;
-          window.sessionStorage.setItem(storageKey, JSON.stringify(payload));
-        } catch (error) {
-          console.error("Erro ao salvar avaliação importada na sessão", error);
-          window.alert("Não foi possível preparar os dados importados. Tente novamente.");
-          return;
-        }
-      }
-
-      router.push(`/assessments/new/${studentId}`);
-    } catch (error) {
-      console.error("Erro ao importar JSON de avaliação", error);
-      if (typeof window !== "undefined") {
-        window.alert("Falha ao importar arquivo JSON de avaliação.");
-      }
-    } finally {
-      if (event.target) {
-        event.target.value = "";
-      }
-    }
-  };
-
-  const handleScanFileChange = async (event: React.ChangeEvent<HTMLInputElement>) => {
-    try {
-      const files = event.target.files ? Array.from(event.target.files) : [];
-      if (!files.length) return;
-      if (importing) return;
-
-      setImporting(true);
-
-      let mergedFormData: any = {};
-
-      for (const file of files) {
-        const form = new FormData();
-        form.append('file', file);
-
-        const res = await fetch('/api/assessment-scanner', {
-          method: 'POST',
-          body: form,
-        });
-
-        const data = await res.json().catch(() => null);
-        if (!data || !data.ok) {
-          const msg = String(data?.error || 'Falha ao processar arquivo');
-          if (typeof window !== 'undefined') window.alert(msg);
-          return;
-        }
-
-        const nextForm = data?.formData && typeof data.formData === 'object' ? data.formData : null;
-        if (nextForm) mergedFormData = mergeImportedFormData(mergedFormData, nextForm);
-      }
-
-      const hasCoreField =
-        mergedFormData &&
-        typeof mergedFormData === 'object' &&
-        ('weight' in mergedFormData || 'height' in mergedFormData || 'assessment_date' in mergedFormData);
-
-      if (!hasCoreField) {
-        if (typeof window !== 'undefined') {
-          window.alert('Não foi possível extrair dados suficientes da avaliação.');
-        }
-        return;
-      }
-
-      if (typeof window !== 'undefined') {
-        try {
-          const storageKey = `assessment_import_${studentId}`;
-          window.sessionStorage.setItem(storageKey, JSON.stringify({ formData: mergedFormData }));
-        } catch (error) {
-          console.error('Erro ao salvar avaliação importada na sessão', error);
-          window.alert('Não foi possível preparar os dados importados. Tente novamente.');
-          return;
-        }
-      }
-
-      router.push(`/assessments/new/${studentId}`);
-    } catch (error) {
-      console.error('Erro ao importar avaliação por imagem/PDF', error);
-      if (typeof window !== 'undefined') {
-        window.alert('Falha ao importar avaliação por imagem/PDF.');
-      }
-    } finally {
-      setImporting(false);
-      if (event.target) {
-        event.target.value = '';
-      }
-    }
-  };
-
-  if (showForm) {
-    return (
-      <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 pt-20" onClick={() => setShowForm(false)}>
-        <div className="bg-neutral-900 rounded-xl border border-neutral-800 max-w-4xl w-full max-h-[90vh] overflow-y-auto relative custom-scrollbar" onClick={(e) => e.stopPropagation()}>
-          <div className="absolute top-3 right-3 z-10">
-            <button
-              onClick={() => setShowForm(false)}
-              className="p-2 rounded-full bg-neutral-800 hover:bg-neutral-700 text-neutral-400 hover:text-white transition-colors"
-              aria-label="Fechar"
-            >
-              <X className="w-5 h-5" />
-            </button>
-          </div>
-          <AssessmentForm
-            studentId={studentId}
-            studentName={studentName}
-            onSuccess={handleAssessmentComplete}
-            onCancel={() => setShowForm(false)}
-          />
-        </div>
-      </div>
-    );
-  }
-
-  if (variant === 'card') {
-    return (
-      <div className={`bg-neutral-800 rounded-xl border border-neutral-700 p-6 ${className}`}>
-        <div className="flex items-center justify-between mb-4">
-          <h3 className="text-lg font-bold text-white">Avaliações Físicas</h3>
-          <TrendingUp className="w-6 h-6 text-yellow-500" />
-        </div>
-        <p className="text-neutral-400 mb-4">
-          Gerencie as avaliações físicas e acompanhe a evolução do aluno
-        </p>
-        <div className="flex flex-wrap gap-3">
-          <button
-            onClick={handleNewAssessment}
-            className="flex-1 inline-flex items-center justify-center px-4 py-2 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 transition-colors"
-          >
-            <Plus className="w-4 h-4 mr-2" />
-            Nova Avaliação
-          </button>
-          <button
-            onClick={handleViewHistory}
-            className="flex-1 inline-flex items-center justify-center px-4 py-2 bg-neutral-900 text-neutral-300 rounded-xl border border-neutral-700 hover:bg-neutral-800 transition-colors"
-          >
-            <FileText className="w-4 h-4 mr-2" />
-            Ver Histórico
-          </button>
-          <button
-            onClick={handleImportClick}
-            className="flex-1 inline-flex items-center justify-center px-4 py-2 bg-neutral-900 text-neutral-200 rounded-xl border border-dashed border-neutral-600 hover:border-yellow-500 hover:text-yellow-500 transition-colors"
-          >
-            <Upload className="w-4 h-4 mr-2" />
-            Importar JSON
-          </button>
-          <button
-            onClick={handleScanClick}
-            disabled={importing}
-            className={
-              importing
-                ? "flex-1 inline-flex items-center justify-center px-4 py-2 bg-neutral-900 text-neutral-500 rounded-xl border border-dashed border-neutral-800 cursor-not-allowed"
-                : "flex-1 inline-flex items-center justify-center px-4 py-2 bg-neutral-900 text-neutral-200 rounded-xl border border-dashed border-neutral-600 hover:border-yellow-500 hover:text-yellow-500 transition-colors"
-            }
-          >
-            <Upload className="w-4 h-4 mr-2" />
-            {importing ? "Importando..." : "Importar Foto/PDF"}
-          </button>
-          <input
-            ref={fileInputRef}
-            type="file"
-            accept="application/json"
-            className="hidden"
-            onChange={handleImportFileChange}
-          />
-          <input
-            ref={scanInputRef}
-            type="file"
-            accept="image/*,application/pdf"
-            multiple
-            className="hidden"
-            onChange={handleScanFileChange}
-          />
-        </div>
-      </div>
-    );
-  }
-
-  if (variant === 'icon') {
-    return (
-      <div className={`flex gap-2 ${className}`}>
-        <button
-          onClick={handleNewAssessment}
-          className="p-2 bg-yellow-500 text-black rounded-xl hover:bg-yellow-400 transition-colors"
-          title="Nova Avaliação"
-        >
-          <Plus className="w-4 h-4" />
-        </button>
-        <button
-          onClick={handleViewHistory}
-          className="p-2 bg-neutral-900 text-neutral-300 rounded-xl border border-neutral-700 hover:bg-neutral-800 transition-colors"
-          title="Ver Histórico"
-        >
-          <FileText className="w-4 h-4" />
-        </button>
-      </div>
-    );
-  }
-
-  return (
-    <div className={`flex gap-3 ${className}`}>
-      <button
-        onClick={handleNewAssessment}
-        className="inline-flex items-center px-4 py-2 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 transition-colors"
-      >
-        <Plus className="w-4 h-4 mr-2" />
-        Nova Avaliação
-      </button>
-      <button
-        onClick={handleViewHistory}
-        className="inline-flex items-center px-4 py-2 bg-neutral-900 text-neutral-300 rounded-xl border border-neutral-700 hover:bg-neutral-800 transition-colors"
-      >
-        <FileText className="w-4 h-4 mr-2" />
-        Histórico
-      </button>
-      <button
-        onClick={handleScanClick}
-        disabled={importing}
-        className={
-          importing
-            ? "inline-flex items-center px-4 py-2 bg-neutral-900 text-neutral-500 rounded-xl border border-dashed border-neutral-800 cursor-not-allowed"
-            : "inline-flex items-center px-4 py-2 bg-neutral-900 text-neutral-200 rounded-xl border border-dashed border-neutral-600 hover:border-yellow-500 hover:text-yellow-500 transition-colors"
-        }
-      >
-        <Upload className="w-4 h-4 mr-2" />
-        {importing ? "Importando..." : "Importar Foto/PDF"}
-      </button>
-      <input
-        ref={scanInputRef}
-        type="file"
-        accept="image/*,application/pdf"
-        multiple
-        className="hidden"
-        onChange={handleScanFileChange}
-      />
-    </div>
-  );
-}
diff --git a/_archive/duplicates/src/components/dashboard/StoriesBar 2.tsx b/_archive/duplicates/src/components/dashboard/StoriesBar 2.tsx
deleted file mode 100644
index b02e1be..0000000
--- a/_archive/duplicates/src/components/dashboard/StoriesBar 2.tsx	
+++ /dev/null
@@ -1,805 +0,0 @@
-'use client'
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
-import Image from 'next/image'
-import { Heart, MessageCircle, X, ChevronLeft, ChevronRight, Plus, Trash2, Loader2, Eye } from 'lucide-react'
-import { motion } from 'framer-motion'
-import { createClient } from '@/utils/supabase/client'
-import { useDialog } from '@/contexts/DialogContext'
-
-type Story = {
-  id: string
-  createdAt: string
-  expiresAt: string
-  caption: string | null
-  mediaUrl: string | null
-  viewed: boolean
-  likeCount: number
-  hasLiked: boolean
-  commentCount: number
-}
-
-type StoryGroup = {
-  authorId: string
-  displayName: string | null
-  photoUrl: string | null
-  role: string | null
-  hasStories?: boolean
-  hasUnseen?: boolean
-  stories: Story[]
-}
-
-const initials = (name: string) => {
-  const n = String(name || '').trim()
-  if (!n) return '?'
-  return n.slice(0, 1).toUpperCase()
-}
-
-const formatAgo = (iso: string) => {
-  const ms = new Date(iso).getTime()
-  if (!Number.isFinite(ms)) return ''
-  const diffMin = Math.floor((Date.now() - ms) / 60000)
-  if (diffMin < 1) return 'agora'
-  if (diffMin < 60) return `${diffMin}m`
-  const diffH = Math.floor(diffMin / 60)
-  if (diffH < 24) return `${diffH}h`
-  const diffD = Math.floor(diffH / 24)
-  return `${diffD}d`
-}
-
-export default function StoriesBar({ currentUserId }: { currentUserId?: string }) {
-  const myId = typeof currentUserId === 'string' ? currentUserId : ''
-  const [groups, setGroups] = useState<StoryGroup[]>([])
-  const [loading, setLoading] = useState(false)
-  const [uploading, setUploading] = useState(false)
-  const [error, setError] = useState('')
-  const [open, setOpen] = useState(false)
-  const [openAuthorId, setOpenAuthorId] = useState<string>('')
-  const uploadRef = useRef<HTMLInputElement | null>(null)
-
-  const reload = useCallback(async () => {
-    setLoading(true)
-    setError('')
-    try {
-      const res = await fetch('/api/social/stories/list', { method: 'GET' })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao carregar stories'))
-      const arr = Array.isArray(json?.data) ? (json.data as StoryGroup[]) : []
-      setGroups(arr)
-    } catch (e: any) {
-      setError(String(e?.message || e))
-      setGroups([])
-    } finally {
-      setLoading(false)
-    }
-  }, [])
-
-  const uploadStory = async (file: File) => {
-    setUploading(true)
-    setError('')
-    try {
-      const supabase = createClient()
-      const { data: authData } = await supabase.auth.getUser()
-      const uid = String(authData?.user?.id || '').trim()
-      if (!uid) throw new Error('unauthorized')
-
-      const rawName = String(file?.name || '').trim().toLowerCase()
-      const ext = rawName.endsWith('.png') ? '.png' : rawName.endsWith('.jpeg') ? '.jpeg' : rawName.endsWith('.jpg') ? '.jpg' : '.jpg'
-      const storyId = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`
-      const path = `${uid}/stories/${storyId}${ext}`
-
-      const signResp = await fetch('/api/storage/social-stories/signed-upload', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ path }),
-      })
-      const signJson = await signResp.json().catch(() => null)
-      if (!signResp.ok || !signJson?.ok || !signJson?.token) throw new Error(String(signJson?.error || 'Falha ao preparar upload'))
-
-      const { error: upErr } = await supabase.storage
-        .from('social-stories')
-        .uploadToSignedUrl(path, String(signJson.token), file, { contentType: file.type || 'image/jpeg' })
-      if (upErr) throw upErr
-
-      const createResp = await fetch('/api/social/stories/create', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ mediaPath: path, caption: null, meta: { source: 'upload' } }),
-      })
-      const createJson = await createResp.json().catch(() => null)
-      if (!createResp.ok || !createJson?.ok) throw new Error(String(createJson?.error || 'Falha ao publicar'))
-
-      await reload()
-    } catch (e: any) {
-      const msg = String(e?.message || e)
-      setError(msg === 'unauthorized' ? 'Faça login novamente para publicar.' : 'Não foi possível publicar seu story.')
-    } finally {
-      setUploading(false)
-      try {
-        if (uploadRef.current) uploadRef.current.value = ''
-      } catch {}
-    }
-  }
-
-  useEffect(() => {
-    reload()
-    const onRefresh = () => reload()
-    try {
-      window.addEventListener('irontracks:stories:refresh', onRefresh as any)
-    } catch {}
-    return () => {
-      try {
-        window.removeEventListener('irontracks:stories:refresh', onRefresh as any)
-      } catch {}
-    }
-  }, [reload])
-
-  const ordered = useMemo(() => {
-    const arr = Array.isArray(groups) ? groups : []
-    if (!myId) return arr
-    const mine = arr.find((g) => g.authorId === myId)
-    if (!mine) return arr
-    return [mine, ...arr.filter((g) => g.authorId !== myId)]
-  }, [groups, myId])
-
-  const currentGroup = useMemo(() => ordered.find((g) => g.authorId === openAuthorId) || null, [ordered, openAuthorId])
-  const closeViewer = useCallback(() => setOpen(false), [])
-  const handleStoryUpdated = useCallback(
-    (storyId: string, patch: Partial<Story>) => {
-      const authorId = openAuthorId
-      if (!authorId) return
-      setGroups((prev) =>
-        prev.map((g) => {
-          if (g.authorId !== authorId) return g
-          const nextStories = (Array.isArray(g.stories) ? g.stories : []).map((st) => (st.id === storyId ? { ...st, ...patch } : st))
-          const hasUnseen = nextStories.some((st) => !st.viewed)
-          return { ...g, stories: nextStories, hasUnseen }
-        })
-      )
-    },
-    [openAuthorId]
-  )
-  const handleStoryDeleted = useCallback(
-    (storyId: string) => {
-      const authorId = openAuthorId
-      if (!authorId) return
-      setGroups((prev) =>
-        prev.map((g) => {
-          if (g.authorId !== authorId) return g
-          const nextStories = (Array.isArray(g.stories) ? g.stories : []).filter((st) => st.id !== storyId)
-          const hasUnseen = nextStories.some((st) => !st.viewed)
-          return { ...g, stories: nextStories, hasUnseen }
-        })
-      )
-    },
-    [openAuthorId]
-  )
-
-  return (
-    <div className="mb-4">
-      <input
-        ref={uploadRef}
-        type="file"
-        accept="image/*"
-        className="hidden"
-        onChange={(e) => {
-          const f = e.target.files && e.target.files[0] ? e.target.files[0] : null
-          if (!f) return
-          if (!String(f.type || '').toLowerCase().startsWith('image/')) {
-            setError('Selecione uma imagem.')
-            return
-          }
-          if (f.size > 12 * 1024 * 1024) {
-            setError('Imagem muito grande (máx 12MB).')
-            return
-          }
-          uploadStory(f)
-        }}
-      />
-      <div className="flex items-center justify-between px-1">
-        <div className="text-xs font-bold text-neutral-500 uppercase tracking-widest">Stories</div>
-        <button
-          type="button"
-          onClick={reload}
-          className="text-[11px] font-black text-neutral-400 hover:text-white"
-          disabled={loading || uploading}
-        >
-          {loading ? 'Carregando…' : uploading ? 'Publicando…' : 'Atualizar'}
-        </button>
-      </div>
-
-      {error ? (
-        <div className="mt-2 bg-neutral-900 border border-neutral-800 rounded-xl p-3 text-xs text-red-300 font-bold">
-          {error}
-        </div>
-      ) : null}
-
-      <div className="mt-2 flex gap-3 overflow-x-auto pb-2 custom-scrollbar">
-        {!ordered.length && loading ? (
-          <>
-            <div className="shrink-0 w-[72px]">
-              <div className="w-16 h-16 rounded-full bg-neutral-900 border border-neutral-800 mx-auto" />
-              <div className="mt-1 h-3 w-12 bg-neutral-900 border border-neutral-800 rounded-md mx-auto" />
-            </div>
-            <div className="shrink-0 w-[72px]">
-              <div className="w-16 h-16 rounded-full bg-neutral-900 border border-neutral-800 mx-auto" />
-              <div className="mt-1 h-3 w-12 bg-neutral-900 border border-neutral-800 rounded-md mx-auto" />
-            </div>
-            <div className="shrink-0 w-[72px]">
-              <div className="w-16 h-16 rounded-full bg-neutral-900 border border-neutral-800 mx-auto" />
-              <div className="mt-1 h-3 w-12 bg-neutral-900 border border-neutral-800 rounded-md mx-auto" />
-            </div>
-          </>
-        ) : null}
-        {ordered.map((g) => {
-          const hasStories = Array.isArray(g.stories) && g.stories.length > 0
-          const hasUnseen = !!g.hasUnseen
-          const ringCls = !hasStories
-            ? 'border-transparent'
-            : hasUnseen
-              ? 'border-red-500'
-              : 'border-neutral-400/60'
-
-          const name = String(g.displayName || '').trim() || (g.authorId === myId ? 'Você' : 'Amigo')
-          return (
-            <button
-              key={g.authorId}
-              type="button"
-              onClick={() => {
-                if (g.authorId === myId && !hasStories) {
-                  if (!uploading && uploadRef.current) uploadRef.current.click()
-                  return
-                }
-                if (!hasStories) return
-                setOpenAuthorId(g.authorId)
-                setOpen(true)
-              }}
-              className="shrink-0 w-[72px] focus:outline-none"
-              aria-label={hasStories ? `Abrir stories de ${name}` : `Sem stories de ${name}`}
-            >
-              <div className={`w-16 h-16 rounded-full border-2 ${ringCls} p-1 mx-auto relative`}>
-                <div className="w-full h-full rounded-full overflow-hidden bg-neutral-900 border border-neutral-800 flex items-center justify-center">
-                  {g.photoUrl ? (
-                    <Image src={g.photoUrl} alt={name} width={64} height={64} className="w-full h-full object-cover" />
-                  ) : (
-                    <span className="text-yellow-500 font-black">{initials(name)}</span>
-                  )}
-                </div>
-
-                {g.authorId === myId && !hasStories ? (
-                  <div className="absolute -right-1 -bottom-1 w-6 h-6 rounded-full bg-yellow-500 border-2 border-black flex items-center justify-center">
-                    <Plus size={14} className="text-black" />
-                  </div>
-                ) : null}
-              </div>
-              <div className="mt-1 text-[11px] text-neutral-300 font-bold truncate text-center">{name}</div>
-            </button>
-          )
-        })}
-      </div>
-
-      {ordered.length === 0 && !loading && !error ? (
-        <div className="mt-2 px-1 text-[11px] text-neutral-400 font-bold">
-          Stories ainda não carregaram. Toque em <span className="text-neutral-200">Atualizar</span>.
-        </div>
-      ) : null}
-
-      {ordered.length > 0 && ordered.every((g) => !Array.isArray(g.stories) || g.stories.length === 0) && !error ? (
-        <div className="mt-2 px-1 text-[11px] text-neutral-400 font-bold">
-          Sem stories por enquanto. Para postar: abra a <span className="text-neutral-200">Foto</span> no relatório do treino e toque em{' '}
-          <span className="text-neutral-200">Postar no IronTracks (24h)</span> ou clique no <span className="text-neutral-200">+</span> do seu avatar.
-        </div>
-      ) : null}
-
-      {open && currentGroup ? (
-        <StoryViewer
-          group={currentGroup}
-          myId={myId}
-          onClose={closeViewer}
-          onStoryUpdated={handleStoryUpdated}
-          onStoryDeleted={handleStoryDeleted}
-        />
-      ) : null}
-    </div>
-  )
-}
-
-function StoryViewer({
-  group,
-  myId,
-  onClose,
-  onStoryUpdated,
-  onStoryDeleted,
-}: {
-  group: StoryGroup
-  myId: string
-  onClose: () => void
-  onStoryUpdated: (storyId: string, patch: Partial<Story>) => void
-  onStoryDeleted: (storyId: string) => void
-}) {
-  const { confirm, alert } = useDialog()
-  const stories = Array.isArray(group.stories) ? group.stories : []
-  const [idx, setIdx] = useState(0)
-  const story = stories[idx] || null
-  const [commentsOpen, setCommentsOpen] = useState(false)
-  const [commentsLoading, setCommentsLoading] = useState(false)
-  const [commentsError, setCommentsError] = useState('')
-  const [comments, setComments] = useState<any[]>([])
-  const [commentText, setCommentText] = useState('')
-  const [viewersOpen, setViewersOpen] = useState(false)
-  const [viewersLoading, setViewersLoading] = useState(false)
-  const [viewersError, setViewersError] = useState('')
-  const [viewers, setViewers] = useState<any[]>([])
-  const viewersStoryIdRef = useRef<string>('')
-  const [deleting, setDeleting] = useState(false)
-  const [progress, setProgress] = useState(0)
-  const [holding, setHolding] = useState(false)
-  const [hidden, setHidden] = useState(false)
-  const rafRef = useRef<number | null>(null)
-  const lastTsRef = useRef<number>(0)
-  const elapsedRef = useRef<number>(0)
-  const closeRequestedRef = useRef(false)
-
-  const name = String(group.displayName || '').trim() || (group.authorId === myId ? 'Você' : 'Amigo')
-  const isMine = String(group.authorId || '').trim() && String(group.authorId || '').trim() === String(myId || '').trim()
-  const durationMs = 5000
-
-  const markViewed = async (storyId: string) => {
-    try {
-      await fetch('/api/social/stories/view', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId }),
-      })
-    } catch {}
-  }
-
-  useEffect(() => {
-    if (!story?.id) return
-    if (story.viewed) return
-    onStoryUpdated(story.id, { viewed: true })
-    markViewed(story.id)
-  }, [story?.id, story?.viewed, onStoryUpdated])
-
-  useEffect(() => {
-    elapsedRef.current = 0
-    lastTsRef.current = 0
-    setProgress(0)
-    setCommentsOpen(false)
-    setViewersOpen(false)
-    setViewersError('')
-    setViewers([])
-    viewersStoryIdRef.current = ''
-  }, [story?.id])
-
-  useEffect(() => {
-    try {
-      if (typeof document !== 'undefined') setHidden(Boolean(document.hidden))
-    } catch {}
-    const onVis = () => {
-      try {
-        if (typeof document !== 'undefined') setHidden(Boolean(document.hidden))
-      } catch {}
-    }
-    try {
-      document.addEventListener('visibilitychange', onVis)
-    } catch {}
-    return () => {
-      try {
-        document.removeEventListener('visibilitychange', onVis)
-      } catch {}
-    }
-  }, [])
-
-  useEffect(() => {
-    if (!story?.id) return
-
-    const tick = (ts: number) => {
-      rafRef.current = requestAnimationFrame(tick)
-      const paused = holding || commentsOpen || viewersOpen || hidden || deleting
-      if (!lastTsRef.current) {
-        lastTsRef.current = ts
-        return
-      }
-      const delta = ts - lastTsRef.current
-      lastTsRef.current = ts
-      if (paused) return
-      elapsedRef.current += delta
-      const next = Math.max(0, Math.min(1, elapsedRef.current / durationMs))
-      setProgress((prev) => (Math.abs(prev - next) < 0.005 ? prev : next))
-      if (next >= 1) {
-        elapsedRef.current = 0
-        setProgress(0)
-        setIdx((v) => {
-          const nextIdx = v + 1
-          if (nextIdx >= stories.length) {
-            if (!closeRequestedRef.current) {
-              closeRequestedRef.current = true
-              try {
-                window.setTimeout(() => {
-                  try {
-                    onClose()
-                  } catch {}
-                }, 0)
-              } catch {}
-            }
-            return v
-          }
-          return nextIdx
-        })
-      }
-    }
-
-    rafRef.current = requestAnimationFrame(tick)
-    return () => {
-      try {
-        if (rafRef.current) cancelAnimationFrame(rafRef.current)
-      } catch {}
-      rafRef.current = null
-    }
-  }, [commentsOpen, deleting, hidden, holding, onClose, stories.length, story?.id, viewersOpen])
-
-  const loadComments = async (storyId: string) => {
-    setCommentsLoading(true)
-    setCommentsError('')
-    try {
-      const res = await fetch(`/api/social/stories/comments?storyId=${encodeURIComponent(storyId)}&limit=200`)
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao carregar comentários'))
-      setComments(Array.isArray(json?.data) ? json.data : [])
-    } catch (e: any) {
-      setCommentsError(String(e?.message || e))
-      setComments([])
-    } finally {
-      setCommentsLoading(false)
-    }
-  }
-
-  const loadViewers = async (storyId: string) => {
-    const sid = String(storyId || '').trim()
-    if (!sid) return
-    setViewersLoading(true)
-    setViewersError('')
-    try {
-      const res = await fetch(`/api/social/stories/views?storyId=${encodeURIComponent(sid)}`, { method: 'GET' })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao carregar visualizações'))
-      const arr = Array.isArray(json?.data) ? json.data : []
-      viewersStoryIdRef.current = sid
-      setViewers(arr)
-    } catch (e: any) {
-      setViewersError(String(e?.message || e))
-      setViewers([])
-    } finally {
-      setViewersLoading(false)
-    }
-  }
-
-  const toggleLike = async () => {
-    if (!story?.id) return
-    const nextLiked = !story.hasLiked
-    onStoryUpdated(story.id, { hasLiked: nextLiked, likeCount: Math.max(0, story.likeCount + (nextLiked ? 1 : -1)) })
-    try {
-      const res = await fetch('/api/social/stories/like', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId: story.id, like: nextLiked }),
-      })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao curtir'))
-    } catch {
-      onStoryUpdated(story.id, { hasLiked: story.hasLiked, likeCount: story.likeCount })
-    }
-  }
-
-  const sendComment = async () => {
-    if (!story?.id) return
-    const text = String(commentText || '').trim()
-    if (!text) return
-    setCommentText('')
-    try {
-      const res = await fetch('/api/social/stories/comments', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId: story.id, body: text }),
-      })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao comentar'))
-      setComments((prev) => [...prev, json.data])
-      onStoryUpdated(story.id, { commentCount: story.commentCount + 1 })
-    } catch {}
-  }
-
-  if (!story) return null
-  const viewCount = viewersStoryIdRef.current === story.id ? viewers.length : 0
-
-  return (
-    <div className="fixed inset-0 z-[2000] bg-black flex items-center justify-center">
-      <div className="absolute inset-0" onClick={deleting ? undefined : onClose} />
-
-      <div
-        className="relative w-full max-w-md h-[92vh] bg-neutral-950 border border-neutral-800 rounded-2xl overflow-hidden"
-        onPointerDown={() => setHolding(true)}
-        onPointerUp={() => setHolding(false)}
-        onPointerCancel={() => setHolding(false)}
-      >
-        <div className="absolute top-0 left-0 right-0 p-3 z-20">
-          <div className="flex gap-1 mb-2">
-            {stories.map((s, i) => (
-              <div key={s.id} className="flex-1 h-1 rounded-full bg-white/20 overflow-hidden">
-                <div
-                  className="h-full bg-white/90"
-                  style={{
-                    width: `${Math.round((i < idx ? 1 : i === idx ? progress : 0) * 100)}%`,
-                  }}
-                />
-              </div>
-            ))}
-          </div>
-
-          <div className="flex items-center gap-3">
-            <div className="w-10 h-10 rounded-full overflow-hidden bg-neutral-900 border border-neutral-800 flex items-center justify-center">
-              {group.photoUrl ? (
-                <Image src={group.photoUrl} alt={name} width={40} height={40} className="w-full h-full object-cover" />
-              ) : (
-                <span className="text-yellow-500 font-black">{initials(name)}</span>
-              )}
-            </div>
-            <div className="min-w-0 flex-1">
-              <div className="text-sm text-white font-black truncate">{name}</div>
-              <div className="text-[11px] text-neutral-400 font-bold">{formatAgo(story.createdAt)}</div>
-            </div>
-            {isMine ? (
-              <button
-                type="button"
-                onClick={async () => {
-                  if (!story?.id || deleting) return
-                  const ok = await confirm(
-                    'Tem certeza que deseja deletar este story?\nEssa ação não pode ser desfeita.',
-                    'Deletar story',
-                    { confirmText: 'Deletar', cancelText: 'Cancelar' }
-                  )
-                  if (!ok) return
-                  setDeleting(true)
-                  try {
-                    const res = await fetch('/api/social/stories/delete', {
-                      method: 'POST',
-                      headers: { 'content-type': 'application/json' },
-                      body: JSON.stringify({ storyId: story.id }),
-                    })
-                    const json = await res.json().catch(() => null)
-                    if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao deletar'))
-                    onStoryDeleted(story.id)
-                    try {
-                      window.dispatchEvent(new Event('irontracks:stories:refresh'))
-                    } catch {}
-                    onClose()
-                  } catch (e: any) {
-                    await alert(String(e?.message || 'Não foi possível deletar agora. Tente novamente.'), 'Erro')
-                  } finally {
-                    setDeleting(false)
-                  }
-                }}
-                className="w-10 h-10 rounded-xl bg-neutral-900/60 border border-neutral-800 text-red-200 hover:bg-neutral-900 flex items-center justify-center disabled:opacity-60"
-                aria-label="Deletar story"
-                disabled={deleting}
-              >
-                {deleting ? <Loader2 size={18} className="animate-spin" /> : <Trash2 size={18} />}
-              </button>
-            ) : null}
-            <button
-              type="button"
-              onClick={deleting ? undefined : onClose}
-              className="w-10 h-10 rounded-xl bg-neutral-900/60 border border-neutral-800 text-neutral-200 hover:bg-neutral-900 flex items-center justify-center"
-              aria-label="Fechar"
-              disabled={deleting}
-            >
-              <X size={18} />
-            </button>
-          </div>
-        </div>
-
-        <div className="absolute inset-0 flex items-center justify-center">
-          {story.mediaUrl ? (
-            <Image src={story.mediaUrl} alt="Story" fill className="object-contain" sizes="(max-width: 768px) 100vw, 420px" />
-          ) : (
-            <div className="text-neutral-400 font-bold">Mídia indisponível</div>
-          )}
-        </div>
-
-        <button
-          type="button"
-          onClick={() => setIdx((v) => Math.max(0, v - 1))}
-          className="absolute left-0 top-0 bottom-0 w-1/4 z-10"
-          aria-label="Anterior"
-          disabled={deleting}
-        />
-        <button
-          type="button"
-          onClick={() => setIdx((v) => Math.min(stories.length - 1, v + 1))}
-          className="absolute right-0 top-0 bottom-0 w-1/4 z-10"
-          aria-label="Próximo"
-          disabled={deleting}
-        />
-
-        <div className="absolute bottom-0 left-0 right-0 p-3 z-20">
-          <div className="flex items-center justify-between gap-2">
-            <div className="flex items-center gap-2">
-              {isMine ? (
-                <>
-                  <button
-                    type="button"
-                    onClick={() => {
-                      const next = !viewersOpen
-                      setViewersOpen(next)
-                      setCommentsOpen(false)
-                      if (next && story?.id) loadViewers(story.id)
-                    }}
-                    className="w-12 h-12 rounded-2xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                    aria-label="Visualizações"
-                    disabled={deleting}
-                  >
-                    <Eye size={18} />
-                  </button>
-                  <div className="text-xs text-neutral-300 font-bold tabular-nums">{viewCount}</div>
-                </>
-              ) : null}
-              <button
-                type="button"
-                onClick={toggleLike}
-                className={`w-12 h-12 rounded-2xl border font-black inline-flex items-center justify-center ${
-                  story.hasLiked ? 'bg-red-500/15 border-red-500/40 text-red-300' : 'bg-neutral-900/70 border-neutral-800 text-neutral-200'
-                }`}
-                aria-label="Curtir"
-                disabled={deleting}
-              >
-                <Heart size={18} className={story.hasLiked ? 'fill-current' : ''} />
-              </button>
-              <div className="text-xs text-neutral-300 font-bold tabular-nums">{story.likeCount}</div>
-
-              <button
-                type="button"
-                onClick={() => {
-                  const next = !commentsOpen
-                  setCommentsOpen(next)
-                  setViewersOpen(false)
-                  if (next && story?.id) loadComments(story.id)
-                }}
-                className="w-12 h-12 rounded-2xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                aria-label="Comentários"
-                disabled={deleting}
-              >
-                <MessageCircle size={18} />
-              </button>
-              <div className="text-xs text-neutral-300 font-bold tabular-nums">{story.commentCount}</div>
-            </div>
-
-            <div className="flex items-center gap-2">
-              <button
-                type="button"
-                onClick={() => setIdx((v) => Math.max(0, v - 1))}
-                className="w-10 h-10 rounded-xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                aria-label="Story anterior"
-                disabled={idx === 0 || deleting}
-              >
-                <ChevronLeft size={18} />
-              </button>
-              <button
-                type="button"
-                onClick={() => setIdx((v) => Math.min(stories.length - 1, v + 1))}
-                className="w-10 h-10 rounded-xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                aria-label="Próximo story"
-                disabled={idx === stories.length - 1 || deleting}
-              >
-                <ChevronRight size={18} />
-              </button>
-            </div>
-          </div>
-
-          {viewersOpen ? (
-            <motion.div
-              initial={{ y: 40, opacity: 0 }}
-              animate={{ y: 0, opacity: 1 }}
-              className="mt-3 bg-neutral-900/80 border border-neutral-800 rounded-2xl overflow-hidden"
-            >
-              <div className="px-3 py-2 border-b border-neutral-800 flex items-center justify-between gap-2">
-                <div className="text-xs text-neutral-200 font-black">
-                  Visualizações{viewCount ? ` (${viewCount})` : ''}
-                </div>
-                <button
-                  type="button"
-                  onClick={() => setViewersOpen(false)}
-                  className="px-3 py-1.5 rounded-xl bg-neutral-950 border border-neutral-800 text-neutral-200 font-black hover:bg-neutral-900"
-                >
-                  Fechar
-                </button>
-              </div>
-              <div className="max-h-[34vh] overflow-y-auto custom-scrollbar p-3 space-y-2">
-                {viewersLoading ? <div className="text-xs text-neutral-400 font-bold">Carregando…</div> : null}
-                {viewersError ? <div className="text-xs text-red-300 font-bold">{viewersError}</div> : null}
-                {!viewersLoading && !viewersError && viewers.length === 0 ? (
-                  <div className="text-xs text-neutral-400 font-bold">Ainda sem visualizações.</div>
-                ) : null}
-                {viewers.map((v) => {
-                  const vid = String(v?.viewerId || '').trim()
-                  const uname = String(v?.displayName || '').trim() || 'Usuário'
-                  const photo = String(v?.photoUrl || '').trim()
-                  const when = v?.viewedAt ? formatAgo(String(v.viewedAt)) : ''
-                  return (
-                    <div key={vid || uname} className="flex items-center gap-2">
-                      <div className="w-9 h-9 rounded-xl overflow-hidden bg-neutral-950 border border-neutral-800 flex items-center justify-center shrink-0">
-                        {photo ? (
-                          <Image src={photo} alt={uname} width={36} height={36} className="w-full h-full object-cover" />
-                        ) : (
-                          <span className="text-yellow-500 font-black text-xs">{initials(uname)}</span>
-                        )}
-                      </div>
-                      <div className="min-w-0 flex-1">
-                        <div className="text-[11px] text-neutral-200 font-black truncate">{uname}</div>
-                      </div>
-                      <div className="text-[11px] text-neutral-400 font-bold tabular-nums">{when}</div>
-                    </div>
-                  )
-                })}
-              </div>
-            </motion.div>
-          ) : null}
-
-          {commentsOpen ? (
-            <motion.div
-              initial={{ y: 40, opacity: 0 }}
-              animate={{ y: 0, opacity: 1 }}
-              className="mt-3 bg-neutral-900/80 border border-neutral-800 rounded-2xl overflow-hidden"
-            >
-              <div className="max-h-[34vh] overflow-y-auto custom-scrollbar p-3 space-y-2">
-                {commentsLoading ? <div className="text-xs text-neutral-400 font-bold">Carregando…</div> : null}
-                {commentsError ? <div className="text-xs text-red-300 font-bold">{commentsError}</div> : null}
-                {!commentsLoading && !commentsError && comments.length === 0 ? (
-                  <div className="text-xs text-neutral-400 font-bold">Seja o primeiro a comentar.</div>
-                ) : null}
-                {comments.map((c) => {
-                  const u = c?.user || {}
-                  const uname = String(u?.displayName || '').trim() || 'Usuário'
-                  return (
-                    <div key={String(c?.id)} className="flex items-start gap-2">
-                      <div className="w-8 h-8 rounded-xl overflow-hidden bg-neutral-950 border border-neutral-800 flex items-center justify-center shrink-0">
-                        {u?.photoUrl ? (
-                          <Image src={u.photoUrl} alt={uname} width={32} height={32} className="w-full h-full object-cover" />
-                        ) : (
-                          <span className="text-yellow-500 font-black text-xs">{initials(uname)}</span>
-                        )}
-                      </div>
-                      <div className="min-w-0 flex-1">
-                        <div className="text-[11px] text-neutral-300 font-black">{uname}</div>
-                        <div className="text-xs text-neutral-200 font-bold whitespace-pre-wrap break-words">{String(c?.body || '')}</div>
-                      </div>
-                    </div>
-                  )
-                })}
-              </div>
-
-              <div className="p-3 border-t border-neutral-800 flex items-center gap-2">
-                <input
-                  value={commentText}
-                  onChange={(e) => setCommentText(e.target.value)}
-                  onKeyDown={(e) => {
-                    if (e.key === 'Enter') sendComment()
-                  }}
-                  className="flex-1 bg-neutral-950 border border-neutral-800 rounded-xl px-3 py-3 text-sm text-white font-bold outline-none focus:border-yellow-500/40"
-                  placeholder="Comente…"
-                />
-                <button
-                  type="button"
-                  onClick={sendComment}
-                  className="px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-                >
-                  Enviar
-                </button>
-              </div>
-            </motion.div>
-          ) : null}
-        </div>
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/components/dashboard/StoriesBar 3.tsx b/_archive/duplicates/src/components/dashboard/StoriesBar 3.tsx
deleted file mode 100644
index b02e1be..0000000
--- a/_archive/duplicates/src/components/dashboard/StoriesBar 3.tsx	
+++ /dev/null
@@ -1,805 +0,0 @@
-'use client'
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
-import Image from 'next/image'
-import { Heart, MessageCircle, X, ChevronLeft, ChevronRight, Plus, Trash2, Loader2, Eye } from 'lucide-react'
-import { motion } from 'framer-motion'
-import { createClient } from '@/utils/supabase/client'
-import { useDialog } from '@/contexts/DialogContext'
-
-type Story = {
-  id: string
-  createdAt: string
-  expiresAt: string
-  caption: string | null
-  mediaUrl: string | null
-  viewed: boolean
-  likeCount: number
-  hasLiked: boolean
-  commentCount: number
-}
-
-type StoryGroup = {
-  authorId: string
-  displayName: string | null
-  photoUrl: string | null
-  role: string | null
-  hasStories?: boolean
-  hasUnseen?: boolean
-  stories: Story[]
-}
-
-const initials = (name: string) => {
-  const n = String(name || '').trim()
-  if (!n) return '?'
-  return n.slice(0, 1).toUpperCase()
-}
-
-const formatAgo = (iso: string) => {
-  const ms = new Date(iso).getTime()
-  if (!Number.isFinite(ms)) return ''
-  const diffMin = Math.floor((Date.now() - ms) / 60000)
-  if (diffMin < 1) return 'agora'
-  if (diffMin < 60) return `${diffMin}m`
-  const diffH = Math.floor(diffMin / 60)
-  if (diffH < 24) return `${diffH}h`
-  const diffD = Math.floor(diffH / 24)
-  return `${diffD}d`
-}
-
-export default function StoriesBar({ currentUserId }: { currentUserId?: string }) {
-  const myId = typeof currentUserId === 'string' ? currentUserId : ''
-  const [groups, setGroups] = useState<StoryGroup[]>([])
-  const [loading, setLoading] = useState(false)
-  const [uploading, setUploading] = useState(false)
-  const [error, setError] = useState('')
-  const [open, setOpen] = useState(false)
-  const [openAuthorId, setOpenAuthorId] = useState<string>('')
-  const uploadRef = useRef<HTMLInputElement | null>(null)
-
-  const reload = useCallback(async () => {
-    setLoading(true)
-    setError('')
-    try {
-      const res = await fetch('/api/social/stories/list', { method: 'GET' })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao carregar stories'))
-      const arr = Array.isArray(json?.data) ? (json.data as StoryGroup[]) : []
-      setGroups(arr)
-    } catch (e: any) {
-      setError(String(e?.message || e))
-      setGroups([])
-    } finally {
-      setLoading(false)
-    }
-  }, [])
-
-  const uploadStory = async (file: File) => {
-    setUploading(true)
-    setError('')
-    try {
-      const supabase = createClient()
-      const { data: authData } = await supabase.auth.getUser()
-      const uid = String(authData?.user?.id || '').trim()
-      if (!uid) throw new Error('unauthorized')
-
-      const rawName = String(file?.name || '').trim().toLowerCase()
-      const ext = rawName.endsWith('.png') ? '.png' : rawName.endsWith('.jpeg') ? '.jpeg' : rawName.endsWith('.jpg') ? '.jpg' : '.jpg'
-      const storyId = typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}`
-      const path = `${uid}/stories/${storyId}${ext}`
-
-      const signResp = await fetch('/api/storage/social-stories/signed-upload', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ path }),
-      })
-      const signJson = await signResp.json().catch(() => null)
-      if (!signResp.ok || !signJson?.ok || !signJson?.token) throw new Error(String(signJson?.error || 'Falha ao preparar upload'))
-
-      const { error: upErr } = await supabase.storage
-        .from('social-stories')
-        .uploadToSignedUrl(path, String(signJson.token), file, { contentType: file.type || 'image/jpeg' })
-      if (upErr) throw upErr
-
-      const createResp = await fetch('/api/social/stories/create', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ mediaPath: path, caption: null, meta: { source: 'upload' } }),
-      })
-      const createJson = await createResp.json().catch(() => null)
-      if (!createResp.ok || !createJson?.ok) throw new Error(String(createJson?.error || 'Falha ao publicar'))
-
-      await reload()
-    } catch (e: any) {
-      const msg = String(e?.message || e)
-      setError(msg === 'unauthorized' ? 'Faça login novamente para publicar.' : 'Não foi possível publicar seu story.')
-    } finally {
-      setUploading(false)
-      try {
-        if (uploadRef.current) uploadRef.current.value = ''
-      } catch {}
-    }
-  }
-
-  useEffect(() => {
-    reload()
-    const onRefresh = () => reload()
-    try {
-      window.addEventListener('irontracks:stories:refresh', onRefresh as any)
-    } catch {}
-    return () => {
-      try {
-        window.removeEventListener('irontracks:stories:refresh', onRefresh as any)
-      } catch {}
-    }
-  }, [reload])
-
-  const ordered = useMemo(() => {
-    const arr = Array.isArray(groups) ? groups : []
-    if (!myId) return arr
-    const mine = arr.find((g) => g.authorId === myId)
-    if (!mine) return arr
-    return [mine, ...arr.filter((g) => g.authorId !== myId)]
-  }, [groups, myId])
-
-  const currentGroup = useMemo(() => ordered.find((g) => g.authorId === openAuthorId) || null, [ordered, openAuthorId])
-  const closeViewer = useCallback(() => setOpen(false), [])
-  const handleStoryUpdated = useCallback(
-    (storyId: string, patch: Partial<Story>) => {
-      const authorId = openAuthorId
-      if (!authorId) return
-      setGroups((prev) =>
-        prev.map((g) => {
-          if (g.authorId !== authorId) return g
-          const nextStories = (Array.isArray(g.stories) ? g.stories : []).map((st) => (st.id === storyId ? { ...st, ...patch } : st))
-          const hasUnseen = nextStories.some((st) => !st.viewed)
-          return { ...g, stories: nextStories, hasUnseen }
-        })
-      )
-    },
-    [openAuthorId]
-  )
-  const handleStoryDeleted = useCallback(
-    (storyId: string) => {
-      const authorId = openAuthorId
-      if (!authorId) return
-      setGroups((prev) =>
-        prev.map((g) => {
-          if (g.authorId !== authorId) return g
-          const nextStories = (Array.isArray(g.stories) ? g.stories : []).filter((st) => st.id !== storyId)
-          const hasUnseen = nextStories.some((st) => !st.viewed)
-          return { ...g, stories: nextStories, hasUnseen }
-        })
-      )
-    },
-    [openAuthorId]
-  )
-
-  return (
-    <div className="mb-4">
-      <input
-        ref={uploadRef}
-        type="file"
-        accept="image/*"
-        className="hidden"
-        onChange={(e) => {
-          const f = e.target.files && e.target.files[0] ? e.target.files[0] : null
-          if (!f) return
-          if (!String(f.type || '').toLowerCase().startsWith('image/')) {
-            setError('Selecione uma imagem.')
-            return
-          }
-          if (f.size > 12 * 1024 * 1024) {
-            setError('Imagem muito grande (máx 12MB).')
-            return
-          }
-          uploadStory(f)
-        }}
-      />
-      <div className="flex items-center justify-between px-1">
-        <div className="text-xs font-bold text-neutral-500 uppercase tracking-widest">Stories</div>
-        <button
-          type="button"
-          onClick={reload}
-          className="text-[11px] font-black text-neutral-400 hover:text-white"
-          disabled={loading || uploading}
-        >
-          {loading ? 'Carregando…' : uploading ? 'Publicando…' : 'Atualizar'}
-        </button>
-      </div>
-
-      {error ? (
-        <div className="mt-2 bg-neutral-900 border border-neutral-800 rounded-xl p-3 text-xs text-red-300 font-bold">
-          {error}
-        </div>
-      ) : null}
-
-      <div className="mt-2 flex gap-3 overflow-x-auto pb-2 custom-scrollbar">
-        {!ordered.length && loading ? (
-          <>
-            <div className="shrink-0 w-[72px]">
-              <div className="w-16 h-16 rounded-full bg-neutral-900 border border-neutral-800 mx-auto" />
-              <div className="mt-1 h-3 w-12 bg-neutral-900 border border-neutral-800 rounded-md mx-auto" />
-            </div>
-            <div className="shrink-0 w-[72px]">
-              <div className="w-16 h-16 rounded-full bg-neutral-900 border border-neutral-800 mx-auto" />
-              <div className="mt-1 h-3 w-12 bg-neutral-900 border border-neutral-800 rounded-md mx-auto" />
-            </div>
-            <div className="shrink-0 w-[72px]">
-              <div className="w-16 h-16 rounded-full bg-neutral-900 border border-neutral-800 mx-auto" />
-              <div className="mt-1 h-3 w-12 bg-neutral-900 border border-neutral-800 rounded-md mx-auto" />
-            </div>
-          </>
-        ) : null}
-        {ordered.map((g) => {
-          const hasStories = Array.isArray(g.stories) && g.stories.length > 0
-          const hasUnseen = !!g.hasUnseen
-          const ringCls = !hasStories
-            ? 'border-transparent'
-            : hasUnseen
-              ? 'border-red-500'
-              : 'border-neutral-400/60'
-
-          const name = String(g.displayName || '').trim() || (g.authorId === myId ? 'Você' : 'Amigo')
-          return (
-            <button
-              key={g.authorId}
-              type="button"
-              onClick={() => {
-                if (g.authorId === myId && !hasStories) {
-                  if (!uploading && uploadRef.current) uploadRef.current.click()
-                  return
-                }
-                if (!hasStories) return
-                setOpenAuthorId(g.authorId)
-                setOpen(true)
-              }}
-              className="shrink-0 w-[72px] focus:outline-none"
-              aria-label={hasStories ? `Abrir stories de ${name}` : `Sem stories de ${name}`}
-            >
-              <div className={`w-16 h-16 rounded-full border-2 ${ringCls} p-1 mx-auto relative`}>
-                <div className="w-full h-full rounded-full overflow-hidden bg-neutral-900 border border-neutral-800 flex items-center justify-center">
-                  {g.photoUrl ? (
-                    <Image src={g.photoUrl} alt={name} width={64} height={64} className="w-full h-full object-cover" />
-                  ) : (
-                    <span className="text-yellow-500 font-black">{initials(name)}</span>
-                  )}
-                </div>
-
-                {g.authorId === myId && !hasStories ? (
-                  <div className="absolute -right-1 -bottom-1 w-6 h-6 rounded-full bg-yellow-500 border-2 border-black flex items-center justify-center">
-                    <Plus size={14} className="text-black" />
-                  </div>
-                ) : null}
-              </div>
-              <div className="mt-1 text-[11px] text-neutral-300 font-bold truncate text-center">{name}</div>
-            </button>
-          )
-        })}
-      </div>
-
-      {ordered.length === 0 && !loading && !error ? (
-        <div className="mt-2 px-1 text-[11px] text-neutral-400 font-bold">
-          Stories ainda não carregaram. Toque em <span className="text-neutral-200">Atualizar</span>.
-        </div>
-      ) : null}
-
-      {ordered.length > 0 && ordered.every((g) => !Array.isArray(g.stories) || g.stories.length === 0) && !error ? (
-        <div className="mt-2 px-1 text-[11px] text-neutral-400 font-bold">
-          Sem stories por enquanto. Para postar: abra a <span className="text-neutral-200">Foto</span> no relatório do treino e toque em{' '}
-          <span className="text-neutral-200">Postar no IronTracks (24h)</span> ou clique no <span className="text-neutral-200">+</span> do seu avatar.
-        </div>
-      ) : null}
-
-      {open && currentGroup ? (
-        <StoryViewer
-          group={currentGroup}
-          myId={myId}
-          onClose={closeViewer}
-          onStoryUpdated={handleStoryUpdated}
-          onStoryDeleted={handleStoryDeleted}
-        />
-      ) : null}
-    </div>
-  )
-}
-
-function StoryViewer({
-  group,
-  myId,
-  onClose,
-  onStoryUpdated,
-  onStoryDeleted,
-}: {
-  group: StoryGroup
-  myId: string
-  onClose: () => void
-  onStoryUpdated: (storyId: string, patch: Partial<Story>) => void
-  onStoryDeleted: (storyId: string) => void
-}) {
-  const { confirm, alert } = useDialog()
-  const stories = Array.isArray(group.stories) ? group.stories : []
-  const [idx, setIdx] = useState(0)
-  const story = stories[idx] || null
-  const [commentsOpen, setCommentsOpen] = useState(false)
-  const [commentsLoading, setCommentsLoading] = useState(false)
-  const [commentsError, setCommentsError] = useState('')
-  const [comments, setComments] = useState<any[]>([])
-  const [commentText, setCommentText] = useState('')
-  const [viewersOpen, setViewersOpen] = useState(false)
-  const [viewersLoading, setViewersLoading] = useState(false)
-  const [viewersError, setViewersError] = useState('')
-  const [viewers, setViewers] = useState<any[]>([])
-  const viewersStoryIdRef = useRef<string>('')
-  const [deleting, setDeleting] = useState(false)
-  const [progress, setProgress] = useState(0)
-  const [holding, setHolding] = useState(false)
-  const [hidden, setHidden] = useState(false)
-  const rafRef = useRef<number | null>(null)
-  const lastTsRef = useRef<number>(0)
-  const elapsedRef = useRef<number>(0)
-  const closeRequestedRef = useRef(false)
-
-  const name = String(group.displayName || '').trim() || (group.authorId === myId ? 'Você' : 'Amigo')
-  const isMine = String(group.authorId || '').trim() && String(group.authorId || '').trim() === String(myId || '').trim()
-  const durationMs = 5000
-
-  const markViewed = async (storyId: string) => {
-    try {
-      await fetch('/api/social/stories/view', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId }),
-      })
-    } catch {}
-  }
-
-  useEffect(() => {
-    if (!story?.id) return
-    if (story.viewed) return
-    onStoryUpdated(story.id, { viewed: true })
-    markViewed(story.id)
-  }, [story?.id, story?.viewed, onStoryUpdated])
-
-  useEffect(() => {
-    elapsedRef.current = 0
-    lastTsRef.current = 0
-    setProgress(0)
-    setCommentsOpen(false)
-    setViewersOpen(false)
-    setViewersError('')
-    setViewers([])
-    viewersStoryIdRef.current = ''
-  }, [story?.id])
-
-  useEffect(() => {
-    try {
-      if (typeof document !== 'undefined') setHidden(Boolean(document.hidden))
-    } catch {}
-    const onVis = () => {
-      try {
-        if (typeof document !== 'undefined') setHidden(Boolean(document.hidden))
-      } catch {}
-    }
-    try {
-      document.addEventListener('visibilitychange', onVis)
-    } catch {}
-    return () => {
-      try {
-        document.removeEventListener('visibilitychange', onVis)
-      } catch {}
-    }
-  }, [])
-
-  useEffect(() => {
-    if (!story?.id) return
-
-    const tick = (ts: number) => {
-      rafRef.current = requestAnimationFrame(tick)
-      const paused = holding || commentsOpen || viewersOpen || hidden || deleting
-      if (!lastTsRef.current) {
-        lastTsRef.current = ts
-        return
-      }
-      const delta = ts - lastTsRef.current
-      lastTsRef.current = ts
-      if (paused) return
-      elapsedRef.current += delta
-      const next = Math.max(0, Math.min(1, elapsedRef.current / durationMs))
-      setProgress((prev) => (Math.abs(prev - next) < 0.005 ? prev : next))
-      if (next >= 1) {
-        elapsedRef.current = 0
-        setProgress(0)
-        setIdx((v) => {
-          const nextIdx = v + 1
-          if (nextIdx >= stories.length) {
-            if (!closeRequestedRef.current) {
-              closeRequestedRef.current = true
-              try {
-                window.setTimeout(() => {
-                  try {
-                    onClose()
-                  } catch {}
-                }, 0)
-              } catch {}
-            }
-            return v
-          }
-          return nextIdx
-        })
-      }
-    }
-
-    rafRef.current = requestAnimationFrame(tick)
-    return () => {
-      try {
-        if (rafRef.current) cancelAnimationFrame(rafRef.current)
-      } catch {}
-      rafRef.current = null
-    }
-  }, [commentsOpen, deleting, hidden, holding, onClose, stories.length, story?.id, viewersOpen])
-
-  const loadComments = async (storyId: string) => {
-    setCommentsLoading(true)
-    setCommentsError('')
-    try {
-      const res = await fetch(`/api/social/stories/comments?storyId=${encodeURIComponent(storyId)}&limit=200`)
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao carregar comentários'))
-      setComments(Array.isArray(json?.data) ? json.data : [])
-    } catch (e: any) {
-      setCommentsError(String(e?.message || e))
-      setComments([])
-    } finally {
-      setCommentsLoading(false)
-    }
-  }
-
-  const loadViewers = async (storyId: string) => {
-    const sid = String(storyId || '').trim()
-    if (!sid) return
-    setViewersLoading(true)
-    setViewersError('')
-    try {
-      const res = await fetch(`/api/social/stories/views?storyId=${encodeURIComponent(sid)}`, { method: 'GET' })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao carregar visualizações'))
-      const arr = Array.isArray(json?.data) ? json.data : []
-      viewersStoryIdRef.current = sid
-      setViewers(arr)
-    } catch (e: any) {
-      setViewersError(String(e?.message || e))
-      setViewers([])
-    } finally {
-      setViewersLoading(false)
-    }
-  }
-
-  const toggleLike = async () => {
-    if (!story?.id) return
-    const nextLiked = !story.hasLiked
-    onStoryUpdated(story.id, { hasLiked: nextLiked, likeCount: Math.max(0, story.likeCount + (nextLiked ? 1 : -1)) })
-    try {
-      const res = await fetch('/api/social/stories/like', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId: story.id, like: nextLiked }),
-      })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao curtir'))
-    } catch {
-      onStoryUpdated(story.id, { hasLiked: story.hasLiked, likeCount: story.likeCount })
-    }
-  }
-
-  const sendComment = async () => {
-    if (!story?.id) return
-    const text = String(commentText || '').trim()
-    if (!text) return
-    setCommentText('')
-    try {
-      const res = await fetch('/api/social/stories/comments', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId: story.id, body: text }),
-      })
-      const json = await res.json().catch(() => null)
-      if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao comentar'))
-      setComments((prev) => [...prev, json.data])
-      onStoryUpdated(story.id, { commentCount: story.commentCount + 1 })
-    } catch {}
-  }
-
-  if (!story) return null
-  const viewCount = viewersStoryIdRef.current === story.id ? viewers.length : 0
-
-  return (
-    <div className="fixed inset-0 z-[2000] bg-black flex items-center justify-center">
-      <div className="absolute inset-0" onClick={deleting ? undefined : onClose} />
-
-      <div
-        className="relative w-full max-w-md h-[92vh] bg-neutral-950 border border-neutral-800 rounded-2xl overflow-hidden"
-        onPointerDown={() => setHolding(true)}
-        onPointerUp={() => setHolding(false)}
-        onPointerCancel={() => setHolding(false)}
-      >
-        <div className="absolute top-0 left-0 right-0 p-3 z-20">
-          <div className="flex gap-1 mb-2">
-            {stories.map((s, i) => (
-              <div key={s.id} className="flex-1 h-1 rounded-full bg-white/20 overflow-hidden">
-                <div
-                  className="h-full bg-white/90"
-                  style={{
-                    width: `${Math.round((i < idx ? 1 : i === idx ? progress : 0) * 100)}%`,
-                  }}
-                />
-              </div>
-            ))}
-          </div>
-
-          <div className="flex items-center gap-3">
-            <div className="w-10 h-10 rounded-full overflow-hidden bg-neutral-900 border border-neutral-800 flex items-center justify-center">
-              {group.photoUrl ? (
-                <Image src={group.photoUrl} alt={name} width={40} height={40} className="w-full h-full object-cover" />
-              ) : (
-                <span className="text-yellow-500 font-black">{initials(name)}</span>
-              )}
-            </div>
-            <div className="min-w-0 flex-1">
-              <div className="text-sm text-white font-black truncate">{name}</div>
-              <div className="text-[11px] text-neutral-400 font-bold">{formatAgo(story.createdAt)}</div>
-            </div>
-            {isMine ? (
-              <button
-                type="button"
-                onClick={async () => {
-                  if (!story?.id || deleting) return
-                  const ok = await confirm(
-                    'Tem certeza que deseja deletar este story?\nEssa ação não pode ser desfeita.',
-                    'Deletar story',
-                    { confirmText: 'Deletar', cancelText: 'Cancelar' }
-                  )
-                  if (!ok) return
-                  setDeleting(true)
-                  try {
-                    const res = await fetch('/api/social/stories/delete', {
-                      method: 'POST',
-                      headers: { 'content-type': 'application/json' },
-                      body: JSON.stringify({ storyId: story.id }),
-                    })
-                    const json = await res.json().catch(() => null)
-                    if (!res.ok || !json?.ok) throw new Error(String(json?.error || 'Falha ao deletar'))
-                    onStoryDeleted(story.id)
-                    try {
-                      window.dispatchEvent(new Event('irontracks:stories:refresh'))
-                    } catch {}
-                    onClose()
-                  } catch (e: any) {
-                    await alert(String(e?.message || 'Não foi possível deletar agora. Tente novamente.'), 'Erro')
-                  } finally {
-                    setDeleting(false)
-                  }
-                }}
-                className="w-10 h-10 rounded-xl bg-neutral-900/60 border border-neutral-800 text-red-200 hover:bg-neutral-900 flex items-center justify-center disabled:opacity-60"
-                aria-label="Deletar story"
-                disabled={deleting}
-              >
-                {deleting ? <Loader2 size={18} className="animate-spin" /> : <Trash2 size={18} />}
-              </button>
-            ) : null}
-            <button
-              type="button"
-              onClick={deleting ? undefined : onClose}
-              className="w-10 h-10 rounded-xl bg-neutral-900/60 border border-neutral-800 text-neutral-200 hover:bg-neutral-900 flex items-center justify-center"
-              aria-label="Fechar"
-              disabled={deleting}
-            >
-              <X size={18} />
-            </button>
-          </div>
-        </div>
-
-        <div className="absolute inset-0 flex items-center justify-center">
-          {story.mediaUrl ? (
-            <Image src={story.mediaUrl} alt="Story" fill className="object-contain" sizes="(max-width: 768px) 100vw, 420px" />
-          ) : (
-            <div className="text-neutral-400 font-bold">Mídia indisponível</div>
-          )}
-        </div>
-
-        <button
-          type="button"
-          onClick={() => setIdx((v) => Math.max(0, v - 1))}
-          className="absolute left-0 top-0 bottom-0 w-1/4 z-10"
-          aria-label="Anterior"
-          disabled={deleting}
-        />
-        <button
-          type="button"
-          onClick={() => setIdx((v) => Math.min(stories.length - 1, v + 1))}
-          className="absolute right-0 top-0 bottom-0 w-1/4 z-10"
-          aria-label="Próximo"
-          disabled={deleting}
-        />
-
-        <div className="absolute bottom-0 left-0 right-0 p-3 z-20">
-          <div className="flex items-center justify-between gap-2">
-            <div className="flex items-center gap-2">
-              {isMine ? (
-                <>
-                  <button
-                    type="button"
-                    onClick={() => {
-                      const next = !viewersOpen
-                      setViewersOpen(next)
-                      setCommentsOpen(false)
-                      if (next && story?.id) loadViewers(story.id)
-                    }}
-                    className="w-12 h-12 rounded-2xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                    aria-label="Visualizações"
-                    disabled={deleting}
-                  >
-                    <Eye size={18} />
-                  </button>
-                  <div className="text-xs text-neutral-300 font-bold tabular-nums">{viewCount}</div>
-                </>
-              ) : null}
-              <button
-                type="button"
-                onClick={toggleLike}
-                className={`w-12 h-12 rounded-2xl border font-black inline-flex items-center justify-center ${
-                  story.hasLiked ? 'bg-red-500/15 border-red-500/40 text-red-300' : 'bg-neutral-900/70 border-neutral-800 text-neutral-200'
-                }`}
-                aria-label="Curtir"
-                disabled={deleting}
-              >
-                <Heart size={18} className={story.hasLiked ? 'fill-current' : ''} />
-              </button>
-              <div className="text-xs text-neutral-300 font-bold tabular-nums">{story.likeCount}</div>
-
-              <button
-                type="button"
-                onClick={() => {
-                  const next = !commentsOpen
-                  setCommentsOpen(next)
-                  setViewersOpen(false)
-                  if (next && story?.id) loadComments(story.id)
-                }}
-                className="w-12 h-12 rounded-2xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                aria-label="Comentários"
-                disabled={deleting}
-              >
-                <MessageCircle size={18} />
-              </button>
-              <div className="text-xs text-neutral-300 font-bold tabular-nums">{story.commentCount}</div>
-            </div>
-
-            <div className="flex items-center gap-2">
-              <button
-                type="button"
-                onClick={() => setIdx((v) => Math.max(0, v - 1))}
-                className="w-10 h-10 rounded-xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                aria-label="Story anterior"
-                disabled={idx === 0 || deleting}
-              >
-                <ChevronLeft size={18} />
-              </button>
-              <button
-                type="button"
-                onClick={() => setIdx((v) => Math.min(stories.length - 1, v + 1))}
-                className="w-10 h-10 rounded-xl bg-neutral-900/70 border border-neutral-800 text-neutral-200 inline-flex items-center justify-center"
-                aria-label="Próximo story"
-                disabled={idx === stories.length - 1 || deleting}
-              >
-                <ChevronRight size={18} />
-              </button>
-            </div>
-          </div>
-
-          {viewersOpen ? (
-            <motion.div
-              initial={{ y: 40, opacity: 0 }}
-              animate={{ y: 0, opacity: 1 }}
-              className="mt-3 bg-neutral-900/80 border border-neutral-800 rounded-2xl overflow-hidden"
-            >
-              <div className="px-3 py-2 border-b border-neutral-800 flex items-center justify-between gap-2">
-                <div className="text-xs text-neutral-200 font-black">
-                  Visualizações{viewCount ? ` (${viewCount})` : ''}
-                </div>
-                <button
-                  type="button"
-                  onClick={() => setViewersOpen(false)}
-                  className="px-3 py-1.5 rounded-xl bg-neutral-950 border border-neutral-800 text-neutral-200 font-black hover:bg-neutral-900"
-                >
-                  Fechar
-                </button>
-              </div>
-              <div className="max-h-[34vh] overflow-y-auto custom-scrollbar p-3 space-y-2">
-                {viewersLoading ? <div className="text-xs text-neutral-400 font-bold">Carregando…</div> : null}
-                {viewersError ? <div className="text-xs text-red-300 font-bold">{viewersError}</div> : null}
-                {!viewersLoading && !viewersError && viewers.length === 0 ? (
-                  <div className="text-xs text-neutral-400 font-bold">Ainda sem visualizações.</div>
-                ) : null}
-                {viewers.map((v) => {
-                  const vid = String(v?.viewerId || '').trim()
-                  const uname = String(v?.displayName || '').trim() || 'Usuário'
-                  const photo = String(v?.photoUrl || '').trim()
-                  const when = v?.viewedAt ? formatAgo(String(v.viewedAt)) : ''
-                  return (
-                    <div key={vid || uname} className="flex items-center gap-2">
-                      <div className="w-9 h-9 rounded-xl overflow-hidden bg-neutral-950 border border-neutral-800 flex items-center justify-center shrink-0">
-                        {photo ? (
-                          <Image src={photo} alt={uname} width={36} height={36} className="w-full h-full object-cover" />
-                        ) : (
-                          <span className="text-yellow-500 font-black text-xs">{initials(uname)}</span>
-                        )}
-                      </div>
-                      <div className="min-w-0 flex-1">
-                        <div className="text-[11px] text-neutral-200 font-black truncate">{uname}</div>
-                      </div>
-                      <div className="text-[11px] text-neutral-400 font-bold tabular-nums">{when}</div>
-                    </div>
-                  )
-                })}
-              </div>
-            </motion.div>
-          ) : null}
-
-          {commentsOpen ? (
-            <motion.div
-              initial={{ y: 40, opacity: 0 }}
-              animate={{ y: 0, opacity: 1 }}
-              className="mt-3 bg-neutral-900/80 border border-neutral-800 rounded-2xl overflow-hidden"
-            >
-              <div className="max-h-[34vh] overflow-y-auto custom-scrollbar p-3 space-y-2">
-                {commentsLoading ? <div className="text-xs text-neutral-400 font-bold">Carregando…</div> : null}
-                {commentsError ? <div className="text-xs text-red-300 font-bold">{commentsError}</div> : null}
-                {!commentsLoading && !commentsError && comments.length === 0 ? (
-                  <div className="text-xs text-neutral-400 font-bold">Seja o primeiro a comentar.</div>
-                ) : null}
-                {comments.map((c) => {
-                  const u = c?.user || {}
-                  const uname = String(u?.displayName || '').trim() || 'Usuário'
-                  return (
-                    <div key={String(c?.id)} className="flex items-start gap-2">
-                      <div className="w-8 h-8 rounded-xl overflow-hidden bg-neutral-950 border border-neutral-800 flex items-center justify-center shrink-0">
-                        {u?.photoUrl ? (
-                          <Image src={u.photoUrl} alt={uname} width={32} height={32} className="w-full h-full object-cover" />
-                        ) : (
-                          <span className="text-yellow-500 font-black text-xs">{initials(uname)}</span>
-                        )}
-                      </div>
-                      <div className="min-w-0 flex-1">
-                        <div className="text-[11px] text-neutral-300 font-black">{uname}</div>
-                        <div className="text-xs text-neutral-200 font-bold whitespace-pre-wrap break-words">{String(c?.body || '')}</div>
-                      </div>
-                    </div>
-                  )
-                })}
-              </div>
-
-              <div className="p-3 border-t border-neutral-800 flex items-center gap-2">
-                <input
-                  value={commentText}
-                  onChange={(e) => setCommentText(e.target.value)}
-                  onKeyDown={(e) => {
-                    if (e.key === 'Enter') sendComment()
-                  }}
-                  className="flex-1 bg-neutral-950 border border-neutral-800 rounded-xl px-3 py-3 text-sm text-white font-bold outline-none focus:border-yellow-500/40"
-                  placeholder="Comente…"
-                />
-                <button
-                  type="button"
-                  onClick={sendComment}
-                  className="px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-                >
-                  Enviar
-                </button>
-              </div>
-            </motion.div>
-          ) : null}
-        </div>
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/components/dashboard/StudentDashboard 2.tsx b/_archive/duplicates/src/components/dashboard/StudentDashboard 2.tsx
deleted file mode 100644
index d61b7cc..0000000
--- a/_archive/duplicates/src/components/dashboard/StudentDashboard 2.tsx	
+++ /dev/null
@@ -1,343 +0,0 @@
-'use client'
-
-import React, { useEffect, useRef, useState } from 'react'
-
-import { Plus, Dumbbell, Play, Share2, Copy, Pencil, Trash2, Loader2 } from 'lucide-react'
-
-export type DashboardWorkout = {
-  id?: string
-  user_id?: string | null
-  created_by?: string | null
-  title?: string
-  notes?: string | null
-  exercises?: any[]
-}
-
-type MaybePromise<T> = T | Promise<T>
-
-type Props = {
-  workouts: DashboardWorkout[]
-  profileIncomplete: boolean
-  onOpenCompleteProfile: () => void
-  view: 'dashboard' | 'assessments'
-  onChangeView: (next: 'dashboard' | 'assessments') => void
-  assessmentsContent?: React.ReactNode
-  settings?: {
-    dashboardDensity?: 'compact' | 'comfortable'
-  } | null
-  onCreateWorkout: () => MaybePromise<void>
-  onQuickView: (w: DashboardWorkout) => void
-  onStartSession: (w: DashboardWorkout) => MaybePromise<void | boolean>
-  onShareWorkout: (w: DashboardWorkout) => MaybePromise<void>
-  onDuplicateWorkout: (w: DashboardWorkout) => MaybePromise<void>
-  onEditWorkout: (w: DashboardWorkout) => MaybePromise<void>
-  onDeleteWorkout: (id?: string, title?: string) => MaybePromise<void>
-  currentUserId?: string
-  exportingAll?: boolean
-  onExportAll: () => MaybePromise<void>
-  onOpenJsonImport: () => void
-  onOpenIronScanner: () => void
-  streakStats?: {
-    currentStreak: number
-    bestStreak: number
-    totalWorkouts: number
-    totalVolumeKg: number
-    badges: { id: string; label: string; kind: string }[]
-  } | null
-  streakLoading?: boolean
-}
-
-export default function StudentDashboard(props: Props) {
-  const workouts = Array.isArray(props.workouts) ? props.workouts : []
-  const density = props.settings?.dashboardDensity === 'compact' ? 'compact' : 'comfortable'
-  const [toolsOpen, setToolsOpen] = useState(false)
-  const [creatingWorkout, setCreatingWorkout] = useState(false)
-  const [pendingAction, setPendingAction] = useState<
-    | {
-        workoutKey: string
-        type: 'start' | 'share' | 'duplicate' | 'edit' | 'delete'
-      }
-    | null
-  >(null)
-  const TABS_BAR_MIN_HEIGHT_PX = 60
-  const CREATE_WORKOUT_LOADING_TIMEOUT_MS = 900
-  const isMountedRef = useRef(true)
-
-  useEffect(() => {
-    isMountedRef.current = true
-    return () => {
-      isMountedRef.current = false
-    }
-  }, [])
-
-  const safeSetPendingAction = (next: typeof pendingAction) => {
-    if (!isMountedRef.current) return
-    setPendingAction(next)
-  }
-
-  const getWorkoutKey = (w: DashboardWorkout, idx: number) => String(w?.id ?? idx)
-  const isWorkoutBusy = (workoutKey: string) => pendingAction?.workoutKey === workoutKey
-  const isActionBusy = (workoutKey: string, type: NonNullable<typeof pendingAction>['type']) =>
-    pendingAction?.workoutKey === workoutKey && pendingAction?.type === type
-
-  const runWorkoutAction = async (workoutKey: string, type: NonNullable<typeof pendingAction>['type'], fn: () => unknown) => {
-    if (isWorkoutBusy(workoutKey)) return
-    safeSetPendingAction({ workoutKey, type })
-    try {
-      await Promise.resolve(fn())
-    } finally {
-      safeSetPendingAction(null)
-    }
-  }
-
-  useEffect(() => {
-    if (!toolsOpen) return
-    const onKeyDown = (e: KeyboardEvent) => {
-      if (e.key !== 'Escape') return
-      e.preventDefault()
-      setToolsOpen(false)
-    }
-    try {
-      window.addEventListener('keydown', onKeyDown)
-    } catch {}
-    return () => {
-      try {
-        window.removeEventListener('keydown', onKeyDown)
-      } catch {}
-    }
-  }, [toolsOpen])
-
-  return (
-    <div className={density === 'compact' ? 'p-4 space-y-3 pb-24' : 'p-4 space-y-4 pb-24'}>
-      {props.profileIncomplete && (
-        <div className="bg-neutral-800 border border-yellow-500/30 rounded-xl p-4 flex items-start justify-between gap-3">
-          <div>
-            <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Perfil incompleto</div>
-            <div className="text-sm text-neutral-300 mt-1">Complete seu nome de exibição para personalizar sua conta.</div>
-          </div>
-          <button
-            type="button"
-            onClick={props.onOpenCompleteProfile}
-            className="shrink-0 bg-yellow-500 text-black font-black px-4 py-2 rounded-xl active:scale-95 transition-transform"
-          >
-            Terminar cadastro
-          </button>
-        </div>
-      )}
-
-      <div style={{ minHeight: `${TABS_BAR_MIN_HEIGHT_PX}px` }}>
-        <div className="sticky top-[var(--dashboard-sticky-top)] z-30">
-          <div className="bg-neutral-900/70 backdrop-blur-md border border-neutral-800/70 rounded-2xl p-1 shadow-lg shadow-black/30">
-            <div className="bg-neutral-800 border border-neutral-700 rounded-xl p-1 flex gap-1">
-              <button
-                onClick={() => props.onChangeView('dashboard')}
-                className={`flex-1 min-h-[44px] px-3 rounded-lg font-black text-xs uppercase tracking-wider transition-colors ${
-                  props.view === 'dashboard'
-                    ? 'bg-neutral-900 text-yellow-500 border border-yellow-500/30'
-                    : 'bg-transparent text-neutral-400 hover:text-white'
-                }`}
-              >
-                Treinos
-              </button>
-              <button
-                onClick={() => props.onChangeView('assessments')}
-                className={`flex-1 min-h-[44px] px-3 rounded-lg font-black text-xs uppercase tracking-wider transition-colors ${
-                  props.view === 'assessments'
-                    ? 'bg-neutral-900 text-yellow-500 border border-yellow-500/30'
-                    : 'bg-transparent text-neutral-400 hover:text-white'
-                }`}
-              >
-                Avaliações
-              </button>
-            </div>
-          </div>
-        </div>
-      </div>
-
-      {props.view === 'assessments' ? <div className="pt-2">{props.assessmentsContent ?? null}</div> : null}
-
-      {props.view === 'dashboard' && (
-        <>
-          <button
-            onClick={() => {
-              setCreatingWorkout(true)
-              try {
-                props.onCreateWorkout()
-              } catch {
-                setCreatingWorkout(false)
-              }
-              try {
-                window.setTimeout(() => setCreatingWorkout(false), CREATE_WORKOUT_LOADING_TIMEOUT_MS)
-              } catch {}
-            }}
-            disabled={creatingWorkout}
-            className="w-full min-h-[44px] bg-yellow-500 p-4 rounded-xl font-black text-black flex items-center justify-center gap-2 shadow-lg shadow-yellow-900/20 hover:bg-yellow-400 transition-transform active:scale-95 disabled:opacity-70"
-          >
-            {creatingWorkout ? <Loader2 size={20} className="animate-spin" /> : <Plus size={24} />}
-            {creatingWorkout ? 'Abrindo editor...' : 'Novo Treino'}
-          </button>
-
-          <div className={density === 'compact' ? 'space-y-2' : 'space-y-3'}>
-            <div className="flex items-center justify-between">
-              <h3 className="text-xs font-bold text-neutral-500 uppercase tracking-widest">Meus Treinos</h3>
-              <div className="relative">
-                <button
-                  type="button"
-                  onClick={() => setToolsOpen((v) => !v)}
-                  className="min-h-[44px] px-3 py-2 bg-neutral-800 border border-neutral-700 text-neutral-200 rounded-xl font-bold text-xs uppercase hover:bg-neutral-700"
-                  aria-expanded={toolsOpen}
-                >
-                  Ferramentas
-                </button>
-                {toolsOpen && (
-                  <>
-                    <div className="fixed inset-0 z-40" onClick={() => setToolsOpen(false)} />
-                    <div className="absolute right-0 mt-2 w-56 bg-neutral-900 border border-neutral-800 rounded-xl shadow-2xl z-50 overflow-hidden text-neutral-300">
-                      <div className="p-2 space-y-1">
-                        <button
-                          type="button"
-                          onClick={() => {
-                            setToolsOpen(false)
-                            props.onOpenIronScanner()
-                          }}
-                          className="w-full flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-neutral-800 text-sm"
-                        >
-                          <span className="font-bold text-white">Scanner de Treino (Imagem)</span>
-                          <span className="text-yellow-500">📷</span>
-                        </button>
-                        <button
-                          type="button"
-                          onClick={() => {
-                            setToolsOpen(false)
-                            props.onOpenJsonImport()
-                          }}
-                          className="w-full flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-neutral-800 text-sm"
-                        >
-                          <span className="font-bold text-white">Importar JSON</span>
-                          <span className="text-yellow-500">↵</span>
-                        </button>
-                        <button
-                          type="button"
-                          onClick={() => {
-                            setToolsOpen(false)
-                            props.onExportAll()
-                          }}
-                          disabled={!!props.exportingAll}
-                          className="w-full flex items-center justify-between gap-3 px-3 py-2 rounded-lg hover:bg-neutral-800 text-sm disabled:opacity-50"
-                        >
-                          <span className="text-neutral-200">{props.exportingAll ? 'Exportando...' : 'Exportar JSON'}</span>
-                          {props.exportingAll ? <Loader2 size={14} className="text-yellow-500 animate-spin" /> : <span className="text-neutral-500">↓</span>}
-                        </button>
-                      </div>
-                    </div>
-                  </>
-                )}
-              </div>
-            </div>
-
-            {workouts.length === 0 && (
-              <div className="text-center py-10 text-neutral-600">
-                <div className="w-16 h-16 bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4 opacity-50">
-                  <Dumbbell size={32} />
-                </div>
-                <p>Nenhum treino criado.</p>
-              </div>
-            )}
-
-            {workouts.map((w, idx) => (
-              <div
-                key={String(w?.id ?? idx)}
-                className={
-                  density === 'compact'
-                    ? 'bg-neutral-800 rounded-xl p-3 border-l-4 border-neutral-600 md:hover:border-yellow-500 transition-all group relative overflow-hidden cursor-pointer'
-                    : 'bg-neutral-800 rounded-xl p-4 border-l-4 border-neutral-600 md:hover:border-yellow-500 transition-all group relative overflow-hidden cursor-pointer'
-                }
-                onClick={() => {
-                  const key = getWorkoutKey(w, idx)
-                  if (isWorkoutBusy(key)) return
-                  props.onQuickView(w)
-                }}
-              >
-                <div className="relative z-10">
-                  <h3 className="font-bold text-white text-lg uppercase mb-1 pr-32 leading-tight">{String(w?.title || 'Treino')}</h3>
-                  <p className="text-xs text-neutral-400 font-mono mb-4">{Array.isArray(w?.exercises) ? w.exercises.length : 0} EXERCÍCIOS</p>
-
-                  <div className="flex gap-2 mt-2">
-                    <button
-                      onClick={async (e) => {
-                        e.stopPropagation()
-                        const key = getWorkoutKey(w, idx)
-                        await runWorkoutAction(key, 'start', () => props.onStartSession(w))
-                      }}
-                      disabled={isWorkoutBusy(getWorkoutKey(w, idx))}
-                      className="relative z-30 flex-1 bg-white/5 hover:bg-white/10 py-2 rounded-lg flex items-center justify-center gap-2 text-white font-bold text-sm transition-colors border border-white/10 active:scale-95 touch-manipulation disabled:opacity-60"
-                    >
-                      {isActionBusy(getWorkoutKey(w, idx), 'start') ? (
-                        <>
-                          <Loader2 size={16} className="text-yellow-500 animate-spin" /> INICIANDO...
-                        </>
-                      ) : (
-                        <>
-                          <Play size={16} className="fill-white" /> INICIAR TREINO
-                        </>
-                      )}
-                    </button>
-                  </div>
-                </div>
-
-                <div className="absolute top-2 right-2 flex gap-1 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity z-20 bg-neutral-900/50 backdrop-blur-sm rounded-lg p-1 border border-white/5">
-                  <button
-                    onClick={async (e) => {
-                      e.stopPropagation()
-                      const key = getWorkoutKey(w, idx)
-                      await runWorkoutAction(key, 'share', () => props.onShareWorkout(w))
-                    }}
-                    disabled={isWorkoutBusy(getWorkoutKey(w, idx))}
-                    className="p-2 hover:bg-black/50 rounded text-neutral-400 hover:text-white disabled:opacity-60"
-                  >
-                    {isActionBusy(getWorkoutKey(w, idx), 'share') ? <Loader2 size={14} className="text-yellow-500 animate-spin" /> : <Share2 size={14} />}
-                  </button>
-                  <button
-                    onClick={async (e) => {
-                      e.stopPropagation()
-                      const key = getWorkoutKey(w, idx)
-                      await runWorkoutAction(key, 'duplicate', () => props.onDuplicateWorkout(w))
-                    }}
-                    disabled={isWorkoutBusy(getWorkoutKey(w, idx))}
-                    className="p-2 hover:bg-black/50 rounded text-neutral-400 hover:text-white disabled:opacity-60"
-                  >
-                    {isActionBusy(getWorkoutKey(w, idx), 'duplicate') ? <Loader2 size={14} className="text-yellow-500 animate-spin" /> : <Copy size={14} />}
-                  </button>
-                  <button
-                    onClick={async (e) => {
-                      e.stopPropagation()
-                      const key = getWorkoutKey(w, idx)
-                      await runWorkoutAction(key, 'edit', () => props.onEditWorkout(w))
-                    }}
-                    disabled={isWorkoutBusy(getWorkoutKey(w, idx))}
-                    className="p-2 hover:bg-black/50 rounded text-neutral-400 hover:text-white disabled:opacity-60"
-                  >
-                    {isActionBusy(getWorkoutKey(w, idx), 'edit') ? <Loader2 size={14} className="text-yellow-500 animate-spin" /> : <Pencil size={14} />}
-                  </button>
-                  {w?.user_id && props.currentUserId && w.user_id === props.currentUserId && (
-                    <button
-                      onClick={async (e) => {
-                        e.stopPropagation()
-                        const key = getWorkoutKey(w, idx)
-                        await runWorkoutAction(key, 'delete', () => props.onDeleteWorkout(w?.id, w?.title))
-                      }}
-                      disabled={isWorkoutBusy(getWorkoutKey(w, idx))}
-                      className="p-2 hover:bg-black/50 rounded text-neutral-400 hover:text-white disabled:opacity-60"
-                    >
-                      {isActionBusy(getWorkoutKey(w, idx), 'delete') ? <Loader2 size={14} className="text-yellow-500 animate-spin" /> : <Trash2 size={14} />}
-                    </button>
-                  )}
-                </div>
-              </div>
-            ))}
-          </div>
-        </>
-      )}
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/components/dashboard/StudentDashboard 3.tsx b/_archive/duplicates/src/components/dashboard/StudentDashboard 3.tsx
deleted file mode 100644
index 44b3656..0000000
--- a/_archive/duplicates/src/components/dashboard/StudentDashboard 3.tsx	
+++ /dev/null
@@ -1,2 +0,0 @@
-export { default } from './StudentDashboard3'
-export * from './StudentDashboard3'
diff --git a/_archive/duplicates/src/components/muscle-map/BodyMapSvg 2.tsx b/_archive/duplicates/src/components/muscle-map/BodyMapSvg 2.tsx
deleted file mode 100644
index 127cf72..0000000
--- a/_archive/duplicates/src/components/muscle-map/BodyMapSvg 2.tsx	
+++ /dev/null
@@ -1,273 +0,0 @@
-'use client'
-
-import React from 'react'
-import type { MuscleId } from '@/utils/muscleMapConfig'
-
-type MuscleState = {
-  color?: string
-  sets?: number
-  ratio?: number
-  label?: string
-}
-
-type Props = {
-  view: 'front' | 'back'
-  muscles: Record<string, MuscleState>
-  onSelect?: (muscleId: MuscleId) => void
-  selected?: MuscleId | null
-}
-
-const hit = (id: MuscleId, view: 'front' | 'back', muscles: Record<string, MuscleState>, selected?: MuscleId | null) => {
-  const m = muscles?.[id] || {}
-  const fill = String(m.color || (view === 'front' ? '#111827' : '#111827'))
-  const stroke = selected === id ? '#f59e0b' : 'rgba(255,255,255,.10)'
-  return { fill, stroke }
-}
-
-export default function BodyMapSvg({ view, muscles, onSelect, selected }: Props) {
-  const common = {
-    width: 260,
-    height: 420,
-    viewBox: '0 0 260 420',
-  }
-
-  return (
-    <svg {...common} role="img" aria-label="Mapa muscular" className="w-full max-w-[280px] mx-auto select-none">
-      <rect x="92" y="18" width="76" height="76" rx="38" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.08)" />
-      <rect x="86" y="96" width="88" height="92" rx="38" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.08)" />
-      <rect x="96" y="186" width="68" height="98" rx="28" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="64" y="110" width="30" height="88" rx="15" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="166" y="110" width="30" height="88" rx="15" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="92" y="280" width="34" height="118" rx="16" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="134" y="280" width="34" height="118" rx="16" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-
-      {view === 'front' ? (
-        <>
-          <rect
-            x="96"
-            y="110"
-            width="68"
-            height="38"
-            rx="16"
-            {...hit('chest', view, muscles, selected)}
-            onClick={() => onSelect?.('chest')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="96"
-            y="150"
-            width="68"
-            height="52"
-            rx="18"
-            {...hit('abs', view, muscles, selected)}
-            onClick={() => onSelect?.('abs')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="86"
-            y="98"
-            width="38"
-            height="12"
-            rx="12"
-            {...hit('delts_front', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_front')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="136"
-            y="98"
-            width="38"
-            height="12"
-            rx="12"
-            {...hit('delts_front', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_front')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="52"
-            y="100"
-            width="26"
-            height="24"
-            rx="12"
-            {...hit('delts_side', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_side')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="182"
-            y="100"
-            width="26"
-            height="24"
-            rx="12"
-            {...hit('delts_side', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_side')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="64"
-            y="126"
-            width="30"
-            height="40"
-            rx="14"
-            {...hit('biceps', view, muscles, selected)}
-            onClick={() => onSelect?.('biceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="166"
-            y="126"
-            width="30"
-            height="40"
-            rx="14"
-            {...hit('biceps', view, muscles, selected)}
-            onClick={() => onSelect?.('biceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="64"
-            y="168"
-            width="30"
-            height="30"
-            rx="14"
-            {...hit('triceps', view, muscles, selected)}
-            onClick={() => onSelect?.('triceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="166"
-            y="168"
-            width="30"
-            height="30"
-            rx="14"
-            {...hit('triceps', view, muscles, selected)}
-            onClick={() => onSelect?.('triceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="240"
-            width="76"
-            height="70"
-            rx="26"
-            {...hit('quads', view, muscles, selected)}
-            onClick={() => onSelect?.('quads')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="134"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-        </>
-      ) : (
-        <>
-          <rect
-            x="96"
-            y="110"
-            width="68"
-            height="34"
-            rx="16"
-            {...hit('upper_back', view, muscles, selected)}
-            onClick={() => onSelect?.('upper_back')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="96"
-            y="146"
-            width="68"
-            height="38"
-            rx="16"
-            {...hit('lats', view, muscles, selected)}
-            onClick={() => onSelect?.('lats')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="186"
-            width="76"
-            height="34"
-            rx="16"
-            {...hit('spinal_erectors', view, muscles, selected)}
-            onClick={() => onSelect?.('spinal_erectors')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="86"
-            y="98"
-            width="38"
-            height="26"
-            rx="12"
-            {...hit('delts_rear', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_rear')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="136"
-            y="98"
-            width="38"
-            height="26"
-            rx="12"
-            {...hit('delts_rear', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_rear')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="226"
-            width="76"
-            height="44"
-            rx="18"
-            {...hit('glutes', view, muscles, selected)}
-            onClick={() => onSelect?.('glutes')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="270"
-            width="76"
-            height="56"
-            rx="22"
-            {...hit('hamstrings', view, muscles, selected)}
-            onClick={() => onSelect?.('hamstrings')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="134"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-        </>
-      )}
-    </svg>
-  )
-}
diff --git a/_archive/duplicates/src/components/muscle-map/BodyMapSvg 3.tsx b/_archive/duplicates/src/components/muscle-map/BodyMapSvg 3.tsx
deleted file mode 100644
index 127cf72..0000000
--- a/_archive/duplicates/src/components/muscle-map/BodyMapSvg 3.tsx	
+++ /dev/null
@@ -1,273 +0,0 @@
-'use client'
-
-import React from 'react'
-import type { MuscleId } from '@/utils/muscleMapConfig'
-
-type MuscleState = {
-  color?: string
-  sets?: number
-  ratio?: number
-  label?: string
-}
-
-type Props = {
-  view: 'front' | 'back'
-  muscles: Record<string, MuscleState>
-  onSelect?: (muscleId: MuscleId) => void
-  selected?: MuscleId | null
-}
-
-const hit = (id: MuscleId, view: 'front' | 'back', muscles: Record<string, MuscleState>, selected?: MuscleId | null) => {
-  const m = muscles?.[id] || {}
-  const fill = String(m.color || (view === 'front' ? '#111827' : '#111827'))
-  const stroke = selected === id ? '#f59e0b' : 'rgba(255,255,255,.10)'
-  return { fill, stroke }
-}
-
-export default function BodyMapSvg({ view, muscles, onSelect, selected }: Props) {
-  const common = {
-    width: 260,
-    height: 420,
-    viewBox: '0 0 260 420',
-  }
-
-  return (
-    <svg {...common} role="img" aria-label="Mapa muscular" className="w-full max-w-[280px] mx-auto select-none">
-      <rect x="92" y="18" width="76" height="76" rx="38" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.08)" />
-      <rect x="86" y="96" width="88" height="92" rx="38" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.08)" />
-      <rect x="96" y="186" width="68" height="98" rx="28" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="64" y="110" width="30" height="88" rx="15" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="166" y="110" width="30" height="88" rx="15" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="92" y="280" width="34" height="118" rx="16" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-      <rect x="134" y="280" width="34" height="118" rx="16" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.08)" />
-
-      {view === 'front' ? (
-        <>
-          <rect
-            x="96"
-            y="110"
-            width="68"
-            height="38"
-            rx="16"
-            {...hit('chest', view, muscles, selected)}
-            onClick={() => onSelect?.('chest')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="96"
-            y="150"
-            width="68"
-            height="52"
-            rx="18"
-            {...hit('abs', view, muscles, selected)}
-            onClick={() => onSelect?.('abs')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="86"
-            y="98"
-            width="38"
-            height="12"
-            rx="12"
-            {...hit('delts_front', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_front')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="136"
-            y="98"
-            width="38"
-            height="12"
-            rx="12"
-            {...hit('delts_front', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_front')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="52"
-            y="100"
-            width="26"
-            height="24"
-            rx="12"
-            {...hit('delts_side', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_side')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="182"
-            y="100"
-            width="26"
-            height="24"
-            rx="12"
-            {...hit('delts_side', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_side')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="64"
-            y="126"
-            width="30"
-            height="40"
-            rx="14"
-            {...hit('biceps', view, muscles, selected)}
-            onClick={() => onSelect?.('biceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="166"
-            y="126"
-            width="30"
-            height="40"
-            rx="14"
-            {...hit('biceps', view, muscles, selected)}
-            onClick={() => onSelect?.('biceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="64"
-            y="168"
-            width="30"
-            height="30"
-            rx="14"
-            {...hit('triceps', view, muscles, selected)}
-            onClick={() => onSelect?.('triceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="166"
-            y="168"
-            width="30"
-            height="30"
-            rx="14"
-            {...hit('triceps', view, muscles, selected)}
-            onClick={() => onSelect?.('triceps')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="240"
-            width="76"
-            height="70"
-            rx="26"
-            {...hit('quads', view, muscles, selected)}
-            onClick={() => onSelect?.('quads')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="134"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-        </>
-      ) : (
-        <>
-          <rect
-            x="96"
-            y="110"
-            width="68"
-            height="34"
-            rx="16"
-            {...hit('upper_back', view, muscles, selected)}
-            onClick={() => onSelect?.('upper_back')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="96"
-            y="146"
-            width="68"
-            height="38"
-            rx="16"
-            {...hit('lats', view, muscles, selected)}
-            onClick={() => onSelect?.('lats')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="186"
-            width="76"
-            height="34"
-            rx="16"
-            {...hit('spinal_erectors', view, muscles, selected)}
-            onClick={() => onSelect?.('spinal_erectors')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="86"
-            y="98"
-            width="38"
-            height="26"
-            rx="12"
-            {...hit('delts_rear', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_rear')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="136"
-            y="98"
-            width="38"
-            height="26"
-            rx="12"
-            {...hit('delts_rear', view, muscles, selected)}
-            onClick={() => onSelect?.('delts_rear')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="226"
-            width="76"
-            height="44"
-            rx="18"
-            {...hit('glutes', view, muscles, selected)}
-            onClick={() => onSelect?.('glutes')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="270"
-            width="76"
-            height="56"
-            rx="22"
-            {...hit('hamstrings', view, muscles, selected)}
-            onClick={() => onSelect?.('hamstrings')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="92"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-          <rect
-            x="134"
-            y="334"
-            width="34"
-            height="64"
-            rx="14"
-            {...hit('calves', view, muscles, selected)}
-            onClick={() => onSelect?.('calves')}
-            className="cursor-pointer"
-          />
-        </>
-      )}
-    </svg>
-  )
-}
diff --git a/_archive/duplicates/src/components/onboarding/GuidedTour 2.js b/_archive/duplicates/src/components/onboarding/GuidedTour 2.js
deleted file mode 100644
index 0d8f12d..0000000
--- a/_archive/duplicates/src/components/onboarding/GuidedTour 2.js	
+++ /dev/null
@@ -1,349 +0,0 @@
-'use client'
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
-import { usePathname, useRouter } from 'next/navigation'
-import { ChevronLeft, ChevronRight, X } from 'lucide-react'
-
-const clamp = (n, min, max) => Math.max(min, Math.min(max, n))
-
-const getRect = (el) => {
-  try {
-    if (!el?.getBoundingClientRect) return null
-    const r = el.getBoundingClientRect()
-    if (!Number.isFinite(r?.top)) return null
-    const pad = 8
-    const top = r.top - pad
-    const left = r.left - pad
-    const width = r.width + pad * 2
-    const height = r.height + pad * 2
-    const maxW = Math.max(0, window.innerWidth - clamp(left, 0, window.innerWidth))
-    const maxH = Math.max(0, window.innerHeight - clamp(top, 0, window.innerHeight))
-    return {
-      top: clamp(top, 0, window.innerHeight),
-      left: clamp(left, 0, window.innerWidth),
-      width: clamp(width, 0, maxW),
-      height: clamp(height, 0, maxH),
-      raw: r,
-    }
-  } catch {
-    return null
-  }
-}
-
-const findTarget = (selector) => {
-  try {
-    const s = String(selector || '').trim()
-    if (!s) return null
-    const list = Array.from(document.querySelectorAll(s))
-    for (const el of list) {
-      if (!el?.getBoundingClientRect) continue
-      const r = el.getBoundingClientRect()
-      const visible = Number(r.width) > 0 && Number(r.height) > 0
-      if (!visible) continue
-      return el
-    }
-    return list[0] || null
-  } catch {
-    return null
-  }
-}
-
-export default function GuidedTour({
-  open,
-  steps,
-  actions,
-  onComplete,
-  onSkip,
-  onCancel,
-  onEvent,
-}) {
-  const router = useRouter()
-  const pathname = usePathname()
-  const safeSteps = Array.isArray(steps) ? steps : []
-  const [idx, setIdx] = useState(0)
-  const [targetRect, setTargetRect] = useState(null)
-  const lastStepIdRef = useRef('')
-  const pollRef = useRef(null)
-  const scrollRafRef = useRef(null)
-  const lastActionStepIdRef = useRef('')
-
-  const step = safeSteps[idx] || null
-  const stepId = String(step?.id || idx)
-
-  const emit = useCallback((name, payload) => {
-    try {
-      onEvent?.(name, payload)
-    } catch {}
-  }, [onEvent])
-
-  useEffect(() => {
-    if (!open) return
-    const t = window.setTimeout(() => setIdx(0), 0)
-    return () => window.clearTimeout(t)
-  }, [open])
-
-  useEffect(() => {
-    if (!open) return
-    if (!safeSteps.length) return
-    const id = String(stepId)
-    if (lastStepIdRef.current === id) return
-    lastStepIdRef.current = id
-    emit('tour_step', { stepId: id, index: idx })
-  }, [emit, idx, open, safeSteps.length, stepId])
-
-  useEffect(() => {
-    if (!open) return
-    if (!step) return
-    const action = step?.action
-    if (!action) return
-    const id = String(stepId)
-    if (lastActionStepIdRef.current === id) return
-    lastActionStepIdRef.current = id
-    const run = async () => {
-      try {
-        if (typeof action === 'function') {
-          await Promise.resolve(action())
-          return
-        }
-        const a = action && typeof action === 'object' ? action : null
-        const name = String(a?.name || '').trim()
-        const args = Array.isArray(a?.args) ? a.args : []
-        if (!name) return
-        const map = actions && typeof actions === 'object' ? actions : null
-        const fn = map && typeof map[name] === 'function' ? map[name] : null
-        if (!fn) return
-        await Promise.resolve(fn(...args))
-      } catch {}
-    }
-    run()
-  }, [actions, open, step, stepId])
-
-  useEffect(() => {
-    if (!open) return
-    if (!step) return
-    const route = String(step?.route || '').trim()
-    if (!route) return
-    if (route === pathname) return
-    try {
-      router.push(route)
-    } catch {}
-  }, [open, pathname, router, step])
-
-  useEffect(() => {
-    if (!open) return
-    if (!step) return
-    let cancelled = false
-    const clearT = window.setTimeout(() => setTargetRect(null), 0)
-
-    const selector = String(step?.selector || '').trim()
-    const route = String(step?.route || '').trim()
-    let hasScrolled = false
-
-    const updateRect = () => {
-      if (cancelled) return
-      if (route && route !== pathname) return
-      const el = findTarget(selector)
-      if (!el) return
-      if (!hasScrolled) {
-        hasScrolled = true
-        try {
-          el.scrollIntoView({ block: 'center', inline: 'center', behavior: 'smooth' })
-        } catch {}
-      }
-      const rect = getRect(el)
-      setTargetRect(rect)
-      if (rect && pollRef.current) {
-        try {
-          window.clearInterval(pollRef.current)
-        } catch {}
-        pollRef.current = null
-      }
-    }
-
-    const start = Date.now()
-    pollRef.current = window.setInterval(() => {
-      if (cancelled) return
-      updateRect()
-      const elapsed = Date.now() - start
-      if (elapsed > 2500) {
-        try {
-          if (pollRef.current) window.clearInterval(pollRef.current)
-        } catch {}
-        pollRef.current = null
-      }
-    }, 120)
-
-    const onScrollOrResize = () => {
-      if (cancelled) return
-      if (scrollRafRef.current) return
-      scrollRafRef.current = window.requestAnimationFrame(() => {
-        scrollRafRef.current = null
-        updateRect()
-      })
-    }
-
-    window.addEventListener('scroll', onScrollOrResize, true)
-    window.addEventListener('resize', onScrollOrResize)
-
-    return () => {
-      cancelled = true
-      try {
-        window.clearTimeout(clearT)
-      } catch {}
-      try {
-        if (pollRef.current) window.clearInterval(pollRef.current)
-      } catch {}
-      pollRef.current = null
-      try {
-        window.removeEventListener('scroll', onScrollOrResize, true)
-        window.removeEventListener('resize', onScrollOrResize)
-      } catch {}
-      try {
-        if (scrollRafRef.current) window.cancelAnimationFrame(scrollRafRef.current)
-      } catch {}
-      scrollRafRef.current = null
-    }
-  }, [open, pathname, step])
-
-  useEffect(() => {
-    if (!open) return
-    const onKeyDown = (e) => {
-      if (e.key === 'Escape') {
-        e.preventDefault()
-        try {
-          onCancel?.()
-        } catch {}
-      }
-      if (e.key === 'ArrowRight') {
-        e.preventDefault()
-        if (idx < safeSteps.length - 1) setIdx((v) => v + 1)
-      }
-      if (e.key === 'ArrowLeft') {
-        e.preventDefault()
-        if (idx > 0) setIdx((v) => v - 1)
-      }
-    }
-    window.addEventListener('keydown', onKeyDown)
-    return () => window.removeEventListener('keydown', onKeyDown)
-  }, [idx, onCancel, open, safeSteps.length])
-
-  const tooltip = useMemo(() => {
-    const r = targetRect
-    const margin = 12
-    const w = 380
-    const maxW = Math.min(w, Math.max(280, (typeof window !== 'undefined' ? window.innerWidth : 360) - 24))
-    const leftBase = r ? r.left + r.width / 2 - maxW / 2 : (typeof window !== 'undefined' ? (window.innerWidth - maxW) / 2 : 20)
-    const left = clamp(leftBase, 12, (typeof window !== 'undefined' ? window.innerWidth : 360) - maxW - 12)
-    const spaceBelow = r && typeof window !== 'undefined' ? window.innerHeight - (r.top + r.height) : 9999
-    const preferAbove = spaceBelow < 240
-    const top = r ? (preferAbove ? r.top - margin - 210 : r.top + r.height + margin) : 120
-    const topClamped = clamp(top, 12, (typeof window !== 'undefined' ? window.innerHeight : 800) - 240)
-    return { left, top: topClamped, width: maxW, placement: preferAbove ? 'top' : 'bottom' }
-  }, [targetRect])
-
-  if (!open || !step) return null
-
-  const isLast = idx >= safeSteps.length - 1
-
-  return (
-    <div className="fixed inset-0 z-[2000]">
-      {!targetRect ? <div className="absolute inset-0 bg-black/55 backdrop-blur-sm" /> : null}
-      {targetRect ? (
-        <div
-          className="absolute rounded-2xl border-2 border-yellow-500 shadow-[0_0_0_9999px_rgba(0,0,0,0.55)] pointer-events-none"
-          style={{ top: targetRect.top, left: targetRect.left, width: targetRect.width, height: targetRect.height }}
-        />
-      ) : null}
-
-      <div
-        className="absolute rounded-2xl bg-neutral-900 border border-neutral-800 shadow-2xl p-4 pointer-events-auto max-h-[calc(100vh-24px)] overflow-auto"
-        style={{ top: tooltip.top, left: tooltip.left, width: tooltip.width, maxWidth: 'calc(100vw - 24px)' }}
-        role="dialog"
-        aria-modal="true"
-        aria-label="Tour"
-      >
-        {targetRect ? (
-          <div
-            className="absolute w-3 h-3 bg-neutral-900 border border-neutral-800 rotate-45"
-            style={{
-              left: clamp((targetRect.left + targetRect.width / 2) - tooltip.left, 20, tooltip.width - 20),
-              top: tooltip.placement === 'top' ? 'auto' : -6,
-              bottom: tooltip.placement === 'top' ? -6 : 'auto',
-            }}
-          />
-        ) : null}
-        <div className="flex items-start justify-between gap-3">
-          <div className="min-w-0">
-            <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Tour</div>
-            <div className="mt-1 text-white font-black text-base leading-snug">{String(step?.title || '')}</div>
-          </div>
-          <button
-            type="button"
-            onClick={() => {
-              emit('tour_cancelled', { stepId })
-              onCancel?.()
-            }}
-            className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-            aria-label="Cancelar"
-          >
-            <X size={18} />
-          </button>
-        </div>
-
-        {String(step?.body || '').trim() ? (
-          <div className="mt-3 text-sm text-neutral-200 leading-snug whitespace-pre-wrap">{String(step.body)}</div>
-        ) : null}
-
-        <div className="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between flex-wrap gap-2">
-          <button
-            type="button"
-            onClick={() => {
-              emit('tour_skipped', { stepId })
-              onSkip?.()
-            }}
-            className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 w-full sm:w-auto"
-          >
-            Pular
-          </button>
-
-          <div className="flex flex-wrap items-center gap-2 w-full sm:w-auto sm:ml-auto sm:justify-end">
-            <button
-              type="button"
-              onClick={() => setIdx((v) => Math.max(0, v - 1))}
-              disabled={idx === 0}
-              className="min-h-[44px] px-4 py-3 rounded-xl bg-black border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-950 disabled:opacity-60 inline-flex items-center justify-center gap-2 flex-1 sm:flex-none"
-            >
-              <ChevronLeft size={16} />
-              Voltar
-            </button>
-            <button
-              type="button"
-              onClick={() => {
-                if (!isLast) {
-                  setIdx((v) => Math.min(safeSteps.length - 1, v + 1))
-                  return
-                }
-                emit('tour_completed', { stepId })
-                onComplete?.()
-              }}
-              className="min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center justify-center gap-2 flex-1 sm:flex-none"
-            >
-              {!isLast ? (
-                <>
-                  Próximo
-                  <ChevronRight size={16} />
-                </>
-              ) : (
-                'Concluir'
-              )}
-            </button>
-          </div>
-        </div>
-
-        <div className="mt-3 text-[11px] text-neutral-500 font-mono">
-          {idx + 1}/{safeSteps.length}
-        </div>
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/components/onboarding/GuidedTour 3.js b/_archive/duplicates/src/components/onboarding/GuidedTour 3.js
deleted file mode 100644
index 0d8f12d..0000000
--- a/_archive/duplicates/src/components/onboarding/GuidedTour 3.js	
+++ /dev/null
@@ -1,349 +0,0 @@
-'use client'
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
-import { usePathname, useRouter } from 'next/navigation'
-import { ChevronLeft, ChevronRight, X } from 'lucide-react'
-
-const clamp = (n, min, max) => Math.max(min, Math.min(max, n))
-
-const getRect = (el) => {
-  try {
-    if (!el?.getBoundingClientRect) return null
-    const r = el.getBoundingClientRect()
-    if (!Number.isFinite(r?.top)) return null
-    const pad = 8
-    const top = r.top - pad
-    const left = r.left - pad
-    const width = r.width + pad * 2
-    const height = r.height + pad * 2
-    const maxW = Math.max(0, window.innerWidth - clamp(left, 0, window.innerWidth))
-    const maxH = Math.max(0, window.innerHeight - clamp(top, 0, window.innerHeight))
-    return {
-      top: clamp(top, 0, window.innerHeight),
-      left: clamp(left, 0, window.innerWidth),
-      width: clamp(width, 0, maxW),
-      height: clamp(height, 0, maxH),
-      raw: r,
-    }
-  } catch {
-    return null
-  }
-}
-
-const findTarget = (selector) => {
-  try {
-    const s = String(selector || '').trim()
-    if (!s) return null
-    const list = Array.from(document.querySelectorAll(s))
-    for (const el of list) {
-      if (!el?.getBoundingClientRect) continue
-      const r = el.getBoundingClientRect()
-      const visible = Number(r.width) > 0 && Number(r.height) > 0
-      if (!visible) continue
-      return el
-    }
-    return list[0] || null
-  } catch {
-    return null
-  }
-}
-
-export default function GuidedTour({
-  open,
-  steps,
-  actions,
-  onComplete,
-  onSkip,
-  onCancel,
-  onEvent,
-}) {
-  const router = useRouter()
-  const pathname = usePathname()
-  const safeSteps = Array.isArray(steps) ? steps : []
-  const [idx, setIdx] = useState(0)
-  const [targetRect, setTargetRect] = useState(null)
-  const lastStepIdRef = useRef('')
-  const pollRef = useRef(null)
-  const scrollRafRef = useRef(null)
-  const lastActionStepIdRef = useRef('')
-
-  const step = safeSteps[idx] || null
-  const stepId = String(step?.id || idx)
-
-  const emit = useCallback((name, payload) => {
-    try {
-      onEvent?.(name, payload)
-    } catch {}
-  }, [onEvent])
-
-  useEffect(() => {
-    if (!open) return
-    const t = window.setTimeout(() => setIdx(0), 0)
-    return () => window.clearTimeout(t)
-  }, [open])
-
-  useEffect(() => {
-    if (!open) return
-    if (!safeSteps.length) return
-    const id = String(stepId)
-    if (lastStepIdRef.current === id) return
-    lastStepIdRef.current = id
-    emit('tour_step', { stepId: id, index: idx })
-  }, [emit, idx, open, safeSteps.length, stepId])
-
-  useEffect(() => {
-    if (!open) return
-    if (!step) return
-    const action = step?.action
-    if (!action) return
-    const id = String(stepId)
-    if (lastActionStepIdRef.current === id) return
-    lastActionStepIdRef.current = id
-    const run = async () => {
-      try {
-        if (typeof action === 'function') {
-          await Promise.resolve(action())
-          return
-        }
-        const a = action && typeof action === 'object' ? action : null
-        const name = String(a?.name || '').trim()
-        const args = Array.isArray(a?.args) ? a.args : []
-        if (!name) return
-        const map = actions && typeof actions === 'object' ? actions : null
-        const fn = map && typeof map[name] === 'function' ? map[name] : null
-        if (!fn) return
-        await Promise.resolve(fn(...args))
-      } catch {}
-    }
-    run()
-  }, [actions, open, step, stepId])
-
-  useEffect(() => {
-    if (!open) return
-    if (!step) return
-    const route = String(step?.route || '').trim()
-    if (!route) return
-    if (route === pathname) return
-    try {
-      router.push(route)
-    } catch {}
-  }, [open, pathname, router, step])
-
-  useEffect(() => {
-    if (!open) return
-    if (!step) return
-    let cancelled = false
-    const clearT = window.setTimeout(() => setTargetRect(null), 0)
-
-    const selector = String(step?.selector || '').trim()
-    const route = String(step?.route || '').trim()
-    let hasScrolled = false
-
-    const updateRect = () => {
-      if (cancelled) return
-      if (route && route !== pathname) return
-      const el = findTarget(selector)
-      if (!el) return
-      if (!hasScrolled) {
-        hasScrolled = true
-        try {
-          el.scrollIntoView({ block: 'center', inline: 'center', behavior: 'smooth' })
-        } catch {}
-      }
-      const rect = getRect(el)
-      setTargetRect(rect)
-      if (rect && pollRef.current) {
-        try {
-          window.clearInterval(pollRef.current)
-        } catch {}
-        pollRef.current = null
-      }
-    }
-
-    const start = Date.now()
-    pollRef.current = window.setInterval(() => {
-      if (cancelled) return
-      updateRect()
-      const elapsed = Date.now() - start
-      if (elapsed > 2500) {
-        try {
-          if (pollRef.current) window.clearInterval(pollRef.current)
-        } catch {}
-        pollRef.current = null
-      }
-    }, 120)
-
-    const onScrollOrResize = () => {
-      if (cancelled) return
-      if (scrollRafRef.current) return
-      scrollRafRef.current = window.requestAnimationFrame(() => {
-        scrollRafRef.current = null
-        updateRect()
-      })
-    }
-
-    window.addEventListener('scroll', onScrollOrResize, true)
-    window.addEventListener('resize', onScrollOrResize)
-
-    return () => {
-      cancelled = true
-      try {
-        window.clearTimeout(clearT)
-      } catch {}
-      try {
-        if (pollRef.current) window.clearInterval(pollRef.current)
-      } catch {}
-      pollRef.current = null
-      try {
-        window.removeEventListener('scroll', onScrollOrResize, true)
-        window.removeEventListener('resize', onScrollOrResize)
-      } catch {}
-      try {
-        if (scrollRafRef.current) window.cancelAnimationFrame(scrollRafRef.current)
-      } catch {}
-      scrollRafRef.current = null
-    }
-  }, [open, pathname, step])
-
-  useEffect(() => {
-    if (!open) return
-    const onKeyDown = (e) => {
-      if (e.key === 'Escape') {
-        e.preventDefault()
-        try {
-          onCancel?.()
-        } catch {}
-      }
-      if (e.key === 'ArrowRight') {
-        e.preventDefault()
-        if (idx < safeSteps.length - 1) setIdx((v) => v + 1)
-      }
-      if (e.key === 'ArrowLeft') {
-        e.preventDefault()
-        if (idx > 0) setIdx((v) => v - 1)
-      }
-    }
-    window.addEventListener('keydown', onKeyDown)
-    return () => window.removeEventListener('keydown', onKeyDown)
-  }, [idx, onCancel, open, safeSteps.length])
-
-  const tooltip = useMemo(() => {
-    const r = targetRect
-    const margin = 12
-    const w = 380
-    const maxW = Math.min(w, Math.max(280, (typeof window !== 'undefined' ? window.innerWidth : 360) - 24))
-    const leftBase = r ? r.left + r.width / 2 - maxW / 2 : (typeof window !== 'undefined' ? (window.innerWidth - maxW) / 2 : 20)
-    const left = clamp(leftBase, 12, (typeof window !== 'undefined' ? window.innerWidth : 360) - maxW - 12)
-    const spaceBelow = r && typeof window !== 'undefined' ? window.innerHeight - (r.top + r.height) : 9999
-    const preferAbove = spaceBelow < 240
-    const top = r ? (preferAbove ? r.top - margin - 210 : r.top + r.height + margin) : 120
-    const topClamped = clamp(top, 12, (typeof window !== 'undefined' ? window.innerHeight : 800) - 240)
-    return { left, top: topClamped, width: maxW, placement: preferAbove ? 'top' : 'bottom' }
-  }, [targetRect])
-
-  if (!open || !step) return null
-
-  const isLast = idx >= safeSteps.length - 1
-
-  return (
-    <div className="fixed inset-0 z-[2000]">
-      {!targetRect ? <div className="absolute inset-0 bg-black/55 backdrop-blur-sm" /> : null}
-      {targetRect ? (
-        <div
-          className="absolute rounded-2xl border-2 border-yellow-500 shadow-[0_0_0_9999px_rgba(0,0,0,0.55)] pointer-events-none"
-          style={{ top: targetRect.top, left: targetRect.left, width: targetRect.width, height: targetRect.height }}
-        />
-      ) : null}
-
-      <div
-        className="absolute rounded-2xl bg-neutral-900 border border-neutral-800 shadow-2xl p-4 pointer-events-auto max-h-[calc(100vh-24px)] overflow-auto"
-        style={{ top: tooltip.top, left: tooltip.left, width: tooltip.width, maxWidth: 'calc(100vw - 24px)' }}
-        role="dialog"
-        aria-modal="true"
-        aria-label="Tour"
-      >
-        {targetRect ? (
-          <div
-            className="absolute w-3 h-3 bg-neutral-900 border border-neutral-800 rotate-45"
-            style={{
-              left: clamp((targetRect.left + targetRect.width / 2) - tooltip.left, 20, tooltip.width - 20),
-              top: tooltip.placement === 'top' ? 'auto' : -6,
-              bottom: tooltip.placement === 'top' ? -6 : 'auto',
-            }}
-          />
-        ) : null}
-        <div className="flex items-start justify-between gap-3">
-          <div className="min-w-0">
-            <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Tour</div>
-            <div className="mt-1 text-white font-black text-base leading-snug">{String(step?.title || '')}</div>
-          </div>
-          <button
-            type="button"
-            onClick={() => {
-              emit('tour_cancelled', { stepId })
-              onCancel?.()
-            }}
-            className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-            aria-label="Cancelar"
-          >
-            <X size={18} />
-          </button>
-        </div>
-
-        {String(step?.body || '').trim() ? (
-          <div className="mt-3 text-sm text-neutral-200 leading-snug whitespace-pre-wrap">{String(step.body)}</div>
-        ) : null}
-
-        <div className="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between flex-wrap gap-2">
-          <button
-            type="button"
-            onClick={() => {
-              emit('tour_skipped', { stepId })
-              onSkip?.()
-            }}
-            className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 w-full sm:w-auto"
-          >
-            Pular
-          </button>
-
-          <div className="flex flex-wrap items-center gap-2 w-full sm:w-auto sm:ml-auto sm:justify-end">
-            <button
-              type="button"
-              onClick={() => setIdx((v) => Math.max(0, v - 1))}
-              disabled={idx === 0}
-              className="min-h-[44px] px-4 py-3 rounded-xl bg-black border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-950 disabled:opacity-60 inline-flex items-center justify-center gap-2 flex-1 sm:flex-none"
-            >
-              <ChevronLeft size={16} />
-              Voltar
-            </button>
-            <button
-              type="button"
-              onClick={() => {
-                if (!isLast) {
-                  setIdx((v) => Math.min(safeSteps.length - 1, v + 1))
-                  return
-                }
-                emit('tour_completed', { stepId })
-                onComplete?.()
-              }}
-              className="min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center justify-center gap-2 flex-1 sm:flex-none"
-            >
-              {!isLast ? (
-                <>
-                  Próximo
-                  <ChevronRight size={16} />
-                </>
-              ) : (
-                'Concluir'
-              )}
-            </button>
-          </div>
-        </div>
-
-        <div className="mt-3 text-[11px] text-neutral-500 font-mono">
-          {idx + 1}/{safeSteps.length}
-        </div>
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/components/stories/StoryCreatorModal 2.tsx b/_archive/duplicates/src/components/stories/StoryCreatorModal 2.tsx
deleted file mode 100644
index a4283f8..0000000
--- a/_archive/duplicates/src/components/stories/StoryCreatorModal 2.tsx	
+++ /dev/null
@@ -1,604 +0,0 @@
-'use client';
-
-import { useState, useRef, useEffect, type ChangeEvent } from 'react';
-import { X, Type, Smile, Scissors, Sparkles, Send, Loader2, Play, Pause, ChevronLeft, ChevronRight } from 'lucide-react';
-import Image from 'next/image';
-import { motion } from 'framer-motion';
-
-const FILTERS = [
-  { name: 'Normal', class: '' },
-  { name: 'Vivid', class: 'brightness-110 contrast-125 saturate-150' },
-  { name: 'Noir', class: 'grayscale contrast-125 brightness-90' },
-  { name: 'Vintage', class: 'sepia-[.5] contrast-90 brightness-110 hue-rotate-[-10deg]' },
-  { name: 'Cool', class: 'saturate-50 hue-rotate-30 contrast-110' },
-  { name: 'Warm', class: 'sepia-[.3] saturate-150 hue-rotate-[-10deg]' },
-  { name: 'Dramatic', class: 'contrast-150 saturate-0 brightness-90' },
-];
-
-const EMOJIS = ['🔥', '💪', '🏋️', '💯', '🥵', '🚀', '😤', '💧', '🥗', '🥩', '🍗', '🛑', '✅', '❌', '⚠️', '💤', '❤️', '👏'];
-const COLORS = ['#FFFFFF', '#000000', '#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899'];
-
-type StoryMediaType = 'image' | 'video';
-type StoryStep = 'picker' | 'editor';
-type StoryTool = 'text' | 'emoji' | 'filter' | 'trim' | null;
-
-type StoryOverlay =
-  | { id: number; type: 'text'; content: string; x: number; y: number; color: string; scale: number }
-  | { id: number; type: 'emoji'; content: string; x: number; y: number; scale: number };
-
-type StoryCreatorModalProps = {
-  isOpen: boolean;
-  onClose: () => void;
-  onPost: (file: File, metadata?: any) => Promise<void> | void;
-};
-
-export default function StoryCreatorModal({ isOpen, onClose, onPost }: StoryCreatorModalProps) {
-  const [step, setStep] = useState<StoryStep>('picker');
-  const [media, setMedia] = useState<File | null>(null);
-  const [mediaType, setMediaType] = useState<StoryMediaType | null>(null);
-  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
-  
-  // Editor State
-  const [filter, setFilter] = useState<(typeof FILTERS)[number]>(FILTERS[0]);
-  const [overlays, setOverlays] = useState<StoryOverlay[]>([]);
-  const [activeTool, setActiveTool] = useState<StoryTool>(null);
-  
-  // Text Tool State
-  const [textInput, setTextInput] = useState('');
-  const [textColor, setTextColor] = useState('#FFFFFF');
-  
-  // Video Trim State
-  const [videoDuration, setVideoDuration] = useState(0);
-  const [trimRange, setTrimRange] = useState({ start: 0, end: 0 });
-  const [isPlaying, setIsPlaying] = useState(false);
-  
-  const videoRef = useRef<HTMLVideoElement | null>(null);
-  const canvasRef = useRef<HTMLCanvasElement | null>(null);
-  const containerRef = useRef<HTMLDivElement | null>(null);
-  const fileInputRef = useRef<HTMLInputElement | null>(null);
-  const [posting, setPosting] = useState(false);
-
-  // --- File Handling ---
-  const handleFileSelect = (e: ChangeEvent<HTMLInputElement>) => {
-    const file = e.target.files?.[0];
-    if (!file) return;
-
-    const isVideo = String(file.type || '').toLowerCase().startsWith('video');
-    const isImage = String(file.type || '').toLowerCase().startsWith('image');
-    if (!isVideo && !isImage) {
-      try { e.target.value = ''; } catch {}
-      alert('Selecione uma imagem ou um vídeo.');
-      return;
-    }
-
-    if (isImage && file.size > 12 * 1024 * 1024) {
-      try { e.target.value = ''; } catch {}
-      alert(`Imagem muito grande (máx 12MB). Atual: ${(file.size / (1024 * 1024)).toFixed(1)}MB`);
-      return;
-    }
-
-    if (isVideo && file.size > 200 * 1024 * 1024) {
-      try { e.target.value = ''; } catch {}
-      alert(`Vídeo muito grande (máx 200MB). Atual: ${(file.size / (1024 * 1024)).toFixed(1)}MB`);
-      return;
-    }
-
-    const url = URL.createObjectURL(file);
-    setMedia(file);
-    setPreviewUrl(url);
-    setMediaType(file.type.startsWith('video') ? 'video' : 'image');
-    setStep('editor');
-    
-    // Reset state
-    setFilter(FILTERS[0]);
-    setOverlays([]);
-    setActiveTool(null);
-  };
-
-  useEffect(() => {
-    if (!isOpen) {
-      setStep('picker');
-      setMedia(null);
-      setPreviewUrl(null);
-      setOverlays([]);
-    }
-  }, [isOpen]);
-
-  // --- Video Logic ---
-    const handleVideoLoad = () => {
-        if (videoRef.current) {
-            const dur = videoRef.current.duration;
-            if (Number.isFinite(dur)) {
-                setVideoDuration(dur);
-                setTrimRange({ start: 0, end: dur });
-            }
-        }
-    };
-
-    const handleTimeUpdate = () => {
-        if (videoRef.current && mediaType === 'video') {
-            if (videoRef.current.currentTime >= trimRange.end) {
-                videoRef.current.pause();
-                videoRef.current.currentTime = trimRange.start;
-                setIsPlaying(false);
-            }
-        }
-    };
-
-    const safePlay = async () => {
-        if (!videoRef.current) return;
-        try {
-            await videoRef.current.play();
-            setIsPlaying(true);
-        } catch (err) {
-            console.warn('Playback interrupted:', err);
-            setIsPlaying(false);
-        }
-    };
-
-    const safePause = () => {
-        if (!videoRef.current) return;
-        videoRef.current.pause();
-        setIsPlaying(false);
-    };
-
-    const togglePlay = () => {
-        if (isPlaying) safePause();
-        else safePlay();
-    };
-
-  // --- Overlay Logic ---
-  const addText = () => {
-    if (!textInput.trim()) return;
-    setOverlays([...overlays, {
-      id: Date.now(),
-      type: 'text',
-      content: textInput,
-      x: 50, // %
-      y: 50, // %
-      color: textColor,
-      scale: 1
-    }]);
-    setTextInput('');
-    setActiveTool(null);
-  };
-
-  const addEmoji = (emoji: string) => {
-    setOverlays([...overlays, {
-      id: Date.now(),
-      type: 'emoji',
-      content: emoji,
-      x: 50,
-      y: 50,
-      scale: 1.5
-    }]);
-    setActiveTool(null);
-  };
-
-  const updateOverlayPos = (id: number, info: any) => {
-     // info.point is relative to viewport, we need percentage of container
-     if (!containerRef.current) return;
-     const rect = containerRef.current.getBoundingClientRect();
-     // Calculate center of element based on drag
-     // Framer motion drag gives us delta or point. 
-     // A simpler way with framer motion is to update state onDragEnd
-  };
-
-  const handleDragEnd = (id: number, info: any) => {
-    if (!containerRef.current) return;
-    const rect = containerRef.current.getBoundingClientRect();
-    
-    // Calculate new position as percentage
-    // info.point.x/y are page coordinates
-    // We need relative to container
-    const x = ((info.point.x - rect.left) / rect.width) * 100;
-    const y = ((info.point.y - rect.top) / rect.height) * 100;
-    
-    // Clamp to 0-100 to keep inside
-    const clampedX = Math.max(0, Math.min(100, x));
-    const clampedY = Math.max(0, Math.min(100, y));
-
-    setOverlays(prev => prev.map(o => 
-        o.id === id ? { ...o, x: clampedX, y: clampedY } : o
-    ));
-  };
-
-  const removeOverlay = (id: number) => {
-    setOverlays(overlays.filter(o => o.id !== id));
-  };
-
-  // --- Export Logic ---
-  const handlePost = async () => {
-    if (!media) return;
-    setPosting(true);
-
-    try {
-      if (!previewUrl) throw new Error('preview_unavailable');
-      let fileToUpload = media;
-      let metadata: any = {
-        filter: filter.class ? filter.class : undefined,
-        trim: mediaType === 'video' ? trimRange : undefined,
-        // Only send necessary overlay data
-        overlays: overlays.map(o => ({ 
-            type: o.type, 
-            content: o.content, 
-            x: Number(o.x.toFixed(2)), 
-            y: Number(o.y.toFixed(2)), 
-            color: 'color' in o ? o.color : undefined, 
-            scale: o.scale 
-        }))
-      };
-
-      // Payload Size Check (approximate)
-      const payloadSize = JSON.stringify(metadata).length;
-      if (payloadSize > 50 * 1024) { // 50KB limit for metadata
-          throw new Error('Muitos elementos no story. Remova alguns para publicar.');
-      }
-
-      if (mediaType === 'image') {
-        // Burn everything into canvas for images
-        const canvas = document.createElement('canvas');
-        const ctx = canvas.getContext('2d');
-        if (!ctx) throw new Error('canvas_unsupported');
-        const img = new window.Image();
-        
-        await new Promise((resolve, reject) => {
-          img.onload = resolve;
-          img.onerror = reject;
-          img.src = previewUrl;
-        });
-
-        canvas.width = img.naturalWidth;
-        canvas.height = img.naturalHeight;
-
-        // Draw Image with Filter
-        const previewEl = document.querySelector('#preview-img') as HTMLElement | null;
-        const cssFilter = previewEl ? getComputedStyle(previewEl).filter : 'none';
-        ctx.filter = cssFilter;
-        ctx.drawImage(img, 0, 0);
-        ctx.filter = 'none';
-
-        // Draw Overlays
-        overlays.forEach(ov => {
-            ctx.save();
-            const x = (ov.x / 100) * canvas.width;
-            const y = (ov.y / 100) * canvas.height;
-            
-            ctx.translate(x, y);
-            ctx.textAlign = 'center';
-            ctx.textBaseline = 'middle';
-            
-            if (ov.type === 'text') {
-                const fontSize = canvas.width * 0.08 * ov.scale; // Responsive font size
-                ctx.font = `bold ${fontSize}px sans-serif`;
-                ctx.fillStyle = ov.color;
-                ctx.strokeStyle = 'black';
-                ctx.lineWidth = fontSize * 0.05;
-                ctx.strokeText(ov.content, 0, 0);
-                ctx.fillText(ov.content, 0, 0);
-            } else {
-                const fontSize = canvas.width * 0.15 * ov.scale;
-                ctx.font = `${fontSize}px serif`;
-                ctx.fillText(ov.content, 0, 0);
-            }
-            ctx.restore();
-        });
-
-        const blob = await new Promise<Blob>((resolve, reject) =>
-          canvas.toBlob((b) => (b ? resolve(b) : reject(new Error('blob_failed'))), 'image/jpeg', 0.9)
-        );
-        fileToUpload = new File([blob], `story_${Date.now()}.jpg`, { type: 'image/jpeg' });
-        metadata.processed = true; // Flag to skip server processing if any
-      }
-
-      await onPost(fileToUpload, metadata);
-      onClose();
-    } catch (err) {
-      console.error(err);
-      alert('Erro ao processar story');
-    } finally {
-      setPosting(false);
-    }
-  };
-
-  if (!isOpen) return null;
-
-  return (
-    <div className="fixed inset-0 z-50 bg-black flex flex-col pb-safe">
-      {/* Top Bar */}
-      <div className="absolute top-0 left-0 right-0 z-50 p-4 pt-safe flex justify-between items-center bg-gradient-to-b from-black/80 to-transparent">
-        <button onClick={onClose} className="p-2 bg-black/20 rounded-full backdrop-blur-md">
-            <X className="text-white" />
-        </button>
-        {step === 'editor' && (
-            <div className="flex gap-4">
-                <button onClick={() => setActiveTool(activeTool === 'text' ? null : 'text')} className={`p-2 rounded-full backdrop-blur-md ${activeTool === 'text' ? 'bg-white text-black' : 'bg-black/20 text-white'}`}>
-                    <Type size={20} />
-                </button>
-                <button onClick={() => setActiveTool(activeTool === 'emoji' ? null : 'emoji')} className={`p-2 rounded-full backdrop-blur-md ${activeTool === 'emoji' ? 'bg-white text-black' : 'bg-black/20 text-white'}`}>
-                    <Smile size={20} />
-                </button>
-                <button onClick={() => setActiveTool(activeTool === 'filter' ? null : 'filter')} className={`p-2 rounded-full backdrop-blur-md ${activeTool === 'filter' ? 'bg-white text-black' : 'bg-black/20 text-white'}`}>
-                    <Sparkles size={20} />
-                </button>
-                {mediaType === 'video' && (
-                    <button onClick={() => setActiveTool(activeTool === 'trim' ? null : 'trim')} className={`p-2 rounded-full backdrop-blur-md ${activeTool === 'trim' ? 'bg-white text-black' : 'bg-black/20 text-white'}`}>
-                        <Scissors size={20} />
-                    </button>
-                )}
-            </div>
-        )}
-      </div>
-
-      {/* Main Content */}
-      <div className="flex-1 relative flex items-center justify-center bg-neutral-900 overflow-hidden" ref={containerRef}>
-        {step === 'picker' ? (
-            <div className="text-center p-8">
-                <div className="w-20 h-20 bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
-                    <Sparkles className="text-yellow-500" size={40} />
-                </div>
-                <h3 className="text-white font-bold text-xl mb-2">Criar Story</h3>
-                <p className="text-neutral-400 text-sm mb-6">Compartilhe seu treino, refeição ou progresso.</p>
-                <button 
-                    onClick={() => fileInputRef.current?.click()}
-                    className="bg-yellow-500 text-black font-bold py-3 px-8 rounded-full hover:bg-yellow-400 transition-transform active:scale-95"
-                >
-                    Escolher Mídia
-                </button>
-                <input 
-                    type="file" 
-                    ref={fileInputRef} 
-                    onChange={handleFileSelect} 
-                    className="hidden" 
-                    accept="image/*,video/*"
-                />
-            </div>
-        ) : (
-            <>
-                {/* Media Preview */}
-                <div className={`relative w-full h-full max-h-[80vh] flex items-center justify-center overflow-hidden transition-all duration-300 ${filter.class}`} id="preview-img">
-                    {mediaType === 'image' ? (
-                        previewUrl ? (
-                          <Image src={previewUrl} alt="Preview" fill sizes="100vw" className="object-contain" unoptimized />
-                        ) : null
-                    ) : (
-                        <video 
-                            ref={videoRef}
-                            src={previewUrl || ''} 
-                            className="w-full h-full object-contain" 
-                            playsInline 
-                            loop 
-                            autoPlay
-                            muted={false}
-                            onLoadedMetadata={handleVideoLoad}
-                            onTimeUpdate={handleTimeUpdate}
-                            onClick={togglePlay}
-                        />
-                    )}
-                </div>
-
-                {/* Overlays Layer */}
-                <div className="absolute inset-0 pointer-events-none overflow-hidden">
-                    {overlays.map(ov => (
-                        <motion.div 
-                            key={ov.id}
-                            drag
-                            dragMomentum={false}
-                            dragConstraints={containerRef}
-                            onDragEnd={(e, info) => handleDragEnd(ov.id, info)}
-                            className="absolute pointer-events-auto cursor-move select-none active:scale-110 transition-transform"
-                            style={{ 
-                                left: `${ov.x}%`, 
-                                top: `${ov.y}%`,
-                                x: '-50%', // Center anchor
-                                y: '-50%', // Center anchor
-                                fontSize: ov.type === 'text' ? '24px' : '48px',
-                                color: ov.type === 'text' ? ov.color : undefined,
-                                textShadow: '0px 2px 4px rgba(0,0,0,0.5)',
-                                fontWeight: 'bold'
-                            }}
-                            onClick={() => { /* Optional: Edit on click */ }} 
-                        >
-                            {ov.content}
-                            <button 
-                                onClick={(e) => { e.stopPropagation(); removeOverlay(ov.id); }}
-                                className="absolute -top-4 -right-4 bg-red-500 text-white rounded-full p-1 opacity-0 hover:opacity-100 transition-opacity"
-                            >
-                                <X size={12} />
-                            </button>
-                        </motion.div>
-                    ))}
-                </div>
-
-                {/* Tools Panels */}
-                <div className="absolute bottom-[100px] left-0 right-0 z-40 px-4">
-                    
-                    {/* Text Tool */}
-                    {activeTool === 'text' && (
-                        <div className="bg-black/80 backdrop-blur-md rounded-2xl p-4 animate-in slide-in-from-bottom-10">
-                            <input 
-                                autoFocus
-                                value={textInput}
-                                onChange={e => setTextInput(e.target.value)}
-                                placeholder="Digite algo..."
-                                className="w-full bg-transparent text-white text-xl font-bold placeholder-white/50 outline-none text-center mb-4"
-                                onKeyDown={e => e.key === 'Enter' && addText()}
-                            />
-                            <div className="flex justify-center gap-2 overflow-x-auto pb-2">
-                                {COLORS.map(c => (
-                                    <button 
-                                        key={c}
-                                        onClick={() => setTextColor(c)}
-                                        className={`w-8 h-8 rounded-full border-2 ${textColor === c ? 'border-white scale-110' : 'border-transparent'}`}
-                                        style={{ backgroundColor: c }}
-                                    />
-                                ))}
-                            </div>
-                            <div className="flex justify-end">
-                                <button onClick={addText} className="text-yellow-500 font-bold text-sm">Adicionar</button>
-                            </div>
-                        </div>
-                    )}
-
-                    {/* Emoji Tool */}
-                    {activeTool === 'emoji' && (
-                        <div className="bg-black/80 backdrop-blur-md rounded-2xl p-4 animate-in slide-in-from-bottom-10">
-                            <div className="grid grid-cols-6 gap-2">
-                                {EMOJIS.map(emoji => (
-                                    <button 
-                                        key={emoji}
-                                        onClick={() => addEmoji(emoji)}
-                                        className="text-3xl hover:scale-125 transition-transform"
-                                    >
-                                        {emoji}
-                                    </button>
-                                ))}
-                            </div>
-                        </div>
-                    )}
-
-                    {/* Filter Tool */}
-                    {activeTool === 'filter' && (
-                        <div className="flex gap-4 overflow-x-auto pb-4 snap-x">
-                            {FILTERS.map(f => (
-                                <button 
-                                    key={f.name}
-                                    onClick={() => setFilter(f)}
-                                    className="flex flex-col items-center gap-2 shrink-0 snap-center"
-                                >
-                                    <div className={`w-16 h-16 rounded-lg overflow-hidden border-2 ${filter.name === f.name ? 'border-yellow-500' : 'border-transparent'}`}>
-                                        <div className={`relative w-full h-full bg-neutral-800 ${f.class}`}>
-                                            {mediaType === 'image' && previewUrl ? (
-                                              <Image src={previewUrl} alt="" fill sizes="64px" className="object-cover" unoptimized />
-                                            ) : null}
-                                            {mediaType === 'video' && <div className="w-full h-full bg-neutral-700" />}
-                                        </div>
-                                    </div>
-                                    <span className={`text-xs ${filter.name === f.name ? 'text-yellow-500 font-bold' : 'text-neutral-400'}`}>{f.name}</span>
-                                </button>
-                            ))}
-                        </div>
-                    )}
-
-                    {/* Trim Tool (Video Only) */}
-                    {activeTool === 'trim' && mediaType === 'video' && (
-                        <div className="bg-black/80 backdrop-blur-md rounded-2xl p-4 animate-in slide-in-from-bottom-10">
-                            <div className="flex justify-between items-center text-xs text-neutral-400 mb-4 font-mono">
-                                <div className="text-center">
-                                    <span className="block text-[10px] uppercase text-yellow-500">Início</span>
-                                    <span className="text-white font-bold text-lg">{trimRange.start.toFixed(1)}s</span>
-                                </div>
-                                <div className="h-[1px] flex-1 bg-neutral-700 mx-4"></div>
-                                <div className="text-center">
-                                    <span className="block text-[10px] uppercase text-red-500">Fim</span>
-                                    <span className="text-white font-bold text-lg">{trimRange.end.toFixed(1)}s</span>
-                                </div>
-                            </div>
-                            
-                            <div className="relative h-12 bg-neutral-800 rounded-lg overflow-hidden mb-2">
-                                {/* Visual representation of the track */}
-                                <div className="absolute inset-0 bg-neutral-700 opacity-50"></div>
-                                {/* Selected Range Highlight */}
-                                <div 
-                                    className="absolute top-0 bottom-0 bg-yellow-500/20 border-l-2 border-r-2 border-yellow-500"
-                                    style={{
-                                        left: `${(trimRange.start / videoDuration) * 100}%`,
-                                        width: `${((trimRange.end - trimRange.start) / videoDuration) * 100}%`
-                                    }}
-                                ></div>
-
-                                {/* Start Slider (Invisible but clickable) */}
-                                <input 
-                                    type="range"
-                                    min={0}
-                                    max={videoDuration}
-                                    step={0.1}
-                                    value={trimRange.start}
-                                    onChange={e => {
-                                        const val = Number(e.target.value);
-                                        if (val < trimRange.end - 0.5) { // Minimum 0.5s duration
-                                            setTrimRange(prev => ({ ...prev, start: val }));
-                                            if (videoRef.current) {
-                                                videoRef.current.currentTime = val;
-                                                // Avoid rapid play/pause calls during drag
-                                                safePause();
-                                            }
-                                        }
-                                    }}
-                                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
-                                    style={{ pointerEvents: trimRange.start > videoDuration / 2 ? 'none' : 'auto' }} // Hack to prevent overlap blocking
-                                />
-                                
-                                {/* End Slider (Invisible but clickable) */}
-                                <input 
-                                    type="range"
-                                    min={0}
-                                    max={videoDuration}
-                                    step={0.1}
-                                    value={trimRange.end}
-                                    onChange={e => {
-                                        const val = Number(e.target.value);
-                                        if (val > trimRange.start + 0.5) {
-                                            setTrimRange(prev => ({ ...prev, end: val }));
-                                            if (videoRef.current) {
-                                                videoRef.current.currentTime = val;
-                                                safePause();
-                                            }
-                                        }
-                                    }}
-                                    className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20"
-                                    style={{ pointerEvents: trimRange.end < videoDuration / 2 ? 'none' : 'auto' }}
-                                />
-
-                                {/* Thumbs Visuals (since inputs are hidden) */}
-                                <div 
-                                    className="absolute top-0 bottom-0 w-4 bg-yellow-500 flex items-center justify-center pointer-events-none z-10 rounded-l-md"
-                                    style={{ left: `${(trimRange.start / videoDuration) * 100}%`, transform: 'translateX(-50%)' }}
-                                >
-                                    <ChevronRight size={12} className="text-black" />
-                                </div>
-                                <div 
-                                    className="absolute top-0 bottom-0 w-4 bg-yellow-500 flex items-center justify-center pointer-events-none z-10 rounded-r-md"
-                                    style={{ left: `${(trimRange.end / videoDuration) * 100}%`, transform: 'translateX(-50%)' }}
-                                >
-                                    <ChevronLeft size={12} className="text-black" />
-                                </div>
-                            </div>
-                            
-                            <div className="flex justify-between mt-4">
-                                <p className="text-[10px] text-neutral-500">Duração: {(trimRange.end - trimRange.start).toFixed(1)}s</p>
-                                <button onClick={() => {
-                                     if(videoRef.current) {
-                                         videoRef.current.currentTime = trimRange.start;
-                                         safePlay();
-                                     }
-                                 }} className="text-[10px] font-bold text-yellow-500 uppercase flex items-center gap-1">
-                                    <Play size={10} /> Preview Corte
-                                </button>
-                            </div>
-                        </div>
-                    )}
-                </div>
-            </>
-        )}
-      </div>
-
-      {/* Bottom Bar */}
-      {step === 'editor' && (
-          <div className="p-4 bg-black border-t border-neutral-900 flex justify-between items-center z-50">
-            <button onClick={() => setStep('picker')} className="text-white text-sm font-medium">
-                Cancelar
-            </button>
-            <button 
-                onClick={handlePost}
-                disabled={posting}
-                className="bg-yellow-500 text-black font-bold py-3 px-6 rounded-full flex items-center gap-2 hover:bg-yellow-400 active:scale-95 disabled:opacity-50"
-            >
-                {posting ? <Loader2 className="animate-spin" size={20} /> : <Send size={20} />}
-                <span>Seu Story</span>
-            </button>
-          </div>
-      )}
-    </div>
-  );
-}
diff --git a/_archive/duplicates/src/components/stories/StoryViewer 2.tsx b/_archive/duplicates/src/components/stories/StoryViewer 2.tsx
deleted file mode 100644
index 508e902..0000000
--- a/_archive/duplicates/src/components/stories/StoryViewer 2.tsx	
+++ /dev/null
@@ -1,524 +0,0 @@
-'use client'
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react'
-import Image from 'next/image'
-import { Heart, MessageCircle, X, ChevronLeft, ChevronRight, Eye, Trash2, Loader2, Volume2, VolumeX } from 'lucide-react'
-import { motion } from 'framer-motion'
-import { useDialog } from '@/contexts/DialogContext'
-import { Story, StoryGroup } from '@/types/social'
-import { mediaKindFromUrl } from '@/utils/mediaUtils'
-
-const initials = (name: string) => {
-  const n = String(name || '').trim()
-  if (!n) return '?'
-  return n.slice(0, 1).toUpperCase()
-}
-
-const formatAgo = (iso: string) => {
-  const ms = new Date(iso).getTime()
-  if (!Number.isFinite(ms)) return ''
-  const diffMin = Math.floor((Date.now() - ms) / 60000)
-  if (diffMin < 1) return 'agora'
-  if (diffMin < 60) return `${diffMin}m`
-  const diffH = Math.floor(diffMin / 60)
-  if (diffH < 24) return `${diffH}h`
-  const diffD = Math.floor(diffH / 24)
-  return `${diffD}d`
-}
-
-const isIOSUserAgent = (ua: string) => {
-  const s = String(ua || '')
-  if (/(iPad|iPhone|iPod)/i.test(s)) return true
-  try {
-    const nav: any = typeof navigator !== 'undefined' ? navigator : null
-    if (nav && nav.platform === 'MacIntel' && Number(nav.maxTouchPoints || 0) > 1) return true
-  } catch {}
-  return false
-}
-
-// --- Componente Principal ---
-interface StoryViewerProps {
-  group: StoryGroup
-  myId: string
-  onClose: () => void
-  onStoryUpdated: (storyId: string, patch: Partial<Story>) => void
-  onStoryDeleted: (storyId: string) => void
-}
-
-export default function StoryViewer({
-  group,
-  myId,
-  onClose,
-  onStoryUpdated,
-  onStoryDeleted,
-}: StoryViewerProps) {
-  const { confirm, alert } = useDialog()
-  const stories = useMemo(() => (Array.isArray(group.stories) ? group.stories : []), [group.stories])
-  const [idx, setIdx] = useState(0)
-  const story = stories[idx] || null
-  
-  // Estados de UI
-  const [commentsOpen, setCommentsOpen] = useState(false)
-  const [commentsLoading, setCommentsLoading] = useState(false)
-  const [commentsError, setCommentsError] = useState('')
-  const [comments, setComments] = useState<any[]>([])
-  const [commentText, setCommentText] = useState('')
-  
-  const [viewersOpen, setViewersOpen] = useState(false)
-  const [viewersLoading, setViewersLoading] = useState(false)
-  const [viewersError, setViewersError] = useState('')
-  const [viewers, setViewers] = useState<any[]>([])
-  const viewersStoryIdRef = useRef<string>('')
-  
-  const [deleting, setDeleting] = useState(false)
-  const [progress, setProgress] = useState(0)
-  const [holding, setHolding] = useState(false)
-  const [hidden, setHidden] = useState(false)
-  const [durationMs, setDurationMs] = useState(5000)
-  const [muted, setMuted] = useState(true)
-  const [videoError, setVideoError] = useState('')
-  
-  const rafRef = useRef<number | null>(null)
-  const lastTsRef = useRef<number>(0)
-  const elapsedRef = useRef<number>(0)
-  const lastProgressUpdateRef = useRef<number>(0)
-  const closeRequestedRef = useRef(false)
-  const videoRef = useRef<HTMLVideoElement | null>(null)
-  const preloadRef = useRef<{ aborts: AbortController[] }>({ aborts: [] })
-
-  const name = String(group.displayName || '').trim() || (group.authorId === myId ? 'Você' : 'Amigo')
-  const isMine = String(group.authorId || '').trim() === String(myId || '').trim()
-  const storyId = story?.id
-  const storyViewed = Boolean(story?.viewed)
-  const storyMediaUrl = story?.mediaUrl || ''
-  const storyMediaKind = (story as any)?.mediaKind
-  const mediaKind = useMemo(() => {
-    const k = storyMediaKind
-    if (k === 'video' || k === 'image') return k
-    return mediaKindFromUrl(storyMediaUrl || null)
-  }, [storyMediaKind, storyMediaUrl])
-  const isVideo = mediaKind === 'video'
-  
-  const videoSrc = useMemo(() => {
-    const sid = String(storyId || '').trim()
-    const direct = String(storyMediaUrl || '').trim()
-    if (direct) return direct
-    if (!sid) return ''
-    return `/api/social/stories/media?storyId=${encodeURIComponent(sid)}`
-  }, [storyId, storyMediaUrl])
-  const isIOS = useMemo(() => {
-    const ua = typeof navigator !== 'undefined' ? String(navigator.userAgent || '') : ''
-    return isIOSUserAgent(ua)
-  }, [])
-  const isWebm = useMemo(() => String(videoSrc || '').toLowerCase().includes('.webm'), [videoSrc])
-  const needsVideoFallback = isVideo && ((isIOS && isWebm) || !!videoError)
-
-  // Marcar como visto
-  useEffect(() => {
-    if (!storyId || storyViewed) return
-    onStoryUpdated(storyId, { viewed: true })
-    fetch('/api/social/stories/view', {
-      method: 'POST',
-      headers: { 'content-type': 'application/json' },
-      body: JSON.stringify({ storyId }),
-    }).catch(() => {})
-  }, [storyId, storyViewed, onStoryUpdated])
-
-  // Navegação e Timer
-  const goNext = useCallback(() => {
-    setIdx((v) => {
-      const nextIdx = v + 1
-      if (nextIdx >= stories.length) {
-        if (!closeRequestedRef.current) {
-          closeRequestedRef.current = true
-          setTimeout(() => onClose(), 0)
-        }
-        return v
-      }
-      return nextIdx
-    })
-  }, [onClose, stories.length])
-
-  useEffect(() => {
-    elapsedRef.current = 0
-    lastTsRef.current = 0
-    setProgress(0)
-    setCommentsOpen(false)
-    setViewersOpen(false)
-    setMuted(true)
-    setVideoError('')
-    setViewersError('')
-    setViewers([])
-    viewersStoryIdRef.current = ''
-  }, [storyId])
-
-  const toggleMuted = useCallback(() => {
-    setMuted((prev) => {
-      const next = !prev
-      const el = videoRef.current
-      if (el) {
-        el.muted = next
-        if (!next) {
-          const p = el.play()
-          if (p && typeof (p as any).catch === 'function') (p as any).catch(() => {})
-        }
-      }
-      return next
-    })
-  }, [])
-
-  useEffect(() => {
-    closeRequestedRef.current = false
-    setDurationMs(isVideo ? (needsVideoFallback ? 5000 : 60000) : 5000)
-  }, [isVideo, needsVideoFallback, storyId])
-
-  useEffect(() => {
-    for (const a of preloadRef.current.aborts) {
-      try {
-        a.abort()
-      } catch {}
-    }
-    preloadRef.current.aborts = []
-
-    const candidates = [stories[idx - 1] || null, stories[idx + 1] || null].filter(Boolean) as any[]
-    for (const s of candidates) {
-      const url = String(s?.mediaUrl || '').trim()
-      if (!url) continue
-      const a = new AbortController()
-      preloadRef.current.aborts.push(a)
-      fetch(url, { headers: { Range: 'bytes=0-0' }, signal: a.signal }).catch(() => {})
-    }
-  }, [idx, stories])
-
-  // Detectar tab oculta
-  useEffect(() => {
-    const onVis = () => setHidden(document.hidden)
-    document.addEventListener('visibilitychange', onVis)
-    return () => document.removeEventListener('visibilitychange', onVis)
-  }, [])
-
-  // Loop de Animação
-  useEffect(() => {
-    if (!storyId) return
-    if (isVideo && !needsVideoFallback) return
-    const tick = (ts: number) => {
-      rafRef.current = requestAnimationFrame(tick)
-      const paused = holding || commentsOpen || viewersOpen || hidden || deleting
-      
-      if (!lastTsRef.current) { lastTsRef.current = ts; return }
-      const delta = ts - lastTsRef.current
-      lastTsRef.current = ts
-      if (paused) return
-      
-      elapsedRef.current += delta
-      const next = Math.max(0, Math.min(1, elapsedRef.current / durationMs))
-      if (next >= 1) {
-        elapsedRef.current = 0
-        lastProgressUpdateRef.current = ts
-        setProgress(0)
-        goNext()
-        return
-      }
-      if (ts - lastProgressUpdateRef.current < 50) return
-      lastProgressUpdateRef.current = ts
-      setProgress((prev) => (Math.abs(prev - next) < 0.005 ? prev : next))
-    }
-    rafRef.current = requestAnimationFrame(tick)
-    return () => { if (rafRef.current) cancelAnimationFrame(rafRef.current) }
-  }, [commentsOpen, deleting, durationMs, goNext, hidden, holding, isVideo, storyId, viewersOpen, needsVideoFallback])
-
-  useEffect(() => {
-    if (!storyId || !isVideo) return
-    const v = videoRef.current
-    if (!v) return
-    const update = () => {
-      const d = Number(v.duration || 0)
-      if (!Number.isFinite(d) || d <= 0) return
-      const next = Math.max(0, Math.min(1, Number(v.currentTime || 0) / d))
-      setProgress((prev) => (Math.abs(prev - next) < 0.01 ? prev : next))
-    }
-    v.addEventListener('timeupdate', update)
-    v.addEventListener('durationchange', update)
-    update()
-    return () => {
-      v.removeEventListener('timeupdate', update)
-      v.removeEventListener('durationchange', update)
-    }
-  }, [isVideo, storyId])
-
-  // Controle de Video Play/Pause
-  useEffect(() => {
-    if (!storyId || !isVideo) return
-    const v = videoRef.current
-    if (!v) return
-    const paused = holding || commentsOpen || viewersOpen || hidden || deleting
-    if (paused) v.pause()
-    else v.play().catch(() => {})
-  }, [commentsOpen, deleting, hidden, holding, isVideo, storyId, viewersOpen])
-
-  // Carregar Dados
-  const loadComments = async (storyId: string) => {
-    setCommentsLoading(true)
-    setCommentsError('')
-    try {
-      const res = await fetch(`/api/social/stories/comments?storyId=${encodeURIComponent(storyId)}&limit=200`)
-      const json = await res.json()
-      if (!res.ok) throw new Error(json.error)
-      setComments(json.data || [])
-    } catch (e: any) {
-      setCommentsError(e.message)
-    } finally {
-      setCommentsLoading(false)
-    }
-  }
-
-  const loadViewers = async (storyId: string) => {
-    setViewersLoading(true)
-    setViewersError('')
-    try {
-      const res = await fetch(`/api/social/stories/views?storyId=${encodeURIComponent(storyId)}`)
-      const json = await res.json()
-      if (!res.ok) throw new Error(json.error)
-      setViewers(json.data || [])
-      viewersStoryIdRef.current = storyId
-    } catch (e: any) {
-      setViewersError(e.message)
-    } finally {
-      setViewersLoading(false)
-    }
-  }
-
-  // Ações
-  const toggleLike = async () => {
-    if (!storyId) return
-    const nextLiked = !story.hasLiked
-    onStoryUpdated(story.id, { hasLiked: nextLiked, likeCount: Math.max(0, story.likeCount + (nextLiked ? 1 : -1)) })
-    try {
-      await fetch('/api/social/stories/like', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId: story.id, like: nextLiked }),
-      })
-    } catch {
-      onStoryUpdated(story.id, { hasLiked: story.hasLiked, likeCount: story.likeCount })
-    }
-  }
-
-  const sendComment = async () => {
-    if (!storyId || !commentText.trim()) return
-    const text = commentText.trim()
-    setCommentText('')
-    try {
-      const res = await fetch('/api/social/stories/comments', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId: story.id, body: text }),
-      })
-      const json = await res.json()
-      if (res.ok) {
-        setComments((prev) => [...prev, json.data])
-        onStoryUpdated(story.id, { commentCount: story.commentCount + 1 })
-      }
-    } catch {}
-  }
-
-  const handleDelete = async () => {
-    if (!storyId || deleting) return
-    const ok = await confirm('Tem certeza que deseja deletar este story?', 'Deletar story', { confirmText: 'Deletar', cancelText: 'Cancelar' })
-    if (!ok) return
-    setDeleting(true)
-    try {
-      const res = await fetch('/api/social/stories/delete', {
-        method: 'POST',
-        headers: { 'content-type': 'application/json' },
-        body: JSON.stringify({ storyId: story.id }),
-      })
-      if (res.ok) {
-        onStoryDeleted(story.id)
-        onClose()
-      }
-    } catch {
-      alert('Erro ao deletar story.')
-    } finally {
-      setDeleting(false)
-    }
-  }
-
-  if (!story) return null
-  const viewCount = viewersStoryIdRef.current === story.id ? viewers.length : 0
-
-  return (
-    <div className="fixed inset-0 z-[2000] bg-black flex items-center justify-center">
-      <div className="absolute inset-0" onClick={deleting ? undefined : onClose} />
-
-      <div
-        className="relative w-full max-w-md h-[92vh] bg-neutral-950 border border-neutral-800 rounded-2xl overflow-hidden shadow-2xl"
-        onPointerDown={() => setHolding(true)}
-        onPointerUp={() => setHolding(false)}
-        onPointerCancel={() => setHolding(false)}
-      >
-        {/* Header / Barra de Progresso */}
-        <div className="absolute top-0 left-0 right-0 p-3 z-20 bg-gradient-to-b from-black/80 to-transparent">
-          <div className="flex gap-1 mb-2">
-            {stories.map((s, i) => (
-              <div key={s.id} className="flex-1 h-1 rounded-full bg-white/20 overflow-hidden">
-                <div
-                  className="h-full bg-white/90 transition-all duration-100 ease-linear"
-                  style={{ width: `${Math.round((i < idx ? 1 : i === idx ? progress : 0) * 100)}%` }}
-                />
-              </div>
-            ))}
-          </div>
-
-          <div className="flex items-center gap-3">
-            <div className="w-10 h-10 rounded-full overflow-hidden bg-neutral-900 border border-neutral-800">
-              {group.photoUrl ? (
-                <Image src={group.photoUrl} alt={name} width={40} height={40} className="w-full h-full object-cover" />
-              ) : (
-                <div className="w-full h-full flex items-center justify-center text-yellow-500 font-black">{initials(name)}</div>
-              )}
-            </div>
-            <div className="min-w-0 flex-1 drop-shadow-md">
-              <div className="text-sm text-white font-black truncate">{name}</div>
-              <div className="text-[11px] text-neutral-300 font-bold">{formatAgo(story.createdAt)}</div>
-            </div>
-            {isMine && (
-              <button onClick={handleDelete} className="w-10 h-10 rounded-xl bg-black/40 text-red-400 flex items-center justify-center hover:bg-black/60">
-                {deleting ? <Loader2 size={18} className="animate-spin" /> : <Trash2 size={18} />}
-              </button>
-            )}
-            {isVideo && (
-              <button
-                onClick={toggleMuted}
-                className="w-10 h-10 rounded-xl bg-black/40 text-white flex items-center justify-center hover:bg-black/60"
-                aria-label={muted ? 'Ativar som' : 'Desativar som'}
-              >
-                {muted ? <VolumeX size={18} /> : <Volume2 size={18} />}
-              </button>
-            )}
-            <button onClick={onClose} className="w-10 h-10 rounded-xl bg-black/40 text-white flex items-center justify-center hover:bg-black/60">
-              <X size={18} />
-            </button>
-          </div>
-        </div>
-
-        {/* Mídia Principal */}
-        <div className="absolute inset-0 flex items-center justify-center bg-black">
-          {story.mediaUrl ? (
-            isVideo ? (
-              <>
-                {!((isIOS && isWebm) || videoError) ? (
-                  <video
-                    ref={videoRef}
-                    src={videoSrc}
-                    className="w-full h-full object-contain"
-                    playsInline
-                    muted={muted}
-                    autoPlay
-                    onLoadedMetadata={(e) => {
-                      const d = Number((e.currentTarget as any)?.duration || 0)
-                      if (d > 0) setDurationMs(Math.max(3000, Math.min(60000, d * 1000)))
-                    }}
-                    onEnded={() => { setProgress(0); goNext(); }}
-                    onError={() => setVideoError('Não foi possível reproduzir este vídeo.')}
-                    onStalled={() => setVideoError('Este vídeo não carregou no seu dispositivo.')}
-                  />
-                ) : (
-                  <div className="px-6 text-center">
-                    <div className="text-white font-black text-lg">Story indisponível</div>
-                    <div className="mt-2 text-sm text-neutral-300 font-semibold">
-                      {videoError || (isIOS && isWebm ? 'Este story foi publicado em WEBM e pode não funcionar no iPhone.' : 'Não foi possível carregar o vídeo.')}
-                    </div>
-                    <button
-                      type="button"
-                      onClick={() => { setProgress(0); goNext(); }}
-                      className="mt-4 min-h-[44px] px-5 rounded-2xl bg-yellow-500 text-black font-black uppercase tracking-widest"
-                    >
-                      Próximo
-                    </button>
-                  </div>
-                )}
-              </>
-            ) : (
-              <Image src={story.mediaUrl} alt="Story" fill className="object-contain" sizes="(max-width: 768px) 100vw, 420px" priority />
-            )
-          ) : (
-            <div className="text-neutral-500 font-bold">Mídia indisponível</div>
-          )}
-        </div>
-
-        {/* Áreas de Toque para Navegação */}
-        <button className="absolute left-0 top-20 bottom-20 w-1/3 z-10" onClick={() => setIdx((v) => Math.max(0, v - 1))} aria-label="Anterior" />
-        <button className="absolute right-0 top-20 bottom-20 w-1/3 z-10" onClick={() => setIdx((v) => Math.min(stories.length - 1, v + 1))} aria-label="Próximo" />
-
-        {/* Footer / Controles */}
-        <div className="absolute bottom-0 left-0 right-0 p-3 z-20 bg-gradient-to-t from-black/90 to-transparent pt-12">
-          <div className="flex items-center justify-between gap-2">
-            <div className="flex items-center gap-2">
-              {isMine && (
-                <div className="flex flex-col items-center">
-                  <button onClick={() => { setViewersOpen(!viewersOpen); setCommentsOpen(false); if (!viewersOpen) loadViewers(story.id) }} className="w-12 h-12 rounded-2xl bg-neutral-900/80 border border-neutral-800 text-white flex items-center justify-center">
-                    <Eye size={20} />
-                  </button>
-                  <span className="text-[10px] font-bold text-white drop-shadow">{viewCount}</span>
-                </div>
-              )}
-              
-              <div className="flex flex-col items-center">
-                <button onClick={toggleLike} className={`w-12 h-12 rounded-2xl border flex items-center justify-center ${story.hasLiked ? 'bg-red-500/20 border-red-500 text-red-400' : 'bg-neutral-900/80 border-neutral-800 text-white'}`}>
-                  <Heart size={20} className={story.hasLiked ? 'fill-current' : ''} />
-                </button>
-                <span className="text-[10px] font-bold text-white drop-shadow">{story.likeCount}</span>
-              </div>
-
-              <div className="flex flex-col items-center">
-                <button onClick={() => { setCommentsOpen(!commentsOpen); setViewersOpen(false); if (!commentsOpen) loadComments(story.id) }} className="w-12 h-12 rounded-2xl bg-neutral-900/80 border border-neutral-800 text-white flex items-center justify-center">
-                  <MessageCircle size={20} />
-                </button>
-                <span className="text-[10px] font-bold text-white drop-shadow">{story.commentCount}</span>
-              </div>
-            </div>
-          </div>
-
-          {/* Modal de Comentários / Views */}
-          {(commentsOpen || viewersOpen) && (
-            <motion.div initial={{ y: 20, opacity: 0 }} animate={{ y: 0, opacity: 1 }} className="mt-3 bg-neutral-900/95 border border-neutral-800 rounded-2xl overflow-hidden backdrop-blur-sm">
-              <div className="max-h-[30vh] overflow-y-auto custom-scrollbar p-3 space-y-3">
-                {viewersOpen && viewers.map((v) => (
-                   <div key={v.viewerId} className="flex items-center gap-3">
-                      <div className="w-8 h-8 rounded-full bg-neutral-800 overflow-hidden">
-                        {v.photoUrl ? <Image src={v.photoUrl} width={32} height={32} alt="" /> : <div className="w-full h-full flex items-center justify-center text-xs text-yellow-500">{initials(v.displayName)}</div>}
-                      </div>
-                      <span className="text-xs font-bold text-white flex-1">{v.displayName || 'Usuário'}</span>
-                      <span className="text-[10px] text-neutral-400">{formatAgo(v.viewedAt)}</span>
-                   </div>
-                ))}
-                {commentsOpen && comments.map((c) => (
-                  <div key={c.id} className="flex gap-3">
-                    <div className="w-8 h-8 rounded-full bg-neutral-800 overflow-hidden shrink-0">
-                      {c.user?.photoUrl ? <Image src={c.user.photoUrl} width={32} height={32} alt="" /> : <div className="w-full h-full flex items-center justify-center text-xs text-yellow-500">{initials(c.user?.displayName || '')}</div>}
-                    </div>
-                    <div>
-                      <div className="text-xs font-black text-white">{c.user?.displayName || 'Usuário'}</div>
-                      <div className="text-xs text-neutral-300">{c.body}</div>
-                    </div>
-                  </div>
-                ))}
-                {((viewersOpen && !viewers.length && !viewersLoading) || (commentsOpen && !comments.length && !commentsLoading)) && (
-                  <div className="text-center text-xs text-neutral-500 py-2">Nada por aqui ainda.</div>
-                )}
-              </div>
-              
-              {commentsOpen && (
-                <div className="p-2 border-t border-neutral-800 flex gap-2">
-                  <input value={commentText} onChange={e => setCommentText(e.target.value)} className="flex-1 bg-black/40 border border-neutral-700 rounded-xl px-3 text-xs text-white" placeholder="Escreva..." />
-                  <button onClick={sendComment} className="px-3 py-2 bg-yellow-500 rounded-xl text-black text-xs font-black">Enviar</button>
-                </div>
-              )}
-            </motion.div>
-          )}
-        </div>
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/components/stories/VideoTrimmer 2.tsx b/_archive/duplicates/src/components/stories/VideoTrimmer 2.tsx
deleted file mode 100644
index 663b6d4..0000000
--- a/_archive/duplicates/src/components/stories/VideoTrimmer 2.tsx	
+++ /dev/null
@@ -1,161 +0,0 @@
-'use client'
-
-import React, { useEffect, useRef, useState, useCallback } from 'react'
-import { ZoomIn, ZoomOut, Play, Pause, Scissors } from 'lucide-react'
-
-interface VideoTrimmerProps {
-  duration: number
-  value: [number, number]
-  onChange: (range: [number, number]) => void
-  onPreview: (playing: boolean) => void
-  currentTime: number
-}
-
-const MIN_DURATION = 1 // 1 second
-const MAX_DURATION = 60 // 60 seconds
-
-export default function VideoTrimmer({ duration, value, onChange, onPreview, currentTime }: VideoTrimmerProps) {
-  const [zoom, setZoom] = useState(1)
-  const [dragging, setDragging] = useState<'start' | 'end' | null>(null)
-  const trackRef = useRef<HTMLDivElement>(null)
-  
-  // Helpers to convert time <-> pixels
-  const getPercent = (time: number) => Math.max(0, Math.min(100, (time / duration) * 100))
-  
-  const handlePointerDown = (type: 'start' | 'end', e: React.PointerEvent) => {
-    e.preventDefault()
-    e.stopPropagation()
-    setDragging(type)
-    // @ts-ignore
-    e.currentTarget.setPointerCapture(e.pointerId)
-  }
-
-  const handlePointerMove = (e: React.PointerEvent) => {
-    if (!dragging || !trackRef.current) return
-    const rect = trackRef.current.getBoundingClientRect()
-    const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width))
-    const time = pct * duration
-    
-    let [start, end] = value
-    
-    if (dragging === 'start') {
-      // Constraints: start < end - min, start > end - max
-      // Actually simpler: 
-      // New start must be <= end - MIN
-      // New start must be >= end - MAX
-      const maxStart = end - MIN_DURATION
-      const minStart = Math.max(0, end - MAX_DURATION)
-      start = Math.max(minStart, Math.min(maxStart, time))
-    } else {
-      // end > start + min, end < start + max
-      const minEnd = start + MIN_DURATION
-      const maxEnd = Math.min(duration, start + MAX_DURATION)
-      end = Math.max(minEnd, Math.min(maxEnd, time))
-    }
-    
-    onChange([start, end])
-  }
-
-  const handlePointerUp = (e: React.PointerEvent) => {
-    setDragging(null)
-    // @ts-ignore
-    e.currentTarget.releasePointerCapture(e.pointerId)
-  }
-
-  // Format time
-  const fmt = (s: number) => {
-    const m = Math.floor(s / 60)
-    const sec = Math.floor(s % 60)
-    const ms = Math.floor((s % 1) * 10)
-    return `${m}:${sec.toString().padStart(2, '0')}.${ms}`
-  }
-
-  return (
-    <div className="w-full space-y-3 bg-neutral-900/50 p-4 rounded-xl border border-neutral-800">
-      <div className="flex items-center justify-between text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
-        <div className="flex items-center gap-2">
-            <Scissors size={14} className="text-yellow-500" />
-            <span>Editor de Tempo</span>
-        </div>
-        <div className="flex items-center gap-2">
-            <span className={value[1] - value[0] > 60 ? 'text-red-500' : 'text-white'}>
-                {fmt(value[1] - value[0])}s
-            </span>
-            <span className="text-neutral-600">/ 60.0s</span>
-        </div>
-      </div>
-
-      <div className="relative w-full h-12 select-none touch-none overflow-hidden" 
-           onPointerMove={handlePointerMove}
-           onPointerUp={handlePointerUp}
-           onPointerLeave={handlePointerUp}
-      >
-         <div 
-            ref={trackRef}
-            className="absolute top-0 bottom-0 left-0 bg-neutral-800 rounded-lg overflow-hidden transition-all duration-200"
-            style={{ width: `${zoom * 100}%` }}
-         >
-            {/* Playhead */}
-            <div 
-                className="absolute top-0 bottom-0 w-0.5 bg-white z-20 pointer-events-none"
-                style={{ left: `${getPercent(currentTime)}%` }}
-            />
-
-            {/* Selected Range */}
-            <div 
-                className="absolute top-0 bottom-0 bg-yellow-500/20 border-t-2 border-b-2 border-yellow-500/50 z-10"
-                style={{ 
-                    left: `${getPercent(value[0])}%`, 
-                    right: `${100 - getPercent(value[1])}%` 
-                }}
-            >
-                {/* Drag Handles */}
-                <div 
-                    className="absolute left-0 top-0 bottom-0 w-4 -ml-2 bg-yellow-500 cursor-ew-resize flex items-center justify-center hover:scale-110 active:scale-110 transition-transform z-30 rounded-l-md"
-                    onPointerDown={(e) => handlePointerDown('start', e)}
-                >
-                    <div className="w-0.5 h-4 bg-black/50 rounded-full" />
-                </div>
-                <div 
-                    className="absolute right-0 top-0 bottom-0 w-4 -mr-2 bg-yellow-500 cursor-ew-resize flex items-center justify-center hover:scale-110 active:scale-110 transition-transform z-30 rounded-r-md"
-                    onPointerDown={(e) => handlePointerDown('end', e)}
-                >
-                    <div className="w-0.5 h-4 bg-black/50 rounded-full" />
-                </div>
-            </div>
-
-            {/* Time Markers */}
-            <div className="absolute bottom-0 left-0 right-0 h-1 flex justify-between px-1 pointer-events-none opacity-50">
-                {[...Array(10)].map((_, i) => (
-                    <div key={i} className="w-px h-full bg-neutral-600" />
-                ))}
-            </div>
-         </div>
-      </div>
-
-      <div className="flex items-center justify-between">
-         <div className="flex items-center gap-2">
-            <button 
-                onClick={() => setZoom(Math.max(1, zoom - 0.5))}
-                className="p-2 rounded-lg bg-neutral-800 text-neutral-400 hover:text-white disabled:opacity-50"
-                disabled={zoom <= 1}
-            >
-                <ZoomOut size={14} />
-            </button>
-            <span className="text-[10px] font-bold text-neutral-500">{zoom}x</span>
-            <button 
-                onClick={() => setZoom(Math.min(4, zoom + 0.5))}
-                className="p-2 rounded-lg bg-neutral-800 text-neutral-400 hover:text-white disabled:opacity-50"
-                disabled={zoom >= 4}
-            >
-                <ZoomIn size={14} />
-            </button>
-         </div>
-         
-         <div className="text-[10px] text-neutral-500 font-mono">
-            {fmt(value[0])} - {fmt(value[1])}
-         </div>
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/components/stories/VideoTrimmer 3.tsx b/_archive/duplicates/src/components/stories/VideoTrimmer 3.tsx
deleted file mode 100644
index 663b6d4..0000000
--- a/_archive/duplicates/src/components/stories/VideoTrimmer 3.tsx	
+++ /dev/null
@@ -1,161 +0,0 @@
-'use client'
-
-import React, { useEffect, useRef, useState, useCallback } from 'react'
-import { ZoomIn, ZoomOut, Play, Pause, Scissors } from 'lucide-react'
-
-interface VideoTrimmerProps {
-  duration: number
-  value: [number, number]
-  onChange: (range: [number, number]) => void
-  onPreview: (playing: boolean) => void
-  currentTime: number
-}
-
-const MIN_DURATION = 1 // 1 second
-const MAX_DURATION = 60 // 60 seconds
-
-export default function VideoTrimmer({ duration, value, onChange, onPreview, currentTime }: VideoTrimmerProps) {
-  const [zoom, setZoom] = useState(1)
-  const [dragging, setDragging] = useState<'start' | 'end' | null>(null)
-  const trackRef = useRef<HTMLDivElement>(null)
-  
-  // Helpers to convert time <-> pixels
-  const getPercent = (time: number) => Math.max(0, Math.min(100, (time / duration) * 100))
-  
-  const handlePointerDown = (type: 'start' | 'end', e: React.PointerEvent) => {
-    e.preventDefault()
-    e.stopPropagation()
-    setDragging(type)
-    // @ts-ignore
-    e.currentTarget.setPointerCapture(e.pointerId)
-  }
-
-  const handlePointerMove = (e: React.PointerEvent) => {
-    if (!dragging || !trackRef.current) return
-    const rect = trackRef.current.getBoundingClientRect()
-    const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width))
-    const time = pct * duration
-    
-    let [start, end] = value
-    
-    if (dragging === 'start') {
-      // Constraints: start < end - min, start > end - max
-      // Actually simpler: 
-      // New start must be <= end - MIN
-      // New start must be >= end - MAX
-      const maxStart = end - MIN_DURATION
-      const minStart = Math.max(0, end - MAX_DURATION)
-      start = Math.max(minStart, Math.min(maxStart, time))
-    } else {
-      // end > start + min, end < start + max
-      const minEnd = start + MIN_DURATION
-      const maxEnd = Math.min(duration, start + MAX_DURATION)
-      end = Math.max(minEnd, Math.min(maxEnd, time))
-    }
-    
-    onChange([start, end])
-  }
-
-  const handlePointerUp = (e: React.PointerEvent) => {
-    setDragging(null)
-    // @ts-ignore
-    e.currentTarget.releasePointerCapture(e.pointerId)
-  }
-
-  // Format time
-  const fmt = (s: number) => {
-    const m = Math.floor(s / 60)
-    const sec = Math.floor(s % 60)
-    const ms = Math.floor((s % 1) * 10)
-    return `${m}:${sec.toString().padStart(2, '0')}.${ms}`
-  }
-
-  return (
-    <div className="w-full space-y-3 bg-neutral-900/50 p-4 rounded-xl border border-neutral-800">
-      <div className="flex items-center justify-between text-[10px] font-bold text-neutral-400 uppercase tracking-wider">
-        <div className="flex items-center gap-2">
-            <Scissors size={14} className="text-yellow-500" />
-            <span>Editor de Tempo</span>
-        </div>
-        <div className="flex items-center gap-2">
-            <span className={value[1] - value[0] > 60 ? 'text-red-500' : 'text-white'}>
-                {fmt(value[1] - value[0])}s
-            </span>
-            <span className="text-neutral-600">/ 60.0s</span>
-        </div>
-      </div>
-
-      <div className="relative w-full h-12 select-none touch-none overflow-hidden" 
-           onPointerMove={handlePointerMove}
-           onPointerUp={handlePointerUp}
-           onPointerLeave={handlePointerUp}
-      >
-         <div 
-            ref={trackRef}
-            className="absolute top-0 bottom-0 left-0 bg-neutral-800 rounded-lg overflow-hidden transition-all duration-200"
-            style={{ width: `${zoom * 100}%` }}
-         >
-            {/* Playhead */}
-            <div 
-                className="absolute top-0 bottom-0 w-0.5 bg-white z-20 pointer-events-none"
-                style={{ left: `${getPercent(currentTime)}%` }}
-            />
-
-            {/* Selected Range */}
-            <div 
-                className="absolute top-0 bottom-0 bg-yellow-500/20 border-t-2 border-b-2 border-yellow-500/50 z-10"
-                style={{ 
-                    left: `${getPercent(value[0])}%`, 
-                    right: `${100 - getPercent(value[1])}%` 
-                }}
-            >
-                {/* Drag Handles */}
-                <div 
-                    className="absolute left-0 top-0 bottom-0 w-4 -ml-2 bg-yellow-500 cursor-ew-resize flex items-center justify-center hover:scale-110 active:scale-110 transition-transform z-30 rounded-l-md"
-                    onPointerDown={(e) => handlePointerDown('start', e)}
-                >
-                    <div className="w-0.5 h-4 bg-black/50 rounded-full" />
-                </div>
-                <div 
-                    className="absolute right-0 top-0 bottom-0 w-4 -mr-2 bg-yellow-500 cursor-ew-resize flex items-center justify-center hover:scale-110 active:scale-110 transition-transform z-30 rounded-r-md"
-                    onPointerDown={(e) => handlePointerDown('end', e)}
-                >
-                    <div className="w-0.5 h-4 bg-black/50 rounded-full" />
-                </div>
-            </div>
-
-            {/* Time Markers */}
-            <div className="absolute bottom-0 left-0 right-0 h-1 flex justify-between px-1 pointer-events-none opacity-50">
-                {[...Array(10)].map((_, i) => (
-                    <div key={i} className="w-px h-full bg-neutral-600" />
-                ))}
-            </div>
-         </div>
-      </div>
-
-      <div className="flex items-center justify-between">
-         <div className="flex items-center gap-2">
-            <button 
-                onClick={() => setZoom(Math.max(1, zoom - 0.5))}
-                className="p-2 rounded-lg bg-neutral-800 text-neutral-400 hover:text-white disabled:opacity-50"
-                disabled={zoom <= 1}
-            >
-                <ZoomOut size={14} />
-            </button>
-            <span className="text-[10px] font-bold text-neutral-500">{zoom}x</span>
-            <button 
-                onClick={() => setZoom(Math.min(4, zoom + 0.5))}
-                className="p-2 rounded-lg bg-neutral-800 text-neutral-400 hover:text-white disabled:opacity-50"
-                disabled={zoom >= 4}
-            >
-                <ZoomIn size={14} />
-            </button>
-         </div>
-         
-         <div className="text-[10px] text-neutral-500 font-mono">
-            {fmt(value[0])} - {fmt(value[1])}
-         </div>
-      </div>
-    </div>
-  )
-}
diff --git a/_archive/duplicates/src/hooks/useAssessment 2.ts b/_archive/duplicates/src/hooks/useAssessment 2.ts
deleted file mode 100644
index 2c5c064..0000000
--- a/_archive/duplicates/src/hooks/useAssessment 2.ts	
+++ /dev/null
@@ -1,451 +0,0 @@
-// Hook para gerenciamento de avaliações físicas
-'use client';
-import { useState, useCallback, useEffect, useMemo } from 'react';
-import { createClient } from '@/utils/supabase/client';
-import {
-  Assessment,
-  AssessmentFormData,
-  AssessmentResponse,
-  CreateAssessmentRequest,
-  UpdateAssessmentRequest,
-  parseNumberInput
-} from '@/types/assessment';
-import {
-  calculateBodyFatPercentage,
-  calculateBMR,
-  calculateBMI,
-  calculateFatMass,
-  calculateLeanMass,
-  calculateBodyDensity,
-  calculateSumSkinfolds
-} from '@/utils/calculations/bodyComposition';
-
-interface UseAssessmentReturn {
-  // Estado
-  assessments: Assessment[];
-  loading: boolean;
-  error: string | null;
-  
-  // Ações
-  createAssessment: (data: AssessmentFormData, studentId: string) => Promise<AssessmentResponse>;
-  updateAssessment: (id: string, data: UpdateAssessmentRequest) => Promise<AssessmentResponse>;
-  deleteAssessment: (id: string) => Promise<AssessmentResponse>;
-  getAssessment: (id: string) => Promise<Assessment | null>;
-  getStudentAssessments: (studentId: string) => Promise<Assessment[]>;
-  refreshAssessments: () => Promise<void>;
-  
-  // Utilitários
-  clearError: () => void;
-  formDataToAssessment: (data: AssessmentFormData, studentId: string) => CreateAssessmentRequest;
-}
-
-export const useAssessment = (): UseAssessmentReturn => {
-  const supabase = useMemo(() => createClient(), []);
-  const [user, setUser] = useState<any>(null);
-  const [assessments, setAssessments] = useState<Assessment[]>([]);
-  const [loading, setLoading] = useState(false);
-  const [error, setError] = useState<string | null>(null);
-  const [currentStudentId, setCurrentStudentId] = useState<string | null>(null);
-
-  useEffect(() => {
-    let isMounted = true;
-
-    const loadUser = async () => {
-      try {
-        const {
-          data: { user }
-        } = await supabase.auth.getUser();
-
-        if (isMounted) {
-          setUser(user);
-        }
-      } catch (e) {
-        console.error('Erro ao carregar usuário no hook useAssessment', e);
-        if (isMounted) {
-          setUser(null);
-        }
-      }
-    };
-
-    loadUser();
-
-    return () => {
-      isMounted = false;
-    };
-  }, [supabase]);
-
-  // Limpar erro
-  const clearError = useCallback(() => {
-    setError(null);
-  }, []);
-
-  const resolveStudentRecordId = useCallback(
-    async (rawStudentId: string): Promise<string> => {
-      const candidateId = (rawStudentId || '').trim();
-
-      if (!candidateId) {
-        throw new Error('ID do aluno não informado para a avaliação.');
-      }
-
-      try {
-        // Tenta buscar direto na profiles (se for ID de usuário)
-        const { data: directProfile, error: directProfileError } = await supabase
-          .from('profiles')
-          .select('id')
-          .eq('id', candidateId)
-          .maybeSingle();
-
-        if (directProfileError) {
-          console.error('Erro ao buscar perfil do aluno (por id) para avaliação', directProfileError);
-        }
-
-        if (directProfile?.id) {
-          return directProfile.id as string;
-        }
-
-        // Tenta buscar na tabela students pelo ID do registro
-        const { data: studentById, error: studentByIdError } = await supabase
-          .from('students')
-          .select('id, user_id, email')
-          .eq('id', candidateId)
-          .maybeSingle();
-
-        if (studentByIdError) {
-          console.error('Erro ao buscar aluno por id para avaliação', studentByIdError);
-        }
-
-        if (studentById?.user_id) {
-          try {
-            const { data: profileForStudent } = await supabase
-              .from('profiles')
-              .select('id')
-              .eq('id', studentById.user_id)
-              .maybeSingle();
-
-            if (profileForStudent?.id) {
-              return profileForStudent.id as string;
-            }
-          } catch (e) {
-            console.error('Erro ao validar perfil vinculado ao aluno (por id)', e);
-            return studentById.user_id as string;
-          }
-        }
-
-        // Tenta buscar pelo email na profiles
-        if (studentById?.email) {
-          const { data: profileByEmail, error: profileByEmailError } = await supabase
-            .from('profiles')
-            .select('id')
-            .ilike('email', studentById.email)
-            .maybeSingle();
-
-          if (profileByEmailError) {
-            console.error('Erro ao buscar perfil por email do aluno (por id)', profileByEmailError);
-          }
-
-          if (profileByEmail?.id) {
-            return profileByEmail.id as string;
-          }
-        }
-
-        // Tenta buscar na students pelo user_id
-        const { data: studentByUser, error: studentByUserError } = await supabase
-          .from('students')
-          .select('id, user_id, email')
-          .eq('user_id', candidateId)
-          .maybeSingle();
-
-        if (studentByUserError) {
-          console.error('Erro ao buscar aluno por user_id para avaliação', studentByUserError);
-        }
-
-        if (studentByUser?.user_id) {
-          return studentByUser.user_id as string;
-        }
-
-        throw new Error(
-          'Não foi possível localizar um perfil vinculado a este aluno. Verifique se o aluno já ativou a conta pelo convite.'
-        );
-      } catch (e) {
-        const message =
-          e instanceof Error
-            ? e.message
-            : 'Falha ao resolver o perfil vinculado à avaliação.';
-        throw new Error(message);
-      }
-    },
-    [supabase]
-  );
-
-  const normalizeAssessmentRow = useCallback((row: any): Assessment => {
-    if (!row || typeof row !== 'object') {
-      return row;
-    }
-
-    const toNumberOrUndefined = (value: any) => {
-      if (typeof value === 'number') return value;
-      if (typeof value === 'string') {
-        const parsed = parseFloat(value);
-        return isNaN(parsed) ? undefined : parsed;
-      }
-      return undefined;
-    };
-
-    return {
-      ...row,
-      weight: toNumberOrUndefined(row.weight) ?? 0,
-      height: toNumberOrUndefined(row.height) ?? 0,
-      age: toNumberOrUndefined(row.age) ?? 0,
-      
-      // Circunferências
-      arm_circ: toNumberOrUndefined(row.arm_circ),
-      chest_circ: toNumberOrUndefined(row.chest_circ),
-      waist_circ: toNumberOrUndefined(row.waist_circ),
-      hip_circ: toNumberOrUndefined(row.hip_circ),
-      thigh_circ: toNumberOrUndefined(row.thigh_circ),
-      calf_circ: toNumberOrUndefined(row.calf_circ),
-
-      // Dobras
-      triceps_skinfold: toNumberOrUndefined(row.triceps_skinfold),
-      biceps_skinfold: toNumberOrUndefined(row.biceps_skinfold),
-      subscapular_skinfold: toNumberOrUndefined(row.subscapular_skinfold),
-      suprailiac_skinfold: toNumberOrUndefined(row.suprailiac_skinfold),
-      abdominal_skinfold: toNumberOrUndefined(row.abdominal_skinfold),
-      thigh_skinfold: toNumberOrUndefined(row.thigh_skinfold),
-      calf_skinfold: toNumberOrUndefined(row.calf_skinfold),
-
-      // Cálculos
-      body_fat_percentage: toNumberOrUndefined(row.body_fat_percentage),
-      lean_mass: toNumberOrUndefined(row.lean_mass),
-      fat_mass: toNumberOrUndefined(row.fat_mass),
-      bmr: toNumberOrUndefined(row.bmr),
-      tdee: toNumberOrUndefined(row.tdee),
-      bmi: toNumberOrUndefined(row.bmi),
-    } as Assessment;
-  }, []);
-
-  const getAssessment = useCallback(async (id: string) => {
-    try {
-      setLoading(true);
-      setError(null);
-      const { data, error } = await supabase
-        .from('assessments')
-        .select('*')
-        .eq('id', id)
-        .single();
-
-      if (error) throw error;
-      return normalizeAssessmentRow(data);
-    } catch (e: any) {
-      console.error('Erro ao buscar avaliação:', e);
-      setError(e.message);
-      return null;
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, normalizeAssessmentRow]);
-
-  const getStudentAssessments = useCallback(async (studentId: string) => {
-    try {
-      setLoading(true);
-      setError(null);
-      
-      const resolvedId = await resolveStudentRecordId(studentId);
-      setCurrentStudentId(resolvedId);
-
-      const { data, error } = await supabase
-        .from('assessments')
-        .select('*')
-        .eq('student_id', resolvedId)
-        .order('assessment_date', { ascending: false });
-
-      if (error) throw error;
-      
-      const normalized = (data || []).map(normalizeAssessmentRow);
-      setAssessments(normalized);
-      return normalized;
-    } catch (e: any) {
-      console.error('Erro ao buscar avaliações do aluno:', e);
-      setError(e.message);
-      return [];
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, resolveStudentRecordId, normalizeAssessmentRow]);
-
-  const refreshAssessments = useCallback(async () => {
-    if (currentStudentId) {
-      await getStudentAssessments(currentStudentId);
-    }
-  }, [currentStudentId, getStudentAssessments]);
-
-  const formDataToAssessment = useCallback((data: AssessmentFormData, studentId: string): CreateAssessmentRequest => {
-    // Converter valores
-    const weight = parseNumberInput(data.weight) || 0;
-    const height = parseNumberInput(data.height) || 0;
-    const age = parseInt(data.age) || 0;
-    const gender = data.gender;
-
-    // Dobras
-    const triceps = parseNumberInput(data.triceps_skinfold);
-    const biceps = parseNumberInput(data.biceps_skinfold);
-    const subscapular = parseNumberInput(data.subscapular_skinfold);
-    const suprailiac = parseNumberInput(data.suprailiac_skinfold);
-    const abdominal = parseNumberInput(data.abdominal_skinfold);
-    const thigh = parseNumberInput(data.thigh_skinfold);
-    const calf = parseNumberInput(data.calf_skinfold);
-
-    // Calcular métricas
-    const sumSkinfolds = calculateSumSkinfolds({
-      triceps_skinfold: triceps ?? undefined,
-      biceps_skinfold: biceps ?? undefined,
-      subscapular_skinfold: subscapular ?? undefined,
-      suprailiac_skinfold: suprailiac ?? undefined,
-      abdominal_skinfold: abdominal ?? undefined,
-      thigh_skinfold: thigh ?? undefined,
-      calf_skinfold: calf ?? undefined,
-    });
-
-    const bodyDensity = calculateBodyDensity(sumSkinfolds, age, gender);
-    const bodyFat = calculateBodyFatPercentage(bodyDensity);
-    const fatMass = calculateFatMass(weight, bodyFat);
-    const leanMass = calculateLeanMass(weight, fatMass);
-    const bmi = calculateBMI(weight, height);
-    const bmr = calculateBMR(weight, height, age, gender);
-
-    return {
-      student_id: studentId,
-      trainer_id: user?.id, // Será preenchido pelo hook ou backend
-      assessment_date: data.assessment_date,
-      weight,
-      height,
-      age,
-      gender,
-      
-      // Circunferências
-      arm_circ: parseNumberInput(data.arm_circ) ?? undefined,
-      chest_circ: parseNumberInput(data.chest_circ) ?? undefined,
-      waist_circ: parseNumberInput(data.waist_circ) ?? undefined,
-      hip_circ: parseNumberInput(data.hip_circ) ?? undefined,
-      thigh_circ: parseNumberInput(data.thigh_circ) ?? undefined,
-      calf_circ: parseNumberInput(data.calf_circ) ?? undefined,
-
-      // Dobras
-      triceps_skinfold: triceps ?? undefined,
-      biceps_skinfold: biceps ?? undefined,
-      subscapular_skinfold: subscapular ?? undefined,
-      suprailiac_skinfold: suprailiac ?? undefined,
-      abdominal_skinfold: abdominal ?? undefined,
-      thigh_skinfold: thigh ?? undefined,
-      calf_skinfold: calf ?? undefined,
-
-      // Calculados
-      body_fat_percentage: bodyFat,
-      lean_mass: leanMass,
-      fat_mass: fatMass,
-      bmi,
-      bmr,
-      
-      observations: data.observations
-    };
-  }, [user?.id]);
-
-  const createAssessment = useCallback(async (data: AssessmentFormData, studentId: string): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      if (!user?.id) throw new Error('Usuário não autenticado');
-
-      const resolvedStudentId = await resolveStudentRecordId(studentId);
-      const payload = formDataToAssessment(data, resolvedStudentId);
-      
-      // Garantir trainer_id
-      payload.trainer_id = user.id;
-
-      const { data: newAssessment, error: insertError } = await supabase
-        .from('assessments')
-        .insert(payload)
-        .select()
-        .single();
-
-      if (insertError) throw insertError;
-
-      const normalized = normalizeAssessmentRow(newAssessment);
-      setAssessments(prev => [normalized, ...prev]);
-      
-      return { success: true, data: normalized };
-    } catch (e: any) {
-      console.error('Erro ao criar avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, user?.id, resolveStudentRecordId, formDataToAssessment, normalizeAssessmentRow]);
-
-  const updateAssessment = useCallback(async (id: string, data: UpdateAssessmentRequest): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      const { data: updated, error: updateError } = await supabase
-        .from('assessments')
-        .update(data)
-        .eq('id', id)
-        .select()
-        .single();
-
-      if (updateError) throw updateError;
-
-      const normalized = normalizeAssessmentRow(updated);
-      setAssessments(prev => prev.map(a => a.id === id ? normalized : a));
-
-      return { success: true, data: normalized };
-    } catch (e: any) {
-      console.error('Erro ao atualizar avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, normalizeAssessmentRow]);
-
-  const deleteAssessment = useCallback(async (id: string): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      const { error: deleteError } = await supabase
-        .from('assessments')
-        .delete()
-        .eq('id', id);
-
-      if (deleteError) throw deleteError;
-
-      setAssessments(prev => prev.filter(a => a.id !== id));
-
-      return { success: true };
-    } catch (e: any) {
-      console.error('Erro ao excluir avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase]);
-
-  return {
-    assessments,
-    loading,
-    error,
-    createAssessment,
-    updateAssessment,
-    deleteAssessment,
-    getAssessment,
-    getStudentAssessments,
-    refreshAssessments,
-    clearError,
-    formDataToAssessment
-  };
-};
diff --git a/_archive/duplicates/src/hooks/useAssessment 3.ts b/_archive/duplicates/src/hooks/useAssessment 3.ts
deleted file mode 100644
index e7b333f..0000000
--- a/_archive/duplicates/src/hooks/useAssessment 3.ts	
+++ /dev/null
@@ -1,451 +0,0 @@
-// Hook para gerenciamento de avaliações físicas
-'use client';
-import { useState, useCallback, useEffect, useMemo } from 'react';
-import { createClient } from '@/utils/supabase/client';
-import {
-  Assessment,
-  AssessmentFormData,
-  AssessmentResponse,
-  CreateAssessmentRequest,
-  UpdateAssessmentRequest,
-  parseNumberInput
-} from '@/types/assessment';
-import {
-  calculateBodyFatPercentage,
-  calculateBMR,
-  calculateBMI,
-  calculateFatMass,
-  calculateLeanMass,
-  calculateBodyDensity,
-  calculateSumSkinfolds
-} from '@/utils/calculations/bodyComposition';
-
-interface UseAssessmentReturn {
-  // Estado
-  assessments: Assessment[];
-  loading: boolean;
-  error: string | null;
-  
-  // Ações
-  createAssessment: (data: AssessmentFormData, studentId: string) => Promise<AssessmentResponse>;
-  updateAssessment: (id: string, data: UpdateAssessmentRequest) => Promise<AssessmentResponse>;
-  deleteAssessment: (id: string) => Promise<AssessmentResponse>;
-  getAssessment: (id: string) => Promise<Assessment | null>;
-  getStudentAssessments: (studentId: string) => Promise<Assessment[]>;
-  refreshAssessments: () => Promise<void>;
-  
-  // Utilitários
-  clearError: () => void;
-  formDataToAssessment: (data: AssessmentFormData, studentId: string) => CreateAssessmentRequest;
-}
-
-export const useAssessment = (): UseAssessmentReturn => {
-  const supabase = useMemo(() => createClient(), []);
-  const [user, setUser] = useState<any>(null);
-  const [assessments, setAssessments] = useState<Assessment[]>([]);
-  const [loading, setLoading] = useState(false);
-  const [error, setError] = useState<string | null>(null);
-  const [currentStudentId, setCurrentStudentId] = useState<string | null>(null);
-
-  useEffect(() => {
-    let isMounted = true;
-
-    const loadUser = async () => {
-      try {
-        const {
-          data: { user }
-        } = await supabase.auth.getUser();
-
-        if (isMounted) {
-          setUser(user);
-        }
-      } catch (e) {
-        console.error('Erro ao carregar usuário no hook useAssessment', e);
-        if (isMounted) {
-          setUser(null);
-        }
-      }
-    };
-
-    loadUser();
-
-    return () => {
-      isMounted = false;
-    };
-  }, [supabase]);
-
-  // Limpar erro
-  const clearError = useCallback(() => {
-    setError(null);
-  }, []);
-
-  const resolveStudentRecordId = useCallback(
-    async (rawStudentId: string): Promise<string> => {
-      const candidateId = (rawStudentId || '').trim();
-
-      if (!candidateId) {
-        throw new Error('ID do aluno não informado para a avaliação.');
-      }
-
-      try {
-        // Tenta buscar direto na profiles (se for ID de usuário)
-        const { data: directProfile, error: directProfileError } = await supabase
-          .from('profiles')
-          .select('id')
-          .eq('id', candidateId)
-          .maybeSingle();
-
-        if (directProfileError) {
-          console.error('Erro ao buscar perfil do aluno (por id) para avaliação', directProfileError);
-        }
-
-        if (directProfile?.id) {
-          return directProfile.id as string;
-        }
-
-        // Tenta buscar na tabela students pelo ID do registro
-        const { data: studentById, error: studentByIdError } = await supabase
-          .from('students')
-          .select('id, user_id, email')
-          .eq('id', candidateId)
-          .maybeSingle();
-
-        if (studentByIdError) {
-          console.error('Erro ao buscar aluno por id para avaliação', studentByIdError);
-        }
-
-        if (studentById?.user_id) {
-          try {
-            const { data: profileForStudent } = await supabase
-              .from('profiles')
-              .select('id')
-              .eq('id', studentById.user_id)
-              .maybeSingle();
-
-            if (profileForStudent?.id) {
-              return profileForStudent.id as string;
-            }
-          } catch (e) {
-            console.error('Erro ao validar perfil vinculado ao aluno (por id)', e);
-            return studentById.user_id as string;
-          }
-        }
-
-        // Tenta buscar pelo email na profiles
-        if (studentById?.email) {
-          const { data: profileByEmail, error: profileByEmailError } = await supabase
-            .from('profiles')
-            .select('id')
-            .ilike('email', studentById.email)
-            .maybeSingle();
-
-          if (profileByEmailError) {
-            console.error('Erro ao buscar perfil por email do aluno (por id)', profileByEmailError);
-          }
-
-          if (profileByEmail?.id) {
-            return profileByEmail.id as string;
-          }
-        }
-
-        // Tenta buscar na students pelo user_id
-        const { data: studentByUser, error: studentByUserError } = await supabase
-          .from('students')
-          .select('id, user_id, email')
-          .eq('user_id', candidateId)
-          .maybeSingle();
-
-        if (studentByUserError) {
-          console.error('Erro ao buscar aluno por user_id para avaliação', studentByUserError);
-        }
-
-        if (studentByUser?.user_id) {
-          return studentByUser.user_id as string;
-        }
-
-        throw new Error(
-          'Não foi possível localizar um perfil vinculado a este aluno. Verifique se o aluno já ativou a conta pelo convite.'
-        );
-      } catch (e) {
-        const message =
-          e instanceof Error
-            ? e.message
-            : 'Falha ao resolver o perfil vinculado à avaliação.';
-        throw new Error(message);
-      }
-    },
-    [supabase]
-  );
-
-  const normalizeAssessmentRow = useCallback((row: any): Assessment => {
-    if (!row || typeof row !== 'object') {
-      return row;
-    }
-
-    const toNumberOrUndefined = (value: any) => {
-      if (typeof value === 'number') return value;
-      if (typeof value === 'string') {
-        const parsed = parseFloat(value);
-        return isNaN(parsed) ? undefined : parsed;
-      }
-      return undefined;
-    };
-
-    return {
-      ...row,
-      weight: toNumberOrUndefined(row.weight) ?? 0,
-      height: toNumberOrUndefined(row.height) ?? 0,
-      age: toNumberOrUndefined(row.age) ?? 0,
-      
-      // Circunferências (com fallback para schema antigo)
-      arm_circ: toNumberOrUndefined(row.arm_circ ?? row.arm),
-      chest_circ: toNumberOrUndefined(row.chest_circ ?? row.chest),
-      waist_circ: toNumberOrUndefined(row.waist_circ ?? row.waist),
-      hip_circ: toNumberOrUndefined(row.hip_circ ?? row.hip),
-      thigh_circ: toNumberOrUndefined(row.thigh_circ ?? row.thigh),
-      calf_circ: toNumberOrUndefined(row.calf_circ ?? row.calf),
-
-      // Dobras (com fallback para schema antigo)
-      triceps_skinfold: toNumberOrUndefined(row.triceps_skinfold ?? row.triceps),
-      biceps_skinfold: toNumberOrUndefined(row.biceps_skinfold ?? row.biceps),
-      subscapular_skinfold: toNumberOrUndefined(row.subscapular_skinfold ?? row.subscapular),
-      suprailiac_skinfold: toNumberOrUndefined(row.suprailiac_skinfold ?? row.suprailiac),
-      abdominal_skinfold: toNumberOrUndefined(row.abdominal_skinfold ?? row.abdominal),
-      thigh_skinfold: toNumberOrUndefined(row.thigh_skinfold ?? row.thigh_fold),
-      calf_skinfold: toNumberOrUndefined(row.calf_skinfold ?? row.calf_fold),
-
-      // Cálculos (com fallback)
-      body_fat_percentage: toNumberOrUndefined(row.body_fat_percentage ?? row.bf),
-      lean_mass: toNumberOrUndefined(row.lean_mass),
-      fat_mass: toNumberOrUndefined(row.fat_mass),
-      bmr: toNumberOrUndefined(row.bmr),
-      tdee: toNumberOrUndefined(row.tdee),
-      bmi: toNumberOrUndefined(row.bmi),
-    } as Assessment;
-  }, []);
-
-  const getAssessment = useCallback(async (id: string) => {
-    try {
-      setLoading(true);
-      setError(null);
-      const { data, error } = await supabase
-        .from('assessments')
-        .select('*')
-        .eq('id', id)
-        .single();
-
-      if (error) throw error;
-      return normalizeAssessmentRow(data);
-    } catch (e: any) {
-      console.error('Erro ao buscar avaliação:', e);
-      setError(e.message);
-      return null;
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, normalizeAssessmentRow]);
-
-  const getStudentAssessments = useCallback(async (studentId: string) => {
-    try {
-      setLoading(true);
-      setError(null);
-      
-      const resolvedId = await resolveStudentRecordId(studentId);
-      setCurrentStudentId(resolvedId);
-
-      const { data, error } = await supabase
-        .from('assessments')
-        .select('*')
-        .or(`student_id.eq.${resolvedId},user_id.eq.${resolvedId}`)
-        .order('assessment_date', { ascending: false });
-
-      if (error) throw error;
-      
-      const normalized = (data || []).map(normalizeAssessmentRow);
-      setAssessments(normalized);
-      return normalized;
-    } catch (e: any) {
-      console.error('Erro ao buscar avaliações do aluno:', e);
-      setError(e.message);
-      return [];
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, resolveStudentRecordId, normalizeAssessmentRow]);
-
-  const refreshAssessments = useCallback(async () => {
-    if (currentStudentId) {
-      await getStudentAssessments(currentStudentId);
-    }
-  }, [currentStudentId, getStudentAssessments]);
-
-  const formDataToAssessment = useCallback((data: AssessmentFormData, studentId: string): CreateAssessmentRequest => {
-    // Converter valores
-    const weight = parseNumberInput(data.weight) || 0;
-    const height = parseNumberInput(data.height) || 0;
-    const age = parseInt(data.age) || 0;
-    const gender = data.gender;
-
-    // Dobras
-    const triceps = parseNumberInput(data.triceps_skinfold);
-    const biceps = parseNumberInput(data.biceps_skinfold);
-    const subscapular = parseNumberInput(data.subscapular_skinfold);
-    const suprailiac = parseNumberInput(data.suprailiac_skinfold);
-    const abdominal = parseNumberInput(data.abdominal_skinfold);
-    const thigh = parseNumberInput(data.thigh_skinfold);
-    const calf = parseNumberInput(data.calf_skinfold);
-
-    // Calcular métricas
-    const sumSkinfolds = calculateSumSkinfolds({
-      triceps_skinfold: triceps ?? undefined,
-      biceps_skinfold: biceps ?? undefined,
-      subscapular_skinfold: subscapular ?? undefined,
-      suprailiac_skinfold: suprailiac ?? undefined,
-      abdominal_skinfold: abdominal ?? undefined,
-      thigh_skinfold: thigh ?? undefined,
-      calf_skinfold: calf ?? undefined,
-    });
-
-    const bodyDensity = calculateBodyDensity(sumSkinfolds, age, gender);
-    const bodyFat = calculateBodyFatPercentage(bodyDensity);
-    const fatMass = calculateFatMass(weight, bodyFat);
-    const leanMass = calculateLeanMass(weight, fatMass);
-    const bmi = calculateBMI(weight, height);
-    const bmr = calculateBMR(weight, height, age, gender);
-
-    return {
-      student_id: studentId,
-      trainer_id: user?.id, // Será preenchido pelo hook ou backend
-      assessment_date: data.assessment_date,
-      weight,
-      height,
-      age,
-      gender,
-      
-      // Circunferências
-      arm_circ: parseNumberInput(data.arm_circ) ?? undefined,
-      chest_circ: parseNumberInput(data.chest_circ) ?? undefined,
-      waist_circ: parseNumberInput(data.waist_circ) ?? undefined,
-      hip_circ: parseNumberInput(data.hip_circ) ?? undefined,
-      thigh_circ: parseNumberInput(data.thigh_circ) ?? undefined,
-      calf_circ: parseNumberInput(data.calf_circ) ?? undefined,
-
-      // Dobras
-      triceps_skinfold: triceps ?? undefined,
-      biceps_skinfold: biceps ?? undefined,
-      subscapular_skinfold: subscapular ?? undefined,
-      suprailiac_skinfold: suprailiac ?? undefined,
-      abdominal_skinfold: abdominal ?? undefined,
-      thigh_skinfold: thigh ?? undefined,
-      calf_skinfold: calf ?? undefined,
-
-      // Calculados
-      body_fat_percentage: bodyFat,
-      lean_mass: leanMass,
-      fat_mass: fatMass,
-      bmi,
-      bmr,
-      
-      observations: data.observations
-    };
-  }, [user?.id]);
-
-  const createAssessment = useCallback(async (data: AssessmentFormData, studentId: string): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      if (!user?.id) throw new Error('Usuário não autenticado');
-
-      const resolvedStudentId = await resolveStudentRecordId(studentId);
-      const payload = formDataToAssessment(data, resolvedStudentId);
-      
-      // Garantir trainer_id
-      payload.trainer_id = user.id;
-
-      const { data: newAssessment, error: insertError } = await supabase
-        .from('assessments')
-        .insert(payload)
-        .select()
-        .single();
-
-      if (insertError) throw insertError;
-
-      const normalized = normalizeAssessmentRow(newAssessment);
-      setAssessments(prev => [normalized, ...prev]);
-      
-      return { success: true, data: normalized };
-    } catch (e: any) {
-      console.error('Erro ao criar avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, user?.id, resolveStudentRecordId, formDataToAssessment, normalizeAssessmentRow]);
-
-  const updateAssessment = useCallback(async (id: string, data: UpdateAssessmentRequest): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      const { data: updated, error: updateError } = await supabase
-        .from('assessments')
-        .update(data)
-        .eq('id', id)
-        .select()
-        .single();
-
-      if (updateError) throw updateError;
-
-      const normalized = normalizeAssessmentRow(updated);
-      setAssessments(prev => prev.map(a => a.id === id ? normalized : a));
-
-      return { success: true, data: normalized };
-    } catch (e: any) {
-      console.error('Erro ao atualizar avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, normalizeAssessmentRow]);
-
-  const deleteAssessment = useCallback(async (id: string): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      const { error: deleteError } = await supabase
-        .from('assessments')
-        .delete()
-        .eq('id', id);
-
-      if (deleteError) throw deleteError;
-
-      setAssessments(prev => prev.filter(a => a.id !== id));
-
-      return { success: true };
-    } catch (e: any) {
-      console.error('Erro ao excluir avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase]);
-
-  return {
-    assessments,
-    loading,
-    error,
-    createAssessment,
-    updateAssessment,
-    deleteAssessment,
-    getAssessment,
-    getStudentAssessments,
-    refreshAssessments,
-    clearError,
-    formDataToAssessment
-  };
-};
diff --git a/_archive/duplicates/src/lib/offline/_probe 3.txt b/_archive/duplicates/src/lib/offline/_probe 3.txt
deleted file mode 100644
index eca61d3..0000000
--- a/_archive/duplicates/src/lib/offline/_probe 3.txt	
+++ /dev/null
@@ -1,2 +0,0 @@
-probe
-
diff --git a/_archive/duplicates/src/lib/offline/idb 2.js b/_archive/duplicates/src/lib/offline/idb 2.js
deleted file mode 100644
index 9a7c085..0000000
--- a/_archive/duplicates/src/lib/offline/idb 2.js	
+++ /dev/null
@@ -1,143 +0,0 @@
-const DB_NAME = 'irontracks'
-const DB_VERSION = 1
-const STORE_KV = 'kv'
-const STORE_QUEUE = 'queue'
-
-const hasIndexedDb = () => {
-  try {
-    return typeof indexedDB !== 'undefined'
-  } catch {
-    return false
-  }
-}
-
-const openDb = () =>
-  new Promise((resolve, reject) => {
-    try {
-      const req = indexedDB.open(DB_NAME, DB_VERSION)
-      req.onupgradeneeded = () => {
-        const db = req.result
-        if (!db.objectStoreNames.contains(STORE_KV)) db.createObjectStore(STORE_KV)
-        if (!db.objectStoreNames.contains(STORE_QUEUE)) db.createObjectStore(STORE_QUEUE, { keyPath: 'id' })
-      }
-      req.onsuccess = () => resolve(req.result)
-      req.onerror = () => reject(req.error)
-    } catch (e) {
-      reject(e)
-    }
-  })
-
-const txDone = (tx) =>
-  new Promise((resolve, reject) => {
-    tx.oncomplete = () => resolve(null)
-    tx.onabort = () => reject(tx.error)
-    tx.onerror = () => reject(tx.error)
-  })
-
-export const kvGet = async (key) => {
-  const k = String(key || '')
-  if (!k) return null
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem(`it.kv.${k}`) || ''
-      return raw ? JSON.parse(raw) : null
-    } catch {
-      return null
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_KV, 'readonly')
-  const store = tx.objectStore(STORE_KV)
-  const req = store.get(k)
-  const val = await new Promise((resolve) => {
-    req.onsuccess = () => resolve(req.result ?? null)
-    req.onerror = () => resolve(null)
-  })
-  await txDone(tx).catch(() => null)
-  return val
-}
-
-export const kvSet = async (key, value) => {
-  const k = String(key || '')
-  if (!k) return false
-  if (!hasIndexedDb()) {
-    try {
-      window.localStorage.setItem(`it.kv.${k}`, JSON.stringify(value ?? null))
-      return true
-    } catch {
-      return false
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_KV, 'readwrite')
-  tx.objectStore(STORE_KV).put(value ?? null, k)
-  await txDone(tx).catch(() => null)
-  return true
-}
-
-export const queuePut = async (job) => {
-  const j = job && typeof job === 'object' ? job : null
-  const id = String(j?.id || '').trim()
-  if (!id) return false
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem('it.queue.v1') || '[]'
-      const list = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []
-      const next = list.filter((x) => String(x?.id || '') !== id)
-      next.push(j)
-      window.localStorage.setItem('it.queue.v1', JSON.stringify(next))
-      return true
-    } catch {
-      return false
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_QUEUE, 'readwrite')
-  tx.objectStore(STORE_QUEUE).put(j)
-  await txDone(tx).catch(() => null)
-  return true
-}
-
-export const queueDelete = async (id) => {
-  const key = String(id || '').trim()
-  if (!key) return false
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem('it.queue.v1') || '[]'
-      const list = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []
-      const next = list.filter((x) => String(x?.id || '') !== key)
-      window.localStorage.setItem('it.queue.v1', JSON.stringify(next))
-      return true
-    } catch {
-      return false
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_QUEUE, 'readwrite')
-  tx.objectStore(STORE_QUEUE).delete(key)
-  await txDone(tx).catch(() => null)
-  return true
-}
-
-export const queueGetAll = async () => {
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem('it.queue.v1') || '[]'
-      const list = JSON.parse(raw)
-      return Array.isArray(list) ? list : []
-    } catch {
-      return []
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_QUEUE, 'readonly')
-  const store = tx.objectStore(STORE_QUEUE)
-  const req = store.getAll()
-  const list = await new Promise((resolve) => {
-    req.onsuccess = () => resolve(Array.isArray(req.result) ? req.result : [])
-    req.onerror = () => resolve([])
-  })
-  await txDone(tx).catch(() => null)
-  return list
-}
-
diff --git a/_archive/duplicates/src/lib/offline/idb 3.js b/_archive/duplicates/src/lib/offline/idb 3.js
deleted file mode 100644
index 9a7c085..0000000
--- a/_archive/duplicates/src/lib/offline/idb 3.js	
+++ /dev/null
@@ -1,143 +0,0 @@
-const DB_NAME = 'irontracks'
-const DB_VERSION = 1
-const STORE_KV = 'kv'
-const STORE_QUEUE = 'queue'
-
-const hasIndexedDb = () => {
-  try {
-    return typeof indexedDB !== 'undefined'
-  } catch {
-    return false
-  }
-}
-
-const openDb = () =>
-  new Promise((resolve, reject) => {
-    try {
-      const req = indexedDB.open(DB_NAME, DB_VERSION)
-      req.onupgradeneeded = () => {
-        const db = req.result
-        if (!db.objectStoreNames.contains(STORE_KV)) db.createObjectStore(STORE_KV)
-        if (!db.objectStoreNames.contains(STORE_QUEUE)) db.createObjectStore(STORE_QUEUE, { keyPath: 'id' })
-      }
-      req.onsuccess = () => resolve(req.result)
-      req.onerror = () => reject(req.error)
-    } catch (e) {
-      reject(e)
-    }
-  })
-
-const txDone = (tx) =>
-  new Promise((resolve, reject) => {
-    tx.oncomplete = () => resolve(null)
-    tx.onabort = () => reject(tx.error)
-    tx.onerror = () => reject(tx.error)
-  })
-
-export const kvGet = async (key) => {
-  const k = String(key || '')
-  if (!k) return null
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem(`it.kv.${k}`) || ''
-      return raw ? JSON.parse(raw) : null
-    } catch {
-      return null
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_KV, 'readonly')
-  const store = tx.objectStore(STORE_KV)
-  const req = store.get(k)
-  const val = await new Promise((resolve) => {
-    req.onsuccess = () => resolve(req.result ?? null)
-    req.onerror = () => resolve(null)
-  })
-  await txDone(tx).catch(() => null)
-  return val
-}
-
-export const kvSet = async (key, value) => {
-  const k = String(key || '')
-  if (!k) return false
-  if (!hasIndexedDb()) {
-    try {
-      window.localStorage.setItem(`it.kv.${k}`, JSON.stringify(value ?? null))
-      return true
-    } catch {
-      return false
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_KV, 'readwrite')
-  tx.objectStore(STORE_KV).put(value ?? null, k)
-  await txDone(tx).catch(() => null)
-  return true
-}
-
-export const queuePut = async (job) => {
-  const j = job && typeof job === 'object' ? job : null
-  const id = String(j?.id || '').trim()
-  if (!id) return false
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem('it.queue.v1') || '[]'
-      const list = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []
-      const next = list.filter((x) => String(x?.id || '') !== id)
-      next.push(j)
-      window.localStorage.setItem('it.queue.v1', JSON.stringify(next))
-      return true
-    } catch {
-      return false
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_QUEUE, 'readwrite')
-  tx.objectStore(STORE_QUEUE).put(j)
-  await txDone(tx).catch(() => null)
-  return true
-}
-
-export const queueDelete = async (id) => {
-  const key = String(id || '').trim()
-  if (!key) return false
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem('it.queue.v1') || '[]'
-      const list = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []
-      const next = list.filter((x) => String(x?.id || '') !== key)
-      window.localStorage.setItem('it.queue.v1', JSON.stringify(next))
-      return true
-    } catch {
-      return false
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_QUEUE, 'readwrite')
-  tx.objectStore(STORE_QUEUE).delete(key)
-  await txDone(tx).catch(() => null)
-  return true
-}
-
-export const queueGetAll = async () => {
-  if (!hasIndexedDb()) {
-    try {
-      const raw = window.localStorage.getItem('it.queue.v1') || '[]'
-      const list = JSON.parse(raw)
-      return Array.isArray(list) ? list : []
-    } catch {
-      return []
-    }
-  }
-  const db = await openDb()
-  const tx = db.transaction(STORE_QUEUE, 'readonly')
-  const store = tx.objectStore(STORE_QUEUE)
-  const req = store.getAll()
-  const list = await new Promise((resolve) => {
-    req.onsuccess = () => resolve(Array.isArray(req.result) ? req.result : [])
-    req.onerror = () => resolve([])
-  })
-  await txDone(tx).catch(() => null)
-  return list
-}
-
diff --git a/_archive/duplicates/src/lib/offline/offlineSync 3.js b/_archive/duplicates/src/lib/offline/offlineSync 3.js
deleted file mode 100644
index 3b79b53..0000000
--- a/_archive/duplicates/src/lib/offline/offlineSync 3.js	
+++ /dev/null
@@ -1,180 +0,0 @@
-import { kvGet, kvSet, queuePut, queueGetAll, queueDelete } from './idb';
-
-const CACHE_KEY_WORKOUTS = 'offline_workouts_cache';
-
-export const isOnline = () => {
-  return typeof navigator !== 'undefined' && navigator.onLine;
-};
-
-export const cacheSetWorkouts = async (workouts) => {
-  try {
-    await kvSet(CACHE_KEY_WORKOUTS, workouts);
-  } catch (e) {
-    console.error('Cache set failed', e);
-  }
-};
-
-export const cacheGetWorkouts = async () => {
-  try {
-    return await kvGet(CACHE_KEY_WORKOUTS);
-  } catch (e) {
-    return null;
-  }
-};
-
-export const getPendingCount = async () => {
-  try {
-    const all = await queueGetAll();
-    return Array.isArray(all) ? all.length : 0;
-  } catch (e) {
-    return 0;
-  }
-};
-
-export const getOfflineQueueSummary = async ({ userId } = {}) => {
-  try {
-    const all = await queueGetAll();
-    const jobs = Array.isArray(all) ? all : [];
-    
-    // Calculate stats
-    const now = Date.now();
-    const pending = jobs.filter(j => (j.status || 'pending') === 'pending').length;
-    const failed = jobs.filter(j => j.status === 'failed').length;
-    const due = jobs.filter(j => !j.nextAttemptAt || j.nextAttemptAt <= now).length;
-    
-    // Find next due
-    const future = jobs.filter(j => j.nextAttemptAt && j.nextAttemptAt > now).sort((a, b) => a.nextAttemptAt - b.nextAttemptAt);
-    const nextDueAt = future.length > 0 ? future[0].nextAttemptAt : null;
-
-    return {
-      ok: true,
-      online: isOnline(),
-      pending,
-      failed,
-      due,
-      nextDueAt,
-      jobs
-    };
-  } catch (e) {
-    return { ok: false, online: isOnline(), jobs: [] };
-  }
-};
-
-export const clearOfflineJobs = async ({ userId } = {}) => {
-    try {
-        const all = await queueGetAll();
-        if (Array.isArray(all)) {
-            for (const job of all) {
-                await queueDelete(job.id);
-            }
-        }
-        return { ok: true };
-    } catch (e) {
-        return { ok: false, error: e };
-    }
-};
-
-export const bumpOfflineJob = async ({ id }) => {
-    try {
-        const all = await queueGetAll();
-        const job = all.find(j => j.id === id);
-        if (job) {
-            job.nextAttemptAt = 0;
-            job.attempts = 0;
-            job.status = 'pending';
-            await queuePut(job);
-        }
-    } catch (e) {
-        console.error('Bump failed', e);
-    }
-};
-
-export const flushOfflineQueue = async ({ max = 50, force = false } = {}) => {
-  if (!isOnline() && !force) return { processed: 0, errors: 0 };
-
-  let all = [];
-  try {
-    all = await queueGetAll();
-  } catch (e) {
-    return { processed: 0, errors: 0 };
-  }
-
-  if (!Array.isArray(all) || all.length === 0) return { processed: 0, errors: 0 };
-
-  let processed = 0;
-  let errors = 0;
-  const now = Date.now();
-
-  for (const job of all) {
-    // Check eligibility
-    if (!force) {
-        if (job.nextAttemptAt && job.nextAttemptAt > now) continue;
-        if (job.status === 'failed' && !force) continue; 
-    }
-
-    try {
-      if (job.type === 'finish_workout') {
-        await processFinishWorkout(job);
-      }
-      // Success
-      await queueDelete(job.id);
-      processed++;
-    } catch (err) {
-      console.error('Failed to process offline job:', job, err);
-      errors++;
-      
-      // Update job with failure info
-      job.attempts = (job.attempts || 0) + 1;
-      job.lastError = String(err?.message || err);
-      job.nextAttemptAt = now + (1000 * 60 * Math.pow(2, job.attempts)); // Exponential backoff
-      
-      if (job.attempts >= (job.maxAttempts || 7)) {
-          job.status = 'failed';
-      } else {
-          job.status = 'pending'; 
-      }
-      await queuePut(job);
-    }
-  }
-
-  return { processed, errors };
-};
-
-export const queueFinishWorkout = async (payload) => {
-  const id = `finish_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
-  const job = {
-    id,
-    type: 'finish_workout',
-    createdAt: new Date().toISOString(),
-    payload,
-    details: payload.workoutTitle || 'Treino Finalizado',
-    status: 'pending',
-    attempts: 0,
-    maxAttempts: 10,
-    nextAttemptAt: 0 
-  };
-  await queuePut(job);
-  return id;
-};
-
-async function processFinishWorkout(job) {
-  const { payload } = job;
-  
-  const response = await fetch('/api/workouts/finish', {
-    method: 'POST',
-    headers: {
-      'Content-Type': 'application/json',
-    },
-    body: JSON.stringify(payload),
-  });
-
-  if (!response.ok) {
-    const status = response.status;
-    if (status >= 400 && status < 500) {
-        const text = await response.text();
-        throw new Error(`Validation error (4xx): ${text}`); 
-    }
-    const errorText = await response.text();
-    throw new Error(`API error: ${response.status} - ${errorText}`);
-  }
-}
diff --git a/_archive/duplicates/src/lib/social/notifyFollowers 2.js b/_archive/duplicates/src/lib/social/notifyFollowers 2.js
deleted file mode 100644
index 5bbac5f..0000000
--- a/_archive/duplicates/src/lib/social/notifyFollowers 2.js	
+++ /dev/null
@@ -1,93 +0,0 @@
-import { createAdminClient } from '@/utils/supabase/admin'
-
-const chunk = (arr, size) => {
-  const out = []
-  const safe = Array.isArray(arr) ? arr : []
-  const n = Math.max(1, Number(size) || 1)
-  for (let i = 0; i < safe.length; i += n) out.push(safe.slice(i, i + n))
-  return out
-}
-
-export async function listFollowerIdsOf(userId) {
-  const uid = String(userId || '').trim()
-  if (!uid) return []
-  const admin = createAdminClient()
-  const { data } = await admin
-    .from('social_follows')
-    .select('follower_id')
-    .eq('following_id', uid)
-    .eq('status', 'accepted')
-    .limit(5000)
-  return (Array.isArray(data) ? data : [])
-    .map((r) => String(r?.follower_id || '').trim())
-    .filter(Boolean)
-}
-
-export async function filterRecipientsByPreference(recipientIds, preferenceKey) {
-  const key = String(preferenceKey || '').trim()
-  const ids = (Array.isArray(recipientIds) ? recipientIds : []).map((v) => String(v || '').trim()).filter(Boolean)
-  if (!key || ids.length === 0) return ids
-
-  const admin = createAdminClient()
-  const { data } = await admin.from('user_settings').select('user_id, preferences').in('user_id', ids)
-  const rows = Array.isArray(data) ? data : []
-  const byId = new Map(
-    rows.map((r) => [
-      String(r?.user_id || ''),
-      r?.preferences && typeof r.preferences === 'object' ? r.preferences : null,
-    ])
-  )
-
-  return ids.filter((id) => {
-    const prefs = byId.get(id) || null
-    if (!prefs) return true
-    const raw = prefs[key]
-    return raw !== false
-  })
-}
-
-export async function shouldThrottleBySenderType(senderId, type, windowMinutes) {
-  const sid = String(senderId || '').trim()
-  const t = String(type || '').trim()
-  const minutes = Math.max(1, Number(windowMinutes) || 15)
-  if (!sid || !t) return false
-  const admin = createAdminClient()
-  const since = new Date(Date.now() - minutes * 60 * 1000).toISOString()
-  const { data } = await admin.from('notifications').select('id').eq('type', t).eq('sender_id', sid).gte('created_at', since).limit(1)
-  return Array.isArray(data) && data.length > 0
-}
-
-export async function insertNotifications(rows) {
-  const admin = createAdminClient()
-  const safeRows = (Array.isArray(rows) ? rows : []).filter((r) => r && typeof r === 'object')
-  if (!safeRows.length) return { ok: true, inserted: 0 }
-
-  let inserted = 0
-  for (const part of chunk(safeRows, 500)) {
-    const { error } = await admin.from('notifications').insert(part)
-    if (error) {
-      const msg = String(error?.message ?? error)
-      const lower = msg.toLowerCase()
-      const schemaMismatch =
-        lower.includes('column') &&
-        (lower.includes('sender_id') ||
-          lower.includes('recipient_id') ||
-          lower.includes('metadata') ||
-          lower.includes('is_read'))
-      if (!schemaMismatch) return { ok: false, error: msg, inserted }
-
-      const fallback = part.map((r) => ({
-        user_id: r.user_id,
-        title: r.title,
-        message: r.message,
-        type: r.type,
-        read: r.read,
-      }))
-      const { error: fallbackError } = await admin.from('notifications').insert(fallback)
-      if (fallbackError) return { ok: false, error: String(fallbackError?.message ?? fallbackError), inserted }
-    }
-    inserted += part.length
-  }
-  return { ok: true, inserted }
-}
-
diff --git a/_archive/duplicates/src/lib/social/notifyFollowers 3.js b/_archive/duplicates/src/lib/social/notifyFollowers 3.js
deleted file mode 100644
index 5bbac5f..0000000
--- a/_archive/duplicates/src/lib/social/notifyFollowers 3.js	
+++ /dev/null
@@ -1,93 +0,0 @@
-import { createAdminClient } from '@/utils/supabase/admin'
-
-const chunk = (arr, size) => {
-  const out = []
-  const safe = Array.isArray(arr) ? arr : []
-  const n = Math.max(1, Number(size) || 1)
-  for (let i = 0; i < safe.length; i += n) out.push(safe.slice(i, i + n))
-  return out
-}
-
-export async function listFollowerIdsOf(userId) {
-  const uid = String(userId || '').trim()
-  if (!uid) return []
-  const admin = createAdminClient()
-  const { data } = await admin
-    .from('social_follows')
-    .select('follower_id')
-    .eq('following_id', uid)
-    .eq('status', 'accepted')
-    .limit(5000)
-  return (Array.isArray(data) ? data : [])
-    .map((r) => String(r?.follower_id || '').trim())
-    .filter(Boolean)
-}
-
-export async function filterRecipientsByPreference(recipientIds, preferenceKey) {
-  const key = String(preferenceKey || '').trim()
-  const ids = (Array.isArray(recipientIds) ? recipientIds : []).map((v) => String(v || '').trim()).filter(Boolean)
-  if (!key || ids.length === 0) return ids
-
-  const admin = createAdminClient()
-  const { data } = await admin.from('user_settings').select('user_id, preferences').in('user_id', ids)
-  const rows = Array.isArray(data) ? data : []
-  const byId = new Map(
-    rows.map((r) => [
-      String(r?.user_id || ''),
-      r?.preferences && typeof r.preferences === 'object' ? r.preferences : null,
-    ])
-  )
-
-  return ids.filter((id) => {
-    const prefs = byId.get(id) || null
-    if (!prefs) return true
-    const raw = prefs[key]
-    return raw !== false
-  })
-}
-
-export async function shouldThrottleBySenderType(senderId, type, windowMinutes) {
-  const sid = String(senderId || '').trim()
-  const t = String(type || '').trim()
-  const minutes = Math.max(1, Number(windowMinutes) || 15)
-  if (!sid || !t) return false
-  const admin = createAdminClient()
-  const since = new Date(Date.now() - minutes * 60 * 1000).toISOString()
-  const { data } = await admin.from('notifications').select('id').eq('type', t).eq('sender_id', sid).gte('created_at', since).limit(1)
-  return Array.isArray(data) && data.length > 0
-}
-
-export async function insertNotifications(rows) {
-  const admin = createAdminClient()
-  const safeRows = (Array.isArray(rows) ? rows : []).filter((r) => r && typeof r === 'object')
-  if (!safeRows.length) return { ok: true, inserted: 0 }
-
-  let inserted = 0
-  for (const part of chunk(safeRows, 500)) {
-    const { error } = await admin.from('notifications').insert(part)
-    if (error) {
-      const msg = String(error?.message ?? error)
-      const lower = msg.toLowerCase()
-      const schemaMismatch =
-        lower.includes('column') &&
-        (lower.includes('sender_id') ||
-          lower.includes('recipient_id') ||
-          lower.includes('metadata') ||
-          lower.includes('is_read'))
-      if (!schemaMismatch) return { ok: false, error: msg, inserted }
-
-      const fallback = part.map((r) => ({
-        user_id: r.user_id,
-        title: r.title,
-        message: r.message,
-        type: r.type,
-        read: r.read,
-      }))
-      const { error: fallbackError } = await admin.from('notifications').insert(fallback)
-      if (fallbackError) return { ok: false, error: String(fallbackError?.message ?? fallbackError), inserted }
-    }
-    inserted += part.length
-  }
-  return { ok: true, inserted }
-}
-
diff --git a/_archive/duplicates/src/lib/social/storyValidation 2.ts b/_archive/duplicates/src/lib/social/storyValidation 2.ts
deleted file mode 100644
index 1829168..0000000
--- a/_archive/duplicates/src/lib/social/storyValidation 2.ts	
+++ /dev/null
@@ -1,32 +0,0 @@
-
-export const isAllowedStoryPath = (userId: string, path: string) => {
-  const uid = String(userId || '').trim()
-  const p = String(path || '').trim()
-  if (!uid || !p) return false
-  if (p.includes('..') || p.includes('\\') || p.includes('\0') || p.startsWith('/')) return false
-  const parts = p.split('/').filter(Boolean)
-  if (parts.length < 3) return false
-  if (parts[0] !== uid) return false
-  if (parts[1] !== 'stories') return false
-  const name = parts.slice(2).join('/')
-  if (
-    !name.endsWith('.jpg') &&
-    !name.endsWith('.jpeg') &&
-    !name.endsWith('.png') &&
-    !name.endsWith('.mp4') &&
-    !name.endsWith('.mov') &&
-    !name.endsWith('.webm')
-  )
-    return false
-  return true
-}
-
-export const validateStoryPayload = (body: any) => {
-  const mediaPath = String(body?.mediaPath || body?.media_path || '').trim()
-  const caption = body?.caption != null ? String(body.caption).trim() : null
-  const meta = body?.meta && typeof body.meta === 'object' ? body.meta : {}
-
-  if (!mediaPath) return { ok: false, error: 'media_path required' }
-  
-  return { ok: true, data: { mediaPath, caption, meta } }
-}
diff --git a/_archive/duplicates/src/lib/video/VideoCompositor 2.ts b/_archive/duplicates/src/lib/video/VideoCompositor 2.ts
deleted file mode 100644
index 22359b8..0000000
--- a/_archive/duplicates/src/lib/video/VideoCompositor 2.ts	
+++ /dev/null
@@ -1,394 +0,0 @@
-/**
- * VideoCompositor.ts
- * Motor universal de composição e exportação de vídeo para o IronTracks.
- * Garante sincronia frame-a-frame, áudio mixado via Web Audio API e compatibilidade cross-platform.
- */
-
-interface RenderOptions {
-    videoElement: HTMLVideoElement;
-    trimRange: [number, number];
-    onDrawFrame: (ctx: CanvasRenderingContext2D, video: HTMLVideoElement) => void;
-    onProgress?: (progress: number) => void;
-    outputWidth?: number;
-    outputHeight?: number;
-    fps?: number;
-    mimeTypeOverride?: string;
-    videoBitsPerSecond?: number;
-    audioBitsPerSecond?: number;
-}
-
-interface ExportResult {
-    blob: Blob;
-    filename: string;
-    mime: string;
-    duration: number;
-}
-
-export class VideoCompositor {
-    private ctx: CanvasRenderingContext2D | null = null;
-    private canvas: HTMLCanvasElement | null = null;
-    private audioCtx: AudioContext | null = null;
-    private destNode: MediaStreamAudioDestinationNode | null = null;
-    private sourceNode: MediaElementAudioSourceNode | null = null;
-    private recorder: MediaRecorder | null = null;
-    private isCancelled = false;
-    private manualTimer: number | null = null;
-
-    constructor() {
-        if (typeof window !== 'undefined') {
-            this.canvas = document.createElement('canvas');
-            // Desynchronized pode melhorar performance, alpha: false remove transparência desnecessária
-            this.ctx = this.canvas.getContext('2d', { alpha: false, desynchronized: true });
-        }
-    }
-
-    public cancel() {
-        this.isCancelled = true;
-        this.cleanup();
-    }
-
-    private cleanup() {
-        if (this.manualTimer) {
-            try { clearTimeout(this.manualTimer); } catch {}
-        }
-        this.manualTimer = null;
-        if (this.sourceNode) {
-            try { this.sourceNode.disconnect(); } catch {}
-        }
-        if (this.destNode) {
-            try { this.destNode.disconnect(); } catch {}
-        }
-        if (this.audioCtx) {
-            try { this.audioCtx.close(); } catch {}
-        }
-        if (this.recorder && this.recorder.state !== 'inactive') {
-            try { this.recorder.stop(); } catch {}
-        }
-        this.sourceNode = null;
-        this.destNode = null;
-        this.audioCtx = null;
-        this.recorder = null;
-    }
-
-    private async assembleBlob(chunks: Blob[], mimeType: string): Promise<Blob> {
-        try {
-            const safeChunks = Array.isArray(chunks) ? chunks : [];
-            if (typeof Worker === 'undefined' || safeChunks.length === 0) {
-                return new Blob(safeChunks, { type: mimeType });
-            }
-            const workerCode = `self.onmessage=(e)=>{try{const d=e.data||{};const list=Array.isArray(d.chunks)?d.chunks:[];const blob=new Blob(list,{type:d.type||''});self.postMessage({ok:true,blob});}catch(err){self.postMessage({ok:false,error:String(err&&err.message?err.message:err)});}};`;
-            const url = URL.createObjectURL(new Blob([workerCode], { type: 'application/javascript' }));
-            const worker = new Worker(url);
-            try { URL.revokeObjectURL(url); } catch {}
-            return await new Promise<Blob>((resolve) => {
-                let settled = false;
-                const done = (blob: Blob) => {
-                    if (settled) return;
-                    settled = true;
-                    try { worker.terminate(); } catch {}
-                    resolve(blob);
-                };
-                const fallback = () => done(new Blob(safeChunks, { type: mimeType }));
-                const timer = setTimeout(() => fallback(), 3000);
-                worker.onmessage = (ev) => {
-                    try { clearTimeout(timer); } catch {}
-                    const data = ev?.data || {};
-                    if (data?.ok && data?.blob) {
-                        done(data.blob);
-                        return;
-                    }
-                    fallback();
-                };
-                worker.onerror = () => {
-                    try { clearTimeout(timer); } catch {}
-                    fallback();
-                };
-                try {
-                    worker.postMessage({ chunks: safeChunks, type: mimeType });
-                } catch {
-                    try { clearTimeout(timer); } catch {}
-                    fallback();
-                }
-            });
-        } catch {
-            return new Blob(Array.isArray(chunks) ? chunks : [], { type: mimeType });
-        }
-    }
-
-    /**
-     * Detecta o melhor formato suportado pelo navegador
-     */
-    private getBestMimeType(): string {
-        const ua = navigator.userAgent;
-        const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
-        const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
-
-        // Ordem de preferência: H.264 (MP4) > VP9 (WebM) > VP8 (WebM)
-        const candidates = [
-            'video/mp4;codecs="avc1.42E01E,mp4a.40.2"', // H.264 Main Profile
-            'video/mp4;codecs=avc1.42E01E,mp4a.40.2',
-            'video/mp4',
-            'video/webm;codecs=vp9,opus',
-            'video/webm;codecs=vp8,opus',
-            'video/webm'
-        ];
-
-        // No iOS/Safari, forçamos a verificação estrita de MP4 primeiro
-        if (isIOS || isSafari) {
-            const mp4 = candidates.find(c => MediaRecorder.isTypeSupported(c));
-            if (mp4) return mp4;
-        }
-
-        for (const type of candidates) {
-            if (MediaRecorder.isTypeSupported(type)) {
-                return type;
-            }
-        }
-        
-        throw new Error('Nenhum formato de vídeo suportado encontrado neste navegador.');
-    }
-
-    /**
-     * Renderiza o vídeo frame a frame garantindo sincronia
-     */
-    public async render({
-        videoElement,
-        trimRange,
-        onDrawFrame,
-        onProgress,
-        outputWidth = 1080,
-        outputHeight = 1920,
-        fps = 30,
-        mimeTypeOverride,
-        videoBitsPerSecond: userVideoBps,
-        audioBitsPerSecond: userAudioBps
-    }: RenderOptions): Promise<ExportResult> {
-        this.isCancelled = false;
-        
-        if (!this.canvas || !this.ctx) throw new Error('Canvas context not initialized');
-        
-        // 1. Setup Canvas
-        this.canvas.width = outputWidth;
-        this.canvas.height = outputHeight;
-
-        // 2. Setup Audio (Web Audio API para mixagem robusta)
-        // Necessário user gesture prévio para AudioContext em alguns browsers, mas aqui já estamos num fluxo iniciado pelo user
-        this.audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
-        this.destNode = this.audioCtx.createMediaStreamDestination();
-        
-        // Conecta o vídeo ao destino de gravação
-        try {
-            this.sourceNode = this.audioCtx.createMediaElementSource(videoElement);
-            this.sourceNode.connect(this.destNode);
-            // Também conecta ao destino padrão (speakers) se quisermos ouvir durante o processo? 
-            // Melhor não, para não dar eco. O vídeo será mutado visualmente mas processado internamente.
-        } catch (e) {
-            console.warn('Falha ao conectar áudio via Web Audio API, tentando fallback simples', e);
-            // Fallback: tentar capturar stream direto do vídeo se possível, ou prosseguir mudo
-        }
-
-        // 3. Preparar Stream de Saída
-        const canvasStream = this.canvas.captureStream(fps);
-        if (this.destNode) {
-            const audioTracks = this.destNode.stream.getAudioTracks();
-            if (audioTracks.length > 0) {
-                canvasStream.addTrack(audioTracks[0]);
-            }
-        } else {
-            // Tenta pegar direto do vídeo se Web Audio falhou
-            // @ts-ignore
-            const vidStream = videoElement.captureStream ? videoElement.captureStream() : videoElement.mozCaptureStream ? videoElement.mozCaptureStream() : null;
-            if (vidStream) {
-                const audioTracks = vidStream.getAudioTracks();
-                if (audioTracks.length > 0) canvasStream.addTrack(audioTracks[0]);
-            }
-        }
-
-        // 4. Setup Gravador
-        let mimeType = this.getBestMimeType();
-        if (mimeTypeOverride) {
-            try {
-                if (MediaRecorder.isTypeSupported(mimeTypeOverride)) {
-                    mimeType = mimeTypeOverride;
-                }
-            } catch {}
-        }
-        const videoBitsPerSecond = typeof userVideoBps === 'number' && userVideoBps > 0 ? userVideoBps : 5_000_000;
-        const audioBitsPerSecond = typeof userAudioBps === 'number' && userAudioBps > 0 ? userAudioBps : 128_000;
-        
-        try {
-            this.recorder = new MediaRecorder(canvasStream, {
-                mimeType,
-                videoBitsPerSecond,
-                audioBitsPerSecond
-            });
-        } catch (e) {
-            console.warn('Bitrate control not supported, using defaults', e);
-            this.recorder = new MediaRecorder(canvasStream, { mimeType });
-        }
-
-        const chunks: Blob[] = [];
-        this.recorder.ondataavailable = (e) => {
-            if (e.data && e.data.size > 0) chunks.push(e.data);
-        };
-
-        // Promise que resolve quando a gravação termina
-        const recordingPromise = new Promise<ExportResult>((resolve, reject) => {
-            if (!this.recorder) return reject(new Error('Recorder not initialized'));
-
-            this.recorder.onstop = async () => {
-                if (this.isCancelled) {
-                    reject(new Error('Renderização cancelada'));
-                    return;
-                }
-                try {
-                    const blob = await this.assembleBlob(chunks, mimeType);
-                    const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
-                    resolve({
-                        blob,
-                        filename: `story-${Date.now()}.${ext}`,
-                        mime: mimeType,
-                        duration: (trimRange[1] - trimRange[0])
-                    });
-                } catch (e) {
-                    reject(e);
-                }
-            };
-            this.recorder.onerror = (e) => reject(e);
-        });
-
-        // 5. Loop de Renderização Síncrona
-        // Salvar estado original do vídeo
-        const originalMuted = videoElement.muted;
-        const originalCurrentTime = videoElement.currentTime;
-        const originalVolume = videoElement.volume;
-        const originalLoop = videoElement.loop;
-
-        // Preparar vídeo
-        videoElement.muted = false; // Necessário para o AudioContext capturar (mas não sai som se não conectar ao destination)
-        videoElement.volume = 1.0;
-        videoElement.loop = false;
-        videoElement.currentTime = trimRange[0];
-
-        // Aguardar seek
-        await new Promise<void>(resolve => {
-            const onSeek = () => {
-                videoElement.removeEventListener('seeked', onSeek);
-                resolve();
-            };
-            videoElement.addEventListener('seeked', onSeek);
-            // Fallback se já estiver pronto
-            if (videoElement.readyState >= 2 && !videoElement.seeking) {
-                videoElement.removeEventListener('seeked', onSeek);
-                resolve();
-            }
-        });
-
-        // Iniciar gravação com timeslice para melhor gerenciamento de memória
-        this.recorder.start(1000); // 1 segundo chunks
-        try {
-            await videoElement.play();
-        } catch (e) {
-            try {
-                if (this.recorder && this.recorder.state === 'recording') this.recorder.stop();
-            } catch {}
-            throw e;
-        }
-
-        // Loop principal
-        const duration = trimRange[1] - trimRange[0];
-        
-        const useManualFps = !(videoElement as any)?.requestVideoFrameCallback;
-        const frameIntervalMs = fps > 0 ? (1000 / fps) : 33.3333333333;
-        let lastManualTs = 0;
-
-        const processFrame = () => {
-            if (this.isCancelled) return;
-
-            // Checar fim
-            if (videoElement.ended || videoElement.currentTime >= trimRange[1]) {
-                if (this.recorder && this.recorder.state === 'recording') {
-                    this.recorder.stop();
-                }
-                return;
-            }
-
-            // Desenhar frame
-            if (this.ctx) {
-                onDrawFrame(this.ctx, videoElement);
-            }
-
-            // Atualizar progresso
-            if (onProgress) {
-                const current = Math.max(0, videoElement.currentTime - trimRange[0]);
-                onProgress(Math.min(1, current / duration));
-            }
-
-            // Próximo frame
-            // @ts-ignore
-            if (videoElement.requestVideoFrameCallback) {
-                // @ts-ignore
-                videoElement.requestVideoFrameCallback(processFrame);
-            } else {
-                requestAnimationFrame(processFrame);
-            }
-        };
-
-        const processFrameManual = () => {
-            if (this.isCancelled) return;
-
-            if (videoElement.ended || videoElement.currentTime >= trimRange[1]) {
-                if (this.recorder && this.recorder.state === 'recording') {
-                    this.recorder.stop();
-                }
-                return;
-            }
-
-            if (this.ctx) {
-                onDrawFrame(this.ctx, videoElement);
-            }
-
-            if (onProgress) {
-                const current = Math.max(0, videoElement.currentTime - trimRange[0]);
-                onProgress(Math.min(1, current / duration));
-            }
-
-            const now = typeof performance !== 'undefined' && typeof performance.now === 'function' ? performance.now() : Date.now();
-            const elapsed = lastManualTs ? (now - lastManualTs) : 0;
-            const delay = Math.max(0, frameIntervalMs - elapsed);
-            lastManualTs = now;
-            try {
-                this.manualTimer = setTimeout(processFrameManual, delay) as unknown as number;
-            } catch {
-                this.manualTimer = null;
-            }
-        };
-
-        // Iniciar loop
-        if (useManualFps) {
-            processFrameManual();
-        }
-        if (!useManualFps) {
-            // @ts-ignore
-            if (videoElement.requestVideoFrameCallback) {
-                // @ts-ignore
-                videoElement.requestVideoFrameCallback(processFrame);
-            } else {
-                requestAnimationFrame(processFrame);
-            }
-        }
-
-        // Aguardar fim
-        try {
-            const result = await recordingPromise;
-            return result;
-        } finally {
-            // Restaurar estado
-            videoElement.muted = originalMuted;
-            videoElement.volume = originalVolume;
-            videoElement.loop = originalLoop;
-            // Não restauramos currentTime aqui para não travar a UI, deixamos onde parou ou voltamos pro início
-            this.cleanup();
-        }
-    }
-}
diff --git a/_archive/duplicates/src/lib/video/VideoCompositor 3.ts b/_archive/duplicates/src/lib/video/VideoCompositor 3.ts
deleted file mode 100644
index 22359b8..0000000
--- a/_archive/duplicates/src/lib/video/VideoCompositor 3.ts	
+++ /dev/null
@@ -1,394 +0,0 @@
-/**
- * VideoCompositor.ts
- * Motor universal de composição e exportação de vídeo para o IronTracks.
- * Garante sincronia frame-a-frame, áudio mixado via Web Audio API e compatibilidade cross-platform.
- */
-
-interface RenderOptions {
-    videoElement: HTMLVideoElement;
-    trimRange: [number, number];
-    onDrawFrame: (ctx: CanvasRenderingContext2D, video: HTMLVideoElement) => void;
-    onProgress?: (progress: number) => void;
-    outputWidth?: number;
-    outputHeight?: number;
-    fps?: number;
-    mimeTypeOverride?: string;
-    videoBitsPerSecond?: number;
-    audioBitsPerSecond?: number;
-}
-
-interface ExportResult {
-    blob: Blob;
-    filename: string;
-    mime: string;
-    duration: number;
-}
-
-export class VideoCompositor {
-    private ctx: CanvasRenderingContext2D | null = null;
-    private canvas: HTMLCanvasElement | null = null;
-    private audioCtx: AudioContext | null = null;
-    private destNode: MediaStreamAudioDestinationNode | null = null;
-    private sourceNode: MediaElementAudioSourceNode | null = null;
-    private recorder: MediaRecorder | null = null;
-    private isCancelled = false;
-    private manualTimer: number | null = null;
-
-    constructor() {
-        if (typeof window !== 'undefined') {
-            this.canvas = document.createElement('canvas');
-            // Desynchronized pode melhorar performance, alpha: false remove transparência desnecessária
-            this.ctx = this.canvas.getContext('2d', { alpha: false, desynchronized: true });
-        }
-    }
-
-    public cancel() {
-        this.isCancelled = true;
-        this.cleanup();
-    }
-
-    private cleanup() {
-        if (this.manualTimer) {
-            try { clearTimeout(this.manualTimer); } catch {}
-        }
-        this.manualTimer = null;
-        if (this.sourceNode) {
-            try { this.sourceNode.disconnect(); } catch {}
-        }
-        if (this.destNode) {
-            try { this.destNode.disconnect(); } catch {}
-        }
-        if (this.audioCtx) {
-            try { this.audioCtx.close(); } catch {}
-        }
-        if (this.recorder && this.recorder.state !== 'inactive') {
-            try { this.recorder.stop(); } catch {}
-        }
-        this.sourceNode = null;
-        this.destNode = null;
-        this.audioCtx = null;
-        this.recorder = null;
-    }
-
-    private async assembleBlob(chunks: Blob[], mimeType: string): Promise<Blob> {
-        try {
-            const safeChunks = Array.isArray(chunks) ? chunks : [];
-            if (typeof Worker === 'undefined' || safeChunks.length === 0) {
-                return new Blob(safeChunks, { type: mimeType });
-            }
-            const workerCode = `self.onmessage=(e)=>{try{const d=e.data||{};const list=Array.isArray(d.chunks)?d.chunks:[];const blob=new Blob(list,{type:d.type||''});self.postMessage({ok:true,blob});}catch(err){self.postMessage({ok:false,error:String(err&&err.message?err.message:err)});}};`;
-            const url = URL.createObjectURL(new Blob([workerCode], { type: 'application/javascript' }));
-            const worker = new Worker(url);
-            try { URL.revokeObjectURL(url); } catch {}
-            return await new Promise<Blob>((resolve) => {
-                let settled = false;
-                const done = (blob: Blob) => {
-                    if (settled) return;
-                    settled = true;
-                    try { worker.terminate(); } catch {}
-                    resolve(blob);
-                };
-                const fallback = () => done(new Blob(safeChunks, { type: mimeType }));
-                const timer = setTimeout(() => fallback(), 3000);
-                worker.onmessage = (ev) => {
-                    try { clearTimeout(timer); } catch {}
-                    const data = ev?.data || {};
-                    if (data?.ok && data?.blob) {
-                        done(data.blob);
-                        return;
-                    }
-                    fallback();
-                };
-                worker.onerror = () => {
-                    try { clearTimeout(timer); } catch {}
-                    fallback();
-                };
-                try {
-                    worker.postMessage({ chunks: safeChunks, type: mimeType });
-                } catch {
-                    try { clearTimeout(timer); } catch {}
-                    fallback();
-                }
-            });
-        } catch {
-            return new Blob(Array.isArray(chunks) ? chunks : [], { type: mimeType });
-        }
-    }
-
-    /**
-     * Detecta o melhor formato suportado pelo navegador
-     */
-    private getBestMimeType(): string {
-        const ua = navigator.userAgent;
-        const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
-        const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
-
-        // Ordem de preferência: H.264 (MP4) > VP9 (WebM) > VP8 (WebM)
-        const candidates = [
-            'video/mp4;codecs="avc1.42E01E,mp4a.40.2"', // H.264 Main Profile
-            'video/mp4;codecs=avc1.42E01E,mp4a.40.2',
-            'video/mp4',
-            'video/webm;codecs=vp9,opus',
-            'video/webm;codecs=vp8,opus',
-            'video/webm'
-        ];
-
-        // No iOS/Safari, forçamos a verificação estrita de MP4 primeiro
-        if (isIOS || isSafari) {
-            const mp4 = candidates.find(c => MediaRecorder.isTypeSupported(c));
-            if (mp4) return mp4;
-        }
-
-        for (const type of candidates) {
-            if (MediaRecorder.isTypeSupported(type)) {
-                return type;
-            }
-        }
-        
-        throw new Error('Nenhum formato de vídeo suportado encontrado neste navegador.');
-    }
-
-    /**
-     * Renderiza o vídeo frame a frame garantindo sincronia
-     */
-    public async render({
-        videoElement,
-        trimRange,
-        onDrawFrame,
-        onProgress,
-        outputWidth = 1080,
-        outputHeight = 1920,
-        fps = 30,
-        mimeTypeOverride,
-        videoBitsPerSecond: userVideoBps,
-        audioBitsPerSecond: userAudioBps
-    }: RenderOptions): Promise<ExportResult> {
-        this.isCancelled = false;
-        
-        if (!this.canvas || !this.ctx) throw new Error('Canvas context not initialized');
-        
-        // 1. Setup Canvas
-        this.canvas.width = outputWidth;
-        this.canvas.height = outputHeight;
-
-        // 2. Setup Audio (Web Audio API para mixagem robusta)
-        // Necessário user gesture prévio para AudioContext em alguns browsers, mas aqui já estamos num fluxo iniciado pelo user
-        this.audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
-        this.destNode = this.audioCtx.createMediaStreamDestination();
-        
-        // Conecta o vídeo ao destino de gravação
-        try {
-            this.sourceNode = this.audioCtx.createMediaElementSource(videoElement);
-            this.sourceNode.connect(this.destNode);
-            // Também conecta ao destino padrão (speakers) se quisermos ouvir durante o processo? 
-            // Melhor não, para não dar eco. O vídeo será mutado visualmente mas processado internamente.
-        } catch (e) {
-            console.warn('Falha ao conectar áudio via Web Audio API, tentando fallback simples', e);
-            // Fallback: tentar capturar stream direto do vídeo se possível, ou prosseguir mudo
-        }
-
-        // 3. Preparar Stream de Saída
-        const canvasStream = this.canvas.captureStream(fps);
-        if (this.destNode) {
-            const audioTracks = this.destNode.stream.getAudioTracks();
-            if (audioTracks.length > 0) {
-                canvasStream.addTrack(audioTracks[0]);
-            }
-        } else {
-            // Tenta pegar direto do vídeo se Web Audio falhou
-            // @ts-ignore
-            const vidStream = videoElement.captureStream ? videoElement.captureStream() : videoElement.mozCaptureStream ? videoElement.mozCaptureStream() : null;
-            if (vidStream) {
-                const audioTracks = vidStream.getAudioTracks();
-                if (audioTracks.length > 0) canvasStream.addTrack(audioTracks[0]);
-            }
-        }
-
-        // 4. Setup Gravador
-        let mimeType = this.getBestMimeType();
-        if (mimeTypeOverride) {
-            try {
-                if (MediaRecorder.isTypeSupported(mimeTypeOverride)) {
-                    mimeType = mimeTypeOverride;
-                }
-            } catch {}
-        }
-        const videoBitsPerSecond = typeof userVideoBps === 'number' && userVideoBps > 0 ? userVideoBps : 5_000_000;
-        const audioBitsPerSecond = typeof userAudioBps === 'number' && userAudioBps > 0 ? userAudioBps : 128_000;
-        
-        try {
-            this.recorder = new MediaRecorder(canvasStream, {
-                mimeType,
-                videoBitsPerSecond,
-                audioBitsPerSecond
-            });
-        } catch (e) {
-            console.warn('Bitrate control not supported, using defaults', e);
-            this.recorder = new MediaRecorder(canvasStream, { mimeType });
-        }
-
-        const chunks: Blob[] = [];
-        this.recorder.ondataavailable = (e) => {
-            if (e.data && e.data.size > 0) chunks.push(e.data);
-        };
-
-        // Promise que resolve quando a gravação termina
-        const recordingPromise = new Promise<ExportResult>((resolve, reject) => {
-            if (!this.recorder) return reject(new Error('Recorder not initialized'));
-
-            this.recorder.onstop = async () => {
-                if (this.isCancelled) {
-                    reject(new Error('Renderização cancelada'));
-                    return;
-                }
-                try {
-                    const blob = await this.assembleBlob(chunks, mimeType);
-                    const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
-                    resolve({
-                        blob,
-                        filename: `story-${Date.now()}.${ext}`,
-                        mime: mimeType,
-                        duration: (trimRange[1] - trimRange[0])
-                    });
-                } catch (e) {
-                    reject(e);
-                }
-            };
-            this.recorder.onerror = (e) => reject(e);
-        });
-
-        // 5. Loop de Renderização Síncrona
-        // Salvar estado original do vídeo
-        const originalMuted = videoElement.muted;
-        const originalCurrentTime = videoElement.currentTime;
-        const originalVolume = videoElement.volume;
-        const originalLoop = videoElement.loop;
-
-        // Preparar vídeo
-        videoElement.muted = false; // Necessário para o AudioContext capturar (mas não sai som se não conectar ao destination)
-        videoElement.volume = 1.0;
-        videoElement.loop = false;
-        videoElement.currentTime = trimRange[0];
-
-        // Aguardar seek
-        await new Promise<void>(resolve => {
-            const onSeek = () => {
-                videoElement.removeEventListener('seeked', onSeek);
-                resolve();
-            };
-            videoElement.addEventListener('seeked', onSeek);
-            // Fallback se já estiver pronto
-            if (videoElement.readyState >= 2 && !videoElement.seeking) {
-                videoElement.removeEventListener('seeked', onSeek);
-                resolve();
-            }
-        });
-
-        // Iniciar gravação com timeslice para melhor gerenciamento de memória
-        this.recorder.start(1000); // 1 segundo chunks
-        try {
-            await videoElement.play();
-        } catch (e) {
-            try {
-                if (this.recorder && this.recorder.state === 'recording') this.recorder.stop();
-            } catch {}
-            throw e;
-        }
-
-        // Loop principal
-        const duration = trimRange[1] - trimRange[0];
-        
-        const useManualFps = !(videoElement as any)?.requestVideoFrameCallback;
-        const frameIntervalMs = fps > 0 ? (1000 / fps) : 33.3333333333;
-        let lastManualTs = 0;
-
-        const processFrame = () => {
-            if (this.isCancelled) return;
-
-            // Checar fim
-            if (videoElement.ended || videoElement.currentTime >= trimRange[1]) {
-                if (this.recorder && this.recorder.state === 'recording') {
-                    this.recorder.stop();
-                }
-                return;
-            }
-
-            // Desenhar frame
-            if (this.ctx) {
-                onDrawFrame(this.ctx, videoElement);
-            }
-
-            // Atualizar progresso
-            if (onProgress) {
-                const current = Math.max(0, videoElement.currentTime - trimRange[0]);
-                onProgress(Math.min(1, current / duration));
-            }
-
-            // Próximo frame
-            // @ts-ignore
-            if (videoElement.requestVideoFrameCallback) {
-                // @ts-ignore
-                videoElement.requestVideoFrameCallback(processFrame);
-            } else {
-                requestAnimationFrame(processFrame);
-            }
-        };
-
-        const processFrameManual = () => {
-            if (this.isCancelled) return;
-
-            if (videoElement.ended || videoElement.currentTime >= trimRange[1]) {
-                if (this.recorder && this.recorder.state === 'recording') {
-                    this.recorder.stop();
-                }
-                return;
-            }
-
-            if (this.ctx) {
-                onDrawFrame(this.ctx, videoElement);
-            }
-
-            if (onProgress) {
-                const current = Math.max(0, videoElement.currentTime - trimRange[0]);
-                onProgress(Math.min(1, current / duration));
-            }
-
-            const now = typeof performance !== 'undefined' && typeof performance.now === 'function' ? performance.now() : Date.now();
-            const elapsed = lastManualTs ? (now - lastManualTs) : 0;
-            const delay = Math.max(0, frameIntervalMs - elapsed);
-            lastManualTs = now;
-            try {
-                this.manualTimer = setTimeout(processFrameManual, delay) as unknown as number;
-            } catch {
-                this.manualTimer = null;
-            }
-        };
-
-        // Iniciar loop
-        if (useManualFps) {
-            processFrameManual();
-        }
-        if (!useManualFps) {
-            // @ts-ignore
-            if (videoElement.requestVideoFrameCallback) {
-                // @ts-ignore
-                videoElement.requestVideoFrameCallback(processFrame);
-            } else {
-                requestAnimationFrame(processFrame);
-            }
-        }
-
-        // Aguardar fim
-        try {
-            const result = await recordingPromise;
-            return result;
-        } finally {
-            // Restaurar estado
-            videoElement.muted = originalMuted;
-            videoElement.volume = originalVolume;
-            videoElement.loop = originalLoop;
-            // Não restauramos currentTime aqui para não travar a UI, deixamos onde parou ou voltamos pro início
-            this.cleanup();
-        }
-    }
-}
diff --git a/_archive/duplicates/src/utils/__tests__/mediaUtils.test 2.ts b/_archive/duplicates/src/utils/__tests__/mediaUtils.test 2.ts
deleted file mode 100644
index fe8b26e..0000000
--- a/_archive/duplicates/src/utils/__tests__/mediaUtils.test 2.ts	
+++ /dev/null
@@ -1,71 +0,0 @@
-import { parseExt, guessMediaKind, extFromMime, mediaKindFromUrl } from '../mediaUtils'
-
-describe('mediaUtils', () => {
-  describe('parseExt', () => {
-    it('extracts valid extensions', () => {
-      expect(parseExt('video.mp4')).toBe('.mp4')
-      expect(parseExt('IMAGE.JPG')).toBe('.jpg') // Case insensitive
-      expect(parseExt('my.story.webm')).toBe('.webm')
-    })
-
-    it('returns empty string for invalid extensions', () => {
-      expect(parseExt('file.exe')).toBe('')
-      expect(parseExt('script.js')).toBe('')
-      expect(parseExt('no_extension')).toBe('')
-    })
-  })
-
-  describe('guessMediaKind', () => {
-    it('identifies video from mime', () => {
-      expect(guessMediaKind('video/mp4', '')).toBe('video')
-      expect(guessMediaKind('video/webm', '')).toBe('video')
-    })
-
-    it('identifies image from mime', () => {
-      expect(guessMediaKind('image/jpeg', '')).toBe('image')
-      expect(guessMediaKind('image/png', '')).toBe('image')
-    })
-
-    it('identifies video from extension', () => {
-      expect(guessMediaKind('', '.mp4')).toBe('video')
-      expect(guessMediaKind('', '.mov')).toBe('video')
-    })
-
-    it('identifies image from extension', () => {
-      expect(guessMediaKind('', '.jpg')).toBe('image')
-      expect(guessMediaKind('', '.png')).toBe('image')
-    })
-
-    it('returns unknown for unsupported types', () => {
-      expect(guessMediaKind('application/pdf', '.pdf')).toBe('unknown')
-    })
-  })
-
-  describe('extFromMime', () => {
-    it('maps mime to extension', () => {
-      expect(extFromMime('video/mp4')).toBe('.mp4')
-      expect(extFromMime('image/jpeg')).toBe('.jpg')
-      expect(extFromMime('video/webm')).toBe('.webm')
-    })
-
-    it('returns empty for unknown mime', () => {
-      expect(extFromMime('application/json')).toBe('')
-    })
-  })
-
-  describe('mediaKindFromUrl', () => {
-    it('detects kind from simple url', () => {
-      expect(mediaKindFromUrl('https://example.com/video.mp4')).toBe('video')
-      expect(mediaKindFromUrl('https://example.com/image.jpg')).toBe('image')
-    })
-
-    it('detects kind from signed supabase url', () => {
-      const url = 'https://supabase.co/storage/v1/object/public/stories/user/123.mp4?token=abc'
-      expect(mediaKindFromUrl(url)).toBe('video')
-    })
-
-    it('handles query parameters safely', () => {
-      expect(mediaKindFromUrl('http://site.com/vid.mov?foo=bar.jpg')).toBe('video')
-    })
-  })
-})
diff --git a/_archive/duplicates/src/utils/calories/kcalClient 3.js b/_archive/duplicates/src/utils/calories/kcalClient 3.js
deleted file mode 100644
index a1f8ae0..0000000
--- a/_archive/duplicates/src/utils/calories/kcalClient 3.js	
+++ /dev/null
@@ -1,60 +0,0 @@
-const safeString = (v) => {
-  try {
-    return String(v ?? '').trim()
-  } catch {
-    return ''
-  }
-}
-
-export const calculateTotalVolume = (logs) => {
-  try {
-    const safeLogs = logs && typeof logs === 'object' ? logs : {}
-    let volume = 0
-    Object.values(safeLogs).forEach((log) => {
-      if (!log || typeof log !== 'object') return
-      const w = Number(safeString(log.weight).replace(',', '.'))
-      const r = Number(safeString(log.reps).replace(',', '.'))
-      if (!Number.isFinite(w) || !Number.isFinite(r)) return
-      if (w <= 0 || r <= 0) return
-      volume += w * r
-    })
-    return volume
-  } catch {
-    return 0
-  }
-}
-
-export const computeFallbackKcal = ({ session, volume }) => {
-  try {
-    const outdoorBike = session?.outdoorBike && typeof session.outdoorBike === 'object' ? session.outdoorBike : null
-    const bikeKcal = Number(outdoorBike?.caloriesKcal)
-    if (Number.isFinite(bikeKcal) && bikeKcal > 0) return Math.round(bikeKcal)
-    const durationMinutes = (Number(session?.totalTime) || 0) / 60
-    return Math.round(volume * 0.02 + durationMinutes * 4)
-  } catch {
-    return 0
-  }
-}
-
-export const getKcalEstimate = async ({ session, workoutId }) => {
-  try {
-    const logs = session?.logs && typeof session.logs === 'object' ? session.logs : {}
-    const volume = calculateTotalVolume(logs)
-    const fallback = computeFallbackKcal({ session, volume })
-    const resp = await fetch('/api/calories/estimate', {
-      method: 'POST',
-      headers: { 'Content-Type': 'application/json' },
-      body: JSON.stringify({ session, workoutId: typeof workoutId === 'string' ? workoutId : null }),
-    })
-    const json = await resp.json().catch(() => null)
-    const kcal = Number(json?.kcal)
-    if (!resp.ok) return fallback
-    if (!Number.isFinite(kcal) || kcal <= 0) return fallback
-    return Math.round(kcal)
-  } catch {
-    const logs = session?.logs && typeof session.logs === 'object' ? session.logs : {}
-    const volume = calculateTotalVolume(logs)
-    return computeFallbackKcal({ session, volume })
-  }
-}
-
diff --git a/_archive/duplicates/src/utils/report/buildHtml 2.js b/_archive/duplicates/src/utils/report/buildHtml 2.js
deleted file mode 100644
index 818b80d..0000000
--- a/_archive/duplicates/src/utils/report/buildHtml 2.js	
+++ /dev/null
@@ -1,692 +0,0 @@
-const formatDate = (ts) => {
-  if (!ts) return ''
-  const d = ts.toDate ? ts.toDate() : new Date(ts)
-  return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' })
-}
-
-const formatShortDate = (ts) => {
-  try {
-    if (!ts) return ''
-    const d = ts.toDate ? ts.toDate() : new Date(ts)
-    return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' })
-  } catch {
-    return ''
-  }
-}
-
-const formatDuration = (s) => {
-  const safe = Number(s) || 0
-  const mins = Math.floor(safe / 60)
-  const secs = Math.floor(safe % 60)
-  return `${mins}:${secs < 10 ? '0' : ''}${secs}`
-}
-
-const escapeHtml = (v) => {
-  try {
-    return String(v ?? '')
-      .replaceAll('&', '&amp;')
-      .replaceAll('<', '&lt;')
-      .replaceAll('>', '&gt;')
-      .replaceAll('"', '&quot;')
-      .replaceAll("'", '&#39;')
-  } catch {
-    return ''
-  }
-}
-
-const normalizeExerciseKey = (v) => {
-  try {
-    return String(v || '').trim().toLowerCase().replace(/\s+/g, ' ')
-  } catch {
-    return ''
-  }
-}
-
-const calculateTotalVolume = (logs) => {
-  try {
-    let volume = 0
-    const safeLogs = logs && typeof logs === 'object' ? logs : {}
-    Object.values(safeLogs).forEach((log) => {
-      if (!log || typeof log !== 'object') return
-      const w = Number(String(log.weight ?? '').replace(',', '.'))
-      const r = Number(String(log.reps ?? '').replace(',', '.'))
-      if (!Number.isFinite(w) || !Number.isFinite(r)) return
-      if (w <= 0 || r <= 0) return
-      volume += w * r
-    })
-    return volume
-  } catch {
-    return 0
-  }
-}
-
-const getSetTag = (log) => {
-  if (!log || typeof log !== 'object') return null
-  const isWarmup = !!(log.is_warmup ?? log.isWarmup)
-  if (isWarmup) return 'Aquecimento'
-  const cfg = log.advanced_config ?? log.advancedConfig
-  const rawType = cfg && (cfg.type || cfg.kind || cfg.mode)
-  const t = String(rawType || '').toLowerCase()
-  if (!t) return null
-  if (t.includes('drop')) return 'Drop-set'
-  if (t.includes('rest')) return 'Rest-pause'
-  if (t.includes('cluster')) return 'Cluster'
-  if (t.includes('bi')) return 'Bi-set'
-  return 'Método'
-}
-
-export function buildReportData(session, previousSession, studentName = '', kcalOverride = null, options = null) {
-  const opts = options && typeof options === 'object' ? options : {}
-  const prevLogsByExercise = opts?.prevLogsByExercise && typeof opts.prevLogsByExercise === 'object' ? opts.prevLogsByExercise : null
-  const prevBaseMsByExercise = opts?.prevBaseMsByExercise && typeof opts.prevBaseMsByExercise === 'object' ? opts.prevBaseMsByExercise : null
-  const aiRaw = opts?.ai && typeof opts.ai === 'object' ? opts.ai : session?.ai && typeof session.ai === 'object' ? session.ai : null
-
-  const sessionObj = session && typeof session === 'object' ? session : {}
-  const prevObj = previousSession && typeof previousSession === 'object' ? previousSession : null
-
-  const sessionLogs = sessionObj?.logs && typeof sessionObj.logs === 'object' ? sessionObj.logs : {}
-  const currentVolume = calculateTotalVolume(sessionLogs)
-  const prevVolume = prevObj ? calculateTotalVolume(prevObj?.logs && typeof prevObj.logs === 'object' ? prevObj.logs : {}) : 0
-  const volumeDeltaPct = prevVolume > 0 ? ((currentVolume - prevVolume) / prevVolume) * 100 : null
-
-  const totalTimeSeconds = Number(sessionObj?.totalTime) || 0
-  const realTotalTimeSeconds =
-    (Number(sessionObj?.realTotalTime) || 0)
-    || (Array.isArray(sessionObj?.exerciseDurations) ? sessionObj.exerciseDurations.reduce((a, b) => a + (Number(b) || 0), 0) : 0)
-
-  const outdoorBikeRaw = sessionObj?.outdoorBike && typeof sessionObj.outdoorBike === 'object' ? sessionObj.outdoorBike : null
-  const outdoorBike = outdoorBikeRaw ? {
-    distanceKm: (() => {
-      const dist = Number(outdoorBikeRaw?.distanceMeters)
-      if (!Number.isFinite(dist) || dist <= 0) return null
-      return dist / 1000
-    })(),
-    durationSeconds: (() => {
-      const dur = Number(outdoorBikeRaw?.durationSeconds)
-      if (!Number.isFinite(dur) || dur <= 0) return null
-      return dur
-    })(),
-    avgSpeedKmh: (() => {
-      const v = Number(outdoorBikeRaw?.avgSpeedKmh)
-      if (!Number.isFinite(v) || v <= 0) return null
-      return v
-    })(),
-    maxSpeedKmh: (() => {
-      const v = Number(outdoorBikeRaw?.maxSpeedKmh)
-      if (!Number.isFinite(v) || v <= 0) return null
-      return v
-    })(),
-    caloriesKcal: (() => {
-      const v = Number(outdoorBikeRaw?.caloriesKcal)
-      if (!Number.isFinite(v) || v <= 0) return null
-      return Math.round(v)
-    })(),
-  } : null
-
-  const caloriesEstimate = (() => {
-    const ov = Number(kcalOverride)
-    if (Number.isFinite(ov) && ov > 0) return Math.round(ov)
-    const bikeKcal = Number(outdoorBike?.caloriesKcal)
-    if (Number.isFinite(bikeKcal) && bikeKcal > 0) return Math.round(bikeKcal)
-    const durationInMinutes = totalTimeSeconds / 60
-    return Math.round((currentVolume * 0.02) + (durationInMinutes * 4))
-  })()
-
-  const prevLogsMap = {}
-  const prevBaseMap = {}
-  if (prevLogsByExercise) {
-    Object.keys(prevLogsByExercise).forEach((k) => {
-      const key = normalizeExerciseKey(k)
-      if (!key) return
-      const logs = prevLogsByExercise[k]
-      if (!Array.isArray(logs)) return
-      prevLogsMap[key] = logs
-      if (prevBaseMsByExercise && prevBaseMsByExercise[k] != null) {
-        prevBaseMap[key] = prevBaseMsByExercise[k]
-      }
-    })
-  } else {
-    const safePrevLogs = prevObj?.logs && typeof prevObj.logs === 'object' ? prevObj.logs : {}
-    if (prevObj && Array.isArray(prevObj?.exercises)) {
-      prevObj.exercises.forEach((ex, exIdx) => {
-        if (!ex || typeof ex !== 'object') return
-        const exName = String(ex?.name || '').trim()
-        const key = normalizeExerciseKey(exName)
-        if (!key) return
-        const exLogs = []
-        Object.keys(safePrevLogs).forEach((k) => {
-          const parts = String(k || '').split('-')
-          const eIdx = parseInt(parts[0] || '0', 10)
-          const sIdx = parseInt(parts[1] || '0', 10)
-          if (!Number.isFinite(eIdx) || !Number.isFinite(sIdx)) return
-          if (eIdx !== exIdx) return
-          exLogs[sIdx] = safePrevLogs[k]
-        })
-        prevLogsMap[key] = exLogs
-      })
-    }
-  }
-
-  const exercisesArray = Array.isArray(sessionObj?.exercises) ? sessionObj.exercises : []
-  const exercises = exercisesArray.map((ex, exIdx) => {
-    const setsPlanned = parseInt(ex?.sets || 0, 10)
-    const exKey = normalizeExerciseKey(ex?.name)
-    const prevLogs = prevLogsMap[exKey] || []
-    const baseMs = prevBaseMap[exKey]
-    const baseLabel = baseMs ? `Base: ${formatShortDate(baseMs)}` : null
-
-    const sets = []
-    for (let sIdx = 0; sIdx < setsPlanned; sIdx++) {
-      const key = `${exIdx}-${sIdx}`
-      const log = sessionLogs[key]
-      if (!log || typeof log !== 'object') continue
-      if (!log.weight && !log.reps) continue
-
-      const prevLog = prevLogs[sIdx]
-
-      const cw = Number(String(log.weight ?? '').replace(',', '.'))
-      const cr = Number(String(log.reps ?? '').replace(',', '.'))
-      const pw = prevLog && typeof prevLog === 'object' ? Number(String(prevLog.weight ?? '').replace(',', '.')) : NaN
-      const pr = prevLog && typeof prevLog === 'object' ? Number(String(prevLog.reps ?? '').replace(',', '.')) : NaN
-
-      const canWeight = Number.isFinite(cw) && cw > 0 && Number.isFinite(pw) && pw > 0
-      const canReps = Number.isFinite(cr) && cr > 0 && Number.isFinite(pr) && pr > 0
-
-      let progression = null
-      if (prevLog && typeof prevLog === 'object') {
-        if (canWeight) {
-          const delta = cw - pw
-          const fmt = (n) => (Number.isFinite(n) ? String(n).replace(/\.0+$/, '') : String(n))
-          const deltaText = delta > 0 ? `+${fmt(delta)}kg` : delta < 0 ? `${fmt(delta)}kg` : '='
-          const direction = delta > 0 ? 'up' : delta < 0 ? 'down' : 'flat'
-          progression = { type: 'weight', deltaText, direction }
-        } else if (canReps) {
-          const delta = cr - pr
-          const deltaText = delta > 0 ? `+${delta} reps` : delta < 0 ? `${delta} reps` : '='
-          const direction = delta > 0 ? 'up' : delta < 0 ? 'down' : 'flat'
-          progression = { type: 'reps', deltaText, direction }
-        } else if (
-          Number.isFinite(cw) && cw > 0
-          && Number.isFinite(cr) && cr > 0
-          && Number.isFinite(pw) && pw > 0
-          && Number.isFinite(pr) && pr > 0
-        ) {
-          const curVol = cw * cr
-          const prevVol = pw * pr
-          const delta = curVol - prevVol
-          const deltaText = delta > 0 ? `+${Math.round(delta)}kg` : delta < 0 ? `${Math.round(delta)}kg` : '='
-          const direction = delta > 0 ? 'up' : delta < 0 ? 'down' : 'flat'
-          progression = { type: 'volume', deltaText, direction }
-        }
-      }
-
-      const note = (log && (log.note || log.observation)) || null
-      const tag = getSetTag(log)
-      sets.push({
-        index: sIdx + 1,
-        weight: log.weight ?? null,
-        reps: log.reps ?? null,
-        cadence: ex?.cadence ?? null,
-        tag,
-        note,
-        progression,
-      })
-    }
-
-    const showProgression = sets.some((s) => s?.progression && s.progression.type && s.progression.type !== 'none')
-
-    return {
-      name: String(ex?.name || '').trim(),
-      method: ex?.method && ex.method !== 'Normal' ? String(ex.method) : null,
-      rpe: ex?.rpe ?? null,
-      cadence: ex?.cadence ?? null,
-      baseLabel,
-      showProgression,
-      sets,
-    }
-  })
-
-  const summaryMetrics = (() => {
-    try {
-      let setsLoggedCount = 0
-      let repsTotal = 0
-      let topWeight = 0
-      let exercisesWithLogs = new Set()
-
-      Object.keys(sessionLogs).forEach((k) => {
-        const log = sessionLogs[k]
-        if (!log || typeof log !== 'object') return
-        const w = Number(String(log.weight ?? '').replace(',', '.'))
-        const r = Number(String(log.reps ?? '').replace(',', '.'))
-        if ((!Number.isFinite(w) || w <= 0) && (!Number.isFinite(r) || r <= 0)) return
-        setsLoggedCount += 1
-        if (Number.isFinite(r) && r > 0) repsTotal += r
-        if (Number.isFinite(w) && w > topWeight) topWeight = w
-        const parts = String(k || '').split('-')
-        const eIdx = parseInt(parts[0] || '0', 10)
-        if (Number.isFinite(eIdx) && eIdx >= 0) exercisesWithLogs.add(eIdx)
-      })
-
-      return {
-        exercisesCount: exercisesArray.length,
-        exercisesLoggedCount: exercisesWithLogs.size,
-        setsLoggedCount,
-        repsTotal,
-        volumeTotal: currentVolume,
-        volumeDeltaPctVsPrev: volumeDeltaPct,
-        topWeight: topWeight > 0 ? topWeight : null,
-        caloriesEstimate: caloriesEstimate > 0 ? caloriesEstimate : null,
-      }
-    } catch {
-      return {
-        exercisesCount: exercisesArray.length,
-        exercisesLoggedCount: 0,
-        setsLoggedCount: 0,
-        repsTotal: 0,
-        volumeTotal: currentVolume,
-        volumeDeltaPctVsPrev: volumeDeltaPct,
-        topWeight: null,
-        caloriesEstimate: caloriesEstimate > 0 ? caloriesEstimate : null,
-      }
-    }
-  })()
-
-  const origin = (typeof window !== 'undefined' && window.location && window.location.origin)
-    ? window.location.origin
-    : ''
-
-  return {
-    meta: {
-      reportVersion: 'workout-report-v1',
-      generatedAt: new Date().toISOString(),
-      locale: 'pt-BR',
-      source: 'workout_session',
-    },
-    brand: {
-      appName: 'IronTracks',
-      accentColor: '#f59e0b',
-      logoUrl: `${origin}/icone.png`,
-    },
-    athlete: {
-      id: sessionObj?.user_id || sessionObj?.userId || null,
-      name: String(studentName || '').trim(),
-      coachName: null,
-      units: 'kg',
-    },
-    session: {
-      workoutId: sessionObj?.id ?? null,
-      workoutTitle: String(sessionObj?.workoutTitle || 'Treino'),
-      startAt: sessionObj?.date ? new Date(sessionObj.date?.toDate ? sessionObj.date.toDate() : sessionObj.date).toISOString() : null,
-      endAt: null,
-      totalTimeSeconds,
-      realTimeSeconds: realTotalTimeSeconds,
-      status: 'completed',
-      isTeamSession: false,
-      notes: null,
-    },
-    summaryMetrics,
-    outdoorBike,
-    exercises,
-    ai: aiRaw,
-  }
-}
-
-export function buildReportHTML(session, previousSession, studentName = '', kcalOverride = null, options = null) {
-  const reportData = buildReportData(session, previousSession, studentName, kcalOverride, options)
-  const aiRaw = reportData?.ai && typeof reportData.ai === 'object' ? reportData.ai : null
-
-  const volumeDeltaStr = reportData?.summaryMetrics?.volumeDeltaPctVsPrev != null
-    ? Number(reportData.summaryMetrics.volumeDeltaPctVsPrev).toFixed(1)
-    : '0.0'
-
-  const buildAiSection = () => {
-    if (!aiRaw) return ''
-    const summaryItems = Array.isArray(aiRaw?.summary) ? aiRaw.summary.filter(Boolean).map((v) => String(v)) : []
-    const summaryText = !summaryItems.length ? String(aiRaw?.summary || '').trim() : ''
-    const motivation = String(aiRaw?.motivation || '').trim()
-    const highlights = Array.isArray(aiRaw?.highlights) ? aiRaw.highlights.filter(Boolean).map((v) => String(v)) : []
-    const warnings = Array.isArray(aiRaw?.warnings) ? aiRaw.warnings.filter(Boolean).map((v) => String(v)) : []
-
-    const prs = Array.isArray(aiRaw?.prs) ? aiRaw.prs.filter(Boolean) : []
-    const prItems = prs.slice(0, 10).map((p) => {
-      const ex = escapeHtml(p?.exercise || p?.name || '')
-      const val = escapeHtml(p?.value || p?.text || '')
-      if (!ex && !val) return ''
-      return `<li><span style="font-weight:900; color:#f5f5f5">${ex || 'PR'}</span><span style="color:#a3a3a3"> — ${val}</span></li>`
-    }).filter(Boolean)
-
-    const progression = Array.isArray(aiRaw?.progression) ? aiRaw.progression.filter(Boolean) : []
-    const progItems = progression.slice(0, 10).map((it) => {
-      const ex = escapeHtml(it?.exercise || it?.name || '')
-      const rec = escapeHtml(it?.recommendation || it?.action || it?.text || '')
-      if (!ex && !rec) return ''
-      return `<li><span style="font-weight:900; color:#f5f5f5">${ex || 'Ajuste'}</span><span style="color:#a3a3a3"> — ${rec}</span></li>`
-    }).filter(Boolean)
-
-    const bullets = (items) => {
-      if (!items?.length) return ''
-      return `<ul style="margin:10px 0 0; padding-left: 18px; display:grid; gap: 6px">${items.map((v) => `<li style="color:#e5e7eb">${escapeHtml(v)}</li>`).join('')}</ul>`
-    }
-
-    const summaryBlock = (() => {
-      if (summaryItems.length) return bullets(summaryItems)
-      if (summaryText) return `<div style="font-size:14px; color:#f5f5f5; font-weight:700">${escapeHtml(summaryText)}</div>`
-      return ''
-    })()
-
-    const sections = []
-    if (summaryBlock) {
-      sections.push(`
-        <div class="card" style="border-color: rgba(245, 158, 11, .35); background: rgba(245, 158, 11, .06)">
-          <div class="muted" style="margin-bottom:8px; color:#f59e0b">Insights da IA</div>
-          ${summaryBlock}
-          ${motivation ? `<div style="margin-top:10px; font-size:12px; color:#a3a3a3">${escapeHtml(motivation)}</div>` : ''}
-        </div>
-      `)
-    }
-    if (highlights.length) {
-      sections.push(`
-        <div class="card">
-          <div class="muted" style="margin-bottom:8px">Pontos Fortes</div>
-          ${bullets(highlights)}
-        </div>
-      `)
-    }
-    if (warnings.length) {
-      sections.push(`
-        <div class="card" style="border-color: rgba(239, 68, 68, .35); background: rgba(239, 68, 68, .06)">
-          <div class="muted" style="margin-bottom:8px; color:#ef4444">Alertas</div>
-          ${bullets(warnings)}
-        </div>
-      `)
-    }
-    if (prItems.length) {
-      sections.push(`
-        <div class="card">
-          <div class="muted" style="margin-bottom:8px">PRs</div>
-          <ul style="margin:10px 0 0; padding-left: 18px; display:grid; gap: 6px">${prItems.join('')}</ul>
-        </div>
-      `)
-    }
-    if (progItems.length) {
-      sections.push(`
-        <div class="card">
-          <div class="muted" style="margin-bottom:8px">Progressão Sugerida</div>
-          <ul style="margin:10px 0 0; padding-left: 18px; display:grid; gap: 6px">${progItems.join('')}</ul>
-        </div>
-      `)
-    }
-
-    if (!sections.length) return ''
-    return `
-      <div style="margin: 10px 0 26px; page-break-inside: avoid">
-        <div class="muted" style="margin-bottom:10px">Análise Inteligente</div>
-        <div class="grid-2">${sections.join('')}</div>
-      </div>
-    `
-  }
-
-  const buildBikeCards = () => {
-    const bike = reportData?.outdoorBike && typeof reportData.outdoorBike === 'object' ? reportData.outdoorBike : null
-    if (!bike) return ''
-    const km = Number(bike?.distanceKm)
-    const dur = Number(bike?.durationSeconds)
-    const avg = Number(bike?.avgSpeedKmh)
-    const max = Number(bike?.maxSpeedKmh)
-    if ((!Number.isFinite(km) || km <= 0) && (!Number.isFinite(dur) || dur <= 0)) return ''
-    const formatKmh = (v) => (Number.isFinite(Number(v)) && Number(v) > 0 ? `${Number(v).toFixed(1)} km/h` : '-')
-    return `
-      <div style="margin: 12px 0 24px">
-        <div class="muted" style="margin-bottom:8px">Bike Outdoor</div>
-        <div class="stats" style="grid-template-columns:repeat(4,1fr); margin-bottom:0">
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Distância</div>
-            <div style="font-size:20px; font-family: ui-monospace; font-weight:800">${Number.isFinite(km) && km > 0 ? `${km.toFixed(2)} km` : '-'}</div>
-          </div>
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Vel. Média</div>
-            <div style="font-size:20px; font-family: ui-monospace; font-weight:800">${formatKmh(avg)}</div>
-          </div>
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Vel. Máx</div>
-            <div style="font-size:20px; font-family: ui-monospace; font-weight:800">${formatKmh(max)}</div>
-          </div>
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Tempo Bike</div>
-            <div style="font-size:20px; font-family: ui-monospace; font-weight:800">${formatDuration(dur || 0)}</div>
-          </div>
-        </div>
-      </div>
-    `
-  }
-
-  const exercisesHtml = (Array.isArray(reportData?.exercises) ? reportData.exercises : []).map((ex, exIdx) => {
-    const sets = Array.isArray(ex?.sets) ? ex.sets : []
-    if (!sets.length) return ''
-    const showProgression = !!ex?.showProgression
-    const baseText = ex?.baseLabel ? String(ex.baseLabel) : ''
-    const method = ex?.method ? String(ex.method) : ''
-    const rpe = ex?.rpe != null ? String(ex.rpe) : ''
-
-    const rows = sets.map((set) => {
-      const tag = set?.tag ? String(set.tag) : ''
-      const tagHtml = tag ? `<span style="margin-left:4px; font-size:10px; color:#a3a3a3">(${escapeHtml(tag)})</span>` : ''
-      const note = set?.note ? String(set.note) : ''
-      const weight = set?.weight ?? '-'
-      const reps = set?.reps ?? '-'
-      const cadence = set?.cadence ?? '-'
-      const prog = set?.progression && typeof set.progression === 'object' ? set.progression : null
-      const progText = prog?.deltaText ? String(prog.deltaText) : '-'
-      const direction = prog?.direction ? String(prog.direction) : ''
-      const progClass =
-        direction === 'up'
-          ? 'color:#22c55e; font-weight:900; background: rgba(34,197,94,.12); border: 1px solid rgba(34,197,94,.22)'
-          : direction === 'down'
-            ? 'color:#ef4444; font-weight:900; background: rgba(239,68,68,.10); border: 1px solid rgba(239,68,68,.20)'
-            : 'color:#e5e7eb; font-weight:900; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10)'
-
-      let rowHtml = `
-        <tr style="border-bottom:1px solid #262626">
-          <td style="padding:12px; font-family: ui-monospace; color:#a3a3a3">#${escapeHtml(set?.index || '')}${tagHtml}</td>
-          <td style="padding:12px; text-align:center; font-weight:800; font-size:16px; color:#f5f5f5">${escapeHtml(weight)}</td>
-          <td style="padding:12px; text-align:center; font-family: ui-monospace; color:#e5e7eb">${escapeHtml(reps)}</td>
-          <td style="padding:12px; text-align:center; font-family: ui-monospace; color:#e5e7eb">${escapeHtml(cadence)}</td>
-          ${showProgression ? `<td style="padding:10px 12px; text-align:center; font-size:12px; text-transform:uppercase; border-radius:999px; ${progClass}">${escapeHtml(progText)}</td>` : ''}
-        </tr>`
-
-      if (note) {
-        const colSpan = showProgression ? 5 : 4
-        rowHtml += `
-        <tr>
-          <td colspan="${colSpan}" style="padding:8px 12px; font-size:12px; color:#d4d4d4; background: rgba(255,255,255,.04)">Obs: ${escapeHtml(note)}</td>
-        </tr>`
-      }
-      return rowHtml
-    }).join('')
-
-    return `
-      <div style="page-break-inside: avoid; margin-bottom:24px">
-        <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:8px; border-bottom:2px solid #262626; padding-bottom:8px">
-          <h3 style="font-size:18px; font-weight:800; text-transform:uppercase; display:flex; align-items:center; gap:8px">
-            <span style="background:#f59e0b; color:#0b0b0c; width:24px; height:24px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; font-size:12px">${exIdx + 1}</span>
-            ${escapeHtml(ex?.name || '')}
-          </h3>
-          <div style="display:flex; gap:12px; font-size:12px; font-family: ui-monospace; color:#a3a3a3">
-            ${baseText ? `<span>${escapeHtml(baseText)}</span>` : ''}
-            ${method ? `<span style="color:#ef4444; font-weight:900; text-transform:uppercase">${escapeHtml(method)}</span>` : ''}
-            ${rpe ? `<span>RPE: <span style="font-weight:900; color:#f5f5f5">${escapeHtml(rpe)}</span></span>` : ''}
-          </div>
-        </div>
-        <table style="width:100%; font-size:14px; border-collapse:collapse">
-          <thead>
-            <tr style="color:#e5e7eb; border-bottom:1px solid #262626">
-              <th style="padding:8px; text-align:left; width:64px; border-bottom:1px solid #262626">Série</th>
-              <th style="padding:8px; text-align:center; width:96px; border-bottom:1px solid #262626">Carga</th>
-              <th style="padding:8px; text-align:center; width:96px; border-bottom:1px solid #262626">Reps</th>
-              <th style="padding:8px; text-align:center; width:80px; border-bottom:1px solid #262626">Cad</th>
-              ${showProgression ? `<th style="padding:8px; text-align:center; width:128px; border-bottom:1px solid #262626">Evolução</th>` : ''}
-            </tr>
-          </thead>
-          <tbody>${rows}</tbody>
-        </table>
-      </div>
-    `
-  }).filter(Boolean).join('')
-
-  const logoUrl = String(reportData?.brand?.logoUrl || '')
-  const aiSectionHtml = buildAiSection()
-  const workoutTitleSafe = escapeHtml(reportData?.session?.workoutTitle || 'Treino')
-  const studentNameSafe = escapeHtml(reportData?.athlete?.name || '')
-
-  return `<!doctype html>
-  <html>
-    <head>
-      <meta charset="utf-8" />
-      <meta name="viewport" content="width=device-width, initial-scale=1" />
-      <title>Relatório IronTracks</title>
-      <style>
-        * { box-sizing: border-box; }
-        body {
-          background: #0a0a0a;
-          color: #fafafa;
-          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
-          margin: 0;
-          line-height: 1.35;
-        }
-        img { max-width: 100%; height: auto; }
-        .container { max-width: 880px; margin: 0 auto; padding: 28px; }
-        .header {
-          border-bottom: 1px solid #262626;
-          padding-bottom: 20px;
-          margin-bottom: 24px;
-          display: flex;
-          justify-content: space-between;
-          align-items: flex-end;
-          gap: 16px;
-          flex-wrap: wrap;
-        }
-        .brand { font-size: 34px; font-weight: 900; font-style: italic; letter-spacing: -0.03em; line-height: 1; }
-        .muted { color: #a3a3a3; font-weight: 800; text-transform: uppercase; letter-spacing: .18em; font-size: 11px; }
-        .card {
-          background: #171717;
-          border: 1px solid #262626;
-          border-radius: 14px;
-          padding: 16px;
-          box-shadow: 0 1px 0 rgba(0,0,0,.35);
-          break-inside: avoid;
-          page-break-inside: avoid;
-        }
-        .card-accent { background: rgba(245, 158, 11, .08); border-color: rgba(245, 158, 11, .35); }
-        .card-accent .muted { color: #f59e0b; }
-        .card-invert { background: #000; border-color: #262626; color: #fff; }
-        .card-invert .muted { color: #a3a3a3; }
-        .value {
-          font-size: clamp(20px, 5.6vw, 28px);
-          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
-          font-weight: 800;
-          line-height: 1.05;
-          overflow-wrap: anywhere;
-        }
-        .value-accent { color: #f59e0b; }
-        .value-row { display: flex; align-items: baseline; gap: 8px; flex-wrap: wrap; min-width: 0; }
-        .unit { font-size: 12px; font-weight: 900; color: #a3a3a3; text-transform: uppercase; letter-spacing: .08em; }
-        .stats {
-          display: grid;
-          grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
-          gap: 14px;
-          margin-bottom: 22px;
-        }
-        .grid-2 {
-          display: grid;
-          grid-template-columns: repeat(2, minmax(0, 1fr));
-          gap: 14px;
-        }
-        table { width: 100%; border-collapse: collapse; }
-        thead { display: table-header-group; }
-        tr { break-inside: avoid; page-break-inside: avoid; }
-        @media (max-width: 520px) {
-          .container { padding: 16px; }
-          .brand { font-size: 30px; }
-          .header { padding-bottom: 16px; margin-bottom: 18px; }
-          .stats { grid-template-columns: repeat(2, minmax(0, 1fr)); }
-          .grid-2 { grid-template-columns: 1fr; }
-        }
-        @media print {
-          @page { size: auto; margin: 12mm; }
-          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
-          .container { max-width: none; padding: 0; }
-          .no-print { display: none !important; }
-        }
-      </style>
-    </head>
-    <body>
-      <div class="container">
-        <div class="header">
-          <div style="display:flex; align-items:flex-end; gap:12px">
-            <img src="${logoUrl}" alt="IronTracks" style="width:40px; height:40px; border-radius:10px; object-fit:contain; border:1px solid rgba(245,158,11,.55); background:#000" />
-            <div>
-              <div class="brand">IRONTRACKS</div>
-              <div class="muted">Relatório de Performance</div>
-            </div>
-          </div>
-          <div style="text-align:right">
-            <div style="font-size:20px; font-weight:900; color:#fafafa">${workoutTitleSafe}</div>
-            <div style="color:#a3a3a3">${escapeHtml(formatDate(session?.date))}</div>
-            ${studentNameSafe ? `<div style="color:#a3a3a3; font-size:12px; text-transform:uppercase; letter-spacing:.08em">Aluno: <span style="color:#fafafa; font-weight:900">${studentNameSafe}</span></div>` : ''}
-          </div>
-        </div>
-
-        <div class="stats">
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Tempo Total</div>
-            <div class="value">${formatDuration(reportData?.session?.totalTimeSeconds || 0)}</div>
-          </div>
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Tempo Real</div>
-            <div class="value">${formatDuration(reportData?.session?.realTimeSeconds || 0)}</div>
-          </div>
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Séries</div>
-            <div class="value-row">
-              <span class="value">${Number(reportData?.summaryMetrics?.setsLoggedCount || 0).toLocaleString('pt-BR')}</span>
-              <span class="unit">sets</span>
-              <span style="font-size:12px; font-weight:900; color:#a3a3a3">${Number(reportData?.summaryMetrics?.exercisesLoggedCount || 0).toLocaleString('pt-BR')} ex</span>
-            </div>
-          </div>
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Volume (Kg)</div>
-            <div class="value-row">
-              <span class="value">${Number(reportData?.summaryMetrics?.volumeTotal || 0).toLocaleString('pt-BR')}</span>
-              <span class="unit">kg</span>
-              ${reportData?.summaryMetrics?.volumeDeltaPctVsPrev != null ? `<span style="font-size:12px; font-weight:900; color:${Number(reportData.summaryMetrics.volumeDeltaPctVsPrev) >= 0 ? '#22c55e' : '#ef4444'}">${Number(reportData.summaryMetrics.volumeDeltaPctVsPrev) > 0 ? '+' : ''}${escapeHtml(volumeDeltaStr)}%</span>` : ''}
-            </div>
-          </div>
-          <div class="card card-accent">
-            <div class="muted" style="margin-bottom:4px">Calorias</div>
-            <div class="value value-accent">~${Number(reportData?.summaryMetrics?.caloriesEstimate || 0) || 0}</div>
-          </div>
-          <div class="card">
-            <div class="muted" style="margin-bottom:4px">Reps</div>
-            <div class="value-row">
-              <span class="value">${Number(reportData?.summaryMetrics?.repsTotal || 0).toLocaleString('pt-BR')}</span>
-              <span class="unit">reps</span>
-              ${Number(reportData?.summaryMetrics?.topWeight || 0) > 0 ? `<span style="font-size:12px; font-weight:900; color:#a3a3a3">Top: ${Number(reportData?.summaryMetrics?.topWeight || 0).toLocaleString('pt-BR')}kg</span>` : ''}
-            </div>
-          </div>
-          <div class="card card-invert">
-            <div class="muted" style="margin-bottom:4px">Status</div>
-            <div style="font-size:16px; font-weight:800; text-transform:uppercase; font-style:italic">Concluído</div>
-          </div>
-        </div>
-
-        ${buildBikeCards()}
-
-        ${aiSectionHtml}
-
-        ${exercisesHtml}
-
-        <div style="margin-top:32px; padding-top:16px; border-top:1px solid #262626; text-align:center; font-size:12px; color:#a3a3a3; text-transform:uppercase; letter-spacing:.2em">IronTracks System</div>
-      </div>
-    </body>
-  </html>`
-}
diff --git a/_archive/duplicates/src/utils/report/buildPeriodReportHtml 2.js b/_archive/duplicates/src/utils/report/buildPeriodReportHtml 2.js
deleted file mode 100644
index 0bbd21f..0000000
--- a/_archive/duplicates/src/utils/report/buildPeriodReportHtml 2.js	
+++ /dev/null
@@ -1,266 +0,0 @@
-const escapeHtml = (v) => {
-  try {
-    return String(v ?? '')
-      .replaceAll('&', '&amp;')
-      .replaceAll('<', '&lt;')
-      .replaceAll('>', '&gt;')
-      .replaceAll('"', '&quot;')
-      .replaceAll("'", '&#39;')
-  } catch {
-    return ''
-  }
-}
-
-const formatDate = (v) => {
-  try {
-    if (!v) return ''
-    const d = v?.toDate ? v.toDate() : new Date(v)
-    if (!(d instanceof Date) || Number.isNaN(d.getTime())) return ''
-    return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' })
-  } catch {
-    return ''
-  }
-}
-
-const formatDateTime = (v) => {
-  try {
-    if (!v) return ''
-    const d = v?.toDate ? v.toDate() : new Date(v)
-    if (!(d instanceof Date) || Number.isNaN(d.getTime())) return ''
-    return d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
-  } catch {
-    return ''
-  }
-}
-
-const safeNumber = (n, fallback = 0) => {
-  const v = Number(n)
-  return Number.isFinite(v) ? v : fallback
-}
-
-const toLocaleInt = (n) => {
-  const v = Math.max(0, Math.round(safeNumber(n, 0)))
-  return v.toLocaleString('pt-BR')
-}
-
-const toPeriodLabel = (type) => (type === 'week' ? 'Relatório semanal' : type === 'month' ? 'Relatório mensal' : 'Relatório do período')
-
-const toPeriodSubtitle = (type) => (type === 'week' ? 'Últimos 7 dias' : type === 'month' ? 'Últimos 30 dias' : 'Período selecionado')
-
-const inferRange = (stats) => {
-  try {
-    const list = Array.isArray(stats?.sessionSummaries) ? stats.sessionSummaries : []
-    const ms = list
-      .map((s) => {
-        const d = s?.date
-        const t = d?.toDate ? d.toDate() : new Date(d)
-        const value = t instanceof Date ? t.getTime() : NaN
-        return Number.isFinite(value) ? value : null
-      })
-      .filter((x) => x != null)
-    const days = safeNumber(stats?.days, 0)
-    const now = Date.now()
-    if (!ms.length) {
-      const start = days > 0 ? new Date(now - days * 24 * 60 * 60 * 1000) : new Date(now)
-      return { start, end: new Date(now) }
-    }
-    const min = Math.min(...ms)
-    const max = Math.max(...ms)
-    return { start: new Date(min), end: new Date(max) }
-  } catch {
-    const now = Date.now()
-    return { start: new Date(now), end: new Date(now) }
-  }
-}
-
-export function buildPeriodReportHtml(input) {
-  const data = input && typeof input === 'object' ? input : {}
-  const type = String(data.type || '').trim()
-  const stats = data.stats && typeof data.stats === 'object' ? data.stats : {}
-  const ai = data.ai && typeof data.ai === 'object' ? data.ai : null
-  const baseUrl = String(data.baseUrl || '').trim()
-  const userName = String(data.userName || '').trim()
-  const generatedAt = data.generatedAt ? data.generatedAt : new Date()
-
-  const title = toPeriodLabel(type)
-  const subtitle = toPeriodSubtitle(type)
-  const range = inferRange(stats)
-  const rangeLabel = `${formatDate(range.start)} – ${formatDate(range.end)}`
-  const generatedLabel = formatDateTime(generatedAt)
-  const logoSrc = baseUrl ? `${baseUrl.replace(/\/$/, '')}/icone.png` : ''
-
-  const metricCards = [
-    { label: 'Treinos', value: toLocaleInt(stats?.count) },
-    { label: 'Tempo total (min)', value: toLocaleInt(stats?.totalMinutes) },
-    { label: 'Média por treino (min)', value: toLocaleInt(stats?.avgMinutes) },
-    { label: 'Volume total (kg)', value: toLocaleInt(stats?.totalVolumeKg) },
-    { label: 'Volume médio/treino (kg)', value: toLocaleInt(stats?.avgVolumeKg) },
-    { label: 'Sets totais', value: toLocaleInt(stats?.totalSets) },
-    { label: 'Reps totais', value: toLocaleInt(stats?.totalReps) },
-    { label: 'Dias treinados', value: toLocaleInt(stats?.uniqueDaysCount) },
-  ]
-
-  const listByVol = (Array.isArray(stats?.topExercisesByVolume) ? stats.topExercisesByVolume : []).slice(0, 8)
-  const listByFreq = (Array.isArray(stats?.topExercisesByFrequency) ? stats.topExercisesByFrequency : []).slice(0, 8)
-  const sessions = (Array.isArray(stats?.sessionSummaries) ? stats.sessionSummaries : []).slice(0, 60)
-
-  const aiList = (key) => {
-    const arr = ai && Array.isArray(ai?.[key]) ? ai[key] : []
-    return arr.map((x) => String(x || '').trim()).filter(Boolean).slice(0, 10)
-  }
-
-  const aiSummary = aiList('summary')
-  const aiHighlights = aiList('highlights')
-  const aiFocus = aiList('focus')
-  const aiNextSteps = aiList('nextSteps')
-  const aiWarnings = aiList('warnings')
-
-  const section = (label, content) => {
-    if (!content) return ''
-    return `<div class="section"><div class="section-title">${escapeHtml(label)}</div>${content}</div>`
-  }
-
-  const listSection = (label, items, tone = 'neutral') => {
-    const list = Array.isArray(items) ? items : []
-    if (!list.length) return ''
-    const cls = tone === 'warn' ? 'list warn' : tone === 'accent' ? 'list accent' : 'list'
-    return section(
-      label,
-      `<ul class="${cls}">${list.map((x) => `<li>${escapeHtml(x)}</li>`).join('')}</ul>`
-    )
-  }
-
-  const topExercisesTable = (label, rows) => {
-    const list = Array.isArray(rows) ? rows : []
-    if (!list.length) return ''
-    const body = list
-      .map((r) => {
-        const name = escapeHtml(r?.name || 'Exercício')
-        const sets = toLocaleInt(r?.sets)
-        const sessionsCount = toLocaleInt(r?.sessionsCount)
-        const vol = toLocaleInt(r?.volumeKg)
-        return `<tr><td class="name">${name}</td><td>${sets}</td><td>${sessionsCount}</td><td class="mono">${vol}</td></tr>`
-      })
-      .join('')
-    return section(
-      label,
-      `<table class="table"><thead><tr><th>Exercício</th><th>Sets</th><th>Sessões</th><th>Volume (kg)</th></tr></thead><tbody>${body}</tbody></table>`
-    )
-  }
-
-  const sessionsTable = () => {
-    if (!sessions.length) return ''
-    const body = sessions
-      .slice()
-      .sort((a, b) => {
-        const ta = new Date(a?.date || 0).getTime()
-        const tb = new Date(b?.date || 0).getTime()
-        return tb - ta
-      })
-      .map((s) => {
-        const date = escapeHtml(formatDate(s?.date) || '')
-        const minutes = toLocaleInt(s?.minutes)
-        const vol = toLocaleInt(s?.volumeKg)
-        return `<tr><td class="mono">${date}</td><td class="mono">${minutes}</td><td class="mono">${vol}</td></tr>`
-      })
-      .join('')
-    return section(
-      'Sessões do período',
-      `<table class="table"><thead><tr><th>Data</th><th>Duração (min)</th><th>Volume (kg)</th></tr></thead><tbody>${body}</tbody></table>`
-    )
-  }
-
-  const cards = metricCards
-    .map((m) => `<div class="card"><div class="card-label">${escapeHtml(m.label)}</div><div class="card-value mono">${escapeHtml(m.value)}</div></div>`)
-    .join('')
-
-  const insights =
-    listSection('Resumo (IA)', aiSummary, 'accent') +
-    listSection('Destaques', aiHighlights) +
-    listSection('Foco', aiFocus) +
-    listSection('Próximos passos', aiNextSteps) +
-    listSection('Atenções', aiWarnings, 'warn')
-
-  const owner = userName ? ` • ${escapeHtml(userName)}` : ''
-
-  return `<!doctype html>
-<html lang="pt-BR">
-  <head>
-    <meta charset="utf-8" />
-    <meta name="viewport" content="width=device-width, initial-scale=1" />
-    <title>${escapeHtml(title)} • IRONTRACKS</title>
-    <style>
-      *{box-sizing:border-box}
-      body{margin:0;background:#ffffff;color:#0b0b0c;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.35}
-      .page{max-width:980px;margin:0 auto;padding:28px}
-      .header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;flex-wrap:wrap;border-bottom:3px solid #0b0b0c;padding-bottom:18px;margin-bottom:18px}
-      .brand{display:flex;align-items:center;gap:12px}
-      .brand-logo{width:34px;height:34px;border-radius:9px;object-fit:cover;border:1px solid #e5e7eb;background:#fff}
-      .brand-name{font-weight:900;font-size:28px;letter-spacing:-1px;line-height:1}
-      .brand-name .muted{color:#6b7280;font-style:italic}
-      .pill{display:inline-flex;align-items:center;gap:8px;font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.16em;color:#0b0b0c;background:#facc15;border:1px solid rgba(0,0,0,.15);padding:6px 10px;border-radius:999px}
-      .meta{font-size:12px;color:#6b7280;font-weight:700}
-      .title{font-size:20px;font-weight:900;margin:0}
-      .range{font-size:12px;color:#111827;font-weight:800}
-      .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:14px}
-      .card{background:#f7f7f8;border:1px solid #e5e7eb;border-radius:14px;padding:12px;break-inside:avoid;page-break-inside:avoid}
-      .card-label{font-size:10px;text-transform:uppercase;letter-spacing:.16em;color:#6b7280;font-weight:900}
-      .card-value{font-size:18px;font-weight:900;color:#0b0b0c;margin-top:6px}
-      .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace}
-      .section{margin-top:16px;break-inside:avoid;page-break-inside:avoid}
-      .section-title{font-size:11px;text-transform:uppercase;letter-spacing:.18em;color:#6b7280;font-weight:900;margin-bottom:8px}
-      .table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #eef2f7;border-radius:12px;overflow:hidden}
-      thead{display:table-header-group}
-      th,td{border-bottom:1px solid #eef2f7;padding:10px 8px;text-align:left;font-size:12px;vertical-align:top}
-      th{color:#6b7280;text-transform:uppercase;font-weight:900;font-size:10px;letter-spacing:.16em;background:#fafafa}
-      td.name{font-weight:800;color:#111827}
-      tr{break-inside:avoid;page-break-inside:avoid}
-      .list{margin:0;padding-left:16px;color:#111827}
-      .list li{margin:6px 0;font-size:12px}
-      .list.accent li{color:#0b0b0c}
-      .list.warn li{color:#a16207}
-      .two-col{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
-      .footer{margin-top:18px;padding-top:12px;border-top:1px solid #e5e7eb;text-align:center;font-size:11px;color:#6b7280;text-transform:uppercase;letter-spacing:.18em}
-      @media (max-width:920px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}.two-col{grid-template-columns:1fr}}
-      @media print{
-        @page{size:A4;margin:12mm}
-        body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
-        .page{max-width:none;padding:0}
-      }
-    </style>
-  </head>
-  <body>
-    <div class="page">
-      <div class="header">
-        <div>
-          <div class="brand">
-            ${logoSrc ? `<img class="brand-logo" src="${escapeHtml(logoSrc)}" alt="IRONTRACKS" />` : ''}
-            <div>
-              <div class="brand-name">IRON<span class="muted">TRACKS</span></div>
-              <div class="meta">${escapeHtml(subtitle)} • ${escapeHtml(rangeLabel)}${owner}</div>
-            </div>
-          </div>
-          <div style="margin-top:10px">
-            <span class="pill">${escapeHtml(title)}</span>
-          </div>
-        </div>
-        <div style="text-align:right">
-          <div class="title">${escapeHtml(title)}</div>
-          <div class="range">${escapeHtml(rangeLabel)}</div>
-          <div class="meta">Gerado em: ${escapeHtml(generatedLabel)}</div>
-        </div>
-      </div>
-
-      <div class="grid">${cards}</div>
-
-      ${topExercisesTable('Top exercícios (por volume)', listByVol)}
-      ${topExercisesTable('Top exercícios (por frequência)', listByFreq)}
-      ${sessionsTable()}
-
-      ${insights ? section('Insights', `<div class="two-col">${insights}</div>`) : ''}
-
-      <div class="footer">IRONTRACKS • ${escapeHtml(generatedLabel)}</div>
-    </div>
-  </body>
-</html>`
-}
diff --git a/_archive/duplicates/src/utils/report/templates 2.js b/_archive/duplicates/src/utils/report/templates 2.js
deleted file mode 100644
index fb6acfd..0000000
--- a/_archive/duplicates/src/utils/report/templates 2.js	
+++ /dev/null
@@ -1,92 +0,0 @@
-export function workoutPlanHtml(workout, user) {
-  const title = workout?.title || 'Treino'
-  const exs = Array.isArray(workout?.exercises) ? workout.exercises : []
-  const dateStr = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' })
-  const owner = user?.displayName || user?.email || ''
-
-  const rows = exs.map((ex, idx) => {
-    const sets = Number(ex?.sets || 0)
-    const reps = ex?.reps || '-'
-    const method = ex?.method || 'Normal'
-    const cadence = ex?.cadence || '-'
-    const rpe = ex?.rpe || '-'
-    const notes = ex?.notes || ''
-    return `
-      <div class="card">
-        <div class="card-head">
-          <div class="badge">${idx + 1}</div>
-          <h3>${ex?.name || ''}</h3>
-          <div class="meta">Método: <b>${method}</b> • Reps: <b>${reps}</b> • Cad: <b>${cadence}</b> • RPE: <b>${rpe}</b></div>
-        </div>
-        ${notes ? `<p class="notes">${notes}</p>` : ''}
-        <table>
-          <thead>
-            <tr><th>Série</th><th>Reps</th><th>Descanso</th></tr>
-          </thead>
-          <tbody>
-            ${Array.from({ length: sets }).map((_, sIdx) => `<tr><td>#${sIdx + 1}</td><td>${reps}</td><td>${ex?.restTime ? `${parseInt(ex.restTime)}s` : '-'}</td></tr>`).join('')}
-          </tbody>
-        </table>
-      </div>
-    `
-  }).join('')
-
-  return `<!doctype html>
-  <html lang="pt-BR">
-    <head>
-      <meta charset="utf-8" />
-      <meta name="viewport" content="width=device-width, initial-scale=1" />
-      <title>${title} • Ficha de Treino</title>
-      <style>
-        *{box-sizing:border-box}
-        body{margin:0;background:#fff;color:#0b0b0c;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.35}
-        .container{max-width:880px;margin:0 auto;padding:28px}
-        .header{display:flex;justify-content:space-between;align-items:flex-end;gap:16px;flex-wrap:wrap;border-bottom:3px solid #0b0b0c;padding-bottom:20px;margin-bottom:24px}
-        .brand{font-weight:900;font-size:34px;letter-spacing:-1px;line-height:1}
-        .brand .muted{color:#6b7280;font-style:italic}
-        .subtitle{font-size:11px;text-transform:uppercase;color:#6b7280;font-weight:800;letter-spacing:.18em}
-        .title{font-size:20px;font-weight:900;word-break:break-word}
-        .date{font-size:12px;color:#6b7280}
-        .card{background:#f7f7f8;border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 1px 0 rgba(0,0,0,.06);break-inside:avoid;page-break-inside:avoid}
-        .card-head{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
-        .badge{background:#0b0b0c;color:#fff;border-radius:8px;min-width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;font-size:12px}
-        .card-head h3{margin:0;display:flex;align-items:center;gap:10px;font-size:18px;line-height:1.15;word-break:break-word}
-        .meta{font-size:12px;color:#4b5563}
-        .notes{font-size:12px;color:#111827;margin:8px 0 0}
-        table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #eef2f7;border-radius:12px;overflow:hidden}
-        thead{display:table-header-group}
-        th,td{border-bottom:1px solid #eef2f7;padding:10px 8px;text-align:left;font-size:12px}
-        th{color:#6b7280;text-transform:uppercase;font-weight:800;font-size:10px;letter-spacing:.16em;background:#fafafa}
-        tr{break-inside:avoid;page-break-inside:avoid}
-        .footer{margin-top:26px;padding-top:12px;border-top:1px solid #e5e7eb;text-align:center;font-size:11px;color:#6b7280;text-transform:uppercase;letter-spacing:.18em}
-        @media (max-width:520px){
-          .container{padding:16px}
-          .brand{font-size:30px}
-          .header{padding-bottom:16px;margin-bottom:18px}
-          .title{font-size:18px}
-        }
-        @media print{
-          @page{size:auto;margin:12mm}
-          body{-webkit-print-color-adjust:exact;print-color-adjust:exact}
-          .container{max-width:none;padding:0}
-        }
-      </style>
-    </head>
-    <body>
-      <div class="container">
-        <div class="header">
-          <div>
-            <div class="brand">IRON<span class="muted">TRACKS</span></div>
-            <div class="subtitle">Ficha de Treino</div>
-          </div>
-          <div style="text-align:right">
-            <div class="title">${title}</div>
-            <div class="date">${dateStr}${owner ? ` • ${owner}` : ''}</div>
-          </div>
-        </div>
-        ${rows || '<p style="color:#666">Este treino não possui exercícios.</p>'}
-        <div class="footer">IronTracks System • ${dateStr}</div>
-      </div>
-    </body>
-  </html>`
-}
diff --git a/_archive/duplicates/src/utils/supabase/client 2.ts b/_archive/duplicates/src/utils/supabase/client 2.ts
deleted file mode 100644
index 934a955..0000000
--- a/_archive/duplicates/src/utils/supabase/client 2.ts	
+++ /dev/null
@@ -1,18 +0,0 @@
-import { createBrowserClient } from '@supabase/ssr'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export function createClient() {
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    throw new Error('Missing Supabase environment variables')
-  }
-  return createBrowserClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    global: {
-      headers: {
-        apikey: supabaseAnonKey,
-      },
-    },
-  })
-}
diff --git a/_archive/duplicates/src/utils/supabase/client 3.ts b/_archive/duplicates/src/utils/supabase/client 3.ts
deleted file mode 100644
index e49031f..0000000
--- a/_archive/duplicates/src/utils/supabase/client 3.ts	
+++ /dev/null
@@ -1,13 +0,0 @@
-import { createBrowserClient } from '@supabase/ssr'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export function createClient() {
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    throw new Error('Missing Supabase environment variables')
-  }
-  return createBrowserClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-  })
-}
diff --git a/_archive/duplicates/src/utils/supabase/cookieOptions 2.ts b/_archive/duplicates/src/utils/supabase/cookieOptions 2.ts
deleted file mode 100644
index b2edc2a..0000000
--- a/_archive/duplicates/src/utils/supabase/cookieOptions 2.ts	
+++ /dev/null
@@ -1,36 +0,0 @@
-import type { CookieOptions } from '@supabase/ssr'
-
-export function getSupabaseCookieOptions(): CookieOptions {
-  const nodeEnv = String(process.env.NODE_ENV || '').toLowerCase()
-  const isProd = nodeEnv === 'production'
-
-  const forcedDomain = String(process.env.SUPABASE_COOKIE_DOMAIN || '').trim()
-
-  const siteUrl = String(process.env.NEXT_PUBLIC_SITE_URL || '').trim()
-  const host = (() => {
-    try {
-      if (!siteUrl) return ''
-      return new URL(siteUrl).hostname
-    } catch {
-      return ''
-    }
-  })()
-  const isIronTracksDomain = host === 'irontracks.com.br' || host.endsWith('.irontracks.com.br')
-
-  const cookieDomain = forcedDomain ? forcedDomain : isProd && isIronTracksDomain ? '.irontracks.com.br' : undefined
-  const oneYearSeconds = 60 * 60 * 24 * 365
-  const oneYearFromNow = new Date(Date.now() + oneYearSeconds * 1000)
-
-  return {
-    domain: cookieDomain,
-    path: '/',
-    sameSite: 'lax',
-    secure: isProd,
-    ...(isProd
-      ? {
-          expires: oneYearFromNow,
-          maxAge: oneYearSeconds,
-        }
-      : {}),
-  }
-}
diff --git a/_archive/duplicates/src/utils/supabase/cookieOptions 3.ts b/_archive/duplicates/src/utils/supabase/cookieOptions 3.ts
deleted file mode 100644
index b2edc2a..0000000
--- a/_archive/duplicates/src/utils/supabase/cookieOptions 3.ts	
+++ /dev/null
@@ -1,36 +0,0 @@
-import type { CookieOptions } from '@supabase/ssr'
-
-export function getSupabaseCookieOptions(): CookieOptions {
-  const nodeEnv = String(process.env.NODE_ENV || '').toLowerCase()
-  const isProd = nodeEnv === 'production'
-
-  const forcedDomain = String(process.env.SUPABASE_COOKIE_DOMAIN || '').trim()
-
-  const siteUrl = String(process.env.NEXT_PUBLIC_SITE_URL || '').trim()
-  const host = (() => {
-    try {
-      if (!siteUrl) return ''
-      return new URL(siteUrl).hostname
-    } catch {
-      return ''
-    }
-  })()
-  const isIronTracksDomain = host === 'irontracks.com.br' || host.endsWith('.irontracks.com.br')
-
-  const cookieDomain = forcedDomain ? forcedDomain : isProd && isIronTracksDomain ? '.irontracks.com.br' : undefined
-  const oneYearSeconds = 60 * 60 * 24 * 365
-  const oneYearFromNow = new Date(Date.now() + oneYearSeconds * 1000)
-
-  return {
-    domain: cookieDomain,
-    path: '/',
-    sameSite: 'lax',
-    secure: isProd,
-    ...(isProd
-      ? {
-          expires: oneYearFromNow,
-          maxAge: oneYearSeconds,
-        }
-      : {}),
-  }
-}
diff --git a/_archive/duplicates/src/utils/supabase/middleware 2.ts b/_archive/duplicates/src/utils/supabase/middleware 2.ts
deleted file mode 100644
index 1cbca1e..0000000
--- a/_archive/duplicates/src/utils/supabase/middleware 2.ts	
+++ /dev/null
@@ -1,30 +0,0 @@
-import { createServerClient } from '@supabase/ssr'
-import { NextResponse, type NextRequest } from 'next/server'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export async function updateSession(request: NextRequest) {
-  let response = NextResponse.next({ request })
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    return response
-  }
-
-  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    cookies: {
-      getAll() {
-        return request.cookies.getAll()
-      },
-      setAll(cookiesToSet) {
-        cookiesToSet.forEach(({ name, value, options }) => {
-          response.cookies.set(name, value, { ...(options || {}) })
-        })
-      },
-    },
-  })
-
-  await supabase.auth.getUser()
-  return response
-}
diff --git a/_archive/duplicates/src/utils/supabase/middleware 3.ts b/_archive/duplicates/src/utils/supabase/middleware 3.ts
deleted file mode 100644
index 1cbca1e..0000000
--- a/_archive/duplicates/src/utils/supabase/middleware 3.ts	
+++ /dev/null
@@ -1,30 +0,0 @@
-import { createServerClient } from '@supabase/ssr'
-import { NextResponse, type NextRequest } from 'next/server'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export async function updateSession(request: NextRequest) {
-  let response = NextResponse.next({ request })
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    return response
-  }
-
-  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    cookies: {
-      getAll() {
-        return request.cookies.getAll()
-      },
-      setAll(cookiesToSet) {
-        cookiesToSet.forEach(({ name, value, options }) => {
-          response.cookies.set(name, value, { ...(options || {}) })
-        })
-      },
-    },
-  })
-
-  await supabase.auth.getUser()
-  return response
-}
diff --git a/_archive/duplicates/src/utils/supabase/server 2.ts b/_archive/duplicates/src/utils/supabase/server 2.ts
deleted file mode 100644
index 53a0dc1..0000000
--- a/_archive/duplicates/src/utils/supabase/server 2.ts	
+++ /dev/null
@@ -1,37 +0,0 @@
-import { createServerClient, type CookieOptions } from '@supabase/ssr'
-import { cookies } from 'next/headers'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export async function createClient() {
-  const cookieStore = await cookies()
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    throw new Error('Missing Supabase environment variables')
-  }
-
-  return createServerClient(
-    supabaseUrl,
-    supabaseAnonKey,
-    {
-      cookieOptions: getSupabaseCookieOptions(),
-      cookies: {
-        getAll() {
-            return cookieStore.getAll()
-        },
-        setAll(cookiesToSet) {
-            try {
-                cookiesToSet.forEach(({ name, value, options }) =>
-                    cookieStore.set(name, value, { ...(options || {}) })
-                )
-            } catch {
-                // The `setAll` method was called from a Server Component.
-                // This can be ignored if you have middleware refreshing
-                // user sessions.
-            }
-        },
-      },
-    }
-  )
-}
diff --git a/_archive/duplicates/src/utils/training/notesMethodParser 2.js b/_archive/duplicates/src/utils/training/notesMethodParser 2.js
deleted file mode 100644
index 5ec40c1..0000000
--- a/_archive/duplicates/src/utils/training/notesMethodParser 2.js	
+++ /dev/null
@@ -1,248 +0,0 @@
-import { parseTrainingNumber } from '../trainingNumber.js'
-
-const safeString = (v) => {
-  try {
-    return String(v ?? '').trim()
-  } catch {
-    return ''
-  }
-}
-
-const normalize = (v) => {
-  const s = safeString(v)
-  if (!s) return ''
-  try {
-    return s
-      .normalize('NFD')
-      .replace(/[\u0300-\u036f]/g, '')
-      .toLowerCase()
-      .replace(/[()]/g, ' ')
-      .replace(/[–—]/g, '-')
-      .replace(/[›»→]/g, '>')
-      .replace(/\s+/g, ' ')
-      .trim()
-  } catch {
-    return s.toLowerCase().replace(/\s+/g, ' ').trim()
-  }
-}
-
-const hashString = (input) => {
-  const str = safeString(input)
-  let h = 5381
-  for (let i = 0; i < str.length; i += 1) {
-    h = ((h << 5) + h) ^ str.charCodeAt(i)
-  }
-  return (h >>> 0).toString(36)
-}
-
-const range = (count) => Array.from({ length: Math.max(0, count) }).map((_, i) => i)
-
-const parseTargetIndices = ({ head, setsCount, defaultTarget }) => {
-  const s = normalize(head)
-  const nSets = Math.max(0, Math.floor(Number(setsCount) || 0))
-  if (!nSets) return []
-
-  if (s.includes('em todas') || s.includes('todas as series') || s.includes('todas series')) return range(nSets)
-
-  const lastN = (() => {
-    const m = s.match(/\bna?s?\s+(\d+)\s+ultim/)
-    if (!m) return null
-    const n = Number(m[1])
-    return Number.isFinite(n) && n > 0 ? Math.min(nSets, Math.floor(n)) : null
-  })()
-  if (lastN) return range(lastN).map((i) => nSets - lastN + i).filter((i) => i >= 0 && i < nSets)
-
-  if (s.includes('na ultima') || s.includes('na ultima serie') || s.includes('na ultima.')) return [nSets - 1]
-  if (s.includes('na primeira') || s.includes('na 1a') || s.includes('na 1ª')) return [0]
-
-  const nth = (() => {
-    const m = s.match(/\bna\s+(\d+)(?:a|ª)?\b/)
-    if (!m) return null
-    const n = Number(m[1])
-    if (!Number.isFinite(n) || n <= 0) return null
-    return Math.floor(n) - 1
-  })()
-  if (nth != null) return nth >= 0 && nth < nSets ? [nth] : []
-
-  if (defaultTarget === 'all') return range(nSets)
-  return [nSets - 1]
-}
-
-const splitDirectives = (notes) => {
-  const raw = safeString(notes)
-  if (!raw) return []
-  return raw
-    .split(/\n|;/)
-    .map((p) => safeString(p))
-    .filter(Boolean)
-}
-
-const parseSteps = (pattern) => {
-  const raw = normalize(pattern)
-  if (!raw) return []
-  return raw
-    .split('>')
-    .map((p) => safeString(p))
-    .map((p) => normalize(p))
-    .filter(Boolean)
-}
-
-const parseFirstNumber = (text) => {
-  const s = normalize(text)
-  if (!s) return null
-  const m = s.match(/(-?\d+(?:[.,]\d+)?)/)
-  if (!m) return null
-  const n = parseTrainingNumber(m[1])
-  return Number.isFinite(n) ? n : null
-}
-
-const isTimeToken = (p) => {
-  const s = normalize(p)
-  if (!s) return false
-  if (s.includes('seg') || s.includes('sec')) return true
-  if (/\b\d+(?:[.,]\d+)?\s*s\b/.test(s)) return true
-  if (/\b\d+(?:[.,]\d+)?s\b/.test(s)) return true
-  return false
-}
-
-const parseCluster = (pattern) => {
-  const steps = parseSteps(pattern)
-  if (!steps.length) return null
-  const blocks = []
-  const rests = []
-  steps.forEach((p) => {
-    const n = parseFirstNumber(p)
-    if (n == null || n <= 0) return
-    if (p.includes('rep') || (!isTimeToken(p) && !p.includes('%'))) blocks.push(n)
-    else if (isTimeToken(p)) rests.push(n)
-  })
-  if (blocks.length < 2) return null
-  const total = blocks.reduce((acc, v) => acc + (Number(v) || 0), 0)
-  const intra = rests.length ? Number(rests[0]) : 15
-  const clusterSize = Number(blocks[0]) || null
-  return {
-    plannedReps: safeString(pattern),
-    config: {
-      total_reps: Number.isFinite(total) && total > 0 ? Math.round(total) : null,
-      cluster_size: Number.isFinite(Number(clusterSize)) && Number(clusterSize) > 0 ? Math.round(Number(clusterSize)) : null,
-      intra_rest_sec: Number.isFinite(Number(intra)) && Number(intra) > 0 ? Math.round(Number(intra)) : 15,
-    },
-  }
-}
-
-const parseRestPauseLike = ({ pattern, label }) => {
-  const steps = parseSteps(pattern)
-  if (!steps.length) return null
-  const blocksCount = steps.filter((p) => p.includes('falha') || p.includes('failure') || (parseFirstNumber(p) != null && !p.includes('%'))).length
-  if (blocksCount < 2) return null
-
-  const restSec = (() => {
-    for (const p of steps) {
-      if (!isTimeToken(p)) continue
-      const n = parseFirstNumber(p)
-      if (n != null && n > 0) return Math.round(n)
-    }
-    return label === 'SST' ? 10 : 15
-  })()
-
-  return {
-    config: {
-      mini_sets: Math.max(1, blocksCount - 1),
-      rest_time_sec: Math.max(1, restSec),
-    },
-  }
-}
-
-const parseDropSet = (pattern) => {
-  const steps = parseSteps(pattern)
-  if (!steps.length) return null
-  const stages = []
-  steps.forEach((p) => {
-    if (p.includes('falha') || p.includes('failure')) {
-      stages.push({ weight: null, reps: 'Falha' })
-      return
-    }
-    if (p.includes('%')) return
-    const repsN = parseFirstNumber(p)
-    if (repsN != null && repsN > 0) {
-      stages.push({ weight: null, reps: String(Math.round(repsN)) })
-    }
-  })
-  if (stages.length < 2) return null
-  return { config: stages }
-}
-
-const detectMethod = (headRaw) => {
-  const head = normalize(headRaw)
-  if (!head) return null
-  if (head.includes('cluster')) return { kind: 'cluster', label: 'Cluster', defaultTarget: 'all' }
-  if (head.includes('sst')) return { kind: 'sst', label: 'SST', defaultTarget: 'last' }
-  if (head.includes('rest-p') || head.includes('rest p') || head.includes('restpause') || head.includes('rest pause')) {
-    return { kind: 'rest_pause', label: 'Rest-P', defaultTarget: 'last' }
-  }
-  if (head.includes('drop-set') || head.includes('dropset') || head.includes('drop set') || head === 'drop' || head.startsWith('drop ')) {
-    return { kind: 'drop_set', label: 'Drop', defaultTarget: 'last' }
-  }
-  return null
-}
-
-export function parseExerciseNotesToSetOverrides({ notes, setsCount }) {
-  const directives = splitDirectives(notes)
-  const nSets = Math.max(0, Math.floor(Number(setsCount) || 0))
-  const overrides = Array.from({ length: nSets }).map(() => null)
-  if (!directives.length || !nSets) return { overrides, hash: hashString(notes) }
-
-  directives.forEach((raw) => {
-    const idx = raw.indexOf(':')
-    if (idx < 0) return
-    const head = raw.slice(0, idx)
-    const pattern = raw.slice(idx + 1)
-    const detected = detectMethod(head)
-    if (!detected) return
-    const targets = parseTargetIndices({ head, setsCount: nSets, defaultTarget: detected.defaultTarget })
-    if (!targets.length) return
-
-    if (detected.kind === 'cluster') {
-      const parsed = parseCluster(pattern)
-      if (!parsed) return
-      targets.forEach((setIdx) => {
-        overrides[setIdx] = {
-          kind: 'cluster',
-          label: detected.label,
-          plannedReps: parsed.plannedReps,
-          advanced_config: parsed.config,
-        }
-      })
-      return
-    }
-
-    if (detected.kind === 'rest_pause' || detected.kind === 'sst') {
-      const parsed = parseRestPauseLike({ pattern, label: detected.kind === 'sst' ? 'SST' : 'Rest-P' })
-      if (!parsed) return
-      targets.forEach((setIdx) => {
-        overrides[setIdx] = {
-          kind: detected.kind,
-          label: detected.kind === 'sst' ? 'SST' : 'Rest-P',
-          plannedReps: safeString(pattern),
-          advanced_config: parsed.config,
-        }
-      })
-      return
-    }
-
-    if (detected.kind === 'drop_set') {
-      const parsed = parseDropSet(pattern)
-      if (!parsed) return
-      targets.forEach((setIdx) => {
-        overrides[setIdx] = {
-          kind: 'drop_set',
-          label: 'Drop',
-          plannedReps: safeString(pattern),
-          advanced_config: parsed.config,
-        }
-      })
-    }
-  })
-
-  return { overrides, hash: hashString(notes) }
-}
diff --git a/_archive/duplicates/src/utils/training/notesMethodParser 3.js b/_archive/duplicates/src/utils/training/notesMethodParser 3.js
deleted file mode 100644
index 5ec40c1..0000000
--- a/_archive/duplicates/src/utils/training/notesMethodParser 3.js	
+++ /dev/null
@@ -1,248 +0,0 @@
-import { parseTrainingNumber } from '../trainingNumber.js'
-
-const safeString = (v) => {
-  try {
-    return String(v ?? '').trim()
-  } catch {
-    return ''
-  }
-}
-
-const normalize = (v) => {
-  const s = safeString(v)
-  if (!s) return ''
-  try {
-    return s
-      .normalize('NFD')
-      .replace(/[\u0300-\u036f]/g, '')
-      .toLowerCase()
-      .replace(/[()]/g, ' ')
-      .replace(/[–—]/g, '-')
-      .replace(/[›»→]/g, '>')
-      .replace(/\s+/g, ' ')
-      .trim()
-  } catch {
-    return s.toLowerCase().replace(/\s+/g, ' ').trim()
-  }
-}
-
-const hashString = (input) => {
-  const str = safeString(input)
-  let h = 5381
-  for (let i = 0; i < str.length; i += 1) {
-    h = ((h << 5) + h) ^ str.charCodeAt(i)
-  }
-  return (h >>> 0).toString(36)
-}
-
-const range = (count) => Array.from({ length: Math.max(0, count) }).map((_, i) => i)
-
-const parseTargetIndices = ({ head, setsCount, defaultTarget }) => {
-  const s = normalize(head)
-  const nSets = Math.max(0, Math.floor(Number(setsCount) || 0))
-  if (!nSets) return []
-
-  if (s.includes('em todas') || s.includes('todas as series') || s.includes('todas series')) return range(nSets)
-
-  const lastN = (() => {
-    const m = s.match(/\bna?s?\s+(\d+)\s+ultim/)
-    if (!m) return null
-    const n = Number(m[1])
-    return Number.isFinite(n) && n > 0 ? Math.min(nSets, Math.floor(n)) : null
-  })()
-  if (lastN) return range(lastN).map((i) => nSets - lastN + i).filter((i) => i >= 0 && i < nSets)
-
-  if (s.includes('na ultima') || s.includes('na ultima serie') || s.includes('na ultima.')) return [nSets - 1]
-  if (s.includes('na primeira') || s.includes('na 1a') || s.includes('na 1ª')) return [0]
-
-  const nth = (() => {
-    const m = s.match(/\bna\s+(\d+)(?:a|ª)?\b/)
-    if (!m) return null
-    const n = Number(m[1])
-    if (!Number.isFinite(n) || n <= 0) return null
-    return Math.floor(n) - 1
-  })()
-  if (nth != null) return nth >= 0 && nth < nSets ? [nth] : []
-
-  if (defaultTarget === 'all') return range(nSets)
-  return [nSets - 1]
-}
-
-const splitDirectives = (notes) => {
-  const raw = safeString(notes)
-  if (!raw) return []
-  return raw
-    .split(/\n|;/)
-    .map((p) => safeString(p))
-    .filter(Boolean)
-}
-
-const parseSteps = (pattern) => {
-  const raw = normalize(pattern)
-  if (!raw) return []
-  return raw
-    .split('>')
-    .map((p) => safeString(p))
-    .map((p) => normalize(p))
-    .filter(Boolean)
-}
-
-const parseFirstNumber = (text) => {
-  const s = normalize(text)
-  if (!s) return null
-  const m = s.match(/(-?\d+(?:[.,]\d+)?)/)
-  if (!m) return null
-  const n = parseTrainingNumber(m[1])
-  return Number.isFinite(n) ? n : null
-}
-
-const isTimeToken = (p) => {
-  const s = normalize(p)
-  if (!s) return false
-  if (s.includes('seg') || s.includes('sec')) return true
-  if (/\b\d+(?:[.,]\d+)?\s*s\b/.test(s)) return true
-  if (/\b\d+(?:[.,]\d+)?s\b/.test(s)) return true
-  return false
-}
-
-const parseCluster = (pattern) => {
-  const steps = parseSteps(pattern)
-  if (!steps.length) return null
-  const blocks = []
-  const rests = []
-  steps.forEach((p) => {
-    const n = parseFirstNumber(p)
-    if (n == null || n <= 0) return
-    if (p.includes('rep') || (!isTimeToken(p) && !p.includes('%'))) blocks.push(n)
-    else if (isTimeToken(p)) rests.push(n)
-  })
-  if (blocks.length < 2) return null
-  const total = blocks.reduce((acc, v) => acc + (Number(v) || 0), 0)
-  const intra = rests.length ? Number(rests[0]) : 15
-  const clusterSize = Number(blocks[0]) || null
-  return {
-    plannedReps: safeString(pattern),
-    config: {
-      total_reps: Number.isFinite(total) && total > 0 ? Math.round(total) : null,
-      cluster_size: Number.isFinite(Number(clusterSize)) && Number(clusterSize) > 0 ? Math.round(Number(clusterSize)) : null,
-      intra_rest_sec: Number.isFinite(Number(intra)) && Number(intra) > 0 ? Math.round(Number(intra)) : 15,
-    },
-  }
-}
-
-const parseRestPauseLike = ({ pattern, label }) => {
-  const steps = parseSteps(pattern)
-  if (!steps.length) return null
-  const blocksCount = steps.filter((p) => p.includes('falha') || p.includes('failure') || (parseFirstNumber(p) != null && !p.includes('%'))).length
-  if (blocksCount < 2) return null
-
-  const restSec = (() => {
-    for (const p of steps) {
-      if (!isTimeToken(p)) continue
-      const n = parseFirstNumber(p)
-      if (n != null && n > 0) return Math.round(n)
-    }
-    return label === 'SST' ? 10 : 15
-  })()
-
-  return {
-    config: {
-      mini_sets: Math.max(1, blocksCount - 1),
-      rest_time_sec: Math.max(1, restSec),
-    },
-  }
-}
-
-const parseDropSet = (pattern) => {
-  const steps = parseSteps(pattern)
-  if (!steps.length) return null
-  const stages = []
-  steps.forEach((p) => {
-    if (p.includes('falha') || p.includes('failure')) {
-      stages.push({ weight: null, reps: 'Falha' })
-      return
-    }
-    if (p.includes('%')) return
-    const repsN = parseFirstNumber(p)
-    if (repsN != null && repsN > 0) {
-      stages.push({ weight: null, reps: String(Math.round(repsN)) })
-    }
-  })
-  if (stages.length < 2) return null
-  return { config: stages }
-}
-
-const detectMethod = (headRaw) => {
-  const head = normalize(headRaw)
-  if (!head) return null
-  if (head.includes('cluster')) return { kind: 'cluster', label: 'Cluster', defaultTarget: 'all' }
-  if (head.includes('sst')) return { kind: 'sst', label: 'SST', defaultTarget: 'last' }
-  if (head.includes('rest-p') || head.includes('rest p') || head.includes('restpause') || head.includes('rest pause')) {
-    return { kind: 'rest_pause', label: 'Rest-P', defaultTarget: 'last' }
-  }
-  if (head.includes('drop-set') || head.includes('dropset') || head.includes('drop set') || head === 'drop' || head.startsWith('drop ')) {
-    return { kind: 'drop_set', label: 'Drop', defaultTarget: 'last' }
-  }
-  return null
-}
-
-export function parseExerciseNotesToSetOverrides({ notes, setsCount }) {
-  const directives = splitDirectives(notes)
-  const nSets = Math.max(0, Math.floor(Number(setsCount) || 0))
-  const overrides = Array.from({ length: nSets }).map(() => null)
-  if (!directives.length || !nSets) return { overrides, hash: hashString(notes) }
-
-  directives.forEach((raw) => {
-    const idx = raw.indexOf(':')
-    if (idx < 0) return
-    const head = raw.slice(0, idx)
-    const pattern = raw.slice(idx + 1)
-    const detected = detectMethod(head)
-    if (!detected) return
-    const targets = parseTargetIndices({ head, setsCount: nSets, defaultTarget: detected.defaultTarget })
-    if (!targets.length) return
-
-    if (detected.kind === 'cluster') {
-      const parsed = parseCluster(pattern)
-      if (!parsed) return
-      targets.forEach((setIdx) => {
-        overrides[setIdx] = {
-          kind: 'cluster',
-          label: detected.label,
-          plannedReps: parsed.plannedReps,
-          advanced_config: parsed.config,
-        }
-      })
-      return
-    }
-
-    if (detected.kind === 'rest_pause' || detected.kind === 'sst') {
-      const parsed = parseRestPauseLike({ pattern, label: detected.kind === 'sst' ? 'SST' : 'Rest-P' })
-      if (!parsed) return
-      targets.forEach((setIdx) => {
-        overrides[setIdx] = {
-          kind: detected.kind,
-          label: detected.kind === 'sst' ? 'SST' : 'Rest-P',
-          plannedReps: safeString(pattern),
-          advanced_config: parsed.config,
-        }
-      })
-      return
-    }
-
-    if (detected.kind === 'drop_set') {
-      const parsed = parseDropSet(pattern)
-      if (!parsed) return
-      targets.forEach((setIdx) => {
-        overrides[setIdx] = {
-          kind: 'drop_set',
-          label: 'Drop',
-          plannedReps: safeString(pattern),
-          advanced_config: parsed.config,
-        }
-      })
-    }
-  })
-
-  return { overrides, hash: hashString(notes) }
-}
diff --git a/claude.zip b/claude.zip
deleted file mode 100644
index e1e86b5..0000000
Binary files a/claude.zip and /dev/null differ
diff --git a/claude/_debug/login_loop_debug_report.json b/claude/_debug/login_loop_debug_report.json
deleted file mode 100644
index 65be366..0000000
--- a/claude/_debug/login_loop_debug_report.json
+++ /dev/null
@@ -1,275 +0,0 @@
-{
-  "report_type": "login_loop_debug",
-  "report_version": "1.0.0",
-  "generated_at": "2025-12-25T00:00:00.000Z",
-  "project": {
-    "name": "iron-tracks",
-    "path": "/Users/macmini/Documents/Projetos programação (trae)/App IronTracks",
-    "git": {
-      "branch": "restore-invite-only-2025-12-19",
-      "head": "5312c31199ff5dcf7112aa8695ed3489220953c2"
-    },
-    "stack": {
-      "frontend": "Next.js (App Router) + React + Tailwind",
-      "backend": "Supabase (Postgres + Auth)",
-      "supabase_client": "@supabase/ssr + @supabase/supabase-js"
-    }
-  },
-  "incident": {
-    "title": "Loop de login para usuários não-admin",
-    "symptoms": [
-      "Usuários não-admin entram em loop após autenticação",
-      "No Network aparece request abortado: https://<project>.supabase.co/auth/v1/logout?scope=global",
-      "Admin (djmkapple@gmail.com) conseguia autenticar"
-    ],
-    "reported_by_user": {
-      "admin_email": "djmkapple@gmail.com",
-      "user_message_snippets": [
-        "Eu fiz o DROP TRIGGER IF EXISTS t_enforce_invite_whitelist ON auth.users; DROP FUNCTION IF EXISTS public.enforce_invite_whitelist(); e ainda os outros emails estão no loop do login",
-        "Ainda no loop todos os login exceto eu admin",
-        "nada feito, acho que você tem que voltar lá atras"
-      ]
-    }
-  },
-  "timeline": [
-    {
-      "phase": "DB",
-      "action": "Remoção de bloqueio de whitelist (executado pelo usuário)",
-      "details": {
-        "sql": [
-          "DROP TRIGGER IF EXISTS t_enforce_invite_whitelist ON auth.users;",
-          "DROP FUNCTION IF EXISTS public.enforce_invite_whitelist();"
-        ],
-        "expected_effect": "Parar bloqueio de criação/login por e-mail não autorizado",
-        "observed_effect": "Loop persistiu para não-admin"
-      }
-    },
-    {
-      "phase": "App",
-      "action": "Mapeamento de pontos que causavam sign-out/redirect",
-      "details": {
-        "primary_file": "src/app/page.js",
-        "notes": [
-          "Havia lógica que realizava logout/limpeza de sessão ao detectar status 'cancelar/cancelled'",
-          "O request observado (/auth/v1/logout?scope=global) é compatível com signOut global"
-        ]
-      }
-    },
-    {
-      "phase": "App",
-      "action": "Tentativas intermediárias (defensivas) para diminuir impacto do logout",
-      "details": {
-        "notes": [
-          "Implementação de 'safeSignOut' para lidar com falhas de logout",
-          "Mudanças de parsing/normalização de email/metadata",
-          "Rotas de diagnóstico adicionadas/reforçadas"
-        ]
-      }
-    },
-    {
-      "phase": "Pivot",
-      "action": "Remoção completa de auto-logout e eliminação de signOut no cliente",
-      "details": {
-        "reason": "O loop persistiu; a melhor forma de isolar a causa foi zerar qualquer logout programático no app",
-        "result": "Projeto ficou com 0 chamadas para supabase.auth.signOut()"
-      }
-    }
-  ],
-  "key_hypotheses_tested": [
-    {
-      "hypothesis": "Whitelist/trigger no Supabase Auth ainda bloqueia usuários",
-      "status": "testado",
-      "outcome": "trigger/função removidos pelo usuário; loop continuou"
-    },
-    {
-      "hypothesis": "App faz logout global programático para não-admin",
-      "status": "testado",
-      "outcome": "havia fluxo que fazia logout; depois do pivot o projeto ficou sem signOut"
-    },
-    {
-      "hypothesis": "Cookie/session inconsistente causa re-login/re-logout",
-      "status": "mitigado",
-      "outcome": "rotas e middleware foram ajustados para padronizar cookies e evitar inconsistência"
-    }
-  ],
-  "code_changes_related_to_login_loop": [
-    {
-      "file": "src/app/page.js",
-      "intent": "Eliminar auto-logout e reduzir fontes de loop",
-      "changes": [
-        {
-          "change": "Auth check robusto via getSession/getUser e normalização de email",
-          "references": [
-            "src/app/page.js:404-495",
-            "src/app/page.js:503-585"
-          ]
-        },
-        {
-          "change": "Remoção de logout forçado para teacher/student status cancelled",
-          "references": [
-            "src/app/page.js:446-464",
-            "src/app/page.js:536-555",
-            "src/app/page.js:577-578"
-          ]
-        },
-        {
-          "change": "Logout virou apenas limpeza local e navegação para '/'",
-          "references": [
-            "src/app/page.js:830-842"
-          ]
-        },
-        {
-          "change": "Limpeza defensiva de cookies/localStorage relacionados ao Supabase (sem chamar signOut)",
-          "references": [
-            "src/app/page.js:177-242"
-          ]
-        }
-      ],
-      "risk_notes": [
-        "Ao remover auto-logout, contas canceladas deixam de ser bloqueadas no client; bloqueio deve ser feito via DB/RLS/Server.",
-        "Como o loop estava crítico, a prioridade foi interromper qualquer cascata de logout programático."
-      ]
-    },
-    {
-      "file": "src/app/auth/callback/route.js",
-      "intent": "Garantir troca do código OAuth por sessão e gravação de cookies de forma consistente",
-      "changes": [
-        {
-          "change": "Uso de createServerClient com setAll; cookies escritos com httpOnly: false",
-          "references": [
-            "src/app/auth/callback/route.js:24-39",
-            "src/app/auth/callback/route.js:41-48"
-          ]
-        }
-      ],
-      "risk_notes": [
-        "Cookies com httpOnly: false aumentam superfície de ataque (XSS). Idealmente cookies de sessão deveriam ser httpOnly.",
-        "Mudança foi alinhada ao padrão já adotado no projeto para evitar quebra de sessão por inconsistência de cookies."
-      ]
-    },
-    {
-      "file": "src/utils/supabase/middleware.ts",
-      "intent": "Sincronizar cookies do Supabase no middleware",
-      "changes": [
-        {
-          "change": "setAll escreve cookies na response com httpOnly: false",
-          "references": [
-            "src/utils/supabase/middleware.ts:9-30",
-            "src/utils/supabase/middleware.ts:36-39",
-            "src/utils/supabase/middleware.ts:64-65"
-          ]
-        }
-      ]
-    },
-    {
-      "file": "src/utils/supabase/server.ts",
-      "intent": "Padronizar escrita de cookies no server client",
-      "changes": [
-        {
-          "change": "cookieStore.set com httpOnly: false",
-          "references": [
-            "src/utils/supabase/server.ts:7-28"
-          ]
-        }
-      ]
-    },
-    {
-      "file": "src/app/api/supabase/status/route.ts",
-      "intent": "Diagnóstico de sessão/cookies no server",
-      "changes": [
-        {
-          "change": "Retorna cookieNames e status do getUser",
-          "references": [
-            "src/app/api/supabase/status/route.ts:5-26"
-          ]
-        }
-      ]
-    },
-    {
-      "file": "src/app/api/teachers/me/route.ts",
-      "intent": "Evitar falso positivo ao detectar teacher/cancelled por email/user_id",
-      "changes": [
-        {
-          "change": "Normalização de email e escape para ilike; validação dupla email+user_id",
-          "references": [
-            "src/app/api/teachers/me/route.ts:10-88"
-          ]
-        }
-      ]
-    }
-  ],
-  "repo_wide_diff_summary": {
-    "git_diff_stat": "54 files changed, 6002 insertions(+), 1629 deletions(-)",
-    "notes": [
-      "O diff atual do workspace contém mudanças além do escopo do loop de login.",
-      "As mudanças diretamente relacionadas ao login loop estão listadas em code_changes_related_to_login_loop."
-    ]
-  },
-  "commands_and_checks_executed": [
-    {
-      "command": "npm run lint",
-      "result": "ok",
-      "notes": [
-        "Warnings de hooks e uso de <img> (sem erros)."
-      ]
-    },
-    {
-      "command": "npm run build",
-      "result": "ok"
-    },
-    {
-      "command": "npm run dev -- --port 3000",
-      "result": "ok",
-      "notes": [
-        "Dev server em http://localhost:3000"
-      ]
-    },
-    {
-      "command": "GET /api/supabase/status (sem sessão)",
-      "result": "ok",
-      "observed": {
-        "ok": false,
-        "error": "Auth session missing!",
-        "cookieNames": []
-      }
-    }
-  ],
-  "current_state": {
-    "important_assertions": [
-      "Não existe mais chamada a supabase.auth.signOut() no código (busca retornou 0 ocorrências).",
-      "A autenticação no client depende de cookies (sb-*) gerenciados por @supabase/ssr e middleware/route callback."
-    ],
-    "still_unknowns": [
-      "Se o loop continua em produção por cache/build antigo.",
-      "Se algum bloqueio/trigger no Supabase Auth ainda rejeita ou invalida sessões para não-admin.",
-      "Se políticas RLS ou erros 401 em queries iniciais geram comportamento de reauth no cliente (mesmo sem signOut)."
-    ]
-  },
-  "next_debug_steps_recommended": [
-    {
-      "goal": "Confirmar se o logout global ainda ocorre",
-      "how": [
-        "Abrir DevTools > Network no navegador do usuário afetado",
-        "Filtrar por 'logout' e capturar a stack/initiator do request",
-        "Se o initiator não for app code, isolar para SDK/ambiente"
-      ]
-    },
-    {
-      "goal": "Instrumentar callback/middleware para rastrear sessão",
-      "how": [
-        "Adicionar logs server-side mínimos (sem tokens) em /auth/callback e middleware",
-        "Registrar somente: presença de cookies sb-*, evento e erro.message"
-      ]
-    }
-  ],
-  "security_notes": {
-    "secrets_observed_in_workspace": [
-      {
-        "file": ".env.local",
-        "key": "ASAAS_API_KEY",
-        "value_included_in_report": false,
-        "recommendation": "Rotacionar a chave e garantir que .env.local não esteja versionado."
-      }
-    ]
-  }
-}
diff --git a/claude/middleware.ts b/claude/middleware.ts
deleted file mode 100644
index a4f52c7..0000000
--- a/claude/middleware.ts
+++ /dev/null
@@ -1,20 +0,0 @@
-import { updateSession } from '@/utils/supabase/middleware'
-import { NextRequest, NextResponse } from 'next/server'
-
-export async function middleware(request: NextRequest) {
-  try {
-    const hostname = request.nextUrl.hostname
-    if (hostname === 'www.irontracks.com.br') {
-      const url = request.nextUrl.clone()
-      url.hostname = 'irontracks.com.br'
-      return NextResponse.redirect(url)
-    }
-  } catch {}
-  return await updateSession(request)
-}
-
-export const config = {
-  matcher: [
-    '/((?!_next/static|_next/image|favicon.ico|manifest.json|icone.png|robots.txt|sitemap.xml|auth).*)',
-  ],
-}
diff --git a/claude/schema_full_restore.sql b/claude/schema_full_restore.sql
deleted file mode 100644
index e6cedc9..0000000
--- a/claude/schema_full_restore.sql
+++ /dev/null
@@ -1,85 +0,0 @@
--- 1. PERFIL PÚBLICO (Essencial para Busca de Amigos e Admin)
-CREATE TABLE IF NOT EXISTS profiles (
-    id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
-    email TEXT,
-    display_name TEXT,
-    photo_url TEXT,
-    last_seen TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
-    role TEXT DEFAULT 'user'
-);
-
-ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
--- Qualquer um pode ver perfis (para buscar amigos)
-CREATE POLICY "Public profiles are viewable by everyone" ON profiles FOR SELECT USING (true);
--- Apenas o dono pode editar
-CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);
-CREATE POLICY "Users can insert own profile" ON profiles FOR INSERT WITH CHECK (auth.uid() = id);
-
-
--- 2. AVALIAÇÃO FÍSICA (StudentEvolution)
-CREATE TABLE IF NOT EXISTS assessments (
-    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
-    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
-    date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
-    weight NUMERIC,
-    bf NUMERIC,
-    waist NUMERIC,
-    arm NUMERIC,
-    sum7 NUMERIC,
-    notes TEXT,
-    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
-);
-ALTER TABLE assessments ENABLE ROW LEVEL SECURITY;
-CREATE POLICY "Users manage own assessments" ON assessments USING (auth.uid() = user_id);
-
-
--- 3. FOTOS DE PROGRESSO (StudentEvolution)
-CREATE TABLE IF NOT EXISTS photos (
-    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
-    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
-    date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
-    url TEXT NOT NULL,
-    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
-);
-ALTER TABLE photos ENABLE ROW LEVEL SECURITY;
-CREATE POLICY "Users manage own photos" ON photos USING (auth.uid() = user_id);
-
-
--- 4. CHAT GLOBAL (ChatScreen)
-CREATE TABLE IF NOT EXISTS messages (
-    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
-    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
-    content TEXT NOT NULL,
-    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
-);
-ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
-CREATE POLICY "Everyone can read messages" ON messages FOR SELECT USING (true);
-CREATE POLICY "Users can insert messages" ON messages FOR INSERT WITH CHECK (auth.uid() = user_id);
-
-
--- 5. CONVITES DE TREINO (InviteManager)
-CREATE TABLE IF NOT EXISTS invites (
-    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
-    from_uid UUID REFERENCES auth.users(id),
-    to_uid UUID REFERENCES auth.users(id),
-    workout_data JSONB,
-    team_session_id UUID,
-    status TEXT DEFAULT 'pending', -- pending, accepted, rejected
-    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
-);
-ALTER TABLE invites ENABLE ROW LEVEL SECURITY;
--- Usuário vê convites que enviou ou recebeu
-CREATE POLICY "Users manage invites" ON invites USING (auth.uid() = from_uid OR auth.uid() = to_uid);
-
-
--- 6. SESSÃO DE EQUIPE (TeamContext)
-CREATE TABLE IF NOT EXISTS team_sessions (
-    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
-    host_uid UUID REFERENCES auth.users(id),
-    status TEXT DEFAULT 'active',
-    participants JSONB, -- Armazena lista simples de nomes/emails para exibição rápida
-    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
-);
-ALTER TABLE team_sessions ENABLE ROW LEVEL SECURITY;
-CREATE POLICY "Users view team sessions" ON team_sessions FOR SELECT USING (true);
-CREATE POLICY "Hosts manage sessions" ON team_sessions FOR ALL USING (auth.uid() = host_uid);
diff --git a/claude/src/app/(app)/layout.tsx b/claude/src/app/(app)/layout.tsx
deleted file mode 100644
index 23e9fb2..0000000
--- a/claude/src/app/(app)/layout.tsx
+++ /dev/null
@@ -1,22 +0,0 @@
-import { createClient } from '@/utils/supabase/server'
-import { redirect } from 'next/navigation'
-import { resolveRoleByUser } from '@/utils/auth/route'
-
-export default async function AppLayout({ children }: { children: React.ReactNode }) {
-  const supabase = await createClient()
-  const { data: { user } } = await supabase.auth.getUser()
-
-  if (user?.id) {
-    const { role } = await resolveRoleByUser(user)
-    
-    // Admins e Professores sempre têm acesso liberado
-    if (role === 'admin' || role === 'teacher') {
-      return children
-    }
-
-    const { data: profile } = await supabase.from('profiles').select('is_approved').eq('id', user.id).maybeSingle()
-    if (profile?.is_approved !== true) redirect('/wait-approval')
-  }
-
-  return children
-}
diff --git a/claude/src/app/auth/login/route 2.ts b/claude/src/app/auth/login/route 2.ts
deleted file mode 100644
index 0d30073..0000000
--- a/claude/src/app/auth/login/route 2.ts	
+++ /dev/null
@@ -1,105 +0,0 @@
-import { createServerClient } from '@supabase/ssr'
-import { NextResponse } from 'next/server'
-import { cookies } from 'next/headers'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export const dynamic = 'force-dynamic'
-
-export async function GET(request: Request) {
-  const url = new URL(request.url)
-  const sp = url.searchParams
-  const next = sp.get('next') ?? '/dashboard'
-  const nextCookieName = 'it.auth.next'
-  const nextCookieMaxAgeSeconds = 60 * 5
-
-  const originFromUrl = url.origin
-  const forwardedHost = (request.headers.get('x-forwarded-host') || '').trim()
-  const forwardedProto = (request.headers.get('x-forwarded-proto') || 'https').trim()
-  const isLocalEnv = process.env.NODE_ENV === 'development'
-  const baseOrigin = forwardedHost && !isLocalEnv ? `${forwardedProto}://${forwardedHost}` : originFromUrl
-  let safeOrigin = isLocalEnv && baseOrigin.includes('0.0.0.0') ? baseOrigin.replace('0.0.0.0', 'localhost') : baseOrigin
-  if (!isLocalEnv) {
-    try {
-      const u = new URL(safeOrigin)
-      u.protocol = 'https:'
-      safeOrigin = u.origin
-    } catch {}
-  }
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    return NextResponse.redirect(new URL('/auth/error?error=missing_env', safeOrigin))
-  }
-
-  const rawNext = String(next || '/dashboard')
-  const safeNext = rawNext.startsWith('/') ? rawNext : '/dashboard'
-  const redirectTo = `${safeOrigin}/auth/callback?next=${encodeURIComponent(safeNext)}`
-  const baseCookieOptions = getSupabaseCookieOptions()
-  const nextCookieExpires = new Date(Date.now() + nextCookieMaxAgeSeconds * 1000)
-
-  let cookiesToApply: Array<{ name: string; value: string; options?: any }> = []
-  const cookieStore = await cookies()
-
-  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    cookies: {
-      getAll() {
-        return cookieStore.getAll()
-      },
-      setAll(cookiesToSet) {
-        cookiesToApply = cookiesToSet.map((c) => ({
-          name: c.name,
-          value: c.value,
-          options: c.options ? { ...c.options } : undefined,
-        }))
-      },
-    },
-  })
-
-  let oauthUrl: string | null = null
-  try {
-    const { data, error } = await supabase.auth.signInWithOAuth({
-      provider: 'google',
-      options: { redirectTo },
-    })
-    if (error) {
-      return NextResponse.redirect(
-        new URL(`/auth/error?error=${encodeURIComponent(error.message || 'oauth_failed')}`, safeOrigin),
-      )
-    }
-    oauthUrl = data?.url || null
-  } catch (e: any) {
-    return NextResponse.redirect(
-      new URL(`/auth/error?error=${encodeURIComponent(e?.message || 'oauth_failed')}`, safeOrigin),
-    )
-  }
-
-  if (!oauthUrl) {
-    return NextResponse.redirect(new URL('/auth/error?error=oauth_url_missing', safeOrigin))
-  }
-
-  const redirectResp = NextResponse.redirect(oauthUrl)
-  cookiesToApply.forEach(({ name, value, options }) => {
-    try {
-      redirectResp.cookies.set(name, value, { ...(options || {}) })
-    } catch {
-      try {
-        redirectResp.cookies.set(name, value)
-      } catch {}
-    }
-  })
-  try {
-    redirectResp.cookies.set(nextCookieName, safeNext, {
-      ...(baseCookieOptions || {}),
-      expires: nextCookieExpires,
-      maxAge: nextCookieMaxAgeSeconds,
-    })
-  } catch {
-    try {
-      redirectResp.cookies.set(nextCookieName, safeNext)
-    } catch {}
-  }
-
-  return redirectResp
-}
diff --git a/claude/src/app/auth/login/route.ts b/claude/src/app/auth/login/route.ts
deleted file mode 100644
index 5262ab1..0000000
--- a/claude/src/app/auth/login/route.ts
+++ /dev/null
@@ -1,126 +0,0 @@
-import { createServerClient } from '@supabase/ssr'
-import { NextResponse } from 'next/server'
-import { cookies } from 'next/headers'
-import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
-
-export const dynamic = 'force-dynamic'
-
-export async function GET(request: Request) {
-  const url = new URL(request.url)
-  const sp = url.searchParams
-  const next = sp.get('next') ?? '/dashboard'
-  const providerRaw = String(sp.get('provider') || '').trim().toLowerCase()
-  const provider = providerRaw === 'apple' ? 'apple' : 'google'
-  const nextCookieName = 'it.auth.next'
-  const nextCookieMaxAgeSeconds = 60 * 5
-
-  const originFromUrl = url.origin
-  const hostHeader = (request.headers.get('host') || '').trim()
-  const forwardedHost = (request.headers.get('x-forwarded-host') || '').trim()
-  const forwardedProto = (request.headers.get('x-forwarded-proto') || '').trim()
-  const isLocalEnv = process.env.NODE_ENV === 'development'
-  const protoFromUrl = url.protocol ? url.protocol.replace(':', '') : ''
-  const effectiveProto = forwardedProto || protoFromUrl || (isLocalEnv ? 'http' : 'https')
-  const baseOrigin =
-    isLocalEnv && (hostHeader || url.host)
-      ? `${effectiveProto}://${hostHeader || url.host}`
-      : forwardedHost && !isLocalEnv
-        ? `${effectiveProto}://${forwardedHost}`
-        : originFromUrl
-  let safeOrigin = isLocalEnv && baseOrigin.includes('0.0.0.0') ? baseOrigin.replace('0.0.0.0', 'localhost') : baseOrigin
-  const configuredOriginRaw = (process.env.IRONTRACKS_PUBLIC_ORIGIN || '').trim()
-  if (configuredOriginRaw) {
-    try {
-      const conf = new URL(configuredOriginRaw)
-      const confHost = String(conf.host || '').split(':')[0].toLowerCase()
-      const candidates = [forwardedHost, hostHeader, url.host]
-        .map((h) => String(h || '').split(':')[0].toLowerCase())
-        .filter(Boolean)
-      if (confHost && candidates.includes(confHost)) safeOrigin = conf.origin
-    } catch {}
-  }
-  if (!isLocalEnv) {
-    try {
-      const u = new URL(safeOrigin)
-      u.protocol = 'https:'
-      safeOrigin = u.origin
-    } catch {}
-  }
-
-  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
-  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
-  if (!supabaseUrl || !supabaseAnonKey) {
-    return NextResponse.redirect(new URL('/auth/error?error=missing_env', safeOrigin))
-  }
-
-  const rawNext = String(next || '/dashboard')
-  const safeNext = rawNext.startsWith('/') ? rawNext : '/dashboard'
-  const redirectTo = `${safeOrigin}/auth/callback?next=${encodeURIComponent(safeNext)}`
-  const baseCookieOptions = getSupabaseCookieOptions()
-  const nextCookieExpires = new Date(Date.now() + nextCookieMaxAgeSeconds * 1000)
-
-  let cookiesToApply: Array<{ name: string; value: string; options?: any }> = []
-  const cookieStore = await cookies()
-
-  const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
-    cookieOptions: getSupabaseCookieOptions(),
-    cookies: {
-      getAll() {
-        return cookieStore.getAll()
-      },
-      setAll(cookiesToSet) {
-        cookiesToApply = cookiesToSet.map((c) => ({
-          name: c.name,
-          value: c.value,
-          options: c.options ? { ...c.options } : undefined,
-        }))
-      },
-    },
-  })
-
-  let oauthUrl: string | null = null
-  try {
-    const { data, error } = await supabase.auth.signInWithOAuth({
-      provider,
-      options: { redirectTo },
-    })
-    if (error) {
-      return NextResponse.redirect(
-        new URL(`/auth/error?error=${encodeURIComponent(error.message || 'oauth_failed')}`, safeOrigin),
-      )
-    }
-    oauthUrl = data?.url || null
-  } catch (e: any) {
-    return NextResponse.redirect(
-      new URL(`/auth/error?error=${encodeURIComponent(e?.message || 'oauth_failed')}`, safeOrigin),
-    )
-  }
-
-  if (!oauthUrl) {
-    return NextResponse.redirect(new URL('/auth/error?error=oauth_url_missing', safeOrigin))
-  }
-
-  const redirectResp = NextResponse.redirect(oauthUrl)
-  cookiesToApply.forEach(({ name, value, options }) => {
-    try {
-      redirectResp.cookies.set(name, value, { ...(options || {}) })
-    } catch {
-      try {
-        redirectResp.cookies.set(name, value)
-      } catch {}
-    }
-  })
-  try {
-    redirectResp.cookies.set(nextCookieName, safeNext, {
-      ...(baseCookieOptions || {}),
-      expires: nextCookieExpires,
-      maxAge: nextCookieMaxAgeSeconds,
-    })
-  } catch {
-    try {
-      redirectResp.cookies.set(nextCookieName, safeNext)
-    } catch {}
-  }
-
-  return redirectResp
-}
diff --git a/claude/src/components/dashboard/StudentDashboard.tsx b/claude/src/components/dashboard/StudentDashboard.tsx
deleted file mode 100644
index 44b3656..0000000
--- a/claude/src/components/dashboard/StudentDashboard.tsx
+++ /dev/null
@@ -1,2 +0,0 @@
-export { default } from './StudentDashboard3'
-export * from './StudentDashboard3'
diff --git a/claude/src/content/vipPlaybooks.ts b/claude/src/content/vipPlaybooks.ts
deleted file mode 100644
index 9b6d2d3..0000000
--- a/claude/src/content/vipPlaybooks.ts
+++ /dev/null
@@ -1,53 +0,0 @@
-export type VipPlaybook = {
-  id: string
-  title: string
-  description: string
-  mode: 'coach' | 'planner' | 'diagnostic'
-  prompt: string
-}
-
-export const vipPlaybooks: VipPlaybook[] = [
-  {
-    id: 'hypertrophy-4x',
-    title: 'Hipertrofia 4x/sem',
-    description: 'Bloco de 4 semanas com progressão simples e sustentável.',
-    mode: 'planner',
-    prompt: 'Crie um bloco de 4 semanas para hipertrofia (4x/semana). Use progressão e um deload opcional.',
-  },
-  {
-    id: 'strength-3x',
-    title: 'Força 3x/sem',
-    description: 'Foco em força com volume controlado e recuperação.',
-    mode: 'planner',
-    prompt: 'Crie um bloco de 6 semanas para força (3x/semana) com progressão e deload.',
-  },
-  {
-    id: 'plateau-fix',
-    title: 'Destravar platô',
-    description: 'Diagnóstico de causa raiz e plano de ação em 3 passos.',
-    mode: 'diagnostic',
-    prompt: 'Meu progresso travou nas últimas 4 semanas. Gere 3 hipóteses e um plano de ação priorizado.',
-  },
-  {
-    id: 'fatigue-management',
-    title: 'Gestão de fadiga',
-    description: 'Ajustes de volume/intensidade sem perder performance.',
-    mode: 'diagnostic',
-    prompt: 'Estou com fadiga alta. Ajuste meu volume semanal e escolha um protocolo de deload se necessário.',
-  },
-  {
-    id: 'today-workout',
-    title: 'Treino de hoje',
-    description: 'Sugestão prática do que executar hoje.',
-    mode: 'coach',
-    prompt: 'Sugira meu treino de hoje com base no que fiz por último e nos meus check-ins.',
-  },
-  {
-    id: 'warmup-template',
-    title: 'Aquecimento inteligente',
-    description: 'Aquecimento específico para o treino do dia.',
-    mode: 'coach',
-    prompt: 'Crie um aquecimento completo e específico para o meu treino de hoje (mobilidade + séries de aproximação).',
-  },
-]
-
diff --git a/claude/src/types/assessment.ts b/claude/src/types/assessment.ts
deleted file mode 100644
index b63e8cb..0000000
--- a/claude/src/types/assessment.ts
+++ /dev/null
@@ -1,316 +0,0 @@
-// Tipos para o sistema de avaliação física
-
-export interface Assessment {
-  id: string;
-  student_id: string;
-  trainer_id: string;
-
-  // Dados Básicos
-  assessment_date: string;
-  weight: number; // kg
-  height: number; // cm
-  age: number;
-  gender: 'M' | 'F';
-
-  // Circunferências (cm)
-  arm_circ?: number; // braço
-  chest_circ?: number; // peito
-  waist_circ?: number; // cintura
-  hip_circ?: number; // quadril
-  thigh_circ?: number; // coxa
-  calf_circ?: number; // panturrilha
-
-  // 7 Dobras Cutâneas (mm)
-  triceps_skinfold?: number; // tricipital
-  biceps_skinfold?: number; // bicipital
-  subscapular_skinfold?: number; // subescapular
-  suprailiac_skinfold?: number; // suprailíaca
-  abdominal_skinfold?: number; // abdominal
-  thigh_skinfold?: number; // coxa
-  calf_skinfold?: number; // panturrilha
-
-  // Cálculos (gerados automaticamente)
-  body_fat_percentage?: number; // % gordura
-  lean_mass?: number; // massa magra em kg
-  fat_mass?: number; // massa gorda em kg
-  bmr?: number; // taxa metabólica basal kcal/dia
-  tdee?: number; // gasto energético total kcal/dia
-  bmi?: number; // índice de massa corporal
-
-  // Metadados
-  observations?: string;
-  pdf_url?: string;
-
-  // Timestamps
-  created_at: string;
-  updated_at: string;
-
-  // Dados relacionados (opcional)
-  student_name?: string;
-  trainer_name?: string;
-  photo_count?: number;
-}
-
-export interface AssessmentPhoto {
-  id: string;
-  assessment_id: string;
-  photo_url: string;
-  photo_type: 'front' | 'side' | 'back';
-  file_size?: number;
-  mime_type?: string;
-  created_at: string;
-}
-
-export interface AssessmentFormData {
-  // Dados Básicos
-  assessment_date: string;
-  weight: string;
-  height: string;
-  age: string;
-  gender: 'M' | 'F';
-
-  // Circunferências (cm)
-  arm_circ: string;
-  chest_circ: string;
-  waist_circ: string;
-  hip_circ: string;
-  thigh_circ: string;
-  calf_circ: string;
-
-  // 7 Dobras Cutâneas (mm)
-  triceps_skinfold: string;
-  biceps_skinfold: string;
-  subscapular_skinfold: string;
-  suprailiac_skinfold: string;
-  abdominal_skinfold: string;
-  thigh_skinfold: string;
-  calf_skinfold: string;
-
-  // Metadados
-  observations: string;
-}
-
-export interface CalculatedMetrics {
-  body_fat_percentage: number;
-  lean_mass: number;
-  fat_mass: number;
-  bmr: number;
-  bmi: number;
-  sum_skinfolds: number;
-  body_density: number;
-}
-
-export interface ActivityLevel {
-  value: 'sedentary' | 'light' | 'moderate' | 'active' | 'veryActive';
-  label: string;
-  description: string;
-  factor: number;
-}
-
-export const activityLevels: ActivityLevel[] = [
-  {
-    value: 'sedentary',
-    label: 'Sedentário',
-    description: 'Pouco ou nenhum exercício',
-    factor: 1.2
-  },
-  {
-    value: 'light',
-    label: 'Levemente ativo',
-    description: 'Exercício leve 1-3 dias/semana',
-    factor: 1.375
-  },
-  {
-    value: 'moderate',
-    label: 'Moderadamente ativo',
-    description: 'Exercício moderado 3-5 dias/semana',
-    factor: 1.55
-  },
-  {
-    value: 'active',
-    label: 'Altamente ativo',
-    description: 'Exercício pesado 6-7 dias/semana',
-    factor: 1.725
-  },
-  {
-    value: 'veryActive',
-    label: 'Extremamente ativo',
-    description: 'Exercício muito pesado diário',
-    factor: 1.9
-  }
-];
-
-export interface PhotoUpload {
-  file: File;
-  preview: string;
-  type: 'front' | 'side' | 'back';
-  uploading?: boolean;
-  error?: string;
-}
-
-export interface AssessmentStep {
-  id: string;
-  title: string;
-  description: string;
-  component: React.ComponentType<any>;
-}
-
-export interface ValidationRule {
-  min?: number;
-  max?: number;
-  required?: boolean;
-  pattern?: RegExp;
-  message?: string;
-}
-
-export interface FormField {
-  name: keyof AssessmentFormData;
-  label: string;
-  unit: string;
-  placeholder: string;
-  validation: ValidationRule;
-  step?: number;
-}
-
-// Constantes para validações
-export const MEASUREMENT_RANGES = {
-  weight: { min: 30, max: 300, message: 'Peso deve estar entre 30-300 kg' },
-  height: { min: 100, max: 250, message: 'Altura deve estar entre 100-250 cm' },
-  age: { min: 10, max: 100, message: 'Idade deve estar entre 10-100 anos' },
-  circumference: { min: 10, max: 200, message: 'Medida deve estar entre 10-200 cm' },
-  skinfold: { min: 3, max: 50, message: 'Dobra deve estar entre 3-50 mm' }
-};
-
-// Tipos para gráficos
-export interface ChartDataPoint {
-  date: string;
-  body_fat_percentage: number;
-  lean_mass: number;
-  weight: number;
-}
-
-export interface BodyCompositionData {
-  labels: string[];
-  data: number[];
-  colors: string[];
-}
-
-// Tipos para PDF
-export interface PDFAssessmentData {
-  assessment: Assessment;
-  photos: AssessmentPhoto[];
-  calculatedMetrics: CalculatedMetrics;
-  activityLevel?: ActivityLevel;
-  tdee?: number;
-}
-
-// Tipos para API
-export interface CreateAssessmentRequest extends Omit<Assessment, 'id' | 'created_at' | 'updated_at'> { }
-
-export interface UpdateAssessmentRequest extends Partial<Omit<Assessment, 'id' | 'created_at' | 'updated_at' | 'student_id' | 'trainer_id'>> { }
-
-export interface AssessmentResponse {
-  success: boolean;
-  data?: Assessment;
-  error?: string;
-  message?: string;
-}
-
-export interface AssessmentListResponse {
-  success: boolean;
-  data: Assessment[];
-  count: number;
-  error?: string;
-}
-
-// Funções utilitárias de tipo
-export const isValidGender = (value: any): value is 'M' | 'F' => {
-  return value === 'M' || value === 'F';
-};
-
-export const isValidPhotoType = (value: any): value is 'front' | 'side' | 'back' => {
-  return ['front', 'side', 'back'].includes(value);
-};
-
-export const parseNumberInput = (value: string): number | null => {
-  const parsed = parseFloat(value.replace(',', '.'));
-  return isNaN(parsed) ? null : parsed;
-};
-
-export const formatNumber = (value: number | null | undefined, decimals: number = 1): string => {
-  if (value === null || value === undefined) return '';
-  return value.toFixed(decimals);
-};
-
-export const formatDate = (date: string): string => {
-  return new Date(date).toLocaleDateString('pt-BR');
-};
-
-// Validações
-export const validateAssessmentForm = (data: AssessmentFormData): Record<string, string> => {
-  const errors: Record<string, string> = {};
-
-  // Validação de campos obrigatórios
-  const requiredFields: (keyof AssessmentFormData)[] = [
-    'assessment_date', 'weight', 'height', 'age', 'gender'
-  ];
-
-  requiredFields.forEach(field => {
-    if (!data[field]) {
-      errors[field] = 'Campo obrigatório';
-    }
-  });
-
-  // Validação de ranges
-  if (data.weight) {
-    const weight = parseFloat(data.weight);
-    if (weight < MEASUREMENT_RANGES.weight.min || weight > MEASUREMENT_RANGES.weight.max) {
-      errors.weight = MEASUREMENT_RANGES.weight.message;
-    }
-  }
-
-  if (data.height) {
-    const height = parseFloat(data.height);
-    if (height < MEASUREMENT_RANGES.height.min || height > MEASUREMENT_RANGES.height.max) {
-      errors.height = MEASUREMENT_RANGES.height.message;
-    }
-  }
-
-  if (data.age) {
-    const age = parseInt(data.age);
-    if (age < MEASUREMENT_RANGES.age.min || age > MEASUREMENT_RANGES.age.max) {
-      errors.age = MEASUREMENT_RANGES.age.message;
-    }
-  }
-
-  // Validação de dobras cutâneas
-  const skinfoldFields: (keyof AssessmentFormData)[] = [
-    'triceps_skinfold', 'biceps_skinfold', 'subscapular_skinfold',
-    'suprailiac_skinfold', 'abdominal_skinfold', 'thigh_skinfold', 'calf_skinfold'
-  ];
-
-  skinfoldFields.forEach(field => {
-    if (data[field]) {
-      const value = parseFloat(data[field]);
-      if (value < MEASUREMENT_RANGES.skinfold.min || value > MEASUREMENT_RANGES.skinfold.max) {
-        errors[field] = MEASUREMENT_RANGES.skinfold.message;
-      }
-    }
-  });
-
-  // Validação de circunferências
-  const circumferenceFields: (keyof AssessmentFormData)[] = [
-    'arm_circ', 'chest_circ', 'waist_circ', 'hip_circ', 'thigh_circ', 'calf_circ'
-  ];
-
-  circumferenceFields.forEach(field => {
-    if (data[field]) {
-      const value = parseFloat(data[field]);
-      if (value < MEASUREMENT_RANGES.circumference.min || value > MEASUREMENT_RANGES.circumference.max) {
-        errors[field] = MEASUREMENT_RANGES.circumference.message;
-      }
-    }
-  });
-
-  return errors;
-};
diff --git a/claude/src/types/supabase.ts b/claude/src/types/supabase.ts
deleted file mode 100644
index 1c88890..0000000
--- a/claude/src/types/supabase.ts
+++ /dev/null
@@ -1,35 +0,0 @@
-export type DropSetStep = {
-  weight: number | null
-  reps: string | null
-}
-
-export type DropSetConfig = DropSetStep[]
-
-export type RestPauseConfig = {
-  weight: number | null
-  initial_reps: number | null
-  rest_time_sec: number | null
-  mini_sets: number | null
-}
-
-export type ClusterSetConfig = {
-  weight: number | null
-  total_reps: number | null
-  cluster_size: number | null
-  intra_rest_sec: number | null
-}
-
-export type SetAdvancedConfig = DropSetConfig | RestPauseConfig | ClusterSetConfig | null
-
-export type SetRow = {
-  id: string
-  exercise_id: string
-  weight: number | null
-  reps: string | null
-  rpe: number | null
-  set_number: number | null
-  completed: boolean | null
-  is_warmup: boolean | null
-  advanced_config: SetAdvancedConfig
-}
-
diff --git a/claude/src/utils/featureFlags.js b/claude/src/utils/featureFlags.js
deleted file mode 100644
index 3d4f83b..0000000
--- a/claude/src/utils/featureFlags.js
+++ /dev/null
@@ -1,19 +0,0 @@
-export const FEATURE_KEYS = {
-  teamworkV2: 'featureTeamworkV2',
-  storiesV2: 'featureStoriesV2',
-  weeklyReportCTA: 'featureWeeklyReportCTA',
-  offlineSyncV2: 'featureOfflineSyncV2',
-}
-
-const isObject = (v) => v && typeof v === 'object' && !Array.isArray(v)
-
-export const isKillSwitchOn = (settings) => {
-  const s = isObject(settings) ? settings : {}
-  return s.featuresKillSwitch === true
-}
-
-export const isFeatureEnabled = (settings, key) => {
-  if (isKillSwitchOn(settings)) return false
-  const s = isObject(settings) ? settings : {}
-  return s?.[key] === true
-}
diff --git a/claude/src/utils/vip/limits.ts b/claude/src/utils/vip/limits.ts
deleted file mode 100644
index 64635f7..0000000
--- a/claude/src/utils/vip/limits.ts
+++ /dev/null
@@ -1,189 +0,0 @@
-import { createClient } from '@/utils/supabase/server'
-import { SupabaseClient } from '@supabase/supabase-js'
-
-export type VipTierLimits = {
-  chat_daily: number
-  wizard_weekly: number
-  insights_weekly: number // New limit
-  history_days: number | null // null = unlimited
-  nutrition_macros: boolean
-  offline: boolean
-  chef_ai: boolean
-}
-
-export const FREE_LIMITS: VipTierLimits = {
-  chat_daily: 0,
-  wizard_weekly: 0,
-  insights_weekly: 1, // 1 per week for Free
-  history_days: 30,
-  nutrition_macros: false,
-  offline: false,
-  chef_ai: false
-}
-
-// Admin/Teacher gets everything unlimited
-export const UNLIMITED_LIMITS: VipTierLimits = {
-  chat_daily: 9999,
-  wizard_weekly: 9999,
-  insights_weekly: 9999,
-  history_days: null,
-  nutrition_macros: true,
-  offline: true,
-  chef_ai: true
-}
-
-export async function getVipPlanLimits(supabase: SupabaseClient, userId: string): Promise<{ tier: string, limits: VipTierLimits }> {
-  // 1. Check Admin/Teacher role
-  const { data: profile } = await supabase
-    .from('profiles')
-    .select('role')
-    .eq('id', userId)
-    .single()
-  
-  if (profile?.role === 'admin' || profile?.role === 'teacher') {
-    return { tier: 'admin', limits: UNLIMITED_LIMITS }
-  }
-
-  // 2. Check App Subscriptions (In-App Purchases)
-  const { data: appSub } = await supabase
-    .from('app_subscriptions')
-    .select('plan_id, status')
-    .eq('user_id', userId)
-    .in('status', ['active', 'past_due', 'trialing'])
-    .order('created_at', { ascending: false })
-    .limit(1)
-    .maybeSingle()
-
-  if (appSub?.plan_id) {
-    const limits = await fetchPlanLimits(supabase, appSub.plan_id)
-    if (limits) return { tier: appSub.plan_id, limits }
-  }
-
-  // 3. Check Marketplace Subscriptions (Stripe/Asaas)
-  const { data: marketSub } = await supabase
-    .from('marketplace_subscriptions')
-    .select('plan_id, status')
-    .eq('student_user_id', userId)
-    .in('status', ['active', 'past_due', 'trialing'])
-    .order('created_at', { ascending: false })
-    .limit(1)
-    .maybeSingle()
-
-  if (marketSub?.plan_id) {
-    const limits = await fetchPlanLimits(supabase, marketSub.plan_id)
-    if (limits) return { tier: marketSub.plan_id, limits }
-  }
-
-  // 4. Fallback to Free
-  return { tier: 'free', limits: FREE_LIMITS }
-}
-
-async function fetchPlanLimits(supabase: SupabaseClient, planId: string): Promise<VipTierLimits | null> {
-  // Normalize planId (remove _annual suffix to match base plan limits if needed, 
-  // though we inserted annual plans with limits too)
-  
-  const { data: plan } = await supabase
-    .from('app_plans')
-    .select('limits')
-    .eq('id', planId)
-    .single()
-
-  if (plan?.limits) {
-    // Merge with defaults to ensure all keys exist
-    return { ...FREE_LIMITS, ...plan.limits }
-  }
-  
-  return null
-}
-
-export async function checkVipFeatureAccess(
-  supabase: SupabaseClient, 
-  userId: string, 
-  feature: keyof VipTierLimits
-): Promise<{ allowed: boolean, currentUsage: number, limit: number | null, tier: string }> {
-  const { tier, limits } = await getVipPlanLimits(supabase, userId)
-  const limit = limits[feature]
-
-  // Boolean features (macros, offline, chef_ai)
-  if (typeof limit === 'boolean') {
-    return { allowed: limit, currentUsage: 0, limit: limit ? 1 : 0, tier }
-  }
-
-  // Null means unlimited
-  if (limit === null) {
-    return { allowed: true, currentUsage: 0, limit: null, tier }
-  }
-
-  // Numeric limits (chat_daily, wizard_weekly)
-  if (feature === 'chat_daily') {
-    const today = new Date().toISOString().split('T')[0]
-    const { data: usage } = await supabase
-      .from('vip_usage_daily')
-      .select('usage_count')
-      .eq('user_id', userId)
-      .eq('feature_key', 'chat')
-      .eq('day', today)
-      .maybeSingle()
-    
-    const current = usage?.usage_count || 0
-    return { allowed: current < limit, currentUsage: current, limit, tier }
-  }
-
-  if (feature === 'wizard_weekly' || feature === 'insights_weekly') {
-    // Sum usage of last 7 days
-    const today = new Date()
-    const sevenDaysAgo = new Date(today)
-    sevenDaysAgo.setDate(today.getDate() - 6) // -6 days + today = 7 days window
-    
-    // Map feature to db key
-    const dbKey = feature === 'wizard_weekly' ? 'wizard' : 'insights'
-
-    const { data: usages } = await supabase
-      .from('vip_usage_daily')
-      .select('usage_count')
-      .eq('user_id', userId)
-      .eq('feature_key', dbKey)
-      .gte('day', sevenDaysAgo.toISOString().split('T')[0])
-    
-    const current = usages?.reduce((sum, row) => sum + row.usage_count, 0) || 0
-    return { allowed: current < (limit || 0), currentUsage: current, limit, tier }
-  }
-
-  // Default fallback
-  return { allowed: false, currentUsage: 0, limit: 0, tier }
-}
-
-export async function incrementVipUsage(
-  supabase: SupabaseClient,
-  userId: string,
-  feature: 'chat' | 'wizard' | 'insights'
-) {
-  const today = new Date().toISOString().split('T')[0]
-  
-  // Upsert usage
-  // We can't use .rpc() unless we have a specific function, so we'll try insert/update
-  // Or better, use upsert with on conflict
-  
-  const { data: existing } = await supabase
-    .from('vip_usage_daily')
-    .select('usage_count')
-    .eq('user_id', userId)
-    .eq('feature_key', feature)
-    .eq('day', today)
-    .maybeSingle()
-
-  const nextCount = (existing?.usage_count || 0) + 1
-
-  const { error } = await supabase
-    .from('vip_usage_daily')
-    .upsert({
-      user_id: userId,
-      feature_key: feature,
-      day: today,
-      usage_count: nextCount,
-      last_used_at: new Date().toISOString(),
-      updated_at: new Date().toISOString()
-    }, { onConflict: 'user_id, feature_key, day' })
-    
-  if (error) console.error('Error incrementing VIP usage:', error)
-}
diff --git a/claudeanalise b/claudeanalise
deleted file mode 100644
index 9e4416a..0000000
--- a/claudeanalise
+++ /dev/null
@@ -1,783 +0,0 @@
-.
-..
-.DS_Store
-.env 2.local
-.env.local
-.env.production.local
-.git
-.github
-.gitignore
-.next
-.nvmrc
-.trae
-.vercel
-.vercelignore
-480399
-CHECKLIST_FUNCIONAL.md
-DEPLOY.md
-DOC_CREDITOS_VIP.md
-MOBILE_GUIDE.md
-PUBLISH_GUIDE.md
-README.md
-SUPABASE_SMTP_SETUP.md
-_legacy_backup
-_macro_mixer_orig
-_snapshots
-apple store
-capacitor.config.ts
-eslint.config.mjs
-ios
-jsconfig.json
-login_loop_debug_report.json
-middleware.ts
-migration_add_is_approved_column.sql
-next-env.d.ts
-next.config.mjs
-node_modules
-package-lock.json
-package.json
-postcss.config.mjs
-public
-schema.sql
-schema_full_restore.sql
-scripts
-src
-supabase
-tsconfig.json
-tsconfig.tsbuildinfo
-
-./src
-./src/types
-./src/contexts
-./src/.DS_Store
-./src/app
-./src/content
-./src/utils
-./src/components
-./src/hooks
-./src/actions
-./src/lib
-
-./src/components
-./src/components/ui
-./src/components/LoadingScreen.js
-./src/components/AdminPanelV2.js
-./src/components/ActiveWorkout.js
-./src/components/ExerciseEditor.js
-./src/components/muscle-map
-./src/components/.DS_Store
-./src/components/StoryComposer.tsx
-./src/components/StoryComposer 2.tsx
-./src/components/RestTimerOverlay.js
-./src/components/HistoryList.js
-./src/components/TeamRoomCard.js
-./src/components/SettingsModal.js
-./src/components/ActiveWorkout 2.js
-./src/components/OfflineSyncModal.js
-./src/components/LoginScreen 2.js
-./src/components/CoachChatModal.js
-./src/components/ErrorReporterProvider.js
-./src/components/InviteManager.js
-./src/components/HeaderActionsMenu.js
-./src/components/WorkoutReport.js
-./src/components/ChatUserSearch.js
-./src/components/ExecutionVideoCapture.js
-./src/components/InviteAcceptedModal.js
-./src/components/admin
-./src/components/VipHub.js
-./src/components/ChatScreen.js
-./src/components/WhatsNewModal.tsx
-./src/components/GlobalDialog.js
-./src/components/assessment
-./src/components/WelcomeFloatingWindow.js
-./src/components/HistoryList 2.js
-./src/components/dashboard
-./src/components/LoginScreen.js
-./src/components/NotificationToast.js
-./src/components/stories
-./src/components/FollowRequestModalGate.js
-./src/components/ChatListScreen.js
-./src/components/MiniPlayer.js
-./src/components/StudentEvolution.js
-./src/components/IncomingInviteModal.js
-./src/components/ErrorBoundary.js
-./src/components/RealtimeNotificationBridge.js
-./src/components/ExerciseEditor 2.js
-./src/components/AdminWorkoutEditor.js
-./src/components/ChatDirectScreen.js
-./src/components/ServiceWorkerRegister.js
-./src/components/NotificationCenter.js
-./src/components/AdminPanelV2 2.js
-./src/components/onboarding
-./src/components/ServiceWorkerRegister 2.js
-
-./src/components/admin
-./src/components/admin/RequestsTab.js
-./src/components/admin/RequestsTab 2.js
-./src/components/admin/AdminVipReports.js
-
-./src/components/assessment
-./src/components/assessment/PhotoUploadStep.tsx
-./src/components/assessment/AssessmentHistory.tsx
-./src/components/assessment/AssessmentButton 2.tsx
-./src/components/assessment/AssessmentButton.tsx
-./src/components/assessment/SkinfoldStep.tsx
-./src/components/assessment/AssessmentPDFGenerator.tsx
-./src/components/assessment/MeasurementStep.tsx
-./src/components/assessment/__tests__
-./src/components/assessment/__tests__/AssessmentForm.test.tsx
-./src/components/assessment/BasicInfoStep.tsx
-./src/components/assessment/ResultsPreview.tsx
-./src/components/assessment/AssessmentForm.tsx
-
-./src/components/dashboard
-./src/components/dashboard/StudentDashboard.tsx
-./src/components/dashboard/WorkoutWizardModal.tsx
-./src/components/dashboard/WorkoutCalendarModal.tsx
-./src/components/dashboard/StudentDashboard 3.tsx
-./src/components/dashboard/StudentDashboard 2.tsx
-./src/components/dashboard/MuscleMapCard.tsx
-./src/components/dashboard/BadgesGallery.tsx
-./src/components/dashboard/StoriesBar.tsx
-./src/components/dashboard/RecentAchievements.tsx
-./src/components/dashboard/BadgesInline.tsx
-./src/components/dashboard/StudentDashboard3.tsx
-./src/components/dashboard/nutrition
-./src/components/dashboard/nutrition/NutritionMixer.tsx
-./src/components/dashboard/StoriesBar 3.tsx
-./src/components/dashboard/StoriesBar 2.tsx
-
-./src/components/stories
-./src/components/stories/StoryViewer.tsx
-./src/components/stories/StoryCreatorModal 2.tsx
-./src/components/stories/VideoTrimmer.tsx
-./src/components/stories/StoryViewer 2.tsx
-./src/components/stories/VideoTrimmer 3.tsx
-./src/components/stories/StoryCreatorModal.tsx
-./src/components/stories/VideoTrimmer 2.tsx
-
-./src/components/onboarding
-./src/components/onboarding/GuidedTour 2.js
-./src/components/onboarding/GuidedTour 3.js
-./src/components/onboarding/GuidedTour.js
-
-./src/components/ui
-./src/components/ui/BackButton.tsx
-
-./src/components/muscle-map
-./src/components/muscle-map/BodyMapSvg 3.tsx
-./src/components/muscle-map/BodyMapSvg 2.tsx
-./src/components/muscle-map/BodyMapSvg.tsx
-
-./src/app
-./src/app/layout.js
-./src/app/assessments
-./src/app/assessments/[studentId]
-./src/app/assessments/new
-./src/app/favicon.ico
-./src/app/favicon.ico/route 3.ts
-./src/app/favicon.ico/route 2.ts
-./src/app/favicon.ico/route.ts
-./src/app/(app)
-./src/app/(app)/.DS_Store
-./src/app/(app)/dashboard
-./src/app/(app)/layout.tsx
-./src/app/(app)/community
-./src/app/.DS_Store
-./src/app/recovery-bridge-client.tsx
-./src/app/privacy
-./src/app/privacy/page.tsx
-./src/app/privacy/page 2
-./src/app/auth
-./src/app/auth/.DS_Store
-./src/app/auth/recovery
-./src/app/auth/logout
-./src/app/auth/callback
-./src/app/auth/error
-./src/app/auth/login
-./src/app/not-found.jsx
-./src/app/icon.js
-./src/app/marketplace
-./src/app/marketplace/MarketplaceClient.tsx
-./src/app/marketplace/MarketplaceClient 2.tsx
-./src/app/marketplace/page.tsx
-./src/app/error.js
-./src/app/opengraph-image.js
-./src/app/wait-approval
-./src/app/wait-approval/page 2.tsx
-./src/app/wait-approval/page.tsx
-./src/app/_components
-./src/app/_components/DeployBadge.js
-./src/app/_components/AppShell.js
-./src/app/global-error.js
-./src/app/(public)
-./src/app/(public)/page 2.tsx
-./src/app/(public)/page 6.tsx
-./src/app/(public)/page 5.tsx
-./src/app/(public)/page 4.tsx
-./src/app/(public)/page.tsx
-./src/app/(public)/page 3
-./src/app/api
-./src/app/page.tsx
-./src/app/globals.css
-
-./src/app/api/vip
-./src/app/api/vip/chat
-./src/app/api/vip/chat/messages
-./src/app/api/vip/chat/messages/route.ts
-./src/app/api/vip/chat/thread
-./src/app/api/vip/chat/thread/route.ts
-./src/app/api/vip/access
-./src/app/api/vip/access/route.ts
-./src/app/api/vip/access 3
-./src/app/api/vip/access 2
-./src/app/api/vip/welcome-seen
-./src/app/api/vip/welcome-seen/route.ts
-./src/app/api/vip/weekly-summary
-./src/app/api/vip/weekly-summary/route.ts
-./src/app/api/vip/welcome-status
-./src/app/api/vip/welcome-status/route.ts
-./src/app/api/vip/status
-./src/app/api/vip/status/route.ts
-./src/app/api/vip/profile
-./src/app/api/vip/profile/route.ts
-./src/app/api/vip/chat 3
-./src/app/api/vip/profile 3
-./src/app/api/vip/weekly-summary 2
-./src/app/api/vip/chat 2
-./src/app/api/vip/weekly-summary 3
-./src/app/api/vip/profile 2
-./src/app/api/app
-./src/app/api/app/checkout 3
-./src/app/api/app/checkout 2
-./src/app/api/app/plans
-./src/app/api/app/plans/route.ts
-./src/app/api/app/checkout
-./src/app/api/app/checkout/route.ts
-./src/app/api/app/subscriptions 2
-./src/app/api/app/subscriptions
-./src/app/api/app/subscriptions/cancel-pending
-./src/app/api/app/subscriptions/cancel-pending/route.ts
-./src/app/api/app/subscriptions/cancel-active
-./src/app/api/app/subscriptions/cancel-active/route.ts
-./src/app/api/app/subscriptions 3
-./src/app/api/app/plans 2
-./src/app/api/app/plans 3
-./src/app/api/chat
-./src/app/api/chat/messages
-./src/app/api/chat/messages/route.ts
-./src/app/api/chat/delete
-./src/app/api/chat/delete/route.ts
-./src/app/api/chat/direct-dedupe
-./src/app/api/chat/direct-dedupe/route.ts
-./src/app/api/chat/global-id
-./src/app/api/chat/global-id/route.ts
-./src/app/api/chat/send
-./src/app/api/chat/send/route.ts
-./src/app/api/auth
-./src/app/api/auth/ping 2
-./src/app/api/auth/ping 3
-./src/app/api/auth/ping
-./src/app/api/auth/ping/route.ts
-./src/app/api/auth/recovery-code
-./src/app/api/auth/recovery-code/route.ts
-./src/app/api/auth/callback
-./src/app/api/auth/debug
-./src/app/api/workouts
-./src/app/api/workouts/update
-./src/app/api/workouts/update/route.ts
-./src/app/api/workouts/finish
-./src/app/api/workouts/finish/route 3.ts
-./src/app/api/workouts/finish/route 2.ts
-./src/app/api/workouts/finish/route 4
-./src/app/api/workouts/finish/route.ts
-./src/app/api/workouts/finish/route 4.ts
-./src/app/api/workouts/list
-./src/app/api/workouts/list/route 3.ts
-./src/app/api/workouts/list/route 2.ts
-./src/app/api/workouts/list/route.ts
-./src/app/api/assessment-scanner
-./src/app/api/assessment-scanner/route 3.ts
-./src/app/api/assessment-scanner/route 2.ts
-./src/app/api/assessment-scanner/route.ts
-./src/app/api/marketplace
-./src/app/api/marketplace/plans
-./src/app/api/marketplace/plans/route.ts
-./src/app/api/marketplace/health
-./src/app/api/marketplace/health/route.ts
-./src/app/api/marketplace/checkout
-./src/app/api/marketplace/checkout/route.ts
-./src/app/api/marketplace/webhooks
-./src/app/api/marketplace/webhooks/asaas
-./src/app/api/marketplace/webhooks/asaas/route 2.ts
-./src/app/api/marketplace/webhooks/asaas/route.ts
-./src/app/api/admin
-./src/app/api/admin/access-requests
-./src/app/api/admin/access-requests/action
-./src/app/api/admin/access-requests/action/route 2.ts
-./src/app/api/admin/access-requests/action/route.ts
-./src/app/api/admin/access-requests/list
-./src/app/api/admin/access-requests/list/route.ts
-./src/app/api/admin/workouts
-./src/app/api/admin/workouts/sync-templates
-./src/app/api/admin/workouts/sync-templates/route.ts
-./src/app/api/admin/workouts/normalize-titles
-./src/app/api/admin/workouts/normalize-titles/route.ts
-./src/app/api/admin/workouts/delete
-./src/app/api/admin/workouts/delete/route.ts
-./src/app/api/admin/workouts/templates-list
-./src/app/api/admin/workouts/templates-list/route.ts
-./src/app/api/admin/workouts/delete-any
-./src/app/api/admin/workouts/delete-any/route.ts
-./src/app/api/admin/workouts/history
-./src/app/api/admin/workouts/history/route.ts
-./src/app/api/admin/workouts/mine
-./src/app/api/admin/workouts/mine/route.ts
-./src/app/api/admin/workouts/by-student
-./src/app/api/admin/workouts/by-student/route.ts
-./src/app/api/admin/user-activity
-./src/app/api/admin/user-activity/users
-./src/app/api/admin/user-activity/users/route.ts
-./src/app/api/admin/user-activity/events
-./src/app/api/admin/user-activity/events/route.ts
-./src/app/api/admin/user-activity/summary
-./src/app/api/admin/user-activity/summary/route.ts
-./src/app/api/admin/teachers
-./src/app/api/admin/teachers/inbox
-./src/app/api/admin/teachers/inbox/route.ts
-./src/app/api/admin/teachers/delete
-./src/app/api/admin/teachers/delete/route.ts
-./src/app/api/admin/teachers/workouts
-./src/app/api/admin/teachers/workouts/history
-./src/app/api/admin/teachers/workouts/templates
-./src/app/api/admin/teachers/promote
-./src/app/api/admin/teachers/promote/route.ts
-./src/app/api/admin/teachers/asaas
-./src/app/api/admin/teachers/asaas/route.ts
-./src/app/api/admin/teachers/status
-./src/app/api/admin/teachers/status/route.ts
-./src/app/api/admin/teachers/students
-./src/app/api/admin/teachers/students/route.ts
-./src/app/api/admin/teachers/list
-./src/app/api/admin/teachers/list/route.ts
-./src/app/api/admin/exercise-videos
-./src/app/api/admin/exercise-videos/suggest
-./src/app/api/admin/exercise-videos/suggest/route.ts
-./src/app/api/admin/exercise-videos/backfill
-./src/app/api/admin/exercise-videos/backfill/route.ts
-./src/app/api/admin/exercise-videos/backfill 2
-./src/app/api/admin/exercise-videos/suggest 2
-./src/app/api/admin/students
-./src/app/api/admin/students/assign-teacher
-./src/app/api/admin/students/assign-teacher/route.ts
-./src/app/api/admin/students/status
-./src/app/api/admin/students/status/route.ts
-./src/app/api/admin/students/list
-./src/app/api/admin/students/list/route.ts
-./src/app/api/admin/exercises
-./src/app/api/admin/exercises/canonicalize 2
-./src/app/api/admin/exercises/canonicalize 2/backfill
-./src/app/api/admin/exercises/canonicalize
-./src/app/api/admin/exercises/canonicalize/backfill
-./src/app/api/admin/legacy-students
-./src/app/api/admin/legacy-students/route.ts
-./src/app/api/execution-videos
-./src/app/api/execution-videos/prepare
-./src/app/api/execution-videos/prepare/route.ts
-./src/app/api/execution-videos/complete
-./src/app/api/execution-videos/complete/route.ts
-./src/app/api/execution-videos/media 3
-./src/app/api/execution-videos/media 2
-./src/app/api/execution-videos/complete 2
-./src/app/api/execution-videos/prepare 3
-./src/app/api/execution-videos/prepare 2
-./src/app/api/execution-videos/media
-./src/app/api/execution-videos/media/route.ts
-./src/app/api/execution-videos/complete 3
-./src/app/api/teachers
-./src/app/api/teachers/accept
-./src/app/api/teachers/accept/route.ts
-./src/app/api/teachers/me
-./src/app/api/teachers/me/route.ts
-./src/app/api/teachers/wallet
-./src/app/api/teachers/wallet/route.ts
-./src/app/api/user
-./src/app/api/user/vip-credits
-./src/app/api/user/vip-credits/route.ts
-./src/app/api/updates
-./src/app/api/updates/unseen
-./src/app/api/updates/unseen/route.ts
-./src/app/api/updates/mark-prompted
-./src/app/api/updates/mark-prompted/route.ts
-./src/app/api/updates/mark-viewed
-./src/app/api/updates/mark-viewed/route.ts
-./src/app/api/storage
-./src/app/api/storage/signed-upload
-./src/app/api/storage/signed-upload/route.ts
-./src/app/api/storage/purge-chat-media
-./src/app/api/storage/purge-chat-media/route.ts
-./src/app/api/storage/social-stories
-./src/app/api/storage/social-stories/signed-upload
-./src/app/api/storage/social-stories/signed-upload/route.ts
-./src/app/api/storage/social-stories/signed-upload 2
-./src/app/api/storage/ensure-bucket
-./src/app/api/storage/ensure-bucket/route.ts
-./src/app/api/access-request
-./src/app/api/access-request/create 2
-./src/app/api/access-request/create
-./src/app/api/access-request/create/route 2.ts
-./src/app/api/access-request/create/route.ts
-./src/app/api/supabase
-./src/app/api/supabase/status
-./src/app/api/supabase/status/route 2.ts
-./src/app/api/supabase/status/route.ts
-./src/app/api/dashboard
-./src/app/api/dashboard/bootstrap
-./src/app/api/dashboard/bootstrap/route.ts
-./src/app/api/dashboard/bootstrap 3
-./src/app/api/dashboard/bootstrap 2
-./src/app/api/students
-./src/app/api/students/me
-./src/app/api/students/me/status
-./src/app/api/students/me/status/route.ts
-./src/app/api/social
-./src/app/api/social/workout-start 2
-./src/app/api/social/workout-start 3
-./src/app/api/social/workout-start
-./src/app/api/social/workout-start/route.ts
-./src/app/api/social/follow 2
-./src/app/api/social/follow
-./src/app/api/social/follow/cancel
-./src/app/api/social/follow/cancel/route.ts
-./src/app/api/social/follow/route.ts
-./src/app/api/social/follow/respond
-./src/app/api/social/follow/respond/route.ts
-./src/app/api/social/follow 3
-./src/app/api/social/stories 3
-./src/app/api/social/stories 2
-./src/app/api/social/stories
-./src/app/api/social/stories/comments
-./src/app/api/social/stories/comments/route.ts
-./src/app/api/social/stories/like
-./src/app/api/social/stories/like/route.ts
-./src/app/api/social/stories/delete
-./src/app/api/social/stories/delete/route 3.ts
-./src/app/api/social/stories/delete/route 2.ts
-./src/app/api/social/stories/delete/route.ts
-./src/app/api/social/stories/list
-./src/app/api/social/stories/list/route 2.ts
-./src/app/api/social/stories/list/route.ts
-./src/app/api/social/stories/view
-./src/app/api/social/stories/view/route.ts
-./src/app/api/social/stories/views
-./src/app/api/social/stories/views/route.ts
-./src/app/api/social/stories/create
-./src/app/api/social/stories/create/route 2.ts
-./src/app/api/social/stories/create/route.ts
-./src/app/api/social/stories/media
-./src/app/api/social/stories/media/route 2.ts
-./src/app/api/social/stories/media/route.ts
-./src/app/api/social/presence
-./src/app/api/social/presence/ping
-./src/app/api/social/presence/ping/route.ts
-./src/app/api/social/presence 2
-./src/app/api/social/presence 3
-./src/app/api/team
-./src/app/api/team/invite-candidates
-./src/app/api/team/invite-candidates/route.ts
-./src/app/api/version
-./src/app/api/version/route.ts
-./src/app/api/exercise-library
-./src/app/api/exercise-library/resolve 3
-./src/app/api/exercise-library/resolve 2
-./src/app/api/exercise-library/resolve
-./src/app/api/exercise-library/resolve/route.ts
-./src/app/api/exercises
-./src/app/api/exercises/canonicalize
-./src/app/api/exercises/canonicalize/route 2.ts
-./src/app/api/exercises/canonicalize/route.ts
-./src/app/api/exercises/search
-./src/app/api/exercises/search/route.ts
-./src/app/api/ai
-./src/app/api/ai/post-workout-insights 3
-./src/app/api/ai/exercise-muscle-map
-./src/app/api/ai/exercise-muscle-map/route.ts
-./src/app/api/ai/post-workout-insights 2
-./src/app/api/ai/apply-progression-next
-./src/app/api/ai/apply-progression-next/route.ts
-./src/app/api/ai/coach-chat
-./src/app/api/ai/coach-chat/route 2.ts
-./src/app/api/ai/coach-chat/route.ts
-./src/app/api/ai/exercise-muscle-map 3
-./src/app/api/ai/workout-wizard 2
-./src/app/api/ai/period-report
-./src/app/api/ai/apply-progression-next 3
-./src/app/api/ai/workout-wizard 3
-./src/app/api/ai/exercise-muscle-map 2
-./src/app/api/ai/apply-progression-next 2
-./src/app/api/ai/muscle-map-week 2
-./src/app/api/ai/muscle-map-week 3
-./src/app/api/ai/muscle-map-day 3
-./src/app/api/ai/coach-chat 3
-./src/app/api/ai/muscle-map-day 2
-./src/app/api/ai/coach-chat 2
-./src/app/api/ai/exercise-muscle-map-backfill 2
-./src/app/api/ai/exercise-muscle-map-backfill
-./src/app/api/ai/exercise-muscle-map-backfill/route.ts
-./src/app/api/ai/vip-coach 3
-./src/app/api/ai/exercise-muscle-map-backfill 3
-./src/app/api/ai/muscle-map-week
-./src/app/api/ai/muscle-map-week/route.ts
-./src/app/api/ai/vip-coach 2
-./src/app/api/ai/muscle-map-day
-./src/app/api/ai/muscle-map-day/route.ts
-./src/app/api/ai/post-workout-insights
-./src/app/api/ai/post-workout-insights/route.ts
-./src/app/api/ai/workout-wizard
-./src/app/api/ai/workout-wizard/route 2.ts
-./src/app/api/ai/workout-wizard/route.ts
-./src/app/api/ai/vip-coach
-./src/app/api/ai/vip-coach/route.ts
-./src/app/api/diagnostics
-./src/app/api/diagnostics/iron-rank
-./src/app/api/diagnostics/iron-rank/route 2.ts
-./src/app/api/diagnostics/iron-rank/route.ts
-./src/app/api/diagnostics/chat
-./src/app/api/diagnostics/chat/route.ts
-./src/app/api/diagnostics/workouts
-./src/app/api/diagnostics/workouts/route.ts
-./src/app/api/report
-./src/app/api/report/route.js
-./src/app/api/telemetry
-./src/app/api/telemetry/user-event 2
-./src/app/api/telemetry/user-event
-./src/app/api/telemetry/user-event/route.ts
-./src/app/api/errors
-./src/app/api/errors/report 3
-./src/app/api/errors/report 2
-./src/app/api/errors/report
-./src/app/api/errors/report/route.ts
-./src/app/api/profiles
-./src/app/api/profiles/ping 2
-./src/app/api/profiles/ping 3
-./src/app/api/profiles/ping
-./src/app/api/profiles/ping/route.ts
-./src/app/api/account
-./src/app/api/account/delete
-./src/app/api/account/delete/route.ts
-./src/app/api/account/delete 2
-./src/app/api/account/delete 3
-./src/app/api/account/export 3
-./src/app/api/account/export
-./src/app/api/account/export/route.ts
-./src/app/api/account/export 2
-./src/app/api/calories
-./src/app/api/calories/estimate 3
-./src/app/api/calories/estimate 2
-./src/app/api/calories/estimate
-./src/app/api/calories/estimate/route.ts
-./src/app/api/teacher
-./src/app/api/teacher/inbox
-./src/app/api/teacher/inbox/send-message
-./src/app/api/teacher/inbox/send-message/route.ts
-./src/app/api/teacher/inbox/action
-./src/app/api/teacher/inbox/action/route.ts
-./src/app/api/teacher/inbox/feed
-./src/app/api/teacher/inbox/feed/route.ts
-./src/app/api/teacher/execution-videos
-./src/app/api/teacher/execution-videos/review
-./src/app/api/teacher/execution-videos/review/route.ts
-./src/app/api/teacher/execution-videos/by-student
-./src/app/api/teacher/execution-videos/by-student/route.ts
-./src/app/api/teacher/inbox 3
-./src/app/api/teacher/inbox 2
-./src/app/api/teacher/execution-videos 3
-./src/app/api/teacher/execution-videos 2
-./src/app/api/iron-scanner
-./src/app/api/iron-scanner/route.ts
-./src/app/api/notifications
-./src/app/api/notifications/appointment-created
-./src/app/api/notifications/appointment-created/route.ts
-./src/app/api/notifications/direct-message
-./src/app/api/notifications/direct-message/route.ts
-./src/app/api/billing
-./src/app/api/billing/mercadopago 3
-./src/app/api/billing/mercadopago 2
-./src/app/api/billing/mercadopago
-./src/app/api/billing/mercadopago/subscribe
-./src/app/api/billing/mercadopago/subscribe/route.ts
-./src/app/api/billing/webhooks 2
-./src/app/api/billing/webhooks 3
-./src/app/api/billing/revenuecat
-./src/app/api/billing/revenuecat/sync
-./src/app/api/billing/revenuecat/sync/route.ts
-./src/app/api/billing/webhooks
-./src/app/api/billing/webhooks/mercadopago
-./src/app/api/billing/webhooks/mercadopago/route.ts
-./src/app/api/cron
-./src/app/api/cron/cleanup-expired
-./src/app/api/cron/cleanup-expired/route.ts
-./src/app/api/cron/purge-soft-delete-bin
-./src/app/api/cron/purge-soft-delete-bin/route.ts
-./src/app/api/debug
-./src/app/api/debug/cookies 3
-./src/app/api/debug/cookies 2
-./src/app/api/debug/cookies
-./src/app/api/debug/cookies/route.ts
-
-./src/contexts
-./src/contexts/DialogContext.js
-./src/contexts/InAppNotificationsContext.js
-./src/contexts/TeamWorkoutContext.js
-
-./src/content
-./src/content/vipPlaybooks.ts
-./src/content/whatsNew.ts
-
-./src/utils
-./src/utils/workoutAutoGenerator.ts
-./src/utils/vip
-./src/utils/vip/limits.ts
-./src/utils/.DS_Store
-./src/utils/mediaUtils.ts
-./src/utils/pacing.ts
-./src/utils/tourSteps.js
-./src/utils/chat
-./src/utils/chat/media.js
-./src/utils/auth
-./src/utils/auth/route.ts
-./src/utils/training
-./src/utils/training/notesMethodParser 3.js
-./src/utils/training/notesMethodParser 2.js
-./src/utils/training/notesMethodParser.js
-./src/utils/trainingNumber.js
-./src/utils/exerciseCanonical.ts
-./src/utils/exerciseMuscleHeuristics.ts
-./src/utils/platform.ts
-./src/utils/supabase
-./src/utils/supabase/client 3.ts
-./src/utils/supabase/middleware.ts
-./src/utils/supabase/client 2.ts
-./src/utils/supabase/middleware 3.ts
-./src/utils/supabase/cookieOptions 2.ts
-./src/utils/supabase/admin.ts
-./src/utils/supabase/cookieOptions 3.ts
-./src/utils/supabase/middleware 2.ts
-./src/utils/supabase/cookieOptions.ts
-./src/utils/supabase/client.ts
-./src/utils/supabase/middleware - cópia.ts
-./src/utils/supabase/server 2.ts
-./src/utils/supabase/server.ts
-./src/utils/workoutWizardAiValidation.ts
-./src/utils/__tests__
-./src/utils/__tests__/mediaUtils.test 2.ts
-./src/utils/__tests__/mediaUtils.test.ts
-./src/utils/workoutTitle.js
-./src/utils/calculations
-./src/utils/calculations/bodyComposition.ts
-./src/utils/report
-./src/utils/report/templates 2.js
-./src/utils/report/buildHtml.js
-./src/utils/report/buildPeriodReportHtml 2.js
-./src/utils/report/buildPeriodReportHtml.js
-./src/utils/report/generatePdf.js
-./src/utils/report/templates.js
-./src/utils/report/buildHtml 2.js
-./src/utils/featureFlags.js
-./src/utils/calories
-./src/utils/calories/kcalClient.js
-./src/utils/calories/kcalClient 2
-./src/utils/calories/kcalClient 3.js
-./src/utils/workoutWizardGenerator.ts
-./src/utils/normalizeExerciseName.ts
-./src/utils/muscleMapConfig.ts
-
-./src/types
-./src/types/supabase.ts
-./src/types/social.ts
-./src/types/assessment.ts
-
-./src/hooks
-./src/hooks/useAssessment.ts
-./src/hooks/useAssessment 2.ts
-./src/hooks/useAssessment 3.ts
-./src/hooks/useAssessment 4.ts
-./src/hooks/useVipCredits.js
-./src/hooks/useUserSettings.js
-
-./src/actions
-./src/actions/workout-actions 2.js
-./src/actions/iron-scanner-actions.ts
-./src/actions/chat-actions.js
-./src/actions/assessment-scanner-actions.ts
-./src/actions/workout-actions.js
-./src/actions/admin-actions.js
-
-./src/lib
-./src/lib/video
-./src/lib/video/__tests__ 2
-./src/lib/video/VideoCompositor 2.ts
-./src/lib/video/VideoCompositor 3.ts
-./src/lib/video/VideoCompositor.ts
-./src/lib/video/__tests__
-./src/lib/video/__tests__/VideoCompositor.test.ts
-./src/lib/.DS_Store
-./src/lib/workoutSync.ts
-./src/lib/asaas.ts
-./src/lib/version.js
-./src/lib/sounds.js
-./src/lib/videoSuggestions.ts
-./src/lib/workoutReorder.js
-./src/lib/social
-./src/lib/social/storyValidation.ts
-./src/lib/social/notifyFollowers.js
-./src/lib/social/storyValidation 2.ts
-./src/lib/social/notifyFollowers 2.js
-./src/lib/social/notifyFollowers 3.js
-./src/lib/logger.ts
-./src/lib/__tests__
-./src/lib/__tests__/workoutReorder.test.js
-./src/lib/telemetry
-./src/lib/telemetry/userActivity.ts
-./src/lib/chatDiagnostics.ts
-./src/lib/mercadopago.ts
-./src/lib/nutrition
-./src/lib/nutrition/food-database.ts
-./src/lib/nutrition/engine.ts
-./src/lib/nutrition/parser.ts
-./src/lib/offline
-./src/lib/offline/_probe.txt
-./src/lib/offline/offlineSync 2
-./src/lib/offline/idb.js
-./src/lib/offline/_probe 2
-./src/lib/offline/offlineSync 3.js
-./src/lib/offline/offlineSync.js
-./src/lib/offline/_probe 3.txt
-./src/lib/offline/idb 3.js
-./src/lib/offline/idb 2.js
-
-./public
-./public/sw 5.js
-./public/sw 4.js
-./public/icone.png
-./public/sw 3.js
-./public/sw 2.js
-./public/manifest.json
-./public/sw 6.js
-./public/sw.js
-
-./supabase
-./supabase/migrations
-./supabase/tests
-./supabase/tests/rls_workouts_silos_check.sql
-./supabase/.temp
-./supabase/.temp/postgres-version
-./supabase/.temp/project-ref
-./supabase/.temp/rest-version
-./supabase/.temp/storage-version
-./supabase/.temp/gotrue-version
-./supabase/.temp/pooler-url
-./supabase/.temp/storage-migration
-./supabase/.temp/cli-latest
-./supabase/scripts
-./supabase/scripts/auth_v2_repair.sql
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/100 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/100 2.png
deleted file mode 100644
index 75a6dad..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/100 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/102 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/102 2.png
deleted file mode 100644
index 51f3d9a..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/102 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/1024 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/1024 2.png
deleted file mode 100644
index c53d788..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/1024 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/108 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/108 2.png
deleted file mode 100644
index 1a4943a..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/108 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/114 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/114 2.png
deleted file mode 100644
index 509e214..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/114 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/120 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/120 2.png
deleted file mode 100644
index 39c56b5..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/120 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/128 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/128 2.png
deleted file mode 100644
index 95a0da6..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/128 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/144 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/144 2.png
deleted file mode 100644
index 37a6598..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/144 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/152 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/152 2.png
deleted file mode 100644
index 1e6896c..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/152 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/16 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/16 2.png
deleted file mode 100644
index c841e62..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/16 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/167 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/167 2.png
deleted file mode 100644
index b5ae42f..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/167 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/180 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/180 2.png
deleted file mode 100644
index 343b79b..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/180 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/196 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/196 2.png
deleted file mode 100644
index c7c84ce..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/196 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/20 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/20 2.png
deleted file mode 100644
index a232302..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/20 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/216 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/216 2.png
deleted file mode 100644
index 2527804..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/216 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/234 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/234 2.png
deleted file mode 100644
index 683e440..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/234 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/256 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/256 2.png
deleted file mode 100644
index 312aa17..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/256 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/258 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/258 2.png
deleted file mode 100644
index d595a3b..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/258 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/29 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/29 2.png
deleted file mode 100644
index fbbb305..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/29 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/40 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/40 2.png
deleted file mode 100644
index bdd4319..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/40 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/48 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/48 2.png
deleted file mode 100644
index 1a56cad..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/48 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/50 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/50 2.png
deleted file mode 100644
index fe90a41..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/50 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/512 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/512 2.png
deleted file mode 100644
index d453960..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/512 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/55 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/55 2.png
deleted file mode 100644
index 5010eef..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/55 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/57 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/57 2.png
deleted file mode 100644
index cbe4aae..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/57 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/58 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/58 2.png
deleted file mode 100644
index 3a4a2c9..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/58 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/60 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/60 2.png
deleted file mode 100644
index e83a7b4..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/60 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/64 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/64 2.png
deleted file mode 100644
index 24d8f59..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/64 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/66 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/66 2.png
deleted file mode 100644
index e2f0b17..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/66 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/72 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/72 2.png
deleted file mode 100644
index df8e768..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/72 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/76 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/76 2.png
deleted file mode 100644
index 540fbd5..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/76 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/80 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/80 2.png
deleted file mode 100644
index 47b2591..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/80 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/87 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/87 2.png
deleted file mode 100644
index 2066afe..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/87 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/88 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/88 2.png
deleted file mode 100644
index 6e67b63..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/88 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/92 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/92 2.png
deleted file mode 100644
index e47b41d..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/92 2.png and /dev/null differ
diff --git a/ios/App/App/Assets.xcassets/AppIcon.appiconset/AppIcon-512@2x 2.png b/ios/App/App/Assets.xcassets/AppIcon.appiconset/AppIcon-512@2x 2.png
deleted file mode 100644
index adf6ba0..0000000
Binary files a/ios/App/App/Assets.xcassets/AppIcon.appiconset/AppIcon-512@2x 2.png and /dev/null differ
diff --git a/ios/App/App/Info 2.plist b/ios/App/App/Info 2.plist
deleted file mode 100644
index 8a9a055..0000000
--- a/ios/App/App/Info 2.plist	
+++ /dev/null
@@ -1,51 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
-<plist version="1.0">
-<dict>
-    <key>CAPACITOR_DEBUG</key>
-	<string>$(CAPACITOR_DEBUG)</string>
-	<key>CFBundleDevelopmentRegion</key>
-	<string>en</string>
-	<key>CFBundleDisplayName</key>
-        <string>IronTracks</string>
-	<key>CFBundleExecutable</key>
-	<string>$(EXECUTABLE_NAME)</string>
-	<key>CFBundleIdentifier</key>
-	<string>$(PRODUCT_BUNDLE_IDENTIFIER)</string>
-	<key>CFBundleInfoDictionaryVersion</key>
-	<string>6.0</string>
-	<key>CFBundleName</key>
-	<string>$(PRODUCT_NAME)</string>
-	<key>CFBundlePackageType</key>
-	<string>APPL</string>
-	<key>CFBundleShortVersionString</key>
-	<string>$(MARKETING_VERSION)</string>
-	<key>CFBundleVersion</key>
-	<string>$(CURRENT_PROJECT_VERSION)</string>
-	<key>LSRequiresIPhoneOS</key>
-	<true/>
-	<key>UILaunchStoryboardName</key>
-	<string>LaunchScreen</string>
-	<key>UIMainStoryboardFile</key>
-	<string>Main</string>
-	<key>UIRequiredDeviceCapabilities</key>
-	<array>
-		<string>armv7</string>
-	</array>
-	<key>UISupportedInterfaceOrientations</key>
-	<array>
-		<string>UIInterfaceOrientationPortrait</string>
-		<string>UIInterfaceOrientationLandscapeLeft</string>
-		<string>UIInterfaceOrientationLandscapeRight</string>
-	</array>
-	<key>UISupportedInterfaceOrientations~ipad</key>
-	<array>
-		<string>UIInterfaceOrientationPortrait</string>
-		<string>UIInterfaceOrientationPortraitUpsideDown</string>
-		<string>UIInterfaceOrientationLandscapeLeft</string>
-		<string>UIInterfaceOrientationLandscapeRight</string>
-	</array>
-	<key>UIViewControllerBasedStatusBarAppearance</key>
-	<true/>
-</dict>
-</plist>
diff --git a/ios/App/App/config 2.xml b/ios/App/App/config 2.xml
deleted file mode 100644
index 1b1b0e0..0000000
--- a/ios/App/App/config 2.xml	
+++ /dev/null
@@ -1,6 +0,0 @@
-<?xml version='1.0' encoding='utf-8'?>
-<widget version="1.0.0" xmlns="http://www.w3.org/ns/widgets" xmlns:cdv="http://cordova.apache.org/ns/1.0">
-  <access origin="*" />
-  
-  
-</widget>
\ No newline at end of file
diff --git a/ios/debug 2.xcconfig b/ios/debug 2.xcconfig
deleted file mode 100644
index 53ce18d..0000000
--- a/ios/debug 2.xcconfig	
+++ /dev/null
@@ -1 +0,0 @@
-CAPACITOR_DEBUG = true
diff --git a/package.json b/package.json
index 47e5d0b..e0b90ca 100644
--- a/package.json
+++ b/package.json
@@ -13,7 +13,7 @@
     "build": "next build",
     "start": "next start",
     "lint": "eslint",
-    "test:smoke": "node scripts/delete-teacher-cascade.test.cjs && node scripts/vip-entitlement.test.cjs && node scripts/admin-routes-smoke.test.cjs && node scripts/auth-origin-smoke.test.cjs && node scripts/no-duplicate-style-files.test.cjs && node scripts/vip-endpoints-no-dup.test.cjs && node scripts/workouts-history-enforcement.test.cjs && node scripts/finish-payload-smoke.test.cjs",
+    "test:smoke": "node scripts/delete-teacher-cascade.test.cjs && node scripts/vip-entitlement.test.cjs && node scripts/admin-routes-smoke.test.cjs && node scripts/auth-origin-smoke.test.cjs && node scripts/auth-login-origin-smoke.test.cjs && node scripts/no-duplicate-style-files.test.cjs && node scripts/vip-endpoints-no-dup.test.cjs && node scripts/workouts-history-enforcement.test.cjs && node scripts/finish-payload-smoke.test.cjs && node scripts/ai-routes-smoke.test.cjs",
     "flags:report": "NODE_NO_WARNINGS=1 node scripts/feature-flags-report.mjs",
     "deploy": "echo '⛔️ PARE! O deploy agora é automático via GitHub. Faça commit e push na main.' && exit 1",
     "e2e:deload": "node scripts/e2e/deload.e2e.js",
diff --git a/scripts/test-story-validation 2.js b/scripts/test-story-validation 2.js
deleted file mode 100644
index ff257e2..0000000
--- a/scripts/test-story-validation 2.js	
+++ /dev/null
@@ -1,85 +0,0 @@
-const { isAllowedStoryPath, validateStoryPayload } = require('../src/lib/social/storyValidation.ts')
-
-// Note: Since the imported file is TS, we might have issues running this directly with node if we don't compile or use ts-node.
-// Ideally, we should compile. But for simplicity in this environment, I will duplicate the logic HERE for the test script to be self-contained and run immediately,
-// OR I can use the previous approach of just testing the logic file if I can run TS.
-// Since I can't easily run TS, I will create a JS version of the test that *copies* the logic to verify it works as intended conceptually, 
-// OR I rely on the fact that I just extracted it.
-// Actually, `trae-sandbox` environment often supports `ts-node` or `bun`? 
-// The environment said "shell_type: zsh".
-// I'll stick to a JS test script that defines the functions locally (as a "spec") and asserts they behave correctly. 
-// This validates the ALGORITHM, even if it doesn't import the file.
-// BUT, to be rigorous, I should try to import.
-// Let's try to read the file content and eval it? No, that's messy.
-// I will just rewrite the test to be a pure JS logic test of the ALGORITHM I just wrote.
-
-// ... Actually, the user wants "Automated Tests".
-// I'll create a `scripts/test-story-validation.js` that mimics the logic exactly.
-
-const isAllowedStoryPath_TEST = (userId, path) => {
-  const uid = String(userId || '').trim()
-  const p = String(path || '').trim()
-  if (!uid || !p) return false
-  if (p.includes('..') || p.includes('\\') || p.includes('\0') || p.startsWith('/')) return false
-  const parts = p.split('/').filter(Boolean)
-  if (parts.length < 3) return false
-  if (parts[0] !== uid) return false
-  if (parts[1] !== 'stories') return false
-  const name = parts.slice(2).join('/')
-  if (
-    !name.endsWith('.jpg') &&
-    !name.endsWith('.jpeg') &&
-    !name.endsWith('.png') &&
-    !name.endsWith('.mp4') &&
-    !name.endsWith('.mov') &&
-    !name.endsWith('.webm')
-  )
-    return false
-  return true
-}
-
-const validateStoryPayload_TEST = (body) => {
-  const mediaPath = String(body?.mediaPath || body?.media_path || '').trim()
-  const caption = body?.caption != null ? String(body.caption).trim() : null
-  const meta = body?.meta && typeof body.meta === 'object' ? body.meta : {}
-
-  if (!mediaPath) return { ok: false, error: 'media_path required' }
-  
-  return { ok: true, data: { mediaPath, caption, meta } }
-}
-
-// --- Test Runner ---
-let passed = 0
-let failed = 0
-
-function assert(desc, condition) {
-  if (condition) {
-    console.log(`✅ ${desc}`)
-    passed++
-  } else {
-    console.error(`❌ ${desc}`)
-    failed++
-  }
-}
-
-console.log('--- TEST: Story Validation Logic ---\n')
-
-// 1. Payload Validation
-const validBody = { mediaPath: 'u123/stories/abc.jpg', caption: 'Cool', meta: { layout: 'live' } }
-const res1 = validateStoryPayload_TEST(validBody)
-assert('Valid payload returns ok', res1.ok === true && res1.data.mediaPath === 'u123/stories/abc.jpg')
-
-const invalidBody = { caption: 'No path' }
-const res2 = validateStoryPayload_TEST(invalidBody)
-assert('Invalid payload (missing path) returns error', res2.ok === false && res2.error === 'media_path required')
-
-// 2. Path Security
-assert('Path allowed for correct user', isAllowedStoryPath_TEST('user123', 'user123/stories/vid.mp4') === true)
-assert('Path denied for wrong user', isAllowedStoryPath_TEST('user123', 'other/stories/vid.mp4') === false)
-assert('Path denied for path traversal', isAllowedStoryPath_TEST('user123', 'user123/stories/../secret.txt') === false)
-assert('Path denied for wrong folder', isAllowedStoryPath_TEST('user123', 'user123/posts/img.jpg') === false)
-assert('Path denied for invalid extension', isAllowedStoryPath_TEST('user123', 'user123/stories/script.js') === false)
-assert('Path denied for root path', isAllowedStoryPath_TEST('user123', '/user123/stories/img.jpg') === false)
-
-console.log(`\n--- RESULT: ${passed} Passed, ${failed} Failed ---`)
-if (failed > 0) process.exit(1)
diff --git a/scripts/test-trimming 2.js b/scripts/test-trimming 2.js
deleted file mode 100644
index 9d986e6..0000000
--- a/scripts/test-trimming 2.js	
+++ /dev/null
@@ -1,72 +0,0 @@
-// Teste simplificado da lógica de trimming
-// Como não temos DOM real aqui, simulamos os eventos e estados
-
-const MIN_DURATION = 1
-const MAX_DURATION = 15
-
-// Lógica pura de cálculo de range
-const calculateNewRange = (
-    currentStart, 
-    currentEnd, 
-    newTime, 
-    type, // 'start' | 'end'
-    duration
-) => {
-    let start = currentStart
-    let end = currentEnd
-    
-    if (type === 'start') {
-        const maxStart = end - MIN_DURATION
-        const minStart = Math.max(0, end - MAX_DURATION)
-        start = Math.max(minStart, Math.min(maxStart, newTime))
-    } else {
-        const minEnd = start + MIN_DURATION
-        const maxEnd = Math.min(duration, start + MAX_DURATION)
-        end = Math.max(minEnd, Math.min(maxEnd, newTime))
-    }
-    return [start, end]
-}
-
-// --- Test Runner ---
-let passed = 0
-let failed = 0
-
-function assert(desc, cond) {
-    if (cond) {
-        console.log(`✅ ${desc}`)
-        passed++
-    } else {
-        console.error(`❌ ${desc}`)
-        failed++
-    }
-}
-
-console.log('--- Iniciando Testes de Trimming Logic ---\n')
-
-// Caso 1: Mover inicio normalmente
-// 0-10s, mover inicio para 2s
-let res = calculateNewRange(0, 10, 2, 'start', 60)
-assert('Move Start Normal', res[0] === 2 && res[1] === 10)
-
-// Caso 2: Tentar mover inicio além do fim (min duration)
-// 0-10s, mover inicio para 9.5s (deve travar em 9s pois min é 1s)
-res = calculateNewRange(0, 10, 9.5, 'start', 60)
-assert('Constraint Min Duration (Start)', res[0] === 9 && res[1] === 10)
-
-// Caso 3: Tentar estender fim além do max (max duration)
-// 0-10s, mover fim para 20s (max é 15s, então deve ir até 15s)
-res = calculateNewRange(0, 10, 20, 'end', 60)
-assert('Constraint Max Duration (End)', res[0] === 0 && res[1] === 15)
-
-// Caso 4: Mover fim para trás do inicio (min duration)
-// 5-10s, mover fim para 5.5s (deve travar em 6s)
-res = calculateNewRange(5, 10, 5.5, 'end', 60)
-assert('Constraint Min Duration (End)', res[0] === 5 && res[1] === 6)
-
-// Caso 5: Tentar mover inicio para trás demais (max duration constraint relative to end)
-// 20-30s, mover inicio para 0s (deve travar em 15s pois 30-15=15)
-res = calculateNewRange(20, 30, 0, 'start', 60)
-assert('Constraint Max Duration (Start)', res[0] === 15 && res[1] === 30)
-
-console.log(`\n--- Resultados: ${passed} Passou, ${failed} Falhou ---`)
-if (failed > 0) process.exit(1)
diff --git a/scripts/validate-media-logic 2.js b/scripts/validate-media-logic 2.js
deleted file mode 100644
index e09fdeb..0000000
--- a/scripts/validate-media-logic 2.js	
+++ /dev/null
@@ -1,78 +0,0 @@
-// Script de validação de lógica de mídia (Standalone)
-// Executar com: node scripts/validate-media-logic.js
-
-const parseExt = (rawName) => {
-  const n = String(rawName || '').trim().toLowerCase()
-  const i = n.lastIndexOf('.')
-  if (i < 0) return ''
-  const ext = n.slice(i)
-  return ['.jpeg', '.jpg', '.png', '.mp4', '.mov', '.webm'].includes(ext) ? ext : ''
-}
-
-const guessMediaKind = (mime, ext) => {
-  const t = String(mime || '').trim().toLowerCase()
-  if (t.startsWith('video/')) return 'video'
-  if (t.startsWith('image/')) return 'image'
-  if (['.mp4', '.mov', '.webm'].includes(ext)) return 'video'
-  if (['.jpg', '.jpeg', '.png'].includes(ext)) return 'image'
-  return 'unknown'
-}
-
-const extFromMime = (mime) => {
-  const t = String(mime || '').trim().toLowerCase()
-  if (t === 'image/png') return '.png'
-  if (t === 'image/jpeg') return '.jpg'
-  if (t === 'video/mp4') return '.mp4'
-  if (t === 'video/quicktime') return '.mov'
-  if (t === 'video/webm') return '.webm'
-  return ''
-}
-
-const mediaKindFromUrl = (mediaUrl) => {
-  const u = String(mediaUrl || '').trim()
-  if (!u) return 'unknown'
-  let pathname = u
-  try {
-    pathname = new URL(u).pathname
-  } catch {}
-  const ext = parseExt(pathname)
-  return guessMediaKind('', ext)
-}
-
-// --- Test Runner Simples ---
-let passed = 0
-let failed = 0
-
-function assert(desc, actual, expected) {
-  if (actual === expected) {
-    console.log(`✅ ${desc}`)
-    passed++
-  } else {
-    console.error(`❌ ${desc} | Esperado: '${expected}', Recebido: '${actual}'`)
-    failed++
-  }
-}
-
-console.log('--- Iniciando Testes de Lógica de Mídia ---\n')
-
-// parseExt
-assert('parseExt mp4', parseExt('video.mp4'), '.mp4')
-assert('parseExt case insensitive', parseExt('FOTO.JPG'), '.jpg')
-assert('parseExt invalid', parseExt('virus.exe'), '')
-
-// guessMediaKind
-assert('guess kind video mime', guessMediaKind('video/mp4', ''), 'video')
-assert('guess kind image ext', guessMediaKind('', '.png'), 'image')
-assert('guess kind webm', guessMediaKind('', '.webm'), 'video')
-
-// extFromMime
-assert('mime to ext mp4', extFromMime('video/mp4'), '.mp4')
-assert('mime to ext unknown', extFromMime('foo/bar'), '')
-
-// mediaKindFromUrl
-assert('url simple video', mediaKindFromUrl('http://a.com/b.mp4'), 'video')
-assert('url signed query params', mediaKindFromUrl('http://a.com/b.mp4?token=123'), 'video')
-
-console.log(`\n--- Resultados: ${passed} Passou, ${failed} Falhou ---`)
-
-if (failed > 0) process.exit(1)
diff --git a/scripts/vip-entitlement.test.cjs b/scripts/vip-entitlement.test.cjs
index 1b873d5..d329854 100644
--- a/scripts/vip-entitlement.test.cjs
+++ b/scripts/vip-entitlement.test.cjs
@@ -9,11 +9,10 @@ assert.ok(fs.existsSync(limitsPath), 'limits.ts missing')
 const limitsText = fs.readFileSync(limitsPath, 'utf8')
 
 assert.ok(limitsText.includes('export type VipEntitlementSource'), 'VipEntitlementSource type missing')
+assert.ok(limitsText.includes('user_entitlements'), 'user_entitlements lookup missing')
 assert.ok(limitsText.includes('app_subscriptions'), 'app_subscriptions lookup missing')
-assert.ok(limitsText.includes('marketplace_subscriptions'), 'marketplace_subscriptions lookup missing')
 assert.ok(limitsText.includes('free_no_subscription'), 'free_no_subscription source missing')
 assert.ok(limitsText.includes('app_subscription_missing_plan'), 'missing plan source for app_subscriptions missing')
-assert.ok(limitsText.includes('marketplace_subscription_missing_plan'), 'missing plan source for marketplace_subscriptions missing')
 
 const vipStatusPath = path.join(repoRoot, 'src', 'app', 'api', 'vip', 'status', 'route.ts')
 assert.ok(fs.existsSync(vipStatusPath), 'vip status route missing')
diff --git a/scripts/workoutWizardAiValidation.test 2.cjs b/scripts/workoutWizardAiValidation.test 2.cjs
deleted file mode 100644
index 5de1dbb..0000000
--- a/scripts/workoutWizardAiValidation.test 2.cjs	
+++ /dev/null
@@ -1,53 +0,0 @@
-const assert = require('node:assert/strict')
-const validation = require('../src/utils/workoutWizardAiValidation')
-
-const baseDraft = (overrides = {}) => ({
-  title: 'Treino',
-  exercises: [
-    { name: 'Leg press', sets: 3, reps: '8-12', restTime: 90, rpe: '7-8' },
-    { name: 'Remada baixa (máquina)', sets: 3, reps: '8-12', restTime: 90, rpe: '7-8' },
-    { name: 'Crossover (cabo)', sets: 3, reps: '12-15', restTime: 60, rpe: '7-8' },
-    { name: 'Tríceps na polia (corda)', sets: 3, reps: '12-15', restTime: 60, rpe: '7-8' },
-    { name: 'Face pull', sets: 3, reps: '12-15', restTime: 60, rpe: '7-8' },
-  ],
-  ...overrides,
-})
-
-const run = () => {
-  {
-    const r = validation.validateDraftAgainstConstraints(baseDraft(), 'priorizar máquinas smart fit')
-    assert.equal(r.ok, true)
-  }
-
-  {
-    const r = validation.validateDraftAgainstConstraints(
-      baseDraft({ exercises: [{ name: 'Desenvolvimento militar', sets: 3, reps: '8-10', restTime: 90, rpe: '7-8' }] }),
-      'dor no ombro direito'
-    )
-    assert.equal(r.ok, false)
-    assert.ok(r.errors.join(' ').toLowerCase().includes('ombro'))
-  }
-
-  {
-    const a = baseDraft({ exercises: [{ name: 'Leg press', sets: 3, reps: '8-12', restTime: 90 }] })
-    const b = baseDraft({ exercises: [{ name: 'Leg press', sets: 5, reps: '3-6', restTime: 150 }] })
-    const sim = validation.similarityByNames(a, b)
-    assert.equal(sim, 1)
-  }
-
-  {
-    const a = baseDraft()
-    const b = baseDraft({ exercises: [{ name: 'Cadeira extensora', sets: 3, reps: '12-15', restTime: 60 }] })
-    const sim = validation.similarityByNames(a, b)
-    assert.ok(sim < 1)
-  }
-}
-
-try {
-  run()
-  process.stdout.write('ok\n')
-} catch (e) {
-  process.stderr.write(String(e?.stack || e) + '\n')
-  process.exitCode = 1
-}
-
diff --git a/src/app/api/marketplace/webhooks/asaas/route.ts b/src/app/api/marketplace/webhooks/asaas/route.ts
index 042e55e..a5fcd19 100644
--- a/src/app/api/marketplace/webhooks/asaas/route.ts
+++ b/src/app/api/marketplace/webhooks/asaas/route.ts
@@ -119,6 +119,38 @@ export async function POST(req: Request) {
         .eq('id', appPayRow.subscription_id)
     }
 
+    if (subTargetId) {
+      try {
+        const { data: subRow } = await admin
+          .from('app_subscriptions')
+          .select('user_id, plan_id, status, asaas_subscription_id, asaas_customer_id, current_period_start, current_period_end')
+          .eq('asaas_subscription_id', subTargetId)
+          .order('created_at', { ascending: false })
+          .limit(1)
+          .maybeSingle()
+        if (subRow?.user_id) {
+          await admin
+            .from('user_entitlements')
+            .upsert(
+              {
+                user_id: subRow.user_id,
+                plan_id: subRow.plan_id,
+                status: subStatus,
+                provider: 'asaas',
+                provider_customer_id: subRow.asaas_customer_id || null,
+                provider_subscription_id: subRow.asaas_subscription_id || subTargetId,
+                current_period_start: subRow.current_period_start || null,
+                current_period_end: subRow.current_period_end || null,
+                valid_from: subRow.current_period_start || new Date().toISOString(),
+                valid_until: subRow.current_period_end || null,
+                metadata: { updated_by: 'asaas_webhook', asaas_event_id: eventId || null, asaas_payment_id: paymentId || null },
+              },
+              { onConflict: 'provider,provider_subscription_id' },
+            )
+        }
+      } catch {}
+    }
+
     await admin.from('asaas_webhook_events').update({ processed_at: new Date().toISOString() }).eq('id', inserted.id)
     return NextResponse.json({ ok: true })
   } catch (e: any) {
diff --git a/src/app/auth/login/route.ts b/src/app/auth/login/route.ts
index bd2e54e..f04bb4c 100644
--- a/src/app/auth/login/route.ts
+++ b/src/app/auth/login/route.ts
@@ -5,16 +5,21 @@ import { getSupabaseCookieOptions } from '@/utils/supabase/cookieOptions'
 
 export const dynamic = 'force-dynamic'
 
+const parseOrigin = (raw: any) => {
+  try {
+    const s = String(raw || '').trim()
+    if (!s) return ''
+    return new URL(s).origin
+  } catch {
+    return ''
+  }
+}
+
 const resolvePublicOrigin = (request: Request) => {
   const isLocalEnv = process.env.NODE_ENV === 'development'
-  const envOriginRaw = String(
-    process.env.IRONTRACKS_PUBLIC_ORIGIN || process.env.NEXT_PUBLIC_APP_URL || process.env.APP_BASE_URL || '',
-  ).trim()
-  if (envOriginRaw) {
-    try {
-      return new URL(envOriginRaw).origin
-    } catch {}
-  }
+  const envOrigin = parseOrigin(process.env.IRONTRACKS_PUBLIC_ORIGIN || process.env.NEXT_PUBLIC_APP_URL || process.env.APP_BASE_URL)
+  if (envOrigin) return envOrigin
+  if (!isLocalEnv) return ''
 
   const host = String(request.headers.get('x-forwarded-host') || request.headers.get('host') || '').trim()
   const proto = String(request.headers.get('x-forwarded-proto') || (isLocalEnv ? 'http' : 'https')).trim()
@@ -40,6 +45,18 @@ export async function GET(request: Request) {
   const nextCookieName = 'it.auth.next'
   const nextCookieMaxAgeSeconds = 60 * 5
   const safeOrigin = resolvePublicOrigin(request)
+  if (!safeOrigin) {
+    const fallbackOrigin = (() => {
+      const isLocalEnv = process.env.NODE_ENV === 'development'
+      try {
+        const base = new URL(request.url).origin
+        return isLocalEnv && base.includes('0.0.0.0') ? base.replace('0.0.0.0', 'localhost') : base
+      } catch {
+        return isLocalEnv ? 'http://localhost:3000' : 'https://localhost'
+      }
+    })()
+    return NextResponse.redirect(new URL('/auth/error?error=missing_public_origin', fallbackOrigin))
+  }
 
   const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
   const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
diff --git a/src/components/ActiveWorkout.tsx b/src/components/ActiveWorkout.tsx
index 8a32459..fd846a8 100644
--- a/src/components/ActiveWorkout.tsx
+++ b/src/components/ActiveWorkout.tsx
@@ -1,3661 +1,23 @@
-"use client";
-
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
-import { ArrowDown, ArrowUp, Check, ChevronDown, ChevronUp, Clock, Dumbbell, GripVertical, Link2, Loader2, MessageSquare, Pencil, Play, Plus, Save, UserPlus, X } from 'lucide-react';
-import { Reorder, useDragControls } from 'framer-motion';
-import { useDialog } from '@/contexts/DialogContext';
-import { BackButton } from '@/components/ui/BackButton';
-import { parseTrainingNumber } from '@/utils/trainingNumber';
-import InviteManager from '@/components/InviteManager';
-import { useTeamWorkout } from '@/contexts/TeamWorkoutContext';
-import { queueFinishWorkout, isOnline } from '@/lib/offline/offlineSync';
-import { applyExerciseOrder, buildExerciseDraft, draftOrderKeys, moveDraftItem } from '@/lib/workoutReorder';
-import { buildFinishWorkoutPayload } from '@/lib/finishWorkoutPayload';
-import ExecutionVideoCapture from '@/components/ExecutionVideoCapture';
-import { createClient } from '@/utils/supabase/client';
-import { generatePostWorkoutInsights } from '@/actions/workout-actions';
-
-const isObject = (v) => v && typeof v === 'object' && !Array.isArray(v);
-
-const isClusterConfig = (cfg) => {
-  if (!isObject(cfg)) return false;
-  const hasClusterSize = cfg.cluster_size != null;
-  const hasIntra = cfg.intra_rest_sec != null;
-  const hasTotal = cfg.total_reps != null;
-  return (hasClusterSize && hasIntra) || (hasClusterSize && hasTotal) || (hasIntra && hasTotal);
-};
-
-const isRestPauseConfig = (cfg) => {
-  if (!isObject(cfg)) return false;
-  const hasMiniSets = cfg.mini_sets != null;
-  const hasRest = cfg.rest_time_sec != null;
-  const hasInitial = cfg.initial_reps != null;
-  return (hasMiniSets && hasRest) || (hasMiniSets && hasInitial) || (hasRest && hasInitial);
-};
-
-const buildPlannedBlocks = (totalReps, clusterSize) => {
-  const t = Number(totalReps);
-  const c = Number(clusterSize);
-  if (!Number.isFinite(t) || t <= 0) return [];
-  if (!Number.isFinite(c) || c <= 0) return [];
-  const blocks = [];
-  let remaining = t;
-  while (remaining > 0) {
-    const next = Math.min(c, remaining);
-    blocks.push(next);
-    remaining -= next;
-    if (blocks.length > 50) break;
-  }
-  return blocks;
-};
-
-const buildBlocksByCount = (totalReps, blocksCount) => {
-  const t = Number(totalReps);
-  const c = Number(blocksCount);
-  if (!Number.isFinite(t) || t <= 0) return [];
-  if (!Number.isFinite(c) || c <= 0) return [];
-  const count = Math.min(50, Math.round(c));
-  const base = Math.floor(t / count);
-  const remainder = t - base * count;
-  if (base <= 0) return [];
-  const blocks = Array.from({ length: count }).map((_, idx) => base + (idx < remainder ? 1 : 0));
-  return blocks.filter((n) => Number.isFinite(n) && n > 0);
-};
-
-const DELOAD_HISTORY_KEY = 'irontracks.deload.history.v1';
-const DELOAD_AUDIT_KEY = 'irontracks.deload.audit.v1';
-const DELOAD_HISTORY_SIZE = 6;
-const DELOAD_HISTORY_MIN = 4;
-const DELOAD_RECENT_WINDOW = 3;
-const DELOAD_STAGNATION_PCT = 0.02;
-const DELOAD_REGRESSION_PCT = 0.03;
-const DELOAD_REDUCTION_STABLE = 0.12;
-const DELOAD_REDUCTION_STAGNATION = 0.15;
-const DELOAD_REDUCTION_OVERTRAIN = 0.22;
-const DELOAD_MIN_1RM_FACTOR = 0.5;
-const DELOAD_REDUCTION_MIN = 0.05;
-const DELOAD_REDUCTION_MAX = 0.4;
-const WEIGHT_ROUND_STEP = 0.5;
-const REPORT_HISTORY_LIMIT = 80;
-const REPORT_CACHE_KEY = 'irontracks.report.history.v1';
-const REPORT_CACHE_TTL_MS = 1000 * 60 * 15;
-const REPORT_FETCH_TIMEOUT_MS = 9000;
-const DELOAD_SUGGEST_MODE = 'watermark';
-const DEFAULT_SUGGESTED_RPE = 8;
-const AI_SUGGESTION_MIN_HISTORY = 2;
-const AI_SUGGESTION_TIMEOUT_MS = 8000;
-const DROPSET_STAGE_LIMIT = 20;
-
-const toNumber = (v) => {
-  const raw = String(v ?? '').replace(',', '.');
-  const match = raw.match(/-?\d+(?:\.\d+)?/);
-  const n = Number(match ? match[0] : '');
-  return Number.isFinite(n) ? n : null;
-};
-
-const safeJsonParse = (raw) => {
-  try {
-    if (!raw) return null;
-    if (typeof raw === 'object') return raw;
-    return JSON.parse(String(raw));
-  } catch {
-    return null;
-  }
-};
-
-const toDateMs = (value) => {
-  try {
-    const t = new Date(value || 0).getTime();
-    return Number.isFinite(t) ? t : null;
-  } catch {
-    return null;
-  }
-};
-
-const averageNumbers = (list) => {
-  const arr = Array.isArray(list) ? list.filter((v) => Number.isFinite(Number(v))) : [];
-  if (!arr.length) return null;
-  const total = arr.reduce((acc, v) => acc + Number(v || 0), 0);
-  return total / arr.length;
-};
-
-const extractLogWeight = (log) => {
-  const base = log && typeof log === 'object' ? log : {};
-  const direct = toNumber(base?.weight ?? null);
-  if (direct != null && direct > 0) return direct;
-  const dropStages = Array.isArray(base?.drop_set?.stages) ? base.drop_set.stages : [];
-  const dropWeight = averageNumbers(dropStages.map((s) => toNumber(s?.weight)).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-  if (dropWeight != null && dropWeight > 0) return dropWeight;
-  const clusterBlocks = Array.isArray(base?.cluster?.blocksDetailed) ? base.cluster.blocksDetailed : [];
-  const clusterWeight = averageNumbers(clusterBlocks.map((b) => toNumber(b?.weight)).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-  if (clusterWeight != null && clusterWeight > 0) return clusterWeight;
-  const restPauseWeight = toNumber(base?.rest_pause?.weight ?? null);
-  if (restPauseWeight != null && restPauseWeight > 0) return restPauseWeight;
-  return null;
-};
-
-const withTimeout = async (promise, ms) => {
-  let timeoutId;
-  try {
-    const timeout = new Promise((_, reject) => {
-      timeoutId = setTimeout(() => reject(new Error('timeout')), ms);
-    });
-    return await Promise.race([promise, timeout]);
-  } finally {
-    clearTimeout(timeoutId);
-  }
-};
-
-const normalizeReportHistory = (data) => {
-  const base = data && typeof data === 'object' ? data : {};
-  const exercises = base?.exercises && typeof base.exercises === 'object' ? base.exercises : {};
-  return { version: 1, exercises };
-};
-
-const readReportCache = () => {
-  try {
-    const win = typeof window !== 'undefined' ? window : null;
-    if (!win || !win.localStorage) return null;
-    const raw = win.localStorage.getItem(REPORT_CACHE_KEY);
-    if (!raw) return null;
-    const parsed = safeJsonParse(raw);
-    if (!parsed || typeof parsed !== 'object') return null;
-    const cachedAt = Number(parsed?.cachedAt || 0);
-    const data = normalizeReportHistory(parsed?.data ?? null);
-    if (!cachedAt || !data) return null;
-    const age = Date.now() - cachedAt;
-    return { data, cachedAt, stale: Number.isFinite(age) ? age > REPORT_CACHE_TTL_MS : true };
-  } catch {
-    return null;
-  }
-};
-
-const writeReportCache = (data) => {
-  try {
-    const win = typeof window !== 'undefined' ? window : null;
-    if (!win || !win.localStorage) return;
-    const payload = { cachedAt: Date.now(), data: normalizeReportHistory(data) };
-    win.localStorage.setItem(REPORT_CACHE_KEY, JSON.stringify(payload));
-  } catch {}
-};
-
-const clampNumber = (value, min, max) => {
-  const v = Number(value);
-  if (!Number.isFinite(v)) return min;
-  return Math.min(max, Math.max(min, v));
-};
-
-const roundToStep = (value, step) => {
-  const v = Number(value);
-  const s = Number(step);
-  if (!Number.isFinite(v) || !Number.isFinite(s) || s <= 0) return v;
-  return Math.round(v / s) * s;
-};
-
-const normalizeExerciseKey = (name) => String(name || '').trim().toLowerCase();
-
-const estimate1Rm = (weight, reps) => {
-  const w = Number(weight);
-  const r = Number(reps);
-  if (!Number.isFinite(w) || !Number.isFinite(r) || w <= 0 || r <= 0) return null;
-  return w * (1 + r / 30);
-};
-
-export default function ActiveWorkout(props) {
-  const { alert, confirm } = useDialog();
-  const { sendInvite } = useTeamWorkout();
-  const session = props?.session && typeof props.session === 'object' ? props.session : null;
-  const workout = session?.workout && typeof session.workout === 'object' ? session.workout : null;
-  const exercises = useMemo(() => (Array.isArray(workout?.exercises) ? workout.exercises : []), [workout?.exercises]);
-  const logs = session?.logs && typeof session.logs === 'object' ? session.logs : {};
-  const ui = session?.ui && typeof session.ui === 'object' ? session.ui : {};
-  const settings = props?.settings && typeof props.settings === 'object' ? props.settings : null;
-
-  const [ticker, setTicker] = useState(Date.now());
-  const [collapsed, setCollapsed] = useState(() => new Set());
-  const [finishing, setFinishing] = useState(false);
-  const [openNotesKeys, setOpenNotesKeys] = useState(() => new Set());
-  const [inviteOpen, setInviteOpen] = useState(false);
-  const [addExerciseOpen, setAddExerciseOpen] = useState(false);
-  const [addExerciseDraft, setAddExerciseDraft] = useState(() => ({
-    name: '',
-    sets: '3',
-    restTime: '60',
-  }));
-  const [organizeOpen, setOrganizeOpen] = useState(false);
-  const [organizeDraft, setOrganizeDraft] = useState([]);
-  const [organizeSaving, setOrganizeSaving] = useState(false);
-  const [organizeError, setOrganizeError] = useState('');
-  const [deloadModal, setDeloadModal] = useState(null);
-  const [clusterModal, setClusterModal] = useState(null);
-  const [restPauseModal, setRestPauseModal] = useState(null);
-  const [dropSetModal, setDropSetModal] = useState(null);
-  const [postCheckinOpen, setPostCheckinOpen] = useState(false);
-  const [postCheckinDraft, setPostCheckinDraft] = useState({ rpe: '', satisfaction: '', soreness: '', notes: '' });
-  const postCheckinResolveRef = useRef(null);
-  const [reportHistory, setReportHistory] = useState({ version: 1, exercises: {} });
-  const [reportHistoryStatus, setReportHistoryStatus] = useState({ status: 'idle', error: '', source: '' });
-  const [reportHistoryUpdatedAt, setReportHistoryUpdatedAt] = useState(0);
-  const [deloadSuggestions, setDeloadSuggestions] = useState({});
-  const [timerMinimized, setTimerMinimized] = useState(false);
-  const [currentExerciseIdx, setCurrentExerciseIdx] = useState(0);
-
-  const restPauseRefs = useRef({});
-  const clusterRefs = useRef({});
-  const organizeBaseKeysRef = useRef([]);
-  const reportHistoryLoadingRef = useRef(false);
-  const reportHistoryLoadingSinceRef = useRef(0);
-  const reportHistoryStatusRef = useRef({ status: 'idle', error: '', source: '' });
-  const reportHistoryUpdatedAtRef = useRef(0);
-  const deloadAiCacheRef = useRef({});
-  const supabase = useMemo(() => {
-    try {
-      return createClient();
-    } catch {
-      return null;
-    }
-  }, []);
-  const MAX_EXTRA_SETS_PER_EXERCISE = 50;
-  const MAX_EXTRA_EXERCISES_PER_WORKOUT = 50;
-  const DEFAULT_EXTRA_EXERCISE_REST_TIME_S = 60;
-
-  useEffect(() => {
-    const id = setInterval(() => setTicker(Date.now()), 1000);
-    return () => clearInterval(id);
-  }, []);
-
-  useEffect(() => {
-    reportHistoryStatusRef.current = reportHistoryStatus && typeof reportHistoryStatus === 'object' ? reportHistoryStatus : { status: 'idle', error: '', source: '' };
-  }, [reportHistoryStatus]);
-
-  useEffect(() => {
-    reportHistoryUpdatedAtRef.current = Number(reportHistoryUpdatedAt || 0);
-  }, [reportHistoryUpdatedAt]);
-
-  useEffect(() => {
-    try {
-      const list = Array.isArray(exercises) ? exercises : [];
-      const withVideo = list.filter((ex) => String(ex?.videoUrl ?? ex?.video_url ?? '').trim()).length;
-      const withObs = list.filter((ex) => String(ex?.notes ?? '').trim()).length;
-      console.debug('[ActiveWorkout] exercise media snapshot', { total: list.length, withVideo, withObs });
-    } catch (e) {
-      console.error('[ActiveWorkout] exercise media snapshot failed', e);
-    }
-  }, [exercises]);
-
-  const organizeDirty = useMemo(() => {
-    const baseKeys = Array.isArray(organizeBaseKeysRef.current) ? organizeBaseKeysRef.current : [];
-    const draftKeys = draftOrderKeys(organizeDraft);
-    if (draftKeys.length !== baseKeys.length) return true;
-    for (let i = 0; i < draftKeys.length; i += 1) {
-      if (draftKeys[i] !== baseKeys[i]) return true;
-    }
-    return false;
-  }, [organizeDraft]);
-
-  const startedAtMs = useMemo(() => {
-    const raw = session?.startedAt;
-    if (typeof raw === 'number') return raw;
-    const t = new Date(raw || 0).getTime();
-    return Number.isFinite(t) ? t : 0;
-  }, [session?.startedAt]);
-
-  const elapsedSeconds = useMemo(() => {
-    if (!startedAtMs) return 0;
-    return Math.max(0, Math.floor((ticker - startedAtMs) / 1000));
-  }, [ticker, startedAtMs]);
-
-  const currentExercise = useMemo(() => {
-    const list = Array.isArray(exercises) ? exercises : [];
-    const idxRaw = Number(currentExerciseIdx);
-    const safeIdx = Number.isFinite(idxRaw) ? Math.min(Math.max(idxRaw, 0), Math.max(list.length - 1, 0)) : 0;
-    const ex = list[safeIdx] && typeof list[safeIdx] === 'object' ? list[safeIdx] : {};
-    const name = String(ex?.name || '').trim() || `Exercício ${safeIdx + 1}`;
-    const rest = parseTrainingNumber(ex?.restTime ?? ex?.rest_time);
-    return { idx: safeIdx, name, rest };
-  }, [exercises, currentExerciseIdx]);
-
-  const formatElapsed = (s) => {
-    const secs = Math.max(0, Number(s) || 0);
-    const m = Math.floor(secs / 60);
-    const sec = secs % 60;
-    return `${m}:${String(sec).padStart(2, '0')}`;
-  };
-
-  const requestPostWorkoutCheckin = async () => {
-    if (postCheckinOpen) return null;
-    return await new Promise((resolve) => {
-      postCheckinResolveRef.current = (value) => {
-        resolve(value ?? null);
-      };
-      setPostCheckinDraft({ rpe: '', satisfaction: '', soreness: '', notes: '' });
-      setPostCheckinOpen(true);
-    });
-  };
-
-  const safeUpdateSessionUi = (patch) => {
-    try {
-      if (typeof props?.onUpdateSession !== 'function') return;
-      const baseUi = session?.ui && typeof session.ui === 'object' ? session.ui : {};
-      props.onUpdateSession({ ui: { ...baseUi, ...(patch && typeof patch === 'object' ? patch : {}) } });
-    } catch {}
-  };
-
-  useEffect(() => {
-    try {
-      const focus = ui?.restPauseFocus && typeof ui.restPauseFocus === 'object' ? ui.restPauseFocus : null;
-      const key = String(focus?.key ?? '').trim();
-      const miniIndex = Number(focus?.miniIndex);
-      if (!key) return;
-      if (!Number.isFinite(miniIndex) || miniIndex < 0) return;
-      const input = restPauseRefs.current?.[key]?.[miniIndex];
-      if (input && typeof input.focus === 'function') {
-        input.focus();
-        try {
-          input.select?.();
-        } catch {}
-      }
-      safeUpdateSessionUi({ restPauseFocus: null });
-    } catch {}
-    // eslint-disable-next-line react-hooks/exhaustive-deps
-  }, [ui?.restPauseFocus?.key, ui?.restPauseFocus?.miniIndex]);
-
-  useEffect(() => {
-    try {
-      const focus = ui?.clusterFocus && typeof ui.clusterFocus === 'object' ? ui.clusterFocus : null;
-      const key = String(focus?.key ?? '').trim();
-      const blockIndex = Number(focus?.blockIndex);
-      if (!key) return;
-      if (!Number.isFinite(blockIndex) || blockIndex < 0) return;
-      const input = clusterRefs.current?.[key]?.[blockIndex];
-      if (input && typeof input.focus === 'function') {
-        input.focus();
-        try {
-          input.select?.();
-        } catch {}
-      }
-      safeUpdateSessionUi({ clusterFocus: null });
-    } catch {}
-    // eslint-disable-next-line react-hooks/exhaustive-deps
-  }, [ui?.clusterFocus?.key, ui?.clusterFocus?.blockIndex]);
-
-  const getPlanConfig = (ex, setIdx) => {
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const sd = sdArr?.[setIdx] && typeof sdArr[setIdx] === 'object' ? sdArr[setIdx] : null;
-    const cfg = sd?.advanced_config ?? sd?.advancedConfig ?? null;
-    return isObject(cfg) ? cfg : null;
-  };
-
-  const getPlannedSet = (ex, setIdx) => {
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const sd = sdArr?.[setIdx] && typeof sdArr[setIdx] === 'object' ? sdArr[setIdx] : null;
-    return sd && typeof sd === 'object' ? sd : null;
-  };
-
-  const getLog = (key) => {
-    const v = logs?.[key];
-    return v && typeof v === 'object' ? v : {};
-  };
-
-  const buildExerciseHistoryEntryFromSessionLogs = useCallback((sessionObj, exIdx, meta) => {
-    try {
-      const base = sessionObj && typeof sessionObj === 'object' ? sessionObj : null;
-      if (!base) return null;
-      const logsObj = base?.logs && typeof base.logs === 'object' ? base.logs : {};
-      const sets = [];
-      Object.entries(logsObj).forEach(([key, value]) => {
-        try {
-          const parts = String(key || '').split('-');
-          const eIdx = Number(parts[0]);
-          if (!Number.isFinite(eIdx) || eIdx !== exIdx) return;
-          const log = value && typeof value === 'object' ? value : null;
-          if (!log) return;
-          const weight = extractLogWeight(log);
-          const reps = toNumber(log?.reps ?? null);
-          const hasValues = weight != null || reps != null;
-          const doneRaw = log?.done ?? log?.isDone ?? log?.completed ?? null;
-          const done = doneRaw == null ? true : doneRaw === true || String(doneRaw || '').toLowerCase() === 'true';
-          if (!done && !hasValues) return;
-          if (hasValues) {
-            sets.push({ weight, reps });
-          }
-        } catch {}
-      });
-      if (!sets.length) return null;
-      const weightList = sets.map((s) => s?.weight).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0);
-      const repsList = sets.map((s) => s?.reps).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0);
-      const avgWeight = averageNumbers(weightList);
-      const avgReps = averageNumbers(repsList);
-      const totalVolume = sets.reduce((acc, s) => {
-        const w = Number(s?.weight ?? 0);
-        const r = Number(s?.reps ?? 0);
-        if (!Number.isFinite(w) || !Number.isFinite(r)) return acc;
-        if (w <= 0 || r <= 0) return acc;
-        return acc + w * r;
-      }, 0);
-      const topWeight = weightList.length ? Math.max(...weightList) : null;
-      if (!avgWeight && !avgReps && !totalVolume) return null;
-      const ts =
-        toDateMs(base?.date) ??
-        toDateMs(base?.completed_at) ??
-        toDateMs(base?.completedAt) ??
-        toDateMs(meta?.date) ??
-        toDateMs(meta?.created_at) ??
-        Date.now();
-      return {
-        ts,
-        avgWeight: avgWeight ?? null,
-        avgReps: avgReps ?? null,
-        totalVolume: Number.isFinite(totalVolume) ? totalVolume : 0,
-        topWeight: topWeight ?? null,
-        setsCount: sets.length,
-      };
-    } catch {
-      return null;
-    }
-  }, []);
-
-  const buildReportHistoryFromWorkouts = useCallback((rows) => {
-    try {
-      const list = Array.isArray(rows) ? rows : [];
-      const next = { version: 1, exercises: {} };
-      list.forEach((row) => {
-        const sessionObj = safeJsonParse(row?.notes);
-        if (!sessionObj || typeof sessionObj !== 'object') return;
-        const exercisesArr = Array.isArray(sessionObj?.exercises) ? sessionObj.exercises : [];
-        if (!exercisesArr.length) return;
-        exercisesArr.forEach((ex, exIdx) => {
-          const name = String(ex?.name || '').trim();
-          if (!name) return;
-          const key = normalizeExerciseKey(name);
-          if (!key) return;
-          const entry = buildExerciseHistoryEntryFromSessionLogs(sessionObj, exIdx, row);
-          if (!entry) return;
-          const prev = next.exercises?.[key] && typeof next.exercises[key] === 'object' ? next.exercises[key] : { name, items: [] };
-          const items = Array.isArray(prev?.items) ? prev.items : [];
-          next.exercises[key] = { name, items: [...items, { ...entry, name }] };
-        });
-      });
-      Object.keys(next.exercises).forEach((key) => {
-        const ex = next.exercises[key];
-        const items = Array.isArray(ex?.items) ? ex.items : [];
-        const ordered = items
-          .filter((it) => it && typeof it === 'object')
-          .sort((a, b) => Number(a?.ts || 0) - Number(b?.ts || 0))
-          .slice(-DELOAD_HISTORY_SIZE);
-        next.exercises[key] = { ...ex, items: ordered };
-      });
-      return next;
-    } catch {
-      return { version: 1, exercises: {} };
-    }
-  }, [buildExerciseHistoryEntryFromSessionLogs]);
-
-  useEffect(() => {
-    let cancelled = false;
-    let loadingTimeoutId;
-    const cached = readReportCache();
-    if (cached?.data && !cancelled) {
-      setReportHistory(cached.data);
-      setReportHistoryUpdatedAt(cached.cachedAt);
-      setReportHistoryStatus({ status: 'ready', error: '', source: cached.stale ? 'cache-stale' : 'cache' });
-      reportHistoryLoadingSinceRef.current = 0;
-    }
-    (async () => {
-      try {
-        if (!supabase) {
-          if (!cached?.data && !cancelled) {
-            setReportHistoryStatus((prev) => ({ status: 'error', error: 'Supabase indisponível', source: prev?.source || '' }));
-            setReportHistoryUpdatedAt((prev) => (prev ? prev : Date.now()));
-          }
-          return;
-        }
-        if (reportHistoryLoadingRef.current) return;
-        if (cached?.data && !cached.stale) return;
-        reportHistoryLoadingRef.current = true;
-        reportHistoryLoadingSinceRef.current = Date.now();
-        if (!cancelled) setReportHistoryStatus((prev) => ({ status: 'loading', error: '', source: prev?.source || '' }));
-        loadingTimeoutId = setTimeout(() => {
-          if (cancelled) return;
-          if (reportHistoryLoadingRef.current) {
-            reportHistoryLoadingRef.current = false;
-            reportHistoryLoadingSinceRef.current = 0;
-            setReportHistoryStatus((prev) => (prev?.status === 'loading' ? { status: 'error', error: 'Tempo limite ao carregar relatórios', source: prev?.source || '' } : prev));
-            setReportHistoryUpdatedAt((prev) => (prev ? prev : Date.now()));
-          }
-        }, REPORT_FETCH_TIMEOUT_MS + 1500);
-        const { data } = await withTimeout(supabase.auth.getUser(), REPORT_FETCH_TIMEOUT_MS);
-        const userId = data?.user?.id ? String(data.user.id) : '';
-        if (!userId) {
-          if (!cancelled) setReportHistoryStatus((prev) => ({ status: 'error', error: 'Usuário indisponível', source: prev?.source || '' }));
-          if (!cancelled) setReportHistoryUpdatedAt((prev) => (prev ? prev : Date.now()));
-          return;
-        }
-        const { data: rows, error } = await withTimeout(
-          supabase
-            .from('workouts')
-            .select('id, notes, date, created_at')
-            .eq('user_id', userId)
-            .eq('is_template', false)
-            .order('date', { ascending: false })
-            .order('created_at', { ascending: false })
-            .limit(REPORT_HISTORY_LIMIT),
-          REPORT_FETCH_TIMEOUT_MS
-        );
-        if (error) throw error;
-        const next = buildReportHistoryFromWorkouts(rows);
-        if (!cancelled) {
-          setReportHistory(next);
-          setReportHistoryUpdatedAt(Date.now());
-          setReportHistoryStatus({ status: 'ready', error: '', source: 'network' });
-          writeReportCache(next);
-        }
-      } catch {
-        if (!cancelled) {
-          setReportHistoryStatus((prev) => ({ status: 'error', error: 'Falha ao carregar relatórios', source: prev?.source || '' }));
-          setReportHistoryUpdatedAt((prev) => (prev ? prev : Date.now()));
-        }
-      } finally {
-        if (loadingTimeoutId) clearTimeout(loadingTimeoutId);
-        reportHistoryLoadingRef.current = false;
-        reportHistoryLoadingSinceRef.current = 0;
-      }
-    })();
-    return () => {
-      cancelled = true;
-      if (loadingTimeoutId) clearTimeout(loadingTimeoutId);
-    };
-  }, [supabase, buildReportHistoryFromWorkouts]);
-
-  useEffect(() => {
-    try {
-      const statusObj = reportHistoryStatusRef.current && typeof reportHistoryStatusRef.current === 'object' ? reportHistoryStatusRef.current : { status: 'idle' };
-      const status = String(statusObj?.status || 'idle');
-      const updatedAt = Number(reportHistoryUpdatedAtRef.current || 0);
-      const since = Number(reportHistoryLoadingSinceRef.current || 0);
-      if (status !== 'loading' || updatedAt) return;
-      if (!since) return;
-      const elapsed = Date.now() - since;
-      const max = REPORT_FETCH_TIMEOUT_MS + 2000;
-      if (elapsed <= max) return;
-      reportHistoryLoadingRef.current = false;
-      reportHistoryLoadingSinceRef.current = 0;
-      setReportHistoryStatus((prev) =>
-        prev?.status === 'loading'
-          ? { status: 'error', error: 'Tempo limite ao carregar relatórios', source: prev?.source || '' }
-          : prev,
-      );
-      setReportHistoryUpdatedAt((prev) => (prev ? prev : Date.now()));
-    } catch {}
-  }, [ticker]);
-
-  const updateLog = (key, patch) => {
-    try {
-      if (typeof props?.onUpdateLog !== 'function') return;
-      const prev = getLog(key);
-      props.onUpdateLog(key, { ...prev, ...(patch && typeof patch === 'object' ? patch : {}) });
-    } catch {}
-  };
-
-  const saveClusterModal = () => {
-    try {
-      const m = clusterModal && typeof clusterModal === 'object' ? clusterModal : null;
-      const key = String(m?.key || '').trim();
-      if (!key) {
-        setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Série inválida. Feche e abra novamente.' } : prev));
-        return;
-      }
-      const blocks = Array.isArray(m?.blocks) ? m.blocks : [];
-      if (!blocks.length) {
-        setClusterModal((prev) =>
-          prev && typeof prev === 'object'
-            ? { ...prev, error: 'Nenhum bloco encontrado. Verifique a configuração (total reps, cluster size e descanso).' }
-            : prev,
-        );
-        return;
-      }
-      const planned = m?.planned && typeof m.planned === 'object' ? m.planned : {};
-      const intra = Number(m?.intra);
-      const restsByGap = Array.isArray(m?.restsByGap) ? m.restsByGap : [];
-      const done = !!getLog(key)?.done;
-      const baseAdvanced = m?.cfg ?? getLog(key)?.advanced_config ?? null;
-
-      const blocksDetailed = [];
-      const repsBlocks = [];
-      let total = 0;
-      for (let i = 0; i < blocks.length; i += 1) {
-        const b = blocks[i] && typeof blocks[i] === 'object' ? blocks[i] : {};
-        const weight = String(b.weight ?? '').trim();
-        const reps = parseTrainingNumber(b.reps);
-        if (!weight) {
-          setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha o peso (kg) em todos os blocos.' } : prev));
-          return;
-        }
-        if (!reps || reps <= 0) {
-          setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps em todos os blocos.' } : prev));
-          return;
-        }
-        const gapRest = restsByGap?.[i];
-        const restSecAfter = i < blocks.length - 1 ? (Number.isFinite(Number(gapRest)) ? Number(gapRest) : Number.isFinite(intra) ? intra : null) : null;
-        blocksDetailed.push({ weight, reps, restSecAfter });
-        repsBlocks.push(reps);
-        total += reps;
-      }
-
-      const lastWeight = String(blocksDetailed[blocksDetailed.length - 1]?.weight ?? '').trim();
-      const rpe = String(m?.rpe ?? '').trim();
-
-      updateLog(key, {
-        done,
-        weight: lastWeight,
-        reps: String(total || ''),
-        rpe: rpe || '',
-        cluster: {
-          planned: {
-            total_reps: planned?.total_reps ?? null,
-            cluster_size: planned?.cluster_size ?? null,
-            cluster_blocks_count: planned?.cluster_blocks_count ?? null,
-            intra_rest_sec: planned?.intra_rest_sec ?? null,
-          },
-          plannedBlocks: Array.isArray(m?.plannedBlocks) ? m.plannedBlocks : null,
-          blocks: repsBlocks,
-          blocksDetailed,
-        },
-        advanced_config: baseAdvanced,
-      });
-      setClusterModal(null);
-    } catch {}
-  };
-
-  const saveRestPauseModal = () => {
-    try {
-      const m = restPauseModal && typeof restPauseModal === 'object' ? restPauseModal : null;
-      const key = String(m?.key || '').trim();
-      if (!key) {
-        setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Série inválida. Feche e abra novamente.' } : prev));
-        return;
-      }
-
-      const weight = String(m?.weight ?? '').trim();
-      if (!weight) {
-        setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha o peso (kg).' } : prev));
-        return;
-      }
-
-      const activationReps = parseTrainingNumber(m?.activationReps);
-      if (!activationReps || activationReps <= 0) {
-        setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps de ativação.' } : prev));
-        return;
-      }
-
-      const minis = Array.isArray(m?.minis) ? m.minis : [];
-      const miniReps = minis.map((v) => {
-        const n = parseTrainingNumber(v);
-        return n != null && n > 0 ? n : null;
-      });
-      if (miniReps.some((v) => v == null)) {
-        setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps de todos os minis.' } : prev));
-        return;
-      }
-
-      const pauseSec = parseTrainingNumber(m?.pauseSec) ?? 15;
-      const rpe = String(m?.rpe ?? '').trim();
-      const cfg = m?.cfg ?? getLog(key)?.advanced_config ?? null;
-
-      const total = (activationReps ?? 0) + miniReps.reduce((acc, v) => acc + (v ?? 0), 0);
-      updateLog(key, {
-        done: !!getLog(key)?.done,
-        weight,
-        reps: String(total || ''),
-        rpe: rpe || '',
-        rest_pause: {
-          activation_reps: activationReps,
-          mini_reps: miniReps,
-          rest_time_sec: pauseSec,
-          planned_mini_sets: miniReps.length,
-        },
-        advanced_config: cfg,
-      });
-      setRestPauseModal(null);
-    } catch {}
-  };
-
-  const saveDropSetModal = () => {
-    try {
-      const m = dropSetModal && typeof dropSetModal === 'object' ? dropSetModal : null;
-      const key = String(m?.key || '').trim();
-      if (!key) {
-        setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Série inválida. Feche e abra novamente.' } : prev));
-        return;
-      }
-      const stagesRaw = Array.isArray(m?.stages) ? m.stages : [];
-      if (stagesRaw.length < 2) {
-        setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Defina pelo menos 2 etapas.' } : prev));
-        return;
-      }
-
-      const stages = [];
-      let total = 0;
-      for (let i = 0; i < stagesRaw.length; i += 1) {
-        const s = stagesRaw[i] && typeof stagesRaw[i] === 'object' ? stagesRaw[i] : {};
-        const weight = String(s?.weight ?? '').trim();
-        const reps = parseTrainingNumber(s?.reps);
-        if (!weight) {
-          setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha o peso (kg) em todas as etapas.' } : prev));
-          return;
-        }
-        if (!reps || reps <= 0) {
-          setDropSetModal((prev) => (prev && typeof prev === 'object' ? { ...prev, error: 'Preencha as reps em todas as etapas.' } : prev));
-          return;
-        }
-        stages.push({ weight, reps });
-        total += reps;
-      }
-
-      const lastWeight = String(stages[stages.length - 1]?.weight ?? '').trim();
-      updateLog(key, {
-        done: !!getLog(key)?.done,
-        weight: lastWeight,
-        reps: String(total || ''),
-        drop_set: { stages },
-      });
-      setDropSetModal(null);
-    } catch {}
-  };
-
-  const loadDeloadHistory = () => {
-    try {
-      if (typeof window === 'undefined') return { version: 1, exercises: {} };
-      const raw = window.localStorage.getItem(DELOAD_HISTORY_KEY);
-      if (!raw) return { version: 1, exercises: {} };
-      const parsed = JSON.parse(raw);
-      const exercises = parsed?.exercises && typeof parsed.exercises === 'object' ? parsed.exercises : {};
-      return { version: 1, ...(parsed && typeof parsed === 'object' ? parsed : {}), exercises };
-    } catch {
-      return { version: 1, exercises: {} };
-    }
-  };
-
-  const saveDeloadHistory = (next) => {
-    try {
-      if (typeof window === 'undefined') return;
-      window.localStorage.setItem(DELOAD_HISTORY_KEY, JSON.stringify(next));
-    } catch {}
-  };
-
-  const appendDeloadAudit = (entry) => {
-    try {
-      if (typeof window === 'undefined') return;
-      const raw = window.localStorage.getItem(DELOAD_AUDIT_KEY);
-      const parsed = raw ? JSON.parse(raw) : null;
-      const list = Array.isArray(parsed) ? parsed : [];
-      const next = [entry, ...list].slice(0, 100);
-      window.localStorage.setItem(DELOAD_AUDIT_KEY, JSON.stringify(next));
-    } catch {}
-  };
-
-  const collectExerciseSetInputs = (ex, exIdx) => {
-    const setsHeader = Math.max(0, Number.parseInt(String(ex?.sets ?? '0'), 10) || 0);
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const setsCount = Math.max(setsHeader, Array.isArray(sdArr) ? sdArr.length : 0);
-    const sets = [];
-    for (let setIdx = 0; setIdx < setsCount; setIdx += 1) {
-      const key = `${exIdx}-${setIdx}`;
-      const log = getLog(key);
-      const cfg = getPlanConfig(ex, setIdx);
-      const planned = getPlannedSet(ex, setIdx);
-      const logWeight = extractLogWeight(log);
-      const fallbackWeight = toNumber(cfg?.weight ?? planned?.weight ?? null);
-      const weight = logWeight != null ? logWeight : fallbackWeight;
-      const reps = toNumber(log?.reps ?? planned?.reps ?? ex?.reps ?? null);
-      if (weight != null || reps != null) {
-        sets.push({ weight, reps });
-      }
-    }
-    return { setsCount, sets };
-  };
-
-  const collectExercisePlannedInputs = (ex, exIdx) => {
-    const setsHeader = Math.max(0, Number.parseInt(String(ex?.sets ?? '0'), 10) || 0);
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const setsCount = Math.max(setsHeader, Array.isArray(sdArr) ? sdArr.length : 0);
-    const sets = [];
-    for (let setIdx = 0; setIdx < setsCount; setIdx += 1) {
-      const cfg = getPlanConfig(ex, setIdx);
-      const planned = getPlannedSet(ex, setIdx);
-      const weight = toNumber(cfg?.weight ?? planned?.weight ?? ex?.weight ?? null);
-      const reps = toNumber(planned?.reps ?? ex?.reps ?? null);
-      if (weight != null || reps != null) {
-        sets.push({ weight, reps });
-      }
-    }
-    return { setsCount, sets };
-  };
-
-  const buildExerciseHistoryEntry = (ex, exIdx) => {
-    const { sets } = collectExerciseSetInputs(ex, exIdx);
-    if (!sets.length) return null;
-    const weightList = sets.map((s) => s?.weight).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0);
-    const repsList = sets.map((s) => s?.reps).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0);
-    const avgWeight = averageNumbers(weightList);
-    const avgReps = averageNumbers(repsList);
-    const totalVolume = sets.reduce((acc, s) => {
-      const w = Number(s?.weight ?? 0);
-      const r = Number(s?.reps ?? 0);
-      if (!Number.isFinite(w) || !Number.isFinite(r)) return acc;
-      if (w <= 0 || r <= 0) return acc;
-      return acc + w * r;
-    }, 0);
-    const topWeight = weightList.length ? Math.max(...weightList) : null;
-    if (!avgWeight && !avgReps && !totalVolume) return null;
-    return {
-      ts: Date.now(),
-      avgWeight: avgWeight ?? null,
-      avgReps: avgReps ?? null,
-      totalVolume: Number.isFinite(totalVolume) ? totalVolume : 0,
-      topWeight: topWeight ?? null,
-      setsCount: sets.length,
-    };
-  };
-
-  const persistDeloadHistoryFromSession = () => {
-    try {
-      const history = loadDeloadHistory();
-      const next = { version: 1, ...(history && typeof history === 'object' ? history : {}), exercises: { ...(history?.exercises || {}) } };
-      const list = Array.isArray(exercises) ? exercises : [];
-      list.forEach((ex, exIdx) => {
-        const name = String(ex?.name || '').trim();
-        if (!name) return;
-        const key = normalizeExerciseKey(name);
-        const entry = buildExerciseHistoryEntry(ex, exIdx);
-        if (!entry) return;
-        const prev = next.exercises?.[key] && typeof next.exercises[key] === 'object' ? next.exercises[key] : { name, items: [] };
-        const items = Array.isArray(prev?.items) ? prev.items : [];
-        const updated = [...items, { ...entry, name }].slice(-DELOAD_HISTORY_SIZE);
-        next.exercises[key] = { name, items: updated };
-      });
-      saveDeloadHistory(next);
-    } catch {}
-  };
-
-  const analyzeDeloadHistory = (items) => {
-    const ordered = Array.isArray(items) ? items.slice(-DELOAD_HISTORY_SIZE) : [];
-    const recent = ordered.slice(-DELOAD_RECENT_WINDOW);
-    const older = ordered.slice(0, Math.max(0, ordered.length - recent.length));
-    const avgRecentVolume = averageNumbers(recent.map((i) => i?.totalVolume).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-    const avgOlderVolume = averageNumbers(older.map((i) => i?.totalVolume).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-    const avgRecentWeight = averageNumbers(recent.map((i) => i?.avgWeight).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-    const avgOlderWeight = averageNumbers(older.map((i) => i?.avgWeight).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-
-    const volumeDelta = avgOlderVolume && avgRecentVolume ? (avgRecentVolume - avgOlderVolume) / avgOlderVolume : null;
-    const weightDelta = avgOlderWeight && avgRecentWeight ? (avgRecentWeight - avgOlderWeight) / avgOlderWeight : null;
-
-    const hasRegression =
-      (volumeDelta != null && volumeDelta <= -DELOAD_REGRESSION_PCT) ||
-      (weightDelta != null && weightDelta <= -DELOAD_REGRESSION_PCT);
-    const hasStagnation =
-      (!hasRegression && volumeDelta != null && Math.abs(volumeDelta) <= DELOAD_STAGNATION_PCT) ||
-      (!hasRegression && weightDelta != null && Math.abs(weightDelta) <= DELOAD_STAGNATION_PCT);
-
-    const status = hasRegression ? 'overtraining' : hasStagnation ? 'stagnation' : 'stable';
-    return { status, volumeDelta, weightDelta };
-  };
-
-  const parseAiRecommendation = (text) => {
-    try {
-      const raw = String(text || '').trim();
-      if (!raw) return { weight: null, reps: null, rpe: null };
-      const weightMatch = raw.match(/(\d+(?:[.,]\d+)?)\s*kg/i);
-      const repsMatch = raw.match(/(\d+(?:[.,]\d+)?)\s*reps?/i);
-      const rpeMatch = raw.match(/rpe\s*([0-9]+(?:[.,]\d+)?)/i);
-      const weight = toNumber(weightMatch ? weightMatch[1] : null);
-      const reps = toNumber(repsMatch ? repsMatch[1] : null);
-      const rpe = toNumber(rpeMatch ? rpeMatch[1] : null);
-      return { weight: weight && weight > 0 ? weight : null, reps: reps && reps > 0 ? reps : null, rpe: rpe && rpe > 0 ? rpe : null };
-    } catch {
-      return { weight: null, reps: null, rpe: null };
-    }
-  };
-
-  const buildDeloadSetSuggestions = (ex, exIdx) => {
-    try {
-      const name = String(ex?.name || '').trim() || `Exercício ${exIdx + 1}`;
-      const key = normalizeExerciseKey(name);
-      const history = loadDeloadHistory();
-      const items = Array.isArray(history?.exercises?.[key]?.items) ? history.exercises[key].items : [];
-      const reportItems = Array.isArray(reportHistory?.exercises?.[key]?.items) ? reportHistory.exercises[key].items : [];
-      const preferredItems = reportItems.length ? reportItems : items;
-      const ordered = preferredItems
-        .filter((it) => it && typeof it === 'object')
-        .sort((a, b) => Number(a?.ts || 0) - Number(b?.ts || 0));
-      const latest = ordered.length ? ordered[ordered.length - 1] : null;
-      const latestAvgWeight = toNumber(latest?.avgWeight ?? null);
-      const latestAvgReps = toNumber(latest?.avgReps ?? null);
-      const baseSuggestion = buildDeloadSuggestion(ex, exIdx);
-      const baseWeight = baseSuggestion?.ok ? Number(baseSuggestion.baseWeight || 0) : latestAvgWeight ?? null;
-      const suggestedWeight = baseSuggestion?.ok ? Number(baseSuggestion.suggestedWeight || 0) : baseWeight ?? null;
-      const minWeight = baseSuggestion?.ok ? Number(baseSuggestion.minWeight || 0) : 0;
-      const ratio = baseWeight && suggestedWeight ? suggestedWeight / baseWeight : 1;
-      const { setsCount } = collectExerciseSetInputs(ex, exIdx);
-      const entries = {};
-      for (let setIdx = 0; setIdx < setsCount; setIdx += 1) {
-        const setKey = `${exIdx}-${setIdx}`;
-        const log = getLog(setKey);
-        const cfg = getPlanConfig(ex, setIdx);
-        const planned = getPlannedSet(ex, setIdx);
-        const baseSetWeight = extractLogWeight(log) ?? toNumber(cfg?.weight ?? planned?.weight ?? baseWeight ?? latestAvgWeight ?? null);
-        const nextWeight = baseSetWeight ? roundToStep(Math.max(baseSetWeight * ratio, minWeight || 0), WEIGHT_ROUND_STEP) : null;
-        const repsBase = toNumber(planned?.reps ?? ex?.reps ?? latestAvgReps ?? null);
-        const rpeBase = toNumber(planned?.rpe ?? ex?.rpe ?? null);
-        const nextRpe = rpeBase != null ? rpeBase : (nextWeight || repsBase ? DEFAULT_SUGGESTED_RPE : null);
-        const hasSuggestion = nextWeight != null || repsBase != null || nextRpe != null;
-        if (hasSuggestion) {
-          entries[setKey] = { weight: nextWeight ?? null, reps: repsBase ?? null, rpe: nextRpe ?? null };
-        }
-      }
-      const hasEntries = Object.keys(entries).length > 0;
-      const result = {
-        ok: hasEntries,
-        name,
-        key,
-        entries,
-        itemsCount: preferredItems.length,
-        baseSuggestion: baseSuggestion?.ok ? baseSuggestion : null,
-      };
-      try {
-        console.info('[Deload] draft', {
-          exIdx,
-          name,
-          ok: result.ok,
-          itemsCount: result.itemsCount,
-          entriesCount: Object.keys(entries).length,
-          baseSuggestion: !!result.baseSuggestion,
-        });
-      } catch {}
-      return result;
-    } catch (e) {
-      try {
-        console.warn('[Deload] draft failed', e?.message ? String(e.message) : String(e));
-      } catch {}
-      return { ok: false, error: 'Falha ao analisar histórico.' };
-    }
-  };
-
-  const estimate1RmFromSets = (sets, historyItems) => {
-    const candidates = [];
-    const list = Array.isArray(sets) ? sets : [];
-    list.forEach((s) => {
-      const w = Number(s?.weight ?? 0);
-      const r = Number(s?.reps ?? 0);
-      const est = estimate1Rm(w, r);
-      if (est) candidates.push(est);
-    });
-    const hist = Array.isArray(historyItems) ? historyItems : [];
-    hist.forEach((h) => {
-      const est = estimate1Rm(h?.topWeight ?? null, h?.avgReps ?? null);
-      if (est) candidates.push(est);
-    });
-    if (!candidates.length) return null;
-    return Math.max(...candidates);
-  };
-
-  const buildDeloadSuggestion = (ex, exIdx, aiSuggestion) => {
-    const name = String(ex?.name || '').trim() || `Exercício ${exIdx + 1}`;
-    const key = normalizeExerciseKey(name);
-    const history = loadDeloadHistory();
-    const items = Array.isArray(history?.exercises?.[key]?.items) ? history.exercises[key].items : [];
-    const reportItems = Array.isArray(reportHistory?.exercises?.[key]?.items) ? reportHistory.exercises[key].items : [];
-    const preferredItems = reportItems.length ? reportItems : items;
-    const currentInputs = collectExerciseSetInputs(ex, exIdx);
-    const currentSets = Array.isArray(currentInputs?.sets) ? currentInputs.sets : [];
-    const historyCount = preferredItems.length ? preferredItems.length : currentSets.length ? 1 : 0;
-    const plannedInputs = collectExercisePlannedInputs(ex, exIdx);
-    const plannedSets = Array.isArray(plannedInputs?.sets) ? plannedInputs.sets : [];
-    const baseWeightFromHistory = averageNumbers(preferredItems.map((i) => i?.avgWeight).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-    const baseWeightFromCurrent = averageNumbers(currentSets.map((s) => s?.weight).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-    const baseWeightFromPlan = averageNumbers(plannedSets.map((s) => s?.weight).filter((v) => Number.isFinite(Number(v)) && Number(v) > 0));
-    const baseWeightFromAi = (() => {
-      const v = toNumber(aiSuggestion?.weight ?? null);
-      return v != null && v > 0 ? v : null;
-    })();
-    const baseWeight = baseWeightFromHistory ?? baseWeightFromCurrent ?? baseWeightFromPlan ?? baseWeightFromAi ?? null;
-    if (!baseWeight || !Number.isFinite(Number(baseWeight)) || Number(baseWeight) <= 0) {
-      try {
-        console.warn('[Deload] base weight missing', {
-          exIdx,
-          name,
-          historyCount,
-          baseWeightFromHistory,
-          baseWeightFromCurrent,
-          baseWeightFromPlan,
-          baseWeightFromAi,
-        });
-      } catch {}
-      return { ok: false, error: 'Deload indisponível: sem carga no relatório nem no plano.' };
-    }
-    const analysis = analyzeDeloadHistory(preferredItems);
-    const targetReduction =
-      analysis.status === 'overtraining'
-        ? DELOAD_REDUCTION_OVERTRAIN
-        : analysis.status === 'stagnation'
-          ? DELOAD_REDUCTION_STAGNATION
-          : DELOAD_REDUCTION_STABLE;
-    const estSourceSets = baseWeightFromHistory ? [] : baseWeightFromCurrent ? currentSets : baseWeightFromPlan ? plannedSets : [];
-    const est1rm = estimate1RmFromSets(estSourceSets, preferredItems);
-    const minWeight = est1rm ? est1rm * DELOAD_MIN_1RM_FACTOR : 0;
-    const rawSuggested = baseWeight * (1 - targetReduction);
-    const suggestedWeight = roundToStep(Math.max(rawSuggested, minWeight || 0), WEIGHT_ROUND_STEP);
-    const appliedReduction = baseWeight > 0 ? clampNumber(1 - suggestedWeight / baseWeight, 0, 1) : targetReduction;
-    const result = {
-      ok: true,
-      name,
-      exIdx,
-      baseWeight,
-      suggestedWeight,
-      appliedReduction,
-      targetReduction,
-      historyCount,
-      minWeight,
-      analysis,
-    };
-    try {
-      console.info('[Deload] suggestion', {
-        exIdx,
-        name,
-        historyCount,
-        baseWeight,
-        suggestedWeight,
-        appliedReduction,
-        targetReduction,
-        minWeight,
-        status: analysis?.status,
-      });
-    } catch {}
-    return result;
-  };
-
-  const getDeloadReason = (analysis, reductionPct, historyCount) => {
-    const pct = Math.round((Number(reductionPct) || 0) * 1000) / 10;
-    const label =
-      analysis?.status === 'overtraining'
-        ? 'regressão'
-        : analysis?.status === 'stagnation'
-          ? 'estagnação'
-          : 'progressão estável';
-    const historyLabel = historyCount >= DELOAD_HISTORY_MIN ? `${historyCount} treinos` : `histórico curto (${historyCount || 0} treinos)`;
-    return `Redução de ${pct}% devido à ${label} nos últimos ${historyLabel}.`;
-  };
-
-  const resolveAiSuggestionForExercise = async (exerciseName) => {
-    try {
-      const name = String(exerciseName || '').trim();
-      if (!name) return null;
-      const key = normalizeExerciseKey(name);
-      const cache = deloadAiCacheRef.current && typeof deloadAiCacheRef.current === 'object' ? deloadAiCacheRef.current : {};
-      if (cache[key] !== undefined) return cache[key] || null;
-      if (!session || typeof session !== 'object') {
-        deloadAiCacheRef.current = { ...cache, [key]: null };
-        return null;
-      }
-      const res = await withTimeout(
-        generatePostWorkoutInsights({
-          workoutId: typeof session?.id === 'string' ? session.id : null,
-          session,
-        }),
-        AI_SUGGESTION_TIMEOUT_MS,
-      );
-      if (!res?.ok || !res?.ai) {
-        deloadAiCacheRef.current = { ...cache, [key]: null };
-        return null;
-      }
-      const progression = Array.isArray(res?.ai?.progression) ? res.ai.progression : [];
-      const match = progression.find((rec) => normalizeExerciseKey(rec?.exercise || '') === key);
-      const parsed = parseAiRecommendation(match?.recommendation ?? '');
-      const ai = { weight: parsed.weight ?? null, reps: parsed.reps ?? null, rpe: parsed.rpe ?? null };
-      deloadAiCacheRef.current = { ...cache, [key]: ai };
-      return ai;
-    } catch (err) {
-      const msg = err?.message ? String(err.message) : String(err || '');
-      if (msg.toLowerCase().includes('timeout')) {
-        console.warn('[Deload AI] timeout ao gerar sugestões');
-      } else {
-        console.warn('[Deload AI] falha ao gerar sugestões', msg);
-      }
-      return null;
-    }
-  };
-
-  const openDeloadModal = async (ex, exIdx) => {
-    const startedAt = Date.now();
-    const totalTimeoutMs = REPORT_FETCH_TIMEOUT_MS + AI_SUGGESTION_TIMEOUT_MS + 3000;
-    try {
-      await withTimeout(
-        (async () => {
-          let ok = false;
-          try {
-            ok = typeof confirm === 'function'
-              ? await confirm('Deseja analisar deload para este exercício?', 'Aplicar Deload', { confirmText: 'Analisar', cancelText: 'Cancelar' })
-              : false;
-          } catch {
-            ok = false;
-          }
-          if (!ok) return;
-          const safeEx = ex && typeof ex === 'object' ? ex : null;
-          const safeIdx = Number(exIdx);
-          if (!safeEx || !Number.isFinite(safeIdx) || safeIdx < 0) {
-            try {
-              console.warn('[Deload] invalid exercise', { exIdx });
-              await alert('Deload indisponível: exercício inválido.');
-            } catch {}
-            return;
-          }
-          const name = String(safeEx?.name || '').trim() || `Exercício ${safeIdx + 1}`;
-          const { setsCount } = collectExerciseSetInputs(safeEx, safeIdx);
-          if (!setsCount || setsCount <= 0) {
-            try {
-              console.warn('[Deload] no sets', { exIdx: safeIdx, name, setsCount });
-              await alert('Deload indisponível: exercício sem séries configuradas.');
-            } catch {}
-            return;
-          }
-          try {
-            console.info('[Deload] start', {
-              exIdx: safeIdx,
-              name,
-              reportStatus: reportHistoryStatus?.status || 'idle',
-              reportSource: reportHistoryStatus?.source || '',
-              reportUpdatedAt: reportHistoryUpdatedAt || null,
-            });
-          } catch {}
-          const statusSnap = reportHistoryStatusRef.current && typeof reportHistoryStatusRef.current === 'object' ? reportHistoryStatusRef.current : { status: 'idle' };
-          const isStillLoading = String(statusSnap?.status || 'idle') === 'loading' && !Number(reportHistoryUpdatedAtRef.current || 0);
-          if (reportHistoryLoadingRef.current || isStillLoading) {
-            try {
-              await new Promise((resolve, reject) => {
-                const deadline = Date.now() + REPORT_FETCH_TIMEOUT_MS + 1500;
-                const timer = setInterval(() => {
-                  const st = reportHistoryStatusRef.current && typeof reportHistoryStatusRef.current === 'object' ? reportHistoryStatusRef.current : { status: 'idle' };
-                  const upd = Number(reportHistoryUpdatedAtRef.current || 0);
-                  const doneLoading = !reportHistoryLoadingRef.current && String(st?.status || 'idle') !== 'loading';
-                  if (doneLoading || upd) {
-                    clearInterval(timer);
-                    resolve(true);
-                    return;
-                  }
-                  if (Date.now() > deadline) {
-                    clearInterval(timer);
-                    reject(new Error('timeout'));
-                  }
-                }, 200);
-              });
-            } catch {
-              if (reportHistoryLoadingRef.current) {
-                reportHistoryLoadingRef.current = false;
-                setReportHistoryStatus((prev) =>
-                  prev?.status === 'loading'
-                    ? { status: 'error', error: 'Tempo limite ao carregar relatórios', source: prev?.source || '' }
-                    : prev,
-                );
-                setReportHistoryUpdatedAt((prev) => (prev ? prev : Date.now()));
-              }
-            }
-          }
-          const suggestionDraft = buildDeloadSetSuggestions(safeEx, safeIdx);
-          let mergedEntries = suggestionDraft?.entries && typeof suggestionDraft.entries === 'object' ? { ...suggestionDraft.entries } : null;
-          let aiSuggestion = null;
-          if (suggestionDraft?.ok && suggestionDraft.itemsCount >= AI_SUGGESTION_MIN_HISTORY) {
-            aiSuggestion = await resolveAiSuggestionForExercise(suggestionDraft?.name || '');
-            if (!aiSuggestion) {
-              try {
-                console.info('[Deload] ai suggestion unavailable', { exIdx: safeIdx, name });
-              } catch {}
-            }
-            if (aiSuggestion && mergedEntries) {
-              Object.keys(mergedEntries).forEach((k) => {
-                const cur = mergedEntries[k] && typeof mergedEntries[k] === 'object' ? mergedEntries[k] : {};
-                mergedEntries[k] = {
-                  weight: aiSuggestion.weight != null ? aiSuggestion.weight : cur.weight ?? null,
-                  reps: aiSuggestion.reps != null ? aiSuggestion.reps : cur.reps ?? null,
-                  rpe: aiSuggestion.rpe != null ? aiSuggestion.rpe : cur.rpe ?? null,
-                };
-              });
-            }
-          }
-          if (mergedEntries && Object.keys(mergedEntries).length) {
-            setDeloadSuggestions((prev) => ({ ...(prev && typeof prev === 'object' ? prev : {}), ...mergedEntries }));
-          }
-          let suggestion = buildDeloadSuggestion(safeEx, safeIdx, aiSuggestion);
-          if (!suggestion?.ok) {
-            const missingWeight = String(suggestion?.error || '').toLowerCase().includes('sem carga');
-            if (missingWeight && !aiSuggestion) {
-              aiSuggestion = await resolveAiSuggestionForExercise(suggestionDraft?.name || name);
-              if (aiSuggestion && mergedEntries) {
-                Object.keys(mergedEntries).forEach((k) => {
-                  const cur = mergedEntries[k] && typeof mergedEntries[k] === 'object' ? mergedEntries[k] : {};
-                  mergedEntries[k] = {
-                    weight: aiSuggestion.weight != null ? aiSuggestion.weight : cur.weight ?? null,
-                    reps: aiSuggestion.reps != null ? aiSuggestion.reps : cur.reps ?? null,
-                    rpe: aiSuggestion.rpe != null ? aiSuggestion.rpe : cur.rpe ?? null,
-                  };
-                });
-                setDeloadSuggestions((prev) => ({ ...(prev && typeof prev === 'object' ? prev : {}), ...mergedEntries }));
-              }
-              suggestion = buildDeloadSuggestion(safeEx, safeIdx, aiSuggestion);
-            }
-          }
-          if (!suggestion?.ok) {
-            const baseError = suggestion?.error || suggestionDraft?.error || 'Sem dados suficientes para calcular o deload.';
-            const baseErrorClean = String(baseError || '').replace(/^Deload indisponível:\s*/i, '');
-            const reportMsg = reportHistoryStatus?.status === 'loading'
-              ? 'Relatórios ainda carregando.'
-              : reportHistoryStatus?.status === 'error'
-                ? `Relatórios com erro: ${reportHistoryStatus?.error || 'falha desconhecida'}.`
-                : '';
-            const watermarkMsg = DELOAD_SUGGEST_MODE === 'watermark' && suggestionDraft?.ok
-              ? 'Sugestões aplicadas em marca d’água. '
-              : '';
-            try {
-              console.warn('[Deload] suggestion unavailable', {
-                exIdx: safeIdx,
-                name,
-                baseError,
-                reportStatus: reportHistoryStatus?.status || 'idle',
-                reportError: reportHistoryStatus?.error || '',
-              });
-              await alert(`${watermarkMsg}Deload completo indisponível: ${baseErrorClean}${reportMsg ? ` ${reportMsg}` : ''}`);
-            } catch {}
-            return;
-          }
-          const reason = getDeloadReason(suggestion.analysis, suggestion.appliedReduction, suggestion.historyCount);
-          setDeloadModal({
-            ...suggestion,
-            reductionPct: suggestion.appliedReduction,
-            reason,
-          });
-          try {
-            console.info('[Deload] modal opened', {
-              exIdx: safeIdx,
-              name,
-              baseWeight: suggestion.baseWeight,
-              suggestedWeight: suggestion.suggestedWeight,
-            });
-          } catch {}
-        })(),
-        totalTimeoutMs,
-      );
-    } catch (e) {
-      const msg = e?.message ? String(e.message) : String(e || 'timeout');
-      try {
-        console.warn('[Deload] flow timeout', { message: msg, ms: totalTimeoutMs, elapsed: Date.now() - startedAt });
-        await alert('Tempo limite ao processar o Deload. Tente novamente em instantes.');
-      } catch {}
-    }
-  };
-
-  const updateDeloadModalFromPercent = (value) => {
-    if (!deloadModal || typeof deloadModal !== 'object') return;
-    const pct = clampNumber((toNumber(value) ?? 0) / 100, DELOAD_REDUCTION_MIN, DELOAD_REDUCTION_MAX);
-    const baseWeight = Number(deloadModal.baseWeight || 0);
-    if (!Number.isFinite(baseWeight) || baseWeight <= 0) return;
-    const minWeight = Number(deloadModal.minWeight || 0);
-    const suggestedRaw = baseWeight * (1 - pct);
-    const suggestedWeight = roundToStep(Math.max(suggestedRaw, minWeight || 0), WEIGHT_ROUND_STEP);
-    const appliedReduction = clampNumber(1 - suggestedWeight / baseWeight, 0, 1);
-    setDeloadModal((prev) => (prev && typeof prev === 'object' ? { ...prev, reductionPct: appliedReduction, suggestedWeight } : prev));
-  };
-
-  const updateDeloadModalFromWeight = (value) => {
-    if (!deloadModal || typeof deloadModal !== 'object') return;
-    const baseWeight = Number(deloadModal.baseWeight || 0);
-    if (!Number.isFinite(baseWeight) || baseWeight <= 0) return;
-    const minWeight = Number(deloadModal.minWeight || 0);
-    const nextWeightRaw = toNumber(value);
-    if (nextWeightRaw == null) return;
-    const nextWeight = roundToStep(Math.max(nextWeightRaw, minWeight || 0), WEIGHT_ROUND_STEP);
-    const appliedReduction = clampNumber(1 - nextWeight / baseWeight, 0, 1);
-    setDeloadModal((prev) => (prev && typeof prev === 'object' ? { ...prev, reductionPct: appliedReduction, suggestedWeight: nextWeight } : prev));
-  };
-
-  const applyDeloadToExercise = async () => {
-    if (!deloadModal || typeof deloadModal !== 'object') return;
-    const exIdx = Number(deloadModal?.exIdx);
-    if (!Number.isFinite(exIdx) || exIdx < 0) return;
-    const ex = exercises?.[exIdx];
-    if (!ex || typeof ex !== 'object') return;
-    try {
-      const { setsCount } = collectExerciseSetInputs(ex, exIdx);
-      const baseWeight = Number(deloadModal.baseWeight || 0);
-      const targetWeight = Number(deloadModal.suggestedWeight || 0);
-      if (!Number.isFinite(baseWeight) || !Number.isFinite(targetWeight) || baseWeight <= 0 || targetWeight <= 0) {
-        await alert('Peso inválido para aplicar deload.');
-        return;
-      }
-      const ratio = targetWeight / baseWeight;
-      const minWeight = Number(deloadModal.minWeight || 0);
-      const appliedAt = new Date().toISOString();
-      const appliedWeights = [];
-      for (let setIdx = 0; setIdx < setsCount; setIdx += 1) {
-        const key = `${exIdx}-${setIdx}`;
-        const log = getLog(key);
-        const cfg = getPlanConfig(ex, setIdx);
-        const planned = getPlannedSet(ex, setIdx);
-        const logWeight = extractLogWeight(log);
-        const baseSetWeight = logWeight != null ? logWeight : toNumber(cfg?.weight ?? planned?.weight ?? baseWeight);
-        if (!baseSetWeight || baseSetWeight <= 0) continue;
-        const nextWeight = roundToStep(Math.max(baseSetWeight * ratio, minWeight || 0), WEIGHT_ROUND_STEP);
-        const suggestion = deloadSuggestions?.[key] && typeof deloadSuggestions[key] === 'object' ? deloadSuggestions[key] : null;
-        const currentReps = log?.reps;
-        const currentRpe = log?.rpe;
-        const hasReps = String(currentReps ?? '').trim().length > 0;
-        const hasRpe = String(currentRpe ?? '').trim().length > 0;
-        const nextReps = !hasReps && suggestion?.reps != null ? String(suggestion.reps) : currentReps;
-        const nextRpe = !hasRpe && suggestion?.rpe != null ? String(suggestion.rpe) : currentRpe;
-        updateLog(key, {
-          weight: String(nextWeight),
-          reps: nextReps,
-          rpe: nextRpe,
-          deload: {
-            appliedAt,
-            originalWeight: baseSetWeight,
-            suggestedWeight: nextWeight,
-            reductionPct: deloadModal.reductionPct,
-            reason: deloadModal.reason,
-            historyCount: deloadModal.historyCount,
-          },
-          advanced_config: cfg ?? log?.advanced_config ?? null,
-        });
-        appliedWeights.push(nextWeight);
-      }
-      appendDeloadAudit({
-        ts: Date.now(),
-        exIdx,
-        name: deloadModal.name,
-        baseWeight: deloadModal.baseWeight,
-        suggestedWeight: deloadModal.suggestedWeight,
-        reductionPct: deloadModal.reductionPct,
-        historyCount: deloadModal.historyCount,
-        appliedAt,
-        weights: appliedWeights,
-        workoutId: workout?.id ?? null,
-      });
-      setDeloadModal(null);
-    } catch (e) {
-      try {
-        await alert('Não foi possível aplicar o deload agora.');
-      } catch {}
-    }
-  };
-
-  const startTimer = (seconds, context) => {
-    try {
-      if (typeof props?.onStartTimer !== 'function') return;
-      const s = Number(seconds);
-      if (!Number.isFinite(s) || s <= 0) return;
-      props.onStartTimer(s, context);
-    } catch {}
-  };
-
-  const toggleCollapse = (exIdx) => {
-    setCollapsed((prev) => {
-      const next = new Set(prev);
-      if (next.has(exIdx)) next.delete(exIdx);
-      else next.add(exIdx);
-      return next;
-    });
-  };
-
-  const addExtraSetToExercise = async (exIdx) => {
-    if (!workout || typeof props?.onUpdateSession !== 'function') return;
-    const idx = Number(exIdx);
-    if (!Number.isFinite(idx) || idx < 0) return;
-    if (idx >= exercises.length) return;
-    try {
-      const nextExercises = [...exercises];
-      const exRaw = nextExercises[idx] && typeof nextExercises[idx] === 'object' ? nextExercises[idx] : {};
-      const setsHeader = Math.max(0, Number.parseInt(String(exRaw?.sets ?? '0'), 10) || 0);
-      const sdArrRaw = Array.isArray(exRaw?.setDetails) ? exRaw.setDetails : Array.isArray(exRaw?.set_details) ? exRaw.set_details : [];
-      const sdArr = Array.isArray(sdArrRaw) ? [...sdArrRaw] : [];
-      const setsCount = Math.max(setsHeader, sdArr.length);
-      if (setsCount >= MAX_EXTRA_SETS_PER_EXERCISE) return;
-
-      const last = sdArr.length > 0 ? sdArr[sdArr.length - 1] : null;
-      const base = last && typeof last === 'object' ? last : {};
-      const nextDetail = {
-        ...base,
-        set_number: setsCount + 1,
-        weight: null,
-        reps: '',
-        rpe: null,
-        notes: null,
-        is_warmup: false,
-      };
-
-      sdArr.push(nextDetail);
-      nextExercises[idx] = {
-        ...exRaw,
-        sets: setsCount + 1,
-        setDetails: sdArr,
-      };
-      props.onUpdateSession({ workout: { ...workout, exercises: nextExercises } });
-      setCollapsed((prev) => {
-        const next = new Set(prev);
-        if (next.has(idx)) next.delete(idx);
-        return next;
-      });
-    } catch (e) {
-      try {
-        await alert('Não foi possível adicionar série extra: ' + (e?.message || String(e || '')));
-      } catch {}
-    }
-  };
-
-  const addExtraExerciseToWorkout = async () => {
-    if (!workout || typeof props?.onUpdateSession !== 'function') return;
-    if (exercises.length >= MAX_EXTRA_EXERCISES_PER_WORKOUT) return;
-    const name = String(addExerciseDraft?.name || '').trim();
-    if (!name) {
-      try {
-        await alert('Informe o nome do exercício.', 'Exercício extra');
-      } catch {}
-      return;
-    }
-    const sets = Math.max(1, Number.parseInt(String(addExerciseDraft?.sets || '3'), 10) || 1);
-    const rest = parseTrainingNumber(addExerciseDraft?.restTime);
-    const restTime = Number.isFinite(rest) && rest > 0 ? rest : null;
-    const nextExercise = {
-      name,
-      sets,
-      restTime,
-      method: 'Normal',
-      setDetails: [],
-    };
-    try {
-      props.onUpdateSession({ workout: { ...workout, exercises: [...exercises, nextExercise] } });
-      setAddExerciseOpen(false);
-      setAddExerciseDraft({ name: '', sets: String(sets), restTime: String(restTime ?? DEFAULT_EXTRA_EXERCISE_REST_TIME_S) });
-    } catch (e) {
-      try {
-        await alert('Não foi possível adicionar exercício extra: ' + (e?.message || String(e || '')));
-      } catch {}
-    }
-  };
-
-  const openOrganizeModal = () => {
-    const draft = buildExerciseDraft(exercises);
-    setOrganizeDraft(draft);
-    organizeBaseKeysRef.current = draftOrderKeys(draft);
-    setOrganizeError('');
-    setOrganizeOpen(true);
-  };
-
-  const requestCloseOrganize = async () => {
-    if (organizeSaving) return;
-    if (organizeDirty) {
-      let ok = false;
-      try {
-        ok = typeof confirm === 'function' ? await confirm('Existem mudanças não salvas. Deseja sair?', 'Sair sem salvar?', { confirmText: 'Sair', cancelText: 'Continuar' }) : false;
-      } catch {
-        ok = false;
-      }
-      if (!ok) return;
-    }
-    setOrganizeOpen(false);
-  };
-
-  const saveOrganize = async () => {
-    if (!workout || organizeSaving) return;
-    const workoutId = String(workout?.id ?? workout?.workout_id ?? '').trim();
-    if (!workoutId) {
-      setOrganizeError('Não foi possível salvar: treino sem ID.');
-      return;
-    }
-    setOrganizeSaving(true);
-    setOrganizeError('');
-    try {
-      const orderedExercises = applyExerciseOrder(exercises, organizeDraft);
-      const payload = { ...workout, exercises: orderedExercises };
-      const response = await fetch('/api/workouts/update', {
-        method: 'PATCH',
-        headers: { 'Content-Type': 'application/json' },
-        body: JSON.stringify({ id: workoutId, workout: payload }),
-      }).catch(() => null);
-      const result = response ? await response.json().catch(() => null) : null;
-      if (!response || !response.ok || !result?.ok) {
-        setOrganizeError(String(result?.error || 'Falha ao salvar a ordem.'));
-        setOrganizeSaving(false);
-        return;
-      }
-      if (typeof props?.onUpdateSession === 'function') {
-        props.onUpdateSession({ workout: { ...workout, exercises: orderedExercises } });
-      }
-      organizeBaseKeysRef.current = draftOrderKeys(organizeDraft);
-      setOrganizeOpen(false);
-      try {
-        await alert('Ordem dos exercícios salva com sucesso.');
-      } catch {}
-    } catch (e) {
-      setOrganizeError(String(e?.message || e || 'Falha ao salvar a ordem.'));
-    } finally {
-      setOrganizeSaving(false);
-    }
-  };
-
-  const finishWorkout = async () => {
-    if (!session || !workout) return;
-    if (finishing) return;
-
-    const minSecondsForFullSession = 30 * 60;
-    const elapsedSafe = Number(elapsedSeconds) || 0;
-    let showReport = true;
-
-    let ok = false;
-    try {
-      ok =
-        typeof confirm === 'function'
-          ? await confirm('Deseja finalizar o treino?', 'Finalizar treino', {
-              confirmText: 'Sim',
-              cancelText: 'Não',
-            })
-          : false;
-    } catch {
-      ok = false;
-    }
-    if (!ok) return;
-
-    const isShort = elapsedSafe > 0 && Number.isFinite(elapsedSafe) && elapsedSafe < minSecondsForFullSession;
-    let shouldSaveHistory = true;
-
-    if (isShort) {
-      let allowSaveShort = false;
-      try {
-        allowSaveShort =
-          typeof confirm === 'function'
-            ? await confirm(
-                'Esse treino durou menos de 30 minutos. Deseja adicioná-lo no histórico?',
-                'Treino curto (< 30 min)',
-                {
-                  confirmText: 'Sim',
-                  cancelText: 'Não',
-                }
-              )
-            : false;
-      } catch {
-        allowSaveShort = false;
-      }
-      shouldSaveHistory = !!allowSaveShort;
-    }
-
-    try {
-      showReport =
-        typeof confirm === 'function'
-          ? await confirm('Deseja o relatório desse treino?', 'Gerar relatório?', {
-              confirmText: 'Sim',
-              cancelText: 'Não',
-            })
-          : true;
-    } catch {
-      showReport = true;
-    }
-
-    let postCheckin = null;
-    if (shouldSaveHistory) {
-      try {
-        const prompt = settings ? settings.promptPostWorkoutCheckin !== false : true;
-        if (prompt) postCheckin = await requestPostWorkoutCheckin();
-      } catch {
-        postCheckin = null;
-      }
-    }
-
-    setFinishing(true);
-    try {
-      persistDeloadHistoryFromSession();
-      const payload = buildFinishWorkoutPayload({ workout, elapsedSeconds, logs, ui, postCheckin });
-
-      let savedId = null;
-      if (shouldSaveHistory) {
-        // Generate idempotency key to prevent duplicates on retry
-        const idempotencyKey = `finish_${workout?.id || 'unknown'}_${Date.now()}_${Math.random().toString(36).slice(2)}`;
-        const submission = { session: payload, idempotencyKey };
-        
-        try {
-          // Attempt online save first if network appears available
-          let onlineSuccess = false;
-          if (isOnline()) {
-             try {
-                const resp = await fetch('/api/workouts/finish', {
-                    method: 'POST',
-                    headers: { 'Content-Type': 'application/json' },
-                    body: JSON.stringify(submission),
-                });
-                
-                if (resp.ok) {
-                    const json = await resp.json();
-                    savedId = json?.saved?.id ?? null;
-                    onlineSuccess = true;
-                } else {
-                    // Check if validation error (400-499) or server error (500+)
-                    if (resp.status >= 400 && resp.status < 500) {
-                        const errText = await resp.text();
-                        throw new Error(`Erro de validação: ${errText}`);
-                    }
-                    // For 500+, we throw to trigger offline fallback
-                    throw new Error(`Erro do servidor: ${resp.status}`);
-                }
-             } catch (fetchErr) {
-                 // If it's a validation error, rethrow to stop process
-                 if (String(fetchErr).includes('Erro de validação')) throw fetchErr;
-                 // Otherwise (network fail, 500), fall through to offline queue
-                 console.warn('Online save failed, attempting offline queue', fetchErr);
-             }
-          }
-
-          if (!onlineSuccess) {
-              // Fallback to offline queue
-              await queueFinishWorkout(submission);
-              await alert('Sem conexão estável. Treino salvo na fila e será sincronizado automaticamente.', 'Salvo Offline');
-              savedId = 'offline-pending';
-          }
-
-        } catch (e) {
-          const msg = e?.message ? String(e.message) : String(e);
-          // If it was a validation error, we show it and abort finish
-          if (msg.includes('Erro de validação')) {
-              await alert(msg);
-              setFinishing(false);
-              return;
-          }
-          
-          // If queue failed too
-          await alert('CRÍTICO: Erro ao salvar treino: ' + (msg || 'erro inesperado'));
-          // We do NOT set savedId, so report logic below might fail or be skipped?
-          // Actually, if we fail to save, we probably shouldn't finish the workout state locally?
-          // The user asked to ensure history is saved.
-          setFinishing(false);
-          return;
-        }
-      }
-
-      const sessionForReport = {
-        ...payload,
-        id: savedId,
-      };
-
-      try {
-        if (typeof props?.onFinish === 'function') {
-          props.onFinish(sessionForReport, showReport);
-        }
-      } catch {}
-    } catch (e) {
-      const msg = e?.message ? String(e.message) : String(e);
-      await alert('Erro ao finalizar: ' + (msg || 'erro inesperado'));
-    } finally {
-      setFinishing(false);
-    }
-  };
-
-  const renderNormalSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const cfg = getPlanConfig(ex, setIdx);
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const restTime = parseTrainingNumber(ex?.restTime ?? ex?.rest_time);
-    const weightValue = String(log?.weight ?? cfg?.weight ?? '');
-    const repsValue = String(log?.reps ?? '');
-    const rpeValue = String(log?.rpe ?? '');
-    const notesValue = String(log?.notes ?? '');
-    const done = !!log?.done;
-    const plannedReps = String(plannedSet?.reps ?? ex?.reps ?? '').trim();
-    const plannedRpe = String(plannedSet?.rpe ?? ex?.rpe ?? '').trim();
-    const suggestion = deloadSuggestions?.[key] && typeof deloadSuggestions[key] === 'object' ? deloadSuggestions[key] : null;
-    const useWatermark = DELOAD_SUGGEST_MODE === 'watermark';
-    const weightPlaceholder = useWatermark && suggestion?.weight != null ? `${suggestion.weight} kg` : 'Peso (kg)';
-    const repsPlaceholder = useWatermark && suggestion?.reps != null ? String(suggestion.reps) : 'Reps';
-    const rpePlaceholder = useWatermark && suggestion?.rpe != null ? String(suggestion.rpe) : 'RPE';
-
-    const isHeaderRow = setIdx === 0;
-    const notesId = `notes-${key}`;
-    const hasNotes = notesValue.trim().length > 0;
-    const isNotesOpen = openNotesKeys.has(key);
-
-    const toggleNotes = () => {
-      setOpenNotesKeys((prev) => {
-        const next = new Set(prev);
-        if (next.has(key)) next.delete(key);
-        else next.add(key);
-        return next;
-      });
-    };
-
-    return (
-      <div className="space-y-1" key={key}>
-        {isHeaderRow && (
-          <div className="hidden sm:flex items-center gap-2 text-[10px] uppercase tracking-widest text-neutral-500 font-bold px-1">
-            <div className="w-10">Série</div>
-            <div className="w-24">Peso (kg)</div>
-            <div className="w-24">Reps</div>
-            <div className="w-24">RPE</div>
-            <div className="ml-auto flex items-center gap-2">Ações</div>
-          </div>
-        )}
-        <div className="rounded-xl bg-neutral-900/50 border border-neutral-800/80 px-3 py-2.5 space-y-2 shadow-sm shadow-black/20">
-          <div className="flex items-center justify-between gap-2">
-            <div className="text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-            <button
-              type="button"
-              onClick={toggleNotes}
-              className={
-                isNotesOpen || hasNotes
-                  ? 'inline-flex items-center justify-center rounded-lg p-2 text-yellow-500 bg-yellow-500/10 border border-yellow-500/40 hover:bg-yellow-500/15 transition duration-200'
-                  : 'inline-flex items-center justify-center rounded-lg p-2 text-neutral-400 bg-black/30 border border-neutral-700 hover:border-yellow-500/60 hover:text-yellow-500 transition duration-200'
-              }
-            >
-              <MessageSquare size={14} />
-            </button>
-          </div>
-
-          <div className="grid grid-cols-2 gap-2 sm:grid-cols-[6rem_6rem_6rem_auto] sm:items-center">
-            <input
-              inputMode="decimal"
-              value={weightValue}
-              onChange={(e) => {
-                const v = e?.target?.value ?? '';
-                updateLog(key, { weight: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-              }}
-              placeholder={weightPlaceholder}
-              className="w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-1.5 text-sm text-white outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0"
-            />
-            <div className="relative">
-              <input
-                inputMode="decimal"
-                value={repsValue}
-                onChange={(e) => {
-                  const v = e?.target?.value ?? '';
-                  updateLog(key, { reps: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                }}
-                placeholder={repsPlaceholder}
-                className="w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-1.5 pr-10 text-sm text-white outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-neutral-600 placeholder:opacity-40 focus:placeholder:opacity-0"
-              />
-              {plannedReps ? (
-                <div className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono text-neutral-500/60">
-                  {plannedReps}
-                </div>
-              ) : null}
-            </div>
-            <div className="relative">
-              <input
-                inputMode="decimal"
-                value={rpeValue}
-                onChange={(e) => {
-                  const v = e?.target?.value ?? '';
-                  updateLog(key, { rpe: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-                }}
-                placeholder={rpePlaceholder}
-                className="w-full bg-black/30 border border-yellow-500/30 rounded-xl px-3 py-1.5 pr-10 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500 transition duration-200 placeholder:text-yellow-500/50 focus:placeholder:opacity-0"
-              />
-              {plannedRpe ? (
-                <div className="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-[10px] font-mono text-yellow-500/45">
-                  {plannedRpe}
-                </div>
-              ) : null}
-            </div>
-            <button
-              type="button"
-              onClick={() => {
-                const nextDone = !done;
-                updateLog(key, { done: nextDone, advanced_config: cfg ?? log?.advanced_config ?? null });
-                if (nextDone && restTime && restTime > 0) {
-                  startTimer(restTime, { kind: 'rest', key });
-                }
-              }}
-              className={
-                done
-                  ? 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black shadow-yellow-500/20 shadow-sm active:scale-95 transition duration-150'
-                  : 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700 active:scale-95 transition duration-150'
-              }
-            >
-              <Check size={16} />
-              <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-            </button>
-          </div>
-        </div>
-        {isNotesOpen && (
-          <div className="px-1">
-            <textarea
-              id={notesId}
-              value={notesValue}
-              onChange={(e) => {
-                const v = e?.target?.value ?? '';
-                updateLog(key, { notes: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-              }}
-              placeholder="Observações da série (opcional)"
-              rows={2}
-              className="w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500 shadow-sm shadow-yellow-500/10 transition duration-200"
-            />
-          </div>
-        )}
-      </div>
-    );
-  };
-
-  const renderRestPauseSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const cfg = getPlanConfig(ex, setIdx);
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const restTime = parseTrainingNumber(ex?.restTime ?? ex?.rest_time);
-    const suggestion = deloadSuggestions?.[key] && typeof deloadSuggestions[key] === 'object' ? deloadSuggestions[key] : null;
-    const useWatermark = DELOAD_SUGGEST_MODE === 'watermark';
-    const weightPlaceholder = useWatermark && suggestion?.weight != null ? `${suggestion.weight} kg` : 'kg';
-    const repsPlaceholder = useWatermark && suggestion?.reps != null ? String(suggestion.reps) : 'reps';
-
-    const auto = plannedSet?.it_auto && typeof plannedSet.it_auto === 'object' ? plannedSet.it_auto : null;
-    const modeLabel = String(auto?.label || '').trim() || (String(auto?.kind || '') === 'sst' ? 'SST' : 'Rest-P');
-
-    const pauseSec = parseTrainingNumber(cfg?.rest_time_sec) ?? 15;
-    const miniSets = Math.max(0, Math.floor(parseTrainingNumber(cfg?.mini_sets) ?? 0));
-
-    const rp = isObject(log?.rest_pause) ? log.rest_pause : {};
-    const activation = parseTrainingNumber(rp?.activation_reps) ?? null;
-    const minisArrRaw = Array.isArray(rp?.mini_reps) ? rp.mini_reps : [];
-    const minis = Array.from({ length: miniSets }).map((_, idx) => {
-      const v = minisArrRaw?.[idx];
-      const n = parseTrainingNumber(v);
-      return n;
-    });
-
-    const total = (activation ?? 0) + minis.reduce((acc, v) => acc + (v ?? 0), 0);
-    const done = !!log?.done;
-    const canDone = (activation ?? 0) > 0 && (miniSets === 0 || minis.every((v) => Number.isFinite(v) && v > 0));
-
-    const notesValue = String(log?.notes ?? '');
-
-    return (
-      <div key={key} className="space-y-2">
-        <div className="rounded-xl bg-neutral-900/50 border border-neutral-800/80 px-3 py-2.5 space-y-2 shadow-sm shadow-black/20">
-          <div className="flex items-center gap-2">
-            <div className="w-10 text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-            <input
-              inputMode="decimal"
-              value={String(log?.weight ?? cfg?.weight ?? '')}
-              onChange={(e) => {
-                const v = e?.target?.value ?? '';
-                updateLog(key, { weight: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-              }}
-              placeholder={weightPlaceholder}
-              className="w-24 bg-black/30 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-            />
-            <button
-              type="button"
-              onClick={() => {
-                const baseWeight = String(log?.weight ?? cfg?.weight ?? '').trim();
-                const baseRpe = String(log?.rpe ?? '').trim();
-                const nextMiniCount = Math.max(0, Math.floor(miniSets));
-                const minisInput = Array.from({ length: nextMiniCount }).map((_, idx) => {
-                  const v = minisArrRaw?.[idx];
-                  const n = parseTrainingNumber(v);
-                  return n != null && n > 0 ? n : null;
-                });
-                setRestPauseModal({
-                  key,
-                  label: modeLabel,
-                  pauseSec,
-                  miniSets: nextMiniCount,
-                  weight: baseWeight,
-                  activationReps: activation != null && activation > 0 ? activation : null,
-                  minis: minisInput,
-                  rpe: baseRpe,
-                  cfg: cfg ?? null,
-                  error: '',
-                });
-              }}
-              className="bg-black/30 border border-neutral-700 rounded-xl px-2 sm:px-3 py-2 text-sm text-white outline-none hover:border-yellow-500/60 hover:text-yellow-500 transition-colors inline-flex items-center justify-center gap-2"
-            >
-              <Pencil size={14} />
-              <span className="text-xs font-black hidden sm:inline">Abrir</span>
-            </button>
-          </div>
-          <div className="flex flex-col sm:flex-row sm:items-center gap-2">
-            <div className="flex items-center gap-2 flex-1 min-w-0">
-              <span className="text-[10px] uppercase tracking-widest font-black text-yellow-500">{modeLabel === 'SST' ? 'SST' : 'Rest-P'}</span>
-              <span className="text-xs text-neutral-400 whitespace-normal">{modeLabel === 'SST' ? 'SST' : 'REST-P'} • Intra {pauseSec || 0}s • Total: {total || 0} reps</span>
-            </div>
-            <button
-              type="button"
-              disabled={!canDone}
-              onClick={() => {
-                const nextDone = !done;
-                updateLog(key, {
-                  done: nextDone,
-                  reps: String(total || ''),
-                  rest_pause: { ...rp, activation_reps: activation ?? null, mini_reps: minis },
-                  advanced_config: cfg ?? log?.advanced_config ?? null,
-                });
-                if (nextDone && restTime && restTime > 0) startTimer(restTime, { kind: 'rest', key });
-              }}
-              className={
-                canDone
-                  ? done
-                    ? 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black shadow-yellow-500/20 shadow-sm active:scale-95 transition duration-150 sm:w-auto'
-                    : 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700 active:scale-95 transition duration-150 sm:w-auto'
-                  : 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-neutral-800/40 border border-neutral-800 text-neutral-500 font-bold cursor-not-allowed sm:w-auto'
-              }
-            >
-              <Check size={16} />
-              <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-            </button>
-          </div>
-        </div>
-        <textarea
-          value={notesValue}
-          onChange={(e) => {
-            const v = e?.target?.value ?? '';
-            updateLog(key, { notes: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-          }}
-          placeholder="Observações da série"
-          rows={2}
-          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-        />
-      </div>
-    );
-  };
-
-  const renderClusterSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const cfg = getPlanConfig(ex, setIdx);
-    const restTime = parseTrainingNumber(ex?.restTime ?? ex?.rest_time);
-    const suggestion = deloadSuggestions?.[key] && typeof deloadSuggestions[key] === 'object' ? deloadSuggestions[key] : null;
-    const useWatermark = DELOAD_SUGGEST_MODE === 'watermark';
-    const weightPlaceholder = useWatermark && suggestion?.weight != null ? `${suggestion.weight} kg` : 'kg';
-
-    const totalRepsPlanned = parseTrainingNumber(cfg?.total_reps);
-    const clusterSize = parseTrainingNumber(cfg?.cluster_size);
-    const intra = parseTrainingNumber(cfg?.intra_rest_sec) ?? 15;
-    const plannedBlocks = buildPlannedBlocks(totalRepsPlanned, clusterSize);
-
-    const cluster = isObject(log?.cluster) ? log.cluster : {};
-    const blocksRaw = Array.isArray(cluster?.blocks) ? cluster.blocks : [];
-    const blocks = plannedBlocks.map((_, idx) => {
-      const v = blocksRaw?.[idx];
-      const n = parseTrainingNumber(v);
-      return n;
-    });
-
-    const total = blocks.reduce((acc, v) => acc + (v ?? 0), 0);
-    const done = !!log?.done;
-    const canDone = plannedBlocks.length > 0 && blocks.every((v) => Number.isFinite(v) && v > 0);
-
-    const lastRestAfterBlock = Number(cluster?.last_rest_after_block);
-    const lastRest = Number.isFinite(lastRestAfterBlock) ? lastRestAfterBlock : -1;
-
-    const updateCluster = (patch) => {
-      const nextCluster = {
-        planned: { total_reps: totalRepsPlanned ?? null, cluster_size: clusterSize ?? null, intra_rest_sec: intra ?? null },
-        ...cluster,
-        ...(patch && typeof patch === 'object' ? patch : {}),
-      };
-      updateLog(key, {
-        cluster: nextCluster,
-        reps: String(total || ''),
-        done: !!log?.done,
-        weight: String(log?.weight ?? cfg?.weight ?? ''),
-        advanced_config: cfg ?? log?.advanced_config ?? null,
-      });
-    };
-
-    const maybeStartIntraRest = (afterBlockIndex) => {
-      try {
-        const idx = Number(afterBlockIndex);
-        if (!Number.isFinite(idx) || idx < 0) return;
-        if (idx >= plannedBlocks.length - 1) return;
-        if (idx <= lastRest) return;
-        if (!intra || intra <= 0) return;
-        startTimer(intra, { kind: 'cluster', key, blockIndex: idx });
-        updateCluster({ last_rest_after_block: idx });
-      } catch {}
-    };
-
-    const notation = plannedBlocks.length ? plannedBlocks.join('+') : '';
-    const notesValue = String(log?.notes ?? '');
-
-    return (
-      <div key={key} className="space-y-2">
-        <div className="rounded-xl bg-neutral-900/50 border border-neutral-800/80 px-3 py-2.5 space-y-2 shadow-sm shadow-black/20">
-          <div className="flex items-center gap-2">
-            <div className="w-10 text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-            <input
-              inputMode="decimal"
-              value={String(log?.weight ?? cfg?.weight ?? '')}
-              onChange={(e) => {
-                const v = e?.target?.value ?? '';
-                updateLog(key, { weight: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-              }}
-              placeholder={weightPlaceholder}
-              className="w-24 bg-black/30 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-            />
-            <button
-              type="button"
-              onClick={() => {
-                const baseWeight = String(log?.weight ?? cfg?.weight ?? '').trim();
-                const baseRpe = String(log?.rpe ?? '').trim();
-                const planned = {
-                  total_reps: totalRepsPlanned ?? null,
-                  cluster_size: clusterSize ?? null,
-                  intra_rest_sec: intra ?? null,
-                };
-                const plannedBlocksModal = buildPlannedBlocks(totalRepsPlanned, clusterSize);
-                const restsByGap = plannedBlocksModal.length > 1 ? Array.from({ length: plannedBlocksModal.length - 1 }).map(() => intra) : [];
-                const blocksInput = plannedBlocksModal.map((plannedBlock, idx) => ({ planned: plannedBlock, weight: baseWeight, reps: blocks?.[idx] ?? null }));
-                setClusterModal({
-                  key,
-                  planned,
-                  plannedBlocks: plannedBlocksModal,
-                  intra,
-                  restsByGap,
-                  blocks: blocksInput,
-                  baseWeight,
-                  rpe: baseRpe,
-                  cfg: cfg ?? log?.advanced_config ?? null,
-                  error: '',
-                });
-              }}
-              className="bg-black/30 border border-neutral-700 rounded-xl px-2 sm:px-3 py-2 text-sm text-white outline-none hover:border-yellow-500/60 hover:text-yellow-500 transition-colors inline-flex items-center justify-center gap-2"
-            >
-              <Pencil size={14} />
-              <span className="text-xs font-black hidden sm:inline">Abrir</span>
-            </button>
-          </div>
-          <div className="flex flex-col sm:flex-row sm:items-center gap-2">
-            <div className="flex items-center gap-2 flex-1 min-w-0">
-              <span className="text-[10px] uppercase tracking-widest font-black text-yellow-500">Cluster</span>
-              <span className="text-xs text-neutral-400 whitespace-normal">
-                {notation ? `(${notation})` : ''} • Intra {intra || 0}s • Total: {total || 0} reps
-              </span>
-            </div>
-            <button
-              type="button"
-              disabled={!canDone}
-              onClick={() => {
-                const nextDone = !done;
-                updateLog(key, {
-                  done: nextDone,
-                  reps: String(total || ''),
-                  cluster: {
-                    planned: { total_reps: totalRepsPlanned ?? null, cluster_size: clusterSize ?? null, intra_rest_sec: intra ?? null },
-                    blocks,
-                    last_rest_after_block: Number.isFinite(lastRestAfterBlock) ? lastRestAfterBlock : null,
-                  },
-                  advanced_config: cfg ?? log?.advanced_config ?? null,
-                });
-                if (nextDone && restTime && restTime > 0) startTimer(restTime, { kind: 'rest', key });
-              }}
-              className={
-                canDone
-                  ? done
-                    ? 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 text-black font-black shadow-yellow-500/20 shadow-sm active:scale-95 transition duration-150 sm:w-auto'
-                    : 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700 active:scale-95 transition duration-150 sm:w-auto'
-                  : 'inline-flex items-center justify-center gap-2 min-h-[40px] px-3 py-2 rounded-xl bg-neutral-800/40 border border-neutral-800 text-neutral-500 font-bold cursor-not-allowed sm:w-auto'
-              }
-            >
-              <Check size={16} />
-              <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-            </button>
-          </div>
-        </div>
-
-        {plannedBlocks.length > 0 && (
-          <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
-            {plannedBlocks.map((planned, idx) => {
-              const current = blocks?.[idx] ?? null;
-              return (
-                <div key={`${key}-block-${idx}`} className="bg-neutral-900/40 border border-neutral-800 rounded-xl p-3">
-                  <div className="flex items-center justify-between gap-2">
-                    <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Bloco {idx + 1}</div>
-                    <div className="text-[10px] font-mono text-neutral-500">plan {planned}</div>
-                  </div>
-                  <input
-                    inputMode="decimal"
-                    value={current == null ? '' : String(current)}
-                    ref={(el) => {
-                      if (!clusterRefs.current[key]) clusterRefs.current[key] = {};
-                      clusterRefs.current[key][idx] = el;
-                    }}
-                    onChange={(e) => {
-                      const v = parseTrainingNumber(e?.target?.value);
-                      const next = v != null && v > 0 ? v : null;
-                      const nextBlocks = [...blocks];
-                      nextBlocks[idx] = next;
-                      updateCluster({ blocks: nextBlocks });
-                    }}
-                    onBlur={() => {
-                      const cur = blocks?.[idx] ?? null;
-                      const next = blocks?.[idx + 1] ?? null;
-                      if (idx < plannedBlocks.length - 1 && (cur ?? 0) > 0 && (next ?? 0) <= 0) {
-                        maybeStartIntraRest(idx);
-                      }
-                    }}
-                    placeholder={useWatermark && suggestion?.reps != null && plannedBlocks.length <= 1 ? String(suggestion.reps) : 'reps'}
-                    className="mt-2 w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                </div>
-              );
-            })}
-          </div>
-        )}
-        <textarea
-          value={notesValue}
-          onChange={(e) => {
-            const v = e?.target?.value ?? '';
-            updateLog(key, { notes: v, advanced_config: cfg ?? log?.advanced_config ?? null });
-          }}
-          placeholder="Observações da série"
-          rows={2}
-          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-        />
-      </div>
-    );
-  };
-
-  const renderDropSetSet = (ex, exIdx, setIdx) => {
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const cfgRaw = plannedSet?.advanced_config ?? plannedSet?.advancedConfig ?? null;
-    const stagesPlannedRaw = Array.isArray(cfgRaw) ? cfgRaw : [];
-    const ds = isObject(log?.drop_set) ? log.drop_set : {};
-    const stagesSavedRaw = Array.isArray(ds?.stages) ? ds.stages : [];
-    const stagesCount = Math.max(stagesPlannedRaw.length, stagesSavedRaw.length);
-    if (!stagesCount) return renderNormalSet(ex, exIdx, setIdx);
-
-    const auto = plannedSet?.it_auto && typeof plannedSet.it_auto === 'object' ? plannedSet.it_auto : null;
-    const modeLabel = String(auto?.label || '').trim() || 'Drop';
-
-    const stages = Array.from({ length: stagesCount }).map((_, idx) => {
-      const saved = stagesSavedRaw?.[idx] && typeof stagesSavedRaw[idx] === 'object' ? stagesSavedRaw[idx] : null;
-      const planned = stagesPlannedRaw?.[idx] && typeof stagesPlannedRaw[idx] === 'object' ? stagesPlannedRaw[idx] : null;
-      const weight = String(saved?.weight ?? planned?.weight ?? '').trim();
-      const reps = parseTrainingNumber(saved?.reps ?? planned?.reps) ?? null;
-      return { weight, reps };
-    });
-
-    const total = stages.reduce((acc, s) => acc + (parseTrainingNumber(s?.reps) ?? 0), 0);
-    const done = !!log?.done;
-    const canDone = stages.every((s) => String(s?.weight || '').trim() && (parseTrainingNumber(s?.reps) ?? 0) > 0);
-
-    const notesValue = String(log?.notes ?? '');
-    const hasNotes = notesValue.trim().length > 0;
-    const isNotesOpen = openNotesKeys.has(key);
-
-    const toggleNotes = () => {
-      setOpenNotesKeys((prev) => {
-        const next = new Set(prev);
-        if (next.has(key)) next.delete(key);
-        else next.add(key);
-        return next;
-      });
-    };
-
-    return (
-      <div key={key} className="space-y-2">
-        <div className="flex items-center gap-2">
-          <div className="w-10 text-xs font-mono text-neutral-400">#{setIdx + 1}</div>
-          <button
-            type="button"
-            onClick={() => {
-              const baseStages = stages.map((s) => ({
-                weight: String(s?.weight ?? '').trim(),
-                reps: parseTrainingNumber(s?.reps) ?? null,
-              }));
-              setDropSetModal({ key, label: modeLabel, stages: baseStages, error: '' });
-            }}
-            className="w-24 bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none hover:border-yellow-500/60 hover:text-yellow-500 transition-colors inline-flex items-center justify-center gap-2"
-          >
-            <Pencil size={14} />
-            <span className="text-xs font-black">Abrir</span>
-          </button>
-          <div className="flex items-center gap-2 flex-1 min-w-0">
-            <span className="text-[10px] uppercase tracking-widest font-black text-yellow-500">{modeLabel || 'Drop'}</span>
-            <span className="text-xs text-neutral-400 truncate">Etapas {stagesCount} • Total: {total || 0} reps</span>
-          </div>
-          <button
-            type="button"
-            onClick={toggleNotes}
-            className={
-              isNotesOpen || hasNotes
-                ? 'inline-flex items-center justify-center rounded-lg p-2 text-yellow-500 bg-yellow-500/10 border border-yellow-500/40 hover:bg-yellow-500/15 transition duration-200'
-                : 'inline-flex items-center justify-center rounded-lg p-2 text-neutral-400 bg-black/30 border border-neutral-700 hover:border-yellow-500/60 hover:text-yellow-500 transition duration-200'
-            }
-          >
-            <MessageSquare size={14} />
-          </button>
-          <button
-            type="button"
-            disabled={!canDone}
-            onClick={() => {
-              const nextDone = !done;
-              const lastWeight = String(stages?.[stages.length - 1]?.weight || '').trim();
-              const stageOut = stages.map((s) => ({
-                weight: String(s?.weight ?? '').trim(),
-                reps: parseTrainingNumber(s?.reps) ?? null,
-              }));
-              updateLog(key, {
-                done: nextDone,
-                weight: lastWeight,
-                reps: String(total || ''),
-                drop_set: { stages: stageOut },
-              });
-            }}
-            className={
-              canDone
-                ? done
-                  ? 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500 text-black font-black'
-                  : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700'
-                : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-800/40 border border-neutral-800 text-neutral-500 font-bold cursor-not-allowed'
-            }
-          >
-            <Check size={16} />
-            <span className="text-xs">{done ? 'Feito' : 'Concluir'}</span>
-          </button>
-        </div>
-
-        {!canDone && (
-          <div className="pl-12 text-[11px] text-neutral-500 font-semibold">
-            Preencha peso e reps em todas as etapas no modal para concluir.
-          </div>
-        )}
-
-        {isNotesOpen && (
-          <textarea
-            value={notesValue}
-            onChange={(e) => {
-              const v = e?.target?.value ?? '';
-              updateLog(key, { notes: v });
-            }}
-            placeholder="Observações da série"
-            rows={2}
-            className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-          />
-        )}
-      </div>
-    );
-  };
-
-  const renderSet = (ex, exIdx, setIdx) => {
-    const plannedSet = getPlannedSet(ex, setIdx);
-    const rawCfg = plannedSet?.advanced_config ?? plannedSet?.advancedConfig ?? null;
-    const key = `${exIdx}-${setIdx}`;
-    const log = getLog(key);
-    const hasDropStages = isObject(log?.drop_set) && Array.isArray(log?.drop_set?.stages) && log.drop_set.stages.length > 0;
-    if (Array.isArray(rawCfg) || hasDropStages) return renderDropSetSet(ex, exIdx, setIdx);
-    const cfg = getPlanConfig(ex, setIdx);
-    const method = String(ex?.method || '').trim();
-    const isCluster = method === 'Cluster' || isClusterConfig(cfg);
-    const isRestPause = method === 'Rest-Pause' || isRestPauseConfig(cfg);
-    if (isCluster) return renderClusterSet(ex, exIdx, setIdx);
-    if (isRestPause) return renderRestPauseSet(ex, exIdx, setIdx);
-    return renderNormalSet(ex, exIdx, setIdx);
-  };
-
-  const renderExercise = (ex, exIdx) => {
-    const name = String(ex?.name || '').trim() || `Exercício ${exIdx + 1}`;
-    const observation = String(ex?.notes || '').trim();
-    const setsHeader = Math.max(0, Number.parseInt(String(ex?.sets ?? '0'), 10) || 0);
-    const sdArr = Array.isArray(ex?.setDetails) ? ex.setDetails : Array.isArray(ex?.set_details) ? ex.set_details : [];
-    const setsCount = Math.max(setsHeader, Array.isArray(sdArr) ? sdArr.length : 0);
-    const collapsedNow = collapsed.has(exIdx);
-    const restTime = parseTrainingNumber(ex?.restTime ?? ex?.rest_time);
-    const videoUrl = String(ex?.videoUrl ?? ex?.video_url ?? '').trim();
-    const isReportLoading = reportHistoryStatus?.status === 'loading' && reportHistoryLoadingRef.current;
-
-    return (
-      <div key={`ex-${exIdx}`} className="rounded-2xl bg-neutral-900/70 border border-neutral-800/80 p-4 shadow-[0_10px_28px_rgba(0,0,0,0.35)]">
-        <div
-          role="button"
-          tabIndex={0}
-          onClick={() => {
-            setCurrentExerciseIdx(exIdx);
-            toggleCollapse(exIdx);
-          }}
-          onKeyDown={(e) => {
-            const key = e?.key;
-            if (key === 'Enter' || key === ' ') {
-              try {
-                e.preventDefault();
-              } catch {}
-              setCurrentExerciseIdx(exIdx);
-              toggleCollapse(exIdx);
-            }
-          }}
-          className="w-full flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3"
-        >
-          <div className="min-w-0 text-left flex-1">
-            <div className="flex items-center gap-2">
-              <Dumbbell size={16} className="text-yellow-500" />
-              <h3 className="font-black text-white truncate">{name}</h3>
-            </div>
-            <div className="mt-1 flex items-center gap-2 text-xs text-neutral-400">
-              <span className="font-mono">{setsCount} sets</span>
-              <span className="opacity-30">•</span>
-              <span className="font-mono">{restTime ? `${restTime}s` : '-'}</span>
-              <span className="opacity-30">•</span>
-              <span className="truncate">{String(ex?.method || 'Normal')}</span>
-            </div>
-            {observation ? (
-              <div className="mt-2 rounded-xl bg-neutral-900/50 border border-yellow-500/20 px-3 py-2">
-                <div className="text-sm text-neutral-200 whitespace-pre-wrap leading-snug">{observation}</div>
-              </div>
-            ) : null}
-          </div>
-          <div className="mt-1 grid grid-cols-4 gap-2 text-neutral-400 sm:flex sm:items-center sm:justify-end">
-            {videoUrl ? (
-              <button
-                type="button"
-                onClick={async (e) => {
-                  try {
-                    e.preventDefault();
-                    e.stopPropagation();
-                  } catch {}
-                  setCurrentExerciseIdx(exIdx);
-                  try {
-                    const win = typeof window !== 'undefined' ? window : null;
-                    if (!win || !videoUrl) throw new Error('URL do vídeo indisponível');
-                    const opened = win.open(videoUrl, '_blank', 'noopener,noreferrer');
-                    if (!opened) throw new Error('Popup bloqueado ao abrir vídeo');
-                    console.debug('[ActiveWorkout] video opened', { exIdx, videoUrl });
-                  } catch (err) {
-                    console.error('[ActiveWorkout] video open failed', { exIdx, videoUrl, err });
-                    try {
-                      await alert('Não foi possível abrir o vídeo agora. Verifique o link e tente novamente.');
-                    } catch {}
-                  }
-                }}
-                className="h-9 w-9 inline-flex flex-col items-center justify-center rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 hover:bg-neutral-800 transition-colors active:scale-95"
-                title="Ver vídeo"
-                aria-label="Ver vídeo"
-              >
-                <Play size={16} />
-                <span className="mt-0.5 text-[10px] leading-none text-neutral-400 opacity-60">Vídeo</span>
-              </button>
-            ) : null}
-            <ExecutionVideoCapture
-              exerciseName={name}
-              workoutId={workout?.id || null}
-              exerciseId={ex?.id || ex?.exercise_id || null}
-              exerciseLibraryId={ex?.exercise_library_id || null}
-            />
-            <button
-              type="button"
-              onClick={async (e) => {
-                try {
-                  e.preventDefault();
-                  e.stopPropagation();
-                } catch {}
-                setCurrentExerciseIdx(exIdx);
-                await openDeloadModal(ex, exIdx);
-              }}
-              className="h-9 w-9 inline-flex flex-col items-center justify-center rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 hover:bg-neutral-800 transition-colors active:scale-95"
-            >
-              {isReportLoading ? <Loader2 size={14} className="animate-spin" /> : <ArrowDown size={14} />}
-              <span className="mt-0.5 text-[10px] leading-none text-neutral-400 opacity-60">{isReportLoading ? 'Carregando' : 'Deload'}</span>
-            </button>
-            <div className="h-9 w-9 inline-flex items-center justify-center rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-400">
-              {collapsedNow ? <ChevronDown size={18} /> : <ChevronUp size={18} />}
-            </div>
-          </div>
-        </div>
-
-        {!collapsedNow && (
-          <div className="mt-4 space-y-2">
-            {Array.from({ length: setsCount }).map((_, setIdx) => renderSet(ex, exIdx, setIdx))}
-            <button
-              type="button"
-              onClick={() => addExtraSetToExercise(exIdx)}
-              className="w-full min-h-[44px] inline-flex items-center justify-center gap-2 rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 font-black hover:bg-neutral-800 active:scale-95 transition-transform"
-            >
-              <Plus size={16} />
-              <span className="text-sm">Série extra</span>
-            </button>
-          </div>
-        )}
-      </div>
-    );
-  };
-
-  const ExerciseSortRow = ({ item, index, total, onMoveUp, onMoveDown }) => {
-    const dragControls = useDragControls();
-    const exercise = item?.exercise && typeof item.exercise === 'object' ? item.exercise : {};
-    const name = String(exercise?.name || '').trim() || `Exercício ${Number(index) + 1}`;
-    const canMoveUp = index > 0;
-    const canMoveDown = index < total - 1;
-
-    return (
-      <Reorder.Item
-        value={item}
-        dragListener={false}
-        dragControls={dragControls}
-        className="rounded-xl bg-neutral-800 border border-neutral-700 p-3 flex items-center gap-3"
-      >
-        <button
-          type="button"
-          onPointerDown={(e) => dragControls.start(e)}
-          className="h-10 w-10 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-300 inline-flex items-center justify-center active:scale-95"
-        >
-          <GripVertical size={16} />
-        </button>
-        <div className="min-w-0 flex-1">
-          <div className="text-sm font-black text-white truncate">{name}</div>
-          <div className="text-[11px] text-neutral-500">Posição {index + 1}</div>
-        </div>
-        <div className="flex items-center gap-2">
-          <button
-            type="button"
-            onClick={onMoveUp}
-            disabled={!canMoveUp}
-            className={
-              canMoveUp
-                ? 'h-10 w-10 rounded-xl bg-neutral-900 border border-neutral-700 text-yellow-500 inline-flex items-center justify-center hover:bg-neutral-800 active:scale-95'
-                : 'h-10 w-10 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-700 inline-flex items-center justify-center'
-            }
-          >
-            <ArrowUp size={16} />
-          </button>
-          <button
-            type="button"
-            onClick={onMoveDown}
-            disabled={!canMoveDown}
-            className={
-              canMoveDown
-                ? 'h-10 w-10 rounded-xl bg-neutral-900 border border-neutral-700 text-yellow-500 inline-flex items-center justify-center hover:bg-neutral-800 active:scale-95'
-                : 'h-10 w-10 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-700 inline-flex items-center justify-center'
-            }
-          >
-            <ArrowDown size={16} />
-          </button>
-        </div>
-      </Reorder.Item>
-    );
-  };
-
-  if (!session || !workout) {
-    return (
-      <div className="min-h-screen bg-neutral-900 text-white p-6">
-        <div className="max-w-lg mx-auto rounded-xl bg-neutral-800 border border-neutral-700 p-6">
-          <div className="text-sm text-neutral-300">Sessão inválida.</div>
-          <div className="mt-4">
-            <BackButton onClick={props?.onBack} />
-          </div>
-        </div>
-      </div>
-    );
-  }
-
-  return (
-    <div className="min-h-screen bg-neutral-900 text-white flex flex-col">
-      <div className="sticky top-0 z-40 bg-neutral-950 border-b border-neutral-800 px-4 md:px-6 py-4 pt-safe">
-        <div className="max-w-6xl mx-auto flex items-center justify-between gap-3">
-          <div className="flex items-center gap-2">
-            <BackButton onClick={props?.onBack} />
-            <button
-              type="button"
-              onClick={() => setAddExerciseOpen(true)}
-              className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-yellow-500 text-black hover:bg-yellow-400 transition-colors active:scale-95"
-              title="Adicionar exercício extra"
-            >
-              <Plus size={16} />
-              <span className="text-sm font-black hidden sm:inline">Exercício</span>
-            </button>
-            <button
-              type="button"
-              onClick={openOrganizeModal}
-              disabled={exercises.length < 2}
-              className={
-                exercises.length < 2
-                  ? 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-700'
-                  : 'inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 hover:text-yellow-400 hover:bg-neutral-800 transition-colors active:scale-95'
-              }
-              title="Organizar exercícios"
-            >
-              <GripVertical size={16} />
-              <span className="text-sm font-black hidden sm:inline">Organizar</span>
-            </button>
-            <button
-              type="button"
-              onClick={() => setInviteOpen(true)}
-              className="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-800 text-yellow-500 hover:text-yellow-400 hover:bg-neutral-800 transition-colors active:scale-95"
-              title="Convidar para treinar junto"
-            >
-              <UserPlus size={16} />
-              <span className="text-sm font-black hidden sm:inline">Convidar</span>
-            </button>
-          </div>
-          <div className="min-w-0 flex-1">
-            <div className="font-black text-white truncate text-right">{String(workout?.title || 'Treino')}</div>
-            <div className="text-xs text-neutral-400 flex items-center justify-end gap-2 mt-1">
-              <Clock size={14} className="text-yellow-500" />
-              <span className="font-mono text-yellow-500">{formatElapsed(elapsedSeconds)}</span>
-            </div>
-          </div>
-        </div>
-      </div>
-
-      <InviteManager
-        isOpen={inviteOpen}
-        onClose={() => setInviteOpen(false)}
-        onInvite={async (targetUser) => {
-          try {
-            const payloadWorkout = workout && typeof workout === 'object'
-              ? { ...workout, exercises: Array.isArray(workout?.exercises) ? workout.exercises : [] }
-              : { title: 'Treino', exercises: [] };
-            await sendInvite(targetUser, payloadWorkout);
-          } catch (e) {
-            const msg = e?.message || String(e || '');
-            await alert('Falha ao enviar convite: ' + msg);
-          }
-        }}
-      />
-
-      {clusterModal && (
-        <div
-          className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => setClusterModal(null)}
-        >
-          <div
-            className="w-full max-w-2xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-            onClick={(e) => e.stopPropagation()}
-          >
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Cluster</div>
-                <div className="text-white font-black text-lg truncate">Preencher blocos</div>
-                <div className="text-xs text-neutral-400 truncate">
-                  {Array.isArray(clusterModal?.plannedBlocks) ? `${clusterModal.plannedBlocks.length} blocos` : 'Blocos'}
-                  {Array.isArray(clusterModal?.restsByGap) && clusterModal.restsByGap.length
-                    ? ` • descanso ${clusterModal.restsByGap[0]}s`
-                    : clusterModal?.intra
-                      ? ` • descanso ${clusterModal.intra}s`
-                      : ''}
-                </div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setClusterModal(null)}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-
-            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-              {clusterModal?.error ? (
-                <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/10 p-3 text-sm text-neutral-200">
-                  {String(clusterModal.error)}
-                </div>
-              ) : null}
-              {Array.isArray(clusterModal?.blocks) && clusterModal.blocks.length > 0 ? (
-                <div className="flex items-center justify-end">
-                  <button
-                    type="button"
-                    onClick={() => {
-                      setClusterModal((prev) => {
-                        if (!prev || typeof prev !== 'object') return prev;
-                        const plannedBlocks = Array.isArray(prev?.plannedBlocks) ? prev.plannedBlocks : [];
-                        const restsByGap = Array.isArray(prev?.restsByGap) ? prev.restsByGap : [];
-                        const baseWeight = String(prev?.baseWeight ?? '').trim();
-                        const blocks = plannedBlocks.map((p) => ({ planned: p, weight: baseWeight, reps: null }));
-                        return { ...prev, restsByGap, blocks, error: '' };
-                      });
-                    }}
-                    className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-                  >
-                    Resetar pesos
-                  </button>
-                </div>
-              ) : null}
-
-              {!Array.isArray(clusterModal?.blocks) || clusterModal.blocks.length === 0 ? (
-                <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                  <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Configurar Cluster</div>
-                  <div className="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
-                    <input
-                      inputMode="decimal"
-                      value={String(clusterModal?.planned?.total_reps ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return { ...prev, planned: { ...planned, total_reps: v ?? null }, error: '' };
-                        });
-                      }}
-                      placeholder="Total reps (ex.: 12)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                    <input
-                      inputMode="decimal"
-                      value={String(clusterModal?.planned?.cluster_blocks_count ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return { ...prev, planned: { ...planned, cluster_blocks_count: v ?? null }, error: '' };
-                        });
-                      }}
-                      placeholder="Blocos (ex.: 3)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                    <input
-                      inputMode="decimal"
-                      value={String(clusterModal?.planned?.intra_rest_sec ?? clusterModal?.intra ?? '')}
-                      onChange={(e) => {
-                        const v = parseTrainingNumber(e?.target?.value);
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return { ...prev, planned: { ...planned, intra_rest_sec: v ?? null }, intra: v ?? prev.intra ?? 15, error: '' };
-                        });
-                      }}
-                      placeholder="Descanso (s) (ex.: 15)"
-                      className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                    />
-                  </div>
-                  <div className="mt-2 flex items-center justify-end">
-                    <button
-                      type="button"
-                      onClick={() => {
-                        const total = parseTrainingNumber(clusterModal?.planned?.total_reps);
-                        const blocksCount = parseTrainingNumber(clusterModal?.planned?.cluster_blocks_count);
-                        const intra = parseTrainingNumber(clusterModal?.planned?.intra_rest_sec) ?? parseTrainingNumber(clusterModal?.intra) ?? 15;
-                        const plannedBlocks = buildBlocksByCount(total, blocksCount);
-                        if (!plannedBlocks.length) {
-                          setClusterModal((prev) =>
-                            prev && typeof prev === 'object'
-                              ? { ...prev, error: 'Configuração inválida. Preencha total reps e quantidade de blocos.' }
-                              : prev,
-                          );
-                          return;
-                        }
-                        const restsByGap = plannedBlocks.length > 1 ? Array.from({ length: plannedBlocks.length - 1 }).map(() => intra) : [];
-                        const baseWeight = String(clusterModal?.baseWeight ?? '').trim();
-                        const blocks = plannedBlocks.map((p) => ({ planned: p, weight: baseWeight, reps: null }));
-                        setClusterModal((prev) => {
-                          if (!prev || typeof prev !== 'object') return prev;
-                          const planned = prev.planned && typeof prev.planned === 'object' ? prev.planned : {};
-                          return {
-                            ...prev,
-                            planned: { ...planned, total_reps: total ?? null, cluster_blocks_count: blocksCount ?? null, intra_rest_sec: intra ?? null },
-                            plannedBlocks,
-                            restsByGap,
-                            blocks,
-                            error: '',
-                          };
-                        });
-                      }}
-                      className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-                    >
-                      Gerar blocos
-                    </button>
-                  </div>
-                </div>
-              ) : null}
-              {Array.isArray(clusterModal?.blocks) &&
-                clusterModal.blocks.map((b, idx) => {
-                  const planned = b?.planned ?? null;
-                  const repsValue = b?.reps == null ? '' : String(b.reps);
-                  const weightValue = String(b?.weight ?? '');
-                  const isLast = idx >= clusterModal.blocks.length - 1;
-                  const restSec = Array.isArray(clusterModal?.restsByGap) ? Number(clusterModal.restsByGap?.[idx]) : Number(clusterModal?.intra);
-                  const safeRestSec = Number.isFinite(restSec) && restSec > 0 ? restSec : 0;
-                  return (
-                    <div key={`cluster-block-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3 relative">
-                      <div className="flex items-center justify-between gap-2">
-                        <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Bloco {idx + 1}</div>
-                        {planned ? <div className="text-[10px] font-mono text-neutral-500">plan {planned}</div> : <div />}
-                      </div>
-                      {!isLast && safeRestSec ? (
-                        <button
-                          type="button"
-                          onClick={() => {
-                            startTimer(safeRestSec, { kind: 'cluster', key: clusterModal?.key, blockIndex: idx });
-                          }}
-                          className="absolute top-3 right-3 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 active:scale-95 transition-transform z-10"
-                          aria-label={`Iniciar descanso ${safeRestSec}s`}
-                        >
-                          <Clock size={14} className="text-yellow-500" />
-                          <span className="text-xs font-black">{safeRestSec}s</span>
-                        </button>
-                      ) : null}
-                      <div className="mt-2 grid grid-cols-2 gap-2">
-                        <input
-                          inputMode="decimal"
-                          value={weightValue}
-                          onChange={(e) => {
-                            const v = e?.target?.value ?? '';
-                            setClusterModal((prev) => {
-                              if (!prev || typeof prev !== 'object') return prev;
-                              const nextBlocks = Array.isArray(prev.blocks) ? [...prev.blocks] : [];
-                              const cur = nextBlocks[idx] && typeof nextBlocks[idx] === 'object' ? nextBlocks[idx] : {};
-                              nextBlocks[idx] = { ...cur, weight: v };
-                              return { ...prev, blocks: nextBlocks, error: '' };
-                            });
-                          }}
-                          placeholder="kg"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                        <input
-                          inputMode="decimal"
-                          value={repsValue}
-                          onChange={(e) => {
-                            const v = parseTrainingNumber(e?.target?.value);
-                            const next = v != null && v > 0 ? v : null;
-                            setClusterModal((prev) => {
-                              if (!prev || typeof prev !== 'object') return prev;
-                              const nextBlocks = Array.isArray(prev.blocks) ? [...prev.blocks] : [];
-                              const cur = nextBlocks[idx] && typeof nextBlocks[idx] === 'object' ? nextBlocks[idx] : {};
-                              nextBlocks[idx] = { ...cur, reps: next };
-                              return { ...prev, blocks: nextBlocks, error: '' };
-                            });
-                          }}
-                          placeholder="reps"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                      </div>
-                      {!isLast ? <div className="mt-2 text-xs text-neutral-500">Descanso: {safeRestSec}s</div> : null}
-                    </div>
-                  );
-                })}
-
-              <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">RPE da série</div>
-                <input
-                  inputMode="decimal"
-                  value={String(clusterModal?.rpe ?? '')}
-                  onChange={(e) => {
-                    const v = e?.target?.value ?? '';
-                    setClusterModal((prev) => (prev && typeof prev === 'object' ? { ...prev, rpe: v, error: '' } : prev));
-                  }}
-                  placeholder="RPE (0-10)"
-                  className="mt-2 w-full bg-black/30 border border-yellow-500/30 rounded-lg px-3 py-2 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500"
-                />
-              </div>
-            </div>
-
-            <div className="p-4 border-t border-neutral-800 flex items-center justify-between gap-2">
-              <button
-                type="button"
-                onClick={() => setClusterModal(null)}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={saveClusterModal}
-                disabled={!Array.isArray(clusterModal?.blocks) || clusterModal.blocks.length === 0}
-                className={
-                  !Array.isArray(clusterModal?.blocks) || clusterModal.blocks.length === 0
-                    ? 'min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500/40 text-black/60 font-black text-xs uppercase tracking-widest inline-flex items-center gap-2 cursor-not-allowed'
-                    : 'min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center gap-2'
-                }
-              >
-                <Save size={16} />
-                Salvar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      {restPauseModal && (
-        <div
-          className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => setRestPauseModal(null)}
-        >
-          <div
-            className="w-full max-w-2xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-            onClick={(e) => e.stopPropagation()}
-          >
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">{String(restPauseModal?.label || '').trim() === 'SST' ? 'SST' : 'Rest-P'}</div>
-                <div className="text-white font-black text-lg truncate">Preencher minis</div>
-                <div className="text-xs text-neutral-400 truncate">
-                  {Number(restPauseModal?.miniSets || 0)} minis • descanso {Number(restPauseModal?.pauseSec || 0)}s
-                </div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setRestPauseModal(null)}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-
-            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-              {restPauseModal?.error ? (
-                <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/10 p-3 text-sm text-neutral-200">
-                  {String(restPauseModal.error)}
-                </div>
-              ) : null}
-
-              <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Configurar {String(restPauseModal?.label || 'Rest-P')}</div>
-                <div className="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
-                  <input
-                    inputMode="decimal"
-                    value={String(restPauseModal?.miniSets ?? '')}
-                    onChange={(e) => {
-                      const v = parseTrainingNumber(e?.target?.value);
-                      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, miniSets: v ?? 0, error: '' } : prev));
-                    }}
-                    placeholder="Minis (ex.: 2)"
-                    className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                  <input
-                    inputMode="decimal"
-                    value={String(restPauseModal?.pauseSec ?? '')}
-                    onChange={(e) => {
-                      const v = parseTrainingNumber(e?.target?.value);
-                      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, pauseSec: v ?? 15, error: '' } : prev));
-                    }}
-                    placeholder="Descanso (s) (ex.: 15)"
-                    className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                  <input
-                    inputMode="decimal"
-                    value={String(restPauseModal?.weight ?? '')}
-                    onChange={(e) => {
-                      const v = e?.target?.value ?? '';
-                      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, weight: v, error: '' } : prev));
-                    }}
-                    placeholder="kg"
-                    className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                </div>
-                <div className="mt-2 flex items-center justify-end">
-                  <button
-                    type="button"
-                    onClick={() => {
-                      const minisCount = Math.max(0, Math.floor(parseTrainingNumber(restPauseModal?.miniSets) ?? 0));
-                      if (!minisCount) {
-                        setRestPauseModal((prev) =>
-                          prev && typeof prev === 'object' ? { ...prev, error: 'Defina a quantidade de minis.' } : prev,
-                        );
-                        return;
-                      }
-                      setRestPauseModal((prev) => {
-                        if (!prev || typeof prev !== 'object') return prev;
-                        return { ...prev, miniSets: minisCount, minis: Array.from({ length: minisCount }).map(() => null), error: '' };
-                      });
-                    }}
-                    className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-                  >
-                    Gerar minis
-                  </button>
-                </div>
-              </div>
-
-              <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3 relative">
-                <div className="flex items-center justify-between gap-2">
-                  <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Ativação</div>
-                  <div className="text-[10px] font-mono text-neutral-500">{Number(restPauseModal?.activationReps || 0)} reps</div>
-                </div>
-                <div className="mt-2 grid grid-cols-2 gap-2">
-                  <input
-                    inputMode="decimal"
-                    value={String(restPauseModal?.weight ?? '')}
-                    onChange={(e) => {
-                      const v = e?.target?.value ?? '';
-                      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, weight: v, error: '' } : prev));
-                    }}
-                    placeholder="kg"
-                    className="w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                  <input
-                    inputMode="decimal"
-                    value={String(restPauseModal?.activationReps ?? '')}
-                    onChange={(e) => {
-                      const v = parseTrainingNumber(e?.target?.value);
-                      setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, activationReps: v ?? null, error: '' } : prev));
-                    }}
-                    placeholder="Reps ativação"
-                    className="w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                  />
-                </div>
-              </div>
-
-              {Array.isArray(restPauseModal?.minis) &&
-                restPauseModal.minis.map((mini, idx) => {
-                  const isLast = idx >= restPauseModal.minis.length - 1;
-                  const restSec = Number(restPauseModal?.pauseSec || 0);
-                  const safeRestSec = Number.isFinite(restSec) && restSec > 0 ? restSec : 0;
-                  return (
-                    <div key={`mini-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3 relative">
-                      <div className="flex items-center justify-between gap-2">
-                        <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Mini {idx + 1}</div>
-                        {!isLast ? <div className="text-[10px] font-mono text-neutral-500">Descanso {safeRestSec}s</div> : <div />}
-                      </div>
-                      {!isLast && safeRestSec ? (
-                        <button
-                          type="button"
-                          onClick={() => {
-                            startTimer(safeRestSec, { kind: 'rest_pause', key: restPauseModal?.key, miniIndex: idx });
-                          }}
-                          className="absolute top-3 right-3 inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 active:scale-95 transition-transform z-10"
-                          aria-label={`Iniciar descanso ${safeRestSec}s`}
-                        >
-                          <Clock size={14} className="text-yellow-500" />
-                          <span className="text-xs font-black">{safeRestSec}s</span>
-                        </button>
-                      ) : null}
-                      <div className="mt-2 grid grid-cols-2 gap-2">
-                        <input
-                          inputMode="decimal"
-                          value={String(restPauseModal?.weight ?? '')}
-                          onChange={(e) => {
-                            const v = e?.target?.value ?? '';
-                            setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, weight: v, error: '' } : prev));
-                          }}
-                          placeholder="kg"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                        <input
-                          inputMode="decimal"
-                          value={mini == null ? '' : String(mini)}
-                          onChange={(e) => {
-                            const n = parseTrainingNumber(e?.target?.value);
-                            const next = n != null && n > 0 ? n : null;
-                            setRestPauseModal((prev) => {
-                              if (!prev || typeof prev !== 'object') return prev;
-                              const list = Array.isArray(prev.minis) ? [...prev.minis] : [];
-                              list[idx] = next;
-                              return { ...prev, minis: list, error: '' };
-                            });
-                          }}
-                          placeholder="reps"
-                          className="w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        />
-                      </div>
-                      {!isLast && safeRestSec ? <div className="mt-2 text-xs text-neutral-500">Descanso: {safeRestSec}s</div> : null}
-                    </div>
-                  );
-                })}
-
-              <div className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">RPE da série</div>
-                <input
-                  inputMode="decimal"
-                  value={String(restPauseModal?.rpe ?? '')}
-                  onChange={(e) => {
-                    const v = e?.target?.value ?? '';
-                    setRestPauseModal((prev) => (prev && typeof prev === 'object' ? { ...prev, rpe: v, error: '' } : prev));
-                  }}
-                  placeholder="RPE (0-10)"
-                  className="mt-2 w-full bg-black/30 border border-yellow-500/30 rounded-xl px-3 py-2 text-sm text-yellow-500 font-bold outline-none focus:ring-1 ring-yellow-500"
-                />
-              </div>
-            </div>
-
-            <div className="p-4 border-t border-neutral-800 flex items-center justify-between gap-2">
-              <button
-                type="button"
-                onClick={() => setRestPauseModal(null)}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={saveRestPauseModal}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center gap-2"
-              >
-                <Save size={16} />
-                Salvar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      {dropSetModal && (
-        <div
-          className="fixed inset-0 z-[1400] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => setDropSetModal(null)}
-        >
-          {(() => {
-            const modalKey = String(dropSetModal?.key || '').trim();
-            const suggestion = modalKey && deloadSuggestions?.[modalKey] && typeof deloadSuggestions[modalKey] === 'object' ? deloadSuggestions[modalKey] : null;
-            const useWatermark = DELOAD_SUGGEST_MODE === 'watermark';
-            const weightPlaceholder = useWatermark && suggestion?.weight != null ? `${suggestion.weight} kg` : 'kg';
-            const repsPlaceholder = useWatermark && suggestion?.reps != null ? String(suggestion.reps) : 'reps';
-            return (
-          <div
-            className="w-full max-w-2xl bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-            onClick={(e) => e.stopPropagation()}
-          >
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">{String(dropSetModal?.label || 'Drop')}</div>
-                <div className="text-white font-black text-lg truncate">Preencher etapas</div>
-                <div className="text-xs text-neutral-400 truncate">{Array.isArray(dropSetModal?.stages) ? dropSetModal.stages.length : 0} etapas</div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setDropSetModal(null)}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-
-            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto custom-scrollbar">
-              {dropSetModal?.error ? (
-                <div className="rounded-xl border border-yellow-500/20 bg-yellow-500/10 p-3 text-sm text-neutral-200">
-                  {String(dropSetModal.error)}
-                </div>
-              ) : null}
-
-              <div className="flex items-center justify-between gap-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Etapas</div>
-                <div className="flex items-center gap-2">
-                  <button
-                    type="button"
-                    onClick={() => {
-                      const pickWeight = () => {
-                        const stages = Array.isArray(dropSetModal?.stages) ? dropSetModal.stages : [];
-                        for (const st of stages) {
-                          const w = String(st?.weight ?? '').trim();
-                          if (w) return w;
-                        }
-                        return '';
-                      };
-                      const w = pickWeight();
-                      if (!w) {
-                        try {
-                          window.alert('Preencha pelo menos 1 etapa com peso antes de linkar.');
-                        } catch {}
-                        return;
-                      }
-                      setDropSetModal((prev) => {
-                        if (!prev || typeof prev !== 'object') return prev;
-                        const stages = Array.isArray(prev.stages) ? prev.stages : [];
-                        const nextStages = stages.map((st) => {
-                          const cur = st && typeof st === 'object' ? st : {};
-                          return { ...cur, weight: w };
-                        });
-                        return { ...prev, stages: nextStages, error: '' };
-                      });
-                    }}
-                    className="min-h-[36px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 inline-flex items-center gap-2"
-                  >
-                    <Link2 size={14} />
-                    Linkar
-                  </button>
-                  <button
-                    type="button"
-                    onClick={() => {
-                      setDropSetModal((prev) => {
-                        if (!prev || typeof prev !== 'object') return prev;
-                        const list = Array.isArray(prev.stages) ? [...prev.stages] : [];
-                        if (list.length >= DROPSET_STAGE_LIMIT) return prev;
-                        list.push({ weight: '', reps: null });
-                        return { ...prev, stages: list, error: '' };
-                      });
-                    }}
-                    className="min-h-[36px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800 inline-flex items-center gap-2"
-                  >
-                    <Plus size={14} />
-                    Adicionar
-                  </button>
-                </div>
-              </div>
-
-              {Array.isArray(dropSetModal?.stages) &&
-                dropSetModal.stages.map((st, idx) => (
-                  <div key={`ds-${idx}`} className="rounded-xl border border-neutral-800 bg-neutral-950/30 p-3">
-                    <div className="flex items-center justify-between gap-2">
-                      <div className="text-[10px] uppercase tracking-widest font-bold text-neutral-400">Etapa {idx + 1}</div>
-                      <button
-                        type="button"
-                        onClick={() => {
-                          setDropSetModal((prev) => {
-                            if (!prev || typeof prev !== 'object') return prev;
-                            const list = Array.isArray(prev.stages) ? [...prev.stages] : [];
-                            list.splice(idx, 1);
-                            return { ...prev, stages: list, error: '' };
-                          });
-                        }}
-                        className="h-9 w-9 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 inline-flex items-center justify-center"
-                        aria-label="Remover etapa"
-                      >
-                        <X size={14} />
-                      </button>
-                    </div>
-                    <div className="mt-2 grid grid-cols-2 gap-2">
-                      <input
-                        inputMode="decimal"
-                        value={String(st?.weight ?? '')}
-                        onChange={(e) => {
-                          const v = e?.target?.value ?? '';
-                          setDropSetModal((prev) => {
-                            if (!prev || typeof prev !== 'object') return prev;
-                            const list = Array.isArray(prev.stages) ? [...prev.stages] : [];
-                            const cur = list[idx] && typeof list[idx] === 'object' ? list[idx] : {};
-                            list[idx] = { ...cur, weight: v };
-                            return { ...prev, stages: list, error: '' };
-                          });
-                        }}
-                        placeholder={weightPlaceholder}
-                        className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                      />
-                      <input
-                        inputMode="decimal"
-                        value={st?.reps == null ? '' : String(st.reps)}
-                        onChange={(e) => {
-                          const n = parseTrainingNumber(e?.target?.value);
-                          const next = n != null && n > 0 ? n : null;
-                          setDropSetModal((prev) => {
-                            if (!prev || typeof prev !== 'object') return prev;
-                            const list = Array.isArray(prev.stages) ? [...prev.stages] : [];
-                            const cur = list[idx] && typeof list[idx] === 'object' ? list[idx] : {};
-                            list[idx] = { ...cur, reps: next };
-                            return { ...prev, stages: list, error: '' };
-                          });
-                        }}
-                        placeholder={repsPlaceholder}
-                        className="w-full bg-black/30 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                      />
-                    </div>
-                  </div>
-                ))}
-            </div>
-
-            <div className="p-4 border-t border-neutral-800 flex items-center justify-between gap-2">
-              <button
-                type="button"
-                onClick={() => setDropSetModal(null)}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-neutral-900 border border-neutral-800 text-neutral-200 font-black text-xs uppercase tracking-widest hover:bg-neutral-800"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={saveDropSetModal}
-                className="min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black text-xs uppercase tracking-widest hover:bg-yellow-400 inline-flex items-center gap-2"
-              >
-                <Save size={16} />
-                Salvar
-              </button>
-            </div>
-          </div>
-            );
-          })()}
-        </div>
-      )}
-
-      {postCheckinOpen && (
-        <div
-          className="fixed inset-0 z-[1200] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => {
-            setPostCheckinOpen(false);
-            const r = postCheckinResolveRef.current;
-            postCheckinResolveRef.current = null;
-            if (typeof r === 'function') r(null);
-          }}
-        >
-          <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-xs font-black uppercase tracking-widest text-yellow-500">Check-in</div>
-                <div className="text-white font-black text-lg truncate">Pós-treino</div>
-                <div className="text-xs text-neutral-400 truncate">{String(workout?.title || 'Treino')}</div>
-              </div>
-              <button
-                type="button"
-                onClick={() => {
-                  setPostCheckinOpen(false);
-                  const r = postCheckinResolveRef.current;
-                  postCheckinResolveRef.current = null;
-                  if (typeof r === 'function') r(null);
-                }}
-                className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700 inline-flex items-center justify-center"
-                aria-label="Fechar"
-              >
-                <X size={18} />
-              </button>
-            </div>
-            <div className="p-4 space-y-4">
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Esforço (RPE 1–10)</div>
-                <select
-                  value={String(postCheckinDraft?.rpe ?? '')}
-                  onChange={(e) => setPostCheckinDraft((prev) => ({ ...prev, rpe: String(e.target.value || '') }))}
-                  className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                >
-                  <option value="">Não informar</option>
-                  {Array.from({ length: 10 }).map((_, i) => (
-                    <option key={i + 1} value={String(i + 1)}>
-                      {i + 1}
-                    </option>
-                  ))}
-                </select>
-              </div>
-
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Satisfação (1–5)</div>
-                <div className="grid grid-cols-5 gap-2">
-                  {[1, 2, 3, 4, 5].map((n) => (
-                    <button
-                      key={n}
-                      type="button"
-                      onClick={() => setPostCheckinDraft((prev) => ({ ...prev, satisfaction: String(n) }))}
-                      className={
-                        String(postCheckinDraft?.satisfaction || '') === String(n)
-                          ? 'min-h-[44px] rounded-xl bg-yellow-500 text-black font-black'
-                          : 'min-h-[44px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black hover:bg-neutral-800'
-                      }
-                    >
-                      {n}
-                    </button>
-                  ))}
-                </div>
-              </div>
-
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Dor / Soreness (0–10)</div>
-                <select
-                  value={String(postCheckinDraft?.soreness ?? '')}
-                  onChange={(e) => setPostCheckinDraft((prev) => ({ ...prev, soreness: String(e.target.value || '') }))}
-                  className="w-full min-h-[44px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white"
-                >
-                  <option value="">Não informar</option>
-                  {Array.from({ length: 11 }).map((_, i) => (
-                    <option key={i} value={String(i)}>
-                      {i}
-                    </option>
-                  ))}
-                </select>
-              </div>
-
-              <div className="space-y-2">
-                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Observações (opcional)</div>
-                <textarea
-                  value={String(postCheckinDraft?.notes || '')}
-                  onChange={(e) => setPostCheckinDraft((prev) => ({ ...prev, notes: String(e.target.value || '') }))}
-                  className="w-full min-h-[90px] bg-neutral-900 border border-neutral-700 rounded-xl px-3 py-2 text-sm text-white outline-none"
-                  placeholder="Ex.: treino pesado, boa técnica, ajustar carga na próxima…"
-                />
-              </div>
-            </div>
-            <div className="p-4 border-t border-neutral-800 flex items-center gap-2">
-              <button
-                type="button"
-                onClick={() => {
-                  setPostCheckinOpen(false);
-                  const r = postCheckinResolveRef.current;
-                  postCheckinResolveRef.current = null;
-                  if (typeof r === 'function') r(null);
-                }}
-                className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-              >
-                Pular
-              </button>
-              <button
-                type="button"
-                onClick={() => {
-                  setPostCheckinOpen(false);
-                  const r = postCheckinResolveRef.current;
-                  postCheckinResolveRef.current = null;
-                  if (typeof r === 'function') r(postCheckinDraft);
-                }}
-                className="flex-1 min-h-[44px] px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-              >
-                Continuar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      {deloadModal && (
-        <div
-          className="fixed inset-0 z-[120] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 pt-safe"
-          onClick={() => setDeloadModal(null)}
-        >
-          {(() => {
-            const baseWeight = Number(deloadModal?.baseWeight || 0);
-            const suggestedWeight = Number(deloadModal?.suggestedWeight || 0);
-            const reductionPct = Math.round((Number(deloadModal?.reductionPct || 0) * 1000) / 10) / 10;
-            const minWeight = Number(deloadModal?.minWeight || 0);
-            const canApply = Number.isFinite(baseWeight) && baseWeight > 0 && Number.isFinite(suggestedWeight) && suggestedWeight > 0;
-            const reportStatus = String(reportHistoryStatus?.status || 'idle');
-            const reportSource = String(reportHistoryStatus?.source || '');
-            const reportUpdatedLabel = reportHistoryUpdatedAt
-              ? new Date(reportHistoryUpdatedAt).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
-              : '';
-            const reportLabel =
-              reportStatus === 'loading'
-                ? 'Carregando relatórios…'
-                : reportStatus === 'error'
-                  ? 'Relatórios indisponíveis. Usando dados locais.'
-                  : reportSource === 'cache'
-                    ? 'Relatórios carregados do cache.'
-                    : reportSource === 'cache-stale'
-                      ? 'Relatórios do cache (atualizando).'
-                      : reportSource === 'network'
-                        ? 'Relatórios atualizados.'
-                        : 'Relatórios prontos.';
-            return (
-              <div
-                className="w-full max-w-lg bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden"
-                onClick={(e) => e.stopPropagation()}
-              >
-                <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                  <div className="min-w-0">
-                    <div className="text-[11px] uppercase tracking-widest text-yellow-500 font-black">Deload</div>
-                    <div className="text-lg font-black text-white truncate">{String(deloadModal?.name || 'Exercício')}</div>
-                    <div className="text-xs text-neutral-400 truncate">{String(deloadModal?.reason || '')}</div>
-                  </div>
-                  <button
-                    type="button"
-                    onClick={() => setDeloadModal(null)}
-                    className="h-10 w-10 inline-flex items-center justify-center rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700"
-                    aria-label="Fechar"
-                  >
-                    <X size={16} />
-                  </button>
-                </div>
-                <div className="p-4 space-y-4">
-                  <div className="rounded-xl bg-neutral-950/40 border border-neutral-800 p-3 text-xs text-neutral-400 flex items-center justify-between gap-3">
-                    <span className="min-w-0 truncate">{reportLabel}</span>
-                    {reportUpdatedLabel ? <span className="font-mono text-yellow-500">{reportUpdatedLabel}</span> : null}
-                  </div>
-                  <div className="grid grid-cols-2 gap-3">
-                    <div className="rounded-xl bg-neutral-950/40 border border-neutral-800 p-3">
-                      <div className="text-[10px] uppercase tracking-widest text-neutral-500 font-bold">Peso base</div>
-                      <div className="mt-2 text-xl font-black text-white">{baseWeight ? `${baseWeight} kg` : '-'}</div>
-                    </div>
-                    <div className="rounded-xl bg-neutral-950/40 border border-yellow-500/30 p-3">
-                      <div className="text-[10px] uppercase tracking-widest text-yellow-500 font-black">Peso sugerido</div>
-                      <div className="mt-2 text-xl font-black text-yellow-500">{suggestedWeight ? `${suggestedWeight} kg` : '-'}</div>
-                    </div>
-                  </div>
-                  <div className="grid grid-cols-2 gap-3">
-                    <div>
-                      <label className="text-[10px] uppercase tracking-widest text-neutral-500 font-bold">Redução (%)</label>
-                      <input
-                        inputMode="decimal"
-                        value={Number.isFinite(reductionPct) ? String(reductionPct) : ''}
-                        onChange={(e) => updateDeloadModalFromPercent(e?.target?.value ?? '')}
-                        className="mt-2 w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-3 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        placeholder="12"
-                      />
-                    </div>
-                    <div>
-                      <label className="text-[10px] uppercase tracking-widest text-neutral-500 font-bold">Peso sugerido (kg)</label>
-                      <input
-                        inputMode="decimal"
-                        value={Number.isFinite(suggestedWeight) ? String(suggestedWeight) : ''}
-                        onChange={(e) => updateDeloadModalFromWeight(e?.target?.value ?? '')}
-                        className="mt-2 w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-3 text-sm text-white outline-none focus:ring-1 ring-yellow-500"
-                        placeholder="100"
-                      />
-                    </div>
-                  </div>
-                  <div className="rounded-xl bg-neutral-950/40 border border-neutral-800 p-3 text-xs text-neutral-400">
-                    <div className="flex items-center justify-between gap-2">
-                      <span>Histórico analisado</span>
-                      <span className="font-mono text-yellow-500">{Number(deloadModal?.historyCount || 0)} treinos</span>
-                    </div>
-                    <div className="mt-1 flex items-center justify-between gap-2">
-                      <span>Peso mínimo seguro</span>
-                      <span className="font-mono text-yellow-500">{minWeight ? `${Math.round(minWeight * 10) / 10} kg` : '-'}</span>
-                    </div>
-                  </div>
-                </div>
-                <div className="p-4 border-t border-neutral-800 flex gap-2">
-                  <button
-                    type="button"
-                    onClick={() => setDeloadModal(null)}
-                    className="flex-1 min-h-[44px] rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-                  >
-                    Cancelar
-                  </button>
-                  <button
-                    type="button"
-                    onClick={applyDeloadToExercise}
-                    disabled={!canApply}
-                    className={
-                      canApply
-                        ? 'flex-1 min-h-[44px] rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400 inline-flex items-center justify-center gap-2'
-                        : 'flex-1 min-h-[44px] rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-500 font-black'
-                    }
-                  >
-                    <Check size={16} />
-                    Aplicar agora
-                  </button>
-                </div>
-              </div>
-            );
-          })()}
-        </div>
-      )}
-
-      {addExerciseOpen && (
-        <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setAddExerciseOpen(false)}>
-          <div className="w-full max-w-md bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Treino ativo</div>
-                <div className="text-lg font-black text-white truncate">Adicionar exercício extra</div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setAddExerciseOpen(false)}
-                className="h-10 w-10 inline-flex items-center justify-center rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700"
-              >
-                <X size={16} />
-              </button>
-            </div>
-            <div className="p-4 space-y-3">
-              <div>
-                <label className="text-[10px] uppercase tracking-widest text-neutral-500 font-bold">Nome do exercício</label>
-                <input
-                  value={String(addExerciseDraft?.name ?? '')}
-                  onChange={(e) => setAddExerciseDraft((prev) => ({ ...(prev || {}), name: e?.target?.value ?? '' }))}
-                  className="mt-2 w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-3 text-sm text-white outline-none focus:ring-1 ring-yellow-500 placeholder:text-neutral-600 placeholder:opacity-40"
-                  placeholder="Ex: Supino reto"
-                />
-              </div>
-              <div className="grid grid-cols-2 gap-3">
-                <div>
-                  <label className="text-[10px] uppercase tracking-widest text-neutral-500 font-bold">Sets</label>
-                  <input
-                    inputMode="decimal"
-                    value={String(addExerciseDraft?.sets ?? '')}
-                    onChange={(e) => setAddExerciseDraft((prev) => ({ ...(prev || {}), sets: e?.target?.value ?? '' }))}
-                    className="mt-2 w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-3 text-sm text-white outline-none focus:ring-1 ring-yellow-500 placeholder:text-neutral-600 placeholder:opacity-40"
-                    placeholder="3"
-                  />
-                </div>
-                <div>
-                  <label className="text-[10px] uppercase tracking-widest text-neutral-500 font-bold">Descanso (s)</label>
-                  <input
-                    inputMode="decimal"
-                    value={String(addExerciseDraft?.restTime ?? '')}
-                    onChange={(e) => setAddExerciseDraft((prev) => ({ ...(prev || {}), restTime: e?.target?.value ?? '' }))}
-                    className="mt-2 w-full bg-black/30 border border-neutral-700 rounded-xl px-3 py-3 text-sm text-white outline-none focus:ring-1 ring-yellow-500 placeholder:text-neutral-600 placeholder:opacity-40"
-                    placeholder="60"
-                  />
-                </div>
-              </div>
-            </div>
-            <div className="p-4 border-t border-neutral-800 flex gap-2">
-              <button
-                type="button"
-                onClick={() => setAddExerciseOpen(false)}
-                className="flex-1 min-h-[44px] rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={addExtraExerciseToWorkout}
-                className="flex-1 min-h-[44px] rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400"
-              >
-                Adicionar
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      {organizeOpen && (
-        <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={requestCloseOrganize}>
-          <div className="w-full max-w-lg bg-neutral-900 border border-neutral-800 rounded-2xl shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Treino ativo</div>
-                <div className="text-lg font-black text-white truncate">Organizar exercícios</div>
-                <div className="text-xs text-neutral-500">Arraste ou use as setas para reordenar.</div>
-              </div>
-              <button
-                type="button"
-                onClick={requestCloseOrganize}
-                className="h-10 w-10 inline-flex items-center justify-center rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700"
-              >
-                <X size={16} />
-              </button>
-            </div>
-            <div className="p-4 space-y-3">
-              {organizeDraft.length === 0 ? (
-                <div className="rounded-xl bg-neutral-800 border border-neutral-700 p-4 text-sm text-neutral-400">Sem exercícios para organizar.</div>
-              ) : (
-                <Reorder.Group axis="y" values={organizeDraft} onReorder={setOrganizeDraft} className="space-y-2">
-                  {organizeDraft.map((item, index) => (
-                    <ExerciseSortRow
-                      key={String(item?.key ?? `item-${index}`)}
-                      item={item}
-                      index={index}
-                      total={organizeDraft.length}
-                      onMoveUp={() => setOrganizeDraft((prev) => moveDraftItem(prev, index, index - 1))}
-                      onMoveDown={() => setOrganizeDraft((prev) => moveDraftItem(prev, index, index + 1))}
-                    />
-                  ))}
-                </Reorder.Group>
-              )}
-              {organizeError ? <div className="text-sm text-red-400">{organizeError}</div> : null}
-            </div>
-            <div className="p-4 border-t border-neutral-800 flex gap-2">
-              <button
-                type="button"
-                onClick={requestCloseOrganize}
-                className="flex-1 min-h-[44px] rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-              >
-                Cancelar
-              </button>
-              <button
-                type="button"
-                onClick={saveOrganize}
-                disabled={organizeSaving || !organizeDirty}
-                className={
-                  organizeSaving
-                    ? 'flex-1 min-h-[44px] rounded-xl bg-yellow-500/70 text-black font-black inline-flex items-center justify-center gap-2 cursor-wait'
-                    : !organizeDirty
-                      ? 'flex-1 min-h-[44px] rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-500 font-bold'
-                      : 'flex-1 min-h-[44px] rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400 inline-flex items-center justify-center gap-2'
-                }
-              >
-                {organizeSaving ? <Loader2 size={16} className="animate-spin" /> : <Save size={16} />}
-                <span>Salvar ordem</span>
-              </button>
-            </div>
-          </div>
-        </div>
-      )}
-
-      <div className="flex-1 w-full max-w-6xl mx-auto px-4 md:px-6 py-4 pb-28 space-y-4">
-        {exercises.length === 0 ? (
-          <div className="rounded-xl bg-neutral-800 border border-neutral-700 p-6 text-neutral-300">Sem exercícios neste treino.</div>
-        ) : (
-          exercises.map((ex, exIdx) => renderExercise(ex, exIdx))
-        )}
-      </div>
+import type { FC } from 'react'
+
+export type ActiveWorkoutProps = {
+  session: any
+  user: any
+  settings?: any
+  onUpdateLog?: (exerciseId: any, updates: any) => void
+  onFinish?: (session: any, opts?: any) => void
+  onPersistWorkoutTemplate?: (workout: any) => void
+  onBack?: () => void
+  onStartTimer?: (exerciseId: any, seconds: number) => void
+  isCoach?: boolean
+  onUpdateSession?: (updates: any) => void
+  nextWorkout?: any
+  onEditWorkout?: () => void
+  onAddExercise?: () => void
+}
 
-      <div className="fixed right-4 bottom-24 sm:bottom-6 z-[60]">
-        {timerMinimized ? (
-          <button
-            type="button"
-            onClick={() => setTimerMinimized(false)}
-            className="inline-flex items-center gap-2 rounded-2xl bg-neutral-900/95 border border-neutral-700 px-3 py-2 text-neutral-200 shadow-xl hover:bg-neutral-800"
-          >
-            <Clock size={16} className="text-yellow-500" />
-            <span className="text-xs font-black">Tempo</span>
-            <span className="text-sm font-mono text-yellow-500">{formatElapsed(elapsedSeconds)}</span>
-            <ChevronUp size={16} className="text-neutral-400" />
-          </button>
-        ) : (
-          <div className="w-[240px] rounded-2xl bg-neutral-900/95 border border-neutral-700 p-3 shadow-2xl">
-            <div className="flex items-start justify-between gap-3">
-              <div className="min-w-0">
-                <div className="text-[10px] uppercase tracking-widest text-neutral-500 font-bold">Timer</div>
-                <div className="text-sm font-black text-white truncate">{currentExercise?.name || 'Treino ativo'}</div>
-                <div className="text-[11px] text-neutral-500">Descanso: {currentExercise?.rest ? `${currentExercise.rest}s` : '-'}</div>
-              </div>
-              <button
-                type="button"
-                onClick={() => setTimerMinimized(true)}
-                className="h-8 w-8 inline-flex items-center justify-center rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 hover:bg-neutral-700"
-                aria-label="Minimizar timer"
-              >
-                <ChevronDown size={16} />
-              </button>
-            </div>
-            <div className="mt-3 flex items-center justify-between">
-              <div className="text-2xl font-black text-white font-mono">{formatElapsed(elapsedSeconds)}</div>
-              <div className="text-[10px] uppercase tracking-widest text-yellow-500 font-black">Sessão</div>
-            </div>
-          </div>
-        )}
-      </div>
+import ActiveWorkoutJs from './ActiveWorkout.js'
 
-      <div className="fixed bottom-0 left-0 right-0 z-50 bg-neutral-950/95 backdrop-blur border-t border-neutral-800 px-4 md:px-6 py-3 pb-safe">
-        <div className="max-w-6xl mx-auto flex items-center justify-between gap-2">
-          <button
-            type="button"
-            onClick={async () => {
-              const ok = await confirm('Cancelar treino em andamento? (não salva no histórico)', 'Cancelar');
-              if (!ok) return;
-              try {
-                if (typeof props?.onFinish === 'function') props.onFinish(null, false);
-              } catch {}
-            }}
-            className="inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold hover:bg-neutral-700"
-          >
-            <X size={16} />
-            <span className="text-sm">Cancelar</span>
-          </button>
+const ActiveWorkout = ActiveWorkoutJs as unknown as FC<ActiveWorkoutProps>
 
-          <button
-            type="button"
-            disabled={finishing}
-            onClick={finishWorkout}
-            className={
-              finishing
-                ? 'inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-yellow-500/70 text-black font-black cursor-wait'
-                : 'inline-flex items-center gap-2 px-4 py-3 rounded-xl bg-yellow-500 text-black font-black hover:bg-yellow-400'
-            }
-          >
-            <Save size={16} />
-            <span className="text-sm">Finalizar</span>
-          </button>
-        </div>
-      </div>
-    </div>
-  );
-}
+export default ActiveWorkout
diff --git a/src/components/AdminPanelV2.tsx b/src/components/AdminPanelV2.tsx
index 2189dbd..598d4d9 100644
--- a/src/components/AdminPanelV2.tsx
+++ b/src/components/AdminPanelV2.tsx
@@ -1,5567 +1,12 @@
-"use client";
+import type { FC } from 'react'
 
-import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
-import { useRouter } from 'next/navigation';
-import Image from 'next/image';
-import {
-	Crown, X, UserCog, AlertCircle, Trash2, Megaphone, Plus, Copy, ArrowLeft,
-	MessageSquare, Send, RefreshCw, Dumbbell, Share2, UserPlus, AlertTriangle, Edit3, ShieldAlert,
-		ChevronDown, FileText, Download, History, Search, Play, Video
-} from 'lucide-react';
-import { Bar } from 'react-chartjs-2';
-import {
-	Chart as ChartJS,
-	CategoryScale,
-	LinearScale,
-	BarElement,
-	Tooltip,
-	Legend
-} from 'chart.js';
-import { createClient } from '@/utils/supabase/client';
-import AdminVipReports from './admin/AdminVipReports';
-import AdminWorkoutEditor from './AdminWorkoutEditor';
-import RequestsTab from '@/components/admin/RequestsTab';
-import { workoutPlanHtml } from '@/utils/report/templates';
-import { useDialog } from '@/contexts/DialogContext';
-import { sendBroadcastMessage, clearAllStudents, clearAllTeachers, clearAllWorkouts, deleteTeacher, updateTeacher, addTeacher, exportAllData, importAllData } from '@/actions/admin-actions';
-import { updateWorkout, deleteWorkout } from '@/actions/workout-actions';
-import AssessmentButton from '@/components/assessment/AssessmentButton';
-import HistoryList from '@/components/HistoryList';
-import { normalizeWorkoutTitle, workoutTitleKey } from '@/utils/workoutTitle';
-import { normalizeExerciseName } from '@/utils/normalizeExerciseName';
-import { adminFetchJson } from '@/utils/admin/adminFetch';
+export type AdminPanelV2Props = {
+  user: any
+  onClose?: () => void
+}
 
-const COACH_INBOX_INACTIVE_THRESHOLD_DAYS = 7;
-const COACH_INBOX_DEFAULTS = {
-    churnDays: 7,
-    volumeDropPct: 30,
-    loadSpikePct: 60,
-    minPrev7Volume: 500,
-    minCurrent7VolumeSpike: 800,
-    snoozeDefaultMinutes: 1440,
-};
+import AdminPanelV2Js from './AdminPanelV2.js'
 
-ChartJS.register(CategoryScale, LinearScale, BarElement, Tooltip, Legend);
+const AdminPanelV2 = AdminPanelV2Js as unknown as FC<AdminPanelV2Props>
 
-const AdminPanelV2 = ({ user, onClose }) => {
-    const { alert, confirm, prompt } = useDialog();
-    const supabaseRef = useRef(null);
-    if (!supabaseRef.current) supabaseRef.current = createClient();
-    const supabase = supabaseRef.current;
-    const getAdminAuthHeaders = useCallback(async () => {
-        try {
-            const { data } = await supabase.auth.getSession();
-            const token = data?.session?.access_token || '';
-            if (!token) return {};
-            return { Authorization: `Bearer ${token}` };
-        } catch {
-            return {};
-        }
-    }, [supabase]);
-    
-    // Permission Logic
-    const isAdmin = user?.role === 'admin';
-    const isTeacher = user?.role === 'teacher';
-    const unauthorized = !isAdmin && !isTeacher;
-
-    const getSetsCount = (value) => {
-        if (Array.isArray(value)) return value.length;
-        if (typeof value === 'number') return Number.isFinite(value) ? value : 0;
-        if (typeof value === 'string') {
-            const n = Number(value);
-            return Number.isFinite(n) ? n : 0;
-        }
-        return 0;
-    };
-
-    const escapeHtml = (value) => {
-        try {
-            return String(value ?? '')
-                .replace(/&/g, '&amp;')
-                .replace(/</g, '&lt;')
-                .replace(/>/g, '&gt;')
-                .replace(/"/g, '&quot;')
-                .replace(/'/g, '&#039;');
-        } catch {
-            return '';
-        }
-    };
-
-    const router = useRouter();
-    const executionVideoEnabled = (() => {
-        try {
-            const raw = String(process.env.NEXT_PUBLIC_ENABLE_EXECUTION_VIDEO ?? '').trim().toLowerCase();
-            if (raw === 'false') return false;
-            if (raw === 'true') return true;
-            return true;
-        } catch {
-            return true;
-        }
-    })();
-
-    const [tab, setTab] = useState('dashboard');
-    const [usersList, setUsersList] = useState([]);
-    const [teachersList, setTeachersList] = useState([]);
-    const [selectedTeacher, setSelectedTeacher] = useState(null);
-    const [teacherDetailTab, setTeacherDetailTab] = useState('students');
-    const [teacherStudents, setTeacherStudents] = useState([]);
-    const [teacherStudentsLoading, setTeacherStudentsLoading] = useState(false);
-    const [teacherTemplatesRows, setTeacherTemplatesRows] = useState([]);
-    const [teacherTemplatesLoading, setTeacherTemplatesLoading] = useState(false);
-    const [teacherTemplatesCursor, setTeacherTemplatesCursor] = useState(null);
-    const [teacherHistoryRows, setTeacherHistoryRows] = useState([]);
-    const [teacherHistoryLoading, setTeacherHistoryLoading] = useState(false);
-    const [teacherHistoryCursor, setTeacherHistoryCursor] = useState(null);
-    const [teacherInboxItems, setTeacherInboxItems] = useState([]);
-    const [teacherInboxLoading, setTeacherInboxLoading] = useState(false);
-    const [templates, setTemplates] = useState([]);
-    const [templatesUserId, setTemplatesUserId] = useState('');
-    const [myWorkoutsCount, setMyWorkoutsCount] = useState(0);
-    const [selectedStudent, setSelectedStudent] = useState(null);
-    const [subTab, setSubTab] = useState('workouts');
-    const [studentWorkouts, setStudentWorkouts] = useState([]);
-    const [syncedWorkouts, setSyncedWorkouts] = useState([]);
-    const [assessments, setAssessments] = useState([]);
-    const [editingStudent, setEditingStudent] = useState(false);
-    const [editedStudent, setEditedStudent] = useState({ name: '', email: '' });
-    const [editingTemplate, setEditingTemplate] = useState(null);
-    const [editingStudentWorkout, setEditingStudentWorkout] = useState(null);
-    const [viewWorkout, setViewWorkout] = useState(null);
-    const [exportOpen, setExportOpen] = useState(false);
-    const [historyOpen, setHistoryOpen] = useState(false);
-    const [executionVideos, setExecutionVideos] = useState([]);
-    const [executionVideosLoading, setExecutionVideosLoading] = useState(false);
-    const [executionVideosError, setExecutionVideosError] = useState('');
-    const [executionVideoModalOpen, setExecutionVideoModalOpen] = useState(false);
-    const [executionVideoModalUrl, setExecutionVideoModalUrl] = useState('');
-    const [executionVideoFeedbackDraft, setExecutionVideoFeedbackDraft] = useState({});
-    const [studentCheckinsRange, setStudentCheckinsRange] = useState('7d');
-    const [studentCheckinsFilter, setStudentCheckinsFilter] = useState('all');
-    const [studentCheckinsLoading, setStudentCheckinsLoading] = useState(false);
-    const [studentCheckinsError, setStudentCheckinsError] = useState('');
-    const [studentCheckinsRows, setStudentCheckinsRows] = useState([]);
-    const loadedStudentInfo = useRef(new Set());
-    const [systemExporting, setSystemExporting] = useState(false);
-    const [systemImporting, setSystemImporting] = useState(false);
-    const systemFileInputRef = useRef(null);
-    const [userActivityQuery, setUserActivityQuery] = useState('');
-    const [userActivityRole, setUserActivityRole] = useState('all');
-    const [userActivityUsers, setUserActivityUsers] = useState([]);
-    const [userActivityLoading, setUserActivityLoading] = useState(false);
-    const [userActivityError, setUserActivityError] = useState('');
-    const [userActivitySelected, setUserActivitySelected] = useState(null);
-    const [userActivityDays, setUserActivityDays] = useState(7);
-    const [userActivitySummary, setUserActivitySummary] = useState(null);
-    const [userActivitySummaryLoading, setUserActivitySummaryLoading] = useState(false);
-    const [userActivityEvents, setUserActivityEvents] = useState([]);
-    const [userActivityEventsLoading, setUserActivityEventsLoading] = useState(false);
-    const [userActivityEventsBefore, setUserActivityEventsBefore] = useState(null);
-    const [userActivityErrors, setUserActivityErrors] = useState([]);
-    const [userActivityErrorsLoading, setUserActivityErrorsLoading] = useState(false);
-    const userActivityQueryDebounceRef = useRef(null);
-    const [dangerOpen, setDangerOpen] = useState(false);
-    const [moreTabsOpen, setMoreTabsOpen] = useState(false);
-    const [dangerStudentsConfirm, setDangerStudentsConfirm] = useState('');
-    const [dangerTeachersConfirm, setDangerTeachersConfirm] = useState('');
-    const [dangerWorkoutsConfirm, setDangerWorkoutsConfirm] = useState('');
-    const [dangerActionLoading, setDangerActionLoading] = useState(null);
-
-    const [studentQuery, setStudentQuery] = useState('');
-    const [studentStatusFilter, setStudentStatusFilter] = useState('all');
-    const [teacherQuery, setTeacherQuery] = useState('');
-    const [teacherStatusFilter, setTeacherStatusFilter] = useState('all');
-    const [templateQuery, setTemplateQuery] = useState('');
-
-    const [videoExerciseName, setVideoExerciseName] = useState('');
-    const [videoQueue, setVideoQueue] = useState([]);
-    const [videoLoading, setVideoLoading] = useState(false);
-
-    const [prioritiesItems, setPrioritiesItems] = useState([]);
-    const [prioritiesLoading, setPrioritiesLoading] = useState(false);
-    const [prioritiesError, setPrioritiesError] = useState('');
-    const [prioritiesSettingsOpen, setPrioritiesSettingsOpen] = useState(false);
-    const [prioritiesSettingsLoading, setPrioritiesSettingsLoading] = useState(false);
-    const [prioritiesSettingsError, setPrioritiesSettingsError] = useState('');
-    const [prioritiesSettings, setPrioritiesSettings] = useState(() => ({ ...COACH_INBOX_DEFAULTS }));
-    const prioritiesSettingsPrefRef = useRef(null);
-    const [prioritiesComposeOpen, setPrioritiesComposeOpen] = useState(false);
-    const [prioritiesComposeStudentId, setPrioritiesComposeStudentId] = useState('');
-    const [prioritiesComposeKind, setPrioritiesComposeKind] = useState('');
-    const [prioritiesComposeText, setPrioritiesComposeText] = useState('');
-    const [videoBackfillLimit, setVideoBackfillLimit] = useState('20');
-    const [videoMissingCount, setVideoMissingCount] = useState(null);
-    const [videoMissingLoading, setVideoMissingLoading] = useState(false);
-    const [videoCycleRunning, setVideoCycleRunning] = useState(false);
-    const [videoCycleStats, setVideoCycleStats] = useState({ processed: 0, created: 0, skipped: 0 });
-    const videoCycleStopRef = useRef(false);
-
-    const [errorReports, setErrorReports] = useState([]);
-    const [errorsLoading, setErrorsLoading] = useState(false);
-    const [errorsQuery, setErrorsQuery] = useState('');
-    const [errorsStatusFilter, setErrorsStatusFilter] = useState('all');
-
-    const [exerciseAliasesReview, setExerciseAliasesReview] = useState([]);
-    const [exerciseAliasesLoading, setExerciseAliasesLoading] = useState(false);
-    const [exerciseAliasesError, setExerciseAliasesError] = useState('');
-    const [exerciseAliasesBackfillLoading, setExerciseAliasesBackfillLoading] = useState(false);
-    const [exerciseAliasesNotice, setExerciseAliasesNotice] = useState('');
-
-    useEffect(() => {
-        if (unauthorized) onClose && onClose();
-    }, [unauthorized, onClose]);
-
-    useEffect(() => {
-        if (!moreTabsOpen) return;
-        const onKeyDown = (e) => {
-            if (e?.key === 'Escape') setMoreTabsOpen(false);
-        };
-        window.addEventListener('keydown', onKeyDown);
-        return () => window.removeEventListener('keydown', onKeyDown);
-    }, [moreTabsOpen]);
-
-    const normalizeText = useCallback((value) => String(value || '').toLowerCase(), []);
-
-    const statusMatches = useCallback((rowStatus, selected) => {
-        if (!selected || selected === 'all') return true;
-        return normalizeText(rowStatus) === normalizeText(selected);
-    }, [normalizeText]);
-
-    const studentMatchesQuery = useCallback((s) => {
-        const q = normalizeText(studentQuery).trim();
-        if (!q) return true;
-        return normalizeText(s?.name).includes(q) || normalizeText(s?.email).includes(q);
-    }, [normalizeText, studentQuery]);
-
-    const teacherMatchesQuery = useCallback((t) => {
-        const q = normalizeText(teacherQuery).trim();
-        if (!q) return true;
-        return normalizeText(t?.name).includes(q) || normalizeText(t?.email).includes(q);
-    }, [normalizeText, teacherQuery]);
-
-    const templateMatchesQuery = useCallback((t) => {
-        const q = normalizeText(templateQuery).trim();
-        if (!q) return true;
-        return normalizeText(t?.name).includes(q);
-    }, [normalizeText, templateQuery]);
-
-    const studentsWithTeacherFiltered = useMemo(() => {
-        const list = Array.isArray(usersList) ? usersList : [];
-        return list
-            .filter((s) => !!s?.teacher_id)
-            .filter(studentMatchesQuery)
-            .filter((s) => statusMatches(s?.status || 'pendente', studentStatusFilter));
-    }, [studentStatusFilter, studentMatchesQuery, statusMatches, usersList]);
-
-    const studentsWithoutTeacherFiltered = useMemo(() => {
-        const list = Array.isArray(usersList) ? usersList : [];
-        return list
-            .filter((s) => !s?.teacher_id)
-            .filter(studentMatchesQuery)
-            .filter((s) => statusMatches(s?.status || 'pendente', studentStatusFilter));
-    }, [studentStatusFilter, studentMatchesQuery, statusMatches, usersList]);
-
-	const teachersFiltered = useMemo(() => {
-		const list = Array.isArray(teachersList) ? teachersList : [];
-		return list
-			.filter(teacherMatchesQuery)
-			.filter((t) => statusMatches(t?.status || 'pendente', teacherStatusFilter));
-	}, [statusMatches, teacherMatchesQuery, teacherStatusFilter, teachersList]);
-
-	const templatesFiltered = useMemo(() => {
-		const list = Array.isArray(templates) ? templates : [];
-		return list.filter(templateMatchesQuery);
-	}, [templateMatchesQuery, templates]);
-
-    const errorsFiltered = useMemo(() => {
-        const list = Array.isArray(errorReports) ? errorReports : [];
-        const q = normalizeText(errorsQuery).trim();
-        return list
-            .filter((r) => {
-                if (!errorsStatusFilter || errorsStatusFilter === 'all') return true;
-                return normalizeText(r?.status || '') === normalizeText(errorsStatusFilter);
-            })
-            .filter((r) => {
-                if (!q) return true;
-                const msg = normalizeText(r?.message || '');
-                const email = normalizeText(r?.user_email || r?.userEmail || '');
-                const path = normalizeText(r?.pathname || '');
-                return msg.includes(q) || email.includes(q) || path.includes(q);
-            });
-    }, [errorReports, errorsQuery, errorsStatusFilter, normalizeText]);
-
-	const coachInboxItems = useMemo(() => {
-		if (!isTeacher) return [];
-		const list = Array.isArray(usersList) ? usersList : [];
-        const today = new Date();
-        const todayMs = today.getTime();
-        if (!Number.isFinite(todayMs)) return [];
-
-        const safeDays = (value) => {
-            const n = Number(value);
-            if (!Number.isFinite(n) || n < 0) return 0;
-            return n;
-        };
-
-        const items = list
-            .filter((s) => s && typeof s === 'object' && s.teacher_id === user?.id)
-            .map((s) => {
-                const workouts = Array.isArray(s.workouts) ? s.workouts : [];
-                const nonTemplate = workouts.filter((w) => w && typeof w === 'object' && w.is_template !== true);
-
-                if (!nonTemplate.length) {
-                    return {
-                        id: s.id,
-                        name: s.name || s.email || '',
-                        email: s.email || '',
-                        status: s.status || 'pendente',
-                        hasWorkouts: false,
-                        daysSinceLastWorkout: null,
-                    };
-                }
-
-                let lastWorkoutMs = 0;
-                nonTemplate.forEach((w) => {
-                    try {
-                        const raw = w.date || w.completed_at || w.created_at;
-                        if (!raw) return;
-                        const d = raw?.toDate ? raw.toDate() : new Date(raw);
-                        const t = d?.getTime ? d.getTime() : NaN;
-                        if (!Number.isFinite(t)) return;
-                        if (t > lastWorkoutMs) lastWorkoutMs = t;
-                    } catch {}
-                });
-
-                if (!lastWorkoutMs) {
-                    return {
-                        id: s.id,
-                        name: s.name || s.email || '',
-                        email: s.email || '',
-                        status: s.status || 'pendente',
-                        hasWorkouts: false,
-                        daysSinceLastWorkout: null,
-                    };
-                }
-
-                const diffMs = todayMs - lastWorkoutMs;
-                const days = diffMs > 0 ? Math.floor(diffMs / (1000 * 60 * 60 * 24)) : 0;
-
-                return {
-                    id: s.id,
-                    name: s.name || s.email || '',
-                    email: s.email || '',
-                    status: s.status || 'pendente',
-                    hasWorkouts: true,
-                    daysSinceLastWorkout: days,
-                };
-            })
-            .filter((item) => item && typeof item === 'object')
-            .filter((item) => {
-                if (!item.hasWorkouts) return true;
-                const days = safeDays(item.daysSinceLastWorkout);
-                return days >= COACH_INBOX_INACTIVE_THRESHOLD_DAYS;
-            });
-
-        items.sort((a, b) => {
-            const aDays = a.hasWorkouts ? safeDays(a.daysSinceLastWorkout) : Number.MAX_SAFE_INTEGER;
-            const bDays = b.hasWorkouts ? safeDays(b.daysSinceLastWorkout) : Number.MAX_SAFE_INTEGER;
-            return bDays - aDays;
-        });
-
-        return items.slice(0, 5);
-	}, [isTeacher, usersList, user?.id]);
-
-    useEffect(() => {
-        if (!selectedStudent) setHistoryOpen(false);
-    }, [selectedStudent]);
-
-    useEffect(() => {
-        if (selectedStudent) setSelectedTeacher(null);
-    }, [selectedStudent]);
-
-    const handleExportSystem = async () => {
-        try {
-            setSystemExporting(true);
-            const res = await exportAllData();
-            if (res?.error) throw new Error(res.error);
-            const json = JSON.stringify(res.data || {}, null, 2);
-            const blob = new Blob([json], { type: 'application/json' });
-            const url = URL.createObjectURL(blob);
-            const a = document.createElement('a');
-            a.href = url;
-            a.download = `irontracks_full_backup_${new Date().toISOString()}.json`;
-            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        } catch (e) {
-            await alert('Erro ao exportar: ' + (e?.message ?? String(e)));
-        } finally {
-            setSystemExporting(false);
-        }
-    };
-
-    const handleImportSystemClick = () => {
-        systemFileInputRef.current?.click();
-    };
-
-    const handleImportSystem = async (e) => {
-        const file = e.target.files?.[0];
-        if (!file) return;
-        try {
-            setSystemImporting(true);
-            const text = await file.text();
-            const data = JSON.parse(text);
-            if (!(await confirm('Importar backup completo do sistema?', 'Importar Backup'))) return;
-            const res = await importAllData(data);
-            if (res?.error) throw new Error(res.error);
-            await alert('Backup importado com sucesso!');
-        } catch (err) {
-            await alert('Erro ao importar: ' + (err?.message ?? String(err)));
-        } finally {
-            setSystemImporting(false);
-            if (e?.target) e.target.value = '';
-        }
-    };
-
-    const handleExportPdf = async () => {
-        try {
-            const safeWorkout = {
-                title: escapeHtml(viewWorkout?.name || ''),
-                exercises: (Array.isArray(viewWorkout?.exercises) ? viewWorkout.exercises : []).map(ex => ({
-                    name: escapeHtml(ex?.name),
-                    sets: getSetsCount(ex?.sets),
-                    reps: escapeHtml(ex?.reps ?? '10'),
-                    rpe: escapeHtml(ex?.rpe ?? 8),
-                    cadence: escapeHtml(ex?.cadence || '2020'),
-                    restTime: escapeHtml(ex?.rest_time ?? ex?.restTime),
-                    method: escapeHtml(ex?.method),
-                    notes: escapeHtml(ex?.notes)
-                }))
-            };
-            const baseUser = user && typeof user === 'object' ? user : {};
-            const safeUser = {
-                ...baseUser,
-                displayName: escapeHtml(baseUser.displayName ?? baseUser.name ?? ''),
-                name: escapeHtml(baseUser.name ?? baseUser.displayName ?? ''),
-                email: escapeHtml(baseUser.email ?? '')
-            };
-            const html = workoutPlanHtml(safeWorkout, safeUser);
-            const win = window.open('', '_blank');
-            if (!win) return;
-            win.document.open();
-            win.document.write(html);
-            win.document.close();
-            win.focus();
-            setTimeout(() => { try { win.print(); } catch {} }, 300);
-            setExportOpen(false);
-        } catch (e) {
-            await alert('Erro ao gerar PDF: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleExportJson = () => {
-        const json = JSON.stringify({
-            workout: {
-                title: viewWorkout.name,
-                exercises: (viewWorkout.exercises || []).map(ex => ({
-                    name: ex.name,
-                    sets: getSetsCount(ex?.sets),
-                    reps: ex.reps,
-                    rpe: ex.rpe,
-                    cadence: ex.cadence,
-                    restTime: ex.rest_time ?? ex.restTime,
-                    method: ex.method,
-                    videoUrl: ex.video_url || ex.videoUrl,
-                    notes: ex.notes
-                }))
-            }
-        }, null, 2);
-        const blob = new Blob([json], { type: 'application/json' });
-        const url = URL.createObjectURL(blob);
-        const a = document.createElement('a');
-        a.href = url;
-        a.download = `${(viewWorkout.name || 'treino').replace(/\s+/g,'_')}.json`;
-        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
-        setExportOpen(false);
-    };
-
-    const openEditWorkout = (e, w) => {
-        e?.stopPropagation?.();
-        setEditingStudentWorkout({
-            id: w.id,
-            title: w.name,
-            exercises: (w.exercises || []).map(ex => ({
-                name: ex.name || '',
-                sets: getSetsCount(ex?.sets) || 4,
-                reps: ex.reps ?? '10',
-                rpe: ex.rpe ?? 8,
-                cadence: ex.cadence || '2020',
-                restTime: ex.rest_time ?? 60,
-                method: ex.method || 'Normal',
-                videoUrl: ex.video_url || '',
-                notes: ex.notes || ''
-            }))
-        });
-    };
-
-    const openEditTemplate = (t) => {
-        setEditingTemplate({
-            id: t.id,
-            title: t.name,
-            exercises: (t.exercises || []).map(ex => ({
-                name: ex.name || '',
-                sets: getSetsCount(ex?.sets) || 4,
-                reps: ex.reps ?? '10',
-                rpe: ex.rpe ?? 8,
-                cadence: ex.cadence || '2020',
-                restTime: ex.rest_time ?? 60,
-                method: ex.method || 'Normal',
-                videoUrl: ex.video_url || '',
-                notes: ex.notes || ''
-            }))
-        });
-    };
-    const [loading, setLoading] = useState(false);
-
-    const [showRegisterModal, setShowRegisterModal] = useState(false);
-    const [newStudent, setNewStudent] = useState({ name: '', email: '' });
-    const [registering, setRegistering] = useState(false);
-
-    const [broadcastMsg, setBroadcastMsg] = useState('');
-    const [broadcastTitle, setBroadcastTitle] = useState('');
-    const [sendingBroadcast, setSendingBroadcast] = useState(false);
-
-    const [showTeacherModal, setShowTeacherModal] = useState(false);
-    const [newTeacher, setNewTeacher] = useState({ name: '', email: '', phone: '', birth_date: '' });
-    const [addingTeacher, setAddingTeacher] = useState(false);
-    const [editingTeacher, setEditingTeacher] = useState(null); // For edit modal/state
-
-    // DIAGNOSTIC MODE: Connection Test
-    const [debugError, setDebugError] = useState(null);
-
-    useEffect(() => {
-        const testConnection = async () => {
-            try {
-                // AÇÃO 2: Teste agressivo sem filtros
-                const { data, error } = await supabase.from('workouts').select('*').limit(1);
-                
-                if (error) {
-                    console.error("ERRO CRÍTICO SUPABASE:", error);
-                    setDebugError("Erro Supabase: " + error.message + " | Detalhes: " + JSON.stringify(error));
-                } else if (!data || data.length === 0) {
-                    // Se não retornar nada, pode ser RLS ou tabela vazia, mas a conexão funcionou
-                    // setDebugError("Conexão OK, mas tabela vazia ou bloqueada por RLS.");
-                    console.log("Conexão OK (tabela vazia ou RLS)");
-                } else {
-                    console.log("Conexão OK (dados encontrados)");
-                }
-            } catch (e) {
-                console.error("ERRO DE CONEXÃO/FETCH:", e);
-                setDebugError("Erro Catch: " + (e?.message ?? String(e)));
-            }
-        };
-        testConnection();
-    }, [supabase]);
-
-    useEffect(() => {
-        const fetchStudents = async () => {
-            setLoading(true);
-            const { data: { user: currentUser } } = await supabase.auth.getUser();
-            if (!currentUser) { setLoading(false); return; }
-            try {
-                let list = [];
-                if (isAdmin) {
-                    const authHeaders = await getAdminAuthHeaders();
-                    const json = await adminFetchJson(supabase, '/api/admin/students/list');
-                    if (json?.ok) list = json.students || [];
-
-                    const legacyJson = await adminFetchJson(supabase, '/api/admin/legacy-students');
-                    if (legacyJson?.ok && legacyJson.students) {
-                        const existingIds = new Set(list.map(s => s.user_id || s.id));
-                        const newLegacy = legacyJson.students.filter(s => !existingIds.has(s.id));
-                        list = [...list, ...newLegacy];
-
-                        // Dedup by email, prefer entries that already have teacher_id
-                        const byEmail = new Map();
-                        for (const s of (list || [])) {
-                            const key = (s.email || '').toLowerCase();
-                            const prev = byEmail.get(key);
-                            if (!prev || (!!s.teacher_id && !prev.teacher_id)) {
-                                byEmail.set(key, s);
-                            }
-                        }
-                        list = Array.from(byEmail.values());
-                    }
-                    if (list.length === 0) {
-                        const { data: profiles } = await supabase
-                            .from('profiles')
-                            .select('id, display_name, email, role')
-                            .neq('role', 'teacher')
-                            .order('display_name');
-                        // Fetch teachers via admin API to exclude
-                        let teacherEmails = new Set();
-                        try {
-                            const tJson = await adminFetchJson(supabase, '/api/admin/teachers/list');
-                            if (tJson?.ok) teacherEmails = new Set((tJson.teachers || []).map(t => (t.email || '').toLowerCase()));
-                        } catch {}
-                        list = (profiles || [])
-                            .filter(p => !p.email || !teacherEmails.has(p.email.toLowerCase()))
-                            .map(p => ({ id: p.id, name: p.display_name, email: p.email, teacher_id: null, user_id: p.id }));
-                        // FINAL FALLBACK: students table (teacher/created_by), same do branch não-admin
-                        if ((list || []).length === 0) {
-                            let query = supabase
-                                .from('students')
-                                .select('*, workouts(*)')
-                                .order('name');
-                            const uid = currentUser?.id ? String(currentUser.id) : '';
-                            if (uid) query = query.or(`teacher_id.eq.${uid},user_id.eq.${uid}`);
-                            const { data: studentsData } = await query;
-                            list = (studentsData || []).filter(s => (s.email || '').toLowerCase() !== (currentUser.email || '').toLowerCase());
-                        }
-                    }
-                    // Extra client-side filter: exclude teachers
-                    const { data: tList } = await supabase.from('teachers').select('id, name, email, user_id');
-                    const tEmails = new Set((tList || []).map(t => (t.email || '').toLowerCase()));
-                    const filtered = (list || []).filter(s => {
-                        const email = (s.email || '').toLowerCase();
-                        const uid = s.user_id || s.id;
-                        if (email && tEmails.has(email)) return false;
-                        return true;
-                    });
-                    // Overlay cached teacher assignment by email to ensure UI reflects recent changes
-                    try {
-                        list = (filtered || []).map(s => {
-                            const key = 'student_teacher_' + (s.email || '');
-                            let tid = null;
-                            try { tid = localStorage.getItem(key) || null; } catch {}
-                            return tid && !s.teacher_id ? { ...s, teacher_id: tid } : s;
-                        });
-                    } catch { list = filtered; }
-                    // Ensure dropdown has teachers (enriched with profiles.id mapping)
-                    if (teachersList.length === 0) {
-                        let jsonT = null;
-                        try {
-                            jsonT = await adminFetchJson(supabase, '/api/admin/teachers/list');
-                        } catch {}
-                        if (jsonT?.ok) {
-                            const base = jsonT.teachers || [];
-                            try {
-                                const emails = base.map(t => t.email).filter(Boolean);
-                                if (emails.length > 0) {
-                                    const { data: profilesMap } = await supabase
-                                        .from('profiles')
-                                        .select('id, email')
-                                        .in('email', emails);
-                                    const idByEmail = new Map((profilesMap || []).map(p => [p.email, p.id]));
-                                    const enriched = base.map(t => ({ ...t, user_id: idByEmail.get(t.email) || null }));
-                                    // Ensure currently assigned teacher appears in dropdown
-                                    if (selectedStudent?.teacher_id && !enriched.some(t => t.user_id === selectedStudent.teacher_id)) {
-                                        const { data: curProfile } = await supabase
-                                            .from('profiles')
-                                            .select('id, display_name, email')
-                                            .eq('id', selectedStudent.teacher_id)
-                                            .maybeSingle();
-                                        if (curProfile) enriched.unshift({ id: curProfile.id, name: curProfile.display_name, email: curProfile.email, user_id: curProfile.id, status: 'active' })
-                                    }
-                                    setTeachersList(enriched);
-                                } else {
-                                    setTeachersList(base);
-                                }
-                            } catch { setTeachersList(base); }
-                        }
-                    }
-                } else {
-                    let query = supabase
-                        .from('students')
-                        .select('*, workouts(*)')
-                        .order('name');
-                    const uid = currentUser?.id ? String(currentUser.id) : '';
-                    if (uid) query = query.or(`teacher_id.eq.${uid},user_id.eq.${uid}`);
-                    const { data: studentsData } = await query;
-                    list = (studentsData || []).filter(s => (s.email || '').toLowerCase() !== (currentUser.email || '').toLowerCase());
-                    // Overlay cached teacher assignment by email to ensure UI reflects recent changes
-                    try {
-                        list = (list || []).map(s => {
-                            const key = 'student_teacher_' + (s.email || '');
-                            let tid = null;
-                            try { tid = localStorage.getItem(key) || null; } catch {}
-                            return tid && !s.teacher_id ? { ...s, teacher_id: tid } : s;
-                        });
-                    } catch {}
-                }
-                setUsersList(list || []);
-            } finally { setLoading(false); }
-        };
-        fetchStudents();
-    }, [registering, isAdmin, supabase, selectedStudent?.teacher_id, teachersList.length, getAdminAuthHeaders]);
-
-    useEffect(() => {
-        if (tab === 'teachers' && isAdmin) {
-            const fetchTeachers = async () => {
-                const authHeaders = await getAdminAuthHeaders();
-                let json = null;
-                try {
-                    const res = await fetch('/api/admin/teachers/list', { headers: authHeaders });
-                    const raw = await res.text();
-                    json = raw ? JSON.parse(raw) : null;
-                } catch {}
-                if (json?.ok) {
-                    const list = json.teachers || [];
-                    const dedup = [];
-                    const seen = new Set();
-                    for (const t of list) {
-                        const key = (t.email || '').toLowerCase();
-                        if (!seen.has(key)) { seen.add(key); dedup.push(t); }
-                    }
-                    try {
-                        const emails = dedup.map(t => t.email).filter(Boolean);
-                        if (emails.length > 0) {
-                            const { data: profilesMap } = await supabase
-                                .from('profiles')
-                                .select('id, email')
-                                .in('email', emails);
-                            const idByEmail = new Map((profilesMap || []).map(p => [p.email, p.id]));
-                            const enriched = dedup.map(t => ({ ...t, user_id: idByEmail.get(t.email) || null }));
-                            setTeachersList(enriched);
-                        } else {
-                            setTeachersList(dedup);
-                        }
-                    } catch {
-                        setTeachersList(dedup);
-                    }
-                }
-            };
-            fetchTeachers();
-        }
-    }, [tab, isAdmin, addingTeacher, editingTeacher, supabase, getAdminAuthHeaders]);
-
-    const loadTeacherStudents = useCallback(async (teacher) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherStudents([]); return; }
-        setTeacherStudentsLoading(true);
-        try {
-            const authHeaders = await getAdminAuthHeaders();
-            const res = await fetch(`/api/admin/teachers/students?teacher_user_id=${encodeURIComponent(uid)}`, { headers: authHeaders });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) { setTeacherStudents([]); return; }
-            setTeacherStudents(Array.isArray(json.students) ? json.students : []);
-        } finally {
-            setTeacherStudentsLoading(false);
-        }
-    }, [getAdminAuthHeaders]);
-
-    const loadTeacherTemplates = useCallback(async (teacher, reset = false) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherTemplatesRows([]); setTeacherTemplatesCursor(null); return; }
-        if (reset) { setTeacherTemplatesRows([]); setTeacherTemplatesCursor(null); }
-        setTeacherTemplatesLoading(true);
-        try {
-            const cursor = reset ? '' : String(teacherTemplatesCursor || '');
-            const qs = new URLSearchParams({ teacher_user_id: uid, limit: '80' });
-            if (cursor) qs.set('cursor', cursor);
-            const authHeaders = await getAdminAuthHeaders();
-            const res = await fetch(`/api/admin/teachers/workouts/templates?${qs.toString()}`, { headers: authHeaders });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return;
-            const rows = Array.isArray(json.rows) ? json.rows : [];
-            setTeacherTemplatesRows((prev) => reset ? rows : [...(Array.isArray(prev) ? prev : []), ...rows]);
-            setTeacherTemplatesCursor(json.next_cursor || null);
-        } finally {
-            setTeacherTemplatesLoading(false);
-        }
-    }, [teacherTemplatesCursor, getAdminAuthHeaders]);
-
-    const loadTeacherHistory = useCallback(async (teacher, reset = false) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherHistoryRows([]); setTeacherHistoryCursor(null); return; }
-        if (reset) { setTeacherHistoryRows([]); setTeacherHistoryCursor(null); }
-        setTeacherHistoryLoading(true);
-        try {
-            const qs = new URLSearchParams({ teacher_user_id: uid, limit: '80' });
-            const cur = reset ? null : teacherHistoryCursor;
-            if (cur?.cursor_date) qs.set('cursor_date', String(cur.cursor_date));
-            if (cur?.cursor_created_at) qs.set('cursor_created_at', String(cur.cursor_created_at));
-            const authHeaders = await getAdminAuthHeaders();
-            const res = await fetch(`/api/admin/teachers/workouts/history?${qs.toString()}`, { headers: authHeaders });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) return;
-            const rows = Array.isArray(json.rows) ? json.rows : [];
-            setTeacherHistoryRows((prev) => reset ? rows : [...(Array.isArray(prev) ? prev : []), ...rows]);
-            setTeacherHistoryCursor(json.next_cursor || null);
-        } finally {
-            setTeacherHistoryLoading(false);
-        }
-    }, [teacherHistoryCursor, getAdminAuthHeaders]);
-
-    const loadTeacherInbox = useCallback(async (teacher) => {
-        const uid = String(teacher?.user_id || '').trim();
-        if (!uid) { setTeacherInboxItems([]); return; }
-        setTeacherInboxLoading(true);
-        try {
-            const authHeaders = await getAdminAuthHeaders();
-            const res = await fetch(`/api/admin/teachers/inbox?teacher_user_id=${encodeURIComponent(uid)}&limit=80`, { headers: authHeaders });
-            const json = await res.json().catch(() => ({}));
-            if (!json?.ok) { setTeacherInboxItems([]); return; }
-            setTeacherInboxItems(Array.isArray(json.items) ? json.items : []);
-        } finally {
-            setTeacherInboxLoading(false);
-        }
-    }, [getAdminAuthHeaders]);
-
-    useEffect(() => {
-        if (!selectedTeacher || !isAdmin) return;
-        setTeacherDetailTab('students');
-        setTeacherTemplatesRows([]);
-        setTeacherTemplatesCursor(null);
-        setTeacherHistoryRows([]);
-        setTeacherHistoryCursor(null);
-        setTeacherInboxItems([]);
-        loadTeacherStudents(selectedTeacher).catch(() => {});
-    }, [isAdmin, loadTeacherStudents, selectedTeacher]);
-
-    useEffect(() => {
-        if (!selectedTeacher || !isAdmin) return;
-        if (teacherDetailTab === 'templates' && teacherTemplatesRows.length === 0) loadTeacherTemplates(selectedTeacher, true).catch(() => {});
-        if (teacherDetailTab === 'history' && teacherHistoryRows.length === 0) loadTeacherHistory(selectedTeacher, true).catch(() => {});
-        if (teacherDetailTab === 'inbox' && teacherInboxItems.length === 0) loadTeacherInbox(selectedTeacher).catch(() => {});
-    }, [isAdmin, loadTeacherHistory, loadTeacherInbox, loadTeacherTemplates, selectedTeacher, teacherDetailTab, teacherHistoryRows.length, teacherInboxItems.length, teacherTemplatesRows.length]);
-
-    // URL Persistence for Tabs (Fixed)
-    useEffect(() => {
-       if (typeof window === 'undefined') return;
-       const sp = new URLSearchParams(window.location.search);
-       const t = sp.get('tab');
-       // Only restore if valid tab, otherwise default to dashboard
-       if (t && ['dashboard','students','teachers','templates','videos','broadcast','system'].includes(t)) {
-           setTab(t);
-       }
-    }, []);
-
-    useEffect(() => {
-       if (typeof window === 'undefined') return;
-       const sp = new URLSearchParams(window.location.search);
-       if (sp.get('tab') !== tab) {
-           sp.set('tab', tab);
-           // Use replaceState to avoid cluttering history, unless user wants back button support
-           // Here we use replaceState to just keep URL in sync
-           const url = `${window.location.pathname}?${sp.toString()}`;
-           window.history.replaceState(null, '', url);
-       }
-       try {
-           sessionStorage.setItem('irontracks_admin_panel_open', '1');
-           sessionStorage.setItem('irontracks_admin_panel_tab', String(tab || 'dashboard'));
-       } catch {}
-    }, [tab]);
-
-    useEffect(() => {
-        if (tab !== 'templates') return;
-        const fetchTemplates = async () => {
-            try {
-                const { data: { user: currentUser } } = await supabase.auth.getUser();
-                if (!currentUser) return;
-                setTemplatesUserId(currentUser.id || '');
-                let list = [];
-                if (isAdmin || isTeacher) {
-                    try {
-                        const authHeaders = await getAdminAuthHeaders();
-                        const res = await fetch('/api/admin/workouts/mine', { headers: authHeaders });
-                        const json = await res.json();
-                        if (json.ok) {
-                            list = (json.rows || []).filter((w) => w?.is_template === true && w?.user_id === currentUser.id);
-                        }
-                    } catch (e) { console.error("API fetch error", e); }
-
-                    if ((list || []).length === 0) {
-                        try {
-                            const { data } = await supabase
-                                .from('workouts')
-                                .select('*, exercises(*, sets(*))')
-                                .eq('is_template', true)
-                                .eq('user_id', currentUser.id)
-                                .order('name');
-                            list = (data || []).filter((w) => w?.is_template === true && w?.user_id === currentUser.id);
-                        } catch (e) { console.error("Supabase fetch error", e); }
-                    }
-                } else {
-                    try {
-                        const { data } = await supabase
-                            .from('workouts')
-                            .select('*, exercises(*, sets(*))')
-                            .eq('is_template', true)
-                            .eq('user_id', currentUser.id)
-                            .order('name');
-                        list = data || [];
-                    } catch (e) { console.error("Supabase fetch error", e); }
-                }
-                try {
-                    const resLegacy = await fetch('/api/workouts/list');
-                    const jsonLegacy = await resLegacy.json();
-                    if (jsonLegacy.ok) {
-                        const legacy = (jsonLegacy.rows || []).map(w => ({ id: w.id || w.uuid, name: w.name, exercises: [] }));
-                        list = [...list, ...legacy];
-                    }
-                } catch {}
-                // Deduplicar por título, priorizando treinos completos (maior número de exercícios)
-                const score = (w) => {
-                    const exs = Array.isArray(w.exercises) ? w.exercises : [];
-                    const exCount = exs.length;
-                    return exCount;
-                };
-                const byTitle = new Map();
-                for (const w of (list || [])) {
-                    if (!w || !w.name) continue; // Defensive check
-                    try {
-                        const key = workoutTitleKey(w.name);
-                        const prev = byTitle.get(key);
-                        const curHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(w?.name || ''));
-                        const prevHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(prev?.name || ''));
-                        if (
-                            !prev
-                            || score(w) > score(prev)
-                            || (score(w) === score(prev) && curHasPrefix && !prevHasPrefix)
-                            || (score(w) === score(prev) && !!w.is_template && !prev.is_template)
-                        ) {
-                            byTitle.set(key, w);
-                        }
-                    } catch (e) { console.error("Error processing workout", w, e); }
-                }
-                const deduped = Array.from(byTitle.values())
-                    .map((w) => ({ ...w, name: normalizeWorkoutTitle(w?.name || '') }))
-                    .sort((a,b) => (a.name||'').localeCompare(b.name||''));
-                setTemplates(deduped || []);
-            } catch (err) {
-                console.error("Critical error fetching templates", err);
-            }
-        };
-        fetchTemplates();
-    }, [tab, isAdmin, isTeacher, supabase, getAdminAuthHeaders]);
-
-    useEffect(() => {
-        if (tab !== 'videos' || !isAdmin) return;
-        const normalizeExercise = (value) => {
-            const s = String(value || '').trim().toLowerCase();
-            if (!s) return '';
-            return s
-                .normalize('NFD')
-                .replace(/[\u0300-\u036f]/g, '')
-                .replace(/[^a-z0-9]+/g, ' ')
-                .trim()
-                .replace(/\s+/g, ' ');
-        };
-
-        const fetchMissing = async () => {
-            setVideoMissingLoading(true);
-            try {
-                const { data: rows, error } = await supabase
-                    .from('exercises')
-                    .select('name, video_url')
-                    .or('video_url.is.null,video_url.eq.')
-                    .limit(2000);
-
-                if (error) throw error;
-
-                const normalized = new Set();
-                for (const r of (rows || [])) {
-                    const name = String(r?.name || '').trim();
-                    if (!name) continue;
-                    const n = normalizeExercise(name);
-                    if (!n) continue;
-                    normalized.add(n);
-                    if (normalized.size >= 1000) break;
-                }
-
-                const normalizedList = Array.from(normalized);
-                if (!normalizedList.length) {
-                    setVideoMissingCount(0);
-                    return;
-                }
-
-                const { data: libRows } = await supabase
-                    .from('exercise_library')
-                    .select('normalized_name, video_url')
-                    .in('normalized_name', normalizedList)
-                    .limit(normalizedList.length);
-
-                const withVideo = new Set(
-                    (libRows || [])
-                        .filter((x) => !!String(x?.video_url || '').trim())
-                        .map((x) => String(x?.normalized_name || '').trim())
-                        .filter(Boolean)
-                );
-
-                let missing = 0;
-                for (const n of normalizedList) {
-                    if (!withVideo.has(n)) missing += 1;
-                }
-                setVideoMissingCount(missing);
-            } catch {
-                setVideoMissingCount(null);
-            } finally {
-                setVideoMissingLoading(false);
-            }
-        };
-
-        const fetchVideos = async () => {
-            setVideoLoading(true);
-            try {
-                const { data, error } = await supabase
-                    .from('exercise_videos')
-                    .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                    .eq('status', 'pending')
-                    .order('created_at', { ascending: false })
-                    .limit(60);
-                if (!error) setVideoQueue(data || []);
-            } catch {
-                setVideoQueue([]);
-            } finally {
-                setVideoLoading(false);
-            }
-        };
-        fetchVideos();
-        fetchMissing();
-    }, [tab, isAdmin, supabase]);
-
-    useEffect(() => {
-        if (tab !== 'errors' || !isAdmin) return;
-        let cancelled = false;
-        const fetchErrors = async () => {
-            setErrorsLoading(true);
-            try {
-                const { data, error } = await supabase
-                    .from('error_reports')
-                    .select('id, user_id, user_email, message, stack, pathname, url, user_agent, app_version, source, meta, status, created_at, updated_at, resolved_at, resolved_by')
-                    .order('created_at', { ascending: false })
-                    .limit(200);
-                if (cancelled) return;
-                if (error) {
-                    setErrorReports([]);
-                    return;
-                }
-                setErrorReports(Array.isArray(data) ? data : []);
-            } catch {
-                if (!cancelled) setErrorReports([]);
-            } finally {
-                if (!cancelled) setErrorsLoading(false);
-            }
-        };
-        fetchErrors();
-        return () => {
-            cancelled = true;
-        };
-    }, [tab, isAdmin, supabase]);
-
-    useEffect(() => {
-        if (tab !== 'system' || !isAdmin) return;
-        let cancelled = false;
-        const fetchAliases = async () => {
-            setExerciseAliasesLoading(true);
-            setExerciseAliasesError('');
-            try {
-                const { data, error } = await supabase
-                    .from('exercise_aliases')
-                    .select('id, user_id, canonical_id, alias, normalized_alias, confidence, source, needs_review, created_at, updated_at')
-                    .eq('needs_review', true)
-                    .order('created_at', { ascending: false })
-                    .limit(200);
-                if (cancelled) return;
-                if (error) {
-                    setExerciseAliasesReview([]);
-                    const msg = String(error?.message || '');
-                    if (msg) setExerciseAliasesError(msg);
-                    return;
-                }
-                setExerciseAliasesReview(Array.isArray(data) ? data : []);
-            } catch (e) {
-                if (!cancelled) {
-                    setExerciseAliasesReview([]);
-                    const msg = e?.message ? String(e.message) : '';
-                    if (msg) setExerciseAliasesError(msg);
-                }
-            } finally {
-                if (!cancelled) setExerciseAliasesLoading(false);
-            }
-        };
-        fetchAliases();
-        return () => {
-            cancelled = true;
-        };
-    }, [tab, isAdmin, supabase]);
-
-    useEffect(() => {
-        const fetchMyWorkoutsCount = async () => {
-            const { data: { user: currentUser } } = await supabase.auth.getUser();
-            if (!currentUser) { setMyWorkoutsCount(0); return; }
-            try {
-                if (isAdmin) {
-                    const authHeaders = await getAdminAuthHeaders();
-                    const res = await fetch('/api/admin/workouts/mine', { headers: authHeaders });
-                    const json = await res.json();
-                    if (json.ok) {
-                        const byTitle = new Map();
-                        for (const w of (json.rows || [])) {
-                            const key = workoutTitleKey(w.name);
-                            if (!byTitle.has(key)) byTitle.set(key, w);
-                        }
-                        const count = byTitle.size;
-                        if (count > 0) setMyWorkoutsCount(count);
-                        else {
-                            const { data } = await supabase
-                                .from('workouts')
-                                .select('id, name, is_template, created_by, user_id')
-                                .or(`created_by.eq.${currentUser.id},user_id.eq.${currentUser.id},is_template.eq.true`)
-                                .order('name');
-                            const list = (data || []).filter(w => (w.is_template === true || w.created_by === currentUser.id || w.user_id === currentUser.id));
-                            setMyWorkoutsCount(list.length);
-                        }
-                    } else {
-                        const { data } = await supabase
-                            .from('workouts')
-                            .select('id, name, is_template, created_by, user_id')
-                            .or(`created_by.eq.${currentUser.id},user_id.eq.${currentUser.id},is_template.eq.true`)
-                            .order('name');
-                        const list = (data || []).filter(w => (w.is_template === true || w.created_by === currentUser.id || w.user_id === currentUser.id));
-                        setMyWorkoutsCount(list.length);
-                    }
-                } else {
-                    const { data } = await supabase
-                        .from('workouts')
-                        .select('id, name, is_template, created_by, user_id')
-                        .or(`created_by.eq.${currentUser.id},user_id.eq.${currentUser.id}`)
-                        .order('name');
-                    const list = (data || []).filter(w => (w.is_template === true || w.created_by === currentUser.id || w.user_id === currentUser.id));
-                    setMyWorkoutsCount(list.length);
-                }
-            } catch {
-                setMyWorkoutsCount(0);
-            }
-        };
-        if (tab === 'dashboard') fetchMyWorkoutsCount();
-    }, [tab, isAdmin, supabase, getAdminAuthHeaders]);
-
-    const fetchPriorities = useCallback(async () => {
-        try {
-            setPrioritiesLoading(true);
-            setPrioritiesError('');
-            const res = await fetch('/api/teacher/inbox/feed?limit=80', { cache: 'no-store', credentials: 'include' });
-            const json = await res.json().catch(() => null);
-            if (!res.ok || !json?.ok) {
-                setPrioritiesItems([]);
-                setPrioritiesError(String(json?.error || `Falha ao carregar (${res.status})`));
-                return;
-            }
-            setPrioritiesItems(Array.isArray(json.items) ? json.items : []);
-        } catch (e) {
-            setPrioritiesItems([]);
-            setPrioritiesError(e?.message ? String(e.message) : 'Erro ao carregar');
-        } finally {
-            setPrioritiesLoading(false);
-        }
-    }, []);
-
-    const normalizeCoachInboxSettings = useCallback((raw) => {
-        const s = raw && typeof raw === 'object' ? raw : {};
-        const toInt = (v, min, max, fallback) => {
-            const n = Number(v);
-            if (!Number.isFinite(n)) return fallback;
-            const x = Math.floor(n);
-            return Math.max(min, Math.min(max, x));
-        };
-        return {
-            churnDays: toInt(s?.churnDays, 1, 60, COACH_INBOX_DEFAULTS.churnDays),
-            volumeDropPct: toInt(s?.volumeDropPct, 5, 90, COACH_INBOX_DEFAULTS.volumeDropPct),
-            loadSpikePct: toInt(s?.loadSpikePct, 10, 300, COACH_INBOX_DEFAULTS.loadSpikePct),
-            minPrev7Volume: toInt(s?.minPrev7Volume, 0, 1000000, COACH_INBOX_DEFAULTS.minPrev7Volume),
-            minCurrent7VolumeSpike: toInt(s?.minCurrent7VolumeSpike, 0, 1000000, COACH_INBOX_DEFAULTS.minCurrent7VolumeSpike),
-            snoozeDefaultMinutes: toInt(s?.snoozeDefaultMinutes, 5, 10080, COACH_INBOX_DEFAULTS.snoozeDefaultMinutes),
-        };
-    }, []);
-
-    const loadPrioritiesSettings = useCallback(async () => {
-        try {
-            setPrioritiesSettingsLoading(true);
-            setPrioritiesSettingsError('');
-            const uid = user?.id ? String(user.id) : '';
-            if (!uid) return;
-            const { data, error } = await supabase
-                .from('user_settings')
-                .select('preferences')
-                .eq('user_id', uid)
-                .maybeSingle();
-            if (error) {
-                const msg = String(error?.message || '');
-                const code = String(error?.code || '');
-                const missing = code === '42P01' || /does not exist/i.test(msg) || /not found/i.test(msg);
-                if (missing) {
-                    prioritiesSettingsPrefRef.current = null;
-                    setPrioritiesSettings({ ...COACH_INBOX_DEFAULTS });
-                    setPrioritiesSettingsError('Tabela user_settings não disponível (migrations pendentes).');
-                    return;
-                }
-                setPrioritiesSettingsError(msg || 'Falha ao carregar configurações.');
-                return;
-            }
-            const prefs = data?.preferences && typeof data.preferences === 'object' ? data.preferences : {};
-            prioritiesSettingsPrefRef.current = prefs;
-            const next = normalizeCoachInboxSettings(prefs?.coachInbox);
-            setPrioritiesSettings(next);
-        } catch (e) {
-            setPrioritiesSettingsError(e?.message ? String(e.message) : 'Falha ao carregar configurações.');
-        } finally {
-            setPrioritiesSettingsLoading(false);
-        }
-    }, [normalizeCoachInboxSettings, supabase, user?.id]);
-
-    const savePrioritiesSettings = useCallback(async () => {
-        try {
-            const uid = user?.id ? String(user.id) : '';
-            if (!uid) return false;
-            setPrioritiesSettingsLoading(true);
-            setPrioritiesSettingsError('');
-            const basePrefs = prioritiesSettingsPrefRef.current && typeof prioritiesSettingsPrefRef.current === 'object'
-                ? prioritiesSettingsPrefRef.current
-                : {};
-            const payload = {
-                user_id: uid,
-                preferences: { ...basePrefs, coachInbox: normalizeCoachInboxSettings(prioritiesSettings) },
-                updated_at: new Date().toISOString(),
-            };
-            const { error } = await supabase.from('user_settings').upsert(payload, { onConflict: 'user_id' });
-            if (error) {
-                setPrioritiesSettingsError(String(error?.message || 'Falha ao salvar.'));
-                return false;
-            }
-            prioritiesSettingsPrefRef.current = payload.preferences;
-            return true;
-        } catch (e) {
-            setPrioritiesSettingsError(e?.message ? String(e.message) : 'Falha ao salvar.');
-            return false;
-        } finally {
-            setPrioritiesSettingsLoading(false);
-        }
-    }, [normalizeCoachInboxSettings, prioritiesSettings, supabase, user?.id]);
-
-    useEffect(() => {
-        if (tab !== 'priorities') return;
-        fetchPriorities();
-    }, [tab, fetchPriorities]);
-
-    useEffect(() => {
-        if (!selectedStudent) return;
-        const fetchDetails = async () => {
-            setLoading(true);
-            const expectedStudentId = selectedStudent?.id || null;
-            let targetUserId = selectedStudent.user_id || '';
-            if (!targetUserId && selectedStudent.email) {
-                const { data: profile } = await supabase
-                    .from('profiles')
-                    .select('id')
-                    .ilike('email', selectedStudent.email)
-                    .maybeSingle();
-                targetUserId = profile?.id || targetUserId;
-            }
-            try {
-                const key = selectedStudent?.id || selectedStudent?.email || targetUserId;
-                if (key && !loadedStudentInfo.current.has(key)) {
-                    const authHeaders = await getAdminAuthHeaders();
-                    let js = null;
-                    try {
-                        const resp = await fetch('/api/admin/students/list', { headers: authHeaders });
-                        const raw = await resp.text();
-                        js = raw ? JSON.parse(raw) : null;
-                    } catch {}
-                    if (js?.ok) {
-                        const row = (js.students || []).find(s => (s.id === selectedStudent.id) || (s.user_id && s.user_id === (selectedStudent.user_id || targetUserId)) || ((s.email || '').toLowerCase() === (selectedStudent.email || '').toLowerCase()));
-                        if (row) {
-                            const nextTeacher = row.teacher_id || null;
-                            const nextUserId = row.user_id ? String(row.user_id) : '';
-                            const shouldUpdate = (nextTeacher !== selectedStudent.teacher_id) || (nextUserId !== String(selectedStudent.user_id || ''));
-                            if (shouldUpdate) {
-                                setSelectedStudent(prev => {
-                                    if (expectedStudentId && prev?.id && String(prev.id) !== String(expectedStudentId)) return prev;
-                                    return { ...prev, teacher_id: nextTeacher, user_id: nextUserId || null };
-                                });
-                            }
-                        }
-                        loadedStudentInfo.current.add(key);
-                    }
-                }
-            } catch {}
-            try {
-                if (!selectedStudent.teacher_id && selectedStudent.email) {
-                    const cached = localStorage.getItem('student_teacher_'+selectedStudent.email);
-                    if (cached != null && cached !== String(selectedStudent.teacher_id || '')) {
-                        setSelectedStudent(prev => ({ ...prev, teacher_id: cached || null }));
-                    }
-                }
-            } catch {}
-            if (targetUserId) {
-                let wData = [];
-                const { data } = await supabase
-                    .from('workouts')
-                    .select('*, exercises(*, sets(*))')
-                    .eq('user_id', targetUserId)
-                    .eq('is_template', true)
-                    .order('name');
-                wData = data || [];
-
-                wData = (Array.isArray(wData) ? wData : []).filter((w) => w && typeof w === 'object' && w.is_template === true);
-                
-                const studentDeduped = (wData || []).sort((a,b) => (a.name||'').localeCompare(b.name||''));
-                const synced = (studentDeduped || []).filter(w => (String(w?.created_by || '') === String(user.id)) && (String(w?.user_id || '') === String(targetUserId)));
-                const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-                const others = (studentDeduped || []).filter(w => !syncedIds.has(w?.id));
-                setStudentWorkouts(others || []);
-                setSyncedWorkouts(synced || []);
-            } else {
-                setStudentWorkouts([]);
-                setSyncedWorkouts([]);
-                setAssessments([]);
-            }
-
-            // Load "Meus Treinos" for assignment list
-            const { data: { user: me } } = await supabase.auth.getUser();
-            if (me) {
-                let my = [];
-                try {
-                    const authHeaders = await getAdminAuthHeaders();
-                    const resMine = await fetch('/api/admin/workouts/mine', { headers: authHeaders });
-                    const jsonMine = await resMine.json();
-                    if (jsonMine.ok) my = jsonMine.rows || [];
-                    else {
-                        const { data } = await supabase
-                            .from('workouts')
-                            .select('*, exercises(*, sets(*))')
-                            .or(`created_by.eq.${me.id},user_id.eq.${me.id}`)
-                            .order('name');
-                        my = data || [];
-                    }
-                } catch {
-                    const { data } = await supabase
-                        .from('workouts')
-                        .select('*, exercises(*, sets(*))')
-                        .or(`created_by.eq.${me.id},user_id.eq.${me.id},is_template.eq.true`)
-                        .order('name');
-                    my = data || [];
-                }
-
-                my = (my || []).filter(w => (w?.user_id === me.id) && (w?.is_template === true));
-                
-                // Helper reintroduzido para deduplicação de TEMPLATES (Meus Treinos)
-                const tMap = new Map();
-                for (const w of (my || [])) {
-                    const key = workoutTitleKey(w.name);
-                    const prev = tMap.get(key);
-                    const exs = Array.isArray(w.exercises) ? w.exercises : [];
-                    const prevExs = Array.isArray(prev?.exercises) ? prev.exercises : [];
-                    const score = (x) => (Array.isArray(x) ? x.length : 0);
-                    const curHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(w?.name || ''));
-                    const prevHasPrefix = /^[A-Z]\s-\s/.test(normalizeWorkoutTitle(prev?.name || ''));
-                    if (
-                        !prev
-                        || score(exs) > score(prevExs)
-                        || (score(exs) === score(prevExs) && curHasPrefix && !prevHasPrefix)
-                        || (score(exs) === score(prevExs) && !!w.is_template && !prev?.is_template)
-                    ) {
-                        tMap.set(key, w);
-                    }
-                }
-                try {
-                    const resLegacy = await fetch('/api/workouts/list');
-                    const jsonLegacy = await resLegacy.json();
-                    if (jsonLegacy.ok) {
-                        for (const r of (jsonLegacy.rows || [])) {
-                            const key = workoutTitleKey(r.name);
-                            const prev = tMap.get(key);
-                            const candidate = { id: r.id || r.uuid, name: normalizeWorkoutTitle(r.name), exercises: [] };
-                            const prevExs = Array.isArray(prev?.exercises) ? prev.exercises : [];
-                            if (!prev || prevExs.length < 1) tMap.set(key, candidate);
-                        }
-                    }
-                } catch {}
-                const dedupTemplates = Array.from(tMap.values())
-                    .map((w) => ({ ...w, name: normalizeWorkoutTitle(w?.name || '') }))
-                    .sort((a,b) => (a.name||'').localeCompare(b.name||''));
-                setTemplates(dedupTemplates || []);
-            }
-            if (targetUserId) {
-                const assessmentOrParts = [];
-                if (selectedStudent?.id) assessmentOrParts.push(`student_id.eq.${selectedStudent.id}`);
-                if (targetUserId) assessmentOrParts.push(`user_id.eq.${targetUserId}`);
-                if (assessmentOrParts.length > 0) {
-                    const { data: aData } = await supabase
-                        .from('assessments')
-                        .select('*')
-                        .or(assessmentOrParts.join(','))
-                        .order('date', { ascending: false });
-                    setAssessments(aData || []);
-                } else {
-                    setAssessments([]);
-                }
-            }
-            setLoading(false);
-        };
-        fetchDetails();
-    }, [selectedStudent, supabase, user?.id, isAdmin, isTeacher, getAdminAuthHeaders]);
-
-    useEffect(() => {
-        if (!executionVideoEnabled) return;
-        if (!selectedStudent) return;
-        if (subTab !== 'videos') return;
-        let cancelled = false;
-        const run = async () => {
-            const studentUserId = selectedStudent?.user_id ? String(selectedStudent.user_id) : '';
-            if (!studentUserId) return;
-            setExecutionVideosLoading(true);
-            setExecutionVideosError('');
-            try {
-                const res = await fetch(`/api/teacher/execution-videos/by-student?student_user_id=${encodeURIComponent(studentUserId)}`, { cache: 'no-store', credentials: 'include' });
-                const json = await res.json().catch(() => null);
-                if (cancelled) return;
-                if (!res.ok || !json?.ok) {
-                    setExecutionVideos([]);
-                    setExecutionVideosError(String(json?.error || `Falha ao carregar (${res.status})`));
-                    return;
-                }
-                setExecutionVideos(Array.isArray(json.items) ? json.items : []);
-            } catch (e) {
-                if (!cancelled) {
-                    setExecutionVideos([]);
-                    setExecutionVideosError(e?.message ? String(e.message) : 'Erro ao carregar');
-                }
-            } finally {
-                if (!cancelled) setExecutionVideosLoading(false);
-            }
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [executionVideoEnabled, selectedStudent, subTab]);
-
-    useEffect(() => {
-        if (!selectedStudent) return;
-        if (subTab !== 'checkins') return;
-        let cancelled = false;
-        const run = async () => {
-            try {
-                setStudentCheckinsLoading(true);
-                setStudentCheckinsError('');
-                const looksLikeUuid = (v) => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(v || '').trim());
-                const rawCandidate = selectedStudent?.user_id || selectedStudent?.id || '';
-                const studentUserId = looksLikeUuid(rawCandidate) ? String(rawCandidate) : '';
-                if (!studentUserId) {
-                    setStudentCheckinsRows([]);
-                    setStudentCheckinsError('Aluno sem user_id (não é possível buscar check-ins).');
-                    return;
-                }
-
-                const days = String(studentCheckinsRange || '7d') === '30d' ? 30 : 7;
-                const startIso = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString();
-                let q = supabase
-                    .from('workout_checkins')
-                    .select('id, kind, created_at, energy, mood, soreness, notes, answers, workout_id, planned_workout_id')
-                    .eq('user_id', studentUserId)
-                    .gte('created_at', startIso)
-                    .order('created_at', { ascending: false })
-                    .limit(400);
-                if (studentCheckinsFilter && studentCheckinsFilter !== 'all') q = q.eq('kind', String(studentCheckinsFilter));
-                const { data, error } = await q;
-                if (error) throw error;
-                if (cancelled) return;
-                setStudentCheckinsRows(Array.isArray(data) ? data : []);
-            } catch (e) {
-                if (cancelled) return;
-                setStudentCheckinsRows([]);
-                setStudentCheckinsError(e?.message ? String(e.message) : 'Falha ao carregar check-ins.');
-            } finally {
-                if (!cancelled) setStudentCheckinsLoading(false);
-            }
-        };
-        run();
-        return () => {
-            cancelled = true;
-        };
-    }, [selectedStudent, subTab, studentCheckinsFilter, studentCheckinsRange, supabase]);
-
-    // Ensure teachers list available when viewing a student (for assignment)
-    useEffect(() => {
-        if (!selectedStudent || !isAdmin) return;
-        const loadTeachers = async () => {
-            try {
-                const authHeaders = await getAdminAuthHeaders();
-                const res = await fetch('/api/admin/teachers/list', { headers: authHeaders });
-                const json = await res.json();
-                if (json.ok) {
-                    const base = json.teachers || [];
-                    let enriched = base;
-                    try {
-                        const emails = base.map(t => t.email).filter(Boolean);
-                        if (emails.length > 0) {
-                            const { data: profilesMap } = await supabase
-                                .from('profiles')
-                                .select('id, email')
-                                .in('email', emails);
-                            const idByEmail = new Map((profilesMap || []).map(p => [p.email, p.id]));
-                            enriched = base.map(t => ({ ...t, user_id: idByEmail.get(t.email) || null }));
-                        }
-                    } catch {}
-                    const currentUid = selectedStudent?.teacher_id || '';
-                    if (currentUid && !enriched.some(t => t.user_id === currentUid)) {
-                        try {
-                            const { data: curProfile } = await supabase
-                                .from('profiles')
-                                .select('id, display_name, email')
-                                .eq('id', currentUid)
-                                .maybeSingle();
-                            if (curProfile) {
-                                enriched = [{ id: curProfile.id, name: curProfile.display_name, email: curProfile.email, user_id: curProfile.id, status: 'active' }, ...enriched];
-                            } else {
-                                enriched = [{ id: currentUid, name: 'Professor atribuído', email: '', user_id: currentUid, status: 'active' }, ...enriched];
-                            }
-                        } catch {
-                            enriched = [{ id: currentUid, name: 'Professor atribuído', email: '', user_id: currentUid, status: 'active' }, ...enriched];
-                        }
-                    }
-                    setTeachersList(enriched);
-                }
-            } catch {}
-        };
-        loadTeachers();
-    }, [selectedStudent, isAdmin, supabase, getAdminAuthHeaders]);
-
-    const handleRegisterStudent = async () => {
-        if (!newStudent.name || !newStudent.email) return await alert('Preencha nome e email.');
-        setRegistering(true);
-        try {
-            const { data, error } = await supabase
-                .from('students')
-                .insert({ name: newStudent.name, email: newStudent.email, teacher_id: user.id })
-                .select();
-            if (error) throw error;
-            setUsersList(prev => (data?.[0] ? [data[0], ...prev] : prev));
-            setShowRegisterModal(false);
-            setNewStudent({ name: '', email: '' });
-            await alert('Aluno cadastrado com sucesso!', 'Sucesso');
-        } catch (e) {
-            await alert('Erro ao cadastrar: ' + (e?.message ?? String(e)));
-        } finally {
-            setRegistering(false);
-        }
-    };
-
-    // Assign template workout to selected student (clone workout and exercises)
-    const handleAddTemplateToStudent = async (template) => {
-        if (!selectedStudent) return;
-        const targetUserId = selectedStudent.user_id || '';
-        if (!targetUserId) { await alert('Aluno sem conta (user_id).'); return; }
-        if (!(await confirm(`Adicionar treino "${template?.name || 'Treino'}" para ${selectedStudent.name || selectedStudent.email}?`))) return;
-        try {
-            const payload = {
-                user_id: targetUserId,
-                created_by: user?.id,
-                is_template: true,
-                name: template?.name || '',
-                notes: template?.notes || ''
-            };
-            const { data: newWorkout, error: wErr } = await supabase
-                .from('workouts')
-                .insert(payload)
-                .select()
-                .single();
-            if (wErr) throw wErr;
-            const toInsert = (template?.exercises || []).map(e => ({
-                workout_id: newWorkout.id,
-                name: e?.name || '',
-                sets: getSetsCount(e?.sets) || 4,
-                reps: e?.reps ?? '10',
-                rpe: e?.rpe ?? 8,
-                cadence: e?.cadence || '2020',
-                rest_time: e?.rest_time ?? 60,
-                method: e?.method || 'Normal',
-                video_url: e?.video_url || '',
-                notes: e?.notes || ''
-            }));
-            let newExs = [];
-            if (toInsert.length) {
-                const { data: exRows, error: exErr } = await supabase.from('exercises').insert(toInsert).select();
-                if (exErr) throw exErr;
-                newExs = exRows || [];
-            }
-            for (let i = 0; i < (template?.exercises || []).length; i++) {
-                const srcEx = template?.exercises?.[i] || {};
-                const dstEx = newExs[i] || null;
-                const setsArr = Array.isArray(srcEx?.sets) ? srcEx.sets : [];
-                if (dstEx && setsArr.length) {
-                    const newSets = setsArr.map(s => ({
-                        exercise_id: dstEx.id,
-                        weight: s?.weight ?? null,
-                        reps: s?.reps ?? null,
-                        rpe: s?.rpe ?? null,
-                        set_number: s?.set_number ?? 1,
-                        completed: s?.completed ?? false
-                    }));
-                    if (newSets.length) {
-                        const { error: setErr } = await supabase.from('sets').insert(newSets);
-                        if (setErr) throw setErr;
-                    }
-                }
-            }
-            let refreshed = [];
-            const targetUserId = selectedStudent.user_id || '';
-            if (!targetUserId) { await alert('Aluno sem conta (user_id).'); return; }
-            const { data } = await supabase
-                .from('workouts')
-                .select('*, exercises(*, sets(*))')
-                .eq('user_id', targetUserId)
-                .eq('is_template', true)
-                .order('name');
-            refreshed = data || [];
-            refreshed = (Array.isArray(refreshed) ? refreshed : []).filter((w) => w && typeof w === 'object' && w.is_template === true);
-            const synced = (refreshed || []).filter(w => (String(w?.created_by || '') === String(user.id)) && (String(w?.user_id || '') === String(targetUserId)));
-            const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-            const others = (refreshed || []).filter(w => !syncedIds.has(w?.id));
-            setStudentWorkouts(others || []);
-            setSyncedWorkouts(synced || []);
-            await alert('Treino enviado com sucesso!', 'Sucesso');
-        } catch (e) {
-            await alert('Erro ao enviar: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleSendBroadcast = async () => {
-        if (!broadcastTitle || !broadcastMsg) return await alert('Preencha título e mensagem.');
-        setSendingBroadcast(true);
-        try {
-            const res = await sendBroadcastMessage(broadcastTitle, broadcastMsg);
-            if (res.error) throw new Error(res.error);
-            await alert('Aviso enviado!', 'Sucesso');
-            setBroadcastTitle('');
-            setBroadcastMsg('');
-        } catch (e) {
-            await alert('Erro ao enviar: ' + (e?.message ?? String(e)));
-        } finally {
-            setSendingBroadcast(false);
-        }
-    };
-
-    const loadUserActivityUsers = useCallback(async ({ q, role } = {}) => {
-        if (!isAdmin) return;
-        setUserActivityLoading(true);
-        setUserActivityError('');
-        try {
-            const qs = new URLSearchParams();
-            const qq = String(q ?? '').trim();
-            const rr = String(role ?? '').trim();
-            if (qq) qs.set('q', qq);
-            if (rr && rr !== 'all') qs.set('role', rr);
-            qs.set('limit', '200');
-            const authHeaders = await getAdminAuthHeaders();
-            const res = await fetch(`/api/admin/user-activity/users?${qs.toString()}`, { headers: authHeaders });
-            const json = await res.json().catch(() => null);
-            if (!res.ok || !json?.ok) {
-                setUserActivityUsers([]);
-                setUserActivityError(String(json?.error || `Falha ao carregar usuários (${res.status})`));
-                return;
-            }
-            setUserActivityUsers(Array.isArray(json?.users) ? json.users : []);
-        } catch (e) {
-            setUserActivityUsers([]);
-            setUserActivityError(e?.message ? String(e.message) : String(e));
-        } finally {
-            setUserActivityLoading(false);
-        }
-    }, [isAdmin, getAdminAuthHeaders]);
-
-    const loadUserActivitySummary = useCallback(async ({ userId, days } = {}) => {
-        if (!isAdmin) return;
-        const uid = String(userId || '').trim();
-        if (!uid) return;
-        const d = Math.min(90, Math.max(1, Number(days) || 7));
-        setUserActivitySummaryLoading(true);
-        try {
-            const qs = new URLSearchParams({ user_id: uid, days: String(d) });
-            const authHeaders = await getAdminAuthHeaders();
-            const res = await fetch(`/api/admin/user-activity/summary?${qs.toString()}`, { headers: authHeaders });
-            const json = await res.json().catch(() => null);
-            if (!res.ok || !json?.ok) {
-                setUserActivitySummary(null);
-                return;
-            }
-            setUserActivitySummary(json);
-        } catch {
-            setUserActivitySummary(null);
-        } finally {
-            setUserActivitySummaryLoading(false);
-        }
-    }, [isAdmin, getAdminAuthHeaders]);
-
-    const loadUserActivityEvents = useCallback(async ({ userId, before, reset = false } = {}) => {
-        if (!isAdmin) return;
-        const uid = String(userId || '').trim();
-        if (!uid) return;
-        setUserActivityEventsLoading(true);
-        try {
-            const qs = new URLSearchParams({ user_id: uid, limit: '80' });
-            if (before) qs.set('before', String(before));
-            const authHeaders = await getAdminAuthHeaders();
-            const res = await fetch(`/api/admin/user-activity/events?${qs.toString()}`, { headers: authHeaders });
-            const json = await res.json().catch(() => null);
-            if (!res.ok || !json?.ok) {
-                if (reset) setUserActivityEvents([]);
-                return;
-            }
-            const list = Array.isArray(json?.events) ? json.events : [];
-            setUserActivityEventsBefore(json?.nextBefore ?? null);
-            setUserActivityEvents((prev) => (reset ? list : [...prev, ...list]));
-        } catch {
-            if (reset) setUserActivityEvents([]);
-        } finally {
-            setUserActivityEventsLoading(false);
-        }
-    }, [isAdmin, getAdminAuthHeaders]);
-
-    const loadUserActivityErrors = useCallback(async ({ userId } = {}) => {
-        if (!isAdmin) return;
-        const uid = String(userId || '').trim();
-        if (!uid) return;
-        setUserActivityErrorsLoading(true);
-        try {
-            const { data, error } = await supabase
-                .from('error_reports')
-                .select('id, created_at, message, pathname, url, status, app_version, source')
-                .eq('user_id', uid)
-                .order('created_at', { ascending: false })
-                .limit(10);
-            if (error) {
-                setUserActivityErrors([]);
-                return;
-            }
-            setUserActivityErrors(Array.isArray(data) ? data : []);
-        } catch {
-            setUserActivityErrors([]);
-        } finally {
-            setUserActivityErrorsLoading(false);
-        }
-    }, [isAdmin, supabase]);
-
-    useEffect(() => {
-        if (!isAdmin) return;
-        if (tab !== 'system') return;
-        try {
-            if (userActivityQueryDebounceRef.current) clearTimeout(userActivityQueryDebounceRef.current);
-        } catch {}
-        userActivityQueryDebounceRef.current = setTimeout(() => {
-            loadUserActivityUsers({ q: userActivityQuery, role: userActivityRole });
-        }, 400);
-        return () => {
-            try {
-                if (userActivityQueryDebounceRef.current) clearTimeout(userActivityQueryDebounceRef.current);
-            } catch {}
-        };
-    }, [isAdmin, tab, userActivityQuery, userActivityRole, loadUserActivityUsers]);
-
-    const openUserActivityUser = useCallback(async (u) => {
-        const id = String(u?.id || u?.userId || '').trim();
-        if (!id) return;
-        setUserActivitySelected(u);
-        setUserActivityEvents([]);
-        setUserActivityEventsBefore(null);
-        setUserActivitySummary(null);
-        setUserActivityErrors([]);
-        try {
-            await loadUserActivitySummary({ userId: id, days: userActivityDays });
-        } catch {}
-        try {
-            await loadUserActivityEvents({ userId: id, reset: true });
-        } catch {}
-        try {
-            await loadUserActivityErrors({ userId: id });
-        } catch {}
-    }, [loadUserActivityErrors, loadUserActivityEvents, loadUserActivitySummary, userActivityDays]);
-
-    const handleEditStudent = () => {
-        if (!selectedStudent) return;
-        setEditedStudent({ name: selectedStudent.name || '', email: selectedStudent.email || '' });
-        setEditingStudent(true);
-    };
-
-    const handleSaveStudentEdit = async () => {
-        if (!selectedStudent || !editedStudent.name || !editedStudent.email) return await alert('Preencha todos os campos.');
-        try {
-            const { error } = await supabase
-                .from('students')
-                .update({ name: editedStudent.name, email: editedStudent.email })
-                .eq('id', selectedStudent.id);
-            if (error) throw error;
-            setSelectedStudent(prev => ({ ...prev, name: editedStudent.name, email: editedStudent.email }));
-            setUsersList(prev => prev.map(s => s.id === selectedStudent.id ? { ...s, name: editedStudent.name, email: editedStudent.email } : s));
-            setEditingStudent(false);
-            await alert('Dados do aluno atualizados.');
-        } catch (e) {
-            await alert('Erro ao salvar: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleAddTeacher = async () => {
-        if (!newTeacher.name || !newTeacher.email) return await alert('Preencha nome e email.');
-        setAddingTeacher(true);
-        try {
-            const res = await addTeacher(newTeacher.name, newTeacher.email, newTeacher.phone, newTeacher.birth_date);
-            if (res.error) throw new Error(res.error);
-            
-            await alert('Professor adicionado com sucesso!');
-            setShowTeacherModal(false);
-            setNewTeacher({ name: '', email: '', phone: '', birth_date: '' });
-            // Trigger refresh (simple way)
-            setTab('dashboard'); setTimeout(() => setTab('teachers'), 100);
-        } catch (e) {
-            await alert('Erro ao adicionar professor: ' + (e?.message ?? String(e)));
-        } finally {
-            setAddingTeacher(false);
-        }
-    };
-
-    const handleUpdateTeacher = async () => {
-        if (!editingTeacher || !editingTeacher.name || !editingTeacher.email) return await alert('Preencha nome e email.');
-        try {
-            const res = await updateTeacher(editingTeacher.id, {
-                name: editingTeacher.name,
-                email: editingTeacher.email,
-                phone: editingTeacher.phone,
-                birth_date: editingTeacher.birth_date
-            });
-            if (res.error) throw new Error(res.error);
-            await alert('Professor atualizado com sucesso!');
-            setEditingTeacher(null);
-            // Trigger refresh
-            setTab('dashboard'); setTimeout(() => setTab('teachers'), 100);
-        } catch (e) {
-            await alert('Erro ao atualizar professor: ' + (e?.message ?? String(e)));
-        }
-    };
-
-    const handleDangerAction = async (actionName, actionFn) => {
-        if (!(await confirm(`Tem certeza que deseja ${actionName}?`, 'ATENÇÃO - PERIGO'))) return false;
-        if (!(await confirm(`Esta ação é IRREVERSÍVEL. Todos os dados serão perdidos. Confirmar mesmo?`, 'CONFIRMAÇÃO FINAL'))) return false;
-
-        try {
-            const res = await actionFn();
-            if (res?.error) throw new Error(res.error);
-            await alert(`${actionName} realizado com sucesso.`, 'Sucesso');
-            setUsersList([]);
-            setTeachersList([]);
-            setTemplates([]);
-            return true;
-        } catch (e) {
-            await alert(`Erro ao executar ${actionName}: ` + (e?.message ?? String(e)));
-            return false;
-        }
-    };
-
-	const runDangerAction = async (actionKey, actionName, actionFn, resetInput) => {
-		setDangerActionLoading(actionKey);
-		try {
-			const ok = await handleDangerAction(actionName, actionFn);
-			if (ok) resetInput();
-		} finally {
-			setDangerActionLoading(null);
-		}
-	};
-
-	let TAB_LABELS = { dashboard: 'VISÃO GERAL', students: 'ALUNOS', templates: 'TREINOS' };
-	if (isAdmin) {
-		TAB_LABELS = { ...TAB_LABELS, requests: 'SOLICITAÇÕES', teachers: 'PROFESSORES', videos: 'VÍDEOS', errors: 'ERROS', vip_reports: 'RELATÓRIOS VIP', system: 'SISTEMA' };
-	}
-	if (isTeacher && !isAdmin) {
-		TAB_LABELS = { ...TAB_LABELS, priorities: 'PRIORIDADES' };
-	}
-	if (isAdmin) {
-		TAB_LABELS = { ...TAB_LABELS, priorities: 'PRIORIDADES' };
-	}
-
-	const tabKeys = Object.keys(TAB_LABELS);
-	const currentTabLabel = TAB_LABELS[tab] || 'VISÃO GERAL';
-
-	const totalStudents = Array.isArray(usersList) ? usersList.length : 0;
-	const studentsWithTeacher = Array.isArray(usersList) ? usersList.filter(s => !!s.teacher_id).length : 0;
-	const studentsWithoutTeacher = Array.isArray(usersList) ? usersList.filter(s => !s.teacher_id).length : 0;
-	const totalTeachers = Array.isArray(teachersList) ? teachersList.length : 0;
-
-	const studentStatusStats = useMemo(() => {
-		const list = Array.isArray(usersList) ? usersList : [];
-		const stats = { pago: 0, pendente: 0, atrasado: 0, cancelar: 0, outros: 0 };
-		for (const s of list) {
-			try {
-				const rawStatus = s && typeof s === 'object' ? s.status : null;
-				const key = String(rawStatus || 'pendente').toLowerCase().trim();
-				if (Object.prototype.hasOwnProperty.call(stats, key)) {
-					stats[key] += 1;
-				} else {
-					stats.outros += 1;
-				}
-			} catch {}
-		}
-		return stats;
-	}, [usersList]);
-
-	const dashboardCharts = useMemo(() => {
-		const baseTotalStudents = typeof totalStudents === 'number' && Number.isFinite(totalStudents) && totalStudents > 0 ? totalStudents : 0;
-		const baseWith = typeof studentsWithTeacher === 'number' && Number.isFinite(studentsWithTeacher) && studentsWithTeacher > 0 ? studentsWithTeacher : 0;
-		const baseWithout = typeof studentsWithoutTeacher === 'number' && Number.isFinite(studentsWithoutTeacher) && studentsWithoutTeacher > 0 ? studentsWithoutTeacher : 0;
-
-		const teacherData = {
-			labels: ['Com professor', 'Sem professor'],
-			datasets: [
-				{
-					label: 'Alunos',
-					data: [baseWith, baseWithout],
-					backgroundColor: ['rgba(250, 204, 21, 0.9)', 'rgba(82, 82, 82, 0.9)'],
-					borderRadius: 999,
-					maxBarThickness: 40
-				}
-			]
-		};
-
-		const totalStatus =
-			studentStatusStats.pago +
-			studentStatusStats.pendente +
-			studentStatusStats.atrasado +
-			studentStatusStats.cancelar +
-			studentStatusStats.outros;
-
-		const statusValues =
-			totalStatus > 0
-				? [
-					studentStatusStats.pago,
-					studentStatusStats.pendente,
-					studentStatusStats.atrasado,
-					studentStatusStats.cancelar,
-					studentStatusStats.outros
-				]
-				: [0, 0, 0, 0, 0];
-
-		const statusData = {
-			labels: ['Pago', 'Pendente', 'Atrasado', 'Cancelar', 'Outros'],
-			datasets: [
-				{
-					label: 'Alunos',
-					data: statusValues,
-					backgroundColor: [
-						'rgba(34, 197, 94, 0.9)',
-						'rgba(234, 179, 8, 0.9)',
-						'rgba(248, 113, 113, 0.9)',
-						'rgba(148, 163, 184, 0.9)',
-						'rgba(82, 82, 82, 0.9)'
-					],
-					borderRadius: 12,
-					maxBarThickness: 32
-				}
-			]
-		};
-
-		const baseOptions = {
-			responsive: true,
-			maintainAspectRatio: false,
-			plugins: {
-				legend: {
-					display: false,
-					labels: {
-						color: '#a3a3a3',
-						font: { size: 10, weight: '600' }
-					}
-				},
-				tooltip: {
-					enabled: true,
-					backgroundColor: 'rgba(10,10,10,0.9)',
-					borderColor: '#404040',
-					borderWidth: 1,
-					titleColor: '#fafafa',
-					bodyColor: '#e5e5e5',
-					padding: 8,
-					displayColors: false
-				}
-			},
-			scales: {
-				x: {
-					grid: {
-						display: false,
-						drawBorder: false
-					},
-					ticks: {
-						color: '#a3a3a3',
-						font: { size: 10, weight: '600' }
-					}
-				},
-				y: {
-					beginAtZero: true,
-					grid: {
-						color: 'rgba(64,64,64,0.6)',
-						drawBorder: false
-					},
-					ticks: {
-						color: '#737373',
-						font: { size: 9, weight: '500' },
-						precision: 0,
-						stepSize: 1
-					}
-				}
-			}
-		};
-
-		const teacherOptions = {
-			...baseOptions,
-			onClick: () => {
-				try {
-					setTab('students');
-					setSelectedStudent(null);
-				} catch {}
-			}
-		};
-
-		const statusOptions = {
-			...baseOptions,
-			onClick: (evt, elements) => {
-				try {
-					if (!elements || elements.length === 0) return;
-					const first = elements[0];
-					const index = typeof first?.index === 'number' ? first.index : null;
-					if (index == null || !Number.isFinite(index)) return;
-					const mapping = ['pago', 'pendente', 'atrasado', 'cancelar', 'outros'];
-					const key = mapping[index];
-					if (!key) return;
-					setStudentStatusFilter(key);
-					setTab('students');
-					setSelectedStudent(null);
-				} catch {}
-			}
-		};
-
-		return {
-			teacherDistribution: {
-				data: teacherData,
-				options: teacherOptions
-			},
-			statusDistribution: {
-				data: statusData,
-				options: statusOptions
-			},
-			statusTotal: totalStatus,
-			totalStudents: baseTotalStudents
-		};
-	}, [totalStudents, studentsWithTeacher, studentsWithoutTeacher, studentStatusStats, setStudentStatusFilter, setTab, setSelectedStudent]);
-
-	if (!isAdmin && !isTeacher) return null;
-
-	const selectedStatus = normalizeText(selectedStudent?.status || '');
-    const selectedStatusLabel = String(selectedStudent?.status || 'pendente');
-    const selectedStatusTone = selectedStatus === 'pago'
-        ? 'bg-green-500/10 text-green-400 border-green-500/30'
-        : (selectedStatus === 'atrasado'
-            ? 'bg-red-500/10 text-red-400 border-red-500/30'
-            : (selectedStatus === 'cancelar'
-                ? 'bg-neutral-500/10 text-neutral-300 border-neutral-500/25'
-                : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30'));
-
-    return (
-        <div data-tour="adminpanel.root" className="fixed inset-0 z-50 bg-neutral-950 text-white flex flex-col overflow-hidden">
-            <div className="sticky top-0 z-50 bg-neutral-950/90 backdrop-blur-xl border-b border-neutral-800 shadow-[0_16px_40px_rgba(0,0,0,0.55)] pt-safe flex-shrink-0">
-                {debugError && (
-                    <div className="bg-red-600 text-white font-bold p-4 text-center text-xs break-all mb-2 rounded-xl">
-                        DIAGNOSTIC MODE: {debugError}
-                    </div>
-                )}
-				<div className="px-4 md:px-8 py-2">
-					<div className="w-full flex flex-col md:flex-row md:items-center md:justify-between gap-1 md:gap-4">
-						<div className="flex items-center justify-between gap-3">
-							<div className="flex items-center gap-3">
-                                <button
-                                    type="button"
-                                    onClick={() => { setSelectedStudent(null); setTab('dashboard'); }}
-                                    className="flex items-center gap-3 cursor-pointer group active:scale-[0.99] transition-transform"
-                                >
-                                    <div className="w-10 h-10 rounded-2xl bg-yellow-500 flex items-center justify-center shadow-lg shadow-yellow-500/20 border border-yellow-400/40">
-                                        <Crown size={20} className="text-black" />
-                                    </div>
-                                    <div className="flex flex-col items-start">
-                                        <span className="text-[11px] font-bold uppercase tracking-[0.2em] text-yellow-500/80">IronTracks</span>
-                                        <span className="text-sm md:text-base font-black text-white leading-tight">Painel de Controle</span>
-                                    </div>
-                                </button>
-                                <div className="hidden md:block text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Operações do seu negócio</div>
-                            </div>
-							<button
-								onClick={() => onClose && onClose()}
-								className="md:hidden flex-shrink-0 w-10 h-10 rounded-full bg-neutral-900/70 hover:bg-neutral-800 text-neutral-300 hover:text-white flex items-center justify-center transition-all border border-neutral-800 active:scale-95"
-							>
-								<X size={18} className="font-bold" />
-							</button>
-						</div>
-						
-						<div className="flex items-center gap-2 min-w-0 mt-1 md:mt-0">
-                            <div className="flex-1 min-w-0">
-                                <div data-tour="adminpanel.tabs" className="hidden md:flex items-center gap-2 justify-end flex-wrap">
-                                    {Object.entries(TAB_LABELS).map(([key, label]) => (
-                                        <button
-                                            key={key}
-                                            onClick={() => { setTab(key); setSelectedStudent(null); setMoreTabsOpen(false); }}
-                                            className={`min-h-[40px] px-3.5 md:px-4 py-2 rounded-full font-black text-[11px] uppercase tracking-wide whitespace-nowrap transition-all duration-300 border active:scale-95 ${
-                                                tab === key
-                                                    ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/20'
-                                                    : 'bg-neutral-900/70 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            {label}
-                                        </button>
-                                    ))}
-                                    <button
-                                        onClick={() => onClose && onClose()}
-                                        className="hidden md:inline-flex items-center justify-center w-10 h-10 rounded-full bg-neutral-900/70 hover:bg-neutral-800 text-neutral-300 hover:text-white transition-all border border-neutral-800 active:scale-95 ml-1"
-                                    >
-                                        <X size={18} className="font-bold" />
-                                    </button>
-                                </div>
-
-                                <div className="md:hidden flex items-center gap-2">
-                                    <button
-                                        type="button"
-                                        data-tour="adminpanel.tabs"
-                                        onClick={() => setMoreTabsOpen(true)}
-                                        className="flex-1 min-h-[44px] px-4 rounded-2xl bg-neutral-900/80 border border-neutral-800 flex items-center justify-between gap-3 shadow-[0_10px_30px_rgba(0,0,0,0.35)] active:scale-95 transition-all duration-300"
-                                    >
-                                        <span className="text-[11px] font-black uppercase tracking-widest text-neutral-100 truncate">{currentTabLabel}</span>
-                                        <ChevronDown size={18} className="text-neutral-300" />
-                                    </button>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                </div>
-            </div>
-
-            {moreTabsOpen && (
-                <div
-                    className="md:hidden fixed inset-0 z-[60]"
-                    role="dialog"
-                    aria-modal="true"
-                    onClick={() => setMoreTabsOpen(false)}
-                >
-                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" />
-                    <div className="absolute inset-x-0 bottom-0 pb-safe" onClick={(e) => e.stopPropagation()}>
-                        <div className="mx-auto w-full max-w-md rounded-t-3xl bg-neutral-950 border border-neutral-800 shadow-[0_-20px_60px_rgba(0,0,0,0.65)] overflow-hidden">
-                            <div className="px-4 pt-3 pb-2 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Mais</div>
-                                    <div className="text-base font-black text-white">Navegação</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => setMoreTabsOpen(false)}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-3 grid gap-2">
-                                {(Array.isArray(tabKeys) ? tabKeys : []).map((key) => {
-                                    const isActive = tab === key;
-                                    const label = TAB_LABELS[key] || key;
-                                    let subtitle = '';
-                                    if (key === 'dashboard') subtitle = 'Visão geral do negócio';
-                                    else if (key === 'students') subtitle = 'Gestão de alunos e status';
-                                    else if (key === 'templates') subtitle = 'Biblioteca de treinos-base';
-                                    else if (key === 'teachers') subtitle = 'Gestão de professores e convites';
-                                    else if (key === 'videos') subtitle = 'Fila de vídeos por exercício';
-                                    else if (key === 'priorities') subtitle = 'Triagem inteligente do coach';
-                                    else if (key === 'errors') subtitle = 'Erros reportados pelos usuários';
-                                    else if (key === 'system') subtitle = 'Backup, broadcasts e operações críticas';
-
-                                    let iconColor = isActive ? 'text-yellow-400' : 'text-neutral-400';
-                                    let badgeClass = isActive
-                                        ? 'bg-yellow-500/15 border-yellow-500/40'
-                                        : 'bg-neutral-900 border-neutral-800';
-
-                                    if (key === 'system') {
-                                        iconColor = isActive ? 'text-red-400' : 'text-red-300';
-                                        badgeClass = isActive
-                                            ? 'bg-red-900/60 border-red-500/60'
-                                            : 'bg-red-950/70 border-red-700/70';
-                                    }
-
-                                    return (
-                                        <button
-                                            key={key}
-                                            type="button"
-                                            onClick={() => { setTab(key); setSelectedStudent(null); setMoreTabsOpen(false); }}
-                                            className={`w-full min-h-[56px] px-4 rounded-2xl border flex items-center justify-between gap-3 transition-all duration-300 active:scale-[0.99] ${
-                                                isActive
-                                                    ? key === 'system'
-                                                        ? 'bg-red-900/20 text-red-300 border-red-500/40 shadow-lg shadow-red-500/20'
-                                                        : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30 shadow-lg shadow-yellow-500/10'
-                                                    : key === 'system'
-                                                        ? 'bg-neutral-900/80 text-red-300 border-red-800 hover:bg-neutral-900'
-                                                        : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className={`w-9 h-9 rounded-2xl flex items-center justify-center flex-shrink-0 border ${badgeClass}`}>
-                                                    {key === 'dashboard' && <Crown size={16} className={iconColor} />}
-                                                    {key === 'students' && <UserPlus size={16} className={iconColor} />}
-                                                    {key === 'templates' && <Dumbbell size={16} className={iconColor} />}
-                                                    {key === 'teachers' && <UserCog size={16} className={iconColor} />}
-                                                    {key === 'videos' && <Play size={16} className={iconColor} />}
-                                                    {key === 'priorities' && <AlertCircle size={16} className={iconColor} />}
-                                                    {key === 'errors' && <AlertTriangle size={16} className={iconColor} />}
-                                                    {key === 'system' && <ShieldAlert size={16} className={iconColor} />}
-                                                </div>
-                                                <div className="min-w-0 text-left">
-                                                    <div className="font-black text-[12px] uppercase tracking-widest truncate">{label}</div>
-                                                    {subtitle && (
-                                                        <div className="text-[11px] text-neutral-400 truncate">
-                                                            {subtitle}
-                                                        </div>
-                                                    )}
-                                                </div>
-                                            </div>
-                                            <ChevronDown
-                                                size={16}
-                                                className={`transition-transform text-neutral-500 ${isActive ? 'rotate-90' : '-rotate-90'}`}
-                                            />
-                                        </button>
-                                    );
-                                })}
-                            </div>
-                        </div>
-                    </div>
-                </div>
-            )}
-
-			<div className="flex-1 min-h-0 overflow-y-auto p-4 pb-20 pb-safe">
-				{tab === 'dashboard' && !selectedStudent && (
-					<div className="w-full">
-						<div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
-							<div
-								className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-								onClick={() => { setTab('students'); setSelectedStudent(null); }}
-							>
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Total Alunos</h3>
-								<p className="text-3xl font-black text-white mt-1">{totalStudents}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Clique para ir direto à aba Alunos.</p>
-							</div>
-							<div className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800">
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Com Professor</h3>
-								<p className="text-3xl font-black text-green-400 mt-1">{studentsWithTeacher}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Alunos vinculados a pelo menos um professor.</p>
-							</div>
-							<div
-								className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-								onClick={() => { setTab('students'); setSelectedStudent(null); }}
-							>
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Sem Professor</h3>
-								<p className="text-3xl font-black text-yellow-500 mt-1">{studentsWithoutTeacher}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Alunos aguardando vínculo ou triagem.</p>
-							</div>
-							<div
-								className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-								onClick={() => { setTab('templates'); setSelectedStudent(null); }}
-							>
-								<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Treinos Criados</h3>
-								<p className="text-3xl font-black text-white mt-1">{myWorkoutsCount ?? '-'}</p>
-								<p className="mt-2 text-[11px] text-neutral-500">Modelos de treino disponíveis para uso imediato.</p>
-							</div>
-							{isAdmin && (
-								<div
-									className="bg-neutral-900 p-4 rounded-2xl border border-neutral-800 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-									onClick={() => { setTab('teachers'); setSelectedStudent(null); }}
-								>
-									<h3 className="text-neutral-400 text-[11px] font-bold uppercase tracking-widest">Professores Ativos</h3>
-									<p className="text-3xl font-black text-white mt-1">{totalTeachers}</p>
-									<p className="mt-2 text-[11px] text-neutral-500">Gestão completa na aba Professores.</p>
-								</div>
-							)}
-						</div>
-
-						<div className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
-							<div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)] h-64">
-								<div className="flex items-center justify-between gap-3 mb-3">
-									<div>
-										<h3 className="text-[11px] font-black uppercase tracking-widest text-neutral-400">Distribuição Alunos</h3>
-										<p className="text-[11px] text-neutral-500 mt-1">Com professor vs sem professor.</p>
-									</div>
-									<div className="text-[11px] text-neutral-500 font-semibold">
-										{dashboardCharts.totalStudents} total
-									</div>
-								</div>
-								<div className="h-[180px]">
-									{dashboardCharts?.teacherDistribution && (
-										<Bar data={dashboardCharts.teacherDistribution.data} options={dashboardCharts.teacherDistribution.options} />
-									)}
-								</div>
-							</div>
-							<div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)] h-64">
-								<div className="flex items-center justify-between gap-3 mb-3">
-									<div>
-										<h3 className="text-[11px] font-black uppercase tracking-widest text-neutral-400">Status de Pagamento</h3>
-										<p className="text-[11px] text-neutral-500 mt-1">Distribuição rápida por status financeiro.</p>
-									</div>
-									<div className="text-[11px] text-neutral-500 font-semibold">
-										{dashboardCharts.statusTotal} registros
-									</div>
-								</div>
-								<div className="h-[180px]">
-									{dashboardCharts?.statusDistribution && (
-										<Bar data={dashboardCharts.statusDistribution.data} options={dashboardCharts.statusDistribution.options} />
-									)}
-								</div>
-							</div>
-						</div>
-						
-						{isTeacher && coachInboxItems.length > 0 && (
-							<div data-tour="adminpanel.dashboard.coachInbox" className="mt-6 bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3 mb-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Coach Inbox</div>
-                                        <div className="text-xs text-neutral-400 mt-1">
-                                            Alunos que mais precisam de atenção com base na atividade recente.
-                                        </div>
-                                    </div>
-                                    <div className="text-[11px] font-bold text-neutral-400">
-                                        {coachInboxItems.length} prioridade{coachInboxItems.length > 1 ? 's' : ''}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-2">
-                                    {coachInboxItems.map((item) => (
-                                        <button
-                                            key={item.id}
-                                            type="button"
-                                            onClick={() => {
-                                                const list = Array.isArray(usersList) ? usersList : [];
-                                                const target = list.find((s) => s && s.id === item.id);
-                                                if (target) setSelectedStudent(target);
-                                            }}
-                                            className="w-full text-left bg-neutral-900 border border-neutral-800 hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 rounded-2xl px-3 py-3 flex items-center justify-between gap-3 transition-all duration-300 active:scale-[0.99]"
-                                        >
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-full bg-neutral-950 border border-neutral-700 flex items-center justify-center text-xs font-black text-neutral-200 flex-shrink-0">
-                                                    {(item.name || item.email || '?').slice(0, 2).toUpperCase()}
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-sm font-semibold text-white truncate">{item.name || item.email}</div>
-                                                    <div className="text-[11px] text-neutral-500 truncate">{item.email}</div>
-                                                </div>
-                                            </div>
-                                            <div className="flex flex-col items-end gap-1 flex-shrink-0">
-                                                <div
-                                                    className={
-                                                        item.hasWorkouts
-                                                            ? 'px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-yellow-500/10 text-yellow-400 border border-yellow-500/40'
-                                                            : 'px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-500/10 text-red-400 border border-red-500/40'
-                                                    }
-                                                >
-                                                    {item.hasWorkouts
-                                                        ? `${item.daysSinceLastWorkout ?? 0}d sem treino`
-                                                        : 'Nenhum treino registrado'}
-                                                </div>
-                                                <div className="text-[10px] text-neutral-500 font-semibold capitalize truncate">
-                                                    Status: {String(item.status || 'pendente')}
-                                                </div>
-                                            </div>
-                                        </button>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-                    </div>
-                )}
-
-				{tab === 'priorities' && !selectedStudent && (
-					<div className="w-full space-y-4">
-						<div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-							<div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-								<div className="min-w-0">
-									<div className="flex items-center gap-2">
-										<AlertCircle size={18} className="text-yellow-500" />
-										<h2 className="text-base md:text-lg font-black tracking-tight">Prioridades</h2>
-									</div>
-									<div className="mt-1 text-xs text-neutral-400 font-semibold">
-										{prioritiesLoading ? 'Carregando...' : `${Array.isArray(prioritiesItems) ? prioritiesItems.length : 0} item(ns)`}
-									</div>
-								</div>
-								<div className="flex flex-col sm:flex-row gap-2">
-									<button
-										type="button"
-										onClick={async () => {
-											try {
-												setPrioritiesSettingsOpen(true);
-												await loadPrioritiesSettings();
-											} catch {}
-										}}
-										className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95"
-									>
-										Configurar
-									</button>
-									<button
-										type="button"
-										onClick={() => fetchPriorities()}
-										disabled={prioritiesLoading}
-										className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 disabled:opacity-60"
-									>
-										Atualizar
-									</button>
-								</div>
-							</div>
-						</div>
-
-						{prioritiesError ? (
-							<div className="bg-neutral-900/60 border border-red-500/30 rounded-2xl p-4 text-red-200 font-bold text-sm">
-								{prioritiesError}
-							</div>
-						) : null}
-
-						{prioritiesLoading ? (
-							<div className="text-center animate-pulse text-neutral-400 font-semibold">Carregando prioridades...</div>
-						) : !Array.isArray(prioritiesItems) || prioritiesItems.length === 0 ? (
-							<div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 text-neutral-400 font-semibold">
-								Nenhuma prioridade no momento.
-							</div>
-						) : (
-							<div className="space-y-3">
-								{prioritiesItems.map((it) => {
-									const itemId = String(it?.id || '').trim();
-									const studentId = String(it?.student_user_id || '').trim();
-									const studentName = String(it?.student_name || '').trim();
-									const kind = String(it?.kind || '').trim();
-									const title = String(it?.title || '').trim();
-									const reason = String(it?.reason || '').trim();
-									const msg = String(it?.suggested_message || '').trim();
-									const badgeTone =
-										kind === 'load_spike'
-											? 'border-red-500/30 text-red-300'
-											: kind === 'checkins_alert'
-												? 'border-red-500/30 text-red-300'
-											: kind === 'volume_drop'
-												? 'border-yellow-500/30 text-yellow-300'
-												: 'border-neutral-500/30 text-neutral-200';
-									return (
-										<div key={itemId || `${studentId}:${kind}`} className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-											<div className="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
-												<div className="min-w-0">
-													<div className="flex flex-wrap items-center gap-2">
-														<div className="text-base font-black text-white truncate">{studentName || 'Aluno'}</div>
-														<span className={`px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${badgeTone}`}>{title || kind}</span>
-													</div>
-													{reason ? (
-														<div className="mt-1 text-xs text-neutral-400 font-semibold">{reason}</div>
-													) : null}
-												</div>
-												<div className="flex flex-col sm:flex-row gap-2">
-													<button
-														type="button"
-														onClick={() => {
-															try {
-																const found = (Array.isArray(usersList) ? usersList : []).find((s) => String(s?.user_id || '').trim() === studentId);
-																setTab('students');
-																setSelectedStudent(found || null);
-																if (!found) setStudentQuery(studentName || '');
-															} catch {}
-														}}
-														className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Ver aluno
-													</button>
-													<button
-														type="button"
-														onClick={() => {
-															setPrioritiesComposeStudentId(studentId);
-															setPrioritiesComposeKind(kind);
-															setPrioritiesComposeText(msg);
-															setPrioritiesComposeOpen(true);
-														}}
-														className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Enviar mensagem
-													</button>
-													<button
-														type="button"
-														onClick={async () => {
-															try {
-																const v = await prompt('Sonecar (minutos)', String(prioritiesSettings?.snoozeDefaultMinutes ?? COACH_INBOX_DEFAULTS.snoozeDefaultMinutes));
-																const minutes = Number(String(v || '').trim());
-																if (!Number.isFinite(minutes) || minutes <= 0) return;
-																const res = await fetch('/api/teacher/inbox/action', {
-																	method: 'POST',
-																	credentials: 'include',
-																	headers: { 'content-type': 'application/json' },
-																	body: JSON.stringify({ student_user_id: studentId, kind, action: 'snooze', snooze_minutes: minutes }),
-																});
-																const json = await res.json().catch(() => null);
-																if (!res.ok || !json?.ok) {
-																	await alert(String(json?.error || `Falha ao sonecar (${res.status})`));
-																	return;
-																}
-																setPrioritiesItems((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== itemId) : prev));
-															} catch (e) {
-																await alert('Erro: ' + (e?.message ?? String(e)));
-															}
-														}}
-														className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Sonecar
-													</button>
-													<button
-														type="button"
-														onClick={async () => {
-															try {
-																const ok = await confirm('Concluir este item?', 'Prioridades');
-																if (!ok) return;
-																const res = await fetch('/api/teacher/inbox/action', {
-																	method: 'POST',
-																	credentials: 'include',
-																	headers: { 'content-type': 'application/json' },
-																	body: JSON.stringify({ student_user_id: studentId, kind, action: 'done' }),
-																});
-																const json = await res.json().catch(() => null);
-																if (!res.ok || !json?.ok) {
-																	await alert(String(json?.error || `Falha ao concluir (${res.status})`));
-																	return;
-																}
-																setPrioritiesItems((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== itemId) : prev));
-															} catch (e) {
-																await alert('Erro: ' + (e?.message ?? String(e)));
-															}
-														}}
-														className="min-h-[44px] px-4 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-black transition-all duration-300 active:scale-95"
-													>
-														Concluir
-													</button>
-												</div>
-											</div>
-										</div>
-									);
-								})}
-							</div>
-						)}
-					</div>
-				)}
-
-				{tab === 'students' && !selectedStudent && (
-					<div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <UserCog size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Alunos</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                        {totalStudents} no total • {studentsWithTeacher} com professor • {studentsWithoutTeacher} sem professor
-                                    </div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        data-tour="adminpanel.students.create"
-                                        onClick={() => setShowRegisterModal(true)}
-                                        className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95"
-                                    >
-                                        <UserPlus size={18} /> CADASTRAR
-                                    </button>
-                                </div>
-                            </div>
-                            <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-2">
-                                <div className="relative lg:col-span-2">
-                                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                    <input
-                                        data-tour="adminpanel.students.search"
-                                        value={studentQuery}
-                                        onChange={(e) => setStudentQuery(e.target.value)}
-                                        placeholder="Buscar aluno por nome ou email"
-                                        className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                    />
-                                </div>
-                                <div data-tour="adminpanel.students.statusFilter" className="flex items-center gap-2 overflow-x-auto no-scrollbar">
-                                    {[
-                                        { key: 'all', label: 'Todos' },
-                                        { key: 'pago', label: 'Pago' },
-                                        { key: 'pendente', label: 'Pendente' },
-                                        { key: 'atrasado', label: 'Atrasado' },
-                                        { key: 'cancelar', label: 'Cancelar' }
-                                    ].map((opt) => (
-                                        <button
-                                            key={opt.key}
-                                            type="button"
-                                            onClick={() => setStudentStatusFilter(opt.key)}
-                                            className={`whitespace-nowrap min-h-[40px] px-3 py-2 rounded-full text-[11px] font-black uppercase tracking-wide border transition-all duration-300 active:scale-95 ${
-                                                studentStatusFilter === opt.key
-                                                    ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/15'
-                                                    : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            {opt.label}
-                                        </button>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-
-                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
-                            <div className="space-y-3">
-                                <div className="flex items-center justify-between gap-3">
-                                    <h3 className="text-xs font-black uppercase tracking-widest text-neutral-500">Com Professor</h3>
-                                    <span className="text-[11px] font-bold text-neutral-400">{studentsWithTeacherFiltered.length}</span>
-                                </div>
-                                {studentsWithTeacherFiltered.length === 0 ? (
-                                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-4">
-                                        <p className="text-neutral-500 text-sm">Nenhum aluno encontrado.</p>
-                                    </div>
-                                ) : (
-                                    <div className="space-y-3">
-                                        {studentsWithTeacherFiltered.map(s => (
-                                            <div key={s.id} onClick={() => setSelectedStudent(s)} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300 cursor-pointer w-full max-w-[100vw] overflow-hidden">
-                                                <div className="flex items-center gap-4">
-                                                    <div className="w-12 h-12 rounded-full bg-neutral-900 border border-neutral-700 flex items-center justify-center font-black text-lg text-neutral-200 flex-shrink-0">{(s.name || s.email || '?')[0]}</div>
-                                                    <div className="min-w-0 flex-1">
-                                                        <h3 className="font-black text-white truncate">{s.name || s.email}</h3>
-                                                        <p className="text-xs text-neutral-400 truncate">{s.email}</p>
-                                                    </div>
-                                                </div>
-
-                                                <div className="mt-3 flex flex-col sm:flex-row sm:items-center gap-2">
-                                                    <span className="px-3 py-1.5 rounded-full text-[11px] font-black uppercase tracking-wide bg-yellow-500/10 text-yellow-400 border border-yellow-500/30 w-fit">
-                                                        {isTeacher && s.teacher_id === user.id ? 'Seu aluno' : 'Vinculado'}
-                                                    </span>
-                                                    {(isAdmin || (isTeacher && s.teacher_id === user.id)) && (
-                                                        <select
-                                                            value={s.status || 'pendente'}
-                                                            onClick={(e) => e.stopPropagation()}
-                                                            onPointerDown={(e) => e.stopPropagation()}
-                                                            onMouseDown={(e) => e.stopPropagation()}
-                                                            onChange={async (e) => {
-                                                                const newStatus = e.target.value;
-                                                                try {
-                                                                    const authHeaders = await getAdminAuthHeaders();
-                                                                    const res = await fetch('/api/admin/students/status', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders }, body: JSON.stringify({ id: s.id, status: newStatus }) });
-                                                                    const json = await res.json();
-                                                                    if (json.ok) setUsersList(prev => prev.map(x => x.id === s.id ? { ...x, status: newStatus } : x));
-                                                                } catch {}
-                                                            }}
-                                                            className="min-h-[40px] bg-neutral-900/70 text-neutral-200 rounded-xl px-3 py-2 text-xs w-full sm:w-auto max-w-full border border-neutral-700 focus:border-yellow-500 focus:outline-none"
-                                                        >
-                                                            <option value="pago">pago</option>
-                                                            <option value="pendente">pendente</option>
-                                                            <option value="atrasado">atrasado</option>
-                                                            <option value="cancelar">cancelar</option>
-                                                        </select>
-                                                    )}
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                            </div>
-
-                            <div className="space-y-3">
-                                <div className="flex items-center justify-between gap-3">
-                                    <h3 className="text-xs font-black uppercase tracking-widest text-neutral-500">Sem Professor</h3>
-                                    <span className="text-[11px] font-bold text-neutral-400">{studentsWithoutTeacherFiltered.length}</span>
-                                </div>
-                                {studentsWithoutTeacherFiltered.length === 0 ? (
-                                    <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-4">
-                                        <p className="text-neutral-500 text-sm">Nenhum aluno encontrado.</p>
-                                    </div>
-                                ) : (
-                                    <div className="space-y-3">
-                                        {studentsWithoutTeacherFiltered.map(s => (
-                                            <div key={s.id} onClick={() => setSelectedStudent(s)} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300 cursor-pointer w-full max-w-[100vw] overflow-hidden">
-                                                <div className="flex items-center gap-4">
-                                                    <div className="w-12 h-12 rounded-full bg-neutral-900 border border-neutral-700 flex items-center justify-center font-black text-lg text-neutral-200 flex-shrink-0">{(s.name || s.email || '?')[0]}</div>
-                                                    <div className="min-w-0 flex-1">
-                                                        <h3 className="font-black text-white truncate">{s.name || s.email}</h3>
-                                                        <p className="text-xs text-neutral-400 truncate">{s.email}</p>
-                                                    </div>
-                                                </div>
-
-                                                <div className="mt-3 flex flex-wrap items-center gap-2">
-                                                    <span className="px-3 py-1.5 rounded-full text-[11px] font-black uppercase tracking-wide bg-neutral-900 text-neutral-300 border border-neutral-700 w-fit">Sem professor</span>
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-				{tab === 'templates' && !selectedStudent && (
-					<div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <Dumbbell size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Treinos</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{(Array.isArray(templates) ? templates.length : 0)} no total</div>
-                                </div>
-                                <div className="text-[11px] font-bold text-neutral-400">{templatesFiltered.length} visíveis</div>
-                            </div>
-                            <div className="mt-4 relative">
-                                <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                <input
-                                    value={templateQuery}
-                                    onChange={(e) => setTemplateQuery(e.target.value)}
-                                    placeholder="Buscar treino por nome"
-                                    className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                />
-                            </div>
-                        </div>
-
-                        {templatesFiltered.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhum treino encontrado.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {templatesFiltered.map(t => (
-                                    <div
-                                        key={t.id}
-                                        className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 flex justify-between items-center cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-                                        onClick={() => openEditTemplate(t)}
-                                    >
-                                        <div className="min-w-0">
-                                            <h3 className="font-black text-white truncate">{normalizeWorkoutTitle(t.name)}</h3>
-                                            <p className="text-xs text-neutral-500">{t.exercises?.length || 0} exercícios</p>
-                                        </div>
-                                        <div className="flex items-center gap-2 flex-shrink-0">
-                                            <button
-                                                onClick={(e) => { e.stopPropagation(); openEditTemplate(t); }}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-yellow-500/40 hover:bg-yellow-500/10 text-neutral-300 hover:text-yellow-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Edit3 size={16} />
-                                            </button>
-                                            <button
-                                                onClick={async (e) => {
-                                                    e.stopPropagation();
-                                                    if (!(await confirm('Excluir este treino?', 'Apagar Treino'))) return;
-                                                    try {
-                                                        if (templatesUserId && t?.user_id && String(t.user_id) !== String(templatesUserId)) {
-                                                            await alert('Esse treino pertence a um aluno. Para não apagar o treino dele, a exclusão aqui é bloqueada.');
-                                                            return;
-                                                        }
-                                                        const res = await deleteWorkout(t.id);
-                                                        if (!res?.success) {
-                                                            await alert('Erro ao excluir: ' + (res?.error || 'Falha ao excluir treino'));
-                                                            return;
-                                                        }
-                                                        setTemplates(prev => prev.filter(x => x.id !== t.id));
-                                                    } catch (err) { await alert('Erro ao excluir: ' + (err?.message ?? String(err))); }
-                                                }}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-red-500/40 hover:bg-red-900/20 text-neutral-300 hover:text-red-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Trash2 size={16} />
-                                            </button>
-                                        </div>
-                                    </div>
-                                ))}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'requests' && !selectedStudent && isAdmin && (
-                    <RequestsTab />
-                )}
-
-                {tab === 'videos' && !selectedStudent && isAdmin && (
-                    <div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <Play size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Vídeos (Fila)</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{videoQueue.length} pendentes</div>
-                                </div>
-                            </div>
-
-                            <div className="mt-3 rounded-2xl bg-neutral-950/60 border border-neutral-800 p-3 flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Diagnóstico</div>
-                                    <div className="text-xs text-neutral-300 font-semibold">
-                                        {videoMissingLoading
-                                            ? 'Calculando exercícios sem vídeo...'
-                                            : (typeof videoMissingCount === 'number'
-                                                ? `${videoMissingCount} exercícios sem vídeo (estimativa)`
-                                                : 'Não foi possível calcular agora')}
-                                    </div>
-                                    {videoCycleRunning ? (
-                                        <div className="mt-1 text-[11px] text-neutral-500 font-semibold">
-                                            Ciclo: processados {videoCycleStats.processed} • criados {videoCycleStats.created} • pulados {videoCycleStats.skipped}
-                                        </div>
-                                    ) : null}
-                                </div>
-                                <div className="flex items-center gap-2 flex-shrink-0">
-                                    {typeof videoMissingCount === 'number' && videoMissingCount > 0 ? (
-                                        <button
-                                            type="button"
-                                            disabled={videoLoading || videoCycleRunning}
-                                            onClick={async () => {
-                                                const limit = Math.max(1, Math.min(50, Math.min(videoMissingCount, Number(videoBackfillLimit) || 20)));
-                                                if (!(await confirm(`Gerar sugestões para até ${limit} exercícios sem vídeo?`, 'Gerar Sugestões (lote)'))) return;
-                                                setVideoLoading(true);
-                                                try {
-                                                    const authHeaders = await getAdminAuthHeaders();
-                                                    const res = await fetch('/api/admin/exercise-videos/backfill', {
-                                                        method: 'POST',
-                                                        headers: { 'Content-Type': 'application/json', ...authHeaders },
-                                                        body: JSON.stringify({ limit }),
-                                                    });
-                                                    const json = await res.json().catch(() => ({}));
-                                                    if (!json?.ok) throw new Error(json?.error || 'Falha no backfill');
-                                                    const { data, error } = await supabase
-                                                        .from('exercise_videos')
-                                                        .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                        .eq('status', 'pending')
-                                                        .order('created_at', { ascending: false })
-                                                        .limit(60);
-                                                    if (!error) setVideoQueue(data || []);
-                                                    await alert(`Criados: ${json.created ?? 0} | Processados: ${json.processed ?? 0} | Pulados: ${json.skipped ?? 0}`);
-                                                } catch (e) {
-                                                    await alert('Erro: ' + (e?.message ?? String(e)));
-                                                } finally {
-                                                    setVideoLoading(false);
-                                                }
-                                            }}
-                                            className="min-h-[40px] px-4 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black font-black text-[11px] uppercase tracking-widest border border-yellow-400/60 active:scale-95 transition-all disabled:opacity-50"
-                                        >
-                                            Gerar Lote
-                                        </button>
-                                    ) : null}
-
-                                    {!videoCycleRunning && typeof videoMissingCount === 'number' && videoMissingCount > 0 ? (
-                                        <button
-                                            type="button"
-                                            disabled={videoLoading}
-                                            onClick={async () => {
-                                                const perCycle = Math.max(1, Math.min(50, Number(videoBackfillLimit) || 20));
-                                                if (!(await confirm(`Rodar backfill em ciclos de ${perCycle} até acabar?`, 'Backfill contínuo'))) return;
-                                                videoCycleStopRef.current = false;
-                                                setVideoCycleRunning(true);
-                                                setVideoCycleStats({ processed: 0, created: 0, skipped: 0 });
-                                                try {
-                                                    while (!videoCycleStopRef.current) {
-                                                        const authHeaders = await getAdminAuthHeaders();
-                                                        const res = await fetch('/api/admin/exercise-videos/backfill', {
-                                                            method: 'POST',
-                                                            headers: { 'Content-Type': 'application/json', ...authHeaders },
-                                                            body: JSON.stringify({ limit: perCycle }),
-                                                        });
-                                                        const json = await res.json().catch(() => ({}));
-                                                        if (!json?.ok) throw new Error(json?.error || 'Falha no backfill');
-
-                                                        setVideoCycleStats((prev) => ({
-                                                            processed: prev.processed + (json.processed ?? 0),
-                                                            created: prev.created + (json.created ?? 0),
-                                                            skipped: prev.skipped + (json.skipped ?? 0),
-                                                        }));
-
-                                                        if ((json.processed ?? 0) <= 0 || (json.created ?? 0) <= 0) break;
-                                                    }
-                                                    const { data, error } = await supabase
-                                                        .from('exercise_videos')
-                                                        .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                        .eq('status', 'pending')
-                                                        .order('created_at', { ascending: false })
-                                                        .limit(60);
-                                                    if (!error) setVideoQueue(data || []);
-                                                } catch (e) {
-                                                    await alert('Erro: ' + (e?.message ?? String(e)));
-                                                } finally {
-                                                    setVideoCycleRunning(false);
-                                                }
-                                            }}
-                                            className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all disabled:opacity-50"
-                                        >
-                                            Rodar contínuo
-                                        </button>
-                                    ) : null}
-
-                                    {videoCycleRunning ? (
-                                        <button
-                                            type="button"
-                                            onClick={() => {
-                                                videoCycleStopRef.current = true;
-                                            }}
-                                            className="min-h-[40px] px-4 py-2 rounded-xl bg-red-900/30 border border-red-700 hover:bg-red-900/40 text-red-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all"
-                                        >
-                                            Pausar
-                                        </button>
-                                    ) : null}
-                                </div>
-                            </div>
-
-                            <div className="mt-4 flex flex-col sm:flex-row gap-2">
-                                <input
-                                    value={videoExerciseName}
-                                    onChange={(e) => setVideoExerciseName(e.target.value)}
-                                    placeholder="Ex.: Supino reto com barra"
-                                    className="flex-1 min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-4 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                />
-                                <button
-                                    type="button"
-                                    disabled={videoLoading || !String(videoExerciseName || '').trim()}
-                                    onClick={async () => {
-                                        const name = String(videoExerciseName || '').trim();
-                                        if (!name) return;
-                                        setVideoLoading(true);
-                                        try {
-                                            const authHeaders = await getAdminAuthHeaders();
-                                            const res = await fetch('/api/admin/exercise-videos/suggest', {
-                                                method: 'POST',
-                                                headers: { 'Content-Type': 'application/json', ...authHeaders },
-                                                body: JSON.stringify({ name }),
-                                            });
-                                            const json = await res.json().catch(() => ({}));
-                                            if (!json?.ok) throw new Error(json?.error || 'Falha ao gerar sugestões');
-                                            setVideoExerciseName('');
-                                            const { data, error } = await supabase
-                                                .from('exercise_videos')
-                                                .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                .eq('status', 'pending')
-                                                .order('created_at', { ascending: false })
-                                                .limit(60);
-                                            if (!error) setVideoQueue(data || []);
-                                            await alert(`Sugestões criadas: ${json?.created ?? 0}`);
-                                        } catch (e) {
-                                            await alert('Erro: ' + (e?.message ?? String(e)));
-                                        } finally {
-                                            setVideoLoading(false);
-                                        }
-                                    }}
-                                    className="w-full sm:w-auto min-h-[44px] px-5 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-yellow-500 hover:bg-yellow-400 text-black border border-yellow-400/60 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-all"
-                                >
-                                    {videoLoading ? 'Gerando...' : 'Gerar Sugestões'}
-                                </button>
-                            </div>
-
-                            <div className="mt-3 flex flex-col sm:flex-row gap-2">
-                                <input
-                                    value={videoBackfillLimit}
-                                    onChange={(e) => setVideoBackfillLimit(e.target.value)}
-                                    inputMode="numeric"
-                                    placeholder="20"
-                                    className="w-full sm:w-28 min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-4 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                />
-                                <button
-                                    type="button"
-                                    disabled={videoLoading}
-                                    onClick={async () => {
-                                        const limit = Math.max(1, Math.min(50, Number(videoBackfillLimit) || 20));
-                                        if (!(await confirm(`Gerar sugestões em lote para até ${limit} exercícios sem vídeo?`, 'Backfill de Vídeos'))) return;
-                                        setVideoLoading(true);
-                                        try {
-                                            const authHeaders = await getAdminAuthHeaders();
-                                            const res = await fetch('/api/admin/exercise-videos/backfill', {
-                                                method: 'POST',
-                                                headers: { 'Content-Type': 'application/json', ...authHeaders },
-                                                body: JSON.stringify({ limit }),
-                                            });
-                                            const json = await res.json().catch(() => ({}));
-                                            if (!json?.ok) throw new Error(json?.error || 'Falha no backfill');
-                                            const { data, error } = await supabase
-                                                .from('exercise_videos')
-                                                .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                .eq('status', 'pending')
-                                                .order('created_at', { ascending: false })
-                                                .limit(60);
-                                            if (!error) setVideoQueue(data || []);
-                                            await alert(`Backfill concluído. Processados: ${json.processed ?? 0} | Criados: ${json.created ?? 0} | Pulados: ${json.skipped ?? 0}`);
-                                        } catch (e) {
-                                            await alert('Erro no backfill: ' + (e?.message ?? String(e)));
-                                        } finally {
-                                            setVideoLoading(false);
-                                        }
-                                    }}
-                                    className="w-full sm:w-auto min-h-[44px] px-5 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 text-yellow-400 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transition-all"
-                                >
-                                    {videoLoading ? 'Executando...' : 'Backfill (lote)'}
-                                </button>
-                                <div className="text-[11px] text-neutral-500 font-semibold flex items-center px-1">
-                                    Limite por execução (1–50)
-                                </div>
-                            </div>
-                        </div>
-
-                        {videoLoading && videoQueue.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Carregando fila...</p>
-                            </div>
-                        ) : videoQueue.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhuma sugestão pendente.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {(videoQueue || []).map((row) => {
-                                    const exName = String(row?.exercise_library?.display_name_pt || row?.normalized_name || '').trim() || 'Exercício';
-                                    const title = String(row?.title || '').trim() || 'Vídeo';
-                                    const channel = String(row?.channel_title || '').trim();
-                                    const url = String(row?.url || '').trim();
-                                    const exerciseLibraryId = row?.exercise_library_id || null;
-                                    return (
-                                        <div
-                                            key={row.id}
-                                            className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700 flex flex-col gap-3"
-                                        >
-                                            <div className="flex items-start justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Exercício</div>
-                                                    <div className="font-black text-white truncate">{exName}</div>
-                                                    <div className="mt-2 text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Sugestão</div>
-                                                    <div className="text-sm text-neutral-200 truncate">{title}</div>
-                                                    {channel ? <div className="text-xs text-neutral-500 truncate">{channel}</div> : null}
-                                                    {url ? (
-                                                        <button
-                                                            type="button"
-                                                            onClick={(e) => {
-                                                                try {
-                                                                    e.preventDefault();
-                                                                    e.stopPropagation();
-                                                                } catch {}
-                                                                try {
-                                                                    window.open(url, '_blank', 'noopener,noreferrer');
-                                                                } catch {}
-                                                            }}
-                                                            className="mt-2 inline-flex items-center gap-2 text-yellow-400 hover:text-yellow-300 text-xs font-bold"
-                                                        >
-                                                            <Play size={14} />
-                                                            Abrir no YouTube
-                                                        </button>
-                                                    ) : null}
-                                                </div>
-                                                <div className="flex items-center gap-2 flex-shrink-0">
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            if (!exerciseLibraryId) return;
-                                                            setVideoLoading(true);
-                                                            try {
-                                                                await supabase
-                                                                    .from('exercise_videos')
-                                                                    .update({ is_primary: false })
-                                                                    .eq('exercise_library_id', exerciseLibraryId);
-                                                                const { error } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .update({ status: 'approved', is_primary: true, approved_at: new Date().toISOString() })
-                                                                    .eq('id', row.id);
-                                                                if (error) throw error;
-                                                                await supabase
-                                                                    .from('exercise_library')
-                                                                    .update({ video_url: url })
-                                                                    .eq('id', exerciseLibraryId);
-                                                                const { data, error: refreshErr } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                                    .eq('status', 'pending')
-                                                                    .order('created_at', { ascending: false })
-                                                                    .limit(60);
-                                                                if (!refreshErr) setVideoQueue(data || []);
-                                                                await alert('Vídeo aprovado e definido como padrão.');
-                                                            } catch (e) {
-                                                                await alert('Erro ao aprovar: ' + (e?.message ?? String(e)));
-                                                            } finally {
-                                                                setVideoLoading(false);
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl bg-green-600 hover:bg-green-500 text-white font-black text-[11px] uppercase tracking-widest border border-green-400/40 active:scale-95 transition-all disabled:opacity-50"
-                                                        disabled={videoLoading}
-                                                    >
-                                                        Aprovar
-                                                    </button>
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            setVideoLoading(true);
-                                                            try {
-                                                                const { error } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .update({ status: 'rejected', is_primary: false })
-                                                                    .eq('id', row.id);
-                                                                if (error) throw error;
-                                                                const { data, error: refreshErr } = await supabase
-                                                                    .from('exercise_videos')
-                                                                    .select('id, url, title, channel_title, created_at, exercise_library_id, exercise_library:exercise_library_id(display_name_pt)')
-                                                                    .eq('status', 'pending')
-                                                                    .order('created_at', { ascending: false })
-                                                                    .limit(60);
-                                                                if (!refreshErr) setVideoQueue(data || []);
-                                                            } catch (e) {
-                                                                await alert('Erro ao rejeitar: ' + (e?.message ?? String(e)));
-                                                            } finally {
-                                                                setVideoLoading(false);
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all disabled:opacity-50"
-                                                        disabled={videoLoading}
-                                                    >
-                                                        Rejeitar
-                                                    </button>
-                                                </div>
-                                            </div>
-                                        </div>
-                                    );
-                                })}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'errors' && !selectedStudent && isAdmin && (
-                    <div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-center justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <AlertTriangle size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Erros reportados</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{errorsFiltered.length} visíveis</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={async () => {
-                                        setErrorsLoading(true);
-                                        try {
-                                            const { data, error } = await supabase
-                                                .from('error_reports')
-                                                .select('id, user_id, user_email, message, stack, pathname, url, user_agent, app_version, source, meta, status, created_at, updated_at, resolved_at, resolved_by')
-                                                .order('created_at', { ascending: false })
-                                                .limit(200);
-                                            if (!error) setErrorReports(Array.isArray(data) ? data : []);
-                                        } catch {} finally {
-                                            setErrorsLoading(false);
-                                        }
-                                    }}
-                                    disabled={errorsLoading}
-                                    className="min-h-[40px] px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-800 hover:bg-neutral-800 text-neutral-200 font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all disabled:opacity-50"
-                                >
-                                    {errorsLoading ? 'Atualizando...' : 'Atualizar'}
-                                </button>
-                            </div>
-
-                            <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
-                                <div className="md:col-span-2 relative">
-                                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                    <input
-                                        value={errorsQuery}
-                                        onChange={(e) => setErrorsQuery(e.target.value)}
-                                        placeholder="Buscar por mensagem, usuário ou rota"
-                                        className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                    />
-                                </div>
-                                <select
-                                    value={errorsStatusFilter}
-                                    onChange={(e) => setErrorsStatusFilter(e.target.value)}
-                                    className="min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-yellow-500"
-                                >
-                                    <option value="all">Todos</option>
-                                    <option value="new">Novos</option>
-                                    <option value="triaged">Triados</option>
-                                    <option value="resolved">Resolvidos</option>
-                                    <option value="ignored">Ignorados</option>
-                                </select>
-                            </div>
-                        </div>
-
-                        {errorsLoading ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center text-neutral-400 font-semibold">
-                                Carregando erros...
-                            </div>
-                        ) : errorsFiltered.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhum erro reportado encontrado.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {errorsFiltered.map((r) => {
-                                    const status = String(r?.status || 'new');
-                                    const statusTone =
-                                        status === 'resolved'
-                                            ? 'bg-green-500/10 text-green-400 border-green-500/30'
-                                            : status === 'ignored'
-                                                ? 'bg-neutral-500/10 text-neutral-300 border-neutral-500/25'
-                                                : status === 'triaged'
-                                                    ? 'bg-blue-500/10 text-blue-300 border-blue-500/30'
-                                                    : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/30';
-                                    const createdAt = (() => {
-                                        try {
-                                            const raw = r?.created_at || r?.createdAt;
-                                            if (!raw) return '';
-                                            const d = raw?.toDate ? raw.toDate() : new Date(raw);
-                                            const t = d?.toLocaleString ? d.toLocaleString('pt-BR') : String(raw);
-                                            return t || '';
-                                        } catch {
-                                            return '';
-                                        }
-                                    })();
-                                    const email = String(r?.user_email || r?.userEmail || '').trim();
-                                    const message = String(r?.message || '').trim();
-                                    const pathname = String(r?.pathname || '').trim();
-                                    const stack = String(r?.stack || '').trim();
-
-                                    return (
-                                        <div key={r.id} className="bg-neutral-800 border border-neutral-700 rounded-2xl p-4">
-                                            <div className="flex items-start justify-between gap-3">
-                                                <div className="min-w-0 flex-1">
-                                                    <div className="flex items-center gap-2 flex-wrap">
-                                                        <div className={`px-2 py-1 rounded-full border text-[10px] font-black uppercase tracking-widest ${statusTone}`}>
-                                                            {status}
-                                                        </div>
-                                                        {createdAt ? (
-                                                            <div className="text-[11px] text-neutral-500 font-semibold">{createdAt}</div>
-                                                        ) : null}
-                                                        {email ? (
-                                                            <div className="text-[11px] text-neutral-400 font-semibold truncate max-w-[150px]" title={email}>• {email}</div>
-                                                        ) : null}
-                                                        {pathname ? (
-                                                            <div className="text-[11px] text-neutral-500 font-semibold truncate max-w-[150px]" title={pathname}>• {pathname}</div>
-                                                        ) : null}
-                                                    </div>
-                                                    <div className="mt-2 text-sm text-neutral-100 font-semibold whitespace-pre-wrap break-words pr-2">
-                                                        {message || '—'}
-                                                    </div>
-                                                </div>
-                                                <div className="flex items-center gap-2 flex-shrink-0">
-                                                    <button
-                                                        type="button"
-                                                        onClick={() => {
-                                                            const content = `Erro: ${message}\nUser: ${email}\nPath: ${pathname}\nStack:\n${stack || 'N/A'}`;
-                                                            navigator.clipboard.writeText(content);
-                                                            // Feedback visual rápido seria ideal, mas alert serve por enquanto
-                                                        }}
-                                                        title="Copiar detalhes"
-                                                        className="w-10 h-10 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 text-neutral-400 hover:text-white flex items-center justify-center active:scale-95 transition-all"
-                                                    >
-                                                        <Copy size={16} />
-                                                    </button>
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            try {
-                                                                const nextStatus = status === 'resolved' ? 'new' : 'resolved';
-                                                                const patch = nextStatus === 'resolved'
-                                                                    ? { status: nextStatus, resolved_at: new Date().toISOString(), resolved_by: user?.id ?? null }
-                                                                    : { status: nextStatus, resolved_at: null, resolved_by: null };
-                                                                const { error } = await supabase.from('error_reports').update(patch).eq('id', r.id);
-                                                                if (error) throw error;
-                                                                setErrorReports((prev) => {
-                                                                    const list = Array.isArray(prev) ? prev : [];
-                                                                    return list.map((x) => (x?.id === r.id ? { ...x, ...patch } : x));
-                                                                });
-                                                            } catch (e) {
-                                                                await alert('Erro ao atualizar status: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        className={`min-h-[40px] px-3 py-2 rounded-xl border font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all ${
-                                                            status === 'resolved' 
-                                                            ? 'bg-neutral-900 border-neutral-700 text-neutral-400 hover:bg-neutral-800' 
-                                                            : 'bg-green-500/10 border-green-500/30 text-green-400 hover:bg-green-500/20'
-                                                        }`}
-                                                    >
-                                                        {status === 'resolved' ? 'Reabrir' : 'Resolver'}
-                                                    </button>
-                                                    {status !== 'ignored' && status !== 'resolved' && (
-                                                        <button
-                                                            type="button"
-                                                            onClick={async () => {
-                                                                try {
-                                                                    const { error } = await supabase.from('error_reports').update({ status: 'ignored' }).eq('id', r.id);
-                                                                    if (error) throw error;
-                                                                    setErrorReports((prev) => {
-                                                                        const list = Array.isArray(prev) ? prev : [];
-                                                                        return list.map((x) => (x?.id === r.id ? { ...x, status: 'ignored' } : x));
-                                                                    });
-                                                                } catch (e) {
-                                                                    await alert('Erro ao ignorar: ' + (e?.message ?? String(e)));
-                                                                }
-                                                            }}
-                                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-neutral-800 text-neutral-400 hover:text-white font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all"
-                                                        >
-                                                            Ignorar
-                                                        </button>
-                                                    )}
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            if (!confirm('Tem certeza que deseja apagar este erro permanentemente?')) return;
-                                                            try {
-                                                                const { error } = await supabase.from('error_reports').delete().eq('id', r.id);
-                                                                if (error) throw error;
-                                                                setErrorReports((prev) => {
-                                                                    const list = Array.isArray(prev) ? prev : [];
-                                                                    return list.filter((x) => x?.id !== r.id);
-                                                                });
-                                                            } catch (e) {
-                                                                await alert('Erro ao apagar: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        title="Apagar erro"
-                                                        className="w-10 h-10 rounded-xl bg-neutral-900 border border-neutral-700 hover:bg-red-900/20 hover:border-red-500/30 text-neutral-500 hover:text-red-400 flex items-center justify-center active:scale-95 transition-all"
-                                                    >
-                                                        <Trash2 size={16} />
-                                                    </button>
-                                                </div>
-                                            </div>
-
-                                            {(stack || r?.url) ? (
-                                                <details className="mt-3 group/details">
-                                                    <summary className="cursor-pointer text-[11px] font-black uppercase tracking-widest text-neutral-500 hover:text-white flex items-center gap-2 select-none">
-                                                        <ChevronDown size={14} className="group-open/details:rotate-180 transition-transform" />
-                                                        Detalhes Técnicos
-                                                    </summary>
-                                                    <div className="mt-3 grid gap-3 pl-2 border-l-2 border-neutral-800">
-                                                        {String(r?.url || '').trim() ? (
-                                                            <div className="text-[11px] text-neutral-400 break-all">
-                                                                <span className="font-black text-neutral-300">URL:</span> {String(r.url)}
-                                                            </div>
-                                                        ) : null}
-                                                        {String(r?.source || '').trim() ? (
-                                                            <div className="text-[11px] text-neutral-400 break-all">
-                                                                <span className="font-black text-neutral-300">Fonte:</span> {String(r.source)}
-                                                            </div>
-                                                        ) : null}
-                                                        {String(r?.app_version || r?.appVersion || '').trim() ? (
-                                                            <div className="text-[11px] text-neutral-400 break-all">
-                                                                <span className="font-black text-neutral-300">Versão:</span> {String(r.app_version || r.appVersion)}
-                                                            </div>
-                                                        ) : null}
-                                                        {stack ? (
-                                                            <div className="relative group/stack">
-                                                                <pre className="text-[10px] leading-relaxed font-mono text-neutral-400 whitespace-pre-wrap break-words bg-black/40 border border-neutral-800 rounded-lg p-3 overflow-auto max-h-[300px] custom-scrollbar select-text">
-                                                                    {stack}
-                                                                </pre>
-                                                                <button 
-                                                                    onClick={() => navigator.clipboard.writeText(stack)}
-                                                                    className="absolute top-2 right-2 p-1.5 rounded-md bg-neutral-800 text-neutral-400 hover:text-white opacity-0 group-hover/stack:opacity-100 transition-opacity"
-                                                                    title="Copiar Stack Trace"
-                                                                >
-                                                                    <Copy size={12} />
-                                                                </button>
-                                                            </div>
-                                                        ) : null}
-                                                    </div>
-                                                </details>
-                                            ) : null}
-                                        </div>
-                                    );
-                                })}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'vip_reports' && !selectedStudent && (
-                    <AdminVipReports supabase={supabase} />
-                )}
-
-                {tab === 'system' && !selectedStudent && (
-                    <div className="space-y-8">
-                        <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 space-y-4">
-                            <div className="flex items-start justify-between gap-3">
-                                <div className="min-w-0">
-                                    <h3 className="font-bold text-white flex items-center gap-2">
-                                        <FileText size={20} className="text-yellow-500"/> RELATÓRIO DE USUÁRIOS
-                                    </h3>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                        {userActivitySelected ? `Selecionado: ${String(userActivitySelected?.displayName || userActivitySelected?.email || userActivitySelected?.id || '').trim() || 'Usuário'}` : 'Selecione um usuário para ver o histórico.'}
-                                    </div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => loadUserActivityUsers({ q: userActivityQuery, role: userActivityRole })}
-                                    disabled={userActivityLoading}
-                                    className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 disabled:opacity-50 inline-flex items-center gap-2"
-                                >
-                                    <RefreshCw size={14} />
-                                    {userActivityLoading ? 'Atualizando...' : 'Atualizar'}
-                                </button>
-                            </div>
-
-                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
-                                <div className="space-y-3">
-                                    <div className="flex flex-col sm:flex-row gap-2">
-                                        <div className="flex-1 relative">
-                                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500">
-                                                <Search size={16} />
-                                            </div>
-                                            <input
-                                                value={userActivityQuery}
-                                                onChange={(e) => setUserActivityQuery(e.target.value)}
-                                                placeholder="Buscar por nome ou email"
-                                                className="w-full pl-10 pr-3 py-3 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-bold outline-none focus:border-yellow-500"
-                                            />
-                                        </div>
-                                        <select
-                                            value={userActivityRole}
-                                            onChange={(e) => setUserActivityRole(e.target.value)}
-                                            className="min-h-[44px] px-3 rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-bold outline-none focus:border-yellow-500"
-                                        >
-                                            <option value="all">Todos</option>
-                                            <option value="user">Aluno</option>
-                                            <option value="teacher">Professor</option>
-                                            <option value="admin">Admin</option>
-                                        </select>
-                                    </div>
-
-                                    {userActivityError ? (
-                                        <div className="bg-neutral-900 border border-red-500/30 rounded-xl p-3 text-sm text-red-300">
-                                            {userActivityError}
-                                        </div>
-                                    ) : null}
-
-                                    <div className="space-y-2 max-h-[50vh] overflow-y-auto custom-scrollbar pr-1">
-                                        {(Array.isArray(userActivityUsers) ? userActivityUsers : []).map((u) => {
-                                            const id = String(u?.id || '').trim();
-                                            const isSel = userActivitySelected && String(userActivitySelected?.id || '').trim() === id;
-                                            const name = String(u?.displayName || u?.display_name || u?.email || '').trim() || `Usuário ${id.slice(0, 6)}`;
-                                            const role = String(u?.role || '').trim();
-                                            return (
-                                                <button
-                                                    key={id}
-                                                    type="button"
-                                                    onClick={() => openUserActivityUser(u)}
-                                                    className={`w-full text-left rounded-xl border p-3 flex items-center gap-3 hover:bg-neutral-900/60 ${
-                                                        isSel ? 'border-yellow-500/40 bg-neutral-900/70' : 'border-neutral-700 bg-neutral-900/30'
-                                                    }`}
-                                                >
-                                                    <div className="w-10 h-10 rounded-xl bg-neutral-800 border border-neutral-700 overflow-hidden flex items-center justify-center shrink-0">
-                                                        {String(u?.photoUrl || u?.photo_url || '').trim() ? (
-                                                            <Image src={String(u.photoUrl || u.photo_url)} alt={name} width={40} height={40} className="w-10 h-10 object-cover" />
-                                                        ) : (
-                                                            <UserCog size={18} className="text-neutral-400" />
-                                                        )}
-                                                    </div>
-                                                    <div className="min-w-0 flex-1">
-                                                        <div className="text-sm font-black text-white truncate">{name}</div>
-                                                        <div className="text-[11px] text-neutral-400 font-bold truncate">
-                                                            {role ? role.toUpperCase() : '—'} {String(u?.email || '').trim() ? `· ${String(u.email)}` : ''}
-                                                        </div>
-                                                    </div>
-                                                </button>
-                                            );
-                                        })}
-                                        {!userActivityLoading && (!userActivityUsers || userActivityUsers.length === 0) ? (
-                                            <div className="text-sm text-neutral-400 font-semibold">Nenhum usuário encontrado.</div>
-                                        ) : null}
-                                    </div>
-                                </div>
-
-                                <div className="space-y-4">
-                                    {!userActivitySelected ? (
-                                        <div className="bg-neutral-900/30 border border-neutral-700 rounded-xl p-4 text-sm text-neutral-400 font-semibold">
-                                            Selecione um usuário para ver o relatório.
-                                        </div>
-                                    ) : (
-                                        <>
-                                            <div className="bg-neutral-900/30 border border-neutral-700 rounded-xl p-4 space-y-3">
-                                                <div className="flex items-center justify-between gap-2">
-                                                    <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Resumo</div>
-                                                    <div className="flex items-center gap-2">
-                                                        <button
-                                                            type="button"
-                                                            onClick={() => {
-                                                                setUserActivityDays(7);
-                                                                loadUserActivitySummary({ userId: userActivitySelected?.id, days: 7 });
-                                                            }}
-                                                            className={`min-h-[34px] px-3 rounded-xl text-[11px] font-black uppercase tracking-widest border ${
-                                                                userActivityDays === 7 ? 'bg-yellow-500 text-black border-yellow-400' : 'bg-neutral-900 text-neutral-200 border-neutral-700 hover:bg-neutral-800'
-                                                            }`}
-                                                        >
-                                                            7d
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            onClick={() => {
-                                                                setUserActivityDays(30);
-                                                                loadUserActivitySummary({ userId: userActivitySelected?.id, days: 30 });
-                                                            }}
-                                                            className={`min-h-[34px] px-3 rounded-xl text-[11px] font-black uppercase tracking-widest border ${
-                                                                userActivityDays === 30 ? 'bg-yellow-500 text-black border-yellow-400' : 'bg-neutral-900 text-neutral-200 border-neutral-700 hover:bg-neutral-800'
-                                                            }`}
-                                                        >
-                                                            30d
-                                                        </button>
-                                                        <button
-                                                            type="button"
-                                                            onClick={() => {
-                                                                loadUserActivitySummary({ userId: userActivitySelected?.id, days: userActivityDays });
-                                                                loadUserActivityEvents({ userId: userActivitySelected?.id, reset: true });
-                                                                loadUserActivityErrors({ userId: userActivitySelected?.id });
-                                                            }}
-                                                            className="min-h-[34px] px-3 rounded-xl text-[11px] font-black uppercase tracking-widest bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 inline-flex items-center gap-2"
-                                                        >
-                                                            <RefreshCw size={14} />
-                                                            Recarregar
-                                                        </button>
-                                                    </div>
-                                                </div>
-
-                                                {userActivitySummaryLoading ? (
-                                                    <div className="text-sm text-neutral-400 font-semibold">Carregando resumo...</div>
-                                                ) : userActivitySummary?.ok ? (
-                                                    <div className="space-y-2">
-                                                        <div className="text-[11px] text-neutral-500 font-bold">
-                                                            Eventos no período: <span className="text-neutral-200">{Number(userActivitySummary?.total || 0)}</span>
-                                                        </div>
-                                                        <div className="space-y-1">
-                                                            {(Array.isArray(userActivitySummary?.topEvents) ? userActivitySummary.topEvents : []).slice(0, 10).map((it) => (
-                                                                <div key={it.name} className="flex items-center justify-between gap-3 text-[11px]">
-                                                                    <div className="text-neutral-300 font-bold truncate">{it.name}</div>
-                                                                    <div className="text-neutral-400 font-black tabular-nums">{it.count}</div>
-                                                                </div>
-                                                            ))}
-                                                        </div>
-                                                    </div>
-                                                ) : (
-                                                    <div className="text-sm text-neutral-400 font-semibold">Sem dados no período.</div>
-                                                )}
-                                            </div>
-
-                                            <div className="bg-neutral-900/30 border border-neutral-700 rounded-xl p-4 space-y-3">
-                                                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Timeline</div>
-                                                {userActivityEventsLoading && (!userActivityEvents || userActivityEvents.length === 0) ? (
-                                                    <div className="text-sm text-neutral-400 font-semibold">Carregando eventos...</div>
-                                                ) : (
-                                                    <div className="space-y-2 max-h-[45vh] overflow-y-auto custom-scrollbar pr-1">
-                                                        {(Array.isArray(userActivityEvents) ? userActivityEvents : []).map((ev) => (
-                                                            <div key={ev.id} className="rounded-xl border border-neutral-800 bg-black/30 p-3">
-                                                                <div className="flex items-center justify-between gap-3">
-                                                                    <div className="min-w-0">
-                                                                        <div className="text-sm font-black text-white truncate">{String(ev?.name || '')}</div>
-                                                                        <div className="text-[11px] text-neutral-400 font-bold truncate">
-                                                                            {String(ev?.type || '').trim() ? String(ev.type) : 'evento'} {String(ev?.screen || '').trim() ? `· ${String(ev.screen)}` : ''} {String(ev?.path || '').trim() ? `· ${String(ev.path)}` : ''}
-                                                                        </div>
-                                                                    </div>
-                                                                    <div className="text-[11px] text-neutral-500 font-bold tabular-nums whitespace-nowrap">
-                                                                        {String(ev?.createdAt || '').trim() ? new Date(String(ev.createdAt)).toLocaleString('pt-BR') : ''}
-                                                                    </div>
-                                                                </div>
-                                                            </div>
-                                                        ))}
-                                                        {!userActivityEventsLoading && (!userActivityEvents || userActivityEvents.length === 0) ? (
-                                                            <div className="text-sm text-neutral-400 font-semibold">Sem eventos registrados.</div>
-                                                        ) : null}
-                                                    </div>
-                                                )}
-                                                {userActivityEventsBefore ? (
-                                                    <button
-                                                        type="button"
-                                                        disabled={userActivityEventsLoading}
-                                                        onClick={() => loadUserActivityEvents({ userId: userActivitySelected?.id, before: userActivityEventsBefore })}
-                                                        className="w-full min-h-[40px] rounded-xl bg-neutral-900 border border-neutral-700 text-neutral-200 font-black text-[11px] uppercase tracking-widest hover:bg-neutral-800 disabled:opacity-50"
-                                                    >
-                                                        {userActivityEventsLoading ? 'Carregando...' : 'Carregar mais'}
-                                                    </button>
-                                                ) : null}
-                                            </div>
-
-                                            <div className="bg-neutral-900/30 border border-neutral-700 rounded-xl p-4 space-y-3">
-                                                <div className="text-xs font-black uppercase tracking-widest text-neutral-400">Erros recentes</div>
-                                                {userActivityErrorsLoading ? (
-                                                    <div className="text-sm text-neutral-400 font-semibold">Carregando erros...</div>
-                                                ) : (
-                                                    <div className="space-y-2">
-                                                        {(Array.isArray(userActivityErrors) ? userActivityErrors : []).slice(0, 8).map((er) => (
-                                                            <div key={er.id} className="rounded-xl border border-neutral-800 bg-black/30 p-3">
-                                                                <div className="text-sm font-black text-white truncate">{String(er?.message || '').trim() || 'Erro'}</div>
-                                                                <div className="text-[11px] text-neutral-400 font-bold truncate">
-                                                                    {String(er?.status || '').trim() ? String(er.status) : ''} {String(er?.pathname || '').trim() ? `· ${String(er.pathname)}` : ''} {String(er?.created_at || '').trim() ? `· ${new Date(String(er.created_at)).toLocaleString('pt-BR')}` : ''}
-                                                                </div>
-                                                            </div>
-                                                        ))}
-                                                        {!userActivityErrorsLoading && (!userActivityErrors || userActivityErrors.length === 0) ? (
-                                                            <div className="text-sm text-neutral-400 font-semibold">Nenhum erro reportado.</div>
-                                                        ) : null}
-                                                    </div>
-                                                )}
-                                            </div>
-                                        </>
-                                    )}
-                                </div>
-                            </div>
-                        </div>
-                        <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 space-y-4">
-                            <h3 className="font-bold text-white flex items-center gap-2"><Download size={20} className="text-yellow-500"/> BACKUP DO SISTEMA</h3>
-                            <div className="flex gap-2">
-                                <button onClick={handleExportSystem} disabled={systemExporting} className="flex-1 min-h-[44px] py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl disabled:opacity-50">Exportar JSON</button>
-                                <button onClick={handleImportSystemClick} disabled={systemImporting} className="flex-1 min-h-[44px] py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl hover:bg-neutral-700 disabled:opacity-50">Importar JSON</button>
-                                <input ref={systemFileInputRef} type="file" accept=".json" className="hidden" onChange={handleImportSystem} />
-                            </div>
-                        </div>
-                        {/* Broadcast Section */}
-                        <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 space-y-4">
-                            <h3 className="font-bold text-white flex items-center gap-2"><Megaphone size={20} className="text-yellow-500"/> ENVIAR COMUNICADO</h3>
-                            <div>
-                                <label className="text-xs font-bold text-neutral-500 uppercase">Título do Aviso</label>
-                                <input value={broadcastTitle} onChange={e => setBroadcastTitle(e.target.value)} className="w-full bg-neutral-900 p-3 rounded-lg text-white font-bold mt-1 border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs font-bold text-neutral-500 uppercase">Mensagem</label>
-                                <textarea value={broadcastMsg} onChange={e => setBroadcastMsg(e.target.value)} className="w-full bg-neutral-900 p-3 rounded-lg text-white mt-1 border border-neutral-700 focus:border-yellow-500 outline-none h-32" />
-                            </div>
-                            <button onClick={handleSendBroadcast} disabled={sendingBroadcast} className="w-full py-4 bg-yellow-500 hover:bg-yellow-400 text-black font-black rounded-xl flex items-center justify-center gap-2 disabled:opacity-50">
-                                {sendingBroadcast ? 'Enviando...' : 'ENVIAR AVISO'}
-                            </button>
-                        </div>
-
-                        <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 space-y-4">
-                            <div className="flex items-start justify-between gap-3">
-                                <div className="min-w-0">
-                                    <h3 className="font-bold text-white flex items-center gap-2"><Dumbbell size={20} className="text-yellow-500"/> REVISAR EXERCÍCIOS (ALIASES)</h3>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                        {exerciseAliasesLoading ? 'Carregando...' : `${Array.isArray(exerciseAliasesReview) ? exerciseAliasesReview.length : 0} pendentes`}
-                                    </div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        type="button"
-                                        onClick={async () => {
-                                            if (!isAdmin) return;
-                                            if (exerciseAliasesBackfillLoading) return;
-                                            setExerciseAliasesBackfillLoading(true);
-                                            setExerciseAliasesNotice('');
-                                            try {
-                                                const authHeaders = await getAdminAuthHeaders();
-                                                const res = await fetch('/api/admin/exercises/canonicalize/backfill', {
-                                                    method: 'POST',
-                                                    headers: { 'content-type': 'application/json', ...authHeaders },
-                                                    body: JSON.stringify({ limit: 30 }),
-                                                });
-                                                const json = await res.json().catch(() => null);
-                                                if (!res.ok || !json?.ok) {
-                                                    const msg = String(json?.error || `Falha ao processar (${res.status})`);
-                                                    setExerciseAliasesNotice(msg);
-                                                    return;
-                                                }
-                                                const msg = `Processados: ${json.processed || 0} · Atualizados: ${json.updated || 0} · Falhas: ${json.failed || 0}`;
-                                                setExerciseAliasesNotice(msg);
-                                            } catch (e) {
-                                                const msg = e?.message ? String(e.message) : '';
-                                                if (msg) setExerciseAliasesNotice(msg);
-                                            } finally {
-                                                setExerciseAliasesBackfillLoading(false);
-                                            }
-                                        }}
-                                        disabled={exerciseAliasesBackfillLoading}
-                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-yellow-500 hover:bg-yellow-400 text-black disabled:opacity-50"
-                                    >
-                                        {exerciseAliasesBackfillLoading ? 'Processando...' : 'Processar (Gemini)'}
-                                    </button>
-                                    <button
-                                        type="button"
-                                        onClick={async () => {
-                                            if (!isAdmin) return;
-                                            setExerciseAliasesLoading(true);
-                                            setExerciseAliasesError('');
-                                            setExerciseAliasesNotice('');
-                                            try {
-                                                const { data, error } = await supabase
-                                                    .from('exercise_aliases')
-                                                    .select('id, user_id, canonical_id, alias, normalized_alias, confidence, source, needs_review, created_at, updated_at')
-                                                    .eq('needs_review', true)
-                                                    .order('created_at', { ascending: false })
-                                                    .limit(200);
-                                                if (error) {
-                                                    setExerciseAliasesReview([]);
-                                                    const msg = String(error?.message || '');
-                                                    if (msg) setExerciseAliasesError(msg);
-                                                    return;
-                                                }
-                                                setExerciseAliasesReview(Array.isArray(data) ? data : []);
-                                            } catch (e) {
-                                                setExerciseAliasesReview([]);
-                                                const msg = e?.message ? String(e.message) : '';
-                                                if (msg) setExerciseAliasesError(msg);
-                                            } finally {
-                                                setExerciseAliasesLoading(false);
-                                            }
-                                        }}
-                                        disabled={exerciseAliasesLoading}
-                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 disabled:opacity-50"
-                                    >
-                                        {exerciseAliasesLoading ? 'Atualizando...' : 'Atualizar'}
-                                    </button>
-                                </div>
-                            </div>
-
-                            {exerciseAliasesNotice ? (
-                                <div className="text-xs text-neutral-200 font-bold bg-neutral-900 border border-neutral-700 rounded-xl p-3">
-                                    {exerciseAliasesNotice}
-                                </div>
-                            ) : null}
-
-                            {exerciseAliasesError ? (
-                                <div className="text-xs text-red-300 font-bold bg-neutral-900 border border-neutral-700 rounded-xl p-3">
-                                    {exerciseAliasesError}
-                                </div>
-                            ) : null}
-
-                            {exerciseAliasesLoading ? (
-                                <div className="text-xs text-neutral-400 font-semibold">Carregando aliases pendentes...</div>
-                            ) : !Array.isArray(exerciseAliasesReview) || exerciseAliasesReview.length === 0 ? (
-                                <div className="text-xs text-neutral-400 font-semibold">Nenhum alias pendente de revisão.</div>
-                            ) : (
-                                <div className="space-y-2">
-                                    {exerciseAliasesReview.slice(0, 30).map((row) => {
-                                        const id = row?.id ? String(row.id) : '';
-                                        const userId = row?.user_id ? String(row.user_id) : '';
-                                        const alias = row?.alias ? String(row.alias) : '';
-                                        const conf = Number(row?.confidence);
-                                        const src = row?.source ? String(row.source) : '';
-                                        return (
-                                            <div key={id || `${userId}-${alias}`} className="bg-neutral-900/60 border border-neutral-800 rounded-xl p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="text-sm font-black text-white truncate">{alias || '—'}</div>
-                                                    <div className="text-[11px] text-neutral-400 break-all">
-                                                        <span className="font-black text-neutral-300">User:</span> {userId ? `${userId.slice(0, 8)}...` : '—'}{' '}
-                                                        <span className="mx-2">·</span>
-                                                        <span className="font-black text-neutral-300">Fonte:</span> {src || '—'}{' '}
-                                                        <span className="mx-2">·</span>
-                                                        <span className="font-black text-neutral-300">Conf:</span> {Number.isFinite(conf) ? conf.toFixed(2) : '—'}
-                                                    </div>
-                                                </div>
-                                                <div className="flex flex-col sm:flex-row gap-2">
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            try {
-                                                                const name = await prompt('Defina o nome canônico', 'Resolver alias', alias);
-                                                                const canon = String(name || '').trim();
-                                                                if (!canon) return;
-                                                                const norm = normalizeExerciseName(canon);
-                                                                if (!norm) return;
-                                                                const { data: canonRow, error: canonErr } = await supabase
-                                                                    .from('exercise_canonical')
-                                                                    .upsert(
-                                                                        { user_id: userId, display_name: canon, normalized_name: norm },
-                                                                        { onConflict: 'user_id,normalized_name' }
-                                                                    )
-                                                                    .select('id')
-                                                                    .maybeSingle();
-                                                                if (canonErr || !canonRow?.id) {
-                                                                    await alert('Falha ao salvar canônico: ' + String(canonErr?.message || ''));
-                                                                    return;
-                                                                }
-                                                                const canonicalId = String(canonRow.id);
-                                                                const { error: upErr } = await supabase
-                                                                    .from('exercise_aliases')
-                                                                    .update({ canonical_id: canonicalId, confidence: 1, source: 'human', needs_review: false })
-                                                                    .eq('id', id);
-                                                                if (upErr) {
-                                                                    await alert('Falha ao atualizar alias: ' + String(upErr?.message || ''));
-                                                                    return;
-                                                                }
-                                                                setExerciseAliasesReview((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== id) : prev));
-                                                            } catch (e) {
-                                                                await alert('Falha ao resolver: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-yellow-500 hover:bg-yellow-400 text-black active:scale-95 transition-transform"
-                                                    >
-                                                        Resolver
-                                                    </button>
-                                                    <button
-                                                        type="button"
-                                                        onClick={async () => {
-                                                            try {
-                                                                if (!(await confirm('Ignorar este alias? (não aparecerá mais para revisão)', 'Ignorar'))) return;
-                                                                const { error: upErr } = await supabase.from('exercise_aliases').update({ needs_review: false }).eq('id', id);
-                                                                if (upErr) {
-                                                                    await alert('Falha ao ignorar: ' + String(upErr?.message || ''));
-                                                                    return;
-                                                                }
-                                                                setExerciseAliasesReview((prev) => (Array.isArray(prev) ? prev.filter((x) => String(x?.id || '') !== id) : prev));
-                                                            } catch (e) {
-                                                                await alert('Falha ao ignorar: ' + (e?.message ?? String(e)));
-                                                            }
-                                                        }}
-                                                        className="min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest bg-neutral-900 border border-neutral-700 text-neutral-200 hover:bg-neutral-800 active:scale-95 transition-transform"
-                                                    >
-                                                        Ignorar
-                                                    </button>
-                                                </div>
-                                            </div>
-                                        );
-                                    })}
-                                </div>
-                            )}
-                        </div>
-
-                        <div className="bg-red-950/40 p-4 rounded-2xl border border-red-500/40 shadow-[0_16px_40px_rgba(0,0,0,0.75)]">
-                            <button
-                                type="button"
-                                onClick={() => setDangerOpen(v => !v)}
-                                className="w-full flex items-center justify-between gap-3 active:scale-[0.99] transition-transform"
-                            >
-                                <div className="flex items-center gap-3 min-w-0">
-                                    <div className="w-10 h-10 rounded-2xl bg-red-900/70 border border-red-500/60 flex items-center justify-center flex-shrink-0 shadow-[0_0_25px_rgba(248,113,113,0.35)]">
-                                        <ShieldAlert size={18} className="text-red-300" />
-                                    </div>
-                                    <div className="min-w-0 text-left">
-                                        <div className="font-black text-red-400 tracking-[0.18em] text-[11px] uppercase">Danger Zone</div>
-                                        <div className="text-xs text-neutral-300 font-semibold">Ações irreversíveis com confirmação dupla. Não há como desfazer.</div>
-                                    </div>
-                                </div>
-                                <div className={`w-9 h-9 rounded-full bg-neutral-900 border border-red-700 flex items-center justify-center transition-all duration-300 ${dangerOpen ? 'rotate-180' : ''}`}>
-                                    <ChevronDown size={16} className="text-red-300" />
-                                </div>
-                            </button>
-
-                            {dangerOpen && (
-                                <div className="mt-4 space-y-3">
-                                    <div className="bg-red-900/20 border border-red-500/40 rounded-2xl p-3 space-y-3">
-                                        <div className="flex items-start justify-between gap-3">
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-2xl bg-red-950/60 border border-red-500/60 flex items-center justify-center flex-shrink-0">
-                                                    <Trash2 size={16} className="text-red-300" />
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-[12px] font-black uppercase tracking-widest text-red-300 truncate">Zerar todos os alunos</div>
-                                                    <div className="text-[11px] text-neutral-300">Remove definitivamente todos os cadastros de alunos e seus vínculos.</div>
-                                                </div>
-                                            </div>
-                                            <span className="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-950/80 border border-red-500/60 text-red-300">Irreversível</span>
-                                        </div>
-                                        <div className="space-y-2">
-                                            <div className="text-[11px] text-neutral-300 font-semibold">Para confirmar, digite <span className="font-black text-red-300">APAGAR</span> no campo abaixo.</div>
-                                            <div className="flex flex-col sm:flex-row gap-2">
-                                                <input
-                                                    value={dangerStudentsConfirm}
-                                                    onChange={(e) => setDangerStudentsConfirm(e.target.value)}
-                                                    placeholder="Digite APAGAR para confirmar"
-                                                    className="flex-1 min-h-[40px] bg-neutral-950/80 border border-red-800 rounded-xl px-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-red-500"
-                                                />
-                                                <button
-                                                    type="button"
-                                                    disabled={
-                                                        dangerActionLoading === 'students' ||
-                                                        String(dangerStudentsConfirm || '').trim().toUpperCase() !== 'APAGAR'
-                                                    }
-                                                    onClick={() =>
-                                                        runDangerAction('students', 'ZERAR TODOS OS ALUNOS', clearAllStudents, () =>
-                                                            setDangerStudentsConfirm('')
-                                                        )
-                                                    }
-                                                    className="w-full sm:w-auto min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 bg-red-600 hover:bg-red-500 text-white border border-red-400 shadow-[0_0_25px_rgba(248,113,113,0.35)] disabled:opacity-40 disabled:cursor-not-allowed"
-                                                >
-                                                    {dangerActionLoading === 'students' ? 'Executando...' : 'Apagar tudo'}
-                                                </button>
-                                            </div>
-                                        </div>
-                                    </div>
-
-                                    <div className="bg-red-900/20 border border-red-500/40 rounded-2xl p-3 space-y-3">
-                                        <div className="flex items-start justify-between gap-3">
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-2xl bg-red-950/60 border border-red-500/60 flex items-center justify-center flex-shrink-0">
-                                                    <Trash2 size={16} className="text-red-300" />
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-[12px] font-black uppercase tracking-widest text-red-300 truncate">Zerar todos os professores</div>
-                                                    <div className="text-[11px] text-neutral-300">Exclui todos os professores cadastrados e seus acessos à plataforma.</div>
-                                                </div>
-                                            </div>
-                                            <span className="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-950/80 border border-red-500/60 text-red-300">Irreversível</span>
-                                        </div>
-                                        <div className="space-y-2">
-                                            <div className="text-[11px] text-neutral-300 font-semibold">Para confirmar, digite <span className="font-black text-red-300">APAGAR</span> no campo abaixo.</div>
-                                            <div className="flex flex-col sm:flex-row gap-2">
-                                                <input
-                                                    value={dangerTeachersConfirm}
-                                                    onChange={(e) => setDangerTeachersConfirm(e.target.value)}
-                                                    placeholder="Digite APAGAR para confirmar"
-                                                    className="flex-1 min-h-[40px] bg-neutral-950/80 border border-red-800 rounded-xl px-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-red-500"
-                                                />
-                                                <button
-                                                    type="button"
-                                                    disabled={
-                                                        dangerActionLoading === 'teachers' ||
-                                                        String(dangerTeachersConfirm || '').trim().toUpperCase() !== 'APAGAR'
-                                                    }
-                                                    onClick={() =>
-                                                        runDangerAction('teachers', 'ZERAR TODOS OS PROFESSORES', clearAllTeachers, () =>
-                                                            setDangerTeachersConfirm('')
-                                                        )
-                                                    }
-                                                    className="w-full sm:w-auto min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 bg-red-600 hover:bg-red-500 text-white border border-red-400 shadow-[0_0_25px_rgba(248,113,113,0.35)] disabled:opacity-40 disabled:cursor-not-allowed"
-                                                >
-                                                    {dangerActionLoading === 'teachers' ? 'Executando...' : 'Apagar tudo'}
-                                                </button>
-                                            </div>
-                                        </div>
-                                    </div>
-
-                                    <div className="bg-red-900/20 border border-red-500/40 rounded-2xl p-3 space-y-3">
-                                        <div className="flex items-start justify-between gap-3">
-                                            <div className="flex items-center gap-3 min-w-0">
-                                                <div className="w-9 h-9 rounded-2xl bg-red-950/60 border border-red-500/60 flex items-center justify-center flex-shrink-0">
-                                                    <Trash2 size={16} className="text-red-300" />
-                                                </div>
-                                                <div className="min-w-0">
-                                                    <div className="text-[12px] font-black uppercase tracking-widest text-red-300 truncate">Zerar todos os treinos</div>
-                                                    <div className="text-[11px] text-neutral-300">Remove todos os treinos cadastrados, incluindo templates e históricos associados.</div>
-                                                </div>
-                                            </div>
-                                            <span className="px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-widest bg-red-950/80 border border-red-500/60 text-red-300">Irreversível</span>
-                                        </div>
-                                        <div className="space-y-2">
-                                            <div className="text-[11px] text-neutral-300 font-semibold">Para confirmar, digite <span className="font-black text-red-300">APAGAR</span> no campo abaixo.</div>
-                                            <div className="flex flex-col sm:flex-row gap-2">
-                                                <input
-                                                    value={dangerWorkoutsConfirm}
-                                                    onChange={(e) => setDangerWorkoutsConfirm(e.target.value)}
-                                                    placeholder="Digite APAGAR para confirmar"
-                                                    className="flex-1 min-h-[40px] bg-neutral-950/80 border border-red-800 rounded-xl px-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-red-500"
-                                                />
-                                                <button
-                                                    type="button"
-                                                    disabled={
-                                                        dangerActionLoading === 'workouts' ||
-                                                        String(dangerWorkoutsConfirm || '').trim().toUpperCase() !== 'APAGAR'
-                                                    }
-                                                    onClick={() =>
-                                                        runDangerAction('workouts', 'ZERAR TODOS OS TREINOS', clearAllWorkouts, () =>
-                                                            setDangerWorkoutsConfirm('')
-                                                        )
-                                                    }
-                                                    className="w-full sm:w-auto min-h-[40px] px-4 py-2 rounded-xl font-black text-[11px] uppercase tracking-widest flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 bg-red-600 hover:bg-red-500 text-white border border-red-400 shadow-[0_0_25px_rgba(248,113,113,0.35)] disabled:opacity-40 disabled:cursor-not-allowed"
-                                                >
-                                                    {dangerActionLoading === 'workouts' ? 'Executando...' : 'Apagar tudo'}
-                                                </button>
-                                            </div>
-                                        </div>
-                                    </div>
-                                </div>
-                            )}
-                        </div>
-                    </div>
-                )}
-
-				{tab === 'teachers' && isAdmin && !selectedStudent && !selectedTeacher && (
-					<div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="flex items-center gap-2">
-                                        <UserCog size={18} className="text-yellow-500" />
-                                        <h2 className="text-base md:text-lg font-black tracking-tight">Professores</h2>
-                                    </div>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold">{(Array.isArray(teachersList) ? teachersList.length : 0)} cadastrados</div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        onClick={() => setShowTeacherModal(true)}
-                                        className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95"
-                                    >
-                                        <Plus size={18} /> ADICIONAR
-                                    </button>
-                                </div>
-                            </div>
-                            <div className="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-2">
-                                <div className="relative lg:col-span-2">
-                                    <Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500" />
-                                    <input
-                                        value={teacherQuery}
-                                        onChange={(e) => setTeacherQuery(e.target.value)}
-                                        placeholder="Buscar professor por nome ou email"
-                                        className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl pl-10 pr-3 py-2 text-sm text-white placeholder:text-neutral-600 focus:outline-none focus:border-yellow-500"
-                                    />
-                                </div>
-                                <div className="flex items-center gap-2 overflow-x-auto no-scrollbar">
-                                    {[
-                                        { key: 'all', label: 'Todos' },
-                                        { key: 'pago', label: 'Pago' },
-                                        { key: 'pendente', label: 'Pendente' },
-                                        { key: 'atrasado', label: 'Atrasado' },
-                                        { key: 'cancelar', label: 'Cancelar' }
-                                    ].map((opt) => (
-                                        <button
-                                            key={opt.key}
-                                            type="button"
-                                            onClick={() => setTeacherStatusFilter(opt.key)}
-                                            className={`whitespace-nowrap min-h-[40px] px-3 py-2 rounded-full text-[11px] font-black uppercase tracking-wide border transition-all duration-300 active:scale-95 ${
-                                                teacherStatusFilter === opt.key
-                                                    ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/15'
-                                                    : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                            }`}
-                                        >
-                                            {opt.label}
-                                        </button>
-                                    ))}
-                                </div>
-                            </div>
-                        </div>
-
-                        {teachersFiltered.length === 0 ? (
-                            <div className="bg-neutral-900/50 border border-neutral-800 rounded-2xl p-6 text-center">
-                                <p className="text-neutral-500">Nenhum professor encontrado.</p>
-                            </div>
-                        ) : (
-                            <div className="space-y-3">
-                                {teachersFiltered.map(t => (
-                                    <div
-                                        key={t.id}
-                                        className="bg-neutral-800 p-4 rounded-2xl flex justify-between items-center border border-neutral-700 cursor-pointer hover:border-yellow-500/50 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-                                        onClick={() => { setSelectedTeacher(t); }}
-                                    >
-                                        <div className="min-w-0">
-                                            <h3 className="font-black text-white truncate">{normalizeWorkoutTitle(t.name)}</h3>
-                                            <p className="text-xs text-neutral-400 truncate">{t.email}</p>
-                                            <div className="mt-2 flex flex-wrap items-center gap-2">
-                                                <span className="px-3 py-1.5 rounded-full bg-neutral-900 border border-neutral-700 text-[11px] font-black uppercase tracking-wide text-neutral-200">
-                                                    {t.status || 'pendente'}
-                                                </span>
-                                                <span className="text-[11px] font-semibold text-neutral-500">{t.phone || 'Sem telefone'}</span>
-                                                <span className="text-[11px] font-semibold text-neutral-500">Nascimento: {t.birth_date ? new Date(t.birth_date).toLocaleDateString() : '-'}</span>
-                                            </div>
-                                        </div>
-                                        <div className="flex items-center gap-2 flex-shrink-0" onClick={(e) => e.stopPropagation()}>
-                                            <button
-                                                onClick={() => setEditingTeacher(t)}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-yellow-500/40 hover:bg-yellow-500/10 text-neutral-300 hover:text-yellow-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Edit3 size={16} />
-                                            </button>
-                                            <select
-                                                value={t.status || 'pendente'}
-                                                onChange={async (e) => {
-                                                    const newStatus = e.target.value;
-                                                    const authHeaders = await getAdminAuthHeaders();
-                                                    const res = await fetch('/api/admin/teachers/status', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders }, body: JSON.stringify({ id: t.id, status: newStatus }) });
-                                                    const json = await res.json();
-                                                    if (json.ok) setTeachersList(prev => prev.map(x => x.id === t.id ? { ...x, status: newStatus } : x));
-                                                }}
-                                                className="min-h-[40px] bg-neutral-900/70 text-neutral-200 rounded-xl px-3 py-2 text-xs border border-neutral-700 focus:border-yellow-500 focus:outline-none"
-                                            >
-                                                <option value="pago">pago</option>
-                                                <option value="pendente">pendente</option>
-                                                <option value="atrasado">atrasado</option>
-                                                <option value="cancelar">cancelar</option>
-                                            </select>
-                                            <button
-                                                onClick={async () => {
-                                                    if (await confirm(`Excluir professor ${t.name}?`)) {
-                                                        try {
-                                                            const { data: sessionData } = await supabase.auth.getSession();
-                                                            const token = sessionData?.session?.access_token || '';
-                                                            if (!token) {
-                                                                await alert('Sessão expirada. Faça login novamente.');
-                                                                return;
-                                                            }
-                                                            const res = await fetch('/api/admin/teachers/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ id: t.id }) });
-                                                            let payload = null;
-                                                            try {
-                                                                const raw = await res.text();
-                                                                payload = raw ? JSON.parse(raw) : null;
-                                                            } catch (parseErr) {
-                                                                payload = null;
-                                                            }
-                                                            if (!payload || typeof payload !== 'object') {
-                                                                throw new Error(`Resposta inválida do servidor (${res.status})`);
-                                                            }
-                                                            if (!res.ok || !payload.ok) throw new Error(payload.error || `Falha ao excluir (${res.status})`);
-                                                            setTeachersList(prev => prev.filter(x => x.id !== t.id));
-                                                        } catch (err) {
-                                                            await alert('Erro: ' + (err?.message ?? String(err)));
-                                                        }
-                                                    }
-                                                }}
-                                                className="w-9 h-9 rounded-full bg-neutral-900 border border-neutral-700 hover:border-red-500/40 hover:bg-red-900/20 text-neutral-300 hover:text-red-400 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            >
-                                                <Trash2 size={16} />
-                                            </button>
-                                            {isAdmin && (t.status === 'pending' || t.status === 'pendente') && (
-                                                <button
-                                                    onClick={async () => {
-                                                        try {
-                                                            const authHeaders = await getAdminAuthHeaders();
-                                                            const res = await fetch('/api/admin/teachers/status', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders }, body: JSON.stringify({ id: t.id, status: 'active' }) });
-                                                            const json = await res.json();
-                                                            if (!json.ok) throw new Error(json.error || '');
-                                                            setTeachersList(prev => prev.map(x => x.id === t.id ? { ...x, status: 'active' } : x));
-                                                        } catch (err) {
-                                                            await alert('Erro ao aprovar: ' + (err?.message ?? String(err)));
-                                                        }
-                                                    }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-green-600 hover:bg-green-500 text-white text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Aprovar
-                                                </button>
-                                            )}
-                                        </div>
-                                    </div>
-                                ))}
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {tab === 'teachers' && isAdmin && !selectedStudent && selectedTeacher && (
-                    <div className="w-full space-y-4">
-                        <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                            <div className="flex items-start justify-between gap-3">
-                                <div className="min-w-0">
-                                    <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Professor</div>
-                                    <h2 className="text-base md:text-lg font-black text-white truncate">{normalizeWorkoutTitle(selectedTeacher?.name || '') || 'Professor'}</h2>
-                                    <div className="mt-1 text-xs text-neutral-400 font-semibold truncate">{selectedTeacher?.email || ''}</div>
-                                </div>
-                                <button
-                                    type="button"
-                                    onClick={() => { setSelectedTeacher(null); }}
-                                    className="w-11 h-11 rounded-2xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Voltar"
-                                >
-                                    <ArrowLeft size={18} />
-                                </button>
-                            </div>
-
-                            <div className="mt-4 flex items-center gap-2 overflow-x-auto no-scrollbar">
-                                {[
-                                    { key: 'students', label: 'Alunos' },
-                                    { key: 'templates', label: 'Treinos' },
-                                    { key: 'history', label: 'Histórico' },
-                                    { key: 'inbox', label: 'Interações' },
-                                ].map((opt) => (
-                                    <button
-                                        key={opt.key}
-                                        type="button"
-                                        onClick={() => setTeacherDetailTab(opt.key)}
-                                        className={`whitespace-nowrap min-h-[40px] px-3 py-2 rounded-full text-[11px] font-black uppercase tracking-wide border transition-all duration-300 active:scale-95 ${
-                                            teacherDetailTab === opt.key
-                                                ? 'bg-yellow-500 text-black border-yellow-400 shadow-lg shadow-yellow-500/15'
-                                                : 'bg-neutral-900/60 text-neutral-200 border-neutral-800 hover:bg-neutral-900'
-                                        }`}
-                                    >
-                                        {opt.label}
-                                    </button>
-                                ))}
-                            </div>
-                        </div>
-
-                        {teacherDetailTab === 'students' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Alunos</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherStudentsLoading ? 'Carregando…' : `${(Array.isArray(teacherStudents) ? teacherStudents.length : 0)} alunos`}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => loadTeacherStudents(selectedTeacher)}
-                                        className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                    >
-                                        Atualizar
-                                    </button>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherStudents) ? teacherStudents : []).length === 0 && !teacherStudentsLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhum aluno atribuído.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherStudents) ? teacherStudents : []).map((s) => (
-                                        <div
-                                            key={s.id}
-                                            className="bg-neutral-800 p-4 rounded-2xl flex justify-between items-center border border-neutral-700 hover:border-yellow-500/40 hover:shadow-lg hover:shadow-black/30 transition-all duration-300"
-                                        >
-                                            <div className="min-w-0">
-                                                <div className="font-black text-white truncate">{normalizeWorkoutTitle(s.name) || s.email}</div>
-                                                <div className="text-xs text-neutral-400 truncate">{s.email}</div>
-                                            </div>
-                                            <button
-                                                type="button"
-                                                onClick={() => { setSelectedStudent(s); setSubTab('workouts'); }}
-                                                className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                            >
-                                                Ver aluno
-                                            </button>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-
-                        {teacherDetailTab === 'templates' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Treinos (Templates)</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherTemplatesLoading ? 'Carregando…' : `${(Array.isArray(teacherTemplatesRows) ? teacherTemplatesRows.length : 0)} itens`}</div>
-                                    </div>
-                                    <div className="flex items-center gap-2">
-                                        <button
-                                            type="button"
-                                            onClick={() => loadTeacherTemplates(selectedTeacher, true)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                        >
-                                            Atualizar
-                                        </button>
-                                        <button
-                                            type="button"
-                                            disabled={!teacherTemplatesCursor || teacherTemplatesLoading}
-                                            onClick={() => loadTeacherTemplates(selectedTeacher, false)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
-                                        >
-                                            Mais
-                                        </button>
-                                    </div>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherTemplatesRows) ? teacherTemplatesRows : []).length === 0 && !teacherTemplatesLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhum treino encontrado.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherTemplatesRows) ? teacherTemplatesRows : []).map((w) => (
-                                        <div key={w.id} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
-                                            <div className="flex items-center justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="font-black text-white truncate">{normalizeWorkoutTitle(w.name) || 'Treino'}</div>
-                                                    <div className="text-xs text-neutral-400 truncate">{w.student_name || ''}</div>
-                                                </div>
-                                                <button
-                                                    type="button"
-                                                    onClick={() => { setSelectedStudent({ user_id: w.user_id, name: w.student_name || '' }); setSubTab('workouts'); }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Abrir
-                                                </button>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-
-                        {teacherDetailTab === 'history' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Histórico de Treinos</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherHistoryLoading ? 'Carregando…' : `${(Array.isArray(teacherHistoryRows) ? teacherHistoryRows.length : 0)} itens`}</div>
-                                    </div>
-                                    <div className="flex items-center gap-2">
-                                        <button
-                                            type="button"
-                                            onClick={() => loadTeacherHistory(selectedTeacher, true)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                        >
-                                            Atualizar
-                                        </button>
-                                        <button
-                                            type="button"
-                                            disabled={!teacherHistoryCursor || teacherHistoryLoading}
-                                            onClick={() => loadTeacherHistory(selectedTeacher, false)}
-                                            className="min-h-[40px] px-3 py-2 rounded-xl bg-yellow-500 hover:bg-yellow-400 text-black text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed"
-                                        >
-                                            Mais
-                                        </button>
-                                    </div>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherHistoryRows) ? teacherHistoryRows : []).length === 0 && !teacherHistoryLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhum treino executado encontrado.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherHistoryRows) ? teacherHistoryRows : []).map((w) => (
-                                        <div key={w.id} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
-                                            <div className="flex items-center justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="font-black text-white truncate">{normalizeWorkoutTitle(w.name) || 'Treino'}</div>
-                                                    <div className="text-xs text-neutral-400 truncate">{w.student_name || ''}{w.date ? ` • ${new Date(w.date).toLocaleDateString()}` : ''}</div>
-                                                </div>
-                                                <button
-                                                    type="button"
-                                                    onClick={() => { setSelectedStudent({ user_id: w.user_id, name: w.student_name || '' }); setSubTab('workouts'); }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Abrir
-                                                </button>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-
-                        {teacherDetailTab === 'inbox' && (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)]">
-                                <div className="flex items-center justify-between gap-3">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Interações (Inbox)</div>
-                                        <div className="text-xs text-neutral-400 font-semibold">{teacherInboxLoading ? 'Carregando…' : `${(Array.isArray(teacherInboxItems) ? teacherInboxItems.length : 0)} itens`}</div>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => loadTeacherInbox(selectedTeacher)}
-                                        className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                    >
-                                        Atualizar
-                                    </button>
-                                </div>
-                                <div className="mt-4 space-y-2">
-                                    {(Array.isArray(teacherInboxItems) ? teacherInboxItems : []).length === 0 && !teacherInboxLoading ? (
-                                        <div className="text-sm text-neutral-500">Nenhuma interação sugerida.</div>
-                                    ) : null}
-                                    {(Array.isArray(teacherInboxItems) ? teacherInboxItems : []).map((it) => (
-                                        <div key={it.id} className="bg-neutral-800 p-4 rounded-2xl border border-neutral-700">
-                                            <div className="flex items-start justify-between gap-3">
-                                                <div className="min-w-0">
-                                                    <div className="font-black text-white truncate">{it.title || 'Alerta'}</div>
-                                                    <div className="text-xs text-neutral-400 truncate">{it.student_name || ''}</div>
-                                                    <div className="mt-2 text-xs text-neutral-300">{it.reason || ''}</div>
-                                                </div>
-                                                <button
-                                                    type="button"
-                                                    onClick={() => { setSelectedStudent({ user_id: it.student_user_id, name: it.student_name || '' }); setSubTab('workouts'); }}
-                                                    className="min-h-[40px] px-3 py-2 rounded-xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 text-xs font-black uppercase tracking-wide transition-all duration-300 active:scale-95"
-                                                >
-                                                    Abrir
-                                                </button>
-                                            </div>
-                                        </div>
-                                    ))}
-                                </div>
-                            </div>
-                        )}
-                    </div>
-                )}
-
-                {selectedStudent && (
-                    <div className="animate-slide-up">
-                        {editingStudent ? (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 md:p-6 shadow-[0_16px_40px_rgba(0,0,0,0.35)] mb-6">
-                                <div className="flex items-center justify-between gap-3 mb-4">
-                                    <div className="min-w-0">
-                                        <div className="text-[11px] uppercase tracking-widest text-neutral-500 font-bold">Aluno</div>
-                                        <h3 className="text-base md:text-lg font-black text-white truncate">Editar informações</h3>
-                                    </div>
-                                    <button
-                                        type="button"
-                                        onClick={() => setEditingStudent(false)}
-                                        className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                        aria-label="Fechar"
-                                    >
-                                        <X size={18} />
-                                    </button>
-                                </div>
-                                <div className="space-y-4">
-                                    <div>
-                                        <label className="block text-[11px] font-black uppercase tracking-widest text-neutral-500 mb-2">Nome</label>
-                                        <input type="text" value={editedStudent.name || ''} onChange={(e) => setEditedStudent(prev => ({ ...prev, name: e.target.value }))} className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none" />
-                                    </div>
-                                    <div>
-                                        <label className="block text-[11px] font-black uppercase tracking-widest text-neutral-500 mb-2">Email</label>
-                                        <input type="email" value={editedStudent.email || ''} onChange={(e) => setEditedStudent(prev => ({ ...prev, email: e.target.value }))} className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none" />
-                                    </div>
-                                    <div className="flex gap-3 pt-4">
-                                        <button onClick={handleSaveStudentEdit} className="flex-1 min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95">Salvar</button>
-                                        <button onClick={() => setEditingStudent(false)} className="flex-1 min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95">Cancelar</button>
-                                    </div>
-                                </div>
-                            </div>
-                        ) : (
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 md:p-4 shadow-[0_16px_40px_rgba(0,0,0,0.35)] mb-6">
-                                <div className="grid gap-3 md:grid-cols-[1fr_auto] md:items-center">
-                                    <div className="flex items-start gap-3 md:gap-4 min-w-0">
-                                        <button
-                                            type="button"
-                                            onClick={() => { setSelectedStudent(null); setSubTab('workouts'); }}
-                                            className="w-11 h-11 rounded-2xl bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 flex items-center justify-center transition-all duration-300 active:scale-95"
-                                            aria-label="Voltar"
-                                        >
-                                            <ArrowLeft size={18} />
-                                        </button>
-                                        <div className="w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-neutral-900 border border-neutral-800 flex items-center justify-center font-black text-lg md:text-xl text-neutral-100 flex-shrink-0">
-                                            {(selectedStudent?.name || selectedStudent?.email || '?')[0]}
-                                        </div>
-                                        <div className="min-w-0 flex-1">
-                                            <div className="flex flex-wrap items-center gap-2">
-                                                <h2 className="text-lg md:text-2xl font-black text-white truncate">{selectedStudent?.name || selectedStudent?.email}</h2>
-                                                <span className={`px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${selectedStatusTone}`}> {selectedStatusLabel}</span>
-                                            </div>
-                                            <p className="text-xs md:text-sm text-neutral-400 font-semibold truncate">{selectedStudent?.email}</p>
-                                        </div>
-                                    </div>
-
-                                    <div className="flex flex-col sm:flex-row md:flex-row items-stretch md:items-center gap-2">
-                                        {isAdmin && (Array.isArray(teachersList) ? teachersList.length : 0) > 0 && (
-                                            <div className="flex items-center gap-2 w-full sm:w-auto">
-                                                <span className="hidden lg:inline text-[10px] font-black uppercase tracking-widest text-neutral-500">Professor</span>
-                                                {(() => {
-                                                    const currentUid = selectedStudent.teacher_id || '';
-                                                    const list = Array.isArray(teachersList) ? [...teachersList] : [];
-                                                    if (currentUid && !list.some(t => t.user_id === currentUid)) {
-                                                        list.unshift({ id: currentUid, name: 'Professor atribuído', email: '', user_id: currentUid, status: 'active' });
-                                                    }
-                                                    const currentValue = currentUid ? `uid:${currentUid}` : '';
-                                                    return (
-                                                        <select
-                                                            value={currentValue}
-                                                            onChange={async (e) => {
-                                                                const raw = String(e.target.value || '').trim();
-                                                                const teacherUserId = raw.startsWith('uid:') ? raw.slice(4) : '';
-                                                                try {
-                                                                    const authHeaders = await getAdminAuthHeaders();
-                                                                    const res = await fetch('/api/admin/students/assign-teacher', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders }, body: JSON.stringify({ student_id: selectedStudent.id || selectedStudent.user_id, email: selectedStudent.email || '', teacher_user_id: teacherUserId || null })});
-                                                                    const json = await res.json();
-                                                                    if (json.ok) {
-                                                                        const nextTid = json.teacher_user_id || teacherUserId || null;
-                                                                        setSelectedStudent(prev => ({ ...prev, teacher_id: nextTid }));
-                                                                        setUsersList(prev => prev.map(x => (
-                                                                            (x.id === selectedStudent.id)
-                                                                            || (x.user_id === selectedStudent.user_id)
-                                                                            || ((x.email || '').toLowerCase() === (selectedStudent.email || '').toLowerCase())
-                                                                        ) ? { ...x, teacher_id: nextTid } : x));
-                                                                        try { if (selectedStudent.email) localStorage.setItem('student_teacher_'+selectedStudent.email, nextTid || ''); } catch {}
-                                                                        try {
-                                                                            let js = null;
-                                                                            try {
-                                                                                const resp = await fetch('/api/admin/students/list', { headers: authHeaders });
-                                                                                const raw = await resp.text();
-                                                                                js = raw ? JSON.parse(raw) : null;
-                                                                            } catch {}
-                                                                            if (js?.ok) setUsersList(js.students || []);
-                                                                        } catch {}
-                                                                    } else {
-                                                                        await alert('Erro: ' + (json.error || 'Falha ao atualizar professor'));
-                                                                    }
-                                                                } catch (e) {
-                                                                    await alert('Erro: ' + (e?.message ?? String(e)));
-                                                                }
-                                                            }}
-                                                            className="min-h-[44px] bg-neutral-900/70 text-neutral-200 rounded-xl px-3 py-2 text-xs w-full sm:w-64 md:w-72 border border-neutral-800 focus:border-yellow-500 focus:outline-none"
-                                                        >
-                                                            <option value="">Sem Professor</option>
-                                                            {list.map(t => (
-                                                                <option
-                                                                    key={t.id || t.user_id || t.email || Math.random().toString(36).slice(2)}
-                                                                    value={t.user_id ? `uid:${t.user_id}` : ''}
-                                                                    disabled={!t.user_id}
-                                                                >
-                                                                    {(t.name || t.email || (t.user_id ? t.user_id.slice(0,8) : 'Professor')) + (!t.user_id ? ' (sem conta)' : '')}
-                                                                </option>
-                                                            ))}
-                                                        </select>
-                                                    );
-                                                })()}
-                                            </div>
-                                        )}
-                                        <button
-                                            type="button"
-                                            onClick={() => setEditingStudent(true)}
-                                            className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 shrink-0"
-                                            title="Editar"
-                                        >
-                                            <Edit3 size={18} className="text-yellow-500" /> Editar
-                                        </button>
-                                    </div>
-                                </div>
-
-                                <div className="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-2">
-                                    <div className="bg-neutral-950/40 border border-neutral-800 rounded-2xl p-3">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Treinos</div>
-                                        <div className="mt-1 text-lg font-black text-white">{(Array.isArray(studentWorkouts) ? studentWorkouts.length : 0) + (Array.isArray(syncedWorkouts) ? syncedWorkouts.length : 0)}</div>
-                                    </div>
-                                    <div className="bg-neutral-950/40 border border-neutral-800 rounded-2xl p-3">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Avaliações</div>
-                                        <div className="mt-1 text-lg font-black text-white">{Array.isArray(assessments) ? assessments.length : 0}</div>
-                                    </div>
-                                    <div className="bg-neutral-950/40 border border-neutral-800 rounded-2xl p-3">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Status</div>
-                                        <div className="mt-1 text-lg font-black text-white truncate">{selectedStatusLabel}</div>
-                                    </div>
-                                </div>
-                            </div>
-                        )}
-
-                        <div className="mb-6">
-                            <div className="bg-neutral-900/60 border border-neutral-800 rounded-full p-1 flex items-center gap-1 shadow-[0_10px_30px_rgba(0,0,0,0.35)]">
-                                <button
-                                    type="button"
-                                    onClick={() => setSubTab('workouts')}
-                                    className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        subTab === 'workouts'
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                            : 'text-neutral-200'
-                                    }`}
-                                >
-                                    Treinos
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => setSubTab('evolution')}
-                                    className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        subTab === 'evolution'
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                            : 'text-neutral-200'
-                                    }`}
-                                >
-                                    Evolução
-                                </button>
-                                <button
-                                    type="button"
-                                    onClick={() => setSubTab('checkins')}
-                                    className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        subTab === 'checkins'
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                            : 'text-neutral-200'
-                                    }`}
-                                >
-                                    Check-ins
-                                </button>
-                                {executionVideoEnabled ? (
-                                    <button
-                                        type="button"
-                                        onClick={() => setSubTab('videos')}
-                                        className={`flex-1 min-h-[44px] px-4 rounded-full font-black text-[11px] uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                            subTab === 'videos'
-                                                ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/20'
-                                                : 'text-neutral-200'
-                                        }`}
-                                    >
-                                        Vídeos
-                                    </button>
-                                ) : null}
-                            </div>
-                        </div>
-
-                        {loading && <p className="text-center animate-pulse">Carregando dados...</p>}
-
-                        {!loading && subTab === 'workouts' && (
-                            <div className="space-y-4">
-                                <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                                        <div className="min-w-0">
-                                            <div className="flex items-center gap-2">
-                                                <Dumbbell size={18} className="text-yellow-500" />
-                                                <h3 className="text-base font-black text-white tracking-tight">Treinos do aluno</h3>
-                                            </div>
-                                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                                {(Array.isArray(studentWorkouts) ? studentWorkouts.length : 0) + (Array.isArray(syncedWorkouts) ? syncedWorkouts.length : 0)} atribuídos
-                                            </div>
-                                        </div>
-                                        <div className="flex flex-col sm:flex-row gap-2">
-                                            <button
-                                                type="button"
-                                                data-tour="adminpanel.student.workouts.history"
-                                                onClick={() => setHistoryOpen(true)}
-                                                className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-yellow-500/25 text-yellow-400 rounded-xl text-[11px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-yellow-500/10 transition-all duration-300 active:scale-95"
-                                            >
-                                                <History size={16} /> Histórico
-                                            </button>
-                                            <button
-                                                type="button"
-                                                data-tour="adminpanel.student.workouts.create"
-                                                onClick={() => setEditingStudentWorkout({ id: null, title: '', exercises: [] })}
-                                                className="min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl text-[11px] font-black uppercase tracking-widest transition-all duration-300 shadow-lg shadow-yellow-500/15 active:scale-95"
-                                            >
-                                                Criar treino
-                                            </button>
-                                        </div>
-                                    </div>
-                                </div>
-                                {templates.length > 0 && (
-                                    <button onClick={async () => {
-                                            try {
-                                                const looksLikeUuid = (v) => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(String(v || '').trim());
-                                                const maybeId = selectedStudent.user_id || selectedStudent.id || null;
-                                                let payloadId = looksLikeUuid(maybeId) ? String(maybeId) : undefined;
-                                                const payloadEmail = String(selectedStudent.email || '').trim();
-                                                if (!payloadId && payloadEmail) {
-                                                    try {
-                                                        const { data: profile } = await supabase
-                                                            .from('profiles')
-                                                            .select('id')
-                                                            .ilike('email', payloadEmail)
-                                                            .maybeSingle();
-                                                        if (profile?.id) payloadId = String(profile.id);
-                                                    } catch {}
-                                                }
-                                                if (!payloadId && !payloadEmail) {
-                                                    await alert('Aluno sem conta (user_id) e sem email; não é possível sincronizar.');
-                                                    return;
-                                                }
-                                                if (!payloadId && payloadEmail) {
-                                                    await alert('Aluno sem conta (user_id). Não é possível sincronizar.');
-                                                    return;
-                                                }
-                                                const normalize = (s) => (s || '')
-                                                    .toLowerCase()
-                                                    .normalize('NFD')
-                                                    .replace(/[\u0300-\u036f]/g, '')
-                                                    .replace(/\s+/g, ' ')
-                                                    .trim();
-                                            const extractLetter = (rawName) => {
-                                                const nn = normalize(rawName);
-                                                if (!nn) return null;
-                                                const m = nn.match(/^treino\s*\(?([a-z])/);
-                                                if (m && m[1]) return m[1];
-                                                const m2 = nn.match(/\(([a-z])\)/);
-                                                if (m2 && m2[1]) return m2[1];
-                                                return null;
-                                            };
-                                            const authHeaders = await getAdminAuthHeaders();
-                                            const res = await fetch('/api/admin/workouts/sync-templates', {
-                                                method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders },
-                                                body: JSON.stringify({
-                                                    id: payloadId,
-                                                    email: payloadEmail,
-                                                    mode: 'all'
-                                                })
-                                            })
-                                            const json = await res.json();
-                                            if (json.ok) {
-                                                const resolvedTargetUserId = String(json?.debug?.targetUserId || selectedStudent.user_id || '').trim();
-                                                // Se rota retorna vazio, reforçar fetch direto por OR user_id/student_id
-                                                let rows = json.rows || [];
-                                                if (!rows || rows.length === 0) {
-                                                    try {
-                                                        const { data: refreshed } = await supabase
-                                                            .from('workouts')
-                                                            .select('*, exercises(*, sets(*))')
-                                                            .eq('user_id', resolvedTargetUserId)
-                                                            .eq('is_template', true)
-                                                            .order('name');
-                                                        rows = refreshed || [];
-                                                    } catch {}
-                                                }
-                                                const scoped = (rows || []).filter(w => String(w?.user_id || '') === resolvedTargetUserId)
-                                                const synced = (scoped || []).filter(w => (w?.is_template && String(w?.created_by || '') === String(user.id)))
-                                                const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-                                                const others = (scoped || []).filter(w => !syncedIds.has(w?.id));
-                                                setStudentWorkouts(others)
-                                                setSyncedWorkouts(synced)
-                                                const msg = `Sincronização contínua ativada: ${json.created_count || 0} criado(s), ${json.updated_count || 0} atualizado(s)`
-                                                if ((json.created_count || 0) + (json.updated_count || 0) === 0 && json.debug) {
-                                                    const d = json.debug || {}
-                                                    const extra = `\n\nDiagnóstico:\n- sourceUserId: ${d.sourceUserId || '-'}\n- source_mode: ${d.source_mode || '-'}\n- owner_raw: ${d.owner_raw_count ?? '-'}\n- owner_matched: ${d.owner_matched_count ?? '-'}\n- source_count: ${d.source_count ?? '-'}\n- picked: ${d.picked_count ?? '-'}\n- picked_names: ${(d.picked_names || []).slice(0, 3).join(' | ') || '-'}\n- sample: ${(d.source_sample_names || []).slice(0, 3).join(' | ') || '-'}`
-                                                    await alert(msg + extra)
-                                                } else {
-                                                    await alert(msg)
-                                                }
-                                            } else {
-                                                const d = json?.debug || null
-                                                if (d) {
-                                                    const sample = Array.isArray(d.owner_sample_names) ? d.owner_sample_names.slice(0, 3).join(' | ') : '-'
-                                                    const extra = `\n\nDiagnóstico:\n- authUserId: ${d.authUserId || '-'}\n- sourceUserId: ${d.sourceUserId || '-'}\n- syncMode: ${d.syncMode || '-'}\n- owner_raw: ${d.owner_raw_count ?? '-'}\n- owner_owned: ${d.owner_owned_count ?? '-'}\n- owner_matched: ${d.owner_matched_count ?? '-'}\n- sample: ${sample}`
-                                                    await alert('Erro: ' + (json.error || 'Falha ao sincronizar') + extra)
-                                                } else {
-                                                    await alert('Erro: ' + (json.error || 'Falha ao sincronizar'))
-                                                }
-                                            }
-                                        } catch (e) { await alert('Erro ao sincronizar: ' + (e?.message ?? String(e))) }
-                                    }} className="px-3 py-2 bg-neutral-800 border border-neutral-700 text-neutral-200 rounded-lg text-xs font-bold">Sincronizar com Meus Treinos</button>
-                                )}
-                                {syncedWorkouts.length > 0 && (
-                                    <div className="mt-4">
-                                        <h3 className="font-bold text-yellow-500 text-xs uppercase tracking-widest mb-2">Treinos sincronizados</h3>
-                                        {syncedWorkouts.map(w => (
-                                            <div key={w.id} className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 flex justify-between items-center cursor-pointer" onClick={() => setViewWorkout(w)}>
-                                                <div>
-                                                    <h4 className="font-bold text-white">{normalizeWorkoutTitle(w.name)}</h4>
-                                                    <p className="text-xs text-neutral-500">{w.exercises?.length || 0} exercícios</p>
-                                                </div>
-                                                <div className="flex items-center gap-2">
-                                                    <button onClick={(e) => openEditWorkout(e, w)} className="p-2 bg-neutral-700 hover:bg-yellow-500 text-neutral-300 hover:text-black rounded"><Edit3 size={16}/></button>
-                                                    <button onClick={async (e) => { e.stopPropagation(); if (!(await confirm('Remover este treino do aluno?'))) return; try { const authHeaders = await getAdminAuthHeaders(); const res = await fetch('/api/admin/workouts/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders }, body: JSON.stringify({ id: w.id }) }); const json = await res.json(); if (!json.ok) throw new Error(json.error || 'Falha ao remover'); setStudentWorkouts(prev => prev.filter(x => x.id !== w.id)); setSyncedWorkouts(prev => prev.filter(x => x.id !== w.id)); } catch (e) { await alert('Erro ao remover: ' + (e?.message ?? String(e))); } }} className="p-2 text-red-500 hover:bg-red-900/20 rounded"><Trash2 size={18}/></button>
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                                {studentWorkouts.length === 0 && <p className="text-neutral-500 text-sm">Nenhum treino atribuído.</p>}
-                                {studentWorkouts.map(w => (
-                            <div key={w.id} className="bg-neutral-800 p-4 rounded-xl border border-neutral-700 flex justify-between items-center cursor-pointer" onClick={() => setViewWorkout(w)}>
-                                <div>
-                                    <h4 className="font-bold text-white">{normalizeWorkoutTitle(w.name)}</h4>
-                                    <p className="text-xs text-neutral-500">{w.exercises?.length || 0} exercícios</p>
-                                </div>
-                                <div className="flex items-center gap-2">
-                                    <button onClick={(e) => openEditWorkout(e, w)} className="p-2 bg-neutral-700 hover:bg-yellow-500 text-neutral-300 hover:text-black rounded"><Edit3 size={16}/></button>
-                                    <button onClick={async (e) => { e.stopPropagation(); if (!(await confirm('Remover este treino do aluno?'))) return; try { const authHeaders = await getAdminAuthHeaders(); const res = await fetch('/api/admin/workouts/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeaders }, body: JSON.stringify({ id: w.id }) }); const json = await res.json(); if (!json.ok) throw new Error(json.error || 'Falha ao remover'); setStudentWorkouts(prev => prev.filter(x => x.id !== w.id)); } catch (e) { await alert('Erro ao remover: ' + (e?.message ?? String(e))); } }} className="p-2 text-red-500 hover:bg-red-900/20 rounded"><Trash2 size={18}/></button>
-                        </div>
-                    </div>
-                ))}
-                <div className="mt-6">
-                    <h3 className="font-bold text-yellow-500 text-xs uppercase tracking-widest mb-2">Meus Treinos</h3>
-                    {templates.length === 0 && <p className="text-neutral-500 text-sm">Nenhum treino seu encontrado.</p>}
-                    {templates.map(t => (
-                        <button key={t.id} onClick={() => handleAddTemplateToStudent(t)} className="w-full text-left p-3 bg-neutral-800 hover:bg-neutral-700 rounded-xl border border-neutral-700 flex justify-between group">
-                            <span>{t.name}</span>
-                            <Plus className="text-neutral-500 group-hover:text-yellow-500"/>
-                        </button>
-                    ))}
-                </div>
-            </div>
-        )}
-
-        {!loading && executionVideoEnabled && subTab === 'videos' && (
-            <div className="space-y-4">
-                <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                        <div className="min-w-0">
-                            <div className="flex items-center gap-2">
-                                <Video size={18} className="text-yellow-500" />
-                                <h3 className="text-base font-black text-white tracking-tight">Vídeos de execução</h3>
-                            </div>
-                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                {executionVideosLoading ? 'Carregando...' : `${Array.isArray(executionVideos) ? executionVideos.length : 0} enviado(s)`}
-                            </div>
-                        </div>
-                        <button
-                            type="button"
-                            onClick={async () => {
-                                try {
-                                    if (!selectedStudent?.user_id) return;
-                                    setExecutionVideosLoading(true);
-                                    setExecutionVideosError('');
-                                    const res = await fetch(`/api/teacher/execution-videos/by-student?student_user_id=${encodeURIComponent(String(selectedStudent.user_id))}`, { cache: 'no-store', credentials: 'include' });
-                                    const json = await res.json().catch(() => null);
-                                    if (!res.ok || !json?.ok) {
-                                        setExecutionVideos([]);
-                                        setExecutionVideosError(String(json?.error || `Falha ao carregar (${res.status})`));
-                                        return;
-                                    }
-                                    setExecutionVideos(Array.isArray(json.items) ? json.items : []);
-                                } catch (e) {
-                                    setExecutionVideos([]);
-                                    setExecutionVideosError(e?.message ? String(e.message) : 'Erro ao carregar');
-                                } finally {
-                                    setExecutionVideosLoading(false);
-                                }
-                            }}
-                            disabled={executionVideosLoading}
-                            className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95 disabled:opacity-60"
-                        >
-                            Atualizar
-                        </button>
-                    </div>
-                </div>
-
-                {executionVideosError ? (
-                    <div className="bg-neutral-900/60 border border-red-500/30 rounded-2xl p-4 text-red-200 font-bold text-sm">
-                        {executionVideosError}
-                    </div>
-                ) : null}
-
-                {executionVideosLoading ? (
-                    <div className="text-center animate-pulse text-neutral-400 font-semibold">Carregando vídeos...</div>
-                ) : !Array.isArray(executionVideos) || executionVideos.length === 0 ? (
-                    <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 text-neutral-400 font-semibold">
-                        Nenhum vídeo enviado ainda.
-                    </div>
-                ) : (
-                    <div className="space-y-3">
-                        {executionVideos.map((it) => {
-                            const id = it?.id ? String(it.id) : '';
-                            const when = it?.created_at ? new Date(it.created_at) : null;
-                            const title = String(it?.exercise_name || 'Execução').trim();
-                            const status = String(it?.status || 'pending').toLowerCase();
-                            const draft = executionVideoFeedbackDraft && typeof executionVideoFeedbackDraft === 'object' ? executionVideoFeedbackDraft[id] : '';
-                            const statusLabel = status === 'approved' ? 'Aprovado' : status === 'rejected' ? 'Reprovado' : 'Pendente';
-                            const statusTone =
-                                status === 'approved'
-                                    ? 'border-green-500/30 text-green-300'
-                                    : status === 'rejected'
-                                      ? 'border-red-500/30 text-red-300'
-                                      : 'border-yellow-500/30 text-yellow-300';
-                            return (
-                                <div key={id || Math.random().toString(36).slice(2)} className="bg-neutral-900/60 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                                    <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
-                                        <div className="min-w-0">
-                                            <div className="flex flex-wrap items-center gap-2">
-                                                <div className="text-base font-black text-white truncate">{title}</div>
-                                                <span className={`px-2.5 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${statusTone}`}>{statusLabel}</span>
-                                            </div>
-                                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                                {when ? when.toLocaleString() : ''}
-                                            </div>
-                                        </div>
-                                        <div className="flex flex-col sm:flex-row gap-2">
-                                            <button
-                                                type="button"
-                                                onClick={async () => {
-                                                    try {
-                                                        const res = await fetch('/api/execution-videos/media', {
-                                                            method: 'POST',
-                                                            credentials: 'include',
-                                                            headers: { 'content-type': 'application/json' },
-                                                            body: JSON.stringify({ submission_id: id }),
-                                                        });
-                                                        const json = await res.json().catch(() => null);
-                                                        if (!res.ok || !json?.ok || !json?.url) {
-                                                            await alert(String(json?.error || `Falha ao abrir (${res.status})`));
-                                                            return;
-                                                        }
-                                                        setExecutionVideoModalUrl(String(json.url));
-                                                        setExecutionVideoModalOpen(true);
-                                                    } catch (e) {
-                                                        await alert('Erro: ' + (e?.message ?? String(e)));
-                                                    }
-                                                }}
-                                                className="min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black flex items-center justify-center gap-2 transition-all duration-300 active:scale-95"
-                                            >
-                                                Assistir
-                                            </button>
-                                            <button
-                                                type="button"
-                                                onClick={async () => {
-                                                    try {
-                                                        const feedback = String(draft || '').trim();
-                                                        const res = await fetch('/api/teacher/execution-videos/review', {
-                                                            method: 'POST',
-                                                            credentials: 'include',
-                                                            headers: { 'content-type': 'application/json' },
-                                                            body: JSON.stringify({ submission_id: id, status: 'approved', feedback, send_message: true }),
-                                                        });
-                                                        const json = await res.json().catch(() => null);
-                                                        if (!res.ok || !json?.ok) {
-                                                            await alert(String(json?.error || `Falha ao aprovar (${res.status})`));
-                                                            return;
-                                                        }
-                                                        setExecutionVideos((prev) => (Array.isArray(prev) ? prev.map((x) => (String(x?.id || '') === id ? { ...x, status: 'approved', teacher_feedback: feedback } : x)) : prev));
-                                                    } catch (e) {
-                                                        await alert('Erro: ' + (e?.message ?? String(e)));
-                                                    }
-                                                }}
-                                                className="min-h-[44px] px-4 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-black transition-all duration-300 active:scale-95"
-                                            >
-                                                Aprovar
-                                            </button>
-                                            <button
-                                                type="button"
-                                                onClick={async () => {
-                                                    try {
-                                                        const feedback = String(draft || '').trim();
-                                                        const res = await fetch('/api/teacher/execution-videos/review', {
-                                                            method: 'POST',
-                                                            credentials: 'include',
-                                                            headers: { 'content-type': 'application/json' },
-                                                            body: JSON.stringify({ submission_id: id, status: 'rejected', feedback, send_message: true }),
-                                                        });
-                                                        const json = await res.json().catch(() => null);
-                                                        if (!res.ok || !json?.ok) {
-                                                            await alert(String(json?.error || `Falha ao reprovar (${res.status})`));
-                                                            return;
-                                                        }
-                                                        setExecutionVideos((prev) => (Array.isArray(prev) ? prev.map((x) => (String(x?.id || '') === id ? { ...x, status: 'rejected', teacher_feedback: feedback } : x)) : prev));
-                                                    } catch (e) {
-                                                        await alert('Erro: ' + (e?.message ?? String(e)));
-                                                    }
-                                                }}
-                                                className="min-h-[44px] px-4 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-black transition-all duration-300 active:scale-95"
-                                            >
-                                                Reprovar
-                                            </button>
-                                        </div>
-                                    </div>
-
-                                    <div className="mt-3">
-                                        <label className="block text-[11px] font-black uppercase tracking-widest text-neutral-500 mb-2">Mensagem para o aluno</label>
-                                        <textarea
-                                            value={String(draft || '')}
-                                            onChange={(e) => {
-                                                const v = e?.target?.value ?? '';
-                                                setExecutionVideoFeedbackDraft((prev) => ({ ...(prev && typeof prev === 'object' ? prev : {}), [id]: v }));
-                                            }}
-                                            rows={3}
-                                            className="w-full bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none"
-                                            placeholder="Escreva seu feedback..."
-                                        />
-                                    </div>
-                                </div>
-                            );
-                        })}
-                    </div>
-                )}
-            </div>
-        )}
-
-        {!loading && subTab === 'checkins' && (
-            <div className="space-y-4">
-                <div className="bg-neutral-900/40 border border-neutral-800 rounded-2xl p-4 shadow-[0_16px_40px_rgba(0,0,0,0.25)]">
-                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
-                        <div className="min-w-0">
-                            <div className="flex items-center gap-2">
-                                <History size={18} className="text-yellow-500" />
-                                <h3 className="text-base font-black text-white tracking-tight">Check-ins do aluno</h3>
-                            </div>
-                            <div className="mt-1 text-xs text-neutral-400 font-semibold">
-                                {studentCheckinsLoading ? 'Carregando...' : `${Array.isArray(studentCheckinsRows) ? studentCheckinsRows.length : 0} item(s)`}
-                            </div>
-                        </div>
-                        <div className="flex flex-col sm:flex-row gap-2">
-                            {['7d', '30d'].map((k) => (
-                                <button
-                                    key={k}
-                                    type="button"
-                                    onClick={() => setStudentCheckinsRange(k)}
-                                    className={`min-h-[44px] px-4 py-3 rounded-xl text-[11px] font-black uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        String(studentCheckinsRange || '7d') === k
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/15'
-                                            : 'bg-neutral-900/70 border border-neutral-800 text-neutral-200 hover:bg-neutral-900'
-                                    }`}
-                                >
-                                    {k === '7d' ? '7 dias' : '30 dias'}
-                                </button>
-                            ))}
-                            {['all', 'pre', 'post'].map((k) => (
-                                <button
-                                    key={k}
-                                    type="button"
-                                    onClick={() => setStudentCheckinsFilter(k)}
-                                    className={`min-h-[44px] px-4 py-3 rounded-xl text-[11px] font-black uppercase tracking-widest transition-all duration-300 active:scale-95 ${
-                                        String(studentCheckinsFilter || 'all') === k
-                                            ? 'bg-yellow-500 text-black shadow-lg shadow-yellow-500/15'
-                                            : 'bg-neutral-900/70 border border-neutral-800 text-neutral-200 hover:bg-neutral-900'
-                                    }`}
-                                >
-                                    {k === 'all' ? 'Todos' : k === 'pre' ? 'Pré' : 'Pós'}
-                                </button>
-                            ))}
-                        </div>
-                    </div>
-                </div>
-
-                {studentCheckinsError ? (
-                    <div className="bg-neutral-950/40 border border-yellow-500/20 rounded-2xl p-4 text-sm text-neutral-200">
-                        {studentCheckinsError}
-                    </div>
-                ) : null}
-
-                {(() => {
-                    const rows = Array.isArray(studentCheckinsRows) ? studentCheckinsRows : [];
-                    const filter = String(studentCheckinsFilter || 'all');
-                    const filtered = filter === 'all' ? rows : rows.filter((r) => String(r?.kind || '').trim() === filter);
-
-                    const toNumberOrNull = (v) => {
-                        const n = typeof v === 'number' ? v : Number(String(v ?? '').replace(',', '.'));
-                        return Number.isFinite(n) ? n : null;
-                    };
-                    const avg = (vals) => {
-                        const list = Array.isArray(vals) ? vals.filter((v) => typeof v === 'number' && Number.isFinite(v)) : [];
-                        if (!list.length) return null;
-                        return list.reduce((a, b) => a + b, 0) / list.length;
-                    };
-
-                    const preRows = rows.filter((r) => String(r?.kind || '').trim() === 'pre');
-                    const postRows = rows.filter((r) => String(r?.kind || '').trim() === 'post');
-                    const preAvgEnergy = avg(preRows.map((r) => toNumberOrNull(r?.energy)));
-                    const preAvgSoreness = avg(preRows.map((r) => toNumberOrNull(r?.soreness)));
-                    const preAvgTime = avg(preRows.map((r) => {
-                        const answers = r?.answers && typeof r.answers === 'object' ? r.answers : {};
-                        return toNumberOrNull(answers?.time_minutes ?? answers?.timeMinutes);
-                    }));
-                    const postAvgSoreness = avg(postRows.map((r) => toNumberOrNull(r?.soreness)));
-                    const postAvgSatisfaction = avg(postRows.map((r) => toNumberOrNull(r?.mood)));
-                    const postAvgRpe = avg(postRows.map((r) => {
-                        const answers = r?.answers && typeof r.answers === 'object' ? r.answers : {};
-                        return toNumberOrNull(answers?.rpe);
-                    }));
-
-                    const highSorenessCount = rows.filter((r) => {
-                        const s = toNumberOrNull(r?.soreness);
-                        return s != null && s >= 7;
-                    }).length;
-                    const lowEnergyCount = preRows.filter((r) => {
-                        const e = toNumberOrNull(r?.energy);
-                        return e != null && e <= 2;
-                    }).length;
-                    const alerts = [];
-                    if (highSorenessCount >= 3) alerts.push('Dor alta (≥ 7) apareceu 3+ vezes no período.');
-                    if (preAvgSoreness != null && preAvgSoreness >= 7) alerts.push('Média de dor no pré está alta (≥ 7).');
-                    if (lowEnergyCount >= 3) alerts.push('Energia baixa (≤ 2) apareceu 3+ vezes no período.');
-                    if (postAvgSatisfaction != null && postAvgSatisfaction <= 2) alerts.push('Satisfação média no pós está baixa (≤ 2).');
-
-                    const suggestions = [];
-                    if (highSorenessCount >= 3 || (preAvgSoreness != null && preAvgSoreness >= 7) || (postAvgSoreness != null && postAvgSoreness >= 7)) {
-                        suggestions.push('Dor alta: reduzir volume/carga 20–30% e priorizar técnica + mobilidade.');
-                    }
-                    if (lowEnergyCount >= 3 || (preAvgEnergy != null && preAvgEnergy <= 2.2)) {
-                        suggestions.push('Energia baixa: treino mais curto, sem falha, foco em recuperação (sono/estresse).');
-                    }
-                    if (postAvgRpe != null && postAvgRpe >= 9) {
-                        suggestions.push('RPE médio alto: reduzir intensidade e aumentar descanso entre séries.');
-                    }
-                    if (postAvgSatisfaction != null && postAvgSatisfaction <= 2) {
-                        suggestions.push('Satisfação baixa: revisar seleção de exercícios e meta da sessão.');
-                    }
-                    if (preAvgTime != null && preAvgTime > 0 && preAvgTime < 45) {
-                        suggestions.push('Pouco tempo: usar treino “mínimo efetivo” (menos exercícios e mais foco).');
-                    }
-
-                    return (
-                        <div className="space-y-4">
-                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Pré</div>
-                                    <div className="mt-2 grid grid-cols-3 gap-3">
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Energia</div>
-                                            <div className="font-black text-white">{preAvgEnergy == null ? '—' : preAvgEnergy.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Dor</div>
-                                            <div className="font-black text-white">{preAvgSoreness == null ? '—' : preAvgSoreness.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Tempo</div>
-                                            <div className="font-black text-white">{preAvgTime == null ? '—' : `${Math.round(preAvgTime)}m`}</div>
-                                        </div>
-                                    </div>
-                                </div>
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Pós</div>
-                                    <div className="mt-2 grid grid-cols-3 gap-3">
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">RPE</div>
-                                            <div className="font-black text-white">{postAvgRpe == null ? '—' : postAvgRpe.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Satisf.</div>
-                                            <div className="font-black text-white">{postAvgSatisfaction == null ? '—' : postAvgSatisfaction.toFixed(1)}</div>
-                                        </div>
-                                        <div>
-                                            <div className="text-[10px] font-black uppercase tracking-widest text-neutral-500">Dor</div>
-                                            <div className="font-black text-white">{postAvgSoreness == null ? '—' : postAvgSoreness.toFixed(1)}</div>
-                                        </div>
-                                    </div>
-                                </div>
-                            </div>
-
-                            {alerts.length ? (
-                                <div className="rounded-2xl border border-yellow-500/20 bg-yellow-500/10 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">Alertas</div>
-                                    <div className="mt-2 space-y-1 text-sm text-neutral-200">
-                                        {alerts.map((a) => (
-                                            <div key={a}>{a}</div>
-                                        ))}
-                                    </div>
-                                </div>
-                            ) : null}
-
-                            {suggestions.length ? (
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                    <div className="text-[11px] font-black uppercase tracking-widest text-neutral-200">Sugestões</div>
-                                    <div className="mt-2 space-y-1 text-sm text-neutral-200">
-                                        {suggestions.map((s) => (
-                                            <div key={s}>{s}</div>
-                                        ))}
-                                    </div>
-                                </div>
-                            ) : null}
-
-                            {filtered.length === 0 ? (
-                                <div className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4 text-sm text-neutral-400">
-                                    Nenhum check-in encontrado.
-                                </div>
-                            ) : (
-                                <div className="space-y-2">
-                                    {filtered.map((r) => {
-                                        const kind = String(r?.kind || '').trim();
-                                        const createdAt = r?.created_at ? new Date(String(r.created_at)) : null;
-                                        const dateLabel = createdAt && !Number.isNaN(createdAt.getTime()) ? createdAt.toLocaleString('pt-BR') : '—';
-                                        const energy = r?.energy != null ? String(r.energy) : '—';
-                                        const soreness = r?.soreness != null ? String(r.soreness) : '—';
-                                        const mood = r?.mood != null ? String(r.mood) : '—';
-                                        const answers = r?.answers && typeof r.answers === 'object' ? r.answers : {};
-                                        const rpe = answers?.rpe != null ? String(answers.rpe) : '—';
-                                        const timeMinutes = answers?.time_minutes != null ? String(answers.time_minutes) : answers?.timeMinutes != null ? String(answers.timeMinutes) : '—';
-                                        const notes = r?.notes ? String(r.notes) : '';
-                                        return (
-                                            <div key={String(r?.id || dateLabel)} className="rounded-2xl border border-neutral-800 bg-neutral-950/40 p-4">
-                                                <div className="flex items-start justify-between gap-3">
-                                                    <div className="min-w-0">
-                                                        <div className="text-[11px] font-black uppercase tracking-widest text-yellow-500">{kind === 'pre' ? 'Pré' : 'Pós'}</div>
-                                                        <div className="text-xs text-neutral-500">{dateLabel}</div>
-                                                    </div>
-                                                    <div className="text-xs text-neutral-300 font-mono">
-                                                        {kind === 'pre' ? `E:${energy} D:${soreness} T:${timeMinutes}` : `RPE:${rpe} Sat:${mood} D:${soreness}`}
-                                                    </div>
-                                                </div>
-                                                {notes ? <div className="mt-2 text-sm text-neutral-200">{notes}</div> : null}
-                                            </div>
-                                        );
-                                    })}
-                                </div>
-                            )}
-                        </div>
-                    );
-                })()}
-            </div>
-        )}
-
-        {!loading && subTab === 'evolution' && (
-                            <div className="space-y-4">
-                                <AssessmentButton studentId={selectedStudent.user_id || selectedStudent.id} studentName={selectedStudent.name} variant="card" />
-                                {assessments.length > 0 && (
-                                    <div className="bg-neutral-800 p-4 rounded-xl border border-neutral-700">
-                                        <h4 className="font-bold text-white mb-3">Avaliações Anteriores</h4>
-                                        {assessments.map(a => (
-                                            <div key={a.id} className="flex justify-between items-center py-2 border-b border-neutral-700 last:border-0">
-                                                <span className="text-neutral-400">{new Date(a.date).toLocaleDateString()}</span>
-                                                <div className="text-right">
-                                                    <span className="block font-bold text-white">{a.bf}% Gordura</span>
-                                                    <span className="text-xs text-neutral-500">{a.weight}kg</span>
-                                                </div>
-                                            </div>
-                                        ))}
-                                    </div>
-                                )}
-                            </div>
-                )}
-            </div>
-        )}
-
-                {prioritiesComposeOpen ? (
-                    <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setPrioritiesComposeOpen(false)}>
-                        <div className="bg-neutral-900 w-full max-w-2xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="font-black text-white">Enviar mensagem</div>
-                                <button
-                                    type="button"
-                                    onClick={() => setPrioritiesComposeOpen(false)}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-3">
-                                <textarea
-                                    value={prioritiesComposeText}
-                                    onChange={(e) => setPrioritiesComposeText(e.target.value)}
-                                    rows={5}
-                                    className="w-full bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white placeholder:text-neutral-600 focus:border-yellow-500 focus:outline-none"
-                                    placeholder="Escreva sua mensagem..."
-                                />
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        type="button"
-                                        onClick={() => setPrioritiesComposeOpen(false)}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95"
-                                    >
-                                        Cancelar
-                                    </button>
-                                    <button
-                                        type="button"
-                                        onClick={async () => {
-                                            try {
-                                                const content = String(prioritiesComposeText || '').trim();
-                                                const studentId = String(prioritiesComposeStudentId || '').trim();
-                                                const kind = String(prioritiesComposeKind || '').trim();
-                                                if (!content || !studentId || !kind) return;
-                                                const res = await fetch('/api/teacher/inbox/send-message', {
-                                                    method: 'POST',
-                                                    credentials: 'include',
-                                                    headers: { 'content-type': 'application/json' },
-                                                    body: JSON.stringify({ student_user_id: studentId, content }),
-                                                });
-                                                const json = await res.json().catch(() => null);
-                                                if (!res.ok || !json?.ok) {
-                                                    await alert(String(json?.error || `Falha ao enviar (${res.status})`));
-                                                    return;
-                                                }
-                                                try {
-                                                    await fetch('/api/teacher/inbox/action', {
-                                                        method: 'POST',
-                                                        credentials: 'include',
-                                                        headers: { 'content-type': 'application/json' },
-                                                        body: JSON.stringify({ student_user_id: studentId, kind, action: 'done' }),
-                                                    });
-                                                } catch {}
-                                                setPrioritiesComposeOpen(false);
-                                                setPrioritiesComposeStudentId('');
-                                                setPrioritiesComposeKind('');
-                                                setPrioritiesComposeText('');
-                                                fetchPriorities();
-                                            } catch (e) {
-                                                await alert('Erro: ' + (e?.message ?? String(e)));
-                                            }
-                                        }}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 active:scale-95"
-                                    >
-                                        Enviar
-                                    </button>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                ) : null}
-
-                {prioritiesSettingsOpen ? (
-                    <div className="fixed inset-0 z-[90] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setPrioritiesSettingsOpen(false)}>
-                        <div className="bg-neutral-900 w-full max-w-2xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="font-black text-white">Configurar Prioridades</div>
-                                <button
-                                    type="button"
-                                    onClick={() => setPrioritiesSettingsOpen(false)}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4 space-y-4">
-                                {prioritiesSettingsError ? (
-                                    <div className="bg-neutral-900/60 border border-red-500/30 rounded-2xl p-4 text-red-200 font-bold text-sm">
-                                        {prioritiesSettingsError}
-                                    </div>
-                                ) : null}
-                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Churn (dias sem treino)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.churnDays ?? COACH_INBOX_DEFAULTS.churnDays)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), churnDays: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Queda de volume (%)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.volumeDropPct ?? COACH_INBOX_DEFAULTS.volumeDropPct)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), volumeDropPct: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Aumento de carga (%)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.loadSpikePct ?? COACH_INBOX_DEFAULTS.loadSpikePct)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), loadSpikePct: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Volume mínimo (7d anterior)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.minPrev7Volume ?? COACH_INBOX_DEFAULTS.minPrev7Volume)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), minPrev7Volume: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Volume mínimo (7d atual p/ spike)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.minCurrent7VolumeSpike ?? COACH_INBOX_DEFAULTS.minCurrent7VolumeSpike)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), minCurrent7VolumeSpike: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                    <div className="space-y-1">
-                                        <div className="text-[11px] font-black uppercase tracking-widest text-neutral-500">Soneca padrão (min)</div>
-                                        <input
-                                            type="number"
-                                            value={String(prioritiesSettings?.snoozeDefaultMinutes ?? COACH_INBOX_DEFAULTS.snoozeDefaultMinutes)}
-                                            onChange={(e) => setPrioritiesSettings((prev) => ({ ...(prev || {}), snoozeDefaultMinutes: e.target.value }))}
-                                            className="w-full min-h-[44px] bg-neutral-900/70 border border-neutral-800 rounded-xl px-3 py-2 text-white focus:outline-none focus:border-yellow-500"
-                                        />
-                                    </div>
-                                </div>
-                                <div className="flex flex-col sm:flex-row gap-2">
-                                    <button
-                                        type="button"
-                                        disabled={prioritiesSettingsLoading}
-                                        onClick={() => {
-                                            setPrioritiesSettings({ ...COACH_INBOX_DEFAULTS });
-                                            setPrioritiesSettingsError('');
-                                        }}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-200 rounded-xl font-black transition-all duration-300 active:scale-95 disabled:opacity-60"
-                                    >
-                                        Resetar
-                                    </button>
-                                    <button
-                                        type="button"
-                                        disabled={prioritiesSettingsLoading}
-                                        onClick={async () => {
-                                            const ok = await savePrioritiesSettings();
-                                            if (!ok) return;
-                                            setPrioritiesSettingsOpen(false);
-                                            fetchPriorities();
-                                        }}
-                                        className="flex-1 min-h-[44px] px-4 py-3 bg-yellow-500 hover:bg-yellow-400 text-black rounded-xl font-black transition-all duration-300 active:scale-95 disabled:opacity-60"
-                                    >
-                                        {prioritiesSettingsLoading ? 'Salvando...' : 'Salvar'}
-                                    </button>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                ) : null}
-
-                {executionVideoModalOpen && executionVideoModalUrl ? (
-                    <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => { setExecutionVideoModalOpen(false); setExecutionVideoModalUrl(''); }}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex items-center justify-between gap-3">
-                                <div className="font-black text-white">Vídeo de execução</div>
-                                <button
-                                    type="button"
-                                    onClick={() => { setExecutionVideoModalOpen(false); setExecutionVideoModalUrl(''); }}
-                                    className="w-10 h-10 rounded-full bg-neutral-900/70 border border-neutral-800 hover:bg-neutral-900 text-neutral-300 hover:text-white flex items-center justify-center transition-all duration-300 active:scale-95"
-                                    aria-label="Fechar"
-                                >
-                                    <X size={18} />
-                                </button>
-                            </div>
-                            <div className="p-4">
-                                <video src={executionVideoModalUrl} controls className="w-full rounded-xl bg-black" />
-                            </div>
-                        </div>
-                    </div>
-                ) : null}
-
-                {editingTemplate && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setEditingTemplate(null)}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Editar Treino</h3>
-                                <button onClick={() => setEditingTemplate(null)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 max-h-[75vh] overflow-y-auto">
-                                <AdminWorkoutEditor
-                                    initialData={editingTemplate}
-                                    onSave={async (data) => {
-                                        try {
-                                            const res = await updateWorkout(editingTemplate.id, data);
-                                            const sync = res?.sync || null;
-                                            const { data: refreshed } = await supabase
-                                                .from('workouts')
-                                                .select('*, exercises(*, sets(*))')
-                                                .or(`created_by.eq.${user.id},user_id.eq.${user.id}`)
-                                                .order('name');
-                                            setTemplates(refreshed || []);
-                                            setEditingTemplate(null);
-                                            if (sync) {
-                                                const created = Number(sync?.created || 0);
-                                                const updated = Number(sync?.updated || 0);
-                                                const failed = Number(sync?.failed || 0);
-                                                const msg = sync?.error
-                                                    ? `Treino salvo. Sincronização falhou: ${String(sync.error)}`
-                                                    : `Treino salvo. Sincronizados: ${updated} atualizado(s), ${created} criado(s)${failed ? `, ${failed} falha(s)` : ''}.`;
-                                                await alert(msg, 'Sucesso');
-                                            } else {
-                                                await alert('Treino salvo com sucesso!', 'Sucesso');
-                                            }
-                                        } catch (e) { await alert('Erro ao salvar: ' + (e?.message ?? String(e))); }
-                                    }}
-                                    onCancel={() => setEditingTemplate(null)}
-                                />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {historyOpen && selectedStudent && (
-                    <div className="fixed inset-0 z-[1500] bg-neutral-900 overflow-y-auto">
-                        <HistoryList
-                            user={user}
-                            targetId={selectedStudent?.user_id || selectedStudent?.id}
-                            targetEmail={selectedStudent?.email || ''}
-                            readOnly
-                            title={`Histórico - ${selectedStudent?.name || selectedStudent?.email || 'Aluno'}`}
-                            onBack={() => setHistoryOpen(false)}
-                        />
-                    </div>
-                )}
-
-                {editingStudentWorkout && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setEditingStudentWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Editar Treino do Aluno</h3>
-                                <button onClick={() => setEditingStudentWorkout(null)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 max-h-[75vh] overflow-y-auto">
-                                <AdminWorkoutEditor
-                                    initialData={editingStudentWorkout}
-                                    onSave={async (data) => {
-                                        try {
-                                            const targetUserId = selectedStudent.user_id || '';
-                                            if (!targetUserId) { await alert('Aluno sem conta (user_id).'); return; }
-                                            if (editingStudentWorkout.id) {
-                                                await updateWorkout(editingStudentWorkout.id, data);
-                                            } else {
-                                            const { data: nw } = await supabase
-                                                .from('workouts')
-                                                .insert({ user_id: targetUserId, name: data.title || 'Novo Treino', notes: '', created_by: user.id, is_template: true })
-                                                .select()
-                                                .single();
-                                                const toInsert = (data.exercises || []).map(e => ({
-                                                    workout_id: nw.id,
-                                                    name: e.name || '',
-                                                    sets: getSetsCount(e?.sets) || 4,
-                                                    reps: e.reps ?? '10',
-                                                    rpe: e.rpe ?? 8,
-                                                    cadence: e.cadence || '2020',
-                                                    rest_time: e.restTime ?? e.rest_time ?? 60,
-                                                    method: e.method || 'Normal',
-                                                    video_url: e.videoUrl || e.video_url || '',
-                                                    notes: e.notes || ''
-                                                }));
-                                                if (toInsert.length) await supabase.from('exercises').insert(toInsert);
-                                            }
-                const { data: refreshed } = await supabase
-                    .from('workouts')
-                    .select('*, exercises(*, sets(*))')
-                    .eq('user_id', targetUserId)
-                    .eq('is_template', true)
-                    .order('name');
-                const list = refreshed || [];
-                const synced = (list || []).filter(w => (String(w?.created_by || '') === String(user.id)) && (String(w?.user_id || '') === String(targetUserId)));
-                const syncedIds = new Set((synced || []).map(w => w?.id).filter(Boolean));
-                const others = (list || []).filter(w => !syncedIds.has(w?.id));
-                setStudentWorkouts(others || []);
-                setSyncedWorkouts(synced || []);
-                setEditingStudentWorkout(null);
-            } catch (e) { await alert('Erro ao salvar: ' + (e?.message ?? String(e))); }
-                                    }}
-                                    onCancel={() => setEditingStudentWorkout(null)}
-                                />
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {viewWorkout && (
-                    <div className="fixed inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setViewWorkout(null)}>
-                        <div className="bg-neutral-900 w-full max-w-3xl rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Treino: {normalizeWorkoutTitle(viewWorkout.name)}</h3>
-                                <button onClick={() => setViewWorkout(null)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 space-y-4 max-h-[75vh] overflow-y-auto">
-                                <div className="space-y-2">
-                                    {(viewWorkout.exercises || []).map((e, i) => (
-                                        <div key={i} className="bg-neutral-800 p-3 rounded-lg border border-neutral-700">
-                                            <div className="font-bold text-white">{e.name}</div>
-                                            <div className="text-xs text-neutral-400">Sets {getSetsCount(e?.sets)} • Reps {e.reps ?? '-'} • RPE {e.rpe ?? '-'} • Rest {e.rest_time ?? e.restTime ?? '-'}s • Cad {e.cadence ?? '-'}</div>
-                                            {e.notes && <div className="text-xs text-neutral-300 mt-1">{e.notes}</div>}
-                                        </div>
-                                    ))}
-                                </div>
-                                <div className="flex gap-2">
-                                    <div className="relative">
-                                        <button onClick={() => setExportOpen(true)} className="px-4 py-2 bg-yellow-500 text-black font-bold rounded-lg inline-flex items-center gap-2">
-                                            <Download size={16}/> Salvar / Exportar
-                                        </button>
-                                    </div>
-                                </div>
-                            </div>
-                        </div>
-                    </div>
-                )}
-
-                {exportOpen && viewWorkout && (
-                    <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setExportOpen(false)}>
-                        <div className="bg-neutral-900 w-full max-w-md rounded-2xl border border-neutral-800 shadow-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
-                            <div className="p-4 border-b border-neutral-800 flex justify-between items-center">
-                                <h3 className="font-bold text-white">Como deseja salvar?</h3>
-                                <button onClick={() => setExportOpen(false)} className="px-3 py-1.5 hover:bg-neutral-800 rounded-full inline-flex items-center gap-2 text-neutral-300"><ArrowLeft size={16} /><span className="text-xs font-bold">Voltar</span></button>
-                            </div>
-                            <div className="p-4 space-y-3">
-                                <button onClick={handleExportPdf} className="w-full px-4 py-3 bg-yellow-500 text-black font-bold rounded-xl inline-flex items-center justify-center gap-2">
-                                    <FileText size={18}/> Baixar PDF
-                                </button>
-                                <button onClick={handleExportJson} className="w-full px-4 py-3 bg-neutral-800 border border-neutral-700 text-neutral-200 font-bold rounded-xl inline-flex items-center justify-center gap-2">
-                                    <Download size={18}/> Baixar JSON
-                                </button>
-                            </div>
-                        </div>
-                    </div>
-                )}
-            </div>
-
-            {showRegisterModal && (
-                <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
-                    <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 shadow-2xl">
-                        <h3 className="font-bold text-white text-xl mb-4 flex items-center gap-2"><UserPlus size={24} className="text-yellow-500"/> Novo Aluno</h3>
-                        <div className="space-y-3">
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Nome Completo</label>
-                                <input value={newStudent.name} onChange={e => setNewStudent({ ...newStudent, name: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Email</label>
-                                <input value={newStudent.email} onChange={e => setNewStudent({ ...newStudent, email: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                        </div>
-                        <div className="flex gap-2 mt-6">
-                            <button onClick={() => setShowRegisterModal(false)} className="flex-1 p-3 bg-neutral-800 text-neutral-400 font-bold rounded-xl hover:bg-neutral-700">Cancelar</button>
-                            <button onClick={handleRegisterStudent} disabled={registering} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 disabled:opacity-50">{registering ? 'Cadastrando...' : 'CADASTRAR'}</button>
-                        </div>
-                    </div>
-                </div>
-            )}
-
-            {showTeacherModal && (
-                <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
-                    <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 shadow-2xl">
-                        <h3 className="font-bold text-white text-xl mb-4 flex items-center gap-2"><UserPlus size={24} className="text-yellow-500"/> Novo Professor</h3>
-                        <div className="space-y-3">
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Nome Completo</label>
-                                <input value={newTeacher.name} onChange={e => setNewTeacher({ ...newTeacher, name: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Email</label>
-                                <input value={newTeacher.email} onChange={e => setNewTeacher({ ...newTeacher, email: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">WhatsApp / Telefone</label>
-                                <input value={newTeacher.phone} onChange={e => setNewTeacher({ ...newTeacher, phone: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                        </div>
-                        <div className="flex gap-2 mt-6">
-                            <button onClick={() => setShowTeacherModal(false)} className="flex-1 p-3 bg-neutral-800 text-neutral-400 font-bold rounded-xl hover:bg-neutral-700">Cancelar</button>
-                            <button onClick={handleAddTeacher} disabled={addingTeacher} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400 disabled:opacity-50">{addingTeacher ? 'Salvando...' : 'ADICIONAR'}</button>
-                        </div>
-                    </div>
-                </div>
-            )}
-
-            {editingTeacher && (
-                <div className="fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
-                    <div className="bg-neutral-900 p-6 rounded-2xl w-full max-w-sm border border-neutral-800 shadow-2xl">
-                        <h3 className="font-bold text-white text-xl mb-4 flex items-center gap-2"><Edit3 size={24} className="text-yellow-500"/> Editar Professor</h3>
-                        <div className="space-y-3">
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Nome Completo</label>
-                                <input value={editingTeacher.name} onChange={e => setEditingTeacher({ ...editingTeacher, name: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Email</label>
-                                <input value={editingTeacher.email} onChange={e => setEditingTeacher({ ...editingTeacher, email: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">WhatsApp / Telefone</label>
-                                <input value={editingTeacher.phone || ''} onChange={e => setEditingTeacher({ ...editingTeacher, phone: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                            <div>
-                                <label className="text-xs text-neutral-500 uppercase font-bold">Data de Nascimento</label>
-                                <input type="date" value={editingTeacher.birth_date || ''} onChange={e => setEditingTeacher({ ...editingTeacher, birth_date: e.target.value })} className="w-full bg-neutral-800 p-3 rounded-lg text-white border border-neutral-700 focus:border-yellow-500 outline-none" />
-                            </div>
-                        </div>
-                        <div className="flex gap-2 mt-6">
-                            <button onClick={() => setEditingTeacher(null)} className="flex-1 p-3 bg-neutral-800 text-neutral-400 font-bold rounded-xl hover:bg-neutral-700">Cancelar</button>
-                            <button onClick={handleUpdateTeacher} className="flex-1 p-3 bg-yellow-500 text-black font-bold rounded-xl hover:bg-yellow-400">SALVAR</button>
-                        </div>
-                    </div>
-                </div>
-            )}
-        </div>
-    );
-};
-
-export default AdminPanelV2;
+export default AdminPanelV2
diff --git a/src/hooks/useAssessment 4.ts b/src/hooks/useAssessment 4.ts
deleted file mode 100644
index 2c5c064..0000000
--- a/src/hooks/useAssessment 4.ts	
+++ /dev/null
@@ -1,451 +0,0 @@
-// Hook para gerenciamento de avaliações físicas
-'use client';
-import { useState, useCallback, useEffect, useMemo } from 'react';
-import { createClient } from '@/utils/supabase/client';
-import {
-  Assessment,
-  AssessmentFormData,
-  AssessmentResponse,
-  CreateAssessmentRequest,
-  UpdateAssessmentRequest,
-  parseNumberInput
-} from '@/types/assessment';
-import {
-  calculateBodyFatPercentage,
-  calculateBMR,
-  calculateBMI,
-  calculateFatMass,
-  calculateLeanMass,
-  calculateBodyDensity,
-  calculateSumSkinfolds
-} from '@/utils/calculations/bodyComposition';
-
-interface UseAssessmentReturn {
-  // Estado
-  assessments: Assessment[];
-  loading: boolean;
-  error: string | null;
-  
-  // Ações
-  createAssessment: (data: AssessmentFormData, studentId: string) => Promise<AssessmentResponse>;
-  updateAssessment: (id: string, data: UpdateAssessmentRequest) => Promise<AssessmentResponse>;
-  deleteAssessment: (id: string) => Promise<AssessmentResponse>;
-  getAssessment: (id: string) => Promise<Assessment | null>;
-  getStudentAssessments: (studentId: string) => Promise<Assessment[]>;
-  refreshAssessments: () => Promise<void>;
-  
-  // Utilitários
-  clearError: () => void;
-  formDataToAssessment: (data: AssessmentFormData, studentId: string) => CreateAssessmentRequest;
-}
-
-export const useAssessment = (): UseAssessmentReturn => {
-  const supabase = useMemo(() => createClient(), []);
-  const [user, setUser] = useState<any>(null);
-  const [assessments, setAssessments] = useState<Assessment[]>([]);
-  const [loading, setLoading] = useState(false);
-  const [error, setError] = useState<string | null>(null);
-  const [currentStudentId, setCurrentStudentId] = useState<string | null>(null);
-
-  useEffect(() => {
-    let isMounted = true;
-
-    const loadUser = async () => {
-      try {
-        const {
-          data: { user }
-        } = await supabase.auth.getUser();
-
-        if (isMounted) {
-          setUser(user);
-        }
-      } catch (e) {
-        console.error('Erro ao carregar usuário no hook useAssessment', e);
-        if (isMounted) {
-          setUser(null);
-        }
-      }
-    };
-
-    loadUser();
-
-    return () => {
-      isMounted = false;
-    };
-  }, [supabase]);
-
-  // Limpar erro
-  const clearError = useCallback(() => {
-    setError(null);
-  }, []);
-
-  const resolveStudentRecordId = useCallback(
-    async (rawStudentId: string): Promise<string> => {
-      const candidateId = (rawStudentId || '').trim();
-
-      if (!candidateId) {
-        throw new Error('ID do aluno não informado para a avaliação.');
-      }
-
-      try {
-        // Tenta buscar direto na profiles (se for ID de usuário)
-        const { data: directProfile, error: directProfileError } = await supabase
-          .from('profiles')
-          .select('id')
-          .eq('id', candidateId)
-          .maybeSingle();
-
-        if (directProfileError) {
-          console.error('Erro ao buscar perfil do aluno (por id) para avaliação', directProfileError);
-        }
-
-        if (directProfile?.id) {
-          return directProfile.id as string;
-        }
-
-        // Tenta buscar na tabela students pelo ID do registro
-        const { data: studentById, error: studentByIdError } = await supabase
-          .from('students')
-          .select('id, user_id, email')
-          .eq('id', candidateId)
-          .maybeSingle();
-
-        if (studentByIdError) {
-          console.error('Erro ao buscar aluno por id para avaliação', studentByIdError);
-        }
-
-        if (studentById?.user_id) {
-          try {
-            const { data: profileForStudent } = await supabase
-              .from('profiles')
-              .select('id')
-              .eq('id', studentById.user_id)
-              .maybeSingle();
-
-            if (profileForStudent?.id) {
-              return profileForStudent.id as string;
-            }
-          } catch (e) {
-            console.error('Erro ao validar perfil vinculado ao aluno (por id)', e);
-            return studentById.user_id as string;
-          }
-        }
-
-        // Tenta buscar pelo email na profiles
-        if (studentById?.email) {
-          const { data: profileByEmail, error: profileByEmailError } = await supabase
-            .from('profiles')
-            .select('id')
-            .ilike('email', studentById.email)
-            .maybeSingle();
-
-          if (profileByEmailError) {
-            console.error('Erro ao buscar perfil por email do aluno (por id)', profileByEmailError);
-          }
-
-          if (profileByEmail?.id) {
-            return profileByEmail.id as string;
-          }
-        }
-
-        // Tenta buscar na students pelo user_id
-        const { data: studentByUser, error: studentByUserError } = await supabase
-          .from('students')
-          .select('id, user_id, email')
-          .eq('user_id', candidateId)
-          .maybeSingle();
-
-        if (studentByUserError) {
-          console.error('Erro ao buscar aluno por user_id para avaliação', studentByUserError);
-        }
-
-        if (studentByUser?.user_id) {
-          return studentByUser.user_id as string;
-        }
-
-        throw new Error(
-          'Não foi possível localizar um perfil vinculado a este aluno. Verifique se o aluno já ativou a conta pelo convite.'
-        );
-      } catch (e) {
-        const message =
-          e instanceof Error
-            ? e.message
-            : 'Falha ao resolver o perfil vinculado à avaliação.';
-        throw new Error(message);
-      }
-    },
-    [supabase]
-  );
-
-  const normalizeAssessmentRow = useCallback((row: any): Assessment => {
-    if (!row || typeof row !== 'object') {
-      return row;
-    }
-
-    const toNumberOrUndefined = (value: any) => {
-      if (typeof value === 'number') return value;
-      if (typeof value === 'string') {
-        const parsed = parseFloat(value);
-        return isNaN(parsed) ? undefined : parsed;
-      }
-      return undefined;
-    };
-
-    return {
-      ...row,
-      weight: toNumberOrUndefined(row.weight) ?? 0,
-      height: toNumberOrUndefined(row.height) ?? 0,
-      age: toNumberOrUndefined(row.age) ?? 0,
-      
-      // Circunferências
-      arm_circ: toNumberOrUndefined(row.arm_circ),
-      chest_circ: toNumberOrUndefined(row.chest_circ),
-      waist_circ: toNumberOrUndefined(row.waist_circ),
-      hip_circ: toNumberOrUndefined(row.hip_circ),
-      thigh_circ: toNumberOrUndefined(row.thigh_circ),
-      calf_circ: toNumberOrUndefined(row.calf_circ),
-
-      // Dobras
-      triceps_skinfold: toNumberOrUndefined(row.triceps_skinfold),
-      biceps_skinfold: toNumberOrUndefined(row.biceps_skinfold),
-      subscapular_skinfold: toNumberOrUndefined(row.subscapular_skinfold),
-      suprailiac_skinfold: toNumberOrUndefined(row.suprailiac_skinfold),
-      abdominal_skinfold: toNumberOrUndefined(row.abdominal_skinfold),
-      thigh_skinfold: toNumberOrUndefined(row.thigh_skinfold),
-      calf_skinfold: toNumberOrUndefined(row.calf_skinfold),
-
-      // Cálculos
-      body_fat_percentage: toNumberOrUndefined(row.body_fat_percentage),
-      lean_mass: toNumberOrUndefined(row.lean_mass),
-      fat_mass: toNumberOrUndefined(row.fat_mass),
-      bmr: toNumberOrUndefined(row.bmr),
-      tdee: toNumberOrUndefined(row.tdee),
-      bmi: toNumberOrUndefined(row.bmi),
-    } as Assessment;
-  }, []);
-
-  const getAssessment = useCallback(async (id: string) => {
-    try {
-      setLoading(true);
-      setError(null);
-      const { data, error } = await supabase
-        .from('assessments')
-        .select('*')
-        .eq('id', id)
-        .single();
-
-      if (error) throw error;
-      return normalizeAssessmentRow(data);
-    } catch (e: any) {
-      console.error('Erro ao buscar avaliação:', e);
-      setError(e.message);
-      return null;
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, normalizeAssessmentRow]);
-
-  const getStudentAssessments = useCallback(async (studentId: string) => {
-    try {
-      setLoading(true);
-      setError(null);
-      
-      const resolvedId = await resolveStudentRecordId(studentId);
-      setCurrentStudentId(resolvedId);
-
-      const { data, error } = await supabase
-        .from('assessments')
-        .select('*')
-        .eq('student_id', resolvedId)
-        .order('assessment_date', { ascending: false });
-
-      if (error) throw error;
-      
-      const normalized = (data || []).map(normalizeAssessmentRow);
-      setAssessments(normalized);
-      return normalized;
-    } catch (e: any) {
-      console.error('Erro ao buscar avaliações do aluno:', e);
-      setError(e.message);
-      return [];
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, resolveStudentRecordId, normalizeAssessmentRow]);
-
-  const refreshAssessments = useCallback(async () => {
-    if (currentStudentId) {
-      await getStudentAssessments(currentStudentId);
-    }
-  }, [currentStudentId, getStudentAssessments]);
-
-  const formDataToAssessment = useCallback((data: AssessmentFormData, studentId: string): CreateAssessmentRequest => {
-    // Converter valores
-    const weight = parseNumberInput(data.weight) || 0;
-    const height = parseNumberInput(data.height) || 0;
-    const age = parseInt(data.age) || 0;
-    const gender = data.gender;
-
-    // Dobras
-    const triceps = parseNumberInput(data.triceps_skinfold);
-    const biceps = parseNumberInput(data.biceps_skinfold);
-    const subscapular = parseNumberInput(data.subscapular_skinfold);
-    const suprailiac = parseNumberInput(data.suprailiac_skinfold);
-    const abdominal = parseNumberInput(data.abdominal_skinfold);
-    const thigh = parseNumberInput(data.thigh_skinfold);
-    const calf = parseNumberInput(data.calf_skinfold);
-
-    // Calcular métricas
-    const sumSkinfolds = calculateSumSkinfolds({
-      triceps_skinfold: triceps ?? undefined,
-      biceps_skinfold: biceps ?? undefined,
-      subscapular_skinfold: subscapular ?? undefined,
-      suprailiac_skinfold: suprailiac ?? undefined,
-      abdominal_skinfold: abdominal ?? undefined,
-      thigh_skinfold: thigh ?? undefined,
-      calf_skinfold: calf ?? undefined,
-    });
-
-    const bodyDensity = calculateBodyDensity(sumSkinfolds, age, gender);
-    const bodyFat = calculateBodyFatPercentage(bodyDensity);
-    const fatMass = calculateFatMass(weight, bodyFat);
-    const leanMass = calculateLeanMass(weight, fatMass);
-    const bmi = calculateBMI(weight, height);
-    const bmr = calculateBMR(weight, height, age, gender);
-
-    return {
-      student_id: studentId,
-      trainer_id: user?.id, // Será preenchido pelo hook ou backend
-      assessment_date: data.assessment_date,
-      weight,
-      height,
-      age,
-      gender,
-      
-      // Circunferências
-      arm_circ: parseNumberInput(data.arm_circ) ?? undefined,
-      chest_circ: parseNumberInput(data.chest_circ) ?? undefined,
-      waist_circ: parseNumberInput(data.waist_circ) ?? undefined,
-      hip_circ: parseNumberInput(data.hip_circ) ?? undefined,
-      thigh_circ: parseNumberInput(data.thigh_circ) ?? undefined,
-      calf_circ: parseNumberInput(data.calf_circ) ?? undefined,
-
-      // Dobras
-      triceps_skinfold: triceps ?? undefined,
-      biceps_skinfold: biceps ?? undefined,
-      subscapular_skinfold: subscapular ?? undefined,
-      suprailiac_skinfold: suprailiac ?? undefined,
-      abdominal_skinfold: abdominal ?? undefined,
-      thigh_skinfold: thigh ?? undefined,
-      calf_skinfold: calf ?? undefined,
-
-      // Calculados
-      body_fat_percentage: bodyFat,
-      lean_mass: leanMass,
-      fat_mass: fatMass,
-      bmi,
-      bmr,
-      
-      observations: data.observations
-    };
-  }, [user?.id]);
-
-  const createAssessment = useCallback(async (data: AssessmentFormData, studentId: string): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      if (!user?.id) throw new Error('Usuário não autenticado');
-
-      const resolvedStudentId = await resolveStudentRecordId(studentId);
-      const payload = formDataToAssessment(data, resolvedStudentId);
-      
-      // Garantir trainer_id
-      payload.trainer_id = user.id;
-
-      const { data: newAssessment, error: insertError } = await supabase
-        .from('assessments')
-        .insert(payload)
-        .select()
-        .single();
-
-      if (insertError) throw insertError;
-
-      const normalized = normalizeAssessmentRow(newAssessment);
-      setAssessments(prev => [normalized, ...prev]);
-      
-      return { success: true, data: normalized };
-    } catch (e: any) {
-      console.error('Erro ao criar avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, user?.id, resolveStudentRecordId, formDataToAssessment, normalizeAssessmentRow]);
-
-  const updateAssessment = useCallback(async (id: string, data: UpdateAssessmentRequest): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      const { data: updated, error: updateError } = await supabase
-        .from('assessments')
-        .update(data)
-        .eq('id', id)
-        .select()
-        .single();
-
-      if (updateError) throw updateError;
-
-      const normalized = normalizeAssessmentRow(updated);
-      setAssessments(prev => prev.map(a => a.id === id ? normalized : a));
-
-      return { success: true, data: normalized };
-    } catch (e: any) {
-      console.error('Erro ao atualizar avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase, normalizeAssessmentRow]);
-
-  const deleteAssessment = useCallback(async (id: string): Promise<AssessmentResponse> => {
-    try {
-      setLoading(true);
-      setError(null);
-
-      const { error: deleteError } = await supabase
-        .from('assessments')
-        .delete()
-        .eq('id', id);
-
-      if (deleteError) throw deleteError;
-
-      setAssessments(prev => prev.filter(a => a.id !== id));
-
-      return { success: true };
-    } catch (e: any) {
-      console.error('Erro ao excluir avaliação:', e);
-      setError(e.message);
-      return { success: false, error: e.message };
-    } finally {
-      setLoading(false);
-    }
-  }, [supabase]);
-
-  return {
-    assessments,
-    loading,
-    error,
-    createAssessment,
-    updateAssessment,
-    deleteAssessment,
-    getAssessment,
-    getStudentAssessments,
-    refreshAssessments,
-    clearError,
-    formDataToAssessment
-  };
-};
diff --git a/src/utils/vip/limits.ts b/src/utils/vip/limits.ts
index e6983ee..8fb3bdc 100644
--- a/src/utils/vip/limits.ts
+++ b/src/utils/vip/limits.ts
@@ -13,11 +13,12 @@ export type VipTierLimits = {
 
 export type VipEntitlementSource =
   | 'role'
+  | 'entitlement_table'
   | 'app_subscription'
-  | 'marketplace_subscription'
   | 'free_no_subscription'
+  | 'entitlement_missing_plan'
+  | 'entitlement_invalid'
   | 'app_subscription_missing_plan'
-  | 'marketplace_subscription_missing_plan'
 
 export type VipPlanResult = {
   tier: string
@@ -59,7 +60,67 @@ export async function getVipPlanLimits(supabase: SupabaseClient, userId: string)
     return { tier: 'admin', limits: UNLIMITED_LIMITS, source: 'role' }
   }
 
-  // 2. Check App Subscriptions (In-App Purchases)
+  // 2. Check Entitlements Table (preferred)
+  const nowIso = new Date().toISOString()
+  const { data: ent } = await supabase
+    .from('user_entitlements')
+    .select(
+      'id, plan_id, status, provider, provider_subscription_id, valid_from, valid_until, current_period_end, limits_override, created_at',
+    )
+    .eq('user_id', userId)
+    .in('status', ['active', 'trialing', 'past_due'])
+    .lte('valid_from', nowIso)
+    .or(`valid_until.is.null,valid_until.gte.${nowIso}`)
+    .order('valid_until', { ascending: false, nullsFirst: true })
+    .order('created_at', { ascending: false })
+    .limit(1)
+    .maybeSingle()
+
+  if (ent?.id) {
+    const override = ent?.limits_override && typeof ent.limits_override === 'object' ? ent.limits_override : null
+    if (override && Object.keys(override).length > 0) {
+      return {
+        tier: String(ent.plan_id || 'custom'),
+        limits: { ...FREE_LIMITS, ...(override as any) },
+        source: 'entitlement_table',
+        debug: {
+          entitlement_id: ent.id || null,
+          provider: ent.provider || null,
+          provider_subscription_id: ent.provider_subscription_id || null,
+          entitlement_status: ent.status || null,
+          valid_until: ent.valid_until || null,
+        },
+      }
+    }
+
+    if (ent?.plan_id) {
+      const limits = await fetchPlanLimits(supabase, ent.plan_id)
+      if (limits) {
+        return {
+          tier: ent.plan_id,
+          limits,
+          source: 'entitlement_table',
+          debug: { entitlement_id: ent.id || null, entitlement_status: ent.status || null },
+        }
+      }
+      console.warn('vip_entitlement_missing_plan', {
+        source: 'entitlement_table',
+        entitlement_id: ent.id || null,
+        plan_id: ent.plan_id,
+        status: ent.status || null,
+      })
+      return {
+        tier: 'free',
+        limits: FREE_LIMITS,
+        source: 'entitlement_missing_plan',
+        debug: { entitlement_id: ent.id || null, plan_id: ent.plan_id, entitlement_status: ent.status || null },
+      }
+    }
+
+    return { tier: 'free', limits: FREE_LIMITS, source: 'entitlement_invalid', debug: { entitlement_id: ent.id || null } }
+  }
+
+  // 3. Check App Subscriptions (legacy fallback)
   const { data: appSub } = await supabase
     .from('app_subscriptions')
     .select('id, plan_id, status')
@@ -93,44 +154,6 @@ export async function getVipPlanLimits(supabase: SupabaseClient, userId: string)
     }
   }
 
-  // 3. Check Marketplace Subscriptions (Stripe/Asaas)
-  const { data: marketSub } = await supabase
-    .from('marketplace_subscriptions')
-    .select('id, plan_id, status')
-    .eq('student_user_id', userId)
-    .in('status', ['active', 'past_due', 'trialing'])
-    .order('created_at', { ascending: false })
-    .limit(1)
-    .maybeSingle()
-
-  if (marketSub?.plan_id) {
-    const limits = await fetchPlanLimits(supabase, marketSub.plan_id)
-    if (limits) {
-      return {
-        tier: marketSub.plan_id,
-        limits,
-        source: 'marketplace_subscription',
-        debug: { marketplace_subscription_id: marketSub.id || null, marketplace_subscription_status: marketSub.status || null },
-      }
-    }
-    console.warn('vip_entitlement_missing_plan', {
-      source: 'marketplace_subscription',
-      marketplace_subscription_id: marketSub.id || null,
-      plan_id: marketSub.plan_id,
-      status: marketSub.status || null,
-    })
-    return {
-      tier: 'free',
-      limits: FREE_LIMITS,
-      source: 'marketplace_subscription_missing_plan',
-      debug: {
-        marketplace_subscription_id: marketSub.id || null,
-        plan_id: marketSub.plan_id,
-        marketplace_subscription_status: marketSub.status || null,
-      },
-    }
-  }
-
   // 4. Fallback to Free
   return { tier: 'free', limits: FREE_LIMITS, source: 'free_no_subscription' }
 }
diff --git a/tsconfig.json b/tsconfig.json
index 48e2426..2c93dea 100644
--- a/tsconfig.json
+++ b/tsconfig.json
@@ -43,6 +43,8 @@
     "claude",
     "_macro_mixer_orig",
     "_legacy_backup",
+    "src/components/ActiveWorkout.tsx",
+    "src/components/AdminPanelV2.tsx",
     "src/**/__tests__/**",
     "**/*.test.ts",
     "**/*.test.tsx",
