import { createAdminClient } from '@/utils/supabase/admin'

const chunk = (arr, size) => {
  const out = []
  const safe = Array.isArray(arr) ? arr : []
  const n = Math.max(1, Number(size) || 1)
  for (let i = 0; i < safe.length; i += n) out.push(safe.slice(i, i + n))
  return out
}

export async function listFollowerIdsOf(userId) {
  const uid = String(userId || '').trim()
  if (!uid) return []
  const admin = createAdminClient()
  const { data } = await admin
    .from('social_follows')
    .select('follower_id')
    .eq('following_id', uid)
    .eq('status', 'accepted')
    .limit(5000)
  return (Array.isArray(data) ? data : [])
    .map((r) => String(r?.follower_id || '').trim())
    .filter(Boolean)
}

export async function filterRecipientsByPreference(recipientIds, preferenceKey) {
  const key = String(preferenceKey || '').trim()
  const ids = (Array.isArray(recipientIds) ? recipientIds : []).map((v) => String(v || '').trim()).filter(Boolean)
  if (!key || ids.length === 0) return ids

  const admin = createAdminClient()
  const { data } = await admin.from('user_settings').select('user_id, preferences').in('user_id', ids)
  const rows = Array.isArray(data) ? data : []
  const byId = new Map(rows.map((r) => [String(r?.user_id || ''), r?.preferences && typeof r.preferences === 'object' ? r.preferences : null]))

  return ids.filter((id) => {
    const prefs = byId.get(id) || null
    if (!prefs) return true
    const raw = prefs[key]
    return raw !== false
  })
}

export async function shouldThrottleBySenderType(senderId, type, windowMinutes) {
  const sid = String(senderId || '').trim()
  const t = String(type || '').trim()
  const minutes = Math.max(1, Number(windowMinutes) || 15)
  if (!sid || !t) return false
  const admin = createAdminClient()
  const since = new Date(Date.now() - minutes * 60 * 1000).toISOString()
  const { data } = await admin
    .from('notifications')
    .select('id')
    .eq('type', t)
    .eq('sender_id', sid)
    .gte('created_at', since)
    .limit(1)
  return Array.isArray(data) && data.length > 0
}

export async function insertNotifications(rows) {
  const admin = createAdminClient()
  const safeRows = (Array.isArray(rows) ? rows : []).filter((r) => r && typeof r === 'object')
  if (!safeRows.length) return { ok: true, inserted: 0 }

  let inserted = 0
  for (const part of chunk(safeRows, 500)) {
    const { error } = await admin.from('notifications').insert(part)
    if (error) {
      const msg = String(error?.message ?? error)
      const lower = msg.toLowerCase()
      const schemaMismatch =
        lower.includes('column') &&
        (lower.includes('sender_id') ||
          lower.includes('recipient_id') ||
          lower.includes('metadata') ||
          lower.includes('is_read'))
      if (!schemaMismatch) return { ok: false, error: msg, inserted }

      const fallback = part.map((r) => ({
        user_id: r.user_id,
        title: r.title,
        message: r.message,
        type: r.type,
        read: r.read,
      }))
      const { error: fallbackError } = await admin.from('notifications').insert(fallback)
      if (fallbackError) return { ok: false, error: String(fallbackError?.message ?? fallbackError), inserted }
    }
    inserted += part.length
  }
  return { ok: true, inserted }
}
